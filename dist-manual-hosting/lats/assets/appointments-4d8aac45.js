import{s as t,Y as e,X as n}from"./index-222cfb29.js";async function a(){try{let{data:e,error:n}=await t.from("appointments").select("*").order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});if(n){const{data:n,error:a}=await t.from("appointments").select("*").order("scheduled_date",{ascending:!0});if(a)throw a;e=n}return(null==e?void 0:e.map(t=>{var e,n,a;const i=t.appointment_date||t.scheduled_date,o=t.appointment_time||"00:00:00",s=t.service_type||t.appointment_type||"Unknown Service",r=(null==(e=t.customers)?void 0:e.name)||t.customer_name||"Unknown Customer",c=(null==(n=t.customers)?void 0:n.phone)||t.customer_phone||"No Phone",d=(null==(a=t.auth_users)?void 0:a.name)||t.technician_name||"No Technician";return{id:t.id,customer_id:t.customer_id,customer_name:r,customer_phone:c,service_type:s,appointment_date:i,appointment_time:o,status:t.status,notes:t.notes,priority:t.priority,technician_name:d,duration_minutes:t.duration_minutes||t.estimated_duration||60,created_at:t.created_at,updated_at:t.updated_at,...t}}))||[]}catch(e){throw e}}async function i(e){try{const{data:n,error:a}=await t.from("appointments").select("*").eq("customer_id",e).order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});if(a)throw a;return(null==n?void 0:n.map(t=>({...t,technician_name:t.technician_name||"No Technician"})))||[]}catch(n){throw n}}async function o(a){try{let r="",c="";try{const{data:n,error:i}=await t.from("customers").select("is_active, name, phone").eq("id",a.customer_id).single();if(i)throw new Error(`Failed to fetch customer details: ${i.message}`);if(!n)throw new Error("Customer not found");r=n.name,c=n.phone,n.is_active||await e(a.customer_id)}catch(i){throw i}let d="";if(a.technician_id)try{const{data:e}=await t.from("users").select("full_name").eq("id",a.technician_id).single();d=(null==e?void 0:e.full_name)||""}catch(o){}const m={customer_id:a.customer_id,notes:a.notes,priority:a.priority||"medium",status:"scheduled"};m.service_type=a.service_type,m.appointment_date=a.appointment_date,m.appointment_time=a.appointment_time,m.duration_minutes=a.duration_minutes||60,r&&(m.customer_name=r),c&&(m.customer_phone=c),a.technician_id&&(m.technician_id=a.technician_id),d&&(m.technician_name=d);const{data:u,error:l}=await t.from("appointments").insert([m]).select().single();if(l)throw l;try{await n(a.customer_id,"appointment_scheduled")}catch(s){}return u}catch(r){throw r}}async function s(e,a){try{const{data:o,error:s}=await t.from("appointments").update({...a,updated_at:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw s;try{await n(o.customer_id,"appointment_updated")}catch(i){}return o}catch(o){throw o}}async function r(e){try{const{error:n}=await t.from("appointments").delete().eq("id",e);if(n)throw n;return!0}catch(n){throw n}}async function c(){try{let{data:e,error:n}=await t.from("appointments").select("status, appointment_date");if(n){const{data:n,error:a}=await t.from("appointments").select("status, scheduled_date");if(a)throw a;e=null==n?void 0:n.map(t=>({...t,appointment_date:t.scheduled_date}))}const a=(new Date).toISOString().split("T")[0],i=new Date;i.setDate(i.getDate()-i.getDay());const o=new Date;o.setDate(o.getDate()+(6-o.getDay()));return{total:(null==e?void 0:e.length)||0,pending:(null==e?void 0:e.filter(t=>"pending"===t.status||"scheduled"===t.status).length)||0,confirmed:(null==e?void 0:e.filter(t=>"confirmed"===t.status).length)||0,completed:(null==e?void 0:e.filter(t=>"completed"===t.status).length)||0,cancelled:(null==e?void 0:e.filter(t=>"cancelled"===t.status).length)||0,today:(null==e?void 0:e.filter(t=>(t.appointment_date||t.scheduled_date)===a).length)||0,thisWeek:(null==e?void 0:e.filter(t=>{const e=new Date(t.appointment_date||t.scheduled_date);return e>=i&&e<=o}).length)||0}}catch(e){throw e}}async function d(e,n){try{let a=t.from("appointments").select("\n        *,\n        customers(name, phone),\n        auth_users!technician_id(name)\n      ");if(e&&(a=a.or(`service_type.ilike.%${e}%,notes.ilike.%${e}%`)),(null==n?void 0:n.status)&&"all"!==n.status&&(a=a.eq("status",n.status)),(null==n?void 0:n.customer_id)&&"all"!==n.customer_id&&(a=a.eq("customer_id",n.customer_id)),(null==n?void 0:n.date)&&"all"!==n.date){const t=(new Date).toISOString().split("T")[0],e=new Date;e.setDate(e.getDate()-e.getDay());const i=new Date;switch(i.setDate(i.getDate()+(6-i.getDay())),n.date){case"today":a=a.eq("appointment_date",t);break;case"this-week":a=a.gte("appointment_date",e.toISOString().split("T")[0]).lte("appointment_date",i.toISOString().split("T")[0]);break;case"this-month":const n=new Date;n.setDate(1);const o=new Date;o.setMonth(o.getMonth()+1,0),a=a.gte("appointment_date",n.toISOString().split("T")[0]).lte("appointment_date",o.toISOString().split("T")[0])}}const{data:i,error:o}=await a.order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});if(o)throw o;return(null==i?void 0:i.map(t=>{var e,n,a;return{...t,customer_name:null==(e=t.customers)?void 0:e.name,customer_phone:null==(n=t.customers)?void 0:n.phone,technician_name:null==(a=t.auth_users)?void 0:a.name}}))||[]}catch(a){throw a}}export{i as a,o as c,r as d,a as f,c as g,d as s,s as u};
