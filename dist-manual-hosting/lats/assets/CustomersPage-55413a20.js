import{j as e,d as t,G as s,g as a,u as r,m as l,s as n,n as i,o,a as c,i as d,p as m}from"./index-222cfb29.js";import{r as x,R as u,b as h}from"./vendor-a2ff445a.js";import{a as p,c as g}from"./routing-a2f0f6d2.js";import{d as b,h as f,g as y,X as j,y as v,ab as N,b as w,p as C,a0 as S,T as k,t as D,v as M,ag as A,D as L,ah as F,u as I,a1 as z,n as T,a4 as P,ai as $,o as O,aj as R,I as E,e as B,R as _,a5 as U,ak as V,q as W,al as G,am as J,m as Y,P as q,a7 as H,an as K,ao as Q,ap as X,aq as Z,ar as ee,as as te,at as se,au as ae,av as re,aw as le,A as ne,r as ie,s as oe,ax as ce,f as de}from"./ui-551a39a6.js";import{B as me}from"./BackButton-e41d1482.js";import{u as xe}from"./useBodyScrollLock-0216d39f.js";import{f as ue,a as he}from"./phoneUtils-1ba19aca.js";import{C as pe}from"./CustomerDetailModal-9e075bf1.js";import{fetchCustomersPaginated as ge}from"./customerApi-3e6f5bd3.js";import{A as be}from"./AddCustomerModal-a69277f6.js";import{A as fe}from"./AppointmentModal-4524caae.js";import{f as ye}from"./financialService-1702c0e7.js";import{f as je,c as ve,u as Ne}from"./appointments-4d8aac45.js";import{u as we,S as Ce}from"./useSuccessModal-e8b7d685.js";import{g as Se,a as ke}from"./search-674d386b.js";import"./supabase-7e851d02.js";import"./Modal-ccfa5014.js";import"./CustomerForm-05944812.js";import"./returns-0428af68.js";import"./whatsappService-37f3bd6b.js";import"./format-0f0b2647.js";import"./index-0096d614.js";import"./pdf-33d2fdad.js";import"./SuccessModalIcons-20b743c5.js";const De=({isSearching:t,searchStatus:s="pending",searchProgress:a=0,resultCount:r,onCancel:l,className:n=""})=>{const[i,o]=x.useState(!0);if(x.useEffect(()=>{t&&o(!0)},[t]),x.useEffect(()=>{if("completed"===s){const e=setTimeout(()=>o(!1),2e3);return()=>clearTimeout(e)}},[s]),!t||!i)return null;return e.jsxs("div",{className:`relative overflow-hidden rounded-lg border ${(()=>{switch(s){case"completed":return"bg-green-50 border-green-200";case"failed":return"bg-red-50 border-red-200";default:return"bg-blue-50 border-blue-200"}})()} ${n}`,children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 h-0.5 bg-gray-200/50",children:e.jsx("div",{className:`h-full ${(()=>{switch(s){case"completed":return"bg-green-500";case"failed":return"bg-red-500";default:return"bg-blue-500"}})()} transition-all duration-300 ease-out`,style:{width:`${a}%`}})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:"completed"===s?e.jsx(b,{className:"w-4 h-4 text-green-600"}):"failed"===s?e.jsx(f,{className:"w-4 h-4 text-red-600"}):e.jsx(y,{className:"w-4 h-4 text-blue-600 animate-spin"})}),e.jsx("p",{className:`text-sm font-medium ${(()=>{switch(s){case"completed":return"text-green-700";case"failed":return"text-red-700";default:return"text-blue-700"}})()} truncate`,children:(()=>{switch(s){case"processing":default:return"Searching...";case"completed":return void 0!==r?`Found ${r.toLocaleString()} customers`:"Complete";case"failed":return"Search failed"}})()}),"processing"===s&&a>0&&e.jsxs("span",{className:"text-xs text-gray-600 tabular-nums",children:[a,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0 ml-2",children:["processing"===s&&l&&e.jsx("button",{onClick:l,className:"text-xs text-gray-600 hover:text-red-600 transition-colors px-2 py-0.5",title:"Cancel",children:"Cancel"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-400 hover:text-gray-600 transition-colors p-0.5",title:"Dismiss",children:e.jsx(j,{className:"w-3.5 h-3.5"})})]})]})]})},Me=({searchQuery:t,onSearchChange:s,loyaltyFilter:a,onLoyaltyFilterChange:r,statusFilter:l,onStatusFilterChange:n,tagFilter:i,onTagFilterChange:o,referralFilter:c,onReferralFilterChange:d,birthdayFilter:m,onBirthdayFilterChange:u,whatsappFilter:h,onWhatsappFilterChange:p,showInactive:g,onShowInactiveChange:b,sortBy:f,onSortByChange:T,customers:P,searchLoading:$=!1,filteredCount:O,genderFilter:R,onGenderFilterChange:E,minSpent:B,onMinSpentChange:_,maxSpent:U,onMaxSpentChange:V,minPoints:W,onMinPointsChange:G,maxPoints:J,onMaxPointsChange:Y,cityFilter:q,onCityFilterChange:H,minPurchases:K,onMinPurchasesChange:Q,maxPurchases:X,onMaxPurchasesChange:Z,joinDateFrom:ee,onJoinDateFromChange:te,joinDateTo:se,onJoinDateToChange:ae,lastVisitFrom:re,onLastVisitFromChange:le,lastVisitTo:ne,onLastVisitToChange:ie})=>{const[oe,ce]=x.useState(!1),de=t||a.length>0||l.length>0||i.length>0||c.length>0||m||h||g||R.length>0||B||U||W||J||q.length>0||K||X||ee||se||re||ne,me=Array.from(new Set(P.map(e=>e.colorTag).filter(Boolean))),xe=Array.from(new Set(P.map(e=>e.referralSource).filter(Boolean))),ue=Array.from(new Set(P.map(e=>e.city).filter(Boolean)));return x.useMemo(()=>{const e=new Date,t=e.getMonth()+1,s=e.getDate();return P.filter(e=>{if(!e.birthMonth||!e.birthDay)return!1;return["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(e.birthMonth.toLowerCase())+1===t&&parseInt(e.birthDay)===s})},[P]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(v,{size:18,className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"}),$&&e.jsx(y,{size:18,className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-200 animate-spin opacity-30"}),e.jsx("input",{type:"text",value:t,onChange:e=>s(e.target.value),placeholder:"Search customers (type at least 2 characters)...",className:"w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",inputMode:"text"}),$&&e.jsx("div",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-300 opacity-40",children:[e.jsx(y,{size:8,className:"animate-spin"}),e.jsx("span",{children:"Searching"})]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>ce(!oe),className:"flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 "+(oe?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[e.jsx(N,{size:16}),"Filters",de&&e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx(w,{size:14,className:"transition-transform duration-200 "+(oe?"rotate-180":"")})]}),de&&e.jsxs("button",{onClick:()=>{s(""),r([]),n([]),o([]),d([]),u(!1),p&&p(!1),b(!1),E([]),_(""),V(""),G(""),Y(""),H([]),Q(""),Z(""),te(""),ae(""),le(""),ie("")},className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-200",children:[e.jsx(j,{size:14}),"Clear all"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[void 0!==O&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:O})," customers found"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:f,onChange:e=>T(e.target.value),className:"appearance-none px-4 py-2 pr-10 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm font-medium text-gray-700",children:[e.jsx("option",{value:"name",children:"Sort by Name"}),e.jsx("option",{value:"recent",children:"Sort by Recent"}),e.jsx("option",{value:"spent",children:"Sort by Spent"}),e.jsx("option",{value:"points",children:"Sort by Points"})]}),e.jsx(w,{size:14,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"})]})]})]}),oe&&e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-6 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(C,{size:16,className:"inline mr-2 text-yellow-500"}),"Loyalty Level"]}),e.jsx("div",{className:"space-y-2",children:["interested","engaged","payment_customer","active","regular","premium","vip"].map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:a.includes(t),onChange:e=>{e.target.checked?r([...a,t]):r(a.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(S,{size:16,className:"inline mr-2 text-green-500"}),"Status"]}),e.jsx("div",{className:"space-y-2",children:["active","inactive"].map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:l.includes(t),onChange:e=>{e.target.checked?n([...l,t]):n(l.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(k,{size:16,className:"inline mr-2 text-purple-500"}),"Tags"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:me.length>0?me.map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:i.includes(t),onChange:e=>{e.target.checked?o([...i,t]):o(i.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t)):e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No tags assigned yet. Add tags to customers to filter by them."})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(D,{size:16,className:"inline mr-2 text-blue-500"}),"Gender"]}),e.jsx("div",{className:"space-y-2",children:["male","female","other"].map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:R.includes(t),onChange:e=>{e.target.checked?E([...R,t]):E(R.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(M,{size:16,className:"inline mr-2 text-green-500"}),"City"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:ue.map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:q.includes(t),onChange:e=>{e.target.checked?H([...q,t]):H(q.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(A,{size:16,className:"inline mr-2 text-orange-500"}),"Referral Source"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:xe.map(t=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:c.includes(t),onChange:e=>{e.target.checked?d([...c,t]):d(c.filter(e=>e!==t))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:t})]},t))})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Range Filters"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(L,{size:16,className:"inline mr-2 text-green-500"}),"Total Spent (TSH)"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:B,onChange:e=>_(e.target.value),placeholder:"Min amount (TSH)",min:"0",step:"100",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:U,onChange:e=>V(e.target.value),placeholder:"Max amount (TSH)",min:"0",step:"100",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(C,{size:16,className:"inline mr-2 text-yellow-500"}),"Points"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:W,onChange:e=>G(e.target.value),placeholder:"Min points",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:J,onChange:e=>Y(e.target.value),placeholder:"Max points",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(F,{size:16,className:"inline mr-2 text-purple-500"}),"Purchase Count"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:K,onChange:e=>Q(e.target.value),placeholder:"Min purchases",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:X,onChange:e=>Z(e.target.value),placeholder:"Max purchases",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Date Range Filters"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(I,{size:16,className:"inline mr-2 text-blue-500"}),"Join Date"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:ee,onChange:e=>te(e.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"date",value:se,onChange:e=>ae(e.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(I,{size:16,className:"inline mr-2 text-green-500"}),"Last Visit"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:re,onChange:e=>le(e.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"date",value:ne,onChange:e=>ie(e.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Quick Filters"}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:e=>u(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(I,{size:16,className:"text-pink-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Has birthday"})]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:h,onChange:e=>null==p?void 0:p(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(z,{size:16,className:"text-green-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Has WhatsApp"})]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:e=>b(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Show inactive only"})]})]})]})]})]})},Ae=({open:r,onClose:l,customers:n,onSend:i,sending:o=!1})=>{const[c,d]=x.useState("all"),[m,u]=x.useState("all"),[h,p]=x.useState("all"),[g,b]=x.useState(""),[f,y]=x.useState(!1),[j,v]=x.useState(""),[N,w]=x.useState(!1),[C,S]=x.useState([]),[k,D]=x.useState("");xe(r);const M=x.useMemo(()=>n.filter(e=>{let t=!0;return"all"!==c&&(t=t&&e.loyaltyLevel===c),"all"!==m&&(t=t&&("active"===m?e.isActive:!e.isActive)),"all"!==h&&(t=t&&e.colorTag===h),t}),[n,c,m,h]);return r?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30",children:e.jsxs(t,{className:"w-full max-w-4xl p-6 relative max-h-[90vh] overflow-y-auto",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700",onClick:l,children:"Ã—"}),e.jsx("h2",{className:"text-xl font-bold mb-4 text-gray-900",children:"AI-Powered Bulk SMS"}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:e=>y(e.target.checked),className:"rounded"}),e.jsx("span",{className:"text-sm font-medium",children:"ðŸ¤– Enable AI Features"})]}),f&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(s,{size:"sm",variant:"secondary",onClick:async()=>{if(0!==M.length){w(!0);try{const e=M.map(e=>({name:e.name,loyaltyLevel:e.loyaltyLevel,totalSpent:e.totalSpent,points:e.points,colorTag:e.colorTag,isActive:e.isActive})),t=`Analyze this customer segment for a device repair and sales business:\n\nCustomer Data: ${JSON.stringify(e,null,2)}\n\nPlease provide:\n1. Key insights about this customer segment\n2. Recommended messaging approach\n3. Best time to contact them\n4. Potential offers or promotions\n5. Risk factors to consider\n\nKeep response concise and actionable.`,s=await a.chat([{role:"user",content:t}]);s.success&&s.data?T.success("Customer insights generated! Check console for details."):T.error("Failed to generate customer insights")}catch(e){T.error("Error generating customer insights")}finally{w(!1)}}else T.error("No customers selected for analysis")},disabled:N,children:N?"Analyzing...":"ðŸ“Š Customer Insights"}),e.jsx(s,{size:"sm",variant:"secondary",onClick:async()=>{if(0!==M.length){w(!0);try{const e=M[0],t=`Generate a personalized SMS template for a device repair business customer:\n\nCustomer Info:\n- Name: ${e.name}\n- Loyalty Level: ${e.loyaltyLevel}\n- Total Spent: ${e.totalSpent}\n- Points: ${e.points}\n- Tag: ${e.colorTag}\n\nBusiness Context:\n- Device repair and sales\n- Professional but friendly tone\n- Include customer's name and loyalty level\n- Make it personal and relevant\n\nGenerate a personalized message template with placeholders like {name}, {loyaltyLevel}, {totalSpent}, {points}.`,s=await a.chat([{role:"user",content:t}]);s.success&&s.data?(b(s.data.trim()),T.success("Personalized message template generated!")):T.error("Failed to generate personalized template")}catch(e){T.error("Error generating personalized template")}finally{w(!1)}}else T.error("No customers selected")},disabled:N,children:N?"Generating...":"ðŸ‘¤ Personalized Template"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loyalty"}),e.jsxs("select",{className:"w-full rounded-lg border-gray-300",value:c,onChange:e=>d(e.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"vip",children:"VIP"}),e.jsx("option",{value:"premium",children:"Premium"}),e.jsx("option",{value:"regular",children:"Regular"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"payment_customer",children:"Payment Customer"}),e.jsx("option",{value:"engaged",children:"Engaged"}),e.jsx("option",{value:"interested",children:"Interested"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{className:"w-full rounded-lg border-gray-300",value:m,onChange:e=>u(e.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tag"}),e.jsxs("select",{className:"w-full rounded-lg border-gray-300",value:h,onChange:e=>p(e.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"vip",children:"VIP"}),e.jsx("option",{value:"new",children:"New"}),e.jsx("option",{value:"complainer",children:"Complainer"})]})]})]}),f&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800 mb-2",children:"ðŸ¤– AI Message Generation"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:"AI Prompt"}),e.jsx("textarea",{className:"w-full rounded-lg border-gray-300 min-h-[60px]",value:j,onChange:e=>v(e.target.value),placeholder:"Describe what kind of message you want to send (e.g., 'Promote our new phone repair service', 'Thank loyal customers', 'Announce special discount')"})]}),e.jsx(s,{onClick:async()=>{if(j.trim()){w(!0);try{const e=`${`Generate SMS messages for ${M.length} customers in a device repair and sales business.\n      \nCustomer Segment Info:\n- Loyalty Level: ${"all"===c?"Mixed":c}\n- Status: ${"all"===m?"Mixed":m}\n- Tag: ${"all"===h?"Mixed":h}\n- Total Customers: ${M.length}\n\nBusiness Context:\n- Device repair and sales business\n- Professional but friendly tone\n- Quick response times\n- Technical expertise available\n- Customer service focused\n\nRequirements:\n- Generate 3 different message variations\n- Each message should be under 160 characters\n- Professional and friendly tone\n- Address the specific prompt/context\n- Include call-to-action if appropriate\n- Use simple language (Swahili/English mix is okay)`}\n\nYour prompt: ${j}\n\nGenerate 3 SMS message variations:`,t=await a.chat([{role:"user",content:e}]);if(t.success&&t.data){const e=t.data.split("\n").filter(e=>e.trim().length>0&&e.trim().length<200).map(e=>e.replace(/^\d+\.\s*/,"").trim()).slice(0,3);S(e),T.success("AI generated message suggestions!")}else T.error("Failed to generate AI suggestions")}catch(e){T.error("Error generating AI suggestions")}finally{w(!1)}}else T.error("Please enter a prompt for AI message generation")},disabled:N||!j.trim(),className:"w-full",children:N?"ðŸ¤– Generating...":"ðŸ¤– Generate AI Suggestions"}),C.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700",children:"AI Suggestions:"}),C.map((t,s)=>e.jsxs("div",{className:"p-2 rounded border cursor-pointer transition-colors "+(k===t?"border-blue-500 bg-blue-100":"border-gray-200 hover:border-blue-300"),onClick:()=>(e=>{D(e),b(e)})(t),children:[e.jsx("div",{className:"text-sm text-gray-700",children:t}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[t.length," characters"]})]},s))]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Message ",f&&"(AI-enhanced)"]}),e.jsx("textarea",{className:"w-full rounded-lg border-gray-300 min-h-[80px]",value:g,onChange:e=>b(e.target.value),placeholder:f?"Type your message or use AI suggestions above... (Use {name}, {loyaltyLevel}, {totalSpent}, {points} for personalization)":"Type your SMS message here...",maxLength:320}),f&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["ðŸ’¡ Personalization variables: ","{name}",", ","{loyaltyLevel}",", ","{totalSpent}",", ","{points}"]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Recipients: ",e.jsx("b",{children:M.length})]}),f&&e.jsxs("div",{className:"text-xs text-blue-600",children:["ðŸ¤– AI Features: ",C.length>0?"Suggestions available":"Ready to generate"]})]}),e.jsxs("span",{className:"text-xs text-gray-400",children:[g.length,"/320"]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(s,{variant:"secondary",onClick:l,disabled:o,children:"Cancel"}),e.jsx(s,{onClick:()=>{if(!g.trim())return;i(M,k||g),b(""),D(""),S([]),l()},disabled:o||!g.trim()||0===M.length,className:f?"bg-gradient-to-r from-blue-500 to-purple-600":"",children:o?"Sending...":f?"ðŸ¤– Send AI-Enhanced SMS":"Send SMS"})]}),f&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-700",children:[e.jsx("span",{children:"ðŸ¤–"}),e.jsx("span",{children:"AI-powered features enabled. Messages will be personalized automatically."})]})})]})}):null},Le=({isOpen:a,onClose:n,onImportComplete:i})=>{const{currentUser:o}=r(),[c,d]=x.useState(null),[m,u]=x.useState([]),[h,p]=x.useState([]),[g,f]=x.useState(!1),[y,v]=x.useState(!1),[N,w]=x.useState("upload"),[C,S]=x.useState(0),[k,D]=x.useState([]),[M,A]=x.useState([]),[L,F]=x.useState(!1),[I,z]=x.useState([]),[_,U]=x.useState(!1),[V,W]=x.useState(new Set),G=x.useRef(null),J=e=>{if(!e)return"";const t=e.replace(/[\s\-()]/g,"");return t.startsWith("+255")||t.startsWith("255")?t:t.startsWith("0")?"+255"+t.substring(1):(9===t.length&&/^\d+$/.test(t),"255"+t)},Y=e=>{if(!e)return"";const t=e.replace(/[\s\-()]/g,"");return t.startsWith("+255")||t.startsWith("255")?t:t.startsWith("0")?"+255"+t.substring(1):(9===t.length&&/^\d+$/.test(t),"255"+t)},q=e=>{if(!e)return"";const t=e.trim();return t===t.toUpperCase()&&t.length>1||t===t.toUpperCase()?t.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):t},H=e=>{if(!e)return"other";const t=e.trim().toLowerCase();return"male"===t||"m"===t?"male":"female"===t||"f"===t?"female":"other"},K=e=>{if(!e)return"";const t=e.trim(),s={mtandaoni:"Social Media",physically:"Walk-in",recommendation:"Friend","social media":"Social Media",facebook:"Facebook",google:"Google",friend:"Friend",family:"Family",colleague:"Colleague",advertisement:"Advertisement",website:"Website","walk-in":"Walk-in",referral:"Referral",other:"Other"},a=t.toLowerCase();return s[a]?s[a]:t===t.toUpperCase()&&t.length>1?t.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):t},Q=e=>{if(!e)return"";const t=e.trim(),s={dsm:"Dar es Salaam",dar:"Dar es Salaam","dar es":"Dar es Salaam","dar es salaam":"Dar es Salaam",mara:"Mara",moro:"Morogoro",arusha:"Arusha",mwanza:"Mwanza",dodoma:"Dodoma",tanga:"Tanga",mbeya:"Mbeya",morogoro:"Morogoro",tabora:"Tabora",singida:"Singida",kigoma:"Kigoma",shinyanga:"Shinyanga",kagera:"Kagera",manyara:"Manyara",njombe:"Njombe",katavi:"Katavi",geita:"Geita",simiyu:"Simiyu",songwe:"Songwe"},a=t.toLowerCase();return s[a]?s[a]:t},X=e=>{if(!e)return{month:"",day:""};const t=e.trim().toLowerCase(),s=t.match(/^(\d{1,2})-([a-z]{3,})$/);if(s){const e=s[1],t={jan:"January",feb:"February",fe:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December"}[s[2]];if(t){return{month:(new Date(`${t} 1, 2000`).getMonth()+1).toString(),day:e}}}const a=t.match(/^([a-z]{3,})-(\d{1,2})$/);if(a){const e=a[1],t=a[2],s={jan:"January",feb:"February",fe:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December"}[e];if(s){return{month:(new Date(`${s} 1, 2000`).getMonth()+1).toString(),day:t}}}return{month:"",day:""}};x.useEffect(()=>{const e=e=>{const t=document.getElementById("column-expand-dropdown"),s=e.target;!t||t.contains(s)||s.closest("[data-dropdown-button]")||t.classList.add("hidden")};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const Z=(e,t)=>{var s,a;const r=[];if((null==(s=e.name)?void 0:s.trim())||r.push(`Row ${t}: Name is required`),(null==(a=e.phone)?void 0:a.trim())?/^[+]?[0-9\s\-()]{8,}$/.test(e.phone)||r.push(`Row ${t}: Invalid phone number format`):r.push(`Row ${t}: Phone number is required`),e.gender&&!["male","female","other"].includes(e.gender)&&r.push(`Row ${t}: Gender must be male, female, or other`),e.loyaltyLevel&&!["bronze","silver","gold","platinum"].includes(e.loyaltyLevel)&&r.push(`Row ${t}: Invalid loyalty level`),e.birthMonth&&!e.birthDay&&r.push(`Row ${t}: Birth day is required if birth month is provided`),e.birthDay&&!e.birthMonth&&r.push(`Row ${t}: Birth month is required if birth day is provided`),e.birthDay){const s=parseInt(e.birthDay);(isNaN(s)||s<1||s>31)&&r.push(`Row ${t}: Birth day must be a number between 1-31`)}return r},ee=(e,t)=>Z(e,t+2),te=(e,t,s)=>ee(e,t).some(e=>e.toLowerCase().includes(s.toLowerCase())||"name"===s&&e.includes("Name is required")||"phone"===s&&(e.includes("Phone number is required")||e.includes("Invalid phone number format"))),se=async e=>{var t;try{f(!0),A([]);const s=(await e.text()).split("\n").filter(e=>e.trim());if(s.length<2)return void T.error("File must contain at least a header row and one data row");const a=(null==(t=s[0])?void 0:t.split(",").map(e=>e.trim().toLowerCase()))||[],r=[],l=[];for(let e=1;e<s.length;e++){const t=s[e].trim();if(!t)continue;const n=t.split(",").map(e=>e.trim().replace(/^"|"$/g,"")),i=n[a.indexOf("phone")]||n[a.indexOf("phone number")]||n[a.indexOf("mobile")]||n[a.indexOf("mobile phone")]||n[a.indexOf("primary phone")]||n[a.indexOf("phone 1 - value")]||"",o=n[a.indexOf("whatsapp")]||n[a.indexOf("whatsapp number")]||"",c={name:q(n[a.indexOf("name")]||n[a.indexOf("full name")]||n[a.indexOf("customer name")]||n[a.indexOf("first name")]||""),email:"",phone:J(i),gender:H(n[a.indexOf("gender")]||"other"),city:Q(n[a.indexOf("city")]||n[a.indexOf("location")]||n[a.indexOf("home city")]||n[a.indexOf("business city")]||""),whatsapp:Y(o),notes:n[a.indexOf("notes")]||n[a.indexOf("comments")]||"",loyaltyLevel:n[a.indexOf("loyalty")]||n[a.indexOf("loyalty level")]||"bronze",colorTag:n[a.indexOf("color tag")]||n[a.indexOf("tag")]||"new",birthMonth:n[a.indexOf("birth month")]||n[a.indexOf("month")]||"",birthDay:n[a.indexOf("birth day")]||n[a.indexOf("day")]||"",referralSource:K(n[a.indexOf("referral source")]||n[a.indexOf("referral")]||n[a.indexOf("referred by")]||n[a.indexOf("referral resource")]||""),referralSourceCustom:n[a.indexOf("referral source custom")]||n[a.indexOf("custom referral")]||""},d=n[a.indexOf("birthday")]||n[a.indexOf("birth day")]||n[a.indexOf("birth")]||n[a.indexOf("birth date")]||"";if(d){const e=X(d);e.month&&e.day&&(c.birthMonth=e.month,c.birthDay=e.day)}if(c.birthMonth&&c.birthMonth.includes("-")){const e=X(c.birthMonth);e.month&&e.day&&(c.birthMonth=e.month,c.birthDay=e.day)}const m=Z(c,e+1);l.push(...m),c.name&&c.phone&&r.push(c)}A(l),u(r),z([...r]),p(r.slice(0,5)),w("preview"),l.length>0?T.error(`Found ${l.length} validation errors. Please review before importing.`):T.success(`Successfully processed ${r.length} customers`)}catch(s){T.error("Error processing file. Please ensure it's a valid CSV/Excel file.")}finally{f(!1)}};return a&&"admin"===(null==o?void 0:o.role)?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs(t,{className:"w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5 text-green-500"}),"Import Customers from Excel (Admin Only)"]}),e.jsx("button",{onClick:()=>{d(null),u([]),z([]),p([]),w("upload"),f(!1),v(!1),F(!1),U(!1),W(new Set),S(0),D([]),A([]),G.current&&(G.current.value=""),n()},className:"p-2 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(j,{className:"w-5 h-5"})})]}),"upload"===N&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx($,{className:"w-12 h-12 mx-auto text-blue-500 mb-2"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Upload Customer Data"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Import customers from Excel/CSV file. Download the template below for the correct format."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>{var e;return null==(e=G.current)?void 0:e.click()},disabled:g,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors",children:[e.jsx($,{className:"w-4 h-4 mr-2 inline"}),g?"Processing...":"Choose File"]}),e.jsxs("button",{onClick:()=>{w("preview"),F(!0),z([{name:"",email:"",phone:"",gender:"other",city:"",whatsapp:"",birthMonth:"",birthDay:"",referralSource:"",notes:"",loyaltyLevel:"bronze",colorTag:"new"}])},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors",children:[e.jsx(O,{className:"w-4 h-4 mr-2 inline"}),"Manual Entry"]}),e.jsxs("button",{onClick:()=>{const e=new Blob(["name,email,phone,gender,city,whatsapp,birth month,birth day,referral source,notes,loyalty level,color tag\nJohn Doe,john@example.com,748757641,male,DSM,748757641,January,15,MTANDAONI,New customer,bronze,new\nJane Smith,jane@example.com,717377078,female,MARA,717377078,March,22,RECOMMENDATION,VIP customer,silver,vip\nMike Johnson,mike@example.com,676947420,male,MORO,676947420,December,5,PHYSICALLY,Regular customer,gold,new\nAlice Brown,alice@example.com,655123456,female,DSM,655123456,June,10,INSTAGRAM,Social media customer,platinum,purchased"],{type:"text/csv;charset=utf-8;"}),t=window.URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="customer_import_template.csv",s.click(),window.URL.revokeObjectURL(t),T.success("Template downloaded! To add dropdowns in Excel: Select column â†’ Data â†’ Data Validation â†’ List â†’ Enter values separated by commas")},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors",children:[e.jsx(R,{className:"w-4 h-4 mr-2 inline"}),"Download Template"]}),e.jsx("div",{className:"flex items-center justify-center text-sm text-gray-500",children:"or"})]}),e.jsx("input",{ref:G,type:"file",accept:".csv,.xlsx,.xls",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){if(s.size>5242880)return void T.error("File size must be less than 5MB");d(s),se(s)}},className:"hidden"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-green-800 mb-2 flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Dropdown Values for Excel:"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-700",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Gender:"})," male, female, other"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Loyalty Level:"})," bronze, silver, gold, platinum"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Color Tag:"})," new, vip, complainer, purchased"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Referral Source:"})," MTANDAONI, RECOMMENDATION, PHYSICALLY, INSTAGRAM, FACEBOOK, GOOGLE, FRIEND, FAMILY, OTHER"]})]})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-yellow-800 mb-2 flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"How to Add Dropdowns in Excel:"]}),e.jsxs("ol",{className:"text-sm text-yellow-700 space-y-1",children:[e.jsx("li",{children:"1. Select the column you want to add dropdown to (e.g., Gender column)"}),e.jsxs("li",{children:["2. Go to ",e.jsx("strong",{children:"Data"})," tab â†’ ",e.jsx("strong",{children:"Data Validation"})]}),e.jsxs("li",{children:["3. Choose ",e.jsx("strong",{children:"List"}),' from "Allow" dropdown']}),e.jsx("li",{children:'4. In "Source" field, enter values separated by commas (e.g., male,female,other)'}),e.jsxs("li",{children:["5. Click ",e.jsx("strong",{children:"OK"})," to apply"]})]})]})]}),"preview"===N&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium",children:m.length>0?"Preview Data":"Manual Entry"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:m.length>0?`${m.length} customers found`:"No file uploaded - manual entry mode"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{"data-dropdown-button":!0,onClick:()=>{const e=document.getElementById("column-expand-dropdown");e&&e.classList.toggle("hidden")},className:"px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium hover:bg-gray-200 transition-colors",children:"Expand Columns"}),e.jsxs("div",{id:"column-expand-dropdown",className:"hidden absolute top-full right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-48",children:[e.jsx("div",{className:"p-2 text-xs text-gray-500 border-b",children:"Select columns to expand:"}),[{key:"name",label:"Name"},{key:"phone",label:"Phone"},{key:"email",label:"Email"},{key:"city",label:"City"},{key:"whatsapp",label:"WhatsApp"},{key:"referral",label:"Referral Source"},{key:"notes",label:"Notes"}].map(t=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:V.has(t.key),onChange:e=>{const s=new Set(V);e.target.checked?s.add(t.key):s.delete(t.key),W(s)},className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm",children:t.label})]},t.key))]})]}),e.jsx("button",{onClick:()=>U(!_),className:"px-3 py-1 rounded text-xs font-medium transition-colors "+(_?"bg-blue-500 text-white hover:bg-blue-600":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:_?"Normal View":"Compact View"}),e.jsx("button",{onClick:()=>F(!L),className:"px-3 py-1 rounded text-xs font-medium transition-colors "+(L?"bg-blue-500 text-white hover:bg-blue-600":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:L?"View Mode":"Edit Mode"})]})]})]}),M.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-yellow-800 mb-2 flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),"Validation Warnings (",M.length," rows will be skipped):"]}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:e.jsxs("ul",{className:"text-sm text-yellow-700 space-y-1",children:[M.slice(0,10).map((t,s)=>e.jsxs("li",{children:["â€¢ ",t]},s)),M.length>10&&e.jsxs("li",{className:"text-yellow-600",children:["... and ",M.length-10," more warnings"]})]})}),e.jsxs("div",{className:"mt-3 p-2 bg-yellow-100 rounded text-sm text-yellow-800",children:[e.jsx("strong",{children:"Note:"})," Rows with validation errors will be automatically skipped during import. Valid customers will still be imported successfully."]})]}),L&&e.jsx("div",{className:"mb-4",children:e.jsx("button",{onClick:()=>{z([...I,{name:"",email:"",phone:"",gender:"other",city:"",whatsapp:"",birthMonth:"",birthDay:"",referralSource:"",notes:"",loyaltyLevel:"bronze",colorTag:"new"}])},className:"px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium hover:bg-gray-200 transition-colors",children:"+ Add Row"})}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:`w-full ${_?"text-xs":"text-sm"} min-w-full`,children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("name")?"w-32":"w-20":""} ${L?"min-w-32":""}`,children:"Name"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("phone")?"w-32":"w-24":""} ${L?"min-w-36":""}`,children:"Phone"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?"w-16":""} ${L?"min-w-20":""}`,children:"Gender"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("city")?"w-32":"w-20":""} ${L?"min-w-28":""}`,children:"City"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("whatsapp")?"w-32":"w-20":""} ${L?"min-w-32":""}`,children:"WhatsApp"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?"w-20":""} ${L?"min-w-24":""}`,children:"Birthday"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("referral")?"w-32":"w-16":""} ${L?"min-w-32":""}`,children:"Referral"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?V.has("notes")?"w-40":"w-20":""} ${L?"min-w-48":""}`,children:"Notes"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?"w-16":""} ${L?"min-w-20":""}`,children:"Loyalty"}),e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?"w-16":""} ${L?"min-w-20":""}`,children:"Color Tag"}),L&&e.jsx("th",{className:`text-left ${_?"p-1":"p-2"} ${_?"w-12":""} ${L?"min-w-16":""}`,children:"Actions"})]})}),e.jsx("tbody",{children:(L?I:h.length>0?h:m).map((t,s)=>e.jsxs("tr",{className:"border-b "+(ee(t,s).length>0?"bg-yellow-50":""),children:[e.jsxs("td",{className:`${_?"p-1":"p-2"} relative ${te(t,s,"name")?"bg-yellow-100 border-l-4 border-yellow-500":""}`,children:[te(t,s,"name")&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs",children:"âš ï¸"})}),L?e.jsx("input",{type:"text",value:t.name||"",onChange:e=>{const t=[...I];t[s].name=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):e.jsx("span",{className:te(t,s,"name")?"text-yellow-800":"",children:t.name||(te(t,s,"name")?"âš ï¸ Required":"")})]}),e.jsxs("td",{className:`${_?"p-1":"p-2"} relative ${te(t,s,"phone")?"bg-yellow-100 border-l-4 border-yellow-500":""}`,children:[te(t,s,"phone")&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs",children:"âš ï¸"})}),L?e.jsx("input",{type:"text",value:t.phone||"",onChange:e=>{const t=[...I];t[s].phone=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):e.jsx("span",{className:te(t,s,"phone")?"text-yellow-800":"",children:t.phone||(te(t,s,"phone")?"âš ï¸ Required":"")})]}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsxs("select",{value:t.gender||"other",onChange:e=>{const t=[...I];t[s].gender=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"female",children:"Female"}),e.jsx("option",{value:"other",children:"Other"})]}):e.jsx("span",{className:"capitalize",children:t.gender})}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsx("input",{type:"text",value:t.city||"",onChange:e=>{const t=[...I];t[s].city=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):t.city}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsx("input",{type:"text",value:t.whatsapp||"",onChange:e=>{const t=[...I];t[s].whatsapp=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):t.whatsapp||"-"}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"text",placeholder:"Month",value:t.birthMonth||"",onChange:e=>{const t=[...I];t[s].birthMonth=e.target.value,z(t)},className:"w-20 bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}),e.jsx("input",{type:"number",placeholder:"Day",min:"1",max:"31",value:t.birthDay||"",onChange:e=>{const t=[...I];t[s].birthDay=e.target.value,z(t)},className:"w-16 bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"})]}):t.birthMonth&&t.birthDay?`${t.birthMonth} ${t.birthDay}`:"-"}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsx("input",{type:"text",value:t.referralSource||"",onChange:e=>{const t=[...I];t[s].referralSource=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):t.referralSource||"-"}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsx("textarea",{value:t.notes||"",onChange:e=>{const t=[...I];t[s].notes=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 resize-none",rows:1,placeholder:"Notes..."}):e.jsx("span",{className:"text-xs text-gray-600 max-w-xs truncate block",title:t.notes,children:t.notes||"-"})}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsxs("select",{value:t.loyaltyLevel||"bronze",onChange:e=>{const t=[...I];t[s].loyaltyLevel=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"bronze",children:"Bronze"}),e.jsx("option",{value:"silver",children:"Silver"}),e.jsx("option",{value:"gold",children:"Gold"}),e.jsx("option",{value:"platinum",children:"Platinum"})]}):e.jsx("span",{className:"capitalize",children:t.loyaltyLevel})}),e.jsx("td",{className:""+(_?"p-1":"p-2"),children:L?e.jsxs("select",{value:t.colorTag||"new",onChange:e=>{const t=[...I];t[s].colorTag=e.target.value,z(t)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"new",children:"New"}),e.jsx("option",{value:"vip",children:"VIP"}),e.jsx("option",{value:"complainer",children:"Complainer"}),e.jsx("option",{value:"purchased",children:"Purchased"})]}):e.jsx("span",{className:"capitalize",children:t.colorTag})}),L&&e.jsx("td",{className:""+(_?"p-1":"p-2"),children:e.jsx("button",{onClick:()=>{const e=[...I];e.splice(s,1),z(e)},className:"text-red-600 hover:text-red-800 text-sm",title:"Remove row",children:"âœ•"})})]},s))})]})})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>w("upload"),className:"flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors",children:"Back"}),e.jsx("button",{onClick:()=>w("import"),className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors",children:M.length>0?"Continue (Skip Invalid Rows)":"Continue to Import"})]})]}),"import"===N&&e.jsxs("div",{className:"space-y-6",children:[y?e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Importing Customers"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Progress: ",Math.round(C),"% (",k.length,"/",m.length,")"]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${C}%`}})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center",children:[e.jsx(b,{className:"w-12 h-12 mx-auto text-green-500 mb-2"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Import Complete"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Import results for ",m.length," customers"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-green-800 mb-1",children:"Successful"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:k.filter(e=>e.success).length})]}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-red-800 mb-1",children:"Failed"}),e.jsx("p",{className:"text-2xl font-bold text-red-900",children:k.filter(e=>!e.success).length})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-800 mb-1",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:k.length})]})]}),k.filter(e=>!e.success).length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-red-800 mb-2",children:"Failed Imports:"}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:e.jsx("ul",{className:"text-sm text-red-700 space-y-1",children:k.filter(e=>!e.success).map((t,s)=>e.jsxs("li",{children:["Row ",t.rowNumber,": ",t.error]},s))})})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(s,{onClick:()=>w("preview"),variant:"secondary",className:"flex-1",disabled:y,children:"Back"}),e.jsx(s,{onClick:async()=>{if("admin"!==(null==o?void 0:o.role))return void T.error("Only administrators can import customers");const e=L?I:m;if(0===e.length)return void T.error("No data to import. Please add at least one customer.");M.length>0&&T.error(`Found ${M.length} validation errors. Invalid rows will be skipped.`);try{v(!0),S(0),D([]);const s=[],a=[];for(let i=0;i<e.length;i++){const r=e[i],n=Z(r,i+2);if(n.length>0)a.push({success:!1,error:`Validation errors: ${n.join(", ")}`,rowNumber:i+2});else{try{const e=await l({id:crypto.randomUUID(),name:r.name,email:r.email,phone:J(r.phone),gender:r.gender,city:r.city,whatsapp:Y(r.whatsapp||""),initialNotes:r.notes,loyaltyLevel:r.loyaltyLevel||"bronze",colorTag:r.colorTag||"new",birthMonth:r.birthMonth,birthDay:r.birthDay,referralSource:r.referralSource,joinedDate:(new Date).toISOString(),totalSpent:0,points:0,lastVisit:(new Date).toISOString(),isActive:!0,notes:[],referrals:[]});e?(s.push(e),a.push({success:!0,customer:e,rowNumber:i+2})):a.push({success:!1,error:"Failed to create customer",rowNumber:i+2})}catch(t){a.push({success:!1,error:t instanceof Error?t.message:"Unknown error",rowNumber:i+2})}S((i+1)/e.length*100),D(a)}}const r=a.filter(e=>e.success).length,n=a.filter(e=>{var t;return!e.success&&(null==(t=e.error)?void 0:t.includes("Validation errors"))}).length,o=a.filter(e=>{var t;return!e.success&&!(null==(t=e.error)?void 0:t.includes("Validation errors"))}).length;r>0&&(T.success(`Successfully imported ${r} customers!`),i(s)),n>0&&T.success(`Skipped ${n} rows with validation errors.`),o>0&&T.error(`${o} customers failed to import. Check the results below.`),w("import")}catch(t){T.error("Error importing customers. Please try again.")}finally{v(!1)}},disabled:y||M.length>0,className:"flex-1",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Importing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"Import Customers"]})})]})]})]})}):null},Fe=u.memo(({isOpen:t,onClose:s,onImportComplete:a})=>{x.useEffect(()=>{},[t]);const{currentUser:l}=r(),[c,d]=x.useState(null),[m,u]=x.useState([]),[h,p]=x.useState([]),[g,f]=x.useState(!1),[y,v]=x.useState(!1),[N,w]=x.useState("upload"),[C,S]=x.useState(0),[k,D]=x.useState([]),[M,A]=x.useState([]),[L,F]=x.useState(new Map),[I,z]=x.useState(new Map),[P,O]=x.useState(!0),[J,Y]=x.useState([]),[q,H]=x.useState(!0),K=x.useRef(null),Q=ue,X=he,Z=x.useCallback(e=>{if(!e)return"";const t=e.trim();return t===t.toUpperCase()&&t.length>1||t===t.toUpperCase()?t.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):t},[]),ee=x.useCallback(e=>{if(!e)return"male";const t=e.trim().toLowerCase();return"male"===t||"m"===t?"male":"female"===t||"f"===t?"female":"other"===t||"o"===t?"other":"male"},[]),te=x.useCallback(e=>{if(!e)return"";return{facebook:"Facebook",twitter:"Twitter",tiktok:"TikTok",friend:"Friend",family:"Family","walk-in":"Walk-in",walkin:"Walk-in","walk in":"Walk-in","social media":"Social Media",socialmedia:"Social Media",google:"Google",search:"Google",website:"Website",referral:"Referral","word of mouth":"Word of Mouth",wordofmouth:"Word of Mouth",advertisement:"Advertisement",ad:"Advertisement",flyer:"Flyer",poster:"Poster",radio:"Radio",tv:"TV",newspaper:"Newspaper",magazine:"Magazine",other:"Other"}[e.trim().toLowerCase()]||e.trim()},[]),se=e=>{if(!e)return"";const t=e.trim();return t===t.toUpperCase()&&t.length>1||t===t.toUpperCase()?t.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()):t},ae=e=>{if(!e)return{month:"",day:""};const t=e.trim(),s=t.split("/");if(2===s.length){const[e,t]=s,a=parseInt(e),r=parseInt(t);if(a>12&&r<=12)return{month:t,day:e};if(r>12&&a<=12)return{month:e,day:t};if(a<=12&&r<=31)return{month:e,day:t}}const a=["january","february","march","april","may","june","july","august","september","october","november","december"],r=t.toLowerCase();for(let l=0;l<a.length;l++)if(r.includes(a[l])){const e=(l+1).toString(),s=t.match(/\d+/);return{month:e,day:s?s[0]:""}}return{month:"",day:""}},re=e=>{if(!e)return"new";return{new:"new",vip:"vip",complainer:"complainer",purchased:"purchased",normal:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[e.trim().toLowerCase()]||"new"},le=(e,t)=>{const s=[];return(!e.name||e.name.trim().length<2)&&s.push("Name must be at least 2 characters"),(!e.phone||e.phone.trim().length<10)&&s.push("Phone number must be at least 10 digits"),e.email&&!e.email.includes("@")&&s.push("Invalid email format"),e.birthDay&&(parseInt(e.birthDay)<1||parseInt(e.birthDay)>31)&&s.push("Birth day must be between 1 and 31"),e.birthMonth&&(parseInt(e.birthMonth)<1||parseInt(e.birthMonth)>12)&&s.push("Birth month must be between 1 and 12"),s},ne=(e,t)=>{const s=["email","gender","city","whatsapp","birthMonth","birthDay","referralSource","locationDescription","nationalId","referredBy"];for(const a of s){const s=e[a],r=t[a];if(s&&!r)return!0}return!1},ie=async e=>{var t,s,a;try{f(!0),A([]);const r=(await e.text()).split("\n").filter(e=>e.trim());if(r.length<2)return void T.error("File must contain at least a header row and one data row");const l=(null==(t=r[0])?void 0:t.split(",").map(e=>e.trim().toLowerCase()))||[],n=[],i=[];for(let e=1;e<r.length;e++){const t=r[e].trim();if(!t)continue;const o=t.split(",").map(e=>e.trim().replace(/^"|"$/g,"")),c=o[l.indexOf("phone")]||o[l.indexOf("phone number")]||o[l.indexOf("mobile")]||o[l.indexOf("mobile phone")]||o[l.indexOf("primary phone")]||o[l.indexOf("phone 1 - value")]||"",d=o[l.indexOf("whatsapp")]||o[l.indexOf("whatsapp number")]||"",m={name:Z(o[l.indexOf("name")]||""),email:o[l.indexOf("email")]||"",phone:Q(c),gender:ee(o[l.indexOf("gender")]||""),city:se(o[l.indexOf("city")]||""),whatsapp:X(d),notes:o[l.indexOf("notes")]||o[l.indexOf("initial notes")]||"",loyaltyLevel:o[l.indexOf("loyalty level")]||"bronze",colorTag:re(o[l.indexOf("color tag")]||""),referralSource:te(o[l.indexOf("referral source")]||""),locationDescription:o[l.indexOf("location description")]||"",nationalId:o[l.indexOf("national id")]||"",referredBy:o[l.indexOf("referred by")]||"",totalSpent:parseFloat(o[l.indexOf("total spent")]||"0")||0,points:parseInt(o[l.indexOf("points")]||"0")||0,isActive:"yes"===(null==(s=o[l.indexOf("is active")])?void 0:s.toLowerCase())||"true"===(null==(a=o[l.indexOf("is active")])?void 0:a.toLowerCase()),profileImage:o[l.indexOf("profile image")]||""},x=o[l.indexOf("birth month")]||o[l.indexOf("birthday")]||"";if(x){const{month:e,day:t}=ae(x);m.birthMonth=e,m.birthDay=t}const u=le(m);u.length>0&&i.push(`Row ${e+2}: ${u.join(", ")}`),n.push(m)}u(n),A(i);const c=await(async e=>{try{const t=await o(),s=new Map,a=new Map,r=new Map,l=new Map,n=new Map;return t.forEach(e=>{if(e.phone){const t=e.phone.replace(/[^0-9]/g,"");r.set(t,e)}if(e.whatsapp){const t=e.whatsapp.replace(/[^0-9]/g,"");l.set(t,e)}e.email&&n.set(e.email.toLowerCase(),e)}),e.forEach(e=>{var t;const s=e.phone.replace(/[^0-9]/g,""),i=(null==(t=e.whatsapp)?void 0:t.replace(/[^0-9]/g,""))||"",o=e.email.toLowerCase(),c=r.get(s)||l.get(s)||l.get(i)||n.get(o);c&&a.set(e.phone,c)}),F(s),z(a),a.size,e.length,a}catch(t){return T.error("Failed to load existing customers"),new Map}})(n),d=n.filter(e=>c.has(e.phone));Y(d),p(d),0===c.size?T("No existing customers found to update. Make sure phone numbers match existing records."):T.success(`Found ${c.size} existing customers to update`),w("preview")}catch(r){T.error("Failed to process CSV file")}finally{f(!1)}},oe=()=>{d(null),u([]),p([]),Y([]),D([]),A([]),w("upload"),S(0),F(new Map),z(new Map),O(!0),H(!0),K.current&&(K.current.value=""),s()};return x.useEffect(()=>{const e=()=>{window.innerWidth<768&&H(!1)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed bg-black/50",onClick:s,style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:35}}),e.jsx("div",{className:"fixed flex items-center justify-center p-4",style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:50,pointerEvents:"none"},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(_,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Update Customers from CSV"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Update existing customer records with new data"})]})]}),e.jsx("button",{onClick:oe,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(j,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[q&&e.jsx("div",{className:"w-72 bg-gray-50 border-r border-gray-200 p-6 overflow-y-auto",children:e.jsxs("div",{className:"space-y-4",children:["upload"===N&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white hover:border-blue-400 transition-colors",children:[e.jsx($,{className:"w-10 h-10 text-blue-500 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-700 font-medium mb-3 text-sm",children:"Upload CSV file to update existing customers"}),e.jsx("input",{ref:K,type:"file",accept:".csv",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];s&&(d(s),ie(s))},className:"hidden"}),e.jsx("button",{onClick:()=>{var e;return null==(e=K.current)?void 0:e.click()},disabled:g,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:g?"Processing...":"Choose CSV File"})]}),e.jsxs("button",{onClick:()=>{const e=new Blob(["Name,Email,Phone,Gender,City,WhatsApp,Notes,Loyalty Level,Color Tag,Referral Source,Location Description,National ID,Referred By,Birth Month,Birth Day\nJohn Doe,john@example.com,+255123456789,male,Dar es Salaam,+255123456789,New customer notes,bronze,normal,Facebook,City Center,123456789,John Smith,January,15\nJane Smith,jane@example.com,+255987654321,female,Arusha,+255987654321,Another customer,bronze,vip,Friend,Suburb Area,987654321,Jane Doe,March,22"],{type:"text/csv"}),t=window.URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="customer_update_template.csv",document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(t)},className:"w-full px-4 py-2 border-2 border-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),"Download Template"]})]}),"preview"===N&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Preview"}),e.jsx("button",{onClick:()=>{if(O(!P),P)Y(m),p(m);else{const e=m.filter(e=>I.has(e.phone));Y(e),p(e)}},className:"px-3 py-1 text-xs border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-colors",children:P?"Show All":"Matched Only"})]}),e.jsxs("div",{className:"space-y-2 bg-white p-4 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:m.length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Matched:"}),e.jsx("span",{className:"font-semibold text-green-600",children:I.size})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Unmatched:"}),e.jsx("span",{className:"font-semibold text-yellow-600",children:m.length-I.size})]})]}),M.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(B,{className:"w-4 h-4 text-yellow-600"}),e.jsxs("span",{className:"text-sm font-medium text-yellow-800",children:[M.length," Validation Errors"]})]}),e.jsxs("div",{className:"text-xs text-yellow-700 max-h-32 overflow-y-auto space-y-1",children:[M.slice(0,5).map((t,s)=>e.jsxs("div",{children:["â€¢ ",t]},s)),M.length>5&&e.jsxs("div",{className:"font-medium",children:["... and ",M.length-5," more"]})]})]}),e.jsx("button",{onClick:async()=>{var e;if("admin"!==(null==l?void 0:l.role))return void T.error("Only administrators can update customers via CSV import.");const t=J;if(0!==t.length)try{v(!0),S(0),D([]);const o=[],c=[];for(let a=0;a<t.length;a++){const d=t[a],m=I.get(d.phone);if(m)if(ne(d,m)){try{const t={};if(d.email&&!m.email&&(t.email=d.email),d.gender&&!m.gender&&(t.gender=d.gender),d.city&&!m.city&&(t.city=d.city),d.whatsapp&&!m.whatsapp&&(t.whatsapp=d.whatsapp),d.birthMonth&&!m.birthMonth&&(t.birthMonth=d.birthMonth),d.birthDay&&!m.birthDay&&(t.birthDay=d.birthDay),d.referralSource&&!m.referralSource&&(t.referralSource=d.referralSource),d.locationDescription&&!m.locationDescription&&(t.locationDescription=d.locationDescription),d.nationalId&&!m.nationalId&&(t.nationalId=d.nationalId),d.referredBy&&!m.referredBy&&(t.referredBy=d.referredBy),d.notes&&!(null==(e=m.notes)?void 0:e.length))try{await n.from("customer_notes").insert({id:crypto.randomUUID(),content:d.notes,created_by:l.id,created_at:(new Date).toISOString(),customer_id:m.id})}catch(s){}if(Object.keys(t).length>0){const e=await i(m.id,t);e?(o.push(e),c.push({success:!0,customer:e,rowNumber:a+2,existingCustomer:m})):c.push({success:!1,error:"Failed to update customer",rowNumber:a+2,existingCustomer:m})}else c.push({success:!1,error:"No fields to update",rowNumber:a+2,skipped:!0,reason:"All fields already populated",existingCustomer:m})}catch(r){c.push({success:!1,error:r instanceof Error?r.message:"Unknown error",rowNumber:a+2,existingCustomer:m})}S((a+1)/t.length*100)}else c.push({success:!1,error:"No null fields to update",rowNumber:a+2,skipped:!0,reason:"No updates needed",existingCustomer:m});else c.push({success:!1,error:"No existing customer found to update",rowNumber:a+2,skipped:!0,reason:"No match found"})}D(c);const d=c.filter(e=>e.success).length,m=(c.filter(e=>e.skipped).length,c.filter(e=>!e.success&&!e.skipped).length);d>0&&(T.success(`Successfully updated ${d} customers`),a(o)),m>0&&T.error(`${m} customers failed to update`),w("import")}catch(r){T.error("Failed to import customers")}finally{v(!1)}else T.error("No customers to update. Please ensure you have matched customers.")},disabled:0===I.size||y,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:y?"Updating...":`Update ${I.size} Customers`})]}),"import"===N&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Import Results"}),e.jsxs("div",{className:"space-y-2 bg-white p-4 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Updated:"}),e.jsx("span",{className:"font-semibold text-green-600",children:k.filter(e=>e.success).length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Skipped:"}),e.jsx("span",{className:"font-semibold text-yellow-600",children:k.filter(e=>e.skipped).length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Errors:"}),e.jsx("span",{className:"font-semibold text-red-600",children:k.filter(e=>!e.success&&!e.skipped).length})]})]}),e.jsx("button",{onClick:oe,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors",children:"Close"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[y&&e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${C}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 font-semibold min-w-[40px]",children:[Math.round(C),"%"]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:["upload"===N&&e.jsxs("div",{className:"text-center py-12 max-w-xl mx-auto",children:[e.jsx("div",{className:"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(U,{className:"w-10 h-10 text-blue-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Update Existing Customers"}),e.jsx("p",{className:"text-gray-600 max-w-md mx-auto mb-6",children:"Upload a CSV file to update existing customer records. Only empty fields in existing customers will be filled with new data."}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 text-left",children:[e.jsxs("h4",{className:"font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"How it works"]}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"â€¢ Customers are matched by phone number"}),e.jsx("li",{children:"â€¢ Only empty/null fields will be updated"}),e.jsx("li",{children:"â€¢ Existing data is never overwritten"}),e.jsx("li",{children:"â€¢ You'll see a preview before confirming"})]})]})]}),"preview"===N&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-900",children:["Preview (",J.length," customers)"]}),e.jsx("button",{onClick:()=>H(!q),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600",children:q?e.jsx(V,{className:"w-5 h-5"}):e.jsx(W,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Phone"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Email"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"City"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:J.map((t,s)=>{const a=I.get(t.phone),r=!!a&&ne(t,a);return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700 font-medium",children:t.phone}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:t.email||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:t.city||"-"}),e.jsx("td",{className:"px-4 py-3",children:a?r?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700",children:[e.jsx(b,{className:"w-3 h-3 mr-1"}),"Will Update"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),"No Updates"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(B,{className:"w-3 h-3 mr-1"}),"No Match"]})})]},s)})})]})})})]}),"import"===N&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:"Import Results"}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Row"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Details"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:k.map((t,s)=>{var a;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 font-medium",children:t.rowNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:(null==(a=t.existingCustomer)?void 0:a.name)||"Unknown"}),e.jsx("td",{className:"px-4 py-3",children:t.success?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700",children:[e.jsx(b,{className:"w-3 h-3 mr-1"}),"Updated"]}):t.skipped?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),"Skipped"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(B,{className:"w-3 h-3 mr-1"}),"Error"]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:t.error||t.reason||"Success"})]},s)})})]})})})]})]})]})]})]})})]}):null}),Ie=({children:t,anchorRef:s,open:a,onClose:r,width:l})=>{const[n,i]=x.useState({top:0,left:0}),o=x.useRef(null);return x.useEffect(()=>{if(a&&s.current){const e=s.current.getBoundingClientRect();i({top:e.bottom+window.scrollY,left:e.left+window.scrollX})}},[a,s]),x.useEffect(()=>{if(a)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){o.current&&!o.current.contains(e.target)&&s.current&&!s.current.contains(e.target)&&r&&r()}},[a,r,s]),a?h.createPortal(e.jsx("div",{ref:o,style:{position:"absolute",top:n.top,left:n.left,zIndex:9999,minWidth:l||180,background:"#fff",border:"1px solid #e5e7eb",borderRadius:8,boxShadow:"0 4px 24px 0 rgba(0,0,0,0.10)",padding:0},children:t}),document.body):null},ze=async()=>{try{const s=localStorage.getItem("current_branch_id"),{count:a,error:r}=await n.from("customers").select("id",{count:"exact",head:!0}),{count:l,error:i}=await n.from("customers").select("id",{count:"exact",head:!0}).eq("is_active",!0),o=new Date,c=o.getMonth()+1,d=o.getDate(),{data:m,error:x}=await n.from("customers").select("id, birth_month, birth_day").not("birth_month","is",null).not("birth_day","is",null),u=(null==m?void 0:m.filter(e=>{if(!e.birth_month||!e.birth_day)return!1;let t,s;if("string"!=typeof e.birth_month)return!1;{if(""===e.birth_month.trim())return!1;const s=parseInt(e.birth_month);if(!isNaN(s)&&s>=1&&s<=12)t=s;else{t=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(e.birth_month.toLowerCase())+1}}if("string"==typeof e.birth_day){if(""===e.birth_day.trim())return!1;const t=e.birth_day.match(/^(\d+)/);s=t?parseInt(t[1]):parseInt(e.birth_day)}else s=parseInt(e.birth_day);return t===c&&s===d}).length)||0;let h=0,p=null;try{let e=n.from("devices").select("id",{count:"exact",head:!0});s&&(e=e.eq("branch_id",s));const t=await e;h=t.count||0,p=t.error}catch(e){try{const e=await n.from("devices").select("id",{count:"exact",head:!0});h=e.count||0,p=e.error}catch(t){p=t}}let g=0,b=null;if(s)try{const{data:e,error:t}=await n.from("customers").select("total_spent").eq("branch_id",s);t||(g=(null==e?void 0:e.reduce((e,t)=>e+(t.total_spent||0),0))||0)}catch(e){b=e}return{totalCustomers:a||0,activeCustomers:l||0,todaysBirthdays:u,totalRevenue:g,totalDevices:h||0}}catch(e){return{totalCustomers:0,activeCustomers:0,todaysBirthdays:0,totalRevenue:0,totalDevices:0}}},Te=({todaysBirthdays:a,onClose:r,onViewCustomers:l})=>0===a.length?null:e.jsx("div",{className:"fixed top-20 right-4 bottom-4 sm:bottom-auto z-[9999] w-80 sm:w-96 max-h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx(t,{className:"p-4 bg-gradient-to-r from-pink-50 to-purple-50 border-pink-200 shadow-2xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center",children:e.jsx(A,{className:"w-5 h-5 text-pink-600"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-pink-900",children:"ðŸŽ‰ Birthday Alert!"}),r&&e.jsx("button",{onClick:r,className:"text-pink-500 hover:text-pink-700 transition-colors",children:e.jsx(j,{className:"w-4 h-4"})})]}),e.jsxs("p",{className:"text-sm text-pink-800 mb-3",children:[a.length," customer",a.length>1?"s":""," celebrating their birthday today!"]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[a.slice(0,3).map(t=>e.jsxs("div",{className:"flex items-center gap-2 text-xs p-2 bg-white/50 rounded-lg",children:[e.jsx("div",{className:"w-6 h-6 bg-pink-200 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-pink-700 font-medium text-xs",children:t.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-pink-800 font-medium truncate block",children:t.name}),t.phone&&e.jsx("span",{className:"text-pink-600 text-xs block truncate",children:t.phone})]}),t.loyaltyLevel&&e.jsx("span",{className:"px-1.5 py-0.5 rounded-full text-xs font-medium flex-shrink-0 "+("platinum"===t.loyaltyLevel?"bg-purple-100 text-purple-700":"gold"===t.loyaltyLevel?"bg-yellow-100 text-yellow-700":"silver"===t.loyaltyLevel?"bg-gray-100 text-gray-700":"bg-orange-100 text-orange-700"),children:t.loyaltyLevel})]},t.id)),a.length>3&&e.jsxs("div",{className:"text-xs text-pink-600 font-medium text-center py-2 bg-pink-100/50 rounded-lg",children:["+",a.length-3," more celebrating today"]})]}),l&&e.jsxs(s,{onClick:l,className:"w-full bg-pink-600 hover:bg-pink-700 text-white text-sm py-3 font-medium",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"View All Birthday Customers"]})]})]})})}),Pe=({todaysBirthdays:a,onClose:r})=>{const[l,n]=x.useState(!1),[i,o]=x.useState([]),[c,d]=x.useState("whatsapp"),m={sms:"Happy Birthday! ðŸŽ‰ Thank you for choosing our services. We hope your special day is filled with joy! - LATS Team",whatsapp:"ðŸŽ‰ *Happy Birthday!* ðŸŽ‰\n\nDear {name},\n\nWishing you a fantastic birthday filled with joy and happiness! Thank you for being a valued customer.\n\nMay your day be as special as you are! ðŸŽ‚âœ¨\n\nBest regards,\nLATS Team"};return 0===a.length?null:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx(t,{className:"max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-pink-600"}),"Send Birthday Messages"]}),r&&e.jsx("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(j,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Message Type"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"messageType",value:"whatsapp",checked:"whatsapp"===c,onChange:e=>d(e.target.value),className:"text-pink-600"}),e.jsx(Y,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm",children:"WhatsApp"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"messageType",value:"sms",checked:"sms"===c,onChange:e=>d(e.target.value),className:"text-pink-600"}),e.jsx(q,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm",children:"SMS"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Select Customers (",i.length,"/",a.length,")"]}),e.jsx("button",{onClick:()=>{i.length===a.length?o([]):o(a.map(e=>e.id))},className:"text-sm text-pink-600 hover:text-pink-700 font-medium",children:i.length===a.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:a.map(t=>e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:i.includes(t.id),onChange:()=>{return e=t.id,void o(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e]);var e},className:"text-pink-600 rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-gray-900",children:t.name}),t.loyaltyLevel&&e.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+("platinum"===t.loyaltyLevel?"bg-purple-100 text-purple-700":"gold"===t.loyaltyLevel?"bg-yellow-100 text-yellow-700":"silver"===t.loyaltyLevel?"bg-gray-100 text-gray-700":"bg-orange-100 text-orange-700"),children:t.loyaltyLevel})]}),e.jsx("div",{className:"text-sm text-gray-600",children:"whatsapp"===c?t.whatsapp||"No WhatsApp":t.phone})]})]},t.id))})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Message Preview"}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-sm text-gray-700",children:m[c].replace("{name}","Customer Name")})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[r&&e.jsx(s,{onClick:r,variant:"outline",disabled:l,children:"Cancel"}),e.jsx(s,{onClick:async()=>{if(0!==i.length){n(!0);try{const e=a.filter(e=>i.includes(e.id));for(const t of e){m[c].replace("{name}",t.name);("whatsapp"===c&&t.whatsapp||"sms"===c&&t.phone)&&await new Promise(e=>setTimeout(e,1e3))}T.success(`Birthday messages sent to ${e.length} customer(s)!`),o([])}catch(e){T.error("Failed to send birthday messages")}finally{n(!1)}}else T.error("Please select at least one customer")},disabled:0===i.length||l,className:"bg-pink-600 hover:bg-pink-700 text-white",children:l?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Send Messages (",i.length,")"]})})]})]})})})},$e=({customers:s,onCustomerClick:a})=>{const[r,l]=x.useState((new Date).getFullYear()),n=["January","February","March","April","May","June","July","August","September","October","November","December"],i=["january","february","march","april","may","june","july","august","september","october","november","december"],o=x.useMemo(()=>{const e={};return s.forEach(t=>{if(!t.birthMonth||!t.birthDay)return;let s,a;if("string"==typeof t.birthMonth){{if(""===t.birthMonth.trim())return;const e=parseInt(t.birthMonth);s=!isNaN(e)&&e>=1&&e<=12?e:i.indexOf(t.birthMonth.toLowerCase())+1}if("string"==typeof t.birthDay){if(""===t.birthDay.trim())return;const e=t.birthDay.match(/^(\d+)/);a=e?parseInt(e[1]):parseInt(t.birthDay)}else a=parseInt(t.birthDay);if(s&&a){const r=`${s}-${a}`;e[r]||(e[r]=[]),e[r].push(t)}}}),e},[s]),c=e=>n[e],d=(e,t)=>{const s=new Date;return s.getDate()===e&&s.getMonth()===t&&s.getFullYear()===r};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(I,{className:"w-6 h-6 text-pink-600"}),"Birthday Calendar ",r]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>l(e=>e-1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(K,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-lg font-semibold text-gray-700",children:r}),e.jsx("button",{onClick:()=>l(e=>e+1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Q,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:n.map((s,l)=>{const n=(e=>{const t=[];return Object.keys(o).forEach(s=>{const[a,r]=s.split("-").map(Number);a===e+1&&t.push({day:r,customers:o[s]})}),t.sort((e,t)=>e.day-t.day)})(l),i=new Date(r,l+1,0).getDate();return e.jsxs(t,{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:c(l)}),e.jsxs("p",{className:"text-sm text-gray-600",children:[n.length," birthday",1!==n.length?"s":""]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-1 text-xs",children:[["S","M","T","W","T","F","S"].map(t=>e.jsx("div",{className:"text-center text-gray-500 font-medium py-1",children:t},t)),Array.from({length:i},(t,s)=>{const i=s+1,o=n.find(e=>e.day===i),c=d(i,l),m=((e,t)=>{const s=new Date;return new Date(r,t,e)<s&&!d(e,t)})(i,l);return e.jsxs("div",{className:`\n                        relative p-1 text-center cursor-pointer rounded transition-colors\n                        ${c?"bg-pink-500 text-white font-bold":""}\n                        ${m?"text-gray-400":"text-gray-700"}\n                        ${o&&!c?"bg-pink-50 hover:bg-pink-100":"hover:bg-gray-50"}\n                      `,onClick:()=>o&&(null==a?void 0:a(o.customers[0])),children:[e.jsx("span",{className:"text-xs",children:i}),o&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-pink-500 rounded-full"})]},i)})]}),n.length>0&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsx("div",{className:"space-y-1",children:n.map(({day:t,customers:s})=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("div",{className:"w-4 h-4 bg-pink-100 rounded-full flex items-center justify-center",children:e.jsx(A,{className:"w-2 h-2 text-pink-600"})}),e.jsx("span",{className:"font-medium text-gray-700",children:t}),e.jsxs("span",{className:"text-gray-600",children:[s.length," customer",s.length>1?"s":""]}),d(t,l)&&e.jsx("span",{className:"text-pink-600 font-medium",children:"Today!"})]},t))})})]},l)})})]})},Oe=({todaysBirthdays:a,onApplyReward:r})=>{const[l,n]=x.useState({}),i=[{id:"discount_20",name:"20% Birthday Discount",description:"20% off on any service or product",icon:X,color:"bg-green-100 text-green-700",value:20},{id:"free_diagnosis",name:"Free Device Diagnosis",description:"Complimentary device health check",icon:C,color:"bg-blue-100 text-blue-700",value:"Free"},{id:"double_points",name:"Double Loyalty Points",description:"Earn 2x points on all purchases",icon:Z,color:"bg-purple-100 text-purple-700",value:"2x"},{id:"priority_service",name:"Priority Service",description:"Skip the queue for faster service",icon:ee,color:"bg-orange-100 text-orange-700",value:"Priority"}];return 0===a.length?null:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(A,{className:"w-6 h-6 text-pink-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Birthday Rewards & Special Offers"})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:a.map(a=>e.jsxs(t,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center",children:e.jsx(A,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-900",children:a.name}),e.jsx("p",{className:"text-sm text-gray-600",children:"ðŸŽ‰ Birthday Today!"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("select",{value:l[a.id]||"",onChange:e=>n(t=>({...t,[a.id]:e.target.value})),className:"w-full p-2 border border-gray-300 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select a birthday reward..."}),i.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(s,{onClick:()=>(e=>{const t=l[e];t&&(null==r||r(e,t),T.success("Birthday reward applied successfully!"))})(a.id),disabled:!l[a.id],className:"flex-1 bg-pink-600 hover:bg-pink-700 text-white",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Apply Reward"]}),e.jsxs(s,{onClick:()=>T.success("Birthday message sent!"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Send Wishes"]})]})]})]},a.id))})]})};function Re(e){if(null==e)return"";const t=String(e);return t.includes('"')?'"'+t.replace(/"/g,'""')+'"':t.includes(",")||t.includes("\n")?'"'+t+'"':t}const Ee="customersPagePrefs",Be=()=>{const{currentUser:a}=r(),l=p(),[i]=g(),{markCustomerAsRead:o}=c();(()=>{const[e,t]=x.useState(null),[s,a]=x.useState(!0),[r,l]=x.useState(!1),[n,i]=x.useState(!1),[o,c]=x.useState(!1),[d,m]=x.useState(null),u=x.useCallback(async()=>{a(!0),m(null);try{const e=await ye.getComprehensiveFinancialData();t(e)}catch(e){m(e instanceof Error?e.message:"Failed to fetch financial data")}finally{a(!1)}},[]),h=x.useCallback(async()=>{await u()},[u]),p=x.useCallback(async()=>{l(!0);try{const e=await ye.getPayments();t(t=>t?{...t,payments:e}:null)}catch(e){m(e instanceof Error?e.message:"Failed to refresh payments")}finally{l(!1)}},[]),g=x.useCallback(async()=>{i(!0);try{const e=await ye.getExpenses();t(t=>t?{...t,expenses:e}:null)}catch(e){m(e instanceof Error?e.message:"Failed to refresh expenses")}finally{i(!1)}},[]),b=x.useCallback(async()=>{c(!0);try{const e=await ye.getAccounts();t(t=>t?{...t,accounts:e}:null)}catch(e){m(e instanceof Error?e.message:"Failed to refresh accounts")}finally{c(!1)}},[]),f=x.useCallback(async(e,t)=>{try{return await ye.getFinancialDataForPeriod(e,t)}catch(s){return m(s instanceof Error?s.message:"Failed to fetch period data"),null}},[]),y=x.useCallback(async(e="csv")=>{try{return await ye.exportFinancialData(e)}catch(t){throw m(t instanceof Error?t.message:"Failed to export data"),t}},[]),j=x.useCallback(()=>{m(null)},[]);x.useEffect(()=>{u()},[u]),null==e||e.summary,null==e||e.payments,null==e||e.expenses,null==e||e.accounts,null==e||e.transfers,null==e||e.revenue,null==e||e.trends})();const u=we(),h=(()=>{if("undefined"==typeof window)return{};try{const e=localStorage.getItem(Ee);return e?JSON.parse(e):{}}catch{return{}}})(),[y,v]=x.useState(""),[N,w]=x.useState(""),[M,F]=x.useState(h.loyaltyFilter??"all"),[P,$]=x.useState(h.statusFilter??"all"),[E,U]=x.useState(h.showInactive??!1),[V,G]=x.useState(h.showAdvancedFilters??!1),[J,Y]=x.useState([]),[H,K]=x.useState(h.viewMode??"grid"),[X,Z]=x.useState(!1),[xe,ue]=x.useState(!1),[he,Be]=x.useState(!1),[_e,Ue]=x.useState(!1),[Ve,We]=x.useState(!1),[Ge,Je]=x.useState(!1),[Ye,qe]=x.useState(!1),He=x.useRef(null),[Ke,Qe]=x.useState(null),[Xe,Ze]=x.useState([]),[et,tt]=x.useState(!0),[st,at]=x.useState(null),[rt,lt]=x.useState(!navigator.onLine),[nt,it]=x.useState(h.sortBy??"name"),[ot,ct]=x.useState(!1),[dt,mt]=x.useState(!1),[xt,ut]=x.useState(!1),[ht,pt]=x.useState("pending"),[gt,bt]=x.useState(0),[ft,yt]=x.useState(null),[jt,vt]=x.useState(1),[Nt,wt]=x.useState(1),[Ct,St]=x.useState(0),[kt,Dt]=x.useState(!1),[Mt,At]=x.useState(!1),[Lt,Ft]=x.useState(!1),It=x.useRef(null),[zt,Tt]=x.useState([]),[Pt,$t]=x.useState([]),[Ot,Rt]=x.useState([]),[Et,Bt]=x.useState([]),[_t,Ut]=x.useState(!1),[Vt,Wt]=x.useState(!1),[Gt,Jt]=x.useState([]),[Yt,qt]=x.useState(""),[Ht,Kt]=x.useState(""),[Qt,Xt]=x.useState(""),[Zt,es]=x.useState(""),[ts,ss]=x.useState([]),[as,rs]=x.useState(""),[ls,ns]=x.useState(""),[is,os]=x.useState(""),[cs,ds]=x.useState(""),[ms,xs]=x.useState(""),[us,hs]=x.useState(""),[ps,gs]=x.useState("customers"),[bs,fs]=x.useState([]),[ys,js]=x.useState({status:"all",date:"all",customer:"all"}),[vs,Ns]=x.useState(0),[ws,Cs]=x.useState(0),[Ss,ks]=x.useState({totalCustomers:0,activeCustomers:0,todaysBirthdays:0,totalRevenue:0,totalDevices:0}),[Ds,Ms]=x.useState(!0),[As,Ls]=x.useState(!0),[Fs,Is]=x.useState(!1),[zs,Ts]=x.useState(!1),[Ps,$s]=x.useState(!1),[Os,Rs]=x.useState(!1),[Es,Bs]=x.useState(!1),[_s,Us]=x.useState(null),[Vs,Ws]=x.useState("create");x.useEffect(()=>{const e=setTimeout(()=>{w(y)},300);return()=>clearTimeout(e)},[y]),x.useEffect(()=>{localStorage.setItem(Ee,JSON.stringify({loyaltyFilter:M,statusFilter:P,showInactive:E,showAdvancedFilters:V,viewMode:H,sortBy:nt}))},[M,P,E,V,H,nt]),x.useEffect(()=>{let e=null,t=!0;(async()=>{try{if(1===jt?tt(!0):Ft(!0),ft){Se().cancelSearchJob(ft)}if(N.trim()&&N.trim().length>=2){ut(!0),pt("processing"),bt(20),mt(!0),e=setInterval(()=>{bt(e=>e<90?e+10:e)},100);try{const s=await ke(N,jt,100);if(!t)return;let a;e&&(clearInterval(e),e=null),1===jt?(a=s.customers,Ze(s.customers)):(a=[...Xe,...s.customers],Ze(a));const r=s.total||0,l=s.customers.length>=100;St(r>0?r:a.length),wt(s.totalPages>0?s.totalPages:l?jt+1:jt),Dt(jt<s.totalPages||l&&0===r),At(jt>1),bt(100),pt("completed"),setTimeout(()=>{t&&ut(!1)},500),yt(null)}catch(s){throw e&&(clearInterval(e),e=null),s}}else{ut(!1),mt(!1);const e=await ge(jt,100);if(!t)return;let s;1===jt?(s=e.customers,Ze(e.customers)):(s=[...Xe,...e.customers],Ze(s));const a=e.totalCount||0,r=e.customers.length>=100;St(a>0?a:s.length),wt(e.totalPages>0?e.totalPages:r?jt+1:jt),Dt(e.hasNextPage||r&&0===a),At(e.hasPreviousPage)}}catch(a){if(e&&(clearInterval(e),e=null),!t)return;const s=a instanceof Error?a.message:"Failed to load customers";at(s),bt(0),pt("failed"),ut(!1),T.error(`Failed to load customers: ${s.includes("timed out")?"Request timed out. Please try again.":s}`,{duration:5e3,position:"top-center"})}finally{t&&(tt(!1),Ft(!1),mt(!1))}})();const s=()=>lt(!1),a=()=>lt(!0);return window.addEventListener("online",s),window.addEventListener("offline",a),()=>{t=!1,e&&clearInterval(e),window.removeEventListener("online",s),window.removeEventListener("offline",a)}},[jt,N]),x.useEffect(()=>{Ue(!1),Be(!1),We(!1),Z(!1)},[]),x.useEffect(()=>{const e=new IntersectionObserver(e=>{e[0].isIntersecting&&kt&&!Lt&&!et&&vt(e=>e+1)},{threshold:.1}),t=It.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}},[kt,Lt,et]),x.useEffect(()=>{(async()=>{try{const e=await je();fs(e)}catch(e){fs([])}})()},[]),x.useEffect(()=>{(async()=>{try{const{count:e,error:t}=await n.from("devices").select("id",{count:"exact",head:!0});t||Ns(e||0);const{count:s,error:a}=await n.from("devices").select("id",{count:"exact",head:!0}).in("status",["in-repair","diagnosis-started"]);a||Cs(s||0)}catch(e){}})()},[]),x.useEffect(()=>{(async()=>{try{Ms(!0);const e=await ze();ks(e)}catch(e){}finally{Ms(!1)}})()},[]);const Gs=x.useMemo(()=>{if(!Xe||!Array.isArray(Xe))return{totalCustomers:Ss.totalCustomers,pageCustomers:0,activeCustomers:Ss.activeCustomers,vipCustomers:0,totalRevenue:Ss.totalRevenue,deviceRevenue:0,posRevenue:0,totalPoints:0,platinumCustomers:0,goldCustomers:0,silverCustomers:0,bronzeCustomers:0,totalDevices:Ss.totalDevices,devicesInRepair:ws,todaysBirthdays:Ss.todaysBirthdays};const e=Xe.length,t=Xe.reduce((e,t)=>e+(t.points||0),0),s=Xe.filter(e=>"vip"===e.loyaltyLevel).length,a=Xe.filter(e=>"premium"===e.loyaltyLevel).length,r=Xe.filter(e=>"regular"===e.loyaltyLevel).length;Xe.filter(e=>"active"===e.loyaltyLevel).length;const l=Xe.filter(e=>"payment_customer"===e.loyaltyLevel).length,n=Xe.filter(e=>"engaged"===e.loyaltyLevel).length,i=Xe.filter(e=>"interested"===e.loyaltyLevel).length;return{totalCustomers:Ss.totalCustomers,pageCustomers:e,activeCustomers:Ss.activeCustomers,totalRevenue:Ss.totalRevenue,deviceRevenue:0,posRevenue:0,totalPoints:t,vipCustomers:s,premiumCustomers:a,regularCustomers:r,paymentCustomers:l,engagedCustomers:n,interestedCustomers:i,totalDevices:Ss.totalDevices,devicesInRepair:ws,todaysBirthdays:Ss.todaysBirthdays}},[Xe,Ss,ws]),Js=x.useMemo(()=>{if(!bs||!Array.isArray(bs))return{totalAppointments:0,confirmedAppointments:0,pendingAppointments:0,completedAppointments:0,cancelledAppointments:0,todaysAppointments:0,thisWeeksAppointments:0};const e=bs.length,t=bs.filter(e=>"confirmed"===e.status).length,s=bs.filter(e=>"pending"===e.status).length,a=bs.filter(e=>"completed"===e.status).length,r=bs.filter(e=>"cancelled"===e.status).length,l=(new Date).toISOString().split("T")[0],n=bs.filter(e=>e.appointment_date===l).length,i=new Date;i.setDate(i.getDate()-i.getDay());const o=new Date;o.setDate(o.getDate()+(6-o.getDay()));return{totalAppointments:e,confirmedAppointments:t,pendingAppointments:s,completedAppointments:a,cancelledAppointments:r,todaysAppointments:n,thisWeeksAppointments:bs.filter(e=>{const t=new Date(e.appointment_date);return t>=i&&t<=o}).length}},[bs]),Ys=x.useMemo(()=>[],[]);x.useMemo(()=>{if(!Xe||!Array.isArray(Xe))return[];const e=new Date,t=new Date(e.getTime()+6048e5);return Xe.filter(s=>{if(!s.birthMonth||!s.birthDay)return!1;let a,r;if("string"!=typeof s.birthMonth)return!1;{if(""===s.birthMonth.trim())return!1;const e=parseInt(s.birthMonth);if(!isNaN(e)&&e>=1&&e<=12)a=e;else{a=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(s.birthMonth.toLowerCase())+1}}if("string"==typeof s.birthDay){if(""===s.birthDay.trim())return!1;const e=s.birthDay.match(/^(\d+)/);r=e?parseInt(e[1]):parseInt(s.birthDay)}else r=parseInt(s.birthDay);const l=new Date(e.getFullYear(),a-1,r);return l<e&&l.setFullYear(e.getFullYear()+1),l>=e&&l<=t}).sort((t,s)=>{let a,r,l,n;if("string"==typeof t.birthMonth&&""!==t.birthMonth.trim()){const e=parseInt(t.birthMonth);if(!isNaN(e)&&e>=1&&e<=12)a=e;else{a=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(t.birthMonth.toLowerCase())+1}}else a=1;if("string"==typeof t.birthDay&&""!==t.birthDay.trim()){const e=t.birthDay.match(/^(\d+)/);l=e?parseInt(e[1]):parseInt(t.birthDay)}else l=1;if("string"==typeof s.birthMonth&&""!==s.birthMonth.trim()){const e=parseInt(s.birthMonth);if(!isNaN(e)&&e>=1&&e<=12)r=e;else{r=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(s.birthMonth.toLowerCase())+1}}else r=1;if("string"==typeof s.birthDay&&""!==s.birthDay.trim()){const e=s.birthDay.match(/^(\d+)/);n=e?parseInt(e[1]):parseInt(s.birthDay)}else n=1;const i=new Date(e.getFullYear(),a-1,l),o=new Date(e.getFullYear(),r-1,n);return i<e&&i.setFullYear(e.getFullYear()+1),o<e&&o.setFullYear(e.getFullYear()+1),i.getTime()-o.getTime()})},[Xe]),x.useEffect(()=>{vt(1)},[N,zt,Pt,Ot,Et,_t,E,nt]),x.useEffect(()=>{const e=i.get("customerId");if(e&&Xe.length>0){const t=Xe.find(t=>t.id===e);t&&(Qe(t),qe(!0),o(e),l("/customers",{replace:!0}))}},[i,Xe,o,l]);const qs=x.useMemo(()=>{if(!Xe||!Array.isArray(Xe))return[];let e=Xe;if(zt.length>0&&(e=e.filter(e=>e.loyaltyLevel&&zt.includes(e.loyaltyLevel))),Pt.length>0&&(e=e.filter(e=>{const t=e.isActive?"active":"inactive";return Pt.includes(t)})),Ot.length>0&&(e=e.filter(e=>e.colorTag&&Ot.includes(e.colorTag))),Et.length>0&&(e=e.filter(e=>e.referralSource&&Et.includes(e.referralSource))),_t&&(e=e.filter(e=>e.birthMonth||e.birthDay)),Vt&&(e=e.filter(e=>e.hasWhatsApp||e.whatsapp||e.phone)),Gt.length>0&&(e=e.filter(e=>e.gender&&Gt.includes(e.gender))),Yt&&""!==Yt.trim()){const t=parseFloat(Yt);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.totalSpent||0)>=t))}if(Ht&&""!==Ht.trim()){const t=parseFloat(Ht);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.totalSpent||0)<=t))}if(Qt&&""!==Qt.trim()){const t=parseInt(Qt);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.points||0)>=t))}if(Zt&&""!==Zt.trim()){const t=parseInt(Zt);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.points||0)<=t))}if(ts.length>0&&(e=e.filter(e=>e.city&&ts.includes(e.city))),as&&""!==as.trim()){const t=parseInt(as);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.totalPurchases||0)>=t))}if(ls&&""!==ls.trim()){const t=parseInt(ls);!isNaN(t)&&t>=0&&(e=e.filter(e=>(e.totalPurchases||0)<=t))}if(is&&""!==is.trim()){const t=new Date(is);isNaN(t.getTime())||(e=e.filter(e=>{if(!e.joinedDate)return!1;const s=new Date(e.joinedDate);return!isNaN(s.getTime())&&s>=t}))}if(cs&&""!==cs.trim()){const t=new Date(cs);isNaN(t.getTime())||(e=e.filter(e=>{if(!e.joinedDate)return!1;const s=new Date(e.joinedDate);return!isNaN(s.getTime())&&s<=t}))}if(ms&&""!==ms.trim()){const t=new Date(ms);isNaN(t.getTime())||(e=e.filter(e=>{if(!e.lastVisit)return!1;const s=new Date(e.lastVisit);return!isNaN(s.getTime())&&s>=t}))}if(us&&""!==us.trim()){const t=new Date(us);isNaN(t.getTime())||(e=e.filter(e=>{if(!e.lastVisit)return!1;const s=new Date(e.lastVisit);return!isNaN(s.getTime())&&s<=t}))}return E&&(e=e.filter(e=>{if(!e.lastVisit)return!1;return new Date(e.lastVisit)<new Date(Date.now()-7776e6)})),[...e].sort((e,t)=>{switch(nt){case"name":return(e.name||"").localeCompare(t.name||"");case"recent":return new Date(t.joinedDate||0).getTime()-new Date(e.joinedDate||0).getTime();case"spent":const s=e.totalSpent??(e.payments?e.payments.reduce((e,t)=>e+(Number(t.amount)||0),0):0);return(t.totalSpent??(t.payments?t.payments.reduce((e,t)=>e+(Number(t.amount)||0),0):0))-s;case"points":return(t.points||0)-(e.points||0);default:return 0}})},[Xe,N,zt,Pt,Ot,Et,_t,Gt,Yt,Ht,Qt,Zt,ts,as,ls,is,cs,ms,us,E,nt]),Hs=e=>{switch(e){case"vip":return"bg-emerald-500/20 text-emerald-700 border-emerald-300/30";case"complainer":return"bg-rose-500/20 text-rose-700 border-rose-300/30";case"purchased":return"bg-blue-500/20 text-blue-700 border-blue-300/30";case"new":return"bg-purple-500/20 text-purple-700 border-purple-300/30";default:return"bg-gray-500/20 text-gray-700 border-gray-300/30"}},Ks=e=>{switch(e){case"vip":return"bg-purple-500/20 text-purple-700 border-purple-300/30";case"premium":return"bg-amber-500/20 text-amber-700 border-amber-300/30";case"regular":return"bg-blue-500/20 text-blue-700 border-blue-300/30";case"active":return"bg-green-500/20 text-green-700 border-green-300/30";case"payment_customer":return"bg-teal-500/20 text-teal-700 border-teal-300/30";case"engaged":return"bg-indigo-500/20 text-indigo-700 border-indigo-300/30";case"interested":return"bg-gray-400/20 text-gray-700 border-gray-300/30";default:return"bg-orange-500/20 text-orange-700 border-orange-300/30"}},Qs=async e=>{if(0!==J.length)switch(e){case"export":Xs();break;case"message":Zs();break;case"delete":await ea()}else T.error("Please select customers first")},Xs=()=>{try{const e=Xe.filter(e=>J.includes(e.id)),t=["Name","Phone","Email","Gender","Address","City","Birthday","Loyalty Level","Loyalty Points","Total Spent","Total Purchases","Tags","Notes","Status","Created At"],s=e.map(e=>{var t;return[Re(e.name||e.full_name),Re(e.phone),Re(e.email),Re(e.gender),Re(e.address),Re(e.city),Re(e.birthday),Re(e.loyalty_level),Re(e.loyalty_points),Re(e.total_spent),Re(e.total_purchases),Re(null==(t=e.tags)?void 0:t.join(", ")),Re(e.notes),Re(e.is_active?"Active":"Inactive"),Re(e.created_at)]}),a=[t.join(","),...s.map(e=>e.join(","))].join("\n"),r=new Blob([a],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),n=URL.createObjectURL(r);l.setAttribute("href",n),l.setAttribute("download",`customers_export_${(new Date).toISOString().split("T")[0]}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),T.success(`Exported ${J.length} customers to CSV`),Y([])}catch(e){T.error("Failed to export customers")}},Zs=()=>{0!==Xe.filter(e=>J.includes(e.id)).length?Z(!0):T.error("No customers selected")},ea=async()=>{if(window.confirm(`Are you sure you want to delete ${J.length} customer${1!==J.length?"s":""}? This action cannot be undone.`))try{const{error:e}=await n.from("customers").delete().in("id",J);if(e)throw e;Ze(e=>e.filter(e=>!J.includes(e.id))),T.success(`Successfully deleted ${J.length} customer${1!==J.length?"s":""}`),Y([]);const t=await ge(jt,100);Ze(t.customers);const s=t.totalCount||0,a=t.customers.length>=100;St(s>0?s:t.customers.length),wt(t.totalPages>0?t.totalPages:a?jt+1:jt),Dt(t.hasNextPage||a&&0===s),At(t.hasPreviousPage)}catch(e){T.error("Failed to delete customers")}},ta=e=>{const t=Xe.find(t=>t.id===e);return t&&t.payments?t.payments.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0):0},sa=e=>{const t=Xe.find(t=>t.id===e);if(!t||!t.devices)return{count:0,lastActivity:"No devices"};const s=t.devices.length;let a="";if(s>0){const e=t.devices.reduce((e,t)=>new Date(t.updatedAt||t.createdAt)>new Date(e.updatedAt||e.createdAt)?t:e,t.devices[0]),s=new Date(e.updatedAt||e.createdAt),r=(new Date).getTime()-s.getTime(),l=Math.floor(r/864e5);a=0===l?"Today":1===l?"1 day ago":`${l} days ago`}else a="No devices";return{count:s,lastActivity:a}},aa=e=>{const t=Xe.find(t=>t.id===e);if(!t||!t.payments)return{totalPurchases:0,totalItems:0,lastPurchase:null};const s=t.payments.filter(e=>"device_payment"===e.source&&"completed"===e.status),a=s.length,r=a;let l=null;if(s.length>0){l=s.reduce((e,t)=>new Date(t.date)>new Date(e.date)?t:e,s[0])}return{totalPurchases:a,totalItems:r,lastPurchase:l}},ra=e=>{switch(e){case"confirmed":return"bg-green-100 text-green-800 border-green-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"completed":return"bg-blue-100 text-blue-800 border-blue-200";case"cancelled":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},la=e=>{switch(e){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},na=x.useMemo(()=>{if(!bs||!Array.isArray(bs))return[];let e=bs;if("all"!==ys.status&&(e=e.filter(e=>e.status===ys.status)),"all"!==ys.date){const t=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0];switch(ys.date){case"today":e=e.filter(e=>e.appointment_date===t);break;case"tomorrow":e=e.filter(e=>e.appointment_date===s);break;case"this-week":const a=new Date;a.setDate(a.getDate()-a.getDay());const r=new Date;r.setDate(r.getDate()+(6-r.getDay())),e=e.filter(e=>{const t=new Date(e.appointment_date);return t>=a&&t<=r})}}return"all"!==ys.customer&&(e=e.filter(e=>e.customer_id===ys.customer)),e},[bs,ys]);return st?e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto",children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsxs("p",{className:"text-red-600 mb-4",children:["Error loading customers: ",st]}),e.jsx(s,{onClick:()=>window.location.reload(),children:"Try Again"})]})})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[et&&0===Xe.length&&e.jsx("div",{className:"mb-4",children:e.jsx(De,{isSearching:!0,searchStatus:"processing",searchProgress:50,resultCount:0})}),rt&&e.jsx("div",{style:{background:"#fbbf24",color:"black",padding:"8px",textAlign:"center"},children:"You are offline. Data is loaded from cache."}),e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(me,{to:"/dashboard"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Customer Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your customer relationships, track loyalty, and schedule appointments"})]})]}),e.jsx("div",{className:"flex flex-wrap gap-3",children:"customers"===ps?e.jsxs(e.Fragment,{children:[e.jsx(s,{onClick:()=>We(!0),icon:e.jsx(O,{size:18}),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white",children:"New Customer"}),["admin","customer-care"].includes((null==a?void 0:a.role)||"")&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:He,children:e.jsxs(s,{onClick:()=>Je(!Ge),icon:e.jsx(te,{size:18}),className:"bg-gradient-to-r from-green-500 to-emerald-600 text-white",children:["Import / Update",e.jsx(Q,{size:16,className:"ml-1 transition-transform "+(Ge?"rotate-90":"")})]})}),e.jsx(Ie,{open:Ge,onClose:()=>Je(!1),anchorRef:He,children:e.jsxs("div",{className:"py-1 min-w-[200px]",children:[e.jsxs("button",{onClick:()=>{Be(!0),Je(!1)},className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx(te,{size:16}),"Import New Customers"]}),e.jsxs("button",{onClick:()=>{Ue(!0),Je(!1)},className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx(_,{size:16}),"Update Existing Customers"]})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(s,{onClick:()=>{Ws("create"),Us(null),Bs(!0)},icon:e.jsx(se,{size:18}),className:"bg-gradient-to-r from-green-500 to-emerald-600 text-white",children:"New Appointment"}),e.jsx(s,{onClick:()=>l("/appointments"),icon:e.jsx(ae,{size:18}),className:"bg-gradient-to-r from-purple-500 to-indigo-600 text-white",children:"Calendar View"})]})})]}),e.jsxs("div",{className:"flex space-x-1 bg-gray-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>gs("customers"),className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-all duration-200 "+("customers"===ps?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[e.jsx(D,{size:18}),"Customers (",Gs.totalCustomers,")"]}),e.jsxs("button",{onClick:()=>gs("appointments"),className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-all duration-200 "+("appointments"===ps?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[e.jsx(ae,{size:18}),"Appointments (",Js.totalAppointments,")"]})]}),"customers"===ps?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Customer Statistics"}),e.jsxs("button",{onClick:async()=>{try{Ms(!0);const e=await ze();ks(e)}catch(e){T.error("Failed to refresh statistics")}finally{Ms(!1)}},disabled:Ds,className:"flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(_,{className:"w-4 h-4 "+(Ds?"animate-spin":"")}),"Refresh Stats"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(t,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Customers"}),Ds?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:Gs.totalCustomers})]}),e.jsx("div",{className:"p-3 bg-blue-50/20 rounded-full",children:e.jsx(D,{className:"w-6 h-6 text-blue-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"Active Customers"}),Ds?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-green-600"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-green-900",children:Gs.activeCustomers})]}),e.jsx("div",{className:"p-3 bg-green-50/20 rounded-full",children:e.jsx(S,{className:"w-6 h-6 text-green-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Total Revenue"}),Ds?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:d(Gs.totalRevenue)})]}),e.jsx("div",{className:"p-3 bg-purple-50/20 rounded-full",children:e.jsx(L,{className:"w-6 h-6 text-purple-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-amber-50 to-amber-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-600",children:"Total Devices"}),Ds?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-600"}),e.jsx("p",{className:"text-2xl font-bold text-amber-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-amber-900",children:Gs.totalDevices})]}),e.jsx("div",{className:"p-3 bg-amber-50/20 rounded-full",children:e.jsx(re,{className:"w-6 h-6 text-amber-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-pink-50 to-pink-100 cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all duration-300",onClick:()=>Rs(!0),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-pink-600",children:"Today's Birthdays"}),Ds?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-pink-600"}),e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:Gs.todaysBirthdays})]}),e.jsx("div",{className:"p-3 bg-pink-50/20 rounded-full",children:e.jsx(A,{className:"w-6 h-6 text-pink-600"})})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(t,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Appointments"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:Js.totalAppointments})]}),e.jsx("div",{className:"p-3 bg-blue-50/20 rounded-full",children:e.jsx(ae,{className:"w-6 h-6 text-blue-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"Confirmed"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:Js.confirmedAppointments})]}),e.jsx("div",{className:"p-3 bg-green-50/20 rounded-full",children:e.jsx(b,{className:"w-6 h-6 text-green-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-yellow-50 to-yellow-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-yellow-600",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-900",children:Js.pendingAppointments})]}),e.jsx("div",{className:"p-3 bg-yellow-50/20 rounded-full",children:e.jsx(le,{className:"w-6 h-6 text-yellow-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Today's"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:Js.todaysAppointments})]}),e.jsx("div",{className:"p-3 bg-purple-50/20 rounded-full",children:e.jsx(I,{className:"w-6 h-6 text-purple-600"})})]})}),e.jsx(t,{className:"bg-gradient-to-br from-pink-50 to-pink-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-pink-600",children:"Birthdays"}),e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:Ys.length})]}),e.jsx("div",{className:"p-3 bg-pink-50/20 rounded-full",children:e.jsx(A,{className:"w-6 h-6 text-pink-600"})})]})})]}),e.jsx(t,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:ys.status,onChange:e=>js(t=>({...t,status:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"confirmed",children:"Confirmed"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date"}),e.jsxs("select",{value:ys.date,onChange:e=>js(t=>({...t,date:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Dates"}),e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"tomorrow",children:"Tomorrow"}),e.jsx("option",{value:"this-week",children:"This Week"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer"}),e.jsxs("select",{value:ys.customer,onChange:e=>js(t=>({...t,customer:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Customers"}),Xe.slice(0,10).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]})}),e.jsxs(t,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200/50",children:[e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Service"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Date & Time"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Technician"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Priority"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:na.map(t=>e.jsxs("tr",{className:"border-b border-gray-200/30 hover:bg-blue-50 transition-colors",children:[e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.customer_name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.customer_phone})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.service_type}),e.jsx("p",{className:"text-sm text-gray-600",children:t.notes})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:new Date(t.appointment_date).toLocaleDateString()}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.appointment_time," (",t.duration_minutes," min)"]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsx("p",{className:"text-gray-900",children:t.technician_name})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${ra(t.status)}`,children:["confirmed"===t.status&&e.jsx(b,{size:12,className:"mr-1"}),"pending"===t.status&&e.jsx(le,{size:12,className:"mr-1"}),"completed"===t.status&&e.jsx(b,{size:12,className:"mr-1"}),"cancelled"===t.status&&e.jsx(f,{size:12,className:"mr-1"}),t.status]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${la(t.priority)}`,children:["high"===t.priority&&e.jsx(ne,{size:12,className:"mr-1"}),t.priority]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>{Ws("edit"),Us(t),Bs(!0)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"Edit Appointment",children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:e=>{e.stopPropagation();const s=Xe.find(e=>e.id===t.customer_id);s&&(Qe(s),qe(!0),o(s.id))},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"View Customer Details",children:e.jsx(W,{size:16})}),e.jsx("button",{onClick:()=>{t.customer_phone?window.open(`tel:${t.customer_phone}`):T.error("No phone number available")},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Call Customer",children:e.jsx(q,{size:16})})]})})]},t.id))})]})}),0===na.length&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ae,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No appointments found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Try adjusting your filters or create a new appointment"}),e.jsx(s,{onClick:()=>{},icon:e.jsx(se,{size:18}),children:"Create Appointment"})]})]})]}),"customers"===ps&&e.jsxs(e.Fragment,{children:[(Gs.deviceRevenue>0||Gs.posRevenue>0)&&e.jsxs(t,{className:"bg-gradient-to-br from-blue-50 to-indigo-100",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Revenue Breakdown"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-500 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-700",children:"Device Repairs"}),e.jsx("p",{className:"text-xs text-blue-600",children:"Repair payments"})]})]}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:d(Gs.deviceRevenue)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:"POS Sales"}),e.jsx("p",{className:"text-xs text-green-600",children:"Product sales"})]})]}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:d(Gs.posRevenue)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(t,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Loyalty Distribution"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-purple-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Platinum"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[Gs.platinumCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Gold"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[Gs.goldCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-400 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Silver"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[Gs.silverCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Bronze"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[Gs.bronzeCustomers," customers"]})]})]})]}),e.jsxs(t,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Quick Actions"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(s,{variant:"secondary",icon:e.jsx(oe,{size:16}),onClick:()=>Z(!0),className:"text-sm",children:"Send SMS"}),e.jsx(s,{variant:"secondary",icon:e.jsx(ce,{size:16}),onClick:()=>l("/customer-analytics"),className:"text-sm",children:"Analytics"}),e.jsx(s,{variant:"secondary",icon:e.jsx(ee,{size:16}),onClick:()=>l("/finance/payments"),className:"text-sm",children:"Points"}),e.jsx(s,{variant:"secondary",icon:e.jsx(I,{size:16}),onClick:()=>l("/customer-events"),className:"text-sm",children:"Events"})]})]})]}),e.jsx(Me,{searchQuery:y,onSearchChange:v,loyaltyFilter:zt,onLoyaltyFilterChange:Tt,statusFilter:Pt,onStatusFilterChange:$t,tagFilter:Ot,onTagFilterChange:Rt,referralFilter:Et,onReferralFilterChange:Bt,birthdayFilter:_t,onBirthdayFilterChange:Ut,whatsappFilter:Vt,onWhatsappFilterChange:Wt,showInactive:E,onShowInactiveChange:U,sortBy:nt,onSortByChange:it,customers:Xe,searchLoading:dt,filteredCount:qs.length,genderFilter:Gt,onGenderFilterChange:Jt,minSpent:Yt,onMinSpentChange:qt,maxSpent:Ht,onMaxSpentChange:Kt,minPoints:Qt,onMinPointsChange:Xt,maxPoints:Zt,onMaxPointsChange:es,cityFilter:ts,onCityFilterChange:ss,minPurchases:as,onMinPurchasesChange:rs,maxPurchases:ls,onMaxPurchasesChange:ns,joinDateFrom:is,onJoinDateFromChange:os,joinDateTo:cs,onJoinDateToChange:ds,lastVisitFrom:ms,onLastVisitFromChange:xs,lastVisitTo:us,onLastVisitToChange:hs}),xt&&e.jsx("div",{className:"mb-4",children:e.jsx(De,{isSearching:xt,searchStatus:ht,searchProgress:gt,resultCount:Ct,onCancel:()=>{if(ft){Se().cancelSearchJob(ft),ut(!1),yt(null)}}})}),J.length>0&&e.jsx(t,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5 text-blue-600"}),e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:[J.length," customer",1!==J.length?"s":""," selected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(s,{variant:"secondary",icon:e.jsx(oe,{size:16}),onClick:()=>Qs("message"),className:"text-sm",children:"Send Message"}),e.jsx(s,{variant:"secondary",icon:e.jsx(R,{size:16}),onClick:()=>Qs("export"),className:"text-sm",children:"Export"}),e.jsx(s,{variant:"secondary",icon:e.jsx(f,{size:16}),onClick:()=>Y([]),className:"text-sm text-red-600",children:"Clear"})]})]})})]}),"list"===H?e.jsxs(t,{children:[ot&&e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-sm opacity-70",children:[e.jsx(_,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading..."})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200/50",children:[e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:e.jsx("input",{type:"checkbox",checked:J.length===qs.length&&qs.length>0,onChange:()=>{J.length===qs.length?Y([]):Y(qs.map(e=>e.id))},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Contact"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Branch"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Devices"}),e.jsx("th",{className:"text-right py-4 px-4 font-medium text-gray-700",children:"Total Spent"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Loyalty"}),e.jsx("th",{className:"text-right py-4 px-4 font-medium text-gray-700",children:"Points"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:qs.map(t=>{const s=sa(t.id);return e.jsxs("tr",{className:"border-b border-gray-200/30 hover:bg-blue-50 cursor-pointer transition-colors",onClick:()=>{Qe(t),qe(!0),o(t.id)},children:[e.jsx("td",{className:"py-4 px-4",children:e.jsx("input",{type:"checkbox",checked:J.includes(t.id),onChange:e=>{var s;e.stopPropagation(),s=t.id,Y(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s])},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold",children:t.name.charAt(0)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.city})]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(q,{className:"w-3 h-3 text-blue-500"}),e.jsx("span",{className:"text-blue-600 font-medium",children:t.phone})]}),t.referralSource&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-purple-600",children:[e.jsx(k,{className:"w-3 h-3"}),e.jsx("span",{children:t.referralSource})]}),(t.birthMonth||t.birthDay)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-pink-600",children:[e.jsx(I,{className:"w-3 h-3"}),e.jsxs("span",{children:[t.birthMonth," ",t.birthDay]})]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{className:"text-sm text-gray-700 font-medium",children:t.branchName})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-gray-900 font-semibold",children:[s.count," device",1!==s.count?"s":""]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Last: ",s.lastActivity]})]})}),e.jsxs("td",{className:"py-4 px-4 text-right",children:[e.jsx("p",{className:"text-gray-900 font-semibold",children:d(ta(t.id))}),(()=>{var s;const a=((null==(s=t.payments)?void 0:s.filter(e=>"device_payment"===e.source&&"completed"===e.status))||[]).reduce((e,t)=>e+(Number(t.amount)||0),0);return a>0?e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-blue-500 rounded-full"}),e.jsxs("span",{children:["Repairs: ",d(a)]})]})}):null})(),(()=>{const s=aa(t.id);return s.totalPurchases>0?e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-green-500 rounded-full"}),e.jsxs("span",{children:[s.totalPurchases," purchase",1!==s.totalPurchases?"s":""," â€¢ ",s.totalItems," items"]})]})}):null})()]}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:`\n                          inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm border\n                          ${Ks(t.loyaltyLevel)}\n                        `,children:[e.jsx(C,{size:14}),e.jsx("span",{className:"capitalize",children:t.loyaltyLevel})]})}),e.jsx("td",{className:"py-4 px-4 text-right",children:e.jsx("p",{className:"text-gray-900 font-semibold",children:t.points})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:`\n                          inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm border\n                          ${Hs(t.colorTag)}\n                        `,children:[!t.isActive&&e.jsx(de,{size:14}),e.jsx("span",{className:"capitalize",children:t.colorTag})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),Qe(t),qe(!0),o(t.id),o(t.id)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(W,{size:16})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),Qe(t),qe(!0),o(t.id)},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"View Customer",children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),l(`/sms-control?customer=${t.id}`)},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Send Message",children:e.jsx(oe,{size:16})})]})})]},t.id)})})]})})]}):e.jsxs("div",{children:[ot&&e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-sm opacity-70",children:[e.jsx(_,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading..."})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:qs.map(s=>{const a=sa(s.id);return e.jsxs(t,{onClick:()=>{Qe(s),qe(!0),o(s.id)},className:"cursor-pointer hover:scale-105 transition-transform duration-300",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-lg",children:s.name.charAt(0)}),e.jsx("div",{className:`\n                    px-2 py-1 rounded-full text-xs border\n                    ${Hs(s.colorTag)}\n                  `,children:s.colorTag})]}),e.jsx("h3",{className:"font-semibold text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:s.city}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600 mb-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{children:s.branchName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mb-1",children:[e.jsx(q,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-blue-600 font-medium",children:s.phone})]}),s.referralSource&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-purple-600 mb-1",children:[e.jsx(k,{className:"w-3 h-3"}),e.jsxs("span",{children:["From: ",s.referralSource]})]}),(s.birthMonth||s.birthDay)&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-pink-600 mb-1",children:[e.jsx(I,{className:"w-3 h-3"}),e.jsxs("span",{children:[s.birthMonth," ",s.birthDay]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mb-2",children:[e.jsxs("span",{children:[a.count," device",1!==a.count?"s":""]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Last: ",a.lastActivity]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:`\n                    inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border\n                    ${Ks(s.loyaltyLevel)}\n                  `,children:[e.jsx(C,{size:12}),e.jsx("span",{className:"capitalize",children:s.loyaltyLevel})]}),e.jsxs("span",{className:"text-xs font-semibold text-gray-900",children:[s.points," pts"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs mb-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total Spent:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:d(ta(s.id))})]}),(()=>{var t;if(!(null==(t=null==s?void 0:s.payments)?void 0:t.length))return null;const a=s.payments.filter(e=>"device_payment"===e.source&&"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0);return a>0?e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 mb-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsxs("span",{children:["Repairs: ",d(a)]})]})}):null})(),(()=>{const t=aa(s.id);return t.totalPurchases>0?e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsxs("span",{children:[t.totalPurchases," purchase",1!==t.totalPurchases?"s":""]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[t.totalItems," item",1!==t.totalItems?"s":""]})]}),t.lastPurchase&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Last: ",new Date(t.lastPurchase.date).toLocaleDateString()]})]}):null})(),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-2",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),Qe(s),qe(!0),o(s.id)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(W,{size:16})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),Qe(s),qe(!0),o(s.id)},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"Edit Customer",children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),l(`/sms-control?customer=${s.id}`)},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Send Message",children:e.jsx(oe,{size:16})})]})]},s.id)})})]}),qs.length>0&&e.jsxs("div",{className:"mt-6 text-center space-y-4",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500 animate-pulse"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Showing ",qs.length.toLocaleString()," of ",Ct.toLocaleString()]})]}),(kt||qs.length<Ct)&&e.jsx("span",{className:"text-xs text-gray-500",children:"â€¢ Scroll for more"})]}),!Lt&&(kt||qs.length<Ct)&&qs.length>0&&e.jsxs("div",{className:"flex flex-col items-center gap-3 py-6 bg-gradient-to-b from-transparent via-blue-50/30 to-transparent",children:[e.jsxs("button",{onClick:()=>{Lt||(Ft(!0),vt(e=>e+1))},className:"group relative px-10 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 text-lg font-bold shadow-2xl hover:shadow-blue-500/50 transform hover:scale-110 flex items-center gap-3 border-2 border-blue-400/50",children:[e.jsx("span",{children:"Load More Customers"}),e.jsx("svg",{className:"w-6 h-6 group-hover:translate-y-1 transition-transform duration-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M19 9l-7 7-7-7"})})]}),e.jsxs("div",{className:"text-sm font-medium text-gray-600",children:["Click to load ",Math.min(100,Ct-qs.length)," more customers"]})]}),Lt&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(_,{className:"w-6 h-6 animate-spin text-blue-500"}),e.jsx("div",{className:"absolute inset-0 bg-blue-400 blur-lg opacity-30 animate-pulse"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Loading more customers..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Please wait"})]})]}),!Lt&&!kt&&qs.length>0&&e.jsxs("div",{className:"flex flex-col items-center gap-2 py-6",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-green-50 rounded-full border border-green-200",children:[e.jsx(b,{className:"w-4 h-4 text-green-600"}),e.jsxs("span",{className:"text-sm font-medium text-green-700",children:["All ",Ct.toLocaleString()," customers loaded"]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"You've reached the end of the list"})]}),e.jsx("div",{ref:It,className:"h-1"})]}),0===qs.length&&e.jsxs(t,{className:"text-center py-12",children:[e.jsx(D,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No customers found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Try adjusting your search or filter criteria"}),e.jsx(s,{onClick:()=>We(!0),icon:e.jsx(O,{size:18}),children:"Add Your First Customer"})]}),e.jsx(be,{isOpen:Ve,onClose:()=>We(!1),onCustomerCreated:e=>{Ze(t=>[e,...t]),St(e=>e+1),We(!1),o(e.id),u.show(`Customer "${e.name}" has been added successfully!`,{title:"Customer Added",actionButtons:[{label:"View Details",onClick:()=>{Qe(e),qe(!0)},variant:"primary"},{label:"Add Another",onClick:()=>We(!0),variant:"secondary"}]})}}),e.jsx(Ae,{open:X,onClose:()=>Z(!1),customers:Xe,onSend:async(e,t)=>{if(a){ue(!0);try{const s=await m.sendBulkSMS({recipients:e.map(e=>e.phone),message:t,created_by:a.id});s.success?T.success(`SMS sent successfully to all ${s.sent} customers!`):s.sent>0?T.success(`SMS sent to ${s.sent} customers, ${s.failed} failed.`):T.error(`Failed to send SMS to any customers. ${s.failed} errors.`)}catch(s){const e=s instanceof Error?s.message:"Unknown error occurred";T.error(`Failed to send bulk SMS: ${e}`)}finally{ue(!1),Z(!1)}}else T.error("You must be logged in to send SMS")},sending:xe}),e.jsx(Le,{isOpen:he,onClose:()=>Be(!1),onImportComplete:e=>{Ze(t=>[...t,...e]),Be(!1),T.success(`Successfully imported ${e.length} customers`)}}),e.jsx(Fe,{isOpen:_e,onClose:()=>Ue(!1),onImportComplete:e=>{Ze(t=>t.map(t=>e.find(e=>e.id===t.id)||t)),Ue(!1),T.success(`Successfully updated ${e.length} customers`)}}),e.jsx(fe,{isOpen:Es,onClose:()=>{Bs(!1),Us(null)},customer:"create"===Vs&&Ke||void 0,appointment:"edit"===Vs&&_s||void 0,onSave:async e=>{"create"===Vs?await(async e=>{try{await ve(e),T.success("Appointment created successfully!");const t=await je();fs(t),Bs(!1),Us(null)}catch(t){throw t}})(e):await(async e=>{if(_s)try{await Ne(_s.id,e),T.success("Appointment updated successfully!");const t=await je();fs(t),Bs(!1),Us(null)}catch(t){throw t}})(e)},mode:Vs}),As&&Ys.length>0&&e.jsx(Te,{todaysBirthdays:Ys,onClose:()=>Ls(!1),onViewCustomers:()=>Ts(!0)}),Fs&&e.jsx(Pe,{todaysBirthdays:Ys,onClose:()=>Is(!1)}),zs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(t,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Birthday Calendar"}),e.jsx("button",{onClick:()=>Ts(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(j,{className:"w-6 h-6"})})]}),e.jsx($e,{customers:Xe,onCustomerClick:e=>{Qe(e),qe(!0),o(e.id)}})]})})}),Ps&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(t,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Birthday Rewards"}),e.jsx("button",{onClick:()=>$s(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(j,{className:"w-6 h-6"})})]}),e.jsx(Oe,{todaysBirthdays:Ys,onApplyReward:(e,t)=>{T.success("Birthday reward applied successfully!")}})]})})}),Os&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(t,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-rose-500 to-fuchsia-600 rounded-xl flex items-center justify-center shadow-lg",children:e.jsx(A,{size:24,className:"text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"All Birthday Customers"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Ys.length," customers celebrating today"]})]})]}),e.jsx("button",{onClick:()=>Rs(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(j,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:Ys.map(t=>e.jsx("div",{className:"group relative",children:e.jsxs("div",{className:"relative bg-gradient-to-br from-white to-gray-50/50 rounded-xl p-4 border border-gray-100/60 shadow-sm hover:shadow-md transition-all duration-500 hover:scale-105 hover:-translate-y-1 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-rose-50/20 via-transparent to-fuchsia-50/20"}),e.jsxs("div",{className:"relative z-10 flex items-center gap-3 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-12 h-12 bg-gradient-to-br from-rose-400 to-fuchsia-600 rounded-xl flex items-center justify-center shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-pulse"}),e.jsx("span",{className:"text-lg font-bold text-white relative z-10",children:t.name.charAt(0).toUpperCase()})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-sm animate-bounce",children:e.jsx("span",{className:"text-xs",children:"ðŸŽ‚"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-bold text-gray-900 truncate text-base",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.birthMonth," ",t.birthDay]}),t.phone&&e.jsxs("p",{className:"text-xs text-blue-500 font-medium mt-1",children:["ðŸ“ž ",t.phone]})]})]}),e.jsxs("div",{className:"relative z-10 flex items-center gap-2",children:[t.phone&&e.jsxs("button",{onClick:()=>window.open(`tel:${t.phone}`),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-rose-500 to-fuchsia-600 text-white text-sm font-semibold rounded-lg hover:from-rose-600 hover:to-fuchsia-700 transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",title:"Call customer",children:[e.jsx(q,{size:14}),"Call"]}),e.jsx("button",{onClick:()=>{Qe(t),qe(!0),o(t.id)},className:"flex items-center justify-center w-10 h-10 bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-600 hover:text-gray-800 rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",title:"View customer details",children:e.jsx(W,{size:16})})]}),e.jsxs("div",{className:"relative z-10 flex gap-2 mt-3",children:[e.jsxs("button",{onClick:()=>Is(!0),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 text-white text-sm font-semibold rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",children:[e.jsx("span",{className:"text-sm",children:"ðŸ’¬"}),"Send Message"]}),e.jsxs("button",{onClick:()=>$s(!0),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-fuchsia-500 to-fuchsia-600 hover:from-fuchsia-600 hover:to-fuchsia-700 text-white text-sm font-semibold rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",children:[e.jsx("span",{className:"text-sm",children:"ðŸŽ"}),"Give Reward"]})]})]})},t.id))}),e.jsx("div",{className:"mt-6 pt-6 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-sm text-gray-600",children:"Quick Actions:"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>{Rs(!1),Is(!0)},className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-rose-500 to-rose-600 text-white text-sm font-semibold rounded-lg hover:from-rose-600 hover:to-rose-700 transition-all duration-300 shadow-sm hover:shadow-md",children:[e.jsx(z,{size:16}),"Send All Messages"]}),e.jsxs("button",{onClick:()=>{Rs(!1),$s(!0)},className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-fuchsia-500 to-fuchsia-600 text-white text-sm font-semibold rounded-lg hover:from-fuchsia-600 hover:to-fuchsia-700 transition-all duration-300 shadow-sm hover:shadow-md",children:[e.jsx(A,{size:16}),"Apply All Rewards"]})]})]})})]})})}),Ke&&e.jsx(pe,{isOpen:Ye,onClose:()=>{qe(!1),Qe(null)},customer:Ke,onEdit:e=>{}}),e.jsx(Ce,{...u.props})]})};export{Be as default};
