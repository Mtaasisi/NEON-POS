import{r as e}from"./vendor-a2ff445a.js";import{s as t}from"./index-222cfb29.js";const r=r=>{const[a,n]=e.useState([]),[i,o]=e.useState(null),[l,s]=e.useState(!1),[u,c]=e.useState(null);return e.useEffect(()=>{if(!r)return n([]),void o(null);if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r))return n([]),void o(null);(async()=>{var e,a;try{s(!0),c(null);const{data:l,error:u}=await t.from("lats_purchase_order_items").select("\n            id,\n            purchase_order_id,\n            product_id,\n            variant_id,\n            quantity_ordered,\n            unit_cost,\n            quantity_received,\n            created_at\n          ").eq("product_id",r).order("created_at",{ascending:!1}).limit(20);if(u)throw u;if(!l||0===l.length)return n([]),void o(null);const d=[...new Set(l.map(e=>e.purchase_order_id).filter(Boolean))];let _=[];if(d.length>0)try{const e=d.map(async e=>{const{data:r,error:a}=await t.from("lats_purchase_orders").select("id, po_number, created_at, status, supplier_id, total_amount, currency, exchange_rate, total_amount_base_currency, payment_terms").eq("id",e).single();return a?null:r});_=(await Promise.all(e)).filter(Boolean)}catch(i){throw i}const p=new Map;(_||[]).forEach(e=>{p.set(e.id,e)});const m=[...new Set((_||[]).map(e=>e.supplier_id).filter(Boolean))];let f=new Map;if(m.length>0)try{const e=m.map(async e=>{const{data:r,error:a}=await t.from("lats_suppliers").select("id, name").eq("id",e).single();return a?null:r}),r=(await Promise.all(e)).filter(Boolean);f=new Map(r.map(e=>[e.id,e.name]))}catch(i){}const h=l.map(e=>{const t=p.get(e.purchase_order_id);return{id:e.id,orderNumber:(null==t?void 0:t.po_number)||"N/A",orderDate:(null==t?void 0:t.created_at)||e.created_at,quantity:e.quantity_ordered||0,costPrice:e.unit_cost||0,receivedQuantity:e.quantity_received||0,status:(null==t?void 0:t.status)||"unknown",supplierName:f.get(null==t?void 0:t.supplier_id)||"Unknown",currency:"TZS",poStatus:(null==t?void 0:t.status)||"draft"}});if(n(h),h.length>0){const t=h.length,r=h.reduce((e,t)=>e+t.quantity,0),n=h.reduce((e,t)=>e+t.receivedQuantity,0),i=h.reduce((e,t)=>e+t.costPrice,0)/t,l=(null==(e=h[0])?void 0:e.orderDate)||null,s=(null==(a=h[0])?void 0:a.costPrice)||null,u=h.map(e=>e.costPrice).filter(e=>e>0),c=u.length>0?Math.min(...u):null,d=u.length>0?Math.max(...u):null;o({totalOrders:t,totalQuantityOrdered:r,totalQuantityReceived:n,averageCostPrice:i,lastOrderDate:l,lastCostPrice:s,lowestCostPrice:c,highestCostPrice:d})}else o(null)}catch(l){c(l.message||"Failed to fetch purchase order history")}finally{s(!1)}})()},[r]),{history:a,stats:i,isLoading:l,error:u}};export{r as u};
