import{j as e,s as t,u as s,d as a,G as r,a as l,U as n,i,V as d,p as c,W as o,X as m}from"./index-222cfb29.js";import{r as x}from"./vendor-a2ff445a.js";import{a as u,c as p}from"./appointments-4d8aac45.js";import{ag as g,X as h,O as b,Q as y,ar as j,n as f,a1 as N,h as v,g as w,d as _,e as C,a7 as S,m as D,s as k,P as L,j as P,u as M,bK as A,D as I,a as T,b as $,bL as B,bM as O,bN as q,ah as F,t as z,p as R,I as E,by as V,T as W,a0 as U,ak as G,v as H,aP as J,Z as Q,aA as K,au as X,aa as Z,r as Y}from"./ui-551a39a6.js";import{M as ee}from"./Modal-ccfa5014.js";import{C as te}from"./CustomerForm-05944812.js";import{f as se}from"./returns-0428af68.js";import{w as ae}from"./whatsappService-37f3bd6b.js";import{u as re}from"./useBodyScrollLock-0216d39f.js";import{A as le}from"./AppointmentModal-4524caae.js";import{format as ne}from"./format-0f0b2647.js";import{f as ie}from"./index-0096d614.js";const de=({isOpen:s,onClose:a,customerId:r,customerName:l,currentPoints:n,loyaltyLevel:i,onPointsUpdated:d})=>{const[c,o]=x.useState(0),[m,u]=x.useState(""),[p,N]=x.useState(!1);if(!s)return null;return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm",onClick:a}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-md w-full",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center",children:e.jsx(g,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Manage Points"}),e.jsx("p",{className:"text-sm text-gray-600",children:l})]})]}),e.jsx("button",{onClick:a,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors",children:e.jsx(h,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-700 font-medium",children:"Current Points"}),e.jsx("p",{className:"text-3xl font-bold text-purple-900",children:n})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-purple-700 font-medium",children:"Loyalty Level"}),e.jsx("p",{className:"text-lg font-semibold text-purple-900",children:i})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Points to Add/Deduct"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>o(e=>e-10),className:"p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors",children:e.jsx(b,{className:"w-4 h-4"})}),e.jsx("input",{type:"number",value:c,onChange:e=>o(parseInt(e.target.value)||0),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-center text-lg font-semibold",placeholder:"0"}),e.jsx("button",{type:"button",onClick:()=>o(e=>e+10),className:"p-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors",children:e.jsx(y,{className:"w-4 h-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["New balance: ",n+c," points"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>o(50),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+50"}),e.jsx("button",{type:"button",onClick:()=>o(100),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+100"}),e.jsx("button",{type:"button",onClick:()=>o(200),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason (Optional)"}),e.jsx("textarea",{value:m,onChange:e=>u(e.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"e.g., Loyalty reward, Compensation, Birthday bonus..."})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50",children:[e.jsx("button",{onClick:a,className:"px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors text-sm font-medium",disabled:p,children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(0!==c){N(!0);try{const s=n+c,{error:l}=await t.from("customers").update({points:s,updated_at:(new Date).toISOString()}).eq("id",r);if(l)throw l;try{await t.from("customer_points_history").insert({customer_id:r,points_change:c,new_balance:s,reason:m||"Manual adjustment",created_at:(new Date).toISOString()})}catch(e){}f.success(`${c>0?"Added":"Deducted"} ${Math.abs(c)} points`),d(s),o(0),u(""),a()}catch(s){f.error("Failed to update points: "+(s.message||"Unknown error"))}finally{N(!1)}}else f.error("Please enter a valid points amount")},disabled:p||0===c,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white rounded-lg transition-colors text-sm font-medium",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-4 h-4"}),c>0?"Add":"Deduct"," Points"]})})]})]})]})},ce=({isOpen:l,onClose:n,customer:i,onMessageSent:d})=>{const{currentUser:c}=s(),[o,m]=x.useState(""),[u,p]=x.useState(!1),[g,h]=x.useState(null),[b,y]=x.useState(!0);re(l),x.useEffect(()=>{l&&j()},[l]);const j=async()=>{y(!0);try{const e=await ae.checkInstanceStatus();h(e)}catch(e){h({authorized:!1,state:"error"})}finally{y(!1)}},D=()=>{m(""),p(!1),n()};return l?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx(a,{className:"w-full max-w-md",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5 text-green-600"}),"Send WhatsApp Message"]}),e.jsx("button",{onClick:D,className:"text-gray-500 hover:text-gray-700 transition-colors",children:e.jsx(v,{className:"w-5 h-5"})})]}),i&&e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"To:"}),e.jsx("p",{className:"font-medium text-gray-800",children:i.name}),e.jsx("p",{className:"text-sm text-gray-600",children:i.phone})]}),e.jsx("div",{className:"mb-4",children:b?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(w,{className:"w-4 h-4 animate-spin"}),"Checking WhatsApp status..."]}):g?e.jsxs("div",{className:"flex items-center gap-2 text-sm p-2 rounded "+(g.authorized?"bg-green-50 text-green-700":"bg-red-50 text-red-700"),children:[g.authorized?e.jsx(_,{className:"w-4 h-4"}):e.jsx(C,{className:"w-4 h-4"}),"WhatsApp: ",g.authorized?"Connected":"Not Connected"]}):null}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Message"}),e.jsx("textarea",{value:o,onChange:e=>m(e.target.value),placeholder:"Type your WhatsApp message here...",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none",rows:4,disabled:u||!(null==g?void 0:g.authorized)}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[o.length,"/1000 characters"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(r,{onClick:D,variant:"secondary",className:"flex-1",disabled:u,children:"Cancel"}),e.jsx(r,{onClick:async()=>{if((null==i?void 0:i.phone)&&o.trim()){p(!0);try{const s=await ae.sendWhatsAppMessage(i.phone,o.trim(),i.id);if(s.success){const s=i.phone.replace(/\D/g,""),{error:a}=await t.from("customer_communications").insert({customer_id:i.id,type:"whatsapp",message:o.trim(),status:"sent",phone_number:s,sent_by:null==c?void 0:c.id,sent_at:(new Date).toISOString()});try{const{error:e}=await t.from("whatsapp_messages").insert({chat_id:s,sender_id:(null==c?void 0:c.id)||"system",sender_name:(null==c?void 0:c.name)||"Staff",type:"text",content:o.trim(),direction:"outbound",status:"sent",timestamp:(new Date).toISOString()})}catch(e){}f.success("WhatsApp message sent and logged successfully!"),m(""),null==d||d(),n()}else f.error(`Failed to send message: ${s.error}`)}catch(e){f.error("Failed to send WhatsApp message")}finally{p(!1)}}else f.error("Please enter a message and ensure customer has a phone number")},className:"flex-1 bg-green-600 hover:bg-green-700",disabled:u||!o.trim()||!(null==g?void 0:g.authorized),children:u?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-4 h-4 animate-spin mr-2"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"Send"]})})]}),!(null==g?void 0:g.authorized)&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx(C,{className:"w-4 h-4 inline mr-1"}),"WhatsApp is not connected. Please check your GreenAPI configuration."]})})]})})}):null},oe=({customerId:s,customerPhone:a})=>{const[r,l]=x.useState([]),[n,i]=x.useState(!0),[d,c]=x.useState("all");x.useEffect(()=>{o()},[s]);const o=async()=>{try{i(!0);const e=[],{data:r}=await t.from("devices").select("*").eq("customer_id",s).order("created_at",{ascending:!1});null==r||r.forEach(t=>{e.push({id:`device-${t.id}`,type:"device",title:`Device: ${t.brand} ${t.model}`,description:t.problem_description||t.issue_description||"No description",date:t.created_at,icon:D,color:"bg-blue-500",metadata:{status:t.status,id:t.id}}),"completed"===t.status&&t.actual_completion_date&&e.push({id:`device-completed-${t.id}`,type:"device",title:"Device Repair Completed",description:`${t.brand} ${t.model} - Repair finished`,date:t.actual_completion_date,icon:_,color:"bg-green-500",metadata:{deviceId:t.id}})});const{data:n}=await t.from("sms_logs").select("*").eq("recipient_phone",a).order("created_at",{ascending:!1});null==n||n.forEach(t=>{e.push({id:`sms-${t.id}`,type:"sms",title:"SMS Sent",description:t.message.substring(0,100)+(t.message.length>100?"...":""),date:t.sent_at||t.created_at,icon:N,color:"bg-purple-500",metadata:{status:t.status}})});const{data:d}=await t.from("customer_communications").select("*").eq("customer_id",s).order("sent_at",{ascending:!1});null==d||d.forEach(t=>{var s;const a="whatsapp"===t.type?k:"call"===t.type?L:"email"===t.type?P:N;e.push({id:`comm-${t.id}`,type:t.type,title:`${t.type.charAt(0).toUpperCase()+t.type.slice(1)} Communication`,description:(null==(s=t.message)?void 0:s.substring(0,100))||"Communication sent",date:t.sent_at||t.created_at,icon:a,color:"whatsapp"===t.type?"bg-green-600":"call"===t.type?"bg-blue-600":"bg-gray-600",metadata:{status:t.status}})});const{data:c}=await t.from("appointments").select("*").eq("customer_id",s).order("created_at",{ascending:!1});null==c||c.forEach(t=>{e.push({id:`apt-${t.id}`,type:"appointment",title:`Appointment: ${t.service_type}`,description:`Scheduled for ${t.appointment_date} at ${t.appointment_time}`,date:t.created_at,icon:M,color:"bg-orange-500",metadata:{status:t.status,date:t.appointment_date}})});const{data:o}=await t.from("lats_receipts").select("*").eq("customer_id",s).order("created_at",{ascending:!1});null==o||o.forEach(t=>{e.push({id:`sale-${t.id}`,type:"purchase",title:"Purchase",description:`Bought items worth ${ne.money(t.total_amount||0)}`,date:t.created_at,icon:A,color:"bg-emerald-500",metadata:{amount:t.total_amount,paymentMethod:t.payment_method}})});const{data:m}=await t.from("payments").select("*").eq("customer_id",s).order("created_at",{ascending:!1});null==m||m.forEach(t=>{e.push({id:`payment-${t.id}`,type:"payment",title:"Payment Received",description:`${ne.money(t.amount||0)} via ${t.method}`,date:t.created_at,icon:I,color:"bg-green-500",metadata:{amount:t.amount,method:t.method}})});const{data:x}=await t.from("customer_points_history").select("*").eq("customer_id",s).order("created_at",{ascending:!1});null==x||x.forEach(t=>{e.push({id:`points-${t.id}`,type:"points",title:t.points_change>0?"Points Earned":"Points Redeemed",description:`${Math.abs(t.points_change)} points - ${t.reason}`,date:t.created_at,icon:t.points_change>0?g:j,color:t.points_change>0?"bg-yellow-500":"bg-indigo-500",metadata:{points:t.points_change}})}),e.sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()),l(e)}catch(e){}finally{i(!1)}},m=r.filter(e=>"all"===d||("communication"===d?["sms","whatsapp","call","email"].includes(e.type):"transactions"===d?["purchase","payment","points"].includes(e.type):"service"!==d||["device","appointment"].includes(e.type)));return n?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("button",{onClick:()=>c("all"),className:"px-4 py-2 rounded-lg text-sm font-medium transition-colors "+("all"===d?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:["All (",r.length,")"]}),e.jsx("button",{onClick:()=>c("communication"),className:"px-4 py-2 rounded-lg text-sm font-medium transition-colors "+("communication"===d?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:"Communication"}),e.jsx("button",{onClick:()=>c("transactions"),className:"px-4 py-2 rounded-lg text-sm font-medium transition-colors "+("transactions"===d?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:"Transactions"}),e.jsx("button",{onClick:()=>c("service"),className:"px-4 py-2 rounded-lg text-sm font-medium transition-colors "+("service"===d?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:"Service"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-6 top-0 bottom-0 w-0.5 bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:0===m.length?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No events found for this filter"}):m.map((t,s)=>{const a=t.icon;return e.jsxs("div",{className:"relative flex items-start gap-4 pl-14",children:[e.jsx("div",{className:`absolute left-0 w-12 h-12 ${t.color} rounded-full flex items-center justify-center text-white shadow-lg z-10`,children:e.jsx(a,{size:20})}),e.jsxs("div",{className:"flex-1 bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:t.title}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.description})]}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-nowrap ml-4",children:ie(new Date(t.date),"MMM dd, yyyy HH:mm")})]}),t.metadata&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[t.metadata.status&&e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium "+("completed"===t.metadata.status||"sent"===t.metadata.status||"delivered"===t.metadata.status?"bg-green-100 text-green-800":"pending"===t.metadata.status?"bg-yellow-100 text-yellow-800":"failed"===t.metadata.status||"cancelled"===t.metadata.status?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"),children:t.metadata.status}),t.metadata.amount&&e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800",children:ne.money(t.metadata.amount)})]})]})]},t.id)})})]}),m.length>0&&e.jsxs("div",{className:"text-center text-sm text-gray-500 pt-4",children:["Showing ",m.length," of ",r.length," events"]})]})},me=({customer:t})=>{const[s,a]=x.useState(!1),r=e=>{if(e<60)return`${Math.round(e)}m`;return`${Math.floor(e/60)}h ${Math.round(e%60)}m`};return t.totalCalls&&0!==t.totalCalls?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-6 h-6 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Call Analytics"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[t.callLoyaltyLevel&&e.jsxs("div",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${(e=>{switch(e){case"VIP":return"bg-gradient-to-r from-purple-500 to-pink-500 text-white";case"Gold":return"bg-gradient-to-r from-yellow-400 to-yellow-600 text-white";case"Silver":return"bg-gradient-to-r from-gray-400 to-gray-600 text-white";case"Bronze":return"bg-gradient-to-r from-orange-400 to-orange-600 text-white";case"Basic":return"bg-gradient-to-r from-blue-400 to-blue-600 text-white";case"New":return"bg-gradient-to-r from-green-400 to-green-600 text-white";default:return"bg-gray-200 text-gray-700"}})(t.callLoyaltyLevel)}`,children:[(t=>{switch(t){case"VIP":return e.jsx(j,{className:"w-4 h-4"});case"Gold":case"Silver":case"Bronze":return e.jsx(R,{className:"w-4 h-4"});default:return e.jsx(z,{className:"w-4 h-4"})}})(t.callLoyaltyLevel),t.callLoyaltyLevel]}),e.jsx("button",{onClick:()=>a(!s),className:"p-1 hover:bg-gray-100 rounded-lg transition-colors",title:s?"Collapse":"Expand",children:s?e.jsx(T,{className:"w-5 h-5 text-gray-600"}):e.jsx($,{className:"w-5 h-5 text-gray-600"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-blue-700 uppercase tracking-wide mb-1",children:"Total Calls"}),e.jsx("div",{className:"text-lg font-bold text-blue-900",children:t.totalCalls}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[t.incomingCalls||0," in â€¢ ",t.outgoingCalls||0," out"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-green-700 uppercase tracking-wide mb-1",children:"Duration"}),e.jsx("div",{className:"text-lg font-bold text-green-900",children:r(t.totalCallDurationMinutes||0)}),e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:["Avg: ",r(t.avgCallDurationMinutes||0)]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-purple-700 uppercase tracking-wide mb-1",children:"Call Span"}),e.jsxs("div",{className:"text-lg font-bold text-purple-900",children:[t.firstCallDate&&t.lastCallDate?Math.ceil((new Date(t.lastCallDate).getTime()-new Date(t.firstCallDate).getTime())/864e5):0," days"]}),e.jsxs("div",{className:"text-xs text-purple-600 mt-1",children:[t.totalCalls>0?Math.round(t.totalCalls/Math.max(1,Math.ceil((Date.now()-new Date(t.firstCallDate||t.createdAt||Date.now()).getTime())/2592e6))):0,"/month"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-orange-700 uppercase tracking-wide mb-1",children:"Loyalty Level"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:t.callLoyaltyLevel||"Basic"}),e.jsxs("div",{className:"text-xs text-orange-600 mt-1",children:[t.missedCalls||0," missed calls"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-indigo-700 uppercase tracking-wide mb-1",children:"Last Call"}),e.jsx("div",{className:"text-lg font-bold text-indigo-900",children:t.lastCallDate?new Date(t.lastCallDate).toLocaleDateString():"Unknown"}),e.jsxs("div",{className:"text-xs text-indigo-600 mt-1",children:[t.firstCallDate?new Date(t.firstCallDate).toLocaleDateString():"Unknown"," first"]})]})]}),s&&e.jsxs("div",{className:"space-y-6 border-t border-gray-200 pt-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(B,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Incoming"})]}),e.jsx("div",{className:"text-xl font-bold text-green-900",children:t.incomingCalls||0}),e.jsxs("div",{className:"text-xs text-green-600",children:[t.totalCalls?Math.round((t.incomingCalls||0)/t.totalCalls*100):0,"% of total"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(O,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Outgoing"})]}),e.jsx("div",{className:"text-xl font-bold text-blue-900",children:t.outgoingCalls||0}),e.jsxs("div",{className:"text-xs text-blue-600",children:[t.totalCalls?Math.round((t.outgoingCalls||0)/t.totalCalls*100):0,"% of total"]})]}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(q,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-800",children:"Missed"})]}),e.jsx("div",{className:"text-xl font-bold text-red-900",children:t.missedCalls||0}),e.jsxs("div",{className:"text-xs text-red-600",children:[t.totalCalls?Math.round((t.missedCalls||0)/t.totalCalls*100):0,"% of total"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),"Call Timeline"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"First Call"}),e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:t.firstCallDate?new Date(t.firstCallDate).toLocaleDateString():"Unknown"}),e.jsx("div",{className:"text-xs text-gray-500",children:t.firstCallDate?new Date(t.firstCallDate).toLocaleTimeString():""})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"Last Call"}),e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:t.lastCallDate?new Date(t.lastCallDate).toLocaleDateString():"Unknown"}),e.jsx("div",{className:"text-xs text-gray-500",children:t.lastCallDate?new Date(t.lastCallDate).toLocaleTimeString():""})]})]}),t.firstCallDate&&t.lastCallDate&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-blue-700 mb-1",children:"Call Activity Span"}),e.jsxs("div",{className:"text-lg font-semibold text-blue-900",children:[Math.ceil((new Date(t.lastCallDate).getTime()-new Date(t.firstCallDate).getTime())/864e5)," days"]}),e.jsxs("div",{className:"text-xs text-blue-600",children:["From ",new Date(t.firstCallDate).toLocaleDateString()," to ",new Date(t.lastCallDate).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-indigo-800 mb-3 flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4"}),"Call Insights"]}),e.jsxs("div",{className:"space-y-2 text-sm text-indigo-700",children:["VIP"===t.callLoyaltyLevel&&e.jsx("p",{children:"ðŸŒŸ This is a VIP customer with exceptional call activity!"}),"Gold"===t.callLoyaltyLevel&&e.jsx("p",{children:"â­ This customer has high call engagement and loyalty."}),"Silver"===t.callLoyaltyLevel&&e.jsx("p",{children:"ðŸ“ž This customer has been calling for more than 2 days, showing good engagement."}),"Bronze"===t.callLoyaltyLevel&&e.jsx("p",{children:"ðŸ“± This customer has made only one call - consider follow-up."}),t.totalCalls&&t.totalCalls>100&&e.jsx("p",{children:"ðŸ”¥ High call volume customer - excellent engagement!"}),t.avgCallDurationMinutes&&t.avgCallDurationMinutes>5&&e.jsx("p",{children:"â±ï¸ Long average call duration - detailed conversations."}),t.missedCalls&&t.missedCalls>.3*t.totalCalls&&e.jsx("p",{children:"âš ï¸ High missed call rate - consider alternative contact methods."})]})]})]})]}):null},xe=({isOpen:a,onClose:b,customer:y,onEdit:v})=>{var w,C,S,T,$;const{currentUser:B}=s();re(a);const{addNote:O,updateCustomer:q,markCustomerAsRead:ae}=l(),[ne,ie]=x.useState(y),[xe,ue]=x.useState("overview"),[pe,ge]=x.useState([]),[he,be]=x.useState([]),[ye,je]=x.useState([]),[fe,Ne]=x.useState([]),[ve,we]=x.useState([]),[_e,Ce]=x.useState(null),[Se,De]=x.useState(!1),[ke,Le]=x.useState([]),[Pe,Me]=x.useState([]),[Ae,Ie]=x.useState([]),[Te,$e]=x.useState([]),[Be,Oe]=x.useState(null),[qe,Fe]=x.useState(!1),[ze,Re]=x.useState(null),[Ee,Ve]=x.useState(!1),[We,Ue]=x.useState(!1),[Ge,He]=x.useState(""),[Je,Qe]=x.useState(!1),[Ke,Xe]=x.useState(null),[Ze,Ye]=x.useState(!1),[et,tt]=x.useState(!1),[st,at]=x.useState(!1),[rt,lt]=x.useState(!1),[nt,it]=x.useState(!1),[dt,ct]=x.useState(!1),[ot,mt]=x.useState(!1),[xt,ut]=x.useState(!1),[pt,gt]=x.useState(!1);x.useEffect(()=>{ie(y)},[y]),x.useEffect(()=>{a&&(null==y?void 0:y.id)&&(ht(),bt(),yt())},[a,null==y?void 0:y.id]);const ht=async()=>{if(null==y?void 0:y.id){De(!0);try{ge(y.devices||[]);const{data:s,error:a}=await t.from("customer_payments").select("*").eq("customer_id",y.id).order("payment_date",{ascending:!1});if(!a&&s){const e=s.map(e=>({id:e.id,customerId:e.customer_id,deviceId:e.device_id,amount:e.amount,method:e.method,type:e.payment_type,status:e.status,date:e.payment_date,createdAt:e.created_at,updatedAt:e.updated_at}));be(e)}else be(y.payments||[]);const{data:r,error:l}=await t.from("lats_sales").select("\n          id,\n          sale_number,\n          customer_id,\n          subtotal,\n          total_amount,\n          payment_method,\n          status,\n          created_at,\n          updated_at\n        ").eq("customer_id",y.id).order("created_at",{ascending:!1});let n=r,i=l;if(l){const{data:e,error:s}=await t.from("lats_sales").select("*").eq("customer_id",y.id).order("created_at",{ascending:!1});s?(n=[],i=null):(n=e,i=null)}if(!i&&n)if(je(n),n.length>0){const e=n.map(e=>e.id),{data:s,error:a}=await t.from("lats_sale_items").select("\n              id,\n              sale_id,\n              product_id,\n              variant_id,\n              quantity,\n              unit_price,\n              total_price\n            ").in("sale_id",e);if(!a&&s){const a=[...new Set(s.map(e=>e.product_id).filter(Boolean))],r=[...new Set(s.map(e=>e.variant_id).filter(Boolean))],{data:l}=await t.from("lats_products").select("id, name, description, sku").in("id",a),{data:i}=await t.from("lats_product_variants").select("id, name, sku, attributes").in("id",r),{data:d}=await t.from("sale_inventory_items").select("sale_id, inventory_item_id").in("sale_id",e);let c={};if(d&&d.length>0){const e=d.map(e=>e.inventory_item_id),{data:s}=await t.from("inventory_items").select("*").in("id",e);s&&s.forEach(e=>{const t=`${e.product_id}_${e.variant_id||"null"}`;c[t]||(c[t]=[]),c[t].push(e)})}const o=s.map(e=>{const t=n.find(t=>t.id===e.sale_id),s=`${e.product_id}_${e.variant_id||"null"}`;return{...e,saleNumber:null==t?void 0:t.sale_number,saleDate:null==t?void 0:t.created_at,paymentMethod:null==t?void 0:t.payment_method,saleStatus:null==t?void 0:t.status,product:null==l?void 0:l.find(t=>t.id===e.product_id),variant:null==i?void 0:i.find(t=>t.id===e.variant_id),serialNumbers:c[s]||[]}});Ne(o)}else Ne([])}else Ne([]);try{const{data:e,error:s}=await t.from("lats_spare_part_usage").select("*").eq("customer_id",y.id).order("used_at",{ascending:!1});if(!s&&e&&e.length>0){const s=[...new Set(e.map(e=>e.spare_part_id).filter(Boolean))];if(s.length>0){const{data:a}=await t.from("lats_spare_parts").select("id, name, part_number, cost_price, selling_price").in("id",s),r=(a||[]).reduce((e,t)=>(e[t.id]=t,e),{}),l=e.map(e=>({...e,lats_spare_parts:r[e.spare_part_id]||null}));we(l)}else we(e)}const a=ft(y.id,r||[],e||[]);Ce(a)}catch(e){const t=ft(y.id,r||[],[]);Ce(t)}}catch(s){}finally{De(!1)}}},bt=async()=>{var e;if(null==y?void 0:y.id){Fe(!0);try{try{const e=await u(y.id);Le(e||[])}catch(s){Le([])}try{const e=await se(y.id);Me(e||[])}catch(s){Me([])}try{const{data:s,error:a}=await t.from("customer_communications").select("*").eq("customer_id",y.id).order("sent_at",{ascending:!1}).limit(50);if(!a&&s)Ie(s);else{const{data:s,error:a}=await t.from("sms_logs").select("*").eq("phone_number",(null==(e=y.phone)?void 0:e.replace(/\D/g,""))||"").order("created_at",{ascending:!1}).limit(50);if(!a&&s){const e=s.map(e=>({id:e.id,customer_id:y.id,type:"sms",message:e.message,status:e.status,phone_number:e.phone_number,sent_by:e.sent_by,sent_at:e.sent_at||e.created_at,created_at:e.created_at}));Ie(e)}}}catch(s){Ie([])}try{const{data:e,error:s}=await t.from("customers").select("id, name, phone, created_at, total_spent").eq("referred_by",y.id).order("created_at",{ascending:!1});!s&&e&&$e(e)}catch(s){$e([])}try{const{data:e,error:s}=await t.from("customer_preferences").select("*").eq("customer_id",y.id);!s&&e&&e.length>0?Oe(e[0]):Oe(null)}catch(s){Oe(null)}}catch(s){}finally{Fe(!1)}}},yt=async()=>{if(null==y?void 0:y.id){Ve(!0);try{const e=await n(y.id);Re(e)}catch(e){Re(null)}finally{Ve(!1)}}},jt=async e=>{if(null==y?void 0:y.id)try{await m(y.id,e),await yt()}catch(t){}},ft=(e,t,s)=>{const a=t.reduce((e,t)=>e+(t.total_amount||0),0),r=s.reduce((e,t)=>{var s;return e+((null==(s=t.lats_spare_parts)?void 0:s.selling_price)||0)},0),l=pe.filter(t=>t.customerId===e).map(e=>e.id),n=he.filter(e=>e.deviceId&&l.includes(e.deviceId)),i=n.reduce((e,t)=>e+(t.amount||0),0),d=n.filter(e=>"deposit"===e.type).reduce((e,t)=>e+(t.amount||0),0),c=n.filter(e=>"payment"===e.type).reduce((e,t)=>e+(t.amount||0),0),o=n.filter(e=>"refund"===e.type).reduce((e,t)=>e+(t.amount||0),0),m=i,x=a+r+m,u=t.flatMap(e=>(e.lats_sale_items||[]).map(t=>({...t,saleNumber:e.sale_number,saleDate:e.created_at,paymentMethod:e.payment_method,saleStatus:e.status}))),p=new Set(u.map(e=>e.product_id)).size,g=u.length,h=t.length>0?a/t.length:0,b=t.length>0?new Date(t[0].created_at):null,j=b?Math.floor((Date.now()-b.getTime())/864e5):null,f=x>1e5?"Top Customer":x>5e4?"VIP Customer":"Regular Customer";return{totalSpent:x,totalPosSpent:a,totalSpareSpent:r,totalDeviceSpent:m,deviceBreakdown:{payments:c,deposits:d,refunds:o,totalPayments:i},uniqueProducts:p,totalItems:g,averageOrderValue:h,lastPurchaseDate:b,daysSinceLastPurchase:j,purchaseFrequency:t.length>0?t.length/Math.max(1,Math.floor((Date.now()-new Date((null==y?void 0:y.joinedDate)||Date.now()).getTime())/2592e6)):0,customerRanking:f}};return a&&y?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm",onClick:b}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center",children:e.jsx(z,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:y.name}),e.jsx("p",{className:"text-sm text-blue-600 font-medium",children:y.phone})]})]}),e.jsx("button",{onClick:b,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors",children:e.jsx(h,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"border-b border-gray-200 bg-white",children:e.jsxs("div",{className:"flex space-x-8 px-6",children:[e.jsx("button",{onClick:()=>ue("overview"),className:"py-4 px-1 border-b-2 font-medium text-sm transition-colors "+("overview"===xe?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Overview"]})}),e.jsx("button",{onClick:()=>ue("activity"),className:"py-4 px-1 border-b-2 font-medium text-sm transition-colors "+("activity"===xe?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4"}),"Activity"]})}),e.jsx("button",{onClick:()=>ue("journey"),className:"py-4 px-1 border-b-2 font-medium text-sm transition-colors "+("journey"===xe?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4"}),"Journey"]})})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-120px)]",children:["overview"===xe&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-emerald-700 uppercase tracking-wide mb-1",children:"Total Spent"}),e.jsx("div",{className:"text-lg font-bold text-emerald-900",children:Se?"...":i((null==_e?void 0:_e.totalSpent)||0)})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-blue-700 uppercase tracking-wide mb-1",children:"Orders"}),e.jsx("div",{className:"text-lg font-bold text-blue-900",children:Se?"...":ye.length})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-orange-700 uppercase tracking-wide mb-1",children:"Devices"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:Se?"...":pe.length})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-purple-700 uppercase tracking-wide mb-1",children:"Points"}),e.jsx("div",{className:"text-lg font-bold text-purple-900",children:Se?"...":y.points||0})]}),e.jsxs("div",{className:"bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-indigo-700 uppercase tracking-wide mb-1",children:"Calls"}),e.jsx("div",{className:"text-lg font-bold text-indigo-900",children:Se?"...":y.totalCalls||0})]})]}),e.jsx(me,{customer:y}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-gray-50 rounded-xl",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center border-2 border-white/30",children:y.profileImage?e.jsx("img",{src:y.profileImage,alt:y.name,className:"w-full h-full rounded-full object-cover"}):e.jsx(z,{className:"w-8 h-8 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:y.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-gray-600 mt-1",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium "+("vip"===y.colorTag?"bg-emerald-500/20 text-emerald-700":"complainer"===y.colorTag?"bg-rose-500/20 text-rose-700":"purchased"===y.colorTag?"bg-blue-500/20 text-blue-700":"new"===y.colorTag?"bg-purple-500/20 text-purple-700":"bg-gray-500/20 text-gray-700"),children:[e.jsx(W,{size:10}),y.colorTag]}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-500/20 text-amber-700",children:[e.jsx(R,{size:10}),y.loyaltyLevel]}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-700",children:[e.jsx(g,{size:10}),y.points||0," pts"]}),y.callLoyaltyLevel&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium "+("VIP"===y.callLoyaltyLevel?"bg-purple-500/20 text-purple-700":"Gold"===y.callLoyaltyLevel?"bg-yellow-500/20 text-yellow-700":"Silver"===y.callLoyaltyLevel?"bg-gray-500/20 text-gray-700":"Bronze"===y.callLoyaltyLevel?"bg-orange-500/20 text-orange-700":"Basic"===y.callLoyaltyLevel?"bg-blue-500/20 text-blue-700":"bg-green-500/20 text-green-700"),children:[e.jsx(L,{size:10}),y.callLoyaltyLevel]}),y.gender&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-500/20 text-blue-700",children:[e.jsx(U,{size:10}),y.gender]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(L,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Contact Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Phone:"}),e.jsx("span",{className:"text-sm font-medium text-blue-600",children:y.phone||"Not provided"})]}),y.whatsapp&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"WhatsApp:"}),e.jsx("span",{className:"text-sm font-medium text-green-600",children:y.whatsapp}),y.whatsappOptOut&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),"Opted Out"]})]}),y.email&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Email:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:y.email})]}),y.city&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Location:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:y.city})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(U,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Personal Information"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.birthMonth&&y.birthDay&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Birthday"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[y.birthMonth,"/",y.birthDay]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Account Status"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+(y.isActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:y.isActive?"Active":"Inactive"})}),ze&&e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:ze.statusReason})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Member Since"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:Ee?"Loading...":ze?new Date(ze.memberSince).toLocaleDateString():y.createdAt?new Date(y.createdAt).toLocaleDateString():y.joinedDate?new Date(y.joinedDate).toLocaleDateString():"Unknown"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Last Visit"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:Ee?"Loading...":ze&&ze.lastVisit?new Date(ze.lastVisit).toLocaleDateString():y.lastVisit?new Date(y.lastVisit).toLocaleDateString():y.updatedAt?new Date(y.updatedAt).toLocaleDateString():"Never"}),ze&&null!==ze.daysSinceActivity&&e.jsx("p",{className:"text-xs text-gray-600",children:0===ze.daysSinceActivity?"Today":1===ze.daysSinceActivity?"1 day ago":`${ze.daysSinceActivity} days ago`})]}),y.gender&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Gender"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 capitalize",children:y.gender})]}),y.country&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Country"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.country})]}),y.address&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Address"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.address})]}),y.notes&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Notes"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.notes})]}),y.birthday&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Birthday Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(y.birthday).toLocaleDateString()})]}),y.profileImage&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Profile Image"}),e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:y.profileImage,alt:"Profile",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-200"})})]})]})]}),(y.referredBy||y.referrals&&y.referrals.length>0||Te.length>0)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(z,{className:"w-5 h-5 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Referral Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[y.referredBy&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Referred By"}),e.jsxs("p",{className:"text-sm font-medium text-blue-600",children:["Customer ID: ",y.referredBy]})]}),y.referralSource&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Referral Source"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.referralSource})]}),Te.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:["Customers Referred (",Te.length,")"]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[Te.slice(0,3).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-purple-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.phone})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Joined: ",new Date(t.created_at).toLocaleDateString()]}),t.total_spent>0&&e.jsx("p",{className:"text-xs font-medium text-green-600",children:i(t.total_spent)})]})]},t.id)),Te.length>3&&e.jsxs("p",{className:"text-xs text-gray-500 text-center",children:["+",Te.length-3," more referrals"]})]})]})]})]}),(y.branchName||y.createdByBranchName||y.createdBy)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(J,{className:"w-5 h-5 text-indigo-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Branch & Registration Info"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.branchName&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Current Branch"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.branchName}),y.isShared&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:"Shared Customer"})]}),y.createdByBranchName&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Registered At"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.createdByBranchName})]}),y.createdBy&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Registered By Staff"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Staff ID: ",y.createdBy]})]})]})]}),(y.totalSpent>0||y.totalPurchases>0||y.lastPurchaseDate)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(A,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Purchase History"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.totalSpent>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Total Spent"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:i(y.totalSpent)})]}),y.totalPurchases>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Total Purchases"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.totalPurchases})]}),y.lastPurchaseDate&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Last Purchase"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(y.lastPurchaseDate).toLocaleDateString()})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(_,{className:"w-5 h-5 text-indigo-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Customer Status"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Loyalty Level"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:y.loyaltyLevel})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Total Devices"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:pe.length})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Active Repairs"}),e.jsx("p",{className:"text-sm font-medium text-orange-600",children:pe.filter(e=>["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(e.status)).length})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Completed"}),e.jsx("p",{className:"text-sm font-medium text-green-600",children:pe.filter(e=>"done"===e.status).length})]})]})]}),(y.totalCalls||0)>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(L,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Call Summary"}),y.callLoyaltyLevel&&e.jsx("span",{className:"ml-auto inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("VIP"===y.callLoyaltyLevel?"bg-purple-100 text-purple-800":"Gold"===y.callLoyaltyLevel?"bg-yellow-100 text-yellow-800":"Silver"===y.callLoyaltyLevel?"bg-gray-100 text-gray-800":"Bronze"===y.callLoyaltyLevel?"bg-orange-100 text-orange-800":"bg-blue-100 text-blue-800"),children:y.callLoyaltyLevel})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Calls"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:y.totalCalls||0})]}),(y.incomingCalls||0)>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Incoming"}),e.jsx("span",{className:"text-sm font-medium text-green-600",children:y.incomingCalls})]}),(y.outgoingCalls||0)>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Outgoing"}),e.jsx("span",{className:"text-sm font-medium text-blue-600",children:y.outgoingCalls})]}),(y.missedCalls||0)>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Missed"}),e.jsx("span",{className:"text-sm font-medium text-red-600",children:y.missedCalls})]}),(y.avgCallDurationMinutes||0)>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Avg Duration"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[y.avgCallDurationMinutes.toFixed(1)," min"]})]}),y.lastCallDate&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Last Call"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:new Date(y.lastCallDate).toLocaleDateString()})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(I,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Financial Summary"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Spent"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:y.totalSpent?`Tsh ${y.totalSpent.toLocaleString()}`:"Tsh 0"})]}),(y.totalPurchases||0)>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Purchases"}),e.jsx("span",{className:"text-sm font-semibold text-indigo-600",children:y.totalPurchases})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Loyalty Points"}),e.jsx("span",{className:"text-sm font-semibold text-blue-600",children:y.loyaltyPoints||y.points||0})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Last Purchase"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:y.lastPurchaseDate?new Date(y.lastPurchaseDate).toLocaleDateString():"Never"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(Q,{className:"w-5 h-5 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Quick Actions"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>Ue(!0),className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium",children:[e.jsx(N,{className:"w-4 h-4"}),"Send SMS"]}),e.jsxs("button",{onClick:()=>Ye(!0),className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm font-medium",children:[e.jsx(j,{className:"w-4 h-4"}),"Add Points"]}),e.jsxs("button",{onClick:()=>ut(!0),className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-sm font-medium",children:[e.jsx(M,{className:"w-4 h-4"}),"Book Appointment"]})]})]})]})]})]}),"activity"===xe&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-6 h-6 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Repair History"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["Total: ",pe.length]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Active: ",pe.filter(e=>["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(e.status)).length]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Completed: ",pe.filter(e=>"done"===e.status).length]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Device"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Issue"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Created"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Total Paid"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Points"})]})}),e.jsxs("tbody",{children:[pe.map(t=>{const s=he.filter(e=>e.deviceId===t.id&&"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0);return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[t.brand," ",t.model]}),e.jsx("div",{className:"text-xs text-gray-500",children:t.serialNumber||"No serial"})]})}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("done"===t.status?"bg-green-100 text-green-800":"failed"===t.status?"bg-red-100 text-red-800":["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(t.status)?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"),children:t.status.replace(/-/g," ")})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"max-w-xs truncate",title:t.issueDescription,children:t.issueDescription})}),e.jsx("td",{className:"p-3",children:new Date(t.createdAt).toLocaleDateString()}),e.jsx("td",{className:"p-3",children:s>0?i(s):"-"}),e.jsx("td",{className:"p-3",children:e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[d(t,y.loyaltyLevel)," pts"]})})]},t.id)}),0===pe.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-gray-500 py-4",children:"No repair history found"})})]})]})})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-6 h-6 text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Payment History"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[he.length," payments â€¢ ",i(he.reduce((e,t)=>e+(Number(t.amount)||0),0))," total"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Date"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Type"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Amount"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Method"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"})]})}),e.jsxs("tbody",{children:[he.slice(0,10).map(t=>e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:new Date(t.date).toLocaleDateString()}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("payment"===t.type?"bg-green-100 text-green-800":"deposit"===t.type?"bg-blue-100 text-blue-800":"bg-orange-100 text-orange-800"),children:t.type})}),e.jsx("td",{className:"p-3 font-medium",children:i(t.amount)}),e.jsx("td",{className:"p-3",children:t.method}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("completed"===t.status?"bg-green-100 text-green-800":"pending"===t.status?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"),children:t.status})})]},t.id)),0===he.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center text-gray-500 py-4",children:"No payments found"})})]})]})})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-6 h-6 text-purple-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Appointments"})]}),e.jsxs(r,{onClick:()=>{},className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors",children:[e.jsx(X,{className:"w-4 h-4"}),"Schedule"]})]}),qe?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading appointments..."}):ke.length>0?e.jsxs("div",{className:"space-y-3",children:[ke.slice(0,5).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center",children:e.jsx(X,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.service_type}),e.jsxs("p",{className:"text-sm text-gray-500",children:[new Date(t.appointment_date).toLocaleDateString()," at ",t.appointment_time]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("completed"===t.status?"bg-green-100 text-green-800":"confirmed"===t.status?"bg-blue-100 text-blue-800":"pending"===t.status?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"),children:t.status}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[t.duration_minutes," min"]})]})]},t.id)),ke.length>5&&e.jsxs("div",{className:"text-center text-sm text-gray-500",children:["+",ke.length-5," more appointments"]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(X,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No appointments found"}),e.jsx("p",{className:"text-sm",children:"Schedule the first appointment for this customer"})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-6 h-6 text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Recent Communications"})]})}),qe?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading communication history..."}):Ae.length>0?e.jsxs("div",{className:"space-y-3",children:[Ae.slice(0,5).map((t,s)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 flex items-center justify-center",children:e.jsx(N,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"SMS"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium "+("delivered"===t.status?"bg-green-100 text-green-800":"sent"===t.status?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"),children:t.status})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-1",children:t.message}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleString()})]})]},s)),Ae.length>5&&e.jsxs("div",{className:"text-center text-sm text-gray-500",children:["+",Ae.length-5," more messages"]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(k,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No communication history found"}),e.jsx("p",{className:"text-sm",children:"Start a conversation with this customer"})]})]})]}),"journey"===xe&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Customer Journey"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Complete timeline of all interactions and activities"})]}),e.jsx(oe,{customerId:y.id,customerPhone:y.phone})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100 bg-gray-50 px-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("button",{onClick:()=>{Ue(!0),jt("sms_opened")},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(N,{className:"w-4 h-4"}),"SMS"]}),e.jsxs("button",{onClick:()=>{mt(!0),jt("whatsapp_opened")},className:"flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(k,{className:"w-4 h-4"}),"WhatsApp"]}),e.jsxs("button",{onClick:()=>Ye(!0),className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(g,{className:"w-4 h-4"}),"Points"]}),e.jsxs("button",{onClick:()=>{lt(!0),jt("checkin_opened")},className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(_,{className:"w-4 h-4"}),"Check-in"]}),e.jsxs("button",{onClick:()=>{ut(!0),jt("appointment_modal_opened")},className:"flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(X,{className:"w-4 h-4"}),"Schedule"]}),e.jsxs("button",{onClick:()=>gt(!0),className:"flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(Z,{className:"w-4 h-4"}),"Preferences"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:b,className:"px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors text-sm font-medium",children:"Close"}),e.jsxs("button",{onClick:()=>tt(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(Y,{className:"w-4 h-4"}),"Edit"]})]})]})]}),e.jsx(ee,{isOpen:We,onClose:()=>{Ue(!1),He(""),Xe(null)},title:"Send SMS",maxWidth:"400px",children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),Qe(!0),Xe(null);try{const e=y.phone.replace(/\D/g,""),l=await c.sendSMS(e,Ge);if(l.success){let l=!1,n=!1;try{const{data:s,error:a}=await t.from("sms_logs").insert({recipient_phone:e,message:Ge,status:"sent",sent_by:null==B?void 0:B.id,device_id:null,cost:null,sent_at:(new Date).toISOString(),created_at:(new Date).toISOString()}).select().single();a||(l=!0)}catch(s){}try{const{data:s,error:a}=await t.from("customer_communications").insert({customer_id:y.id,type:"sms",message:Ge,status:"sent",phone_number:e,sent_by:null==B?void 0:B.id,sent_at:(new Date).toISOString()}).select().single();a||(n=!0)}catch(a){}Xe(`âœ… SMS sent${l||n?" and logged":" (logging skipped)"} successfully!`),He(""),f.success("SMS sent successfully!");try{await bt()}catch(r){}}else{const e=l.error||"Unknown error occurred";Xe(`Failed: ${e}`),f.error(`SMS Failed: ${e}`)}}catch(l){let e="Failed to send SMS";(null==l?void 0:l.message)?e=l.message:(null==l?void 0:l.error)?e="string"==typeof l.error?l.error:JSON.stringify(l.error):"string"==typeof l&&(e=l),Xe(`âŒ ${e}`),f.error(e)}finally{Qe(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"To"}),e.jsx("div",{className:"py-2 px-4 bg-blue-50 text-blue-700 font-medium rounded",children:y.phone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"Message"}),e.jsx("textarea",{value:Ge,onChange:e=>He(e.target.value),rows:3,className:"w-full py-2 px-4 bg-white/30 backdrop-blur-md border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50",placeholder:"Type your message here",required:!0})]}),Ke&&e.jsx("div",{className:"text-sm "+(Ke.startsWith("Failed")?"text-red-600":"text-green-600"),children:Ke}),e.jsxs("div",{className:"flex gap-3 justify-end mt-4",children:[e.jsx(r,{type:"button",variant:"secondary",onClick:()=>{Ue(!1),He(""),Xe(null)},children:"Cancel"}),e.jsx(r,{type:"submit",variant:"primary",disabled:Je,children:Je?"Sending...":"Send SMS"})]})]})}),e.jsx(de,{isOpen:Ze,onClose:()=>Ye(!1),customerId:y.id,customerName:y.name,currentPoints:y.points||0,loyaltyLevel:y.loyaltyLevel,onPointsUpdated:e=>{q(y.id,{points:e})}}),e.jsx(ee,{isOpen:et,onClose:()=>tt(!1),title:"Edit Customer",maxWidth:"xl",children:e.jsx(te,{onSubmit:async e=>{at(!0);try{const{notes:t,referralSourceCustom:s,...a}=e;t&&t.trim()&&await O(y.id,t.trim());const r=s&&s.trim()?s.trim():a.referralSource,l={...a,referralSource:r};await q(y.id,l)?(tt(!1),ie(e=>({...e,...l})),f.success("Customer updated successfully!")):f.error("Failed to update customer")}catch(t){f.error("Failed to update customer")}finally{at(!1)}},onCancel:()=>tt(!1),isLoading:st,initialValues:{id:y.id,name:y.name||"",email:y.email||"",phone:y.phone||"",whatsapp:y.whatsapp||y.phone||"",gender:"male"===y.gender||"female"===y.gender?y.gender:"male",city:y.city||"",referralSource:y.referralSource||"",birthMonth:y.birthMonth||"",birthDay:y.birthDay||"",notes:Array.isArray(y.notes)&&y.notes.length>0?y.notes[y.notes.length-1].content:"string"==typeof y.notes?y.notes:""},renderActionsInModal:!0,children:(t,s)=>e.jsxs(e.Fragment,{children:[s,t]})})}),rt&&e.jsx(ee,{isOpen:rt,onClose:()=>{lt(!1),it(!1)},title:"Customer Check-in",children:e.jsx("div",{className:"p-4",children:nt?e.jsxs("div",{className:"text-green-600 font-bold text-center mb-4",children:["Check-in successful! 20 points awarded.",ze&&!ze.isActive&&e.jsx("div",{className:"text-blue-600 text-sm mt-2",children:"Customer has been reactivated automatically."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center text-gray-700",children:[e.jsx("p",{className:"text-sm mb-2",children:"Check in this customer:"}),e.jsx("p",{className:"font-medium text-lg",children:y.name}),e.jsx("p",{className:"text-sm text-gray-500",children:y.phone})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("button",{onClick:async()=>{ct(!0);try{if(!(null==B?void 0:B.id))throw new Error("No staff user.");const e=await o(y.id,B.id);e.success?(it(!0),e.wasReactivated?f.success("Customer checked in and reactivated! Points awarded."):f.success("Check-in successful! Points awarded."),await yt(),ie(e=>({...e,isActive:!0,lastVisit:(new Date).toISOString()}))):f.error(e.message)}catch(e){f.error("Check-in failed: "+(e.message||"Unknown error"))}finally{ct(!1)}},disabled:dt,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white rounded-lg transition-colors font-medium",children:dt?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Checking in..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4"}),"Check In Customer"]})}),e.jsx("button",{onClick:()=>lt(!1),className:"w-full px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"})]})]})})}),e.jsx(ce,{isOpen:ot,onClose:()=>mt(!1),customer:y,onMessageSent:()=>{bt()}}),e.jsx(le,{isOpen:xt,onClose:()=>ut(!1),customer:y,mode:"create",onSave:async e=>{try{await p(e),await bt(),await yt(),await jt("appointment_created")}catch(t){throw t}}}),e.jsx(ee,{isOpen:pt,onClose:()=>gt(!1),title:"Customer Preferences",maxWidth:"md",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("form",{id:"preferences-form",children:Be?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Preferred Contact Method"}),e.jsxs("select",{name:"preferred_contact_method",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:Be.preferred_contact_method||"whatsapp",children:[e.jsx("option",{value:"whatsapp",children:"WhatsApp"}),e.jsx("option",{value:"sms",children:"SMS"}),e.jsx("option",{value:"phone",children:"Phone Call"}),e.jsx("option",{value:"email",children:"Email"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Language"}),e.jsxs("select",{name:"language",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:Be.language||"en",children:[e.jsx("option",{value:"en",children:"English"}),e.jsx("option",{value:"sw",children:"Swahili"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notification Preferences"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"repair_updates",defaultChecked:null==(w=Be.notification_preferences)?void 0:w.repair_updates,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Repair Updates"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"appointment_reminders",defaultChecked:null==(C=Be.notification_preferences)?void 0:C.appointment_reminders,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Appointment Reminders"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"promotions",defaultChecked:null==(S=Be.notification_preferences)?void 0:S.promotions,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Promotions"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Quiet Hours"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"time",name:"quiet_start",defaultValue:(null==(T=Be.quiet_hours)?void 0:T.start)||"22:00",className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("span",{className:"flex items-center justify-center text-gray-500",children:"to"}),e.jsx("input",{type:"time",name:"quiet_end",defaultValue:(null==($=Be.quiet_hours)?void 0:$.end)||"08:00",className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Z,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No preferences set for this customer"}),e.jsx("p",{className:"text-sm",children:"Preferences will be created when first saved"})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{onClick:()=>gt(!1),className:"px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{try{const e=document.querySelector("#preferences-form");if(!e)return void f.error("Form not found");const s=new FormData(e),a={customer_id:y.id,preferred_contact_method:s.get("preferred_contact_method")||"whatsapp",language:s.get("language")||"en",notification_preferences:{repair_updates:"on"===s.get("repair_updates"),appointment_reminders:"on"===s.get("appointment_reminders"),promotions:"on"===s.get("promotions")},quiet_hours:{start:s.get("quiet_start")||"22:00",end:s.get("quiet_end")||"08:00"}},{error:r}=await t.from("customer_preferences").upsert(a,{onConflict:"customer_id",ignoreDuplicates:!1});if(r)return void f.error("Failed to save preferences");f.success("Preferences saved successfully!"),gt(!1),await bt()}catch(e){f.error("Failed to save preferences")}},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Save Preferences"})]})]})})]}):null};export{xe as C};
