import{a2 as t,s as e}from"./index-222cfb29.js";import"./supabase-460661f2.js";const a={products:864e5,customers:432e5,sales:6048e5,branches:864e5,categories:1728e5,payment_accounts:864e5,settings:1728e5};const s=new class{constructor(){this.db=null}async init(){return this.db||(this.db=await t("mobile-offline-pos",1,{upgrade(t,e,a,s){if(!t.objectStoreNames.contains("products")){const e=t.createObjectStore("products",{keyPath:"id"});e.createIndex("category","category"),e.createIndex("is_active","is_active")}if(t.objectStoreNames.contains("customers")||t.createObjectStore("customers",{keyPath:"id"}),!t.objectStoreNames.contains("sales")){t.createObjectStore("sales",{keyPath:"id"}).createIndex("created_at","created_at")}if(t.objectStoreNames.contains("branches")||t.createObjectStore("branches",{keyPath:"id"}),t.objectStoreNames.contains("categories")||t.createObjectStore("categories",{keyPath:"id"}),t.objectStoreNames.contains("payment_accounts")||t.createObjectStore("payment_accounts",{keyPath:"id"}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),!t.objectStoreNames.contains("pending_sales")){t.createObjectStore("pending_sales",{keyPath:"id",autoIncrement:!0}).createIndex("created_at","created_at")}t.objectStoreNames.contains("sync_metadata")||t.createObjectStore("sync_metadata",{keyPath:"store"})}})),this.db}async isCacheValid(t){try{const e=await this.init(),s=await e.get("sync_metadata",t);if(!s)return!1;const n=a[t],c=Date.now();return c-new Date(s.lastSynced).getTime()<n}catch(e){return!1}}async syncAll(t){const e=[],a=[];try{try{await this.syncProducts(t),e.push("products")}catch(s){a.push("products")}try{await this.syncCustomers(t),e.push("customers")}catch(s){a.push("customers")}try{await this.syncBranches(),e.push("branches")}catch(s){a.push("branches")}try{await this.syncCategories(),e.push("categories")}catch(s){a.push("categories")}try{await this.syncPaymentAccounts(),e.push("payment_accounts")}catch(s){a.push("payment_accounts")}try{await this.syncRecentSales(t),e.push("sales")}catch(s){a.push("sales")}return a.length,{success:0===a.length,synced:e,errors:a}}catch(s){return{success:!1,synced:e,errors:[...a,"fatal_error"]}}}async syncProducts(t){const a=await this.init();let s=e.from("lats_products").select("*").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1e3);t&&(s=s.eq("branch_id",t));const{data:n,error:c}=await s;if(c)throw new Error(`Failed to sync products: ${c.message}`);if(!n||0===n.length)return;const r=a.transaction("products","readwrite");await r.store.clear();for(const e of n)await r.store.put({...e,_cachedAt:(new Date).toISOString()});await r.done,await a.put("sync_metadata",{store:"products",lastSynced:(new Date).toISOString(),itemCount:n.length,version:1})}async syncCustomers(t){const a=await this.init();let s=e.from("lats_customers").select("*").order("created_at",{ascending:!1}).limit(500);t&&(s=s.eq("branch_id",t));const{data:n,error:c}=await s;if(c)throw new Error(`Failed to sync customers: ${c.message}`);if(!n||0===n.length)return;const r=a.transaction("customers","readwrite");await r.store.clear();for(const e of n)await r.store.put({...e,_cachedAt:(new Date).toISOString()});await r.done,await a.put("sync_metadata",{store:"customers",lastSynced:(new Date).toISOString(),itemCount:n.length,version:1})}async syncBranches(){const t=await this.init(),{data:a,error:s}=await e.from("lats_branches").select("*").eq("is_active",!0);if(s)throw new Error(`Failed to sync branches: ${s.message}`);if(!a||0===a.length)return;const n=t.transaction("branches","readwrite");await n.store.clear();for(const e of a)await n.store.put({...e,_cachedAt:(new Date).toISOString()});await n.done,await t.put("sync_metadata",{store:"branches",lastSynced:(new Date).toISOString(),itemCount:a.length,version:1})}async syncCategories(){const t=await this.init(),{data:a,error:s}=await e.from("lats_categories").select("*").eq("is_active",!0);if(s)throw new Error(`Failed to sync categories: ${s.message}`);if(!a||0===a.length)return;const n=t.transaction("categories","readwrite");await n.store.clear();for(const e of a)await n.store.put({...e,_cachedAt:(new Date).toISOString()});await n.done,await t.put("sync_metadata",{store:"categories",lastSynced:(new Date).toISOString(),itemCount:a.length,version:1})}async syncPaymentAccounts(){const t=await this.init(),{data:a,error:s}=await e.from("lats_payment_accounts").select("*").eq("is_active",!0);if(s)throw new Error(`Failed to sync payment accounts: ${s.message}`);if(!a||0===a.length)return;const n=t.transaction("payment_accounts","readwrite");await n.store.clear();for(const e of a)await n.store.put({...e,_cachedAt:(new Date).toISOString()});await n.done,await t.put("sync_metadata",{store:"payment_accounts",lastSynced:(new Date).toISOString(),itemCount:a.length,version:1})}async syncRecentSales(t){const a=await this.init(),s=new Date;s.setDate(s.getDate()-30);let n=e.from("lats_sales").select("*").gte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(200);t&&(n=n.eq("branch_id",t));const{data:c,error:r}=await n;if(r)throw new Error(`Failed to sync sales: ${r.message}`);if(!c||0===c.length)return;const i=a.transaction("sales","readwrite");await i.store.clear();for(const e of c)await i.store.put({...e,_cachedAt:(new Date).toISOString()});await i.done,await a.put("sync_metadata",{store:"sales",lastSynced:(new Date).toISOString(),itemCount:c.length,version:1})}async getProducts(){const t=await this.init();return await t.getAll("products")}async getCustomers(){const t=await this.init();return await t.getAll("customers")}async getSales(){const t=await this.init();return await t.getAll("sales")}async getBranches(){const t=await this.init();return await t.getAll("branches")}async getCategories(){const t=await this.init();return await t.getAll("categories")}async getPaymentAccounts(){const t=await this.init();return await t.getAll("payment_accounts")}async savePendingSale(t){const e=await this.init();return await e.add("pending_sales",{...t,created_at:(new Date).toISOString(),synced:!1})}async getPendingSales(){const t=await this.init();return(await t.getAll("pending_sales")).filter(t=>!t.synced)}async markSaleSynced(t){const e=await this.init(),a=await e.get("pending_sales",t);a&&await e.put("pending_sales",{...a,synced:!0})}async getCacheStats(){const t=await this.init(),[e,a,s,n,c,r,i,o,l,d,u,y,h]=await Promise.all([t.count("products"),t.count("customers"),t.count("sales"),t.count("branches"),t.count("categories"),t.count("payment_accounts"),t.count("pending_sales"),t.get("sync_metadata","products"),t.get("sync_metadata","customers"),t.get("sync_metadata","sales"),t.get("sync_metadata","branches"),t.get("sync_metadata","categories"),t.get("sync_metadata","payment_accounts")]);return{products:{count:e,lastSynced:(null==o?void 0:o.lastSynced)||null},customers:{count:a,lastSynced:(null==l?void 0:l.lastSynced)||null},sales:{count:s,lastSynced:(null==d?void 0:d.lastSynced)||null},branches:{count:n,lastSynced:(null==u?void 0:u.lastSynced)||null},categories:{count:c,lastSynced:(null==y?void 0:y.lastSynced)||null},payment_accounts:{count:r,lastSynced:(null==h?void 0:h.lastSynced)||null},pending_sales:{count:i}}}async clearAll(){const t=await this.init();await Promise.all([t.clear("products"),t.clear("customers"),t.clear("sales"),t.clear("branches"),t.clear("categories"),t.clear("payment_accounts"),t.clear("pending_sales"),t.clear("sync_metadata")])}};export{s as m};
