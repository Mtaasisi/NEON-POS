import{s as e,j as s}from"./index-222cfb29.js";import{r as t}from"./vendor-a2ff445a.js";import{n as a,y as l,ab as r,az as i}from"./ui-551a39a6.js";import{format as n}from"./format-0f0b2647.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";const o=()=>{const[o,c]=t.useState([]),[d,m]=t.useState(new Set),[u,h]=t.useState(!0),[x,p]=t.useState(!1),[g,y]=t.useState(""),[b,v]=t.useState(""),[f,j]=t.useState({loyaltyLevel:"all",colorTag:"all",city:"all",minSpent:"",maxSpent:"",minPoints:"",activeOnly:!0,hasDevices:"all",lastVisit:"all"}),[N,w]=t.useState(()=>{const e=localStorage.getItem("sms_price_per_unit");return e?parseFloat(e):50}),[S,C]=t.useState(!1),[k,T]=t.useState(!1),_={"win-back":{title:"Win-Back Inactive Customers",message:"Hi [Name], we noticed it's been a while since your last visit! We'd love to see you again. Get 20% off your next repair. Reply VISIT to book.",description:"For customers who haven't visited in 90+ days"},"vip-exclusive":{title:"VIP Exclusive Offer",message:"Dear [Name], as one of our valued VIP customers, you're invited to an exclusive 30% off on all services this month. Thank you for your continued trust!",description:"For Platinum/VIP customers"},"loyalty-reward":{title:"Loyalty Points Reminder",message:"Hi [Name]! You have [Points] loyalty points ready to use. That's [Amount] TZS in savings! Visit us today to redeem them.",description:"For customers with high points balance"},"high-spender":{title:"Thank You - High Value",message:"Thank you for being one of our top customers, [Name]! As appreciation, enjoy free diagnostics on your next device. We value your business!",description:"For customers who spent over 500K TZS"},"new-service":{title:"New Service Announcement",message:"Hi [Name]! We've launched a new service that might interest you. [Service Name] - now available with special introductory pricing. Call us to learn more!",description:"General announcement for active customers"},"appointment-reminder":{title:"Appointment Follow-up",message:"Hi [Name], this is a friendly reminder about your appointment on [Date] at [Time]. Reply CONFIRM or call us. See you soon!",description:"For customers with upcoming appointments"},"device-ready":{title:"Device Repair Complete",message:"Good news [Name]! Your [Device] is ready for pickup. Our store is open 8AM-8PM daily. Thank you for your patience!",description:"For customers with completed repairs"},"feedback-request":{title:"Service Feedback",message:"Hi [Name], thank you for choosing us! How was your experience? Reply with a rating 1-5 or visit our store to share feedback. Your opinion matters!",description:"Post-service feedback request"},birthday:{title:"Birthday Special",message:"Happy Birthday [Name]! ðŸŽ‰ Celebrate with us - get 25% off any service this month. Wishing you a fantastic year ahead!",description:"For customers with birthdays this month"},"referral-incentive":{title:"Referral Program",message:"Hi [Name]! Refer a friend to us and you both get 15% off your next service. Share the love and save together!",description:"Encourage referrals from satisfied customers"}};t.useEffect(()=>{P()},[]);const P=async()=>{try{h(!0);const{data:s,error:t}=await e.from("customers").select("id, name, phone, email, city, total_spent, loyalty_level, color_tag, last_visit, is_active, points").order("name");if(t)throw t;c(s||[])}catch(s){a.error("Failed to load customers")}finally{h(!1)}},M=t.useMemo(()=>Array.from(new Set(o.map(e=>e.city).filter(Boolean))),[o]),L=t.useMemo(()=>o.filter(e=>{var s;if(b){const t=b.toLowerCase();if(!e.name.toLowerCase().includes(t)&&!e.phone.toLowerCase().includes(t)&&!(null==(s=e.email)?void 0:s.toLowerCase().includes(t)))return!1}if("all"!==f.loyaltyLevel&&e.loyalty_level!==f.loyaltyLevel)return!1;if("all"!==f.colorTag&&e.color_tag!==f.colorTag)return!1;if("all"!==f.city&&e.city!==f.city)return!1;if(f.minSpent&&(e.total_spent||0)<parseFloat(f.minSpent))return!1;if(f.maxSpent&&(e.total_spent||0)>parseFloat(f.maxSpent))return!1;if(f.minPoints&&(e.points||0)<parseFloat(f.minPoints))return!1;if(f.activeOnly&&!e.is_active)return!1;if("all"!==f.lastVisit&&e.last_visit){const s=new Date(e.last_visit),t=new Date,a=Math.floor((t.getTime()-s.getTime())/864e5);switch(f.lastVisit){case"7days":if(a>7)return!1;break;case"30days":if(a>30)return!1;break;case"90days":if(a>90)return!1;break;case"6months":if(a>180)return!1;break;case"1year":if(a>365)return!1}}return!0}),[o,b,f]),F=t.useMemo(()=>{const e=[];0===L.length&&e.push({type:"warning",text:"No customers match your filters"});const s=L.filter(e=>"platinum"===e.loyalty_level||"vip"===e.color_tag);s.length>0&&e.push({type:"vip",text:`${s.length} VIP customers found`,action:()=>{const e=new Set(s.map(e=>e.id));m(e),a.success(`Selected ${s.length} VIP customers`)}});const t=L.filter(e=>{if(!e.last_visit)return!1;return Math.floor((Date.now()-new Date(e.last_visit).getTime())/864e5)>90});t.length>0&&e.push({type:"inactive",text:`${t.length} customers haven't visited in 90+ days`,action:()=>{const e=new Set(t.map(e=>e.id));m(e),a.success(`Selected ${t.length} inactive customers`)}});const l=L.filter(e=>(e.total_spent||0)>5e5);return l.length>0&&e.push({type:"highspender",text:`${l.length} customers have spent over 500,000 TZS`,action:()=>{const e=new Set(l.map(e=>e.id));m(e),a.success(`Selected ${l.length} high spenders`)}}),e},[L]),z=(e=>{const s=e.length,t=/[^\x00-\x7F]/.test(e),a=t?70:160;return{charCount:s,smsUnits:Math.ceil(s/a),charsPerSMS:a,encoding:t?"Unicode":"GSM-7"}})(g),V=d.size*z.smsUnits*N;return u?s.jsx("div",{className:"flex items-center justify-center h-screen",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6",children:s.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Bulk SMS"}),s.jsx("p",{className:"text-gray-600",children:"Send SMS to multiple customers at once with smart filtering"})]}),F.length>0&&s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[s.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"ðŸ’¡ Smart Suggestions"}),s.jsx("div",{className:"space-y-2",children:F.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg "+("warning"===e.type?"bg-yellow-50 border border-yellow-200":"vip"===e.type?"bg-purple-50 border border-purple-200":"inactive"===e.type?"bg-orange-50 border border-orange-200":"bg-green-50 border border-green-200"),children:[s.jsx("span",{className:"text-sm text-gray-700",children:e.text}),e.action&&s.jsx("button",{onClick:e.action,className:"px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm",children:"Select These"})]},t))})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[s.jsxs("div",{className:"flex gap-4 mb-4",children:[s.jsxs("div",{className:"flex-1 relative",children:[s.jsx(l,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:20}),s.jsx("input",{type:"text",placeholder:"Search by name, phone, or email...",value:b,onChange:e=>v(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),s.jsxs("button",{onClick:()=>C(!S),className:"px-4 py-2 rounded-lg flex items-center gap-2 "+(S?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"),children:[s.jsx(r,{size:20}),"Filters"]})]}),S&&s.jsxs("div",{className:"border-t pt-4 grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loyalty Level"}),s.jsxs("select",{value:f.loyaltyLevel,onChange:e=>j({...f,loyaltyLevel:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[s.jsx("option",{value:"all",children:"All Levels"}),s.jsx("option",{value:"platinum",children:"Platinum"}),s.jsx("option",{value:"gold",children:"Gold"}),s.jsx("option",{value:"silver",children:"Silver"}),s.jsx("option",{value:"bronze",children:"Bronze"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Color Tag"}),s.jsxs("select",{value:f.colorTag,onChange:e=>j({...f,colorTag:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[s.jsx("option",{value:"all",children:"All Tags"}),s.jsx("option",{value:"vip",children:"VIP"}),s.jsx("option",{value:"new",children:"New"}),s.jsx("option",{value:"complainer",children:"Complainer"}),s.jsx("option",{value:"purchased",children:"Purchased"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"City"}),s.jsxs("select",{value:f.city,onChange:e=>j({...f,city:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[s.jsx("option",{value:"all",children:"All Cities"}),M.map(e=>s.jsx("option",{value:e,children:e},e))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Visit"}),s.jsxs("select",{value:f.lastVisit,onChange:e=>j({...f,lastVisit:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[s.jsx("option",{value:"all",children:"Any Time"}),s.jsx("option",{value:"7days",children:"Last 7 days"}),s.jsx("option",{value:"30days",children:"Last 30 days"}),s.jsx("option",{value:"90days",children:"Last 90 days"}),s.jsx("option",{value:"6months",children:"Last 6 months"}),s.jsx("option",{value:"1year",children:"Last year"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Min Spent (TZS)"}),s.jsx("input",{type:"number",value:f.minSpent,onChange:e=>j({...f,minSpent:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"0"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Min Points"}),s.jsx("input",{type:"number",value:f.minPoints,onChange:e=>j({...f,minPoints:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"0"})]}),s.jsx("div",{className:"col-span-2",children:s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",checked:f.activeOnly,onChange:e=>j({...f,activeOnly:e.target.checked}),className:"w-4 h-4 text-blue-600 rounded"}),s.jsx("span",{className:"text-sm text-gray-700",children:"Show active customers only"})]})}),s.jsx("div",{className:"col-span-2 flex gap-2",children:s.jsx("button",{onClick:()=>j({loyaltyLevel:"all",colorTag:"all",city:"all",minSpent:"",maxSpent:"",minPoints:"",activeOnly:!0,hasDevices:"all",lastVisit:"all"}),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",children:"Clear Filters"})})]})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Customers (",L.length,")"]}),s.jsx("button",{onClick:()=>{d.size===L.length?m(new Set):m(new Set(L.map(e=>e.id)))},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:d.size===L.length?"Deselect All":"Select All"})]}),s.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:L.map(e=>s.jsx("div",{onClick:()=>(e=>{const s=new Set(d);s.has(e)?s.delete(e):s.add(e),m(s)})(e.id),className:"p-4 rounded-lg border-2 cursor-pointer transition-all "+(d.has(e.id)?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-blue-300"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-6 h-6 rounded flex items-center justify-center "+(d.has(e.id)?"bg-blue-600":"bg-gray-200"),children:d.has(e.id)&&s.jsx(i,{size:16,className:"text-white"})}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-gray-900",children:e.name}),s.jsx("div",{className:"text-sm text-gray-600",children:e.phone})]})]}),s.jsxs("div",{className:"text-right",children:[e.loyalty_level&&s.jsx("span",{className:"inline-block px-2 py-1 rounded text-xs font-medium "+("platinum"===e.loyalty_level?"bg-purple-100 text-purple-800":"gold"===e.loyalty_level?"bg-yellow-100 text-yellow-800":"silver"===e.loyalty_level?"bg-gray-100 text-gray-800":"bg-orange-100 text-orange-800"),children:e.loyalty_level}),e.total_spent&&s.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Spent: ",n.money(e.total_spent)]})]})]})},e.id))})]})]}),s.jsx("div",{className:"space-y-4",children:s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Compose Message"}),s.jsxs("button",{onClick:()=>T(!k),className:"text-sm text-blue-600 hover:text-blue-800 font-medium",children:[k?"Hide":"Show"," Templates"]})]}),k&&s.jsxs("div",{className:"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-3",children:"ðŸ“ Message Templates"}),s.jsx("div",{className:"space-y-2",children:Object.entries(_).map(([e,t])=>s.jsxs("button",{onClick:()=>{y(t.message),T(!1),a.success(`Template "${t.title}" loaded!`)},className:"w-full text-left p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all",children:[s.jsx("div",{className:"font-medium text-gray-900 text-sm",children:t.title}),s.jsx("div",{className:"text-xs text-gray-500 mt-1",children:t.description})]},e))}),s.jsx("div",{className:"mt-3 text-xs text-gray-500",children:"ðŸ’¡ Tip: Use [Name], [Points], [Device], [Date], [Time], [Amount] as placeholders"})]}),s.jsx("textarea",{value:g,onChange:e=>y(e.target.value),placeholder:"Type your message here or use a template above...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4",rows:6}),s.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"Characters:"}),s.jsx("span",{className:"font-medium text-gray-900",children:z.charCount})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"SMS Units (each):"}),s.jsx("span",{className:"font-medium text-gray-900",children:z.smsUnits})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"Encoding:"}),s.jsx("span",{className:"font-medium text-gray-900",children:z.encoding})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"Price per SMS:"}),s.jsxs("span",{className:"font-medium text-gray-900",children:[N," TZS"]})]})]})}),s.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-4",children:[s.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"ðŸ“Š Summary"}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"Recipients:"}),s.jsx("span",{className:"font-bold text-gray-900",children:d.size})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-600",children:"Total SMS Units:"}),s.jsx("span",{className:"font-bold text-gray-900",children:d.size*z.smsUnits})]}),s.jsxs("div",{className:"border-t border-green-300 pt-2 mt-2 flex justify-between",children:[s.jsx("span",{className:"font-semibold text-gray-900",children:"Total Cost:"}),s.jsx("span",{className:"text-lg font-bold text-green-700",children:n.money(V)})]})]})]}),s.jsx("button",{onClick:async()=>{if(0!==d.size)if(g.trim())try{p(!0);const s=o.filter(e=>d.has(e.id)).map(e=>({recipient_phone:e.phone,message:g,status:"pending",created_at:(new Date).toISOString(),sent_at:(new Date).toISOString()})),{error:t}=await e.from("sms_logs").insert(s);if(t)throw t;a.success(`Successfully queued ${d.size} SMS messages!`),y(""),m(new Set)}catch(s){a.error("Failed to send SMS messages")}finally{p(!1)}else a.error("Please enter a message");else a.error("Please select at least one customer")},disabled:x||0===d.size||!g.trim(),className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium",children:x?"Sending...":`Send to ${d.size} Customer${1!==d.size?"s":""}`})]})})]})]})})};export{o as default};
