import{s as t}from"./index-222cfb29.js";import{w as e}from"./whatsappService-37f3bd6b.js";const n=new class{async generatePlanNumber(){const{data:e,error:n}=await t.from("customer_installment_plans").select("plan_number").order("created_at",{ascending:!1}).limit(1);if(n)return`INS-${Date.now().toString().slice(-6)}`;if(!e||0===e.length)return"INS-001";const a=e[0].plan_number.match(/INS-(\d+)/);if(a){return`INS-${(parseInt(a[1])+1).toString().padStart(3,"0")}`}return`INS-${Date.now().toString().slice(-6)}`}calculateSchedule(t,e,n){const a=new Date(t);let r;switch(n){case"weekly":r=7;break;case"bi_weekly":r=14;break;default:r=30}const s=new Date(a);s.setDate(s.getDate()+r);const l=new Date(a);return l.setDate(l.getDate()+r*e),{nextPaymentDate:s.toISOString().split("T")[0],endDate:l.toISOString().split("T")[0]}}async createInstallmentPlan(e,n,a){try{const r=await this.generatePlanNumber(),s=e.total_amount-e.down_payment,l=s/e.number_of_installments,m=this.calculateSchedule(e.start_date,e.number_of_installments,e.payment_frequency),o={plan_number:r,customer_id:e.customer_id,sale_id:e.sale_id,total_amount:e.total_amount,down_payment:e.down_payment,amount_financed:s,installment_amount:l,number_of_installments:e.number_of_installments,payment_frequency:e.payment_frequency,start_date:e.start_date,next_payment_date:m.nextPaymentDate,end_date:m.endDate,balance_due:s,late_fee_amount:e.late_fee_amount||0,notes:e.notes,status:"active",created_by:n,branch_id:a},{data:i,error:u}=await t.from("customer_installment_plans").insert(o).select().single();if(u)throw u;if(e.down_payment>0){const a={installment_plan_id:i.id,customer_id:e.customer_id,installment_number:0,amount:e.down_payment,payment_method:e.payment_method,due_date:e.start_date,account_id:e.account_id,reference_number:`${r}-DOWN`,notes:"Down payment",status:"paid",created_by:n},{error:s}=await t.from("installment_payments").insert(a);await this.updateFinanceAccount(e.account_id,e.down_payment)}return await this.sendPlanCreatedNotification(i.id,n),{success:!0,plan:i}}catch(r){return{success:!1,error:r.message}}}async recordPayment(e,n){try{const a=await this.getInstallmentPlanById(e.installment_plan_id);if(!a)return{success:!1,error:"Installment plan not found"};const r=a.installments_paid+1,s=a.next_payment_date,{data:l,error:m}=await t.from("installment_payments").insert({installment_plan_id:e.installment_plan_id,customer_id:e.customer_id,installment_number:r,amount:e.amount,payment_method:e.payment_method,due_date:s,account_id:e.account_id,reference_number:e.reference_number,notes:e.notes,status:"paid",created_by:n}).select().single();if(m)throw m;await this.updateFinanceAccount(e.account_id,e.amount);const o=this.calculateSchedule(s,1,a.payment_frequency),i={next_payment_date:a.installments_paid+1>=a.number_of_installments?null:o.nextPaymentDate,updated_at:(new Date).toISOString()},{error:u}=await t.from("customer_installment_plans").update(i).eq("id",e.installment_plan_id);if(u)throw u;return await this.sendPaymentReceivedNotification(e.installment_plan_id,e.amount,n),{success:!0,payment:l}}catch(a){return{success:!1,error:a.message}}}async getAllInstallmentPlans(e){try{let n=t.from("customer_installment_plans").select("\n          *,\n          customer:customers!customer_id(id, name, phone, email),\n          sale:lats_sales!sale_id(id, sale_number, total_amount)\n        ").order("created_at",{ascending:!1});e&&(n=n.eq("branch_id",e));const{data:a,error:r}=await n;if(r)throw r;return(a||[]).map(t=>({...t,total_amount:Number(t.total_amount||0),down_payment:Number(t.down_payment||0),amount_financed:Number(t.amount_financed||0),total_paid:Number(t.total_paid||0),balance_due:Number(t.balance_due||0),installment_amount:Number(t.installment_amount||0),number_of_installments:Number(t.number_of_installments||0),installments_paid:Number(t.installments_paid||0),late_fee_amount:Number(t.late_fee_amount||0),late_fee_applied:Number(t.late_fee_applied||0),days_overdue:Number(t.days_overdue||0),reminder_count:Number(t.reminder_count||0)}))}catch(n){return[]}}async getInstallmentPlanById(e){try{const{data:n,error:a}=await t.from("customer_installment_plans").select("\n          *,\n          customer:customers!customer_id(id, name, phone, email),\n          sale:lats_sales!sale_id(id, sale_number, total_amount)\n        ").eq("id",e).single();if(a)throw a;const{data:r}=await t.from("installment_payments").select("*").eq("installment_plan_id",e).order("created_at",{ascending:!0});return{...n,total_amount:Number(n.total_amount||0),down_payment:Number(n.down_payment||0),amount_financed:Number(n.amount_financed||0),total_paid:Number(n.total_paid||0),balance_due:Number(n.balance_due||0),installment_amount:Number(n.installment_amount||0),number_of_installments:Number(n.number_of_installments||0),installments_paid:Number(n.installments_paid||0),late_fee_amount:Number(n.late_fee_amount||0),late_fee_applied:Number(n.late_fee_applied||0),days_overdue:Number(n.days_overdue||0),reminder_count:Number(n.reminder_count||0),payments:r||[]}}catch(n){return null}}async getCustomerInstallmentPlans(e){try{const{data:n,error:a}=await t.from("customer_installment_plans").select("*").eq("customer_id",e).order("created_at",{ascending:!1});if(a)throw a;return n||[]}catch(n){return[]}}async getPaymentSchedule(t){var e;try{const n=await this.getInstallmentPlanById(t);if(!n)return[];const a=[],r=new Date(n.start_date);let s;switch(n.payment_frequency){case"weekly":s=7;break;case"bi_weekly":s=14;break;default:s=30}for(let t=1;t<=n.number_of_installments;t++){const l=new Date(r);l.setDate(l.getDate()+s*t);const m=null==(e=n.payments)?void 0:e.find(e=>e.installment_number===t),o=new Date;o.setHours(0,0,0,0);let i="pending";"paid"===(null==m?void 0:m.status)?i="paid":l<o&&(i="overdue"),a.push({installment_number:t,due_date:l.toISOString().split("T")[0],amount:n.installment_amount,status:i,paid_date:null==m?void 0:m.payment_date,paid_amount:null==m?void 0:m.amount})}return a}catch(n){return[]}}async getStatistics(e){try{let n=t.from("customer_installment_plans").select("*");e&&(n=n.eq("branch_id",e));const{data:a,error:r}=await n;if(r)throw r;const s=a||[],l=new Date,m=new Date(l);m.setDate(m.getDate()+7);const o=new Date(l);o.setDate(o.getDate()+30);return{total:s.length,active:s.filter(t=>"active"===t.status).length,completed:s.filter(t=>"completed"===t.status).length,defaulted:s.filter(t=>"defaulted"===t.status).length,cancelled:s.filter(t=>"cancelled"===t.status).length,total_value:s.reduce((t,e)=>t+Number(e.total_amount||0),0),total_paid:s.reduce((t,e)=>t+Number(e.total_paid||0),0),total_balance_due:s.reduce((t,e)=>t+Number(e.balance_due||0),0),overdue_count:s.filter(t=>{const e=new Date(t.next_payment_date);return"active"===t.status&&e<l}).length,due_this_week:s.filter(t=>{const e=new Date(t.next_payment_date);return"active"===t.status&&e>=l&&e<=m}).length,due_this_month:s.filter(t=>{const e=new Date(t.next_payment_date);return"active"===t.status&&e>=l&&e<=o}).length}}catch(n){return{total:0,active:0,completed:0,defaulted:0,cancelled:0,total_value:0,total_paid:0,total_balance_due:0,overdue_count:0,due_this_week:0,due_this_month:0}}}async sendPaymentReminder(n,a){try{const a=await this.getInstallmentPlanById(n);if(!a||!a.customer)return{success:!1,error:"Plan or customer not found"};const r=Math.ceil((new Date(a.next_payment_date).getTime()-(new Date).getTime())/864e5),s=`ðŸ“… Payment Reminder\n\nHi ${a.customer.name},\n\nYour installment payment of ${this.formatCurrency(a.installment_amount)} is due on ${this.formatDate(a.next_payment_date)} (${r} days).\n\nPlan: ${a.plan_number}\nCurrent Balance: ${this.formatCurrency(a.balance_due)}\nInstallments Paid: ${a.installments_paid}/${a.number_of_installments}\n\nPlease make your payment on time. Thank you!`;return a.customer.phone&&await e.sendWhatsAppMessage(a.customer.phone,s,a.customer_id),await t.from("customer_installment_plans").update({last_reminder_sent:(new Date).toISOString(),reminder_count:a.reminder_count+1}).eq("id",n),{success:!0}}catch(r){return{success:!1,error:r.message}}}async cancelPlan(e){try{const{error:n}=await t.from("customer_installment_plans").update({status:"cancelled",updated_at:(new Date).toISOString()}).eq("id",e);if(n)throw n;return{success:!0}}catch(n){return{success:!1,error:n.message}}}async updateInstallmentPlan(e,n){try{const{data:a,error:r}=await t.from("customer_installment_plans").update({...n,updated_at:(new Date).toISOString()}).eq("id",e).select().single();if(r)throw r;return{success:!0,plan:await this.getInstallmentPlanById(e)||void 0}}catch(a){return{success:!1,error:a.message}}}async updateFinanceAccount(e,n){try{const{data:a,error:r}=await t.from("finance_accounts").select("balance").eq("id",e).single();if(r||!a)return;const s=Number(a.balance)+n,{error:l}=await t.from("finance_accounts").update({balance:s,updated_at:(new Date).toISOString()}).eq("id",e)}catch(a){}}async sendPlanCreatedNotification(n,a){try{const s=await this.getInstallmentPlanById(n);if(!s||!s.customer)return;const l=`âœ… Installment Plan Created!\n\nPlan: ${s.plan_number}\nTotal Amount: ${this.formatCurrency(s.total_amount)}\nDown Payment: ${this.formatCurrency(s.down_payment)}\nAmount to Finance: ${this.formatCurrency(s.amount_financed)}\n\nPayment Schedule:\n- ${this.formatCurrency(s.installment_amount)} per ${"monthly"===s.payment_frequency?"month":"weekly"===s.payment_frequency?"week":"payment"}\n- ${s.number_of_installments} installments\n- Next payment: ${this.formatDate(s.next_payment_date)}\n\nThank you for choosing our installment plan!`;s.customer.phone&&await e.sendWhatsAppMessage(s.customer.phone,l,s.customer_id);try{await t.from("notifications").insert({user_id:a,type:"payment",category:"payment",title:"Installment Plan Created",message:`Plan ${s.plan_number} for ${s.customer.name}`,priority:"normal",status:"unread",metadata:{planId:s.id,planNumber:s.plan_number}})}catch(r){}}catch(r){}}async sendPaymentReceivedNotification(n,a,r){try{const l=await this.getInstallmentPlanById(n);if(!l||!l.customer)return;const m=`âœ… Payment Received!\n\nPlan: ${l.plan_number}\nAmount Paid: ${this.formatCurrency(a)}\nRemaining Balance: ${this.formatCurrency(l.balance_due)}\n\nInstallments Paid: ${l.installments_paid}/${l.number_of_installments}\nNext Payment Due: ${this.formatDate(l.next_payment_date)}\n\nThank you for your payment!`;l.customer.phone&&await e.sendWhatsAppMessage(l.customer.phone,m,l.customer_id);try{await t.from("notifications").insert({user_id:r,type:"payment",category:"payment",title:"Installment Payment Received",message:`${this.formatCurrency(a)} received for plan ${l.plan_number}`,priority:"normal",status:"unread",metadata:{planId:l.id,amount:a}})}catch(s){}}catch(s){}}formatCurrency(t){return new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(t)}formatDate(t){return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}};export{n as i};
