import{s as e}from"./index-222cfb29.js";import"./vendor-a2ff445a.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";import"./ui-551a39a6.js";const t=new class{async processPayment(t){var r;try{const o=[];if(t.purchaseOrderId||o.push("Purchase Order ID"),t.paymentAccountId||o.push("Payment Account ID"),(!t.amount||t.amount<=0)&&o.push("Payment Amount"),t.paymentMethodId||o.push("Payment Method ID"),o.length>0){const e=`Missing required payment data: ${o.join(", ")}`;throw new Error(e)}const{data:c,error:s}=await e.from("lats_purchase_orders").select("payment_status, total_amount, total_paid, total_amount_base_currency, currency").eq("id",t.purchaseOrderId).single();if(s)throw new Error("Failed to verify purchase order payment status");if("paid"===c.payment_status)return{success:!1,message:"This purchase order has already been fully paid"};const u=Number(c.total_paid)||0,d=(Number(c.total_amount_base_currency||c.total_amount)||0)-u;if(t.amount>d+1)return{success:!1,message:`Payment amount (${t.amount.toLocaleString()} TZS) exceeds remaining balance (${d.toLocaleString()} TZS)`};const i=e=>{if(!e)return!1;return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)},m=t.currency||"TZS";if(i(m))throw new Error(`Invalid currency value: "${m}" appears to be a UUID. Expected a currency code like TZS, USD, EUR, etc.`);const p=t.paymentMethod;if(i(p))throw new Error(`Invalid payment method value: "${p}" appears to be a UUID. Expected a payment method name like Cash, Bank Transfer, etc.`);if(!i(t.purchaseOrderId))throw new Error(`Invalid purchase order ID: "${t.purchaseOrderId}". Expected a valid UUID.`);if(!i(t.paymentAccountId))throw new Error(`Invalid payment account ID: "${t.paymentAccountId}". Expected a valid UUID.`);if(!i(t.paymentMethodId))throw new Error(`Invalid payment method ID: "${t.paymentMethodId}". Expected a valid UUID.`);const _=t.createdBy&&i(t.createdBy)?t.createdBy:"00000000-0000-0000-0000-000000000001",{data:l,error:y}=await e.rpc("process_purchase_order_payment",{purchase_order_id_param:t.purchaseOrderId,payment_account_id_param:t.paymentAccountId,amount_param:t.amount,currency_param:m,payment_method_param:p,payment_method_id_param:t.paymentMethodId,user_id_param:_,reference_param:t.reference||null,notes_param:t.notes||null});if(y)try{const r=crypto.randomUUID(),{error:n}=await e.from("purchase_order_payments").insert({id:r,purchase_order_id:t.purchaseOrderId,payment_account_id:t.paymentAccountId,amount:t.amount,currency:m,payment_method:p,payment_method_id:t.paymentMethodId,reference:t.reference||null,notes:t.notes||null,status:"completed",payment_date:(new Date).toISOString(),created_by:_,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()});if(n)throw new Error(`Payment processing failed: ${y.message}`);const{data:o}=await e.from("lats_purchase_orders").select("total_paid, total_amount, total_amount_base_currency, currency").eq("id",t.purchaseOrderId).single(),c=((null==o?void 0:o.total_paid)||0)+t.amount,s=c>=((null==o?void 0:o.total_amount_base_currency)||(null==o?void 0:o.total_amount)||0)?"paid":"partial";await e.from("lats_purchase_orders").update({total_paid:c,payment_status:s,updated_at:(new Date).toISOString()}).eq("id",t.purchaseOrderId);const{data:u}=await e.from("finance_accounts").select("balance").eq("id",t.paymentAccountId).single();if(u){const n=u.balance-t.amount;await e.from("finance_accounts").update({balance:n,updated_at:(new Date).toISOString()}).eq("id",t.paymentAccountId);try{const{data:a}=await e.from("lats_purchase_orders").select("po_number, supplier_id, currency, exchange_rate, base_currency, total_amount, total_amount_base_currency").eq("id",t.purchaseOrderId).single();let o="Unknown Supplier";if(null==a?void 0:a.supplier_id){const{data:t}=await e.from("lats_suppliers").select("name").eq("id",a.supplier_id).single();t&&(o=t.name)}const c=(null==a?void 0:a.po_number)||`PO-${t.purchaseOrderId.substring(0,8)}`;let s=t.amount;const d=(null==a?void 0:a.currency)||"TZS",i=(null==a?void 0:a.exchange_rate)||1,m=(null==a?void 0:a.base_currency)||"TZS";d!==m&&1!==i&&(s=t.amount),await e.from("account_transactions").insert({account_id:t.paymentAccountId,transaction_type:"expense",amount:t.amount,balance_before:u.balance,balance_after:n,description:`PO Payment: ${c} - ${o} (Fallback)`,reference_number:t.reference||`PO-PAY-${r.substring(0,8)}`,related_entity_type:"purchase_order_payment",related_entity_id:r,metadata:{purchase_order_id:t.purchaseOrderId,po_reference:c,supplier:o,payment_method:p,po_currency:d,po_total_amount:null==a?void 0:a.total_amount,po_total_amount_base_currency:null==a?void 0:a.total_amount_base_currency,po_exchange_rate:i,payment_amount_tzs:t.amount,base_currency:m,expense_amount_base_currency:s},created_by:_,created_at:(new Date).toISOString()})}catch(a){}}return{success:!0,message:"Payment processed successfully (using fallback method)",payment:{id:r,purchaseOrderId:t.purchaseOrderId,paymentAccountId:t.paymentAccountId,amount:t.amount,currency:m,paymentMethod:p,paymentMethodId:t.paymentMethodId,reference:t.reference,notes:t.notes,status:"completed",paymentDate:(new Date).toISOString(),createdBy:_,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}}}catch(n){throw new Error(`Payment processing failed: ${y.message}`)}let h=Array.isArray(l)?l[0]:l;if((null==h?void 0:h.process_purchase_order_payment)&&(h=h.process_purchase_order_payment),!(null==h?void 0:h.success))throw new Error((null==h?void 0:h.message)||"Payment processing failed");const f=null==(r=h.data)?void 0:r.payment_id;if(!f)throw new Error("Payment processed but no payment ID returned");const{data:w,error:g}=await e.from("purchase_order_payments").select("*").eq("id",f).single();return g?{success:!0,message:"Payment processed successfully",payment:{id:f,purchaseOrderId:t.purchaseOrderId,paymentAccountId:t.paymentAccountId,amount:h.data.amount_paid,currency:t.currency||"TZS",paymentMethod:t.paymentMethod,paymentMethodId:t.paymentMethodId,reference:t.reference,notes:t.notes,status:"completed",paymentDate:(new Date).toISOString(),createdBy:t.createdBy||"00000000-0000-0000-0000-000000000001",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}}:{success:!0,message:"Payment processed successfully",payment:w}}catch(o){return{success:!1,message:`Payment failed: ${o instanceof Error?o.message:"Unknown error"}`}}}async getPaymentSummary(t){try{const{data:r,error:a}=await e.rpc("get_purchase_order_payment_summary",{purchase_order_id_param:t});return a?{success:!1,message:"Failed to get payment summary"}:{success:!0,data:(null==r?void 0:r[0])||null}}catch(r){return{success:!1,message:`Unexpected error: ${r instanceof Error?r.message:"Unknown error"}`}}}async getPaymentHistory(t){try{const{data:r,error:a}=await e.rpc("get_purchase_order_payment_history",{purchase_order_id_param:t});return a?{success:!1,message:"Failed to get payment history"}:{success:!0,data:r||[]}}catch(r){return{success:!1,message:`Unexpected error: ${r instanceof Error?r.message:"Unknown error"}`}}}async createPurchaseOrderPayment(t){try{const{data:a,error:n}=await e.from("finance_accounts").select("*").eq("id",t.paymentAccountId).single();if(n||!a)throw new Error("Payment account not found");let o=t.amount,c=a.balance||0;if((isNaN(c)||null==c)&&(c=0),a.currency!==t.currency){const e=(e,t)=>{var r;try{if(void 0!==globalThis.import&&(null==(r=globalThis.import.meta)?void 0:r.env))return globalThis.import.meta.env[e]||t;if("undefined"!=typeof process&&process.env)return process.env[e]||t;if("undefined"!=typeof window&&window.env)return window.env[e]||t}catch(a){}return t},r={USD_TZS:parseFloat(e("REACT_APP_USD_TZS_RATE","2500")),TZS_USD:parseFloat(e("REACT_APP_TZS_USD_RATE","0.0004")),EUR_TZS:parseFloat(e("REACT_APP_EUR_TZS_RATE","2700")),TZS_EUR:parseFloat(e("REACT_APP_TZS_EUR_RATE","0.00037")),GBP_TZS:parseFloat(e("REACT_APP_GBP_TZS_RATE","3200")),TZS_GBP:parseFloat(e("REACT_APP_TZS_GBP_RATE","0.00031"))},n=r[`${t.currency}_${a.currency}`];if(!n)throw new Error(`Currency conversion not supported: ${t.currency} to ${a.currency}. Please use matching currencies or contact support.`);o=t.amount*n}if(c<o){const e=o-c;throw new Error(`âŒ Insufficient balance in ${a.name}!\nAvailable: ${a.currency} ${c.toLocaleString()}\nRequired: ${a.currency} ${o.toLocaleString()}\nShortfall: ${a.currency} ${e.toLocaleString()}\nPlease add funds to the account or use a different payment method.`)}const{data:s,error:u}=await e.from("users").select("id").limit(1).single();if(u||!s){}let d=t.notes||"";if(a.currency!==t.currency){const e=`Original: ${t.amount} ${t.currency} (converted to ${o} ${a.currency})`;d=d?`${d}\n${e}`:e}const{data:i,error:m}=await e.from("purchase_order_payments").insert({purchase_order_id:t.purchaseOrderId,payment_account_id:t.paymentAccountId,amount:o,currency:a.currency,payment_method:t.paymentMethod,payment_method_id:t.paymentMethodId,reference:t.reference,notes:d,status:"completed",payment_date:(new Date).toISOString(),created_by:(null==s?void 0:s.id)||"00000000-0000-0000-0000-000000000001"}).select().single();if(m)throw new Error("Failed to create purchase order payment record");const p=c-o,{error:_}=await e.from("finance_accounts").update({balance:p,updated_at:(new Date).toISOString()}).eq("id",t.paymentAccountId);try{const{data:r}=await e.from("lats_purchase_orders").select("po_number, supplier_id, currency, exchange_rate, base_currency, total_amount, total_amount_base_currency").eq("id",t.purchaseOrderId).single();let n="Unknown Supplier";if(null==r?void 0:r.supplier_id){const{data:t}=await e.from("lats_suppliers").select("name").eq("id",r.supplier_id).single();t&&(n=t.name)}const u=(null==r?void 0:r.po_number)||`PO-${t.purchaseOrderId.substring(0,8)}`,d=t.amount,m=(null==r?void 0:r.currency)||"TZS",_=(null==r?void 0:r.exchange_rate)||1,l=(null==r?void 0:r.base_currency)||"TZS";if(m!==l&&1!==_){const e=(null==r?void 0:r.total_amount_base_currency)||0;e>0&&t.amount}const{error:y}=await e.from("account_transactions").insert({account_id:t.paymentAccountId,transaction_type:"expense",amount:o,balance_before:c,balance_after:p,description:`PO Payment: ${u} - ${n}`,reference_number:t.reference||`PO-PAY-${i.id.substring(0,8)}`,related_entity_type:"purchase_order_payment",related_entity_id:i.id,metadata:{purchase_order_id:t.purchaseOrderId,po_reference:u,supplier:n,payment_method:t.paymentMethod,account_name:a.name,po_currency:m,po_total_amount:null==r?void 0:r.total_amount,po_total_amount_base_currency:null==r?void 0:r.total_amount_base_currency,po_exchange_rate:_,payment_amount_tzs:t.amount,base_currency:l,expense_amount_base_currency:d,account_currency:a.currency,account_amount:o},created_by:(null==s?void 0:s.id)||"00000000-0000-0000-0000-000000000001",created_at:(new Date).toISOString()})}catch(r){}return i}catch(a){throw a}}async createMultiplePurchaseOrderPayments(e){try{const t=[];for(const r of e){const e=await this.createPurchaseOrderPayment(r);t.push(e)}return t}catch(t){throw t}}async getPurchaseOrderPayments(t){try{const{data:r,error:a}=await e.from("purchase_order_payments").select("*").eq("purchase_order_id",t).order("created_at",{ascending:!1});if(a)throw new Error("Failed to fetch purchase order payments");return r||[]}catch(r){throw r}}async getPurchaseOrderPaymentSummary(t){var r;try{const{data:a,error:n}=await e.from("purchase_order_payments").select("amount, payment_date").eq("purchase_order_id",t).eq("status","completed");if(n)throw new Error("Failed to fetch payment summary");const o=(null==a?void 0:a.reduce((e,t)=>e+t.amount,0))||0,c=(null==a?void 0:a.length)||0,s=null==(r=null==a?void 0:a[0])?void 0:r.payment_date,{data:u,error:d}=await e.from("lats_purchase_orders").select("total_amount").eq("id",t).single();if(d)throw new Error("Failed to fetch purchase order total");return{totalPaid:o,remainingAmount:((null==u?void 0:u.total_amount)||0)-o,paymentCount:c,lastPaymentDate:s}}catch(a){throw a}}async updatePaymentStatus(t,r,a){try{const{error:a}=await e.from("purchase_order_payments").update({status:r,updated_at:(new Date).toISOString()}).eq("id",t);if(a)throw new Error("Failed to update payment status");return!0}catch(n){throw n}}async deletePurchaseOrderPayment(t,r){try{const{data:r,error:a}=await e.from("purchase_order_payments").select("*").eq("id",t).single();if(a||!r)throw new Error("Payment not found");const{error:n}=await e.from("finance_accounts").update({balance:e.raw(`balance + ${r.amount}`),updated_at:(new Date).toISOString()}).eq("id",r.payment_account_id),{error:o}=await e.from("purchase_order_payments").delete().eq("id",t);if(o)throw new Error("Failed to delete payment");return!0}catch(a){throw a}}};export{t as purchaseOrderPaymentService};
