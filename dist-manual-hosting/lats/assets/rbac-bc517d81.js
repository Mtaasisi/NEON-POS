import{j as e,s,au as r}from"./index-222cfb29.js";import{r as t,b as a}from"./vendor-a2ff445a.js";import{i as o,$ as i,n,k as c,X as l,A as d,d as m,ak as u,q as p,aD as h,aA as x,m as g,D as v}from"./ui-551a39a6.js";const y=({onKeyPress:s,onBackspace:r,onClear:t,disabled:a=!1})=>e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"grid grid-cols-3 gap-4 max-w-md mx-auto",children:[["1","2","3"],["4","5","6"],["7","8","9"],["Clear","0","Backspace"]].map((n,c)=>n.map((n,l)=>e.jsx("button",{onClick:()=>(e=>{a||("Backspace"===e?r():"Clear"===e?t():s(e))})(n),disabled:a,className:`aspect-square flex items-center justify-center rounded-lg font-semibold text-2xl transition-all duration-200 min-h-[64px] min-w-[64px] ${"Backspace"===n||"Clear"===n?"bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400":"bg-white text-gray-900 hover:bg-gray-100 active:bg-gray-200 border border-gray-300"} ${a?"opacity-50 cursor-not-allowed":"cursor-pointer"} shadow-sm hover:shadow-md active:shadow-inner`,children:"Backspace"===n?e.jsx(o,{className:"w-6 h-6"}):"Clear"===n?e.jsx(i,{className:"w-6 h-6"}):n},`${c}-${l}`)))})}),f=({isOpen:r,onClose:o,onComplete:i,currentUser:f,expectedPasscode:b="1234"})=>{const[w,j]=t.useState("summary"),[_,N]=t.useState([]),[k,C]=t.useState(0),[S,P]=t.useState(0),[R,A]=t.useState(!1),[D,T]=t.useState(""),[E,O]=t.useState(!1),[U,$]=t.useState(!1);t.useEffect(()=>{r&&B()},[r]);const B=async()=>{try{A(!0);const e=(new Date).toISOString().split("T")[0],r=new Date(e+"T00:00:00.000Z").toISOString(),t=new Date(e+"T23:59:59.999Z").toISOString(),{data:a,error:o}=await s.from("lats_sales").select("*").gte("created_at",r).lte("created_at",t);if(o)return void n.error("Failed to load daily sales");const i=new Map;let c=0,l=0;null==a||a.forEach(e=>{var s;if(e.payment_method){const r=parseFloat(e.total_amount)||0;if(isNaN(r)||!isFinite(r))return;if("multiple"===e.payment_method.type&&(null==(s=e.payment_method.details)?void 0:s.payments))e.payment_method.details.payments.forEach(e=>{const s=e.method||"Unknown",r=parseFloat(e.amount)||0;if(!isNaN(r)&&isFinite(r))if(i.has(s)){const e=i.get(s);i.set(s,{total:e.total+r,count:e.count+1})}else i.set(s,{total:r,count:1})});else{const s=e.payment_method.name||e.payment_method.type||"Unknown";if(i.has(s)){const e=i.get(s);i.set(s,{total:e.total+r,count:e.count+1})}else i.set(s,{total:r,count:1})}c+=r,l++}});const d=Array.from(i.entries()).map(([e,s])=>({method:e,total:s.total,count:s.count,confirmed:!1}));N(d),C(c),P(l)}catch(e){n.error("Failed to load daily summary")}finally{A(!1)}},F=s=>{const r=s.toLowerCase();return r.includes("cash")?e.jsx(h,{className:"w-5 h-5"}):r.includes("card")||r.includes("credit")?e.jsx(x,{className:"w-5 h-5"}):r.includes("mobile")||r.includes("mpesa")||r.includes("tigo")?e.jsx(g,{className:"w-5 h-5"}):e.jsx(v,{className:"w-5 h-5"})},I=e=>{const s=e.toLowerCase();return s.includes("cash")?"text-green-600 bg-green-100":s.includes("card")||s.includes("credit")?"text-blue-600 bg-blue-100":s.includes("mobile")||s.includes("mpesa")||s.includes("tigo")?"text-purple-600 bg-purple-100":"text-gray-600 bg-gray-100"};return r?a.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",style:{zIndex:99999},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center",children:e.jsx(c,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Daily Sales Closing"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["summary"===w&&"Review daily sales summary","confirm"===w&&"Confirm payment totals","passcode"===w&&"Enter passcode to close"]})]})]}),e.jsx("button",{onClick:o,className:"w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors",children:e.jsx(l,{className:"w-4 h-4 text-gray-500"})})]}),e.jsxs("div",{className:"p-6",children:[R&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})}),!R&&"summary"===w&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Daily Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Sales"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[k.toLocaleString()," TZS"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Transactions"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:S})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Payment Methods"}),e.jsx("div",{className:"space-y-3",children:_.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${I(s.method)}`,children:F(s.method)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.method}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.count," transactions"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-gray-900",children:[s.total.toLocaleString()," TZS"]})})]},r))})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:o,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Cancel"}),e.jsx("button",{onClick:()=>j("confirm"),className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium",children:"Continue to Confirmation"})]})]}),!R&&"confirm"===w&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(d,{className:"w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-orange-800 font-medium",children:"Confirm each payment method"}),e.jsx("p",{className:"text-sm text-orange-700 mt-1",children:"Please verify the totals for each payment method before closing the day."})]})]})}),e.jsx("div",{className:"space-y-3",children:_.map((s,r)=>e.jsx("div",{className:"p-4 border rounded-lg transition-colors "+(s.confirmed?"border-green-200 bg-green-50":"border-gray-200 bg-white"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${I(s.method)}`,children:F(s.method)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.method}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.count," transactions"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-gray-900",children:[s.total.toLocaleString()," TZS"]})}),e.jsx("button",{onClick:()=>{return e=s.method,void N(s=>s.map(s=>s.method===e?{...s,confirmed:!s.confirmed}:s));var e},className:"w-8 h-8 rounded-full flex items-center justify-center transition-colors "+(s.confirmed?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400 hover:bg-gray-200"),children:e.jsx(m,{className:"w-5 h-5"})})]})]})},r))}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>j("summary"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Back to Summary"}),e.jsx("button",{onClick:()=>{N(e=>e.map(e=>({...e,confirmed:!0}))),$(!0),j("passcode")},disabled:!_.every(e=>e.confirmed),className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:"All Confirmed - Continue"})]})]}),!R&&"passcode"===w&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(m,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-800 font-medium",children:"All payments confirmed"}),e.jsx("p",{className:"text-sm text-green-700 mt-1",children:"Enter passcode to complete daily closing."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Enter Passcode"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:E?"text":"password",value:D,onChange:e=>T(e.target.value),placeholder:"Enter 4-digit passcode",className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-center text-lg tracking-widest",maxLength:4,readOnly:!0}),e.jsx("button",{type:"button",onClick:()=>O(!E),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:E?e.jsx(u,{className:"w-5 h-5"}):e.jsx(p,{className:"w-5 h-5"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Use the passcode configured in POS Settings"})]}),e.jsx("div",{children:e.jsx(y,{onKeyPress:e=>{D.length<4&&T(s=>s+e)},onBackspace:()=>{T(e=>e.slice(0,-1))},onClear:()=>{T("")},disabled:R})})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>j("confirm"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Back to Confirmation"}),e.jsxs("button",{onClick:async()=>{try{if(A(!0),D!==b)return void n.error("Invalid passcode");const e={date:(new Date).toISOString().split("T")[0],total_sales:k,total_transactions:S,closed_at:(new Date).toISOString(),closed_by:(null==f?void 0:f.name)||(null==f?void 0:f.email)||"Unknown",closed_by_user_id:null==f?void 0:f.id,sales_data:{payment_summaries:_,confirmed_by:(null==f?void 0:f.name)||(null==f?void 0:f.email)}},{error:r}=await s.from("daily_sales_closures").upsert(e,{onConflict:"date",ignoreDuplicates:!1});if(r)return void n.error("Failed to close daily sales");n.success("Daily sales closed successfully! ðŸŽ‰"),i(),o()}catch(e){n.error("Failed to close daily sales")}finally{A(!1)}},disabled:4!==D.length||R,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[e.jsx(c,{className:"w-4 h-4"}),R?"Closing...":"Close Day"]})]})]})]})]})}),document.body):null},b=[{resource:"inventory",action:"view",roles:["admin","customer-care","technician"]},{resource:"inventory",action:"create",roles:["admin"]},{resource:"inventory",action:"edit",roles:["admin"]},{resource:"inventory",action:"delete",roles:["admin"]},{resource:"inventory",action:"manage",roles:["admin"]},{resource:"categories",action:"view",roles:["admin","customer-care","technician"]},{resource:"categories",action:"create",roles:["admin"]},{resource:"categories",action:"edit",roles:["admin"]},{resource:"categories",action:"delete",roles:["admin"]},{resource:"brands",action:"view",roles:["admin","customer-care","technician"]},{resource:"brands",action:"create",roles:["admin"]},{resource:"brands",action:"edit",roles:["admin"]},{resource:"brands",action:"delete",roles:["admin"]},{resource:"suppliers",action:"view",roles:["admin"]},{resource:"suppliers",action:"create",roles:["admin"]},{resource:"suppliers",action:"edit",roles:["admin"]},{resource:"suppliers",action:"delete",roles:["admin"]},{resource:"products",action:"view",roles:["admin","technician"]},{resource:"products",action:"create",roles:["admin"]},{resource:"products",action:"edit",roles:["admin"]},{resource:"products",action:"delete",roles:["admin"]},{resource:"stock",action:"view",roles:["admin","technician"]},{resource:"stock",action:"adjust",roles:["admin","technician"]},{resource:"stock",action:"history",roles:["admin"]},{resource:"purchase-orders",action:"view",roles:["admin"]},{resource:"purchase-orders",action:"create",roles:["admin"]},{resource:"purchase-orders",action:"edit",roles:["admin"]},{resource:"purchase-orders",action:"delete",roles:["admin"]},{resource:"purchase-orders",action:"receive",roles:["admin"]},{resource:"spare-parts",action:"view",roles:["admin","technician"]},{resource:"spare-parts",action:"create",roles:["admin"]},{resource:"spare-parts",action:"edit",roles:["admin"]},{resource:"spare-parts",action:"delete",roles:["admin"]},{resource:"spare-parts",action:"use",roles:["admin","technician"]},{resource:"pos",action:"view",roles:["admin","customer-care"]},{resource:"pos",action:"sell",roles:["admin","customer-care"]},{resource:"pos",action:"refund",roles:["admin"]},{resource:"pos",action:"void",roles:["admin"]},{resource:"pos-inventory",action:"view",roles:["admin","customer-care"]},{resource:"pos-inventory",action:"search",roles:["admin","customer-care"]},{resource:"pos-inventory",action:"add-to-cart",roles:["admin","customer-care"]},{resource:"sales",action:"view",roles:["admin","customer-care"]},{resource:"sales",action:"create",roles:["admin","customer-care"]},{resource:"sales",action:"edit",roles:["admin"]},{resource:"sales",action:"delete",roles:["admin"]},{resource:"sales",action:"refund",roles:["admin"]},{resource:"reports",action:"view",roles:["admin","customer-care"]},{resource:"reports",action:"export",roles:["admin","customer-care"]},{resource:"reports",action:"daily-close",roles:["admin","customer-care"]},{resource:"analytics",action:"view",roles:["admin"]},{resource:"analytics",action:"export",roles:["admin"]},{resource:"settings",action:"view",roles:["admin"]},{resource:"settings",action:"edit",roles:["admin"]},{resource:"system",action:"admin",roles:["admin"]},{resource:"system",action:"debug",roles:["admin"]}],w=[{path:"/lats/inventory/management",roles:["admin"]},{path:"/lats/inventory/new",roles:["admin"]},{path:"/lats/inventory/products",roles:["admin","technician"]},{path:"/lats/inventory/products/:id/edit",roles:["admin"]},{path:"/lats/inventory/purchase-orders",roles:["admin"]},{path:"/lats/inventory/purchase-orders/new",roles:["admin"]},{path:"/lats/add-product",roles:["admin"]},{path:"/lats/spare-parts",roles:["admin","technician"]},{path:"/lats/pos-inventory",roles:["admin","customer-care"]},{path:"/lats/pos",roles:["admin","customer-care"]}];const j=new class{constructor(){this.permissions=b,this.routePermissions=w}can(e,s,r){const t=this.permissions.find(e=>e.resource===s&&e.action===r);return!!t&&t.roles.includes(e)}canUser(e,s,t){var a;if(!e)return!1;const o=null==(a={inventory:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products",manage:"edit_settings"},products:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},pos:{view:"access_pos",sell:"process_sales",refund:"process_refunds",void:"process_refunds"},"pos-inventory":{view:"view_inventory",search:"view_inventory","add-to-cart":"access_pos"},sales:{view:"view_reports",create:"process_sales",edit:"process_sales",delete:"process_sales",refund:"process_refunds"},reports:{view:"view_reports",export:"view_reports","daily-close":"daily_close"},settings:{view:"view_settings",edit:"edit_settings"},"purchase-orders":{view:"view_purchase_orders",create:"create_purchase_orders",edit:"edit_purchase_orders",delete:"delete_purchase_orders",receive:"edit_purchase_orders"},"spare-parts":{view:"view_spare_parts",create:"create_spare_parts",edit:"edit_spare_parts",delete:"delete_spare_parts",use:"view_spare_parts"},categories:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},suppliers:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},stock:{view:"view_inventory",adjust:"adjust_stock",history:"view_stock_history"},analytics:{view:"view_financial_reports",export:"view_financial_reports"}}[s])?void 0:a[t];return!(!o||!r(e,o))||this.can(e.role,s,t)}canAccessRoute(e,s){const r=this.routePermissions.find(e=>e.exact?e.path===s:s.startsWith(e.path));return!r||r.roles.includes(e)}canUserAccessRoute(e,s){if(!e)return!1;const t={"/lats/pos":"access_pos","/lats/inventory/management":"edit_settings","/lats/inventory/new":"add_products","/lats/inventory/products":"view_inventory","/lats/inventory/products/:id/edit":"edit_products","/lats/inventory/purchase-orders":"view_purchase_orders","/lats/inventory/purchase-orders/new":"create_purchase_orders","/lats/add-product":"add_products","/lats/spare-parts":"view_spare_parts","/lats/pos-inventory":"view_inventory"};for(const[a,o]of Object.entries(t)){const t=a.replace(/:\w+/g,"[^/]+");if(new RegExp(`^${t}$`).test(s)&&r(e,o))return!0}return this.canAccessRoute(e.role,s)}hasPermission(e,s,r){const t=this.getRoleHierarchy()[e]||[];return this.permissions.some(e=>e.resource===s&&e.action===r&&e.roles.some(e=>t.includes(e)))}hasUserPermission(e,s,r){return this.canUser(e,s,r)}getRolePermissions(e){return this.permissions.filter(s=>s.roles.includes(e))}getAccessibleRoutes(e){return this.routePermissions.filter(s=>s.roles.includes(e)).map(e=>e.path)}addPermission(e){this.permissions.push(e)}removePermission(e,s){this.permissions=this.permissions.filter(r=>!(r.resource===e&&r.action===s))}addRoutePermission(e){this.routePermissions.push(e)}removeRoutePermission(e){this.routePermissions=this.routePermissions.filter(s=>s.path!==e)}getAvailableRoles(){return["admin","customer-care","technician","viewer"]}getRoleHierarchy(){return{admin:["admin","customer-care","technician","viewer"],"customer-care":["customer-care","viewer"],technician:["technician","viewer"],viewer:["viewer"]}}hasRoleAccess(e,s){var r;return(null==(r=this.getRoleHierarchy()[e])?void 0:r.includes(s))||!1}getAllRolePermissions(e){const s=this.getRoleHierarchy()[e]||[];return this.permissions.filter(e=>e.roles.some(e=>s.includes(e)))}validatePermission(e){return!!(e.resource&&e.action&&e.roles&&e.roles.length>0&&e.roles.every(e=>this.getAvailableRoles().includes(e)))}validateRoutePermission(e){return!!(e.path&&e.roles&&e.roles.length>0&&e.roles.every(e=>this.getAvailableRoles().includes(e)))}getPermissionSummary(e){const s=this.getAllRolePermissions(e),r={};return s.forEach(e=>{r[e.resource]||(r[e.resource]=[]),r[e.resource].push(e.action)}),r}canMultiple(e,s,r){return r.every(r=>this.can(e,s,r))}getAccessibleResources(e){const s=this.getAllRolePermissions(e);return[...new Set(s.map(e=>e.resource))]}getAccessibleActions(e,s){return this.getAllRolePermissions(e).filter(e=>e.resource===s).map(e=>e.action)}};export{f as D,y as V,j as r};
