import{at as e,j as s}from"./index-222cfb29.js";import{r as a,R as t}from"./vendor-a2ff445a.js";import{b as l,h as r,i,t as d}from"./tradeInApi-966791f7.js";import{format as n}from"./format-0f0b2647.js";import{a9 as c,X as o,y as m,m as x,d as u,$ as h}from"./ui-551a39a6.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";const g=({isOpen:g,onClose:p,newDevicePrice:b=0,onTradeInComplete:v})=>{const[j,f]=a.useState("select-device"),[y,N]=a.useState([]),[_,w]=a.useState([]),[C,k]=a.useState(!0),[I,D]=a.useState(""),[S,P]=a.useState(null),[E,T]=a.useState(""),[A,F]=a.useState("excellent"),[M,B]=a.useState(""),[R,V]=a.useState([]),[z,L]=a.useState(null);a.useEffect(()=>{g?O():(f("select-device"),P(null),T(""),F("excellent"),B(""),V([]),L(null),D(""))},[g]);const O=async()=>{k(!0);const[s,a]=await Promise.all([l({is_active:!0}),e()]);s.success&&s.data&&N(s.data),a.success&&a.data&&w(a.data),k(!1)};a.useEffect(()=>{if(S){const e=r(S.base_trade_in_price,A,{excellent:S.excellent_multiplier,good:S.good_multiplier,fair:S.fair_multiplier,poor:S.poor_multiplier},R),s=b?i(b,e.final_trade_in_value):0;L({...e,new_device_price:b||void 0,customer_payment_amount:s})}},[S,A,R,b]);if(!g)return null;const $=y.filter(e=>{if(!I)return!0;const s=I.toLowerCase();return e.device_name.toLowerCase().includes(s)||e.device_model.toLowerCase().includes(s)});return s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99998] p-4",onClick:e=>{e.target===e.currentTarget&&p()},children:s.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col relative z-[99998]",children:[s.jsxs("div",{className:"p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-blue-700",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(c,{className:"w-8 h-8 text-white"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold text-white",children:"Trade-In Calculator"}),s.jsx("p",{className:"text-blue-100 text-sm mt-1",children:"Value your customer's device for trade-in"})]})]}),s.jsx("button",{onClick:p,className:"p-2 hover:bg-blue-800 rounded-lg transition-colors text-white",children:s.jsx(o,{className:"w-6 h-6"})})]}),s.jsx("div",{className:"mt-6 flex items-center gap-2",children:["select-device","assess-condition","damage-assessment","review"].map((e,a)=>s.jsx(t.Fragment,{children:s.jsx("div",{className:"flex-1 h-2 rounded-full transition-all "+(j===e?"bg-white":a<["select-device","assess-condition","damage-assessment","review"].indexOf(j)?"bg-blue-300":"bg-blue-800")})},e))})]}),s.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:C?s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"})}):s.jsxs(s.Fragment,{children:["select-device"===j&&s.jsx("div",{className:"space-y-6",children:s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Select the device being traded in"}),s.jsxs("div",{className:"relative mb-4",children:[s.jsx(m,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),s.jsx("input",{type:"text",placeholder:"Search device...",value:I,onChange:e=>D(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto",children:$.map(e=>s.jsx("button",{onClick:()=>{P(e),f("assess-condition")},className:"p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-left",children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx(x,{className:"w-8 h-8 text-blue-600 flex-shrink-0"}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-semibold text-gray-900",children:e.device_name}),s.jsx("div",{className:"text-sm text-gray-600",children:e.device_model}),s.jsxs("div",{className:"mt-2 text-lg font-bold text-blue-600",children:["Up to ",n.money(e.base_trade_in_price)]})]})]})},e.id))}),0===$.length&&s.jsxs("div",{className:"text-center py-12",children:[s.jsx(x,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"No devices found"})]})]})}),"assess-condition"===j&&S&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[s.jsx("div",{className:"font-semibold text-gray-900",children:S.device_name}),s.jsx("div",{className:"text-sm text-gray-600",children:S.device_model})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Device IMEI *"}),s.jsx("input",{type:"text",required:!0,value:E,onChange:e=>T(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter device IMEI"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Device Condition *"}),s.jsx("div",{className:"grid grid-cols-2 gap-3",children:[{value:"excellent",label:"Excellent",color:"green",multiplier:S.excellent_multiplier},{value:"good",label:"Good",color:"blue",multiplier:S.good_multiplier},{value:"fair",label:"Fair",color:"yellow",multiplier:S.fair_multiplier},{value:"poor",label:"Poor",color:"red",multiplier:S.poor_multiplier}].map(e=>s.jsxs("button",{type:"button",onClick:()=>F(e.value),className:"p-4 border-2 rounded-lg transition-all "+(A===e.value?`border-${e.color}-500 bg-${e.color}-50`:"border-gray-200 hover:border-gray-300"),children:[s.jsx("div",{className:"font-semibold text-gray-900",children:e.label}),s.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[(100*e.multiplier).toFixed(0),"% of base price"]}),s.jsx("div",{className:"text-lg font-bold text-blue-600 mt-2",children:n.money(S.base_trade_in_price*e.multiplier)})]},e.value))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Condition Notes"}),s.jsx("textarea",{value:M,onChange:e=>B(e.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Describe the overall condition..."})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>f("select-device"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Back"}),s.jsx("button",{onClick:()=>{V([]),f("review")},className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"No Damage - Skip to Review"}),s.jsx("button",{onClick:()=>f("damage-assessment"),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Add Damage/Issues"})]})]}),"damage-assessment"===j&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Damage & Issues Assessment (Optional)"}),s.jsx("p",{className:"text-sm text-gray-600",children:"Add any damaged parts to deduct from the trade-in value, or skip if device has no issues"})]}),0===R.length&&s.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[s.jsx(u,{className:"w-5 h-5"}),s.jsx("span",{className:"font-medium",children:"No damage or issues selected"})]}),s.jsx("p",{className:"text-sm text-green-600 mt-1",children:'The device will be valued at the full condition-adjusted price. Click "Continue" to proceed.'})]}),R.length>0&&s.jsx("div",{className:"space-y-3",children:R.map((e,a)=>s.jsxs("div",{className:"flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"font-medium text-gray-900",children:e.spare_part_name}),s.jsxs("div",{className:"font-bold text-red-600",children:["-",n.money(e.price)]})]}),s.jsx("input",{type:"text",value:e.description||"",onChange:e=>((e,s)=>{const a=[...R];a[e].description=s,V(a)})(a,e.target.value),placeholder:"Add description...",className:"w-full mt-2 px-3 py-1 text-sm border border-gray-300 rounded"})]}),s.jsx("button",{onClick:()=>(e=>{V(R.filter((s,a)=>a!==e))})(a),className:"p-1 text-red-600 hover:bg-red-100 rounded",children:s.jsx(h,{className:"w-4 h-4"})})]},a))}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select damaged parts (optional - skip if no damage)"}),s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50",children:_.map(e=>s.jsxs("button",{onClick:()=>(e=>{const s={spare_part_id:e.id,spare_part_name:e.name,price:e.selling_price,description:""};V([...R,s])})(e),className:"p-3 border border-gray-200 rounded hover:border-blue-500 hover:bg-blue-50 transition-all text-left text-sm",children:[s.jsx("div",{className:"font-medium text-gray-900 truncate",children:e.name}),s.jsx("div",{className:"text-xs text-gray-600",children:n.money(e.selling_price)})]},e.id))})]}),z&&s.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-gray-600",children:"Base Price:"}),s.jsx("span",{className:"font-medium",children:n.money(z.base_price)})]}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-gray-600",children:"Condition Adjustment:"}),s.jsx("span",{className:"font-medium",children:n.money(z.condition_adjusted_price)})]}),s.jsxs("div",{className:"flex justify-between text-sm text-red-600",children:[s.jsx("span",{children:"Damage Deductions:"}),s.jsxs("span",{className:"font-medium",children:["-",n.money(z.total_damage_deductions)]})]}),s.jsxs("div",{className:"flex justify-between text-lg font-bold text-gray-900 pt-2 border-t border-blue-200",children:[s.jsx("span",{children:"Final Trade-In Value:"}),s.jsx("span",{children:n.money(z.final_trade_in_value)})]})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>f("assess-condition"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Back"}),s.jsx("button",{onClick:()=>f("review"),className:"flex-1 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:R.length>0?"Continue to Review":"Continue (No Damage)"})]})]}),"review"===j&&z&&S?s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"text-center",children:[s.jsx(u,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),s.jsx("h3",{className:"text-2xl font-bold text-gray-900",children:"Trade-In Summary"})]}),s.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg space-y-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-600",children:"Device"}),s.jsxs("div",{className:"font-semibold text-gray-900",children:[S.device_name," - ",S.device_model]}),s.jsxs("div",{className:"text-sm text-gray-600",children:["IMEI: ",E]})]}),s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-600",children:"Condition"}),s.jsx("div",{className:"font-medium text-gray-900 capitalize",children:A}),M&&s.jsx("div",{className:"text-sm text-gray-600 mt-1",children:M})]}),R.length>0&&s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"Damage/Issues"}),s.jsx("div",{className:"space-y-1",children:R.map((e,a)=>s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-gray-700",children:e.spare_part_name}),s.jsxs("span",{className:"text-red-600",children:["-",n.money(e.price)]})]},a))})]})]}),s.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg space-y-3",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-gray-700",children:"Base Trade-In Price:"}),s.jsx("span",{className:"font-medium",children:n.money(z.base_price)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("span",{className:"text-gray-700",children:["Condition Adjustment (",(100*z.condition_multiplier).toFixed(0),"%):"]}),s.jsx("span",{className:"font-medium",children:n.money(z.condition_adjusted_price)})]}),z.total_damage_deductions>0&&s.jsxs("div",{className:"flex justify-between text-red-600",children:[s.jsx("span",{children:"Total Deductions:"}),s.jsxs("span",{className:"font-medium",children:["-",n.money(z.total_damage_deductions)]})]}),s.jsxs("div",{className:"flex justify-between text-xl font-bold text-gray-900 pt-3 border-t-2 border-blue-200",children:[s.jsx("span",{children:"Final Trade-In Value:"}),s.jsx("span",{className:"text-green-600",children:n.money(z.final_trade_in_value)})]}),b>0&&s.jsx(s.Fragment,{children:s.jsxs("div",{className:"border-t-2 border-blue-200 pt-3 mt-3",children:[s.jsxs("div",{className:"flex justify-between text-gray-700",children:[s.jsx("span",{children:"New Device Price:"}),s.jsx("span",{className:"font-medium",children:n.money(b)})]}),s.jsxs("div",{className:"flex justify-between text-xl font-bold text-blue-600 mt-2",children:[s.jsx("span",{children:"Customer Pays:"}),s.jsx("span",{children:n.money(z.customer_payment_amount)})]})]})})]}),s.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs",children:[s.jsx("div",{className:"font-semibold mb-1",children:"Debug Info:"}),s.jsxs("div",{children:["Device: ",(null==S?void 0:S.device_name)||"N/A"]}),s.jsxs("div",{children:["IMEI: ",E||"⚠️ Not set"]}),s.jsxs("div",{children:["Calculation: ",z?"✅":"❌"]}),s.jsxs("div",{children:["Final Value: ",(null==z?void 0:z.final_trade_in_value)?n.money(z.final_trade_in_value):"N/A"]})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{type:"button",onClick:()=>{f("damage-assessment")},className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer",children:"Back"}),s.jsx("button",{type:"button",onClick:e=>{e.preventDefault(),e.stopPropagation(),(async()=>{S&&z?E?v({final_trade_in_value:z.final_trade_in_value,customer_payment_amount:z.customer_payment_amount,trade_in_details:{device_name:S.device_name,device_model:S.device_model,device_imei:E,base_price:S.base_trade_in_price,condition_rating:A,condition_multiplier:z.condition_multiplier,damage_items:R,total_deductions:z.total_damage_deductions,condition_description:M}}):d.error("Please enter device IMEI"):d.error("Please complete all steps")})()},className:"flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 active:bg-green-800 font-semibold transition-colors shadow-md hover:shadow-lg",children:"Complete Trade-In"})]})]}):"review"===j?s.jsxs("div",{className:"p-6 bg-yellow-50 border border-yellow-200 rounded-lg",children:[s.jsx("p",{className:"text-yellow-800 font-medium",children:"⚠️ Review Step Debug Info:"}),s.jsxs("ul",{className:"mt-2 text-sm text-yellow-700 space-y-1",children:[s.jsxs("li",{children:["Step: ",j]}),s.jsxs("li",{children:["Has Calculation: ",z?"✅ Yes":"❌ No"]}),s.jsxs("li",{children:["Has Selected Price: ",S?"✅ Yes":"❌ No"]}),s.jsxs("li",{children:["Device IMEI: ",E||"❌ Not set"]})]})]}):null]})})]})})};export{g as TradeInCalculator,g as default};
