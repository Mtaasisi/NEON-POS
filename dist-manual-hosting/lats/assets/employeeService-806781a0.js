import{s as e}from"./index-222cfb29.js";import{n as t}from"./ui-551a39a6.js";const a=e=>Array.isArray(e)?e.map(a):null!==e&&e.constructor===Object?Object.keys(e).reduce((t,r)=>(t[r.replace(/_([a-z])/g,(e,t)=>t.toUpperCase())]=a(e[r]),t),{}):e,r=e=>Array.isArray(e)?e.map(r):null!==e&&e.constructor===Object?Object.keys(e).reduce((t,a)=>(t[a.replace(/[A-Z]/g,e=>`_${e.toLowerCase()}`)]=r(e[a]),t),{}):e;const o=new class{async getAllEmployees(){var r;try{const{data:t,error:o}=await e.from("employees").select("*").order("created_at",{ascending:!1});if(o)throw o;if(!t||0===t.length)return[];const n=[...new Set(t.map(e=>e.branch_id).filter(Boolean))],c=n.length>0?await e.from("store_locations").select("id, name, code, is_main").in("id",n):{data:[],error:null},s=new Map((null==(r=c.data)?void 0:r.map(e=>[e.id,e]))||[]);return a(t.map(e=>({...e,branch:e.branch_id?s.get(e.branch_id):null})))}catch(o){throw t.error("Failed to load employees"),o}}async getEmployeeById(r){try{const{data:t,error:o}=await e.from("employees").select("*").eq("id",r).single();if(o)throw o;if(!t)return null;let n=null;if(t.branch_id){const{data:a}=await e.from("store_locations").select("id, name, code, is_main").eq("id",t.branch_id).single();n=a}return a({...t,branch:n})}catch(o){throw t.error("Failed to load employee details"),o}}async getEmployeeByUserId(t){try{const{data:r,error:o}=await e.from("employees").select("*").eq("user_id",t).maybeSingle();if(o)throw o;return r?a(r):null}catch(r){throw r}}async getActiveEmployees(){var t;try{const{data:r,error:o}=await e.from("employees").select("*").eq("status","active").order("full_name",{ascending:!0});if(o)throw o;if(!r||0===r.length)return[];const n=[...new Set(r.map(e=>e.branch_id).filter(Boolean))],c=n.length>0?await e.from("store_locations").select("id, name, code, is_main").in("id",n):{data:[],error:null},s=new Map((null==(t=c.data)?void 0:t.map(e=>[e.id,e]))||[]);return a(r.map(e=>({...e,branch:e.branch_id?s.get(e.branch_id):null})))}catch(r){throw r}}cleanEmployeeData(e){const t={...e};return Array.isArray(t.skills)&&0===t.skills.length&&(t.skills=null),Array.isArray(t.assigned_branches)&&0===t.assigned_branches.length&&(t.assigned_branches=null),t}async createEmployee(o){try{const n=this.cleanEmployeeData(r(o)),{data:c,error:s}=await e.from("employees").insert([n]).select().single();if(s)throw s;return t.success("Employee created successfully"),a(c)}catch(n){throw t.error(n.message||"Failed to create employee"),n}}async updateEmployee(o,n){try{const c=this.cleanEmployeeData(r(n)),{data:s,error:l}=await e.from("employees").update(c).eq("id",o).select().single();if(l)throw l;return t.success("Employee updated successfully"),a(s)}catch(c){throw t.error(c.message||"Failed to update employee"),c}}async deleteEmployee(a){try{const{error:r}=await e.from("employees").delete().eq("id",a);if(r)throw r;t.success("Employee deleted successfully")}catch(r){throw t.error(r.message||"Failed to delete employee"),r}}async searchEmployees(t){try{const{data:r,error:o}=await e.from("employees").select("*").or(`full_name.ilike.%${t}%,email.ilike.%${t}%,role.ilike.%${t}%`).order("full_name",{ascending:!0});if(o)throw o;return a(r||[])}catch(r){throw r}}async getEmployeesByDepartment(t){var r;try{const{data:o,error:n}=await e.from("employees").select("*").eq("role",t).order("full_name",{ascending:!0});if(n)throw n;if(!o||0===o.length)return[];const c=[...new Set(o.map(e=>e.branch_id).filter(Boolean))],s=c.length>0?await e.from("store_locations").select("id, name, code, is_main").in("id",c):{data:[],error:null},l=new Map((null==(r=s.data)?void 0:r.map(e=>[e.id,e]))||[]);return a(o.map(e=>({...e,branch:e.branch_id?l.get(e.branch_id):null})))}catch(o){throw o}}async getEmployeesByBranch(t){try{const{data:r,error:o}=await e.from("employees").select("*").eq("branch_id",t).order("full_name",{ascending:!0});if(o)throw o;if(!r||0===r.length)return[];const{data:n}=await e.from("store_locations").select("id, name, code, is_main").eq("id",t).single();return a(r.map(e=>({...e,branch:n})))}catch(r){throw r}}async assignEmployeeToBranch(r,o){try{const{data:n,error:c}=await e.from("employees").update({branch_id:o}).eq("id",r).select("*").single();if(c)throw c;const{data:s}=await e.from("store_locations").select("id, name, code, is_main").eq("id",o).single();return t.success("Employee assigned to branch successfully"),a({...n,branch:s})}catch(n){throw t.error(n.message||"Failed to assign employee to branch"),n}}async removeEmployeeFromBranch(r){try{const{data:o,error:n}=await e.from("employees").update({branch_id:null}).eq("id",r).select("*").single();if(n)throw n;return t.success("Employee removed from branch"),a({...o,branch:null})}catch(o){throw t.error(o.message||"Failed to remove employee from branch"),o}}async getAllAttendanceRecords(){try{const{data:t,error:r}=await e.from("attendance_records").select("*").order("attendance_date",{ascending:!1});if(r)throw r;return a(t||[])}catch(r){throw t.error("Failed to load attendance records"),r}}async getAttendanceByEmployeeId(t,r){try{let o=e.from("attendance_records").select("*").eq("employee_id",t).order("attendance_date",{ascending:!1});r&&(o=o.limit(r));const{data:n,error:c}=await o;if(c)throw c;return a(n||[])}catch(o){throw o}}async getTodayAttendance(t){try{const r=(new Date).toISOString().split("T")[0],{data:o,error:n}=await e.from("attendance_records").select("*").eq("employee_id",t).eq("attendance_date",r).maybeSingle();if(n)throw n;return o?a(o):null}catch(r){throw r}}async checkIn(r,o,n,c){try{const s=(new Date).toISOString().split("T")[0],l=(new Date).toISOString(),i=await this.getTodayAttendance(r);if(i&&i.checkInTime)throw t.error("Already checked in today"),new Error("Already checked in today");const d={employee_id:r,attendance_date:s,check_in_time:l,status:"present"};void 0!==(null==o?void 0:o.lat)&&(d.check_in_location_lat=o.lat),void 0!==(null==o?void 0:o.lng)&&(d.check_in_location_lng=o.lng),void 0!==n&&(d.check_in_network_ssid=n),void 0!==c&&(d.check_in_photo_url=c);const{data:m,error:h}=await e.from("attendance_records").upsert(d).select().single();if(h)throw h;return t.success("Checked in successfully"),a(m)}catch(s){throw t.error(s.message||"Failed to check in"),s}}async checkOut(r,o,n,c){try{const s=(new Date).toISOString(),l=await this.getTodayAttendance(r);if(!l||!l.checkInTime)throw t.error("Not checked in yet"),new Error("Not checked in yet");if(l.checkOutTime)throw t.error("Already checked out today"),new Error("Already checked out today");const i={check_out_time:s};void 0!==(null==o?void 0:o.lat)&&(i.check_out_location_lat=o.lat),void 0!==(null==o?void 0:o.lng)&&(i.check_out_location_lng=o.lng),void 0!==n&&(i.check_out_network_ssid=n),void 0!==c&&(i.check_out_photo_url=c);const{data:d,error:m}=await e.from("attendance_records").update(i).eq("id",l.id).select().single();if(m)throw m;return t.success("Checked out successfully"),a(d)}catch(s){throw t.error(s.message||"Failed to check out"),s}}async markAttendance(o){try{const n=r(o),{data:c,error:s}=await e.from("attendance_records").upsert(n,{onConflict:"employee_id,attendance_date"}).select().single();if(s)throw s;return t.success("Attendance marked successfully"),a(c)}catch(n){throw t.error(n.message||"Failed to mark attendance"),n}}async deleteAttendanceRecord(a){try{const{error:r}=await e.from("attendance_records").delete().eq("id",a);if(r)throw r;t.success("Attendance record deleted")}catch(r){throw t.error(r.message||"Failed to delete attendance"),r}}async getAttendanceByDateRange(t,r){try{const{data:o,error:n}=await e.from("attendance_records").select("*").gte("attendance_date",t).lte("attendance_date",r).order("attendance_date",{ascending:!1});if(n)throw n;return a(o||[])}catch(o){throw o}}async getAllLeaveRequests(){try{const{data:t,error:r}=await e.from("leave_requests").select("*").order("created_at",{ascending:!1});if(r)throw r;return a(t||[])}catch(r){throw t.error("Failed to load leave requests"),r}}async getLeaveRequestsByEmployeeId(t){try{const{data:r,error:o}=await e.from("leave_requests").select("*").eq("employee_id",t).order("created_at",{ascending:!1});if(o)throw o;return a(r||[])}catch(r){throw r}}async createLeaveRequest(o){try{const n=r(o),{data:c,error:s}=await e.from("leave_requests").insert([n]).select().single();if(s)throw s;return t.success("Leave request submitted"),a(c)}catch(n){throw t.error(n.message||"Failed to submit leave request"),n}}async updateLeaveRequestStatus(r,o,n){try{const{data:c,error:s}=await e.from("leave_requests").update({status:o,review_notes:n,reviewed_at:(new Date).toISOString()}).eq("id",r).select().single();if(s)throw s;return t.success(`Leave request ${o}`),a(c)}catch(c){throw t.error(c.message||"Failed to update leave request"),c}}async getEmployeeStats(){try{const{data:t,error:a}=await e.from("employees").select("status, performance_rating");if(a)throw a;const r=(new Date).toISOString().split("T")[0],{data:o,error:n}=await e.from("attendance_records").select("status").eq("attendance_date",r);if(n)throw n;return{totalEmployees:(null==t?void 0:t.length)||0,activeEmployees:(null==t?void 0:t.filter(e=>"active"===e.status).length)||0,onLeaveEmployees:(null==t?void 0:t.filter(e=>"on-leave"===e.status).length)||0,inactiveEmployees:(null==t?void 0:t.filter(e=>"inactive"===e.status).length)||0,averagePerformanceRating:(null==t?void 0:t.length)?t.reduce((e,t)=>e+(t.performance_rating||0),0)/t.length:0,averageAttendanceRate:0,presentToday:(null==o?void 0:o.filter(e=>"present"===e.status).length)||0,absentToday:(null==o?void 0:o.filter(e=>"absent"===e.status).length)||0,lateToday:(null==o?void 0:o.filter(e=>"late"===e.status).length)||0}}catch(t){throw t}}async getTodaysAttendanceSummary(){try{const{data:t,error:r}=await e.from("todays_attendance").select("*");if(r)throw r;return a(t||[])}catch(t){throw t}}async getEmployeeAttendanceSummary(){try{const{data:t,error:r}=await e.from("employee_attendance_summary").select("*");if(r)throw r;return a(t||[])}catch(t){throw t}}exportEmployeesToCSV(e){const t=e.map(e=>[e.id,e.firstName,e.lastName,e.email,e.phone||"",e.position,e.department,e.status,e.hireDate,e.salary,e.performanceRating]);return[["ID","First Name","Last Name","Email","Phone","Position","Department","Status","Hire Date","Salary","Performance Rating"].join(","),...t.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n")}exportAttendanceToCSV(e){const t=e.map(e=>[e.id,e.employeeId,e.attendanceDate,e.checkInTime||"",e.checkOutTime||"",e.totalHours,e.overtimeHours,e.status,e.notes||""]);return[["ID","Employee ID","Date","Check In","Check Out","Total Hours","Overtime Hours","Status","Notes"].join(","),...t.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n")}downloadCSV(e,a){const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),n=URL.createObjectURL(r);o.setAttribute("href",n),o.setAttribute("download",a),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),t.success(`${a} downloaded successfully`)}};export{o as e};
