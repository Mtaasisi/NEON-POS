import{s as e,j as s}from"./index-222cfb29.js";import{r as t}from"./vendor-a2ff445a.js";import{n as a}from"./ui-551a39a6.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";const r=e=>{const s=e.length,t=/[^\x00-\x7F]/.test(e),a=t?70:160;return{charCount:s,smsUnits:Math.ceil(s/a),charsPerSMS:a,encoding:t?"Unicode":"GSM-7"}},l=()=>{const[l,n]=t.useState([]),[i,d]=t.useState(!0),[c,o]=t.useState(""),[x,m]=t.useState("all"),[g,h]=t.useState(null),[u,p]=t.useState(null),[j,b]=t.useState(()=>{const e=localStorage.getItem("sms_price_per_unit");return e?parseFloat(e):50}),[N,y]=t.useState(!1),f=t.useRef(!0);t.useEffect(()=>(f.current=!0,v(),()=>{f.current=!1}),[]);const v=async()=>{var s;try{d(!0),p(null);const{data:s,error:t}=await e.from("sms_logs").select("*").order("created_at",{ascending:!1}),{data:r,error:l}=await e.from("customer_communications").select("*").eq("type","sms").order("created_at",{ascending:!1});if(t&&l)return p("Unable to fetch SMS logs. Please contact your administrator."),void a.error("Failed to fetch SMS logs");const i=[];if(s){const e=s.map(e=>({id:e.id,recipient_phone:e.recipient_phone,message:e.message,status:e.status,error_message:e.error_message,sent_at:e.sent_at,sent_by:e.sent_by,created_at:e.created_at,device_id:e.device_id,cost:e.cost}));i.push(...e)}if(r){const e=r.map(e=>({id:e.id,recipient_phone:e.phone_number||"N/A",message:e.message,status:e.status,error_message:void 0,sent_at:e.sent_at,sent_by:e.sent_by,created_at:e.created_at,device_id:void 0,cost:void 0}));i.push(...e)}i.sort((e,s)=>{const t=new Date(e.created_at).getTime();return new Date(s.created_at).getTime()-t});const c=i.filter(e=>e&&"string"==typeof e.id&&"string"==typeof e.recipient_phone&&"string"==typeof e.message&&"string"==typeof e.status);f.current&&n(c)}catch(t){if(!f.current)return;if((null==t?void 0:t.error)&&void 0!==(null==t?void 0:t.data)){const e=t.error;"PGRST116"===e.code||(null==(s=e.message)?void 0:s.includes("does not exist"))?p("SMS logs database not configured. Please contact your administrator."):p(`Database error: ${e.message||"Unknown database error"}`)}else p("Unable to load SMS logs. Please try again later.")}finally{f.current&&d(!1)}},w=l.filter(e=>{if(!e||!e.recipient_phone||!e.message)return!1;const s=(e.recipient_phone||"").includes(c)||e.message.toLowerCase().includes(c.toLowerCase()),t="all"===x||e.status===x;return s&&t}),S=e=>{switch(e){case"sent":return"âœ…";case"delivered":return"ðŸ“¨";case"failed":return"âŒ";case"pending":return"â³";default:return"â“"}},_=e=>{switch(e){case"sent":return"text-green-600 bg-green-100";case"delivered":return"text-blue-600 bg-blue-100";case"failed":return"text-red-600 bg-red-100";case"pending":return"text-yellow-600 bg-yellow-100";default:return"text-gray-600 bg-gray-100"}},k=e=>new Date(e).toLocaleString("en-TZ",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),M=(()=>{const e=l.length,s=l.filter(e=>e&&"sent"===e.status).length,t=l.filter(e=>e&&"delivered"===e.status).length,a=l.filter(e=>e&&"failed"===e.status).length,n=l.filter(e=>e&&"pending"===e.status).length;let i=0,d=0;return l.forEach(e=>{if(!e||!e.message)return;const s=r(e.message);d+=s.smsUnits,i+=s.smsUnits*j}),{total:e,sent:s,delivered:t,failed:a,pending:n,totalCost:i,totalSMSUnits:d}})();return i?s.jsx("div",{className:"min-h-screen p-6",children:s.jsx("div",{className:"max-w-6xl mx-auto",children:s.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8",children:s.jsxs("div",{className:"animate-pulse",children:[s.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-6"}),s.jsx("div",{className:"space-y-4",children:[...Array(5)].map((e,t)=>s.jsx("div",{className:"h-16 bg-gray-200 rounded"},t))})]})})})}):u?s.jsx("div",{className:"min-h-screen p-6",children:s.jsx("div",{className:"max-w-6xl mx-auto",children:s.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),s.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Error Loading SMS Logs"}),s.jsx("p",{className:"text-gray-600 mb-4",children:u}),s.jsx("button",{onClick:v,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Try Again"})]})})})}):s.jsx("div",{className:"min-h-screen p-6",children:s.jsxs("div",{className:"max-w-6xl mx-auto",children:[s.jsxs("div",{className:"mb-8",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"SMS Logs"}),s.jsx("p",{className:"text-gray-600",children:"View and monitor all SMS activity"})]}),s.jsx("div",{className:"bg-white rounded-lg shadow-lg p-4 mb-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Price per SMS Unit:"}),N?s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"number",min:"0",step:"1",value:j,onChange:e=>b(parseFloat(e.target.value)||0),className:"w-24 px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",autoFocus:!0}),s.jsx("span",{className:"text-sm text-gray-600",children:"TZS"}),s.jsx("button",{onClick:()=>{var e;b(e=j),localStorage.setItem("sms_price_per_unit",e.toString()),a.success(`Price per SMS updated to ${e} TZS`),y(!1)},className:"px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm",children:"Save"}),s.jsx("button",{onClick:()=>{b(parseFloat(localStorage.getItem("sms_price_per_unit")||"50")),y(!1)},className:"px-3 py-1 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm",children:"Cancel"})]}):s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-lg font-bold text-blue-600",children:[j," TZS"]}),s.jsx("button",{onClick:()=>y(!0),className:"text-blue-600 hover:text-blue-800 text-sm",children:"âœï¸ Edit"})]})]}),s.jsx("div",{className:"text-sm text-gray-500",children:"ðŸ’¡ This price is used to calculate the cost for each SMS based on message length"})]})}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-900",children:M.total}),s.jsx("div",{className:"text-sm text-gray-600",children:"Total SMS"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-green-600",children:M.sent}),s.jsx("div",{className:"text-sm text-gray-600",children:"Sent"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:M.delivered}),s.jsx("div",{className:"text-sm text-gray-600",children:"Delivered"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-red-600",children:M.failed}),s.jsx("div",{className:"text-sm text-gray-600",children:"Failed"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:M.pending}),s.jsx("div",{className:"text-sm text-gray-600",children:"Pending"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:M.totalSMSUnits}),s.jsx("div",{className:"text-sm text-gray-600",children:"SMS Units"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[s.jsx("div",{className:"text-2xl font-bold text-purple-600",children:(Number(M.totalCost)||0).toLocaleString()}),s.jsx("div",{className:"text-sm text-gray-600",children:"Total Cost (TZS)"})]})]}),s.jsx("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:s.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsx("input",{type:"text",placeholder:"Search by phone number or message...",value:c,onChange:e=>o(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})}),s.jsx("div",{children:s.jsxs("select",{value:x,onChange:e=>m(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[s.jsx("option",{value:"all",children:"All Status"}),s.jsx("option",{value:"sent",children:"Sent"}),s.jsx("option",{value:"delivered",children:"Delivered"}),s.jsx("option",{value:"failed",children:"Failed"}),s.jsx("option",{value:"pending",children:"Pending"})]})}),s.jsx("button",{onClick:v,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Refresh"})]})}),s.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:[s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone Number"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Message"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Chars / Units"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Sent At"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cost"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:w.map(e=>{if(!e||!e.id)return null;const t=r(e.message||""),a=t.smsUnits*j;return s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${_(e.status||"unknown")}`,children:[S(e.status||"unknown")," ",e.status||"unknown"]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.recipient_phone||"N/A"}),s.jsx("td",{className:"px-6 py-4 text-sm text-gray-900 max-w-xs truncate",children:e.message||"N/A"}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("span",{className:"font-medium",children:[t.charCount," chars"]}),s.jsxs("span",{className:"text-xs text-gray-500",children:[t.smsUnits," unit",t.smsUnits>1?"s":""]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.sent_at?k(e.sent_at):e.created_at?k(e.created_at):"N/A"}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("span",{className:"font-medium",children:[a," TZS"]}),s.jsx("span",{className:"text-xs text-gray-500",children:t.encoding})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:s.jsx("button",{onClick:()=>h(e),className:"text-blue-600 hover:text-blue-900",children:"View Details"})})]},e.id)})})]})}),0===w.length&&s.jsxs("div",{className:"text-center py-12",children:[s.jsx("div",{className:"text-gray-500 text-lg",children:"No SMS logs found"}),s.jsx("div",{className:"text-gray-400 text-sm mt-2",children:c||"all"!==x?"Try adjusting your search filters":"SMS logs will appear here when you send messages"}),!c&&"all"===x&&s.jsx("div",{className:"mt-4",children:s.jsx("button",{onClick:async()=>{try{const{data:s,error:t}=await e.from("sms_logs").insert({recipient_phone:"255700000000",message:"Test SMS from SMS logs page - "+(new Date).toLocaleTimeString(),status:"sent",sent_at:(new Date).toISOString(),created_at:(new Date).toISOString()}).select().single();t?a.error("Failed to create test log"):(a.success("Test SMS log created!"),v())}catch(s){a.error("Failed to create test log")}},className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:"Create Test SMS Log"})})]})]}),g&&(()=>{const e=r(g.message||""),t=e.smsUnits*j;return s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:s.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"SMS Details"}),s.jsx("button",{onClick:()=>h(null),className:"text-gray-400 hover:text-gray-600",children:s.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Status"}),s.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${_(g.status||"unknown")}`,children:[S(g.status||"unknown")," ",g.status||"unknown"]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Phone Number"}),s.jsx("p",{className:"text-sm text-gray-900",children:g.recipient_phone||"N/A"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Message"}),s.jsx("div",{className:"bg-gray-50 rounded-lg p-3 text-sm text-gray-900 whitespace-pre-wrap",children:g.message||"N/A"})]}),s.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“Š SMS Analytics"}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Character Count"}),s.jsx("p",{className:"text-lg font-bold text-gray-900",children:e.charCount})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"SMS Units"}),s.jsx("p",{className:"text-lg font-bold text-gray-900",children:e.smsUnits})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Encoding"}),s.jsx("p",{className:"text-sm font-medium text-gray-900",children:e.encoding})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-gray-600",children:"Chars per SMS"}),s.jsx("p",{className:"text-sm font-medium text-gray-900",children:e.charsPerSMS})]})]})]}),s.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-2",children:"ðŸ’° Cost Calculation"}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-gray-600",children:"Price per SMS Unit:"}),s.jsxs("span",{className:"font-medium text-gray-900",children:[j," TZS"]})]}),s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-gray-600",children:"SMS Units Used:"}),s.jsx("span",{className:"font-medium text-gray-900",children:e.smsUnits})]}),s.jsxs("div",{className:"border-t border-green-300 pt-2 flex justify-between",children:[s.jsx("span",{className:"font-semibold text-gray-900",children:"Total Cost:"}),s.jsxs("span",{className:"text-lg font-bold text-green-700",children:[t," TZS"]})]})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Created At"}),s.jsx("p",{className:"text-sm text-gray-900",children:g.created_at?k(g.created_at):"N/A"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Sent At"}),s.jsx("p",{className:"text-sm text-gray-900",children:g.sent_at?k(g.sent_at):"Not sent"})]})]}),g.sent_by&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Sent By"}),s.jsx("p",{className:"text-sm text-gray-900",children:g.sent_by})]}),g.device_id&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Device ID"}),s.jsx("p",{className:"text-sm text-gray-900",children:g.device_id})]}),g.error_message&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Error Message"}),s.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-800",children:g.error_message})]})]})]})})})})()]})})};export{l as default};
