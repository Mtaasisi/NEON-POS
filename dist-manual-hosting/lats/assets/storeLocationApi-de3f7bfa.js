import{s as e}from"./index-222cfb29.js";const t=new class{constructor(){this.tableName="lats_store_locations"}async getAll(t){let a=e.from(this.tableName).select("*").order("priority_order",{ascending:!0}).order("name",{ascending:!0});t&&(t.search&&(a=a.or(`name.ilike.%${t.search}%,code.ilike.%${t.search}%,city.ilike.%${t.search}%`)),t.city&&(a=a.eq("city",t.city)),t.region&&(a=a.eq("region",t.region)),void 0!==t.is_active&&(a=a.eq("is_active",t.is_active)),void 0!==t.is_main_branch&&(a=a.eq("is_main_branch",t.is_main_branch)),void 0!==t.has_repair_service&&(a=a.eq("has_repair_service",t.has_repair_service)),void 0!==t.has_sales_service&&(a=a.eq("has_sales_service",t.has_sales_service)),void 0!==t.has_delivery_service&&(a=a.eq("has_delivery_service",t.has_delivery_service)));const{data:r,error:i}=await a;if(i)throw new Error(`Failed to fetch store locations: ${i.message}`);return r||[]}async getById(t){const{data:a,error:r}=await e.from(this.tableName).select("*").eq("id",t).single();if(r){if("PGRST116"===r.code)return null;throw new Error(`Failed to fetch store location: ${r.message}`)}return a}async getByCode(t){const{data:a,error:r}=await e.from(this.tableName).select("*").eq("code",t).single();if(r){if("PGRST116"===r.code)return null;throw new Error(`Failed to fetch store location: ${r.message}`)}return a}async create(t){if(await this.getByCode(t.code))throw new Error(`Store location with code '${t.code}' already exists`);t.is_main_branch&&await e.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0);const{data:a,error:r}=await e.from(this.tableName).insert([t]).select().single();if(r)throw new Error(`Failed to create store location: ${r.message}`);return a}async update(t,a){if(a.code){const e=await this.getByCode(a.code);if(e&&e.id!==t)throw new Error(`Store location with code '${a.code}' already exists`)}a.is_main_branch&&await e.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0).neq("id",t);const{data:r,error:i}=await e.from(this.tableName).update(a).eq("id",t).select().single();if(i)throw new Error(`Failed to update store location: ${i.message}`);return r}async delete(t){const a=await this.getById(t);if(null==a?void 0:a.is_main_branch){if((await this.getAll({is_main_branch:!0})).length<=1)throw new Error("Cannot delete the only main branch. Please set another location as main branch first.")}const{error:r}=await e.from(this.tableName).delete().eq("id",t);if(r)throw new Error(`Failed to delete store location: ${r.message}`)}async getStats(){const{data:t,error:a}=await e.from(this.tableName).select("is_active, is_main_branch, current_staff_count, monthly_target, store_size_sqm");if(a)throw new Error(`Failed to fetch store location stats: ${a.message}`);const r=t||[];return{total_locations:r.length,active_locations:r.filter(e=>e.is_active).length,main_branches:r.filter(e=>e.is_main_branch).length,total_staff:r.reduce((e,t)=>e+(t.current_staff_count||0),0),total_monthly_target:r.reduce((e,t)=>e+(t.monthly_target||0),0),average_store_size:r.length>0?r.reduce((e,t)=>e+(t.store_size_sqm||0),0)/r.length:0}}async getCities(){const{data:t,error:a}=await e.from(this.tableName).select("city").not("city","is",null);if(a)throw new Error(`Failed to fetch cities: ${a.message}`);return[...new Set((null==t?void 0:t.map(e=>e.city))||[])].sort()}async getRegions(){const{data:t,error:a}=await e.from(this.tableName).select("region").not("region","is",null);if(a)throw new Error(`Failed to fetch regions: ${a.message}`);return[...new Set((null==t?void 0:t.map(e=>e.region))||[])].sort()}async toggleActive(e){const t=await this.getById(e);if(!t)throw new Error("Store location not found");return this.update(e,{is_active:!t.is_active})}async setMainBranch(t){return await e.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0),this.update(t,{is_main_branch:!0})}};export{t as s};
