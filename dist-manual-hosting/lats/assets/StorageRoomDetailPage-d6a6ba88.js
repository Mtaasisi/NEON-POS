import{j as e,G as s,s as t}from"./index-222cfb29.js";import{r}from"./vendor-a2ff445a.js";import{i as a,ay as l,aj as o,cs as n,Q as d,y as c,n as i,c as m,$ as x,ao as h,b as u}from"./ui-551a39a6.js";import{s as p}from"./storeLocationApi-de3f7bfa.js";import{d as j,a as v}from"./routing-a2f0f6d2.js";import"./supabase-7e851d02.js";const g="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),f=e=>Math.max(1,g.indexOf((e||"A").toUpperCase())+1),w=(e,s,t)=>`${e}${(s||"A").toUpperCase()}${t}`,b=(e,s)=>{if(e.row_number&&e.column_number)return{rowLetter:(t=e.row_number,g[(t-1)%26]||String(t)),col:e.column_number};var t;const r=e.code||"",a=(s||"").toUpperCase(),l=r.toUpperCase().startsWith(a)?r.slice(a.length):r;return{rowLetter:l.slice(0,1)||"A",col:Number(l.slice(1))||e.column_number||1}},N=(e,s)=>{if(!s.length)return i.error("Hakuna data ya ku-export");const t=Object.keys(s[0]),r=[t.join(","),...s.map(e=>t.map(s=>(e=>{if(null==e)return"";const s=String(e);return s.includes(",")||s.includes('"')||s.includes("\n")?`"${s.replace(/"/g,'""')}"`:s})(e[s])).join(","))].join("\n"),a=new Blob([r],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(a),o=document.createElement("a");o.href=l,o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l),i.success("CSV imetengenezwa")},y=()=>{const{id:g}=j(),y=v(),[_,C]=r.useState(null),[S,k]=r.useState(null),[L,A]=r.useState([]),[R,E]=r.useState(!0),[M,$]=r.useState(""),[q,U]=r.useState(""),[X,z]=r.useState(!1),[G,D]=r.useState({row_letter:"A",column_number:1}),[I,O]=r.useState([]),[T,B]=r.useState(!1),[F,P]=r.useState(new Set);r.useEffect(()=>{(async()=>{if(g){E(!0);try{if(!t)throw new Error("Database connection not available");const{data:e,error:s}=await t.from("lats_store_rooms").select("*").eq("id",g).single();if(s)throw s;C(e);try{const s=await p.getById(e.store_location_id);k(s||null)}catch{if(t){const{data:s}=await t.from("lats_store_locations").select("*").eq("id",e.store_location_id).maybeSingle();k(s||null)}}const{data:r,error:a}=await t.from("lats_store_shelves").select("*").eq("storage_room_id",g).order("priority_order",{ascending:!0}).order("row_number",{ascending:!0}).order("column_number",{ascending:!0});if(a)throw a;A(r||[])}catch(e){i.error("Failed to load room details")}finally{E(!1)}}else i.error("Missing room id")})()},[g]);const H=r.useMemo(()=>{const e=new Set;return L.forEach(s=>{const{rowLetter:t}=b(s,null==_?void 0:_.code);e.add(t)}),Array.from(e).sort((e,s)=>f(e)-f(s))},[L,null==_?void 0:_.code]),V=r.useMemo(()=>{let e=L;if(q&&(e=e.filter(e=>b(e,null==_?void 0:_.code).rowLetter===q)),M.trim()){const s=M.trim().toLowerCase();e=e.filter(e=>e.code.toLowerCase().includes(s)||(e.name||"").toLowerCase().includes(s))}return[...e].sort((e,s)=>{const t=b(e,null==_?void 0:_.code),r=b(s,null==_?void 0:_.code);return t.rowLetter===r.rowLetter?(t.col||0)-(r.col||0):f(t.rowLetter)-f(r.rowLetter)})},[L,q,M,null==_?void 0:_.code]),W=r.useMemo(()=>{if(!_)return[];const e=[],s=new Set;return L.forEach(t=>{if(s.has(t.id))return;const{rowLetter:r,col:a}=b(t,_.code);f(r);const l=L.filter(e=>b(e,_.code).rowLetter===r);if(l.length>0){const t=Math.max(...l.map(e=>b(e,_.code).col||0)),a=Math.min(...l.map(e=>b(e,_.code).col||0)),o=l.length>0?1:0,n=t-a+1,d=1,c=`${r}-${a}-${t}`;e.push({id:c,rows:o,columns:n,quantity:d,shelves:l,collapsed:F.has(c),startRow:r,endRow:r,startCol:a,endCol:t}),l.forEach(e=>s.add(e.id))}}),e.sort((e,s)=>f(e.startRow)-f(s.startRow))},[L,_,F]),Q=r.useMemo(()=>{const e=new Map;return L.forEach(s=>{const{rowLetter:t}=b(s,null==_?void 0:_.code);e.set(t,(e.get(t)||0)+1)}),Array.from(e.entries()).sort((e,s)=>f(e[0])-f(s[0])).map(([e,s])=>({row:e,count:s}))},[L,null==_?void 0:_.code]);return R?e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"animate-pulse text-gray-500",children:"Loading room details..."})}):_?e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(s,{onClick:()=>y(-1),variant:"secondary",children:[e.jsx(a,{className:"w-4 h-4 mr-2"})," Back"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"w-6 h-6 text-blue-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xl font-semibold text-gray-900",children:[_.name," ",e.jsx("span",{className:"text-gray-400",children:"•"})," ",_.code]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(null==S?void 0:S.name)||"—"," "," · "," Floor ",_.floor_level||1," "," · ",L.length," shelves"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(s,{onClick:()=>N(`shelves_${_.code}.csv`,L.map(e=>({id:e.id,shelf_code:e.code,shelf_name:e.name,row:b(e,_.code).rowLetter,column:b(e,_.code).col,floor_level:e.floor_level??"",type:e.shelf_type??"",is_active:e.is_active?"yes":"no"}))),variant:"secondary",children:[e.jsx(o,{className:"w-4 h-4 mr-2"}),"Export CSV"]}),e.jsxs(s,{onClick:()=>B(e=>!e),variant:"secondary",children:[e.jsx(n,{className:"w-4 h-4 mr-2"}),T?"Close Generator":"Generate Layout"]}),e.jsxs(s,{onClick:()=>z(e=>!e),className:"bg-blue-600 text-white",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),X?"Close Add":"Add Shelf"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Store Location"}),e.jsx("div",{className:"text-sm font-medium",children:(null==S?void 0:S.name)||"—"})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Floor Level"}),e.jsx("div",{className:"text-sm font-medium",children:_.floor_level||1})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Total Shelves"}),e.jsx("div",{className:"text-sm font-medium",children:L.length})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Shelf Groups"}),e.jsxs("div",{className:"text-sm font-medium",children:[W.length,e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",W.filter(e=>!e.collapsed).length," expanded)"]})]})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Total Positions"}),e.jsx("div",{className:"text-sm font-medium",children:W.reduce((e,s)=>e+s.rows*s.columns*s.quantity,0)})]})]}),T&&e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"Shelf Layout Generator"}),e.jsxs(s,{onClick:()=>O(e=>[...e,{row_letter:"A",columns:1}]),variant:"secondary",children:[e.jsx(d,{className:"w-4 h-4 mr-2"})," Add Row"]})]}),I.length?e.jsxs("div",{className:"space-y-2",children:[I.map((s,t)=>e.jsxs("div",{className:"p-3 rounded-lg border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Row ",s.row_letter," • ",s.columns," columns"]}),e.jsx("button",{onClick:()=>O(e=>e.filter((e,s)=>s!==t)),className:"text-xs text-red-600 hover:underline",children:"Remove"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Row Letter"}),e.jsx("input",{value:s.row_letter,maxLength:1,onChange:e=>{const s=e.target.value.toUpperCase().slice(0,1)||"A";O(e=>e.map((e,r)=>r===t?{...e,row_letter:s}:e))},className:"w-16 px-2 py-1 text-sm border rounded"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Columns"}),e.jsx("input",{type:"number",min:1,max:100,value:s.columns,onChange:e=>{const s=Math.max(1,Math.min(100,Number(e.target.value)||1));O(e=>e.map((e,r)=>r===t?{...e,columns:s}:e))},className:"w-24 px-2 py-1 text-sm border rounded"})]})]})]},t)),e.jsx("div",{children:e.jsxs(s,{onClick:async()=>{if(!_)return;if(!I.length)return i.error("Ongeza angalau row moja");const e=new Set(L.map(e=>e.code)),s=[];if(I.forEach(t=>{const r=(t.row_letter||"A").toUpperCase();for(let a=1;a<=Math.max(1,t.columns||1);a++){const t=w(_.code,r,a);e.has(t)||s.push({store_location_id:_.store_location_id,storage_room_id:_.id,name:`Shelf ${r}${a}`,code:t,shelf_type:"standard",row_number:f(r),column_number:a,floor_level:_.floor_level||1,is_active:!0,is_accessible:!0,requires_ladder:!1,is_refrigerated:!1,priority_order:100*(f(r)-1)+a})}}),!s.length)return i("Hakuna shelf mpya za kuunda (zipo tayari)",{icon:"ℹ️"});if(!t)throw new Error("Database connection not available");const{data:r,error:a}=await t.from("lats_store_shelves").insert(s).select("*");if(a)return i.error("Imeshindikana kutengeneza shelves");A(e=>[...e,...r]),B(!1),i.success(`Shelves ${s.length} zimeundwa`)},className:"bg-purple-600 text-white",children:[e.jsx(n,{className:"w-4 h-4 mr-2"}),"Generate Shelves"]})})]}):e.jsx("div",{className:"p-3 rounded-lg border text-sm text-gray-500 text-center",children:'No rows yet. Click "Add Row".'})]}),X&&e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-3",children:"Add Shelf"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Row Letter"}),e.jsx("input",{value:G.row_letter,maxLength:1,onChange:e=>D(s=>({...s,row_letter:e.target.value.toUpperCase().slice(0,1)||"A"})),className:"w-full px-3 py-2 border rounded-lg",placeholder:"A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Column Number"}),e.jsx("input",{type:"number",min:1,value:G.column_number,onChange:e=>D(s=>({...s,column_number:Math.max(1,parseInt(e.target.value)||1)})),className:"w-full px-3 py-2 border rounded-lg",placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Auto Code"}),e.jsx("input",{disabled:!0,className:"w-full px-3 py-2 border rounded-lg bg-gray-50",value:w(_.code,G.row_letter||"A",G.column_number||1)})]})]}),e.jsx("div",{className:"mt-3",children:e.jsxs(s,{onClick:async()=>{if(!_||!S)return;if(!G.row_letter||!G.column_number)return i.error("Weka row letter na column number");const e=w(_.code,G.row_letter,G.column_number);if(L.some(s=>s.code===e))return i.error("Shelf hii tayari ipo");const s={store_location_id:_.store_location_id,storage_room_id:_.id,name:`Shelf ${G.row_letter}${G.column_number}`,code:e,shelf_type:"standard",row_number:f(G.row_letter),column_number:G.column_number,floor_level:_.floor_level||1,is_active:!0,is_accessible:!0,requires_ladder:!1,is_refrigerated:!1,priority_order:100*(f(G.row_letter)-1)+G.column_number};if(!t)throw new Error("Database connection not available");const{data:r,error:a}=await t.from("lats_store_shelves").insert(s).select("*").single();a?i.error("Imeshindikana kuongeza shelf"):(A(e=>[...e,r]),z(!1),i.success("Shelf imeongezwa"))},className:"bg-green-600 text-white",children:[e.jsx(d,{className:"w-4 h-4 mr-2"}),"Save Shelf"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("div",{className:"relative w-full md:w-80",children:[e.jsx(c,{className:"w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{value:M,onChange:e=>$(e.target.value),placeholder:"Search code or name…",className:"w-full pl-9 pr-3 py-2 border rounded-lg"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto",children:[e.jsx("button",{onClick:()=>U(""),className:"px-3 py-1 rounded-lg border text-sm "+(q?"bg-white":"bg-gray-900 text-white border-gray-900"),children:"All Rows"}),H.map(s=>{var t;return e.jsxs("button",{onClick:()=>U(s),className:"px-3 py-1 rounded-lg border text-sm "+(q===s?"bg-blue-600 text-white border-blue-600":"bg-white"),children:["Row ",s," ",e.jsxs("span",{className:"ml-1 text-gray-500",children:["(",(null==(t=Q.find(e=>e.row===s))?void 0:t.count)||0,")"]})]},s)})]})]}),e.jsxs("div",{className:"rounded-xl border overflow-hidden bg-white",children:[e.jsx("div",{className:"px-4 py-3 border-b text-sm font-medium text-gray-700",children:"Shelves"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-left",children:[e.jsx("th",{className:"px-4 py-2",children:"Code"}),e.jsx("th",{className:"px-4 py-2",children:"Name"}),e.jsx("th",{className:"px-4 py-2",children:"Row"}),e.jsx("th",{className:"px-4 py-2",children:"Column"}),e.jsx("th",{className:"px-4 py-2",children:"Type"}),e.jsx("th",{className:"px-4 py-2",children:"Active"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Actions"})]})}),e.jsx("tbody",{children:V.length?V.map(s=>{const{rowLetter:r,col:a}=b(s,_.code);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-2 font-mono",children:s.code}),e.jsx("td",{className:"px-4 py-2",children:s.name}),e.jsx("td",{className:"px-4 py-2",children:r}),e.jsx("td",{className:"px-4 py-2",children:a}),e.jsx("td",{className:"px-4 py-2",children:s.shelf_type||"—"}),e.jsx("td",{className:"px-4 py-2",children:s.is_active?"Yes":"No"}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(s.code),i.success("Code copied")},className:"p-2 rounded-lg border hover:bg-gray-50",title:"Copy code",children:e.jsx(m,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>(async e=>{if(!confirm(`Futa shelf ${e.code}?`))return;if(!t)throw new Error("Database connection not available");const{error:s}=await t.from("lats_store_shelves").delete().eq("id",e.id);if(s)return i.error("Imeshindikana kufuta shelf");A(s=>s.filter(s=>s.id!==e.id)),i.success("Imefutwa")})(s),className:"p-2 rounded-lg border hover:bg-red-50 text-red-600 border-red-200",title:"Delete",children:e.jsx(x,{className:"w-4 h-4"})})]})})]},s.id)}):e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-gray-500",colSpan:7,children:"No shelves match your filter."})})})]})})]}),W.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Shelf Groups"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(s,{onClick:()=>P(new Set),variant:"secondary",size:"sm",className:"text-xs",children:"Expand All"}),e.jsx(s,{onClick:()=>P(new Set(W.map(e=>e.id))),variant:"secondary",size:"sm",className:"text-xs",children:"Collapse All"})]})]}),e.jsx("div",{className:"grid gap-4",children:W.map(s=>e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>{return e=s.id,void P(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t});var e},className:"p-1 hover:bg-gray-100 rounded transition-colors",children:s.collapsed?e.jsx(h,{className:"w-4 h-4 text-gray-500"}):e.jsx(u,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"font-medium",children:["Row ",s.startRow,": ",s.columns," columns × ",s.quantity," quantity",e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(",(null==_?void 0:_.code)||"XX",s.startRow,s.startCol," - ",(null==_?void 0:_.code)||"XX",s.endRow,s.endCol,")"]})]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.shelves.length," shelves"]})]}),s.collapsed&&e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-50 p-2 rounded flex items-center justify-between border-l-4 border-blue-200",children:[e.jsxs("span",{children:["Positions: ",(null==_?void 0:_.code)||"XX",s.startRow,s.startCol," to ",(null==_?void 0:_.code)||"XX",s.endRow,s.endCol]}),e.jsx("span",{className:"text-blue-500 font-medium",children:"Click to expand"})]}),!s.collapsed&&e.jsxs("div",{className:"space-y-3",children:[s.rows<=6&&s.columns<=8&&e.jsx("div",{className:"inline-block border rounded p-2 bg-gray-50",children:Array.from({length:s.rows},(t,r)=>e.jsx("div",{className:"flex gap-1 mb-1",children:Array.from({length:s.columns},(t,r)=>{const a=s.startCol+r,l=s.shelves.find(e=>b(e,null==_?void 0:_.code).col===a);return e.jsxs("div",{className:"w-8 h-6 border text-xs flex items-center justify-center "+(l?"bg-blue-50 border-blue-200 text-blue-700":"bg-white text-gray-400"),children:[(null==_?void 0:_.code)||"XX",s.startRow,a,s.quantity>1&&e.jsxs("span",{className:"text-[10px] text-blue-500",children:["×",s.quantity]})]},r)})},r))}),e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("div",{className:"font-medium mb-2",children:"Shelf Details:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:s.shelves.map(s=>e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-center",children:[e.jsx("div",{className:"font-mono text-xs",children:s.code}),e.jsx("div",{className:"text-[10px] text-gray-500",children:s.code})]},s.id))})]})]})]},s.id))})]}),H.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Row Preview"}),e.jsx("div",{className:"grid gap-4",children:H.map(s=>{const t=(e=>{let s=0;return L.forEach(t=>{const r=b(t,null==_?void 0:_.code);r.rowLetter===e&&(s=Math.max(s,r.col||0))}),s})(s),r=L.filter(e=>b(e,_.code).rowLetter===s).sort((e,s)=>(b(e,_.code).col||0)-(b(s,_.code).col||0));return e.jsxs("div",{className:"p-3 rounded-xl border bg-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"font-medium",children:["Row ",s," (",r.length," / ",t,")"]})}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:`repeat(${Math.max(1,t)}, minmax(0, 1fr))`},children:Array.from({length:t}).map((t,a)=>{const l=r.find(e=>(b(e,_.code).col||0)===a+1),o=l?l.code:w(_.code,s,a+1);return e.jsx("div",{className:"h-12 rounded-lg border flex items-center justify-center text-xs font-mono "+(l?"bg-blue-50 border-blue-200 text-blue-700":"bg-gray-50 text-gray-400"),title:l?"Existing shelf":"Empty slot",children:o},a)})})]},s)})})]})]}):e.jsxs("div",{className:"p-6",children:[e.jsxs(s,{onClick:()=>y(-1),variant:"secondary",children:[e.jsx(a,{className:"w-4 h-4 mr-2"})," Back"]}),e.jsx("div",{className:"mt-4 text-red-600",children:"Room not found."})]})};export{y as default};
