import{s as t}from"./index-222cfb29.js";import"./vendor-a2ff445a.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";import"./ui-551a39a6.js";const e=new class{constructor(){this.cache=new Map,this.CACHE_DURATION=6e4,this.MAX_RETRIES=3,this.RETRY_DELAY=1e3,this.fetchLock=new Map,this.connectionStatus="unknown",this.lastConnectionCheck=0,this.CONNECTION_CHECK_INTERVAL=3e4,this.globalFetchLock=!1,this.GLOBAL_FETCH_TIMEOUT=3e4,this.debounceTimers=new Map,this.DEBOUNCE_DELAY=1e3}clearCache(){this.cache.clear(),this.fetchLock.clear(),this.debounceTimers.forEach(t=>clearTimeout(t)),this.debounceTimers.clear()}async checkConnection(){var e;const a=Date.now();if(a-this.lastConnectionCheck<this.CONNECTION_CHECK_INTERVAL)return"connected"===this.connectionStatus;try{this.lastConnectionCheck=a;return(null==(e=(await t.auth.getUser()).data)?void 0:e.user)?(this.connectionStatus="connected",!0):(this.connectionStatus="disconnected",!1)}catch(n){return this.connectionStatus="connected",!0}}getCachedData(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<this.CACHE_DURATION?e.data:null}setCachedData(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}async retryOperation(t,e,a=this.MAX_RETRIES){var n,r;try{return await t()}catch(s){const o=(null==(n=null==s?void 0:s.message)?void 0:n.includes("ERR_CONNECTION_CLOSED"))||(null==(r=null==s?void 0:s.message)?void 0:r.includes("Failed to fetch"))||"PGRST301"===(null==s?void 0:s.code)||"PGRST116"===(null==s?void 0:s.code);if(a>1&&o){const n=this.RETRY_DELAY*(this.MAX_RETRIES-a+1);return await new Promise(t=>setTimeout(t,n)),this.retryOperation(t,e,a-1)}if(a>1)return await new Promise(t=>setTimeout(t,this.RETRY_DELAY)),this.retryOperation(t,e,a-1);if(o)return[];throw s}}async fetchSoldItems(e,a){try{if("pos_sale"===a){const{data:a,error:n}=await t.from("lats_sale_items").select("*").eq("sale_id",e);return n?[]:(null==a?void 0:a.map(t=>({id:t.id,name:t.product_name||"Unknown Product",sku:t.sku||"N/A",quantity:t.quantity||1,unitPrice:t.unit_price||0,totalPrice:t.total_price||0,category:t.category||"General",brand:t.brand||"Unknown",variant:t.variant_name||"Default",type:"product",description:t.product_name||"Product from sale",notes:t.notes||""})))||[]}if("device_payment"===a){const{data:a,error:n}=await t.from("customer_payments").select("amount").eq("id",e).single();return n?[]:[{id:`service-${e}`,name:"Device Repair Service",quantity:1,unitPrice:(null==a?void 0:a.amount)||0,totalPrice:(null==a?void 0:a.amount)||0,type:"service",description:"Device repair and maintenance service",notes:"Repair service for device"}]}if("purchase_order"===a){const{data:a,error:n}=await t.from("lats_purchase_order_items").select("\n            *,\n            lats_products(name, sku),\n            lats_product_variants(name, sku)\n          ").eq("purchase_order_id",e);return n?[]:(null==a?void 0:a.map(t=>{var e,a,n,r,s,o;return{id:t.id,name:(null==(e=t.lats_products)?void 0:e.name)||(null==(a=t.lats_product_variants)?void 0:a.name)||"Unknown Product",sku:(null==(n=t.lats_products)?void 0:n.sku)||(null==(r=t.lats_product_variants)?void 0:r.sku)||"N/A",quantity:t.quantity||1,unitPrice:t.unit_price||0,totalPrice:t.total_price||0,category:"Purchase Order",brand:"Supplier",variant:(null==(s=t.lats_product_variants)?void 0:s.name)||"Default",type:"product",description:`Purchase order item - ${(null==(o=t.lats_products)?void 0:o.name)||"Product"}`,notes:t.notes||""}}))||[]}return[]}catch(n){return[]}}async debouncedFetchPaymentTransactions(t,e,a,n){const r=`payments_${t||"all"}_${e||"all"}_${a||"all"}_${n||"all"}`;return this.debounceTimers.has(r)&&clearTimeout(this.debounceTimers.get(r)),new Promise((s,o)=>{const i=setTimeout(async()=>{this.debounceTimers.delete(r);try{const r=await this.fetchPaymentTransactions(t,e,a,n);s(r)}catch(i){o(i)}},this.DEBOUNCE_DELAY);this.debounceTimers.set(r,i)})}async fetchPaymentTransactions(t,e,a,n){var r,s;try{const s=`payments_${t||"all"}_${e||"all"}_${a||"all"}_${n||"all"}`,o=this.getCachedData(s);if(o)return o;if(this.globalFetchLock){let t=0;const e=1e4;for(;this.globalFetchLock&&t<e;)await new Promise(t=>setTimeout(t,200)),t+=200;const a=this.getCachedData(s);if(a)return a;this.globalFetchLock}if(!(await this.checkConnection())){return(null==(r=this.cache.get(s))?void 0:r.data)||[]}if(this.fetchLock.has(s))return this.fetchLock.get(s);this.globalFetchLock=!0;const i=setTimeout(()=>{this.globalFetchLock&&(this.globalFetchLock=!1)},this.GLOBAL_FETCH_TIMEOUT),c=this.retryOperation(()=>this._fetchPaymentTransactionsInternal(t,e,a,n),"fetchPaymentTransactions");this.fetchLock.set(s,c);try{const t=await c;return this.setCachedData(s,t),t}finally{clearTimeout(i),this.fetchLock.delete(s),this.globalFetchLock=!1}}catch(o){const r=`payments_${t||"all"}_${e||"all"}_${a||"all"}_${n||"all"}`,i=null==(s=this.cache.get(r))?void 0:s.data;return this.globalFetchLock=!1,i||[]}}async _fetchPaymentTransactionsInternal(e,a,n,r){const s=[];try{const{data:c,error:u}=await t.from("customer_payments").select("*").order("payment_date",{ascending:!1}).limit(1e3);if(u);else if(c&&c.length>0){const t=c.map(t=>({id:t.id,transactionId:`TXN-${t.id.slice(0,8).toUpperCase()}`,customerName:t.customer_name||"Unknown Customer",customerPhone:t.customer_phone,customerEmail:t.customer_email,customerAddress:t.customer_address,amount:Number(t.amount)||0,currency:t.currency||"TZS",method:this.mapPaymentMethod(t.method||t.payment_method),paymentMethod:this.mapPaymentMethod(t.method||t.payment_method),reference:t.reference||`REF-${t.id.slice(0,8).toUpperCase()}`,status:t.status||"completed",date:t.payment_date||t.created_at,timestamp:t.payment_date||t.created_at,cashier:t.cashier_name||"System",fees:Number(t.fees)||0,netAmount:(Number(t.amount)||0)-(Number(t.fees)||0),orderId:t.device_id,source:"device_payment",customerId:t.customer_id,deviceId:t.device_id,deviceName:t.device_name||void 0,paymentType:t.payment_type||"payment",createdBy:t.created_by,createdAt:t.created_at,failureReason:t.failure_reason,metadata:t.metadata||{}}));s.push(...t)}try{const e="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;let a=t.from("lats_sales").select("*").order("created_at",{ascending:!1}).limit(1e3);e&&(a=a.eq("branch_id",e));const{data:n,error:r}=await a;if(!r&&n&&n.length>0){const t=n.map(t=>({id:t.id,transactionId:t.sale_number||`SALE-${t.id.slice(0,8).toUpperCase()}`,customerName:t.customer_name||"Walk-in Customer",customerPhone:t.customer_phone,customerEmail:t.customer_email,customerAddress:t.customer_address,amount:Number(t.total_amount)||0,method:this.getPaymentMethodDisplay(t.payment_method),paymentMethod:this.getPaymentMethodDisplay(t.payment_method),reference:t.sale_number||`REF-${t.id.slice(0,8).toUpperCase()}`,status:this.mapSaleStatus(t.status),date:t.created_at,timestamp:t.created_at,cashier:t.cashier_name||"System",fees:Number(t.processing_fees)||0,netAmount:(Number(t.total_amount)||0)-(Number(t.processing_fees)||0),orderId:t.id,source:"pos_sale",customerId:t.customer_id||"",paymentType:"payment",createdBy:t.created_by,createdAt:t.created_at,failureReason:t.failure_reason,metadata:{...t.metadata,paymentMethod:this.parsePaymentMethod(t.payment_method)}}));s.push(...t)}}catch(o){}try{const{data:e,error:a}=await t.from("purchase_order_payments").select("*").order("payment_date",{ascending:!1}).limit(1e3);if(!a&&e&&e.length>0){const t=e.map(t=>({id:t.id,transactionId:`PO-PAY-${t.id.slice(0,8).toUpperCase()}`,customerName:"Supplier Payment",customerPhone:void 0,customerEmail:void 0,amount:Number(t.amount)||0,currency:t.currency||"TZS",method:this.mapPaymentMethod(t.payment_method),paymentMethod:this.mapPaymentMethod(t.payment_method),reference:t.reference_number||t.reference||`PO-REF-${t.id.slice(0,8).toUpperCase()}`,status:this.mapPOPaymentStatus(t.status),date:t.payment_date||t.created_at,timestamp:t.payment_date||t.created_at,cashier:"System",fees:0,netAmount:Number(t.amount)||0,orderId:t.purchase_order_id,source:"purchase_order",customerId:"",paymentType:"payment",createdBy:t.created_by,createdAt:t.created_at,failureReason:"failed"===t.status?"Payment failed":void 0,metadata:{paymentMethod:t.payment_method,paymentAccountId:t.payment_account_id},purchaseOrderId:t.purchase_order_id,purchaseOrderNumber:void 0,supplierId:void 0,supplierName:void 0,supplierPhone:void 0,supplierEmail:void 0,paymentAccountId:t.payment_account_id,paymentAccountName:void 0,notes:t.notes}));s.push(...t)}}catch(i){}let d=s;return e&&a&&(d=d.filter(t=>{const n=new Date(t.date),r=new Date(e),s=new Date(a);return n>=r&&n<=s})),n&&"all"!==n&&void 0!==n&&(d=d.filter(t=>t.status===n)),r&&"all"!==r&&void 0!==r&&(d=d.filter(t=>t.method===r)),d.sort((t,e)=>{const a=new Date(t.date||t.timestamp).getTime();return new Date(e.date||e.timestamp).getTime()-a}),d}catch(c){return[]}}async calculatePaymentMetrics(t,e){try{const a=await this.fetchPaymentTransactions(t,e),n=a.length,r=a.reduce((t,e)=>t+(Number(e.amount)||0),0),s=a.filter(t=>"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),o=a.filter(t=>"pending"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),i=a.filter(t=>"failed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),c=a.reduce((t,e)=>t+(Number(e.fees)||0),0);return{totalPayments:n,totalAmount:r,completedAmount:s,pendingAmount:o,failedAmount:i,totalFees:c,successRate:r>0?(s/r*100).toFixed(1).replace(/\.0$/,""):"0"}}catch(a){return{totalPayments:0,totalAmount:0,completedAmount:0,pendingAmount:0,failedAmount:0,totalFees:0,successRate:"0"}}}async getPaymentMethodSummary(t,e){try{const a=await this.fetchPaymentTransactions(t,e),n=a.reduce((t,e)=>t+(Number(e.amount)||0),0),r=new Map;return a.forEach(t=>{const e=t.method,a=r.get(e)||{count:0,amount:0},n=Number(t.amount)||0;r.set(e,{count:a.count+1,amount:a.amount+n})}),Array.from(r.entries()).map(([t,e])=>({method:t,count:e.count,amount:e.amount,percentage:n>0?Math.round(e.amount/n*100):0}))}catch(a){return[]}}async getPaymentsByMethod(t,e,a){try{const n=await this.fetchPaymentTransactions(t,e,a),r={};return n.forEach(t=>{const e=t.method;r[e]||(r[e]=[]),r[e].push(t)}),Object.keys(r).forEach(t=>{r[t].sort((t,e)=>new Date(e.date).getTime()-new Date(t.date).getTime())}),r}catch(n){return{}}}async getPaymentMethodStatistics(t,e){try{const a=await this.fetchPaymentTransactions(t,e),n={};return a.forEach(t=>{const e=t.method;n[e]||(n[e]={totalAmount:0,totalCount:0,completedAmount:0,completedCount:0,pendingAmount:0,pendingCount:0,failedAmount:0,failedCount:0,averageAmount:0,successRate:0});const a=n[e];a.totalAmount+=t.amount,a.totalCount+=1,"completed"===t.status?(a.completedAmount+=t.amount,a.completedCount+=1):"pending"===t.status?(a.pendingAmount+=t.amount,a.pendingCount+=1):"failed"===t.status&&(a.failedAmount+=t.amount,a.failedCount+=1)}),Object.keys(n).forEach(t=>{const e=n[t];e.averageAmount=e.totalCount>0?e.totalAmount/e.totalCount:0,e.successRate=e.totalCount>0?e.completedCount/e.totalCount*100:0}),n}catch(a){return{}}}async getDailySummary(t=7){try{const e=new Date,a=new Date;a.setDate(a.getDate()-t);const n=await this.fetchPaymentTransactions(a.toISOString().split("T")[0],e.toISOString().split("T")[0]),r=new Map;return n.forEach(t=>{const e=new Date(t.date).toISOString().split("T")[0],a=r.get(e)||{total:0,completed:0,pending:0,failed:0},n=Number(t.amount)||0;a.total+=n,"completed"===t.status?a.completed+=n:"pending"===t.status?a.pending+=n:"failed"===t.status&&(a.failed+=n),r.set(e,a)}),Array.from(r.entries()).map(([t,e])=>({date:t,...e})).sort((t,e)=>new Date(e.date).getTime()-new Date(t.date).getTime())}catch(e){return[]}}async getReconciliationRecords(){try{const t=await this.fetchPaymentTransactions(),e=new Map;return t.forEach(t=>{const a=new Date(t.date).toISOString().split("T")[0],n=e.get(a)||0,r=Number(t.amount)||0;e.set(a,n+r)}),Array.from(e.entries()).slice(0,5).map(([t,e])=>({date:t,status:"reconciled",expected:e,actual:e,variance:0}))}catch(t){return[]}}async updatePaymentStatus(e,a,n,r){try{const o=await this.getPaymentStatus(e,n);if("device_payment"===n)try{const n={status:a,updated_at:(new Date).toISOString()};if(r&&"null"!==r&&"undefined"!==r&&r.length>0){/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r)}const{error:s}=await t.from("customer_payments").update(n).eq("id",e);if(s){const{error:n}=await t.from("customer_payments").update({status:a}).eq("id",e);if(n)throw n}}catch(s){throw s}else if("pos_sale"===n){const{error:n}=await t.from("lats_sales").update({status:this.mapStatusToSaleStatus(a),updated_at:(new Date).toISOString(),updated_by:r}).eq("id",e);if(n)throw n}else if("purchase_order"===n){const{error:n}=await t.from("purchase_order_payments").update({status:"failed"===a?"failed":a,updated_at:(new Date).toISOString()}).eq("id",e);if(n)throw n}return await this.logPaymentOperation("status_update",e,{previous_status:o,new_status:a,source:n,timestamp:(new Date).toISOString()},r),this.clearCache(),!0}catch(o){return!1}}async getPaymentStatus(e,a){try{if("device_payment"===a){const{data:a,error:n}=await t.from("customer_payments").select("status").eq("id",e).single();if(n)throw n;return(null==a?void 0:a.status)||"unknown"}if("pos_sale"===a){const{data:a,error:n}=await t.from("lats_sales").select("status").eq("id",e).single();if(n)throw n;return(null==a?void 0:a.status)||"unknown"}if("purchase_order"===a){const{data:a,error:n}=await t.from("purchase_order_payments").select("status").eq("id",e).single();if(n)throw n;return(null==a?void 0:a.status)||"unknown"}return"unknown"}catch(n){return"unknown"}}clearPaymentCache(){this.clearCache()}async logPaymentOperation(e,a,n,r){try{await t.from("payment_audit_log").insert({operation:e,payment_id:a,details:n,user_id:r,timestamp:(new Date).toISOString(),ip_address:null,user_agent:null})}catch(s){}}async getPaymentAuditTrail(e){try{const{data:a,error:n}=await t.from("payment_audit_log").select("*").eq("payment_id",e).order("timestamp",{ascending:!1});if(n)throw n;return a||[]}catch(a){return[]}}mapPaymentMethod(t){if(!t)return"Cash";if("object"==typeof t){const e=t.method||t.paymentMethod||t.type;if(!e||"string"!=typeof e)return"Cash";t=e}if("string"!=typeof t)return"Cash";return{cash:"Cash",card:"Card",transfer:"Bank Transfer",mpesa:"M-Pesa",mobile_money:"M-Pesa"}[t.toLowerCase()]||t||"Cash"}mapSaleStatus(t){return"completed"===t?"completed":"pending"===t?"pending":"approved"===t?"approved":"cancelled"===t||"refunded"===t?"failed":"pending"}mapStatusToSaleStatus(t){return"completed"===t?"completed":"pending"===t?"pending":"approved"===t?"approved":"failed"===t?"cancelled":"pending"}mapPOPaymentStatus(t){return"completed"===t?"completed":"pending"===t?"pending":"approved"===t?"approved":"failed"===t||"cancelled"===t?"failed":"pending"}parsePaymentMethod(t){if(!t)return null;if("object"==typeof t)return t;if("string"==typeof t)try{return JSON.parse(t)}catch(e){return{type:"single",method:t}}return null}getPaymentMethodDisplay(t){var e;const a=this.parsePaymentMethod(t);return a?"single"!==a.type&&a.type&&"multiple"===a.type&&"multiple"===a.type&&(null==(e=a.details)?void 0:e.payments)?"Multiple":this.mapPaymentMethod(a):"Unknown"}};export{e as paymentTrackingService};
