import{s as e}from"./index-222cfb29.js";function t(e){if(!e)return"new";return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[e.trim().toLowerCase()]||"new"}const a=new Map;async function s(a,s=1,r=50){try{let i=null,l=null;try{const{data:t,error:n}=await e.rpc("search_customers_fn",{search_query:a,page_number:s,page_size:r});i=t,l=n}catch(n){l=n}if(l||!i){const t=(s-1)*r,n=(localStorage.getItem("current_branch_id"),a.toLowerCase()),o=e.from("customers").select("id").or(`name.ilike.%${n}%,phone.ilike.%${n}%,email.ilike.%${n}%`),{data:l}=await o,c=(null==l?void 0:l.length)||0,u=e.from("customers").select("id, name, phone, email, branch_id, created_by_branch_name").or(`name.ilike.%${n}%,phone.ilike.%${n}%,email.ilike.%${n}%`).order("created_at",{ascending:!1}).range(t,t+r-1),{data:h,error:d}=await u;if(d)throw d;i=(null==h?void 0:h.map(e=>({...e,total_count:c||0})))||[]}const c=i&&i.length>0?i[0].total_count:0,u=(null==i?void 0:i.map(e=>e.id))||[];if(0===u.length)return{customers:[],total:0,page:s,pageSize:r,totalPages:0,hasNextPage:!1,hasPreviousPage:!1};const{data:h,error:d}=await e.from("customers").select("\n        id,\n        name,\n        phone,\n        email,\n        whatsapp,\n        gender,\n        city,\n        country,\n        color_tag,\n        loyalty_level,\n        points,\n        total_spent,\n        last_visit,\n        is_active,\n        referral_source,\n        birth_month,\n        birth_day,\n        birthday,\n        initial_notes,\n        notes,\n        customer_tag,\n        location_description,\n        national_id,\n        joined_date,\n        created_at,\n        updated_at,\n        branch_id,\n        is_shared,\n        created_by_branch_id,\n        created_by_branch_name,\n        profile_image,\n        whatsapp_opt_out,\n        referred_by,\n        created_by,\n        last_purchase_date,\n        total_purchases,\n        total_calls,\n        total_call_duration_minutes,\n        incoming_calls,\n        outgoing_calls,\n        missed_calls,\n        avg_call_duration_minutes,\n        first_call_date,\n        last_call_date,\n        call_loyalty_level,\n        total_returns\n      ").in("id",u);if(d)throw d;if(h){let a={};try{const t=[...new Set(h.map(e=>e.branch_id).filter(Boolean))];if(t.length>0){const s=e.from("store_locations").select("id, name").in("id",t),r=await s;r.data&&(a=r.data.reduce((e,t)=>(e[t.id]=t.name,e),{}))}}catch(o){}const n=h.map(e=>({id:e.id,name:e.name,phone:e.phone,email:e.email,gender:e.gender||"other",city:e.city||"",colorTag:t(e.color_tag||"new"),loyaltyLevel:e.loyalty_level||"interested",points:e.points||0,totalSpent:e.total_spent||0,lastVisit:e.last_visit||e.created_at,isActive:!1!==e.is_active,referralSource:e.referral_source,birthMonth:e.birth_month,birthDay:e.birth_day,totalReturns:0,profileImage:null,branchName:a[e.branch_id]||e.created_by_branch_name||"Unknown Branch",whatsapp:e.phone,whatsappOptOut:!1,initialNotes:e.initial_notes,locationDescription:e.location_description,nationalId:e.national_id,notes:e.notes?"string"==typeof e.notes?(()=>{try{return JSON.parse(e.notes)}catch{return[]}})():e.notes:[],referrals:[],customerTag:e.customer_tag,joinedDate:e.joined_date||e.created_at,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]})),i=Math.ceil((c||0)/r);return{customers:n,total:c||0,page:s,pageSize:r,totalPages:i,hasNextPage:s<i,hasPreviousPage:s>1}}return{customers:[],total:0,page:s,pageSize:r,totalPages:0}}catch(i){throw i}}async function r(s,r=1,n=50){try{const i=`search_${s}_${r}_${n}`,l=a.get(i);if(l&&Date.now()-l.timestamp<3e5)return l.data;let c=null,u=null;try{const t=await e.rpc("search_customers_fn",{search_query:s,page_number:r,page_size:n});c=t.data,u=t.error}catch(o){u=o}if(u||!c){const t=(r-1)*n,a=s.toLowerCase(),o=localStorage.getItem("current_branch_id");let i=e.from("customers").select("id").or(`name.ilike.%${a}%,phone.ilike.%${a}%,email.ilike.%${a}%`);o&&(i=i.eq("branch_id",o));const{data:l}=await i,u=(null==l?void 0:l.length)||0;let h=e.from("customers").select("id,name,phone,email,gender,city,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared").or(`name.ilike.%${a}%,phone.ilike.%${a}%,email.ilike.%${a}%`).order("created_at",{ascending:!1}).range(t,t+n-1);o&&(h=h.eq("branch_id",o));const{data:d,error:_}=await h;if(_)throw _;c=(null==d?void 0:d.map(e=>({...e,total_count:u||0})))||[]}const h=c&&c.length>0?c[0].total_count:0;if(c){const e=c.map(e=>({...e,colorTag:t(e.color_tag||"new")})),s=Math.ceil((h||0)/n),o={customers:e,total:h||0,page:r,pageSize:n,totalPages:s,hasNextPage:r<s,hasPreviousPage:r>1};return a.set(i,{data:o,timestamp:Date.now()}),o}return{customers:[],total:0,page:r,pageSize:n,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}}catch(i){throw i}}function n(){a.clear()}function o(){return{size:a.size,entries:Array.from(a.keys())}}const i=new class{constructor(){this.searchQueue=[],this.isProcessing=!1,this.results=new Map,this.activeJobs=new Map}async search(e){return new Promise((t,a)=>{this.searchQueue.push({query:e,resolve:t,reject:a}),this.processQueue()})}async processQueue(){if(!this.isProcessing&&0!==this.searchQueue.length){for(this.isProcessing=!0;this.searchQueue.length>0;){const{query:t,resolve:a,reject:s}=this.searchQueue.shift(),n=`search_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.activeJobs.set(n,{query:t,resolve:a,reject:s});try{if(this.results.has(t)){a(this.results.get(t)),this.activeJobs.delete(n);continue}const e=await r(t,1,100);this.results.set(t,e.customers),a(e.customers),this.activeJobs.delete(n)}catch(e){s(e),this.activeJobs.delete(n)}}this.isProcessing=!1}}cancelSearchJob(e){const t=this.activeJobs.get(e);return!!t&&(t.resolve({cancelled:!0,customers:[],totalCount:0,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}),this.activeJobs.delete(e),!0)}clearResults(){this.results.clear();for(const[e,t]of this.activeJobs)t.reject(new Error("Search manager cleared"));this.activeJobs.clear()}};async function l(e,t=1,a=50,r,n,o){try{const l=`search_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;new Promise((s,r)=>{i.activeJobs.set(l,{query:e,resolve:e=>{const r={customers:e.customers||e,totalCount:e.total||(Array.isArray(e)?e.length:0),totalPages:e.totalPages||Math.ceil((e.total||(Array.isArray(e)?e.length:0))/a),hasNextPage:t<(e.totalPages||Math.ceil((e.total||(Array.isArray(e)?e.length:0))/a)),hasPreviousPage:t>1};s(r)},reject:r})});return setTimeout(async()=>{try{null==r||r("processing");const o=await s(e,t,a),c=i.activeJobs.get(l);if(c){const e={customers:o.customers,totalCount:o.total,totalPages:o.totalPages,hasNextPage:t<o.totalPages,hasPreviousPage:t>1};c.resolve(e),i.activeJobs.delete(l),null==r||r("completed"),null==n||n(e)}}catch(c){const e=i.activeJobs.get(l);e&&(e.reject(c),i.activeJobs.delete(l)),null==o||o(c instanceof Error?c.message:"Search failed")}},100),l}catch(l){throw l}}function c(){return i}export{s as a,l as b,n as c,o as d,c as g,r as s};
