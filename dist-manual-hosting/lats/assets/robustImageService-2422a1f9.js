import{s as e}from"./index-222cfb29.js";class t{static log(e,...t){}static throttledLog(e,t,a=1e3,...r){}static sessionLog(e,t,...a){}static initLog(e,t,...a){}static verboseLog(e,...t){this.isVerboseLogging}static setVerboseLogging(e){this.isVerboseLogging=e,e?localStorage.setItem("verbose_logging","true"):localStorage.removeItem("verbose_logging")}static getLogCounts(){return{...this.logCounts}}static clearLogCounts(){this.logCounts={},this.lastLogTime={},this.sessionLogged={}}static debugWhatsAppService(){}static resetSessionLogging(){this.sessionLogged={}}}t.isVerboseLogging=!1,t.logCounts={},t.lastLogTime={},t.sessionLogged={};class a{static async uploadImage(t,a,r,i=!1){try{const r=this.validateFile(t);if(!r.valid)return{success:!1,error:r.error};let c=null;try{const{data:{user:t},error:a}=await e.auth.getUser();if(t&&!a)c=t.id;else{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);c=t.id&&"system"!==t.id?t.id:null}}}catch(s){}if((await this.getProductImages(a)).length>=this.MAX_FILES_PER_PRODUCT)return{success:!1,error:`Maximum ${this.MAX_FILES_PER_PRODUCT} images allowed per product`};const m=this.generateFileName(t,a);let l,n;try{await this.checkBucketAccess();const e=await this.uploadToStorage(t,m);if(l=e.url,n=e.thumbnailUrl,!l||""===l.trim()||!n||""===n.trim())throw new Error("Storage returned empty URLs - falling back to base64")}catch(o){l=await this.compressImage(t),n=await this.createThumbnail(t,200)}if(!l||""===l.trim())throw new Error("Image URL is empty - upload may have failed");n&&""!==n.trim()||(n=l);const g=await this.saveImageRecord({productId:a,imageUrl:l,thumbnailUrl:n,fileName:t.name,fileSize:t.size,isPrimary:i,userId:c,mimeType:t.type});return this.clearProductCache(a),{success:!0,image:g}}catch(c){return{success:!1,error:c instanceof Error?c.message:"Upload failed"}}}static async getProductImages(a){var r;try{if(!a||"string"!=typeof a)return[];if(a.startsWith("temp-product-")||a.startsWith("test-product-")||a.startsWith("temp-sparepart-")){return this.tempImageStorage.get(a)||[]}const s=`product_${a}`,o=this.imageCache.get(s);if(o&&Date.now()-o.timestamp<this.CACHE_DURATION)return t.throttledLog(`cached_images_${a}`,"ðŸ“¦ Using cached images for product:",3e3,a),o.data;let c=null,m=null;try{const t=await e.from("product_images").select("*").eq("product_id",a).order("is_primary",{ascending:!1});c=t.data,m=t.error}catch(i){const t=await e.from("lats_products").select("images").eq("id",a).single();(null==(r=t.data)?void 0:r.images)&&Array.isArray(t.data.images)?(c=t.data.images.map((e,t)=>({id:`fallback-${t}`,image_url:e,thumbnail_url:e,file_name:`image-${t+1}`,file_size:0,is_primary:0===t,created_at:(new Date).toISOString(),mime_type:"image/jpeg",width:null,height:null})),m=null):m=t.error}if(m)return[];const l=c.map(e=>({id:e.id,url:e.image_url,thumbnailUrl:e.thumbnail_url,fileName:e.file_name,fileSize:e.file_size,isPrimary:e.is_primary,uploadedAt:e.created_at,mimeType:e.mime_type,width:e.width,height:e.height})).filter(e=>this.isValidImageUrl(e.url)||this.isValidImageUrl(e.thumbnailUrl));return this.imageCache.set(s,{data:l,timestamp:Date.now()}),l}catch(s){return[]}}static async deleteImage(t,a){try{if(t.startsWith("temp-")){if(a&&(a.startsWith("temp-product-")||a.startsWith("test-product-")||a.startsWith("temp-sparepart-"))){const e=(this.tempImageStorage.get(a)||[]).filter(e=>e.id!==t);this.tempImageStorage.set(a,e)}return{success:!0}}const{data:{user:i},error:s}=await neonClient.auth.getUser();if(s||!i)return{success:!1,error:"User not authenticated"};const{data:o,error:c}=await e.from("product_images").select("*").eq("id",t).single();if(c)return{success:!1,error:"Image not found"};if(!o)return{success:!1,error:"Image not found"};const{error:m}=await e.from("product_images").delete().eq("id",t);if(m)return{success:!1,error:"Failed to delete image from database"};if(o.image_url&&!o.image_url.startsWith("data:")&&!o.image_url.startsWith("blob:"))try{await this.deleteFromStorage(o.image_url)}catch(r){}return this.clearProductCache(o.product_id),{success:!0}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Delete failed"}}}static async setPrimaryImage(t,a){try{if(a.startsWith("temp-product-")||a.startsWith("test-product-")||t.startsWith("temp-"))return{success:!0};await e.from("product_images").update({is_primary:!1}).eq("product_id",a);const{error:r}=await e.from("product_images").update({is_primary:!0}).eq("id",t);if(r)throw r;return this.clearProductCache(a),{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Set primary failed"}}}static async getImageStats(){try{const{data:t,error:a}=await e.from("product_images").select("file_size, is_primary");if(a)throw a;const r=t.length,i=t.reduce((e,t)=>e+(t.file_size||0),0);return{totalImages:r,totalSize:i,averageSize:r>0?i/r:0,primaryImages:t.filter(e=>e.is_primary).length}}catch(t){return{totalImages:0,totalSize:0,averageSize:0,primaryImages:0}}}static async bulkUploadImages(e,t,a){const r=[],i=[],s=e.map(async(e,s)=>{try{const o=await this.uploadImage(e,t,a,0===s);o.success&&o.image?r.push(o.image):i.push(`${e.name}: ${o.error}`)}catch(o){i.push(`${e.name}: Upload failed`)}});return await Promise.all(s),{success:r.length>0,images:r,errors:i}}static validateFile(e){return e?this.ALLOWED_TYPES.includes(e.type)?e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size is ${this.MAX_FILE_SIZE/1024/1024}MB`}:{valid:!0}:{valid:!1,error:"Invalid file type. Only JPG, PNG, and WebP are allowed"}:{valid:!1,error:"No file provided"}}static isValidImageUrl(e){if(!e||"string"!=typeof e||""===e.trim())return!1;const t=e.trim();return!!t.startsWith("data:image/")||(!!t.startsWith("blob:")||!t.startsWith("{")&&!t.startsWith("[")&&(!(t.startsWith("/")&&!t.match(/\.(jpg|jpeg|png|webp|gif|svg)(\?.*)?$/i))&&!(!t.startsWith("http://")&&!t.startsWith("https://"))))}static generateFileName(e,t){var a;const r=Date.now(),i=crypto.randomUUID().replace(/-/g,"").substring(0,8),s=(null==(a=e.name.split(".").pop())?void 0:a.toLowerCase())||"jpg";return`${t.replace(/[^a-zA-Z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}_${r}_${i}.${s}`}static async compressImage(e){return new Promise((t,a)=>{const r=document.createElement("canvas"),i=r.getContext("2d"),s=new Image;s.onload=()=>{const e=1200;let{width:a,height:o}=s;a>o&&a>e?(o=o*e/a,a=e):o>e&&(a=a*e/o,o=e),r.width=a,r.height=o,null==i||i.drawImage(s,0,0,a,o);const c=r.toDataURL("image/jpeg",.8);t(c)},s.onerror=a,s.src=URL.createObjectURL(e)})}static async createThumbnail(e,t){return new Promise((a,r)=>{const i=document.createElement("canvas"),s=i.getContext("2d"),o=new Image;o.onload=()=>{i.width=t,i.height=t;const e=o.width/o.height;let r=t,c=t;e>1?c=t/e:r=t*e;const m=(t-r)/2,l=(t-c)/2;null==s||s.drawImage(o,m,l,r,c);const n=i.toDataURL("image/jpeg",.7);a(n)},o.onerror=r,o.src=URL.createObjectURL(e)})}static async uploadToStorage(t,a){const{data:{user:r},error:i}=await e.auth.getUser(),{data:s,error:o}=await e.storage.from("product-images").upload(a,t);if(o)throw o;const c=e.storage.from("product-images").getPublicUrl(a).data.publicUrl,m=await this.createThumbnail(t,200),l=await this.dataUrlToBlob(m),n=`thumb_${a}`,{data:g,error:u}=await e.storage.from("product-images").upload(n,l);return{url:c,thumbnailUrl:e.storage.from("product-images").getPublicUrl(n).data.publicUrl}}static async dataUrlToBlob(e){return(await fetch(e)).blob()}static async checkBucketAccess(){try{const{data:t,error:a}=await e.storage.from("product-images").list("",{limit:1});if(a)throw a.message.includes("not found")||404===a.statusCode?new Error("product-images bucket does not exist. Please create it in Supabase dashboard."):a.message.includes("permission")||403===a.statusCode?new Error("Permission denied. User may not have access to product-images bucket."):new Error(`Bucket access failed: ${a.message}`)}catch(t){throw t}}static async saveImageRecord(t){if(t.productId.startsWith("temp-product-")||t.productId.startsWith("test-product-")||t.productId.startsWith("temp-sparepart-")){const e={id:`temp-${Date.now()}-${crypto.randomUUID().replace(/-/g,"").substring(0,8)}`,url:t.imageUrl,thumbnailUrl:t.thumbnailUrl&&t.thumbnailUrl!==t.imageUrl?t.thumbnailUrl:t.imageUrl,fileName:t.fileName,fileSize:t.fileSize,isPrimary:t.isPrimary,uploadedAt:(new Date).toISOString(),mimeType:t.mimeType},a=this.tempImageStorage.get(t.productId)||[];return this.tempImageStorage.set(t.productId,[...a,e]),e}const{data:a}=await e.from("product_images").select("id, image_url").eq("product_id",t.productId).eq("image_url",t.imageUrl).single();if(a){const{data:t}=await e.from("product_images").select("*").eq("id",a.id).single();return{id:t.id,url:t.image_url,thumbnailUrl:t.thumbnail_url,fileName:t.file_name,fileSize:t.file_size,isPrimary:t.is_primary,uploadedAt:t.created_at,mimeType:t.mime_type}}const{data:r,error:i}=await e.from("product_images").insert({product_id:t.productId,image_url:t.imageUrl,thumbnail_url:t.thumbnailUrl,file_name:t.fileName,file_size:t.fileSize,is_primary:t.isPrimary,uploaded_by:t.userId,mime_type:t.mimeType}).select().single();if(i)throw i;if(!r)throw new Error("Failed to save image record: No data returned from database");return{id:r.id,url:r.image_url,thumbnailUrl:r.thumbnail_url,fileName:r.file_name,fileSize:r.file_size,isPrimary:r.is_primary,uploadedAt:r.created_at,mimeType:r.mime_type}}static async deleteFromStorage(t){try{const a=t.split("/").pop();a&&await e.storage.from("product-images").remove([a,`thumb_${a}`])}catch(a){}}static clearProductCache(e){const t=`product_${e}`;this.imageCache.delete(t)}static clearAllCache(){this.imageCache.clear()}static getCacheStats(){return{size:this.imageCache.size,entries:this.imageCache.size}}}a.MAX_FILE_SIZE=5242880,a.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp"],a.MAX_FILES_PER_PRODUCT=5,a.CACHE_DURATION=3e5,a.imageCache=new Map,a.tempImageStorage=new Map;export{a as R};
