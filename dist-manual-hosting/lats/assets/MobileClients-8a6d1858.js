import{s as e,j as t}from"./index-222cfb29.js";import{r as s}from"./vendor-a2ff445a.js";import"./supabase-460661f2.js";import{Q as a,t as r,ah as n,D as i,y as l,bP as o,bQ as c,R as d,ao as m,z as u}from"./ui-551a39a6.js";import{M as x}from"./MobileAddCustomerModal-ed043a13.js";import{u as h,a as p}from"./useMobileBranch-1aee679b.js";import{a as f}from"./routing-a2f0f6d2.js";import"./supabase-7e851d02.js";import"./phoneUtils-1ba19aca.js";import"./useSuccessModal-e8b7d685.js";import"./useBodyScrollLock-0216d39f.js";import"./SuccessModalIcons-20b743c5.js";import"./MobileSheetContent-ad1cebdf.js";const g=()=>{const g=f(),{currentBranch:b,loading:j,isDataShared:v}=h(),[N,y]=s.useState(""),[w,C]=s.useState("name"),[k,S]=s.useState("asc"),[P,F]=s.useState([]),[$,_]=s.useState(!0),[M,D]=s.useState(!1),[W,z]=s.useState(!1),[L,R]=s.useState({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0}),[T,A]=s.useState(0),[E,U]=s.useState(0),B=s.useRef(null),Y=e=>{const t=new Date;t.setDate(t.getDate()-30);const s=e.filter(e=>{if(!e.lastPurchase)return!1;try{return new Date(e.lastPurchase)>=t}catch(s){return!1}}).length;let a=0;e.forEach(e=>{const t=e.totalPurchases||0;isFinite(t)&&!isNaN(t)&&t>=0&&(a+=t)}),a>1e15&&(a=0);const r=e.length>0?a/e.length:0;return{totalClients:e.length,activeClients:s,totalRevenue:isFinite(a)?a:0,avgPurchase:isFinite(r)?r:0}},I=async(t=!0)=>{if(!j)try{let s=e.from("customers").select("*").order("name",{ascending:!0});if(b){const e=v("customers");s=p(s,b.id,b.data_isolation_mode,e)}let{data:a,error:r}=await s;if(a&&a.length,!a||0===a.length){let t=e.from("lats_customers").select("*").order("name",{ascending:!0});if(b){const e=v("customers");t=p(t,b.id,b.data_isolation_mode,e)}const s=await t;s.data&&s.data.length>0&&(a=s.data,r=s.error)}if(r)throw r;if(!a||0===a.length)return t&&u("No customers found. Add your first customer to get started!"),F([]),void R({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0});const n=a.map(e=>{let t=e.total_spent||e.total_purchases||0,s=0;"string"==typeof t&&(t=parseFloat(t.replace(/[^0-9.-]/g,""))),s=isNaN(t)||!isFinite(t)||t>1e15?0:t>1e8?t/100:t,s=Math.max(0,s);return{id:e.id,name:e.name||`${e.first_name||""} ${e.last_name||""}`.trim()||"Unnamed Customer",phone:e.phone||e.mobile||e.whatsapp||"No phone",email:e.email,address:e.address||e.location_description||e.city,totalPurchases:s,lastPurchase:e.last_purchase_date?new Date(e.last_purchase_date).toLocaleDateString():void 0,avatar:void 0}});F(n);const i=Y(n);R(i),t&&u.success(`Loaded ${n.length} customers`)}catch(s){u.error(`Failed to load customers: ${s.message}`),F([]),R({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0})}};s.useEffect(()=>{const e=async()=>{_(!0),await I(),_(!1)};e();const t=()=>{e()};return window.addEventListener("branchChanged",t),()=>{window.removeEventListener("branchChanged",t)}},[b,j]),s.useEffect(()=>{const t=e.channel("customers-changes").on("postgres_changes",{event:"*",schema:"public",table:"customers"},e=>{I(!1)}).subscribe();return()=>{t.unsubscribe()}},[]);const K=e=>{const t=e.trim().split(" ");return t.length>=2?`${t[0][0]}${t[t.length-1][0]}`.toUpperCase():e.substring(0,2).toUpperCase()},O=e=>{if(0===e||null==e)return"0";if(isNaN(e)||!isFinite(e))return"0";if(e>1e15||e<-1e15)return"0";const t=Math.abs(e);return t>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":t>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toFixed(0)},Q=P.filter(e=>{var t;return e.name.toLowerCase().includes(N.toLowerCase())||e.phone.includes(N)||(null==(t=e.email)?void 0:t.toLowerCase().includes(N.toLowerCase()))}).sort((e,t)=>{let s=0;switch(w){case"name":s=e.name.localeCompare(t.name);break;case"purchases":s=(e.totalPurchases||0)-(t.totalPurchases||0);break;case"recent":s=(e.lastPurchase?new Date(e.lastPurchase).getTime():0)-(t.lastPurchase?new Date(t.lastPurchase).getTime():0)}return"asc"===k?s:-s});return t.jsxs("div",{className:"flex flex-col h-full bg-white",children:[t.jsxs("div",{className:"px-4 pt-3 pb-2",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h1",{className:"text-[32px] font-bold text-black tracking-tight",children:"Clients"}),t.jsx("button",{onClick:()=>z(!0),className:"flex items-center justify-center text-blue-500 hover:text-blue-600 active:text-blue-700 transition-colors flex-shrink-0 p-1","aria-label":"Add client",children:t.jsx(a,{size:28,strokeWidth:2.5})})]}),!$&&P.length>0&&t.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[t.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(r,{size:14,className:"text-blue-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-blue-700",children:"Total"})]}),t.jsx("div",{className:"text-[20px] font-bold text-blue-900",children:L.totalClients})]}),t.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(n,{size:14,className:"text-green-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-green-700",children:"Active"})]}),t.jsx("div",{className:"text-[20px] font-bold text-green-900",children:L.activeClients})]}),t.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-3 border border-purple-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(i,{size:14,className:"text-purple-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-purple-700",children:"Revenue"})]}),t.jsxs("div",{className:"text-[20px] font-bold text-purple-900",children:["$",O(L.totalRevenue)]})]})]}),t.jsxs("div",{className:"relative mb-2",children:[t.jsx(l,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16,strokeWidth:2}),t.jsx("input",{type:"text",placeholder:"Search by name, phone, or email",value:N,onChange:e=>y(e.target.value),className:"w-full pl-9 pr-4 py-2 bg-[#f2f2f7] border-0 rounded-lg focus:outline-none focus:ring-0 text-gray-900 placeholder-gray-400 text-[15px] font-light",style:{WebkitAppearance:"none"}})]}),t.jsxs("div",{className:"flex items-center justify-between py-2.5 px-0.5",children:[t.jsxs("button",{onClick:()=>{const e=["name","purchases","recent"],t=(e.indexOf(w)+1)%e.length;C(e[t])},className:"flex items-center gap-1.5 hover:opacity-70 transition-opacity",children:[t.jsx(o,{size:16,className:"text-blue-500",strokeWidth:2.5}),t.jsx("span",{className:"text-gray-900 font-normal text-[15px]",children:(()=>{switch(w){case"name":return"Sorted alphabetically";case"purchases":return"Sorted by purchases";case"recent":return"Sorted by recent activity";default:return"Sorted"}})()})]}),t.jsx("button",{onClick:()=>{S("asc"===k?"desc":"asc")},className:"p-0.5 hover:opacity-70 transition-opacity","aria-label":"Toggle sort order",children:t.jsx(c,{size:16,strokeWidth:2.5,className:"text-blue-500 transition-transform "+("desc"===k?"rotate-180":"")})})]}),!$&&N&&t.jsx("div",{className:"py-1 px-0.5",children:t.jsxs("span",{className:"text-[13px] text-gray-500",children:[Q.length," of ",P.length," clients"]})})]}),$&&t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-3"}),t.jsx("p",{className:"text-gray-500 text-[15px]",children:"Loading clients..."})]})}),E>0&&!$&&t.jsxs("div",{className:"flex items-center justify-center py-2 transition-all",style:{transform:`translateY(${Math.min(E,80)}px)`,opacity:Math.min(E/80,1)},children:[t.jsx(d,{size:20,className:"text-blue-500 "+(M||E>80?"animate-spin":""),strokeWidth:2.5}),t.jsx("span",{className:"ml-2 text-[14px] text-blue-500 font-medium",children:E>80?"Release to refresh":"Pull to refresh"})]}),!$&&t.jsxs("div",{ref:B,className:"flex-1 overflow-y-auto pb-20",onTouchStart:e=>{B.current&&0===B.current.scrollTop&&A(e.touches[0].clientY)},onTouchMove:e=>{if(T>0&&B.current&&0===B.current.scrollTop){const t=e.touches[0].clientY-T;t>0&&t<120&&U(t)}},onTouchEnd:async()=>{E>80&&(D(!0),await I(!1),u.success("Refreshed!"),D(!1)),A(0),U(0)},children:[Q.map((e,s)=>{return t.jsxs("div",{onClick:()=>g(`/mobile/clients/${e.id}`),className:"flex items-center gap-3 px-4 py-3 border-b border-[#e5e5ea] hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors",style:{borderBottomWidth:s===Q.length-1?"0":"0.5px"},children:[t.jsx("div",{className:"flex-shrink-0 w-11 h-11 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-semibold text-[15px] shadow-sm",children:K(e.name)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-[16px] font-semibold text-gray-900 truncate",children:e.name}),e.lastPurchase&&t.jsx("span",{className:"flex-shrink-0 px-1.5 py-0.5 text-[10px] font-medium bg-green-100 text-green-700 rounded",children:"Active"})]}),t.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.jsx("span",{className:"text-[13px] text-gray-500 truncate",children:e.phone}),e.totalPurchases>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-gray-300",children:"â€¢"}),t.jsx("span",{className:"text-[13px] font-medium text-gray-700",children:(a=e.totalPurchases,a&&!isNaN(a)&&isFinite(a)?a>1e12?"$"+O(a):new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(a):"$0")})]})]})]}),t.jsx(m,{size:18,className:"text-gray-400 flex-shrink-0",strokeWidth:2})]},e.id);var a}),0===Q.length&&t.jsxs("div",{className:"text-center py-16 px-4",children:[t.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4",children:t.jsx(r,{size:40,className:"text-gray-400",strokeWidth:1.5})}),t.jsx("p",{className:"text-gray-900 text-[17px] font-semibold mb-2",children:"No clients found"}),t.jsx("p",{className:"text-[15px] text-gray-500 mb-6 max-w-sm mx-auto",children:0===P.length?"Start building your customer base by adding your first client":"Try adjusting your search or filters"}),0===P.length&&t.jsxs("button",{onClick:()=>z(!0),className:"inline-flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm",children:[t.jsx(a,{size:20,strokeWidth:2.5}),"Add First Client"]})]})]}),t.jsx(x,{isOpen:W,onClose:()=>z(!1),onCustomerCreated:e=>{const t={id:e.id,name:e.name,phone:e.phone,email:e.email||"",address:e.city||"",totalPurchases:e.totalSpent||0,lastPurchase:e.lastVisit,avatar:void 0};F(e=>{const s=[t,...e];return R(Y(s)),s}),z(!1),u.success(`Customer "${e.name}" added successfully!`)},onAddAnother:()=>{z(!0)}})]})};export{g as default};
