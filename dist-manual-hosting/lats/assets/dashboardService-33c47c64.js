import{a8 as t,a9 as e,F as a,s as n,aa as o,ab as r}from"./index-222cfb29.js";const i=new class{async getDashboardStats(t,e,a){try{const[n,o,r,i,s,c]=await Promise.all([this.getDeviceStats(e,a),this.getCustomerStats(e,a),this.getEmployeeStats(),this.getPaymentStats(e,a),this.getAppointmentStats(e,a),this.getInventoryStats()]);return{totalDevices:n.total,totalCustomers:o.total,totalEmployees:r.total,totalRevenue:i.totalRevenue,activeDevices:n.active,completedDevices:n.completed,pendingDevices:n.pending,overdueDevices:n.overdue,devicesInRepair:n.inRepair,presentToday:r.presentToday,onLeaveToday:r.onLeaveToday,attendanceRate:r.attendanceRate,newCustomersThisMonth:o.newThisMonth,activeCustomers:o.active,revenueThisMonth:i.thisMonth,revenueThisWeek:i.thisWeek,revenueToday:i.today,pendingPayments:i.pending,unreadNotifications:await this.getNotificationCounts(t).then(t=>t.unread),urgentNotifications:await this.getNotificationCounts(t).then(t=>t.urgent),appointmentsToday:s.today,appointmentsThisWeek:s.thisWeek,upcomingAppointments:s.upcoming,todayAppointments:s.today,appointmentCompletionRate:s.completionRate,lowStockItems:c.lowStock,criticalStockAlerts:c.critical,totalProducts:c.total,inventoryValue:c.value}}catch(n){return this.getDefaultStats()}}async getDeviceStats(e,a){try{const n=await t(),o=new Date;let r=n;return e&&a&&(r=n.filter(t=>{const n=new Date(t.created_at);return n>=new Date(e)&&n<=new Date(a)})),{total:r.length,active:r.filter(t=>!["done","failed","repair-complete"].includes(t.status)).length,completed:r.filter(t=>["done","repair-complete"].includes(t.status)).length,pending:r.filter(t=>["assigned","awaiting-parts"].includes(t.status)).length,overdue:r.filter(t=>!!t.estimated_completion_date&&(new Date(t.estimated_completion_date)<o&&!["done","failed","repair-complete"].includes(t.status))).length,inRepair:r.filter(t=>["diagnosis-started","in-repair","reassembled-testing"].includes(t.status)).length}}catch(n){return{total:0,active:0,completed:0,pending:0,overdue:0,inRepair:0}}}async getCustomerStats(t,a){try{const n=await e();let o=n;return t&&a&&(o=n.filter(e=>{const n=new Date(e.joined_date);return n>=new Date(t)&&n<=new Date(a)})),{total:n.length,active:n.filter(t=>t.is_active).length,newThisMonth:o.length}}catch(n){return{total:0,active:0,newThisMonth:0}}}async getEmployeeStats(){try{const t=(new Date).toISOString().split("T")[0],e=a();let o=n.from("employees").select("id, status");e&&(o=o.eq("branch_id",e));const{data:r,error:i}=await o;if(i)throw i;const s=(null==r?void 0:r.length)||0,c=(null==r?void 0:r.filter(t=>"on-leave"===t.status).length)||0;let d=n.from("attendance_records").select("status").eq("attendance_date",t);e&&(d=d.eq("branch_id",e));const{data:l,error:u}=await d;if(u)throw u;const m=(null==l?void 0:l.filter(t=>"present"===t.status||"late"===t.status).length)||0,p=s>0?m/s*100:0;return{total:s,presentToday:m,onLeaveToday:c,attendanceRate:Math.round(p)}}catch(t){return{total:0,presentToday:0,onLeaveToday:0,attendanceRate:0}}}async getPaymentStats(t,e){try{const a=await o();let n=a;t&&e&&(n=a.filter(a=>{const n=new Date(a.payment_date);return n>=new Date(t)&&n<=new Date(e)}));const r=new Date,i=new Date(r.getFullYear(),r.getMonth(),r.getDate()),s=new Date(i);s.setDate(s.getDate()-s.getDay());const c=new Date(r.getFullYear(),r.getMonth(),1);return{totalRevenue:a.filter(t=>"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),today:n.filter(t=>new Date(t.payment_date)>=i&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),thisWeek:n.filter(t=>new Date(t.payment_date)>=s&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),thisMonth:n.filter(t=>new Date(t.payment_date)>=c&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),pending:n.filter(t=>"pending"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0)}}catch(a){return{totalRevenue:0,today:0,thisWeek:0,thisMonth:0,pending:0}}}async getAppointmentStats(t,e){try{const o=a(),r=new Date,i=new Date(r.getFullYear(),r.getMonth(),r.getDate());i.setHours(0,0,0,0);const s=new Date(i);s.setHours(23,59,59,999);const c=new Date(i);c.setDate(c.getDate()-c.getDay());let d=n.from("appointments").select("id, status, appointment_date, created_at");o&&(d=d.eq("branch_id",o)),t&&e&&(d=d.gte("appointment_date",t).lte("appointment_date",e));const{data:l,error:u}=await d;if(u)return{today:0,thisWeek:0,upcoming:0,completionRate:0};const m=l||[],p=m.filter(t=>{const e=new Date(t.appointment_date);return e>=i&&e<=s}),h=m.filter(t=>new Date(t.appointment_date)>=i),g=p.filter(t=>"completed"===t.status).length,_=p.length>0?Math.round(g/p.length*100):0;return{today:p.length,thisWeek:m.filter(t=>new Date(t.appointment_date)>=c).length,upcoming:h.length,completionRate:_}}catch(o){return{today:0,thisWeek:0,upcoming:0,completionRate:0}}}async getInventoryStats(){try{const t=await r(),e=t.filter(t=>{const e=Number(t.quantity)||0,a=Number(t.min_quantity)||0;return e>0&&e<=a}).length,a=t.filter(t=>0===(Number(t.quantity)||0)).length,n=t.reduce((t,e)=>t+(Number(e.cost_price)||0)*(Number(e.quantity)||0),0);return{total:t.length,lowStock:e,critical:a,value:n}}catch(t){return{total:0,lowStock:0,critical:0,value:0}}}async getNotificationCounts(t){try{const e=a();let o=n.from("notifications").select("status, priority").eq("user_id",t);e&&(o=o.eq("branch_id",e));const{data:r,error:i}=await o;if(i)throw i;const s=r||[],c=s.filter(t=>"unread"===t.status).length;return{unread:c,urgent:s.filter(t=>"urgent"===t.priority&&"unread"===t.status).length}}catch(e){return{unread:0,urgent:0}}}async getRecentNotifications(t,e=10){try{const o=a();let r=n.from("notifications").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(e);o&&(r=r.eq("branch_id",o));const{data:i,error:s}=await r;if(s)throw s;return(i||[]).map(t=>({id:t.id,title:t.title,message:t.message,priority:t.priority,createdAt:t.created_at,isRead:"read"===t.status||"actioned"===t.status,type:t.type}))}catch(o){return[]}}async getTodayEmployeeStatus(){try{const t=(new Date).toISOString().split("T")[0],e=a();let o=n.from("employees").select("id, full_name, email, phone, position").eq("is_active",!0).limit(10);e&&(o=o.eq("branch_id",e));const{data:r,error:i}=await o;if(i)throw i;if(!r||0===r.length)return[];const s=r.map(t=>t.id);let c=n.from("attendance_records").select("employee_id, status, check_in_time").eq("attendance_date",t).in("employee_id",s);e&&(c=c.eq("branch_id",e));const{data:d,error:l}=await c;if(l)throw l;return r.map(t=>{const e=null==d?void 0:d.find(e=>e.employee_id===t.id);return{id:t.id,full_name:t.full_name||"Unknown",email:t.email,role:t.position||"Staff",status:(null==e?void 0:e.status)||"absent",department:t.position||"",checkInTime:(null==e?void 0:e.check_in_time)?new Date(e.check_in_time).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):void 0}})}catch(t){return[]}}async getRecentActivity(t=20){try{const e=[],o=a();let r=n.from("devices").select("id, device_name, status, problem_description, created_at, updated_at").order("updated_at",{ascending:!1}).limit(5);o&&(r=r.eq("branch_id",o));const{data:i,error:s}=await r;if(s)throw s;i&&i.forEach(t=>{e.push({id:`device-${t.id}`,type:"device",title:`Device ${t.status.replace("-"," ")}`,description:`${t.problem_description||"Service"} - ${t.device_name}`,time:t.updated_at,status:["done","repair-complete"].includes(t.status)?"completed":"pending"})});let c=n.from("customer_payments").select("id, amount, payment_date, status").order("payment_date",{ascending:!1}).limit(5);o&&(c=c.eq("branch_id",o));const{data:d}=await c;d&&d.forEach(t=>{e.push({id:`payment-${t.id}`,type:"payment",title:"Payment received",description:`Payment of ${t.amount} TZS`,time:t.payment_date,status:"completed"===t.status?"completed":"pending",amount:t.amount})});let l=n.from("lats_sales").select("id, sale_number, total_amount, customer_name, created_at").order("created_at",{ascending:!1}).limit(10);o&&(l=l.eq("branch_id",o));const{data:u}=await l;u&&u.forEach(t=>{e.push({id:`sale-${t.id}`,type:"payment",title:"Sale completed",description:`${t.customer_name||"Walk-in customer"} - ${t.sale_number}`,time:t.created_at,status:"completed",amount:t.total_amount})});let m=n.from("customers").select("id, name, joined_date").order("joined_date",{ascending:!1}).limit(3);o&&(m=m.eq("branch_id",o));const{data:p}=await m;return p&&p.forEach(t=>{e.push({id:`customer-${t.id}`,type:"customer",title:"New customer registered",description:t.name,time:t.joined_date,status:"completed"})}),e.sort((t,e)=>new Date(e.time).getTime()-new Date(t.time).getTime()).slice(0,t)}catch(e){return[]}}async getRecentActivities(t=20){return this.getRecentActivity(t)}async getTodayAppointments(t=10){try{const e=a(),o=new Date,r=new Date(o.getFullYear(),o.getMonth(),o.getDate());r.setHours(0,0,0,0);const i=new Date(r);i.setHours(23,59,59,999);let s=n.from("appointments").select("*").gte("appointment_date",r.toISOString()).lte("appointment_date",i.toISOString()).order("appointment_date",{ascending:!0}).limit(t);e&&(s=s.eq("branch_id",e));const{data:c,error:d}=await s;if(d)return[];const l=c||[];if(0===l.length)return[];const u=l.map(t=>t.customer_id).filter(Boolean),{data:m}=await n.from("customers").select("id, name").in("id",u),p=new Map((m||[]).map(t=>[t.id,t.name]));return l.map(t=>({id:t.id,customerName:p.get(t.customer_id)||"Unknown",serviceName:t.title||t.service_type||t.description||"Appointment",time:new Date(t.appointment_date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),status:t.status||"scheduled",priority:t.priority||"medium",technicianName:void 0}))}catch(e){return[]}}async getCustomerInsights(){try{const t=a();let e=n.from("customers").select("id, name, total_spent, joined_date, is_active");t&&(e=e.eq("branch_id",t));const{data:o,error:r}=await e;if(r)throw r;const i=o||[],s=new Date,c=new Date(s.getFullYear(),s.getMonth(),1),d=i.sort((t,e)=>(e.total_spent||0)-(t.total_spent||0)).slice(0,5).map(t=>({id:t.id,name:t.name,totalSpent:t.total_spent||0,deviceCount:0}));return{totalCustomers:i.length,newThisMonth:i.filter(t=>new Date(t.joined_date)>=c).length,returningCustomers:i.filter(t=>(t.total_spent||0)>0).length,avgLifetimeValue:i.length>0?i.reduce((t,e)=>t+(e.total_spent||0),0)/i.length:0,topCustomers:d}}catch(t){return{totalCustomers:0,newThisMonth:0,returningCustomers:0,avgLifetimeValue:0,topCustomers:[]}}}async getFinancialSummary(){try{const t=new Date,e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(e);o.setDate(o.getDate()-o.getDay());const r=new Date(t.getFullYear(),t.getMonth(),1),i=new Date(t.getFullYear(),t.getMonth()-1,1),s=new Date(t.getFullYear(),t.getMonth(),0,23,59,59),c=a();let d=n.from("lats_sales").select("total_amount, created_at, payment_method, sale_number");c&&(d=d.eq("branch_id",c));const{data:l,error:u}=await d;if(u)throw u;let m=n.from("customer_payments").select("amount, payment_date, status, method");c&&(m=m.eq("branch_id",c));const{data:p}=await m,h=l||[],g=p||[],_=h.filter(t=>new Date(t.created_at)>=e).reduce((t,e)=>t+(Number(e.total_amount)||0),0),y=_+g.filter(t=>new Date(t.payment_date)>=e&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),w=h.filter(t=>new Date(t.created_at)>=o).reduce((t,e)=>t+(Number(e.total_amount)||0),0),f=w+g.filter(t=>new Date(t.payment_date)>=o&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),v=h.filter(t=>new Date(t.created_at)>=r).reduce((t,e)=>t+(Number(e.total_amount)||0),0),D=v+g.filter(t=>new Date(t.payment_date)>=r&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),b=h.filter(t=>new Date(t.created_at)>=i&&new Date(t.created_at)<=s).reduce((t,e)=>t+(Number(e.total_amount)||0),0),S=b+g.filter(t=>new Date(t.payment_date)>=i&&new Date(t.payment_date)<=s&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),N=S>0?Math.round((D-S)/S*100):0,T=h.length+g.filter(t=>"completed"===t.status).length,q=g.filter(t=>"pending"===t.status).length,M=g.filter(t=>"pending"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),k={};h.forEach(t=>{let e="cash";t.payment_method&&("string"==typeof t.payment_method?e=t.payment_method:"object"==typeof t.payment_method&&(e=t.payment_method.method||t.payment_method.name||t.payment_method.type||Object.keys(t.payment_method)[0]||"cash")),k[e]||(k[e]={amount:0,count:0}),k[e].amount+=Number(t.total_amount)||0,k[e].count+=1}),g.filter(t=>"completed"===t.status).forEach(t=>{const e=t.method||"cash";k[e]||(k[e]={amount:0,count:0}),k[e].amount+=Number(t.amount)||0,k[e].count+=1});return{todayRevenue:y,weeklyRevenue:f,monthlyRevenue:D,revenueGrowth:N,completedPayments:T,pendingPayments:q,outstandingAmount:M,paymentMethods:Object.entries(k).map(([t,e])=>({method:t,amount:e.amount,count:e.count})).sort((t,e)=>e.amount-t.amount)}}catch(t){return{todayRevenue:0,weeklyRevenue:0,monthlyRevenue:0,revenueGrowth:0,completedPayments:0,pendingPayments:0,outstandingAmount:0,paymentMethods:[]}}}async getInventoryAlerts(){try{const t=a();let e=n.from("lats_products").select("id, name, category_id, is_active, branch_id, is_shared").eq("is_active",!0);t&&(e=e.or(`is_shared.eq.true,branch_id.eq.${t}`));const{data:o,error:r}=await e;if(r)throw r;if(!o||0===o.length)return[];const i=o.map(t=>t.id);let s=n.from("lats_product_variants").select("id, product_id, quantity, min_quantity, branch_id, is_shared").in("product_id",i);t&&(s=s.or(`is_shared.eq.true,branch_id.eq.${t}`));const{data:c,error:d}=await s;if(d)throw d;const l=[...new Set(o.map(t=>t.category_id).filter(Boolean))],{data:u}=l.length>0?await n.from("lats_categories").select("id, name").in("id",l):{data:[]},m=new Map((u||[]).map(t=>[t.id,t.name])),p=new Map(o.map(t=>[t.id,t])),h=[];(c||[]).forEach(t=>{const e=Number(t.quantity)||0,a=Number(t.min_quantity)||0,n=p.get(t.product_id);if(!n)return;let o;0===e?o="out-of-stock":e<=.25*a?o="critical":e<=a&&(o="low"),o&&h.push({id:t.id,productName:n.name||"Unknown Product",category:m.get(n.category_id)||"Uncategorized",currentStock:e,minimumStock:a,alertLevel:o})});const g={"out-of-stock":0,critical:1,low:2};return h.sort((t,e)=>g[t.alertLevel]-g[e.alertLevel]),h.slice(0,10)}catch(t){return[]}}async getAnalyticsData(t,e){try{const o=new Date,r=new Date(o.getFullYear(),o.getMonth(),1),i=new Date(o.getFullYear(),o.getMonth()-1,1),s=new Date(o.getFullYear(),o.getMonth(),0,23,59,59),c=a();let d=n.from("customer_payments").select("amount, payment_date, status");c&&(d=d.eq("branch_id",c)),t&&e&&(d=d.gte("payment_date",t).lte("payment_date",e));const{data:l,error:u}=await d;if(u)throw u;const m=l||[],p=m.filter(t=>new Date(t.payment_date)>=r&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),h=m.filter(t=>new Date(t.payment_date)>=i&&new Date(t.payment_date)<=s&&"completed"===t.status).reduce((t,e)=>t+(Number(e.amount)||0),0),g=h>0?Math.round((p-h)/h*100):0;let _=n.from("customers").select("id, joined_date");c&&(_=_.eq("branch_id",c));const{data:y}=await _,w=y||[],f=w.filter(t=>new Date(t.joined_date)>=r).length,v=w.filter(t=>new Date(t.joined_date)>=i&&new Date(t.joined_date)<=s).length,D=v>0?Math.round((f-v)/v*100):0,b=new Date;b.setHours(0,0,0,0);let S=n.from("lats_sales").select("total_amount, created_at");c&&(S=S.eq("branch_id",c));const{data:N}=await S,T=N||[],q=T.length>0?T.reduce((t,e)=>t+(Number(e.total_amount)||0),0)/T.length:0,M=T.filter(t=>new Date(t.created_at)>=b).length;return{revenueGrowth:g,customerGrowth:D,averageOrderValue:Math.round(q),completedToday:M}}catch(o){return{revenueGrowth:0,customerGrowth:0,averageOrderValue:0,completedToday:0}}}getDefaultStats(){return{totalDevices:0,totalCustomers:0,totalEmployees:0,totalRevenue:0,activeDevices:0,completedDevices:0,pendingDevices:0,overdueDevices:0,devicesInRepair:0,presentToday:0,onLeaveToday:0,attendanceRate:0,newCustomersThisMonth:0,activeCustomers:0,revenueThisMonth:0,revenueThisWeek:0,revenueToday:0,pendingPayments:0,unreadNotifications:0,urgentNotifications:0,appointmentsToday:0,appointmentsThisWeek:0,upcomingAppointments:0,todayAppointments:0,appointmentCompletionRate:0,lowStockItems:0,criticalStockAlerts:0,totalProducts:0,inventoryValue:0}}};export{i as d};
