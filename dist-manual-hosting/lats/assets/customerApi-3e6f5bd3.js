import{_ as e}from"./supabase-7e851d02.js";import{s as t,Y as a,X as r}from"./index-222cfb29.js";import{m as n,a0 as o,_ as s,o as c,$ as i,i as u,n as m}from"./index-222cfb29.js";import{c as l,d,f as p,a as _,g as h,s as y,u as v}from"./appointments-4d8aac45.js";import{c as f,g,d as w,a as b,b as C,s as N}from"./search-674d386b.js";import"./vendor-a2ff445a.js";import"./routing-a2f0f6d2.js";import"./ui-551a39a6.js";async function R(e){try{const{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return[];const{data:n,error:o}=await t.from("customer_payments").select("\n        *,\n        customers(name),\n        devices(device_name)\n      ").eq("customer_id",e).order("payment_date",{ascending:!1});if(o)throw o;return(null==n?void 0:n.map(e=>{var t,a;return{id:e.id,customer_id:e.customer_id,revenue_type:"device_payment"===e.payment_type?"device_repair":"pos_payment"===e.payment_type?"pos_sale":"service_payment"===e.payment_type?"service_fee":"consultation",amount:e.amount,transaction_date:e.payment_date,order_id:e.device_id,device_id:e.device_id,description:`${e.payment_type} payment`,created_at:e.created_at,customer_name:null==(t=e.customers)?void 0:t.name,device_name:null==(a=e.devices)?void 0:a.device_name}}))||[]}catch(a){throw a}}async function S(e){try{const{data:{user:a},error:r}=await t.auth.getUser();if(r||!a)return{totalRevenue:0,deviceRevenue:0,posRevenue:0,serviceRevenue:0,consultationRevenue:0,transactionCount:0,averageTransaction:0};const{data:n,error:o}=await t.from("customer_payments").select("payment_type, amount, payment_date").eq("customer_id",e);if(o)throw o;const s=n||[],c=s.reduce((e,t)=>e+Number(t.amount),0),i=s.filter(e=>"device_payment"===e.payment_type).reduce((e,t)=>e+Number(t.amount),0),u=s.filter(e=>"pos_payment"===e.payment_type).reduce((e,t)=>e+Number(t.amount),0),m=s.filter(e=>"service_payment"===e.payment_type).reduce((e,t)=>e+Number(t.amount),0),l=s.filter(e=>"consultation_payment"===e.payment_type).reduce((e,t)=>e+Number(t.amount),0),d=s.length,p=d>0?c/d:0,_=s.length>0?s.sort((e,t)=>new Date(t.payment_date).getTime()-new Date(e.payment_date).getTime())[0].payment_date:void 0;return{totalRevenue:c,deviceRevenue:i,posRevenue:u,serviceRevenue:m,consultationRevenue:l,transactionCount:d,averageTransaction:p,lastTransactionDate:_}}catch(a){throw a}}async function D(e){try{const{data:a,error:r}=await t.from("customer_revenue").insert([{...e,transaction_date:(new Date).toISOString()}]).select().single();if(r)throw r;return a}catch(a){throw a}}async function A(){try{const{data:e,error:a}=await t.from("customer_revenue").select("revenue_type, amount, customer_id");if(a)throw a;const r=e||[],n=r.reduce((e,t)=>e+Number(t.amount),0),o=r.filter(e=>"device_repair"===e.revenue_type).reduce((e,t)=>e+Number(t.amount),0),s=r.filter(e=>"pos_sale"===e.revenue_type).reduce((e,t)=>e+Number(t.amount),0),c=r.filter(e=>"service_fee"===e.revenue_type).reduce((e,t)=>e+Number(t.amount),0),i=r.filter(e=>"consultation"===e.revenue_type).reduce((e,t)=>e+Number(t.amount),0),u=new Set(r.map(e=>e.customer_id)).size;return{totalRevenue:n,deviceRevenue:o,posRevenue:s,serviceRevenue:c,consultationRevenue:i,customerCount:u,averageRevenuePerCustomer:u>0?n/u:0}}catch(e){throw e}}async function P(e,a){try{const{data:r,error:n}=await t.from("customer_revenue").select("\n        *,\n        customers(name),\n        devices(device_name)\n      ").gte("transaction_date",e).lte("transaction_date",a).order("transaction_date",{ascending:!1});if(n)throw n;return(null==r?void 0:r.map(e=>{var t,a;return{...e,customer_name:null==(t=e.customers)?void 0:t.name,device_name:null==(a=e.devices)?void 0:a.device_name}}))||[]}catch(r){throw r}}async function j(e=10){try{const{data:a,error:r}=await t.from("customer_revenue").select("\n        customer_id,\n        amount,\n        customers(name)\n      ");if(r)throw r;const n=new Map;null==a||a.forEach(e=>{var t;const a=e.customer_id,r=(null==(t=e.customers)?void 0:t.name)||"Unknown",o=Number(e.amount);if(n.has(a)){const e=n.get(a);e.total+=o,e.count+=1}else n.set(a,{name:r,total:o,count:1})});return Array.from(n.entries()).map(([e,t])=>({customer_id:e,customer_name:t.name,total_revenue:t.total,transaction_count:t.count})).sort((e,t)=>t.total_revenue-e.total_revenue).slice(0,e)}catch(a){throw a}}function k(e){if(!e)return"new";return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[e.trim().toLowerCase()]||"new"}async function T(a=1,r=50){try{const o=(a-1)*r;let s=t.from("customers").select("\n        id, name, email, phone, created_at, branch_id, is_shared, created_by_branch_name\n      ",{count:"exact"}).range(o,o+r-1).order("created_at",{ascending:!1});const{addBranchFilter:c}=await e(()=>import("./index-222cfb29.js").then(e=>e.aV),["assets/index-222cfb29.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/index-d3868143.css"]);s=await c(s,"customers");const{data:i,error:u,count:m}=await s;if(u)throw u;if(i){let e={};try{const a=[...new Set(i.map(e=>e.branch_id).filter(Boolean))];if(a.length>0){const r=t.from("store_locations").select("id, name").in("id",a),n=await r;n.data&&(e=n.data.reduce((e,t)=>(e[t.id]=t.name,e),{}))}}catch(n){}const o=i.map(t=>({...t,joined_date:t.created_at,colorTag:k(t.color_tag||"new"),branchName:e[t.branch_id]||t.created_by_branch_name||"Unknown Branch",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]})),s=Math.ceil((m||0)/r);return{customers:o,totalCount:m||0,total:m||0,page:a,pageSize:r,totalPages:s,hasNextPage:a<s,hasPreviousPage:a>1}}return{customers:[],totalCount:0,total:0,page:a,pageSize:r,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}}catch(o){throw o}}async function B(e){try{const{data:a,error:r}=await t.from("customers").select("\n        id,\n        name,\n        phone,\n        email,\n        gender,\n        city,\n        color_tag,\n        loyalty_level,\n        points,\n        total_spent,\n        last_visit,\n        is_active,\n        referral_source,\n        birth_month,\n        birth_day,\n        initial_notes,\n        notes,\n        customer_tag,\n        location_description,\n        national_id,\n        joined_date,\n        created_at,\n        updated_at\n      ").eq("id",e).single();if(r)throw r;if(a){return{id:a.id,name:a.name,phone:a.phone,email:a.email,gender:a.gender||"other",city:a.city||"",colorTag:k(a.color_tag||"new"),loyaltyLevel:a.loyalty_level||"interested",points:a.points||0,totalSpent:a.total_spent||0,lastVisit:a.last_visit||a.created_at,isActive:!1!==a.is_active,referralSource:a.referral_source,birthMonth:a.birth_month,birthDay:a.birth_day,totalReturns:0,profileImage:null,whatsapp:a.phone,whatsappOptOut:!1,initialNotes:a.initial_notes,locationDescription:a.location_description,nationalId:a.national_id,notes:a.notes?"string"==typeof a.notes?(()=>{try{return JSON.parse(a.notes)}catch{return[]}})():a.notes:[],referrals:[],customerTag:a.customer_tag,joinedDate:a.joined_date||a.created_at,createdAt:a.created_at,updatedAt:a.updated_at,address:null,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]}}return null}catch(a){throw a}}async function x(e){try{const{error:a}=await t.from("customers").delete().eq("id",e);if(a)throw a;return!0}catch(a){throw a}}async function I(e,n){try{try{const{data:r,error:n}=await t.from("customers").select("is_active, name").eq("id",e).single();n||!r||r.is_active||await a(e)}catch(o){}const{error:c}=await t.from("customer_checkins").insert([{customer_id:e,staff_id:n,checkin_at:(new Date).toISOString()}]);if(c)return{success:!1,message:"Failed to check in customer"};try{await r(e,"checkin")}catch(s){}return{success:!0,message:"Customer checked in successfully"}}catch(c){return{success:!1,message:"Failed to check in customer"}}}async function M(e){try{const{data:e,error:a}=await t.from("customers").select("id, name").limit(1);return a?{success:!1,error:a}:{success:!0,data:e}}catch(a){return{success:!1,error:a}}}async function O(){try{const{data:e,error:a}=await t.from("customers").select("id, name").limit(1);return a?{success:!1,error:a,type:"simple"}:{success:!0,type:"all"}}catch(e){return{success:!1,error:e,type:"exception"}}}export{D as addCustomerRevenue,n as addCustomerToDb,I as checkInCustomer,f as clearSearchCache,l as createAppointment,o as createCustomer,d as deleteAppointment,x as deleteCustomerFromDb,p as fetchAllAppointments,s as fetchAllCustomers,c as fetchAllCustomersSimple,_ as fetchCustomerAppointments,i as fetchCustomerById,R as fetchCustomerRevenue,T as fetchCustomersPaginated,u as formatCurrency,A as getAllCustomersRevenueSummary,h as getAppointmentStats,g as getBackgroundSearchManager,S as getCustomerRevenueSummary,P as getRevenueByDateRange,w as getSearchCacheStats,j as getTopCustomersByRevenue,B as loadCustomerDetails,y as searchAppointments,b as searchCustomers,C as searchCustomersBackground,N as searchCustomersFast,M as testCustomerAccess,O as testCustomerQuery,v as updateAppointment,m as updateCustomerInDb};
