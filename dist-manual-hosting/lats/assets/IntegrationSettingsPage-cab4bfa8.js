import{s as e,j as s,d as a,G as t}from"./index-222cfb29.js";import{r}from"./vendor-a2ff445a.js";import{z as n,R as l,aa as i,m as c,s as o,aA as d,j as m,ak as p,q as x,aQ as h,I as u,N as g,A as b,d as y,h as j}from"./ui-551a39a6.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";const f=()=>{var f,v;const[w,N]=r.useState(!0),[k,S]=r.useState(!1),[C,I]=r.useState(null),[A,P]=r.useState({}),[_,M]=r.useState("sms"),[T,U]=r.useState({sms:{enabled:!1,provider:"mshastra",apiKey:"",senderId:"LATS POS",webhookUrl:""},whatsapp:{enabled:!1,provider:"greenapi",instanceId:"",apiToken:"",apiUrl:"https://7105.api.greenapi.com",webhookUrl:""},mpesa:{enabled:!1,businessShortcode:"",consumerKey:"",consumerSecret:"",passkey:"",callbackUrl:"",environment:"sandbox"},tigopesa:{enabled:!1,merchantCode:"",merchantPin:"",apiUrl:"https://api.tigo.co.tz",callbackUrl:""},airtelmoney:{enabled:!1,merchantCode:"",apiKey:"",apiUrl:"https://api.airtel.co.tz",callbackUrl:""},email:{enabled:!1,provider:"smtp",host:"",port:587,username:"",password:"",fromEmail:"",fromName:"LATS CHANCE"}}),[E,F]=r.useState({});r.useEffect(()=>{K()},[]);const K=async()=>{N(!0);try{const{data:s,error:a}=await e.from("integration_settings").select("*");if(a)throw a;if(s&&s.length>0){const e={...T};s.forEach(s=>{const a=s.integration_type,t=s.config||{};switch(a){case"sms":e.sms={enabled:s.is_enabled,provider:s.provider||"mshastra",...t};break;case"whatsapp":e.whatsapp={enabled:s.is_enabled,provider:s.provider||"greenapi",...t};break;case"mpesa":e.mpesa={enabled:s.is_enabled,...t};break;case"tigopesa":e.tigopesa={enabled:s.is_enabled,...t};break;case"airtelmoney":e.airtelmoney={enabled:s.is_enabled,...t};break;case"email":e.email={enabled:s.is_enabled,provider:s.provider||"smtp",...t}}F(e=>({...e,[a]:{status:"active"===s.status?"connected":"disconnected",message:s.last_test_result,lastChecked:s.last_test_date?new Date(s.last_test_date):void 0}}))}),U(e)}}catch(s){n.error("Failed to load integration settings")}finally{N(!1)}},D=async s=>{I(s);try{let a={success:!1,message:""};switch(s){case"sms":a=await $();break;case"whatsapp":a=await z();break;case"mpesa":a=await R();break;case"email":a=await W()}F(e=>({...e,[s]:{status:a.success?"connected":"error",message:a.message,lastChecked:new Date}})),await e.from("integration_settings").update({status:a.success?"active":"error",last_test_date:(new Date).toISOString(),last_test_result:a.message}).eq("integration_type",s),a.success?n.success(`${s.toUpperCase()} connection successful!`):n.error(`${s.toUpperCase()} connection failed: ${a.message}`)}catch(a){n.error(`Test failed: ${a.message}`),F(e=>({...e,[s]:{status:"error",message:a.message,lastChecked:new Date}}))}finally{I(null)}},$=async()=>T.sms.apiKey?{success:!0,message:"SMS credentials verified. Ready to send messages."}:{success:!1,message:"API key is required"},z=async()=>{if(!T.whatsapp.instanceId||!T.whatsapp.apiToken)return{success:!1,message:"Instance ID and API token are required"};try{const e=`${T.whatsapp.apiUrl}/waInstance${T.whatsapp.instanceId}/getStateInstance/${T.whatsapp.apiToken}`,s=await fetch(e),a=await s.json();return"authorized"===a.stateInstance?{success:!0,message:`Connected to WhatsApp. Phone: ${a.phoneNumber||"N/A"}`}:{success:!1,message:`Status: ${a.stateInstance}. Scan QR code to authorize.`}}catch(e){return{success:!1,message:e.message}}},R=async()=>T.mpesa.consumerKey&&T.mpesa.consumerSecret?{success:!0,message:"M-Pesa credentials verified. Ready to accept payments."}:{success:!1,message:"Consumer key and secret are required"},W=async()=>{if("smtp"===T.email.provider){if(!T.email.host||!T.email.username||!T.email.password)return{success:!1,message:"SMTP credentials incomplete"}}else if(!T.email.apiKey)return{success:!1,message:"API key is required"};return{success:!0,message:"Email configuration valid. Ready to send emails."}},q=e=>{P(s=>({...s,[e]:!s[e]}))},L=e=>{const a=E[e];if(!a)return s.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-500",children:[s.jsx(b,{className:"w-4 h-4"}),"Not Configured"]});return{connected:s.jsxs("span",{className:"flex items-center gap-2 text-sm text-green-600",children:[s.jsx(y,{className:"w-4 h-4"}),"Connected"]}),disconnected:s.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-500",children:[s.jsx(j,{className:"w-4 h-4"}),"Disconnected"]}),error:s.jsxs("span",{className:"flex items-center gap-2 text-sm text-red-600",children:[s.jsx(b,{className:"w-4 h-4"}),"Error"]}),unknown:s.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-400",children:[s.jsx(u,{className:"w-4 h-4"}),"Unknown"]})}[a.status]};return w?s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsx(l,{className:"w-8 h-8 animate-spin text-blue-600"})}):s.jsxs("div",{className:"max-w-6xl mx-auto p-6 space-y-6",children:[s.jsxs("div",{children:[s.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[s.jsx(i,{className:"w-8 h-8 text-blue-600"}),"Integration Settings"]}),s.jsx("p",{className:"text-gray-600 mt-2",children:"Configure SMS, WhatsApp, Mobile Money, and Email integrations"})]}),s.jsx("div",{className:"flex gap-2 border-b border-gray-200 overflow-x-auto",children:[{id:"sms",label:"SMS",icon:c},{id:"whatsapp",label:"WhatsApp",icon:o},{id:"mobile-money",label:"Mobile Money",icon:d},{id:"email",label:"Email",icon:m}].map(e=>s.jsxs("button",{onClick:()=>M(e.id),className:"flex items-center gap-2 px-4 py-3 font-medium transition-colors border-b-2 "+(_===e.id?"border-blue-600 text-blue-600":"border-transparent text-gray-600 hover:text-gray-900"),children:[s.jsx(e.icon,{className:"w-5 h-5"}),e.label]},e.id))}),"sms"===_&&s.jsxs(a,{className:"p-6 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[s.jsx(c,{className:"w-6 h-6 text-blue-600"}),"SMS Integration"]}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Configure SMS provider for sending receipts and notifications"})]}),L("sms")]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("input",{type:"checkbox",id:"sms-enabled",checked:T.sms.enabled,onChange:e=>U({...T,sms:{...T.sms,enabled:e.target.checked}}),className:"w-5 h-5 text-blue-600 rounded"}),s.jsx("label",{htmlFor:"sms-enabled",className:"font-medium",children:"Enable SMS Integration"})]}),T.sms.enabled&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SMS Provider"}),s.jsxs("select",{value:T.sms.provider,onChange:e=>U({...T,sms:{...T.sms,provider:e.target.value}}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"mshastra",children:"MShastra (Tanzania)"}),s.jsx("option",{value:"africastalking",children:"Africa's Talking"}),s.jsx("option",{value:"twilio",children:"Twilio"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"API Key *"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:A["sms-api-key"]?"text":"password",value:T.sms.apiKey,onChange:e=>U({...T,sms:{...T.sms,apiKey:e.target.value}}),placeholder:"Enter your SMS API key",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),s.jsx("button",{type:"button",onClick:()=>q("sms-api-key"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700",children:A["sms-api-key"]?s.jsx(p,{className:"w-5 h-5"}):s.jsx(x,{className:"w-5 h-5"})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sender ID"}),s.jsx("input",{type:"text",value:T.sms.senderId,onChange:e=>U({...T,sms:{...T.sms,senderId:e.target.value}}),placeholder:"e.g., LATS POS",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),s.jsx(t,{onClick:()=>D("sms"),disabled:"sms"===C,className:"w-full",children:"sms"===C?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):s.jsxs(s.Fragment,{children:[s.jsx(h,{className:"w-5 h-5"}),"Test SMS Connection"]})}),(null==(f=E.sms)?void 0:f.message)&&s.jsx("div",{className:"p-3 rounded-lg text-sm "+("connected"===E.sms.status?"bg-green-50 text-green-800":"bg-red-50 text-red-800"),children:E.sms.message})]})]}),"whatsapp"===_&&s.jsxs(a,{className:"p-6 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[s.jsx(o,{className:"w-6 h-6 text-green-600"}),"WhatsApp Integration"]}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Send receipts and messages via WhatsApp"})]}),L("whatsapp")]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("input",{type:"checkbox",id:"whatsapp-enabled",checked:T.whatsapp.enabled,onChange:e=>U({...T,whatsapp:{...T.whatsapp,enabled:e.target.checked}}),className:"w-5 h-5 text-green-600 rounded"}),s.jsx("label",{htmlFor:"whatsapp-enabled",className:"font-medium",children:"Enable WhatsApp Integration"})]}),T.whatsapp.enabled&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Instance ID *"}),s.jsx("input",{type:"text",value:T.whatsapp.instanceId,onChange:e=>U({...T,whatsapp:{...T.whatsapp,instanceId:e.target.value}}),placeholder:"Your Green API Instance ID",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"API Token *"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:A["whatsapp-token"]?"text":"password",value:T.whatsapp.apiToken,onChange:e=>U({...T,whatsapp:{...T.whatsapp,apiToken:e.target.value}}),placeholder:"Your Green API Token",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"}),s.jsx("button",{type:"button",onClick:()=>q("whatsapp-token"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700",children:A["whatsapp-token"]?s.jsx(p,{className:"w-5 h-5"}):s.jsx(x,{className:"w-5 h-5"})})]})]}),s.jsx(t,{onClick:()=>D("whatsapp"),disabled:"whatsapp"===C,className:"w-full bg-green-600 hover:bg-green-700",children:"whatsapp"===C?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):s.jsxs(s.Fragment,{children:[s.jsx(h,{className:"w-5 h-5"}),"Test WhatsApp Connection"]})}),(null==(v=E.whatsapp)?void 0:v.message)&&s.jsx("div",{className:"p-3 rounded-lg text-sm "+("connected"===E.whatsapp.status?"bg-green-50 text-green-800":"bg-yellow-50 text-yellow-800"),children:E.whatsapp.message})]})]}),"mobile-money"===_&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs(a,{className:"p-6 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[s.jsx(d,{className:"w-6 h-6 text-red-600"}),"M-Pesa Integration"]}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Accept M-Pesa payments from customers"})]}),L("mpesa")]}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("input",{type:"checkbox",id:"mpesa-enabled",checked:T.mpesa.enabled,onChange:e=>U({...T,mpesa:{...T.mpesa,enabled:e.target.checked}}),className:"w-5 h-5 text-red-600 rounded"}),s.jsx("label",{htmlFor:"mpesa-enabled",className:"font-medium",children:"Enable M-Pesa Payments"})]}),T.mpesa.enabled&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Environment"}),s.jsxs("select",{value:T.mpesa.environment,onChange:e=>U({...T,mpesa:{...T.mpesa,environment:e.target.value}}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500",children:[s.jsx("option",{value:"sandbox",children:"Sandbox (Testing)"}),s.jsx("option",{value:"production",children:"Production (Live)"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Business Shortcode *"}),s.jsx("input",{type:"text",value:T.mpesa.businessShortcode,onChange:e=>U({...T,mpesa:{...T.mpesa,businessShortcode:e.target.value}}),placeholder:"e.g., 174379",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Consumer Key *"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:A["mpesa-key"]?"text":"password",value:T.mpesa.consumerKey,onChange:e=>U({...T,mpesa:{...T.mpesa,consumerKey:e.target.value}}),placeholder:"Consumer Key from Daraja",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),s.jsx("button",{type:"button",onClick:()=>q("mpesa-key"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:A["mpesa-key"]?s.jsx(p,{className:"w-5 h-5"}):s.jsx(x,{className:"w-5 h-5"})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Consumer Secret *"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:A["mpesa-secret"]?"text":"password",value:T.mpesa.consumerSecret,onChange:e=>U({...T,mpesa:{...T.mpesa,consumerSecret:e.target.value}}),placeholder:"Consumer Secret from Daraja",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),s.jsx("button",{type:"button",onClick:()=>q("mpesa-secret"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:A["mpesa-secret"]?s.jsx(p,{className:"w-5 h-5"}):s.jsx(x,{className:"w-5 h-5"})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Passkey *"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:A["mpesa-passkey"]?"text":"password",value:T.mpesa.passkey,onChange:e=>U({...T,mpesa:{...T.mpesa,passkey:e.target.value}}),placeholder:"Lipa Na M-Pesa Online Passkey",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),s.jsx("button",{type:"button",onClick:()=>q("mpesa-passkey"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:A["mpesa-passkey"]?s.jsx(p,{className:"w-5 h-5"}):s.jsx(x,{className:"w-5 h-5"})})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Callback URL"}),s.jsx("input",{type:"url",value:T.mpesa.callbackUrl,onChange:e=>U({...T,mpesa:{...T.mpesa,callbackUrl:e.target.value}}),placeholder:"https://yourdomain.com/api/mpesa/callback",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"})]}),s.jsx(t,{onClick:()=>D("mpesa"),disabled:"mpesa"===C,className:"w-full bg-red-600 hover:bg-red-700",children:"mpesa"===C?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):s.jsxs(s.Fragment,{children:[s.jsx(h,{className:"w-5 h-5"}),"Test M-Pesa Connection"]})})]})]}),s.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:s.jsxs("div",{className:"flex gap-3",children:[s.jsx(u,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),s.jsxs("div",{className:"text-sm text-blue-900",children:[s.jsx("p",{className:"font-medium mb-1",children:"Need M-Pesa Credentials?"}),s.jsxs("p",{children:["Visit ",s.jsx("a",{href:"https://developer.mpesa.vm.co.tz",target:"_blank",rel:"noopener noreferrer",className:"underline",children:"developer.mpesa.vm.co.tz"})," to register your business and get API credentials."]})]})]})})]}),s.jsxs("div",{className:"flex gap-4 justify-end sticky bottom-4",children:[s.jsxs(t,{onClick:K,variant:"secondary",children:[s.jsx(l,{className:"w-5 h-5"}),"Reset Changes"]}),s.jsx(t,{onClick:async()=>{S(!0);try{const s=[{type:"sms",data:T.sms,provider:T.sms.provider},{type:"whatsapp",data:T.whatsapp,provider:T.whatsapp.provider},{type:"mpesa",data:T.mpesa,provider:"vodacom"},{type:"tigopesa",data:T.tigopesa,provider:"tigo"},{type:"airtelmoney",data:T.airtelmoney,provider:"airtel"},{type:"email",data:T.email,provider:T.email.provider}];for(const a of s){const{type:s,data:t,provider:r}=a,{enabled:n,...l}=t,{error:i}=await e.from("integration_settings").upsert({integration_type:s,is_enabled:n,provider:r,config:l,status:n?"active":"inactive",updated_at:(new Date).toISOString()},{onConflict:"integration_type"});if(i)throw i}n.success("Integration settings saved successfully!")}catch(s){n.error("Failed to save integration settings")}finally{S(!1)}},disabled:k,className:"bg-blue-600 hover:bg-blue-700 text-white",children:k?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-5 h-5 animate-spin"}),"Saving..."]}):s.jsxs(s.Fragment,{children:[s.jsx(g,{className:"w-5 h-5"}),"Save All Settings"]})})]})]})};export{f as default};
