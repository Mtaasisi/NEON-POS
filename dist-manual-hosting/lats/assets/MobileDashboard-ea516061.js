import{s as e,j as t}from"./index-222cfb29.js";import{r as s}from"./vendor-a2ff445a.js";import"./supabase-460661f2.js";import{R as a,ah as r,bu as l,e as i,D as n,t as o,x as d,f as c,ao as x,V as m,ax as u,z as h}from"./ui-551a39a6.js";import{u as p,a as b}from"./useMobileBranch-1aee679b.js";import{a as g}from"./routing-a2f0f6d2.js";import"./supabase-7e851d02.js";const f=()=>{const f=g(),{currentBranch:j,loading:y,isDataShared:v}=p(),[N,w]=s.useState({todaySales:0,todayOrders:0,lowStock:0,totalRevenue:0,totalCustomers:0,totalProducts:0,yesterdaySales:0,yesterdayOrders:0}),[k,S]=s.useState([]),[_,z]=s.useState(!0),[W,C]=s.useState(!1);s.useState(0);const[F,M]=s.useState(0);s.useRef(null);const R=[{label:"New Sale",path:"/mobile/pos",icon:m},{label:"Reports",path:"/mobile/analytics",icon:u}],$=e=>{if(0===e||null==e)return"0";if(isNaN(e)||!isFinite(e))return"0";if(e>1e15||e<-1e15)return"0";const t=Math.abs(e);return t>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":t>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toFixed(0)},D=e=>{if(!e)return 0;let t=e;return"string"==typeof t&&(t=parseFloat(t.replace(/[^0-9.-]/g,""))),isNaN(t)||!isFinite(t)||t>1e15?0:(t>1e8&&(t/=100),Math.max(0,t))},O=e=>{const t=new Date(e),s=(new Date).getTime()-t.getTime(),a=Math.floor(s/6e4),r=Math.floor(s/36e5),l=Math.floor(s/864e5);return a<1?"Just now":a<60?`${a} min ago`:r<24?`${r} hour${r>1?"s":""} ago`:`${l} day${l>1?"s":""} ago`},T=async(t=!0)=>{if(!y)try{const s=new Date;s.setHours(0,0,0,0);const a=new Date(s);a.setDate(a.getDate()-1);let r=e.from("lats_sales").select("*").gte("created_at",s.toISOString()),l=e.from("lats_customers").select("id, total_spent"),i=e.from("lats_products").select("id, stock_quantity, min_stock_level").eq("is_active",!0),n=e.from("lats_sales").select("*").order("created_at",{ascending:!1}).limit(10);if(j){r=r.eq("branch_id",j.id),n=n.eq("branch_id",j.id);const e=v("customers");e||(l=b(l,j.id,j.data_isolation_mode,e));const t=v("products");t||(i=b(i,j.id,j.data_isolation_mode,t))}const{data:o,error:d}=await r,{data:c}=await l,{data:x}=await i,{data:u}=await n;let p=0,g=0;o&&!d&&(g=o.length,p=o.reduce((e,t)=>e+D(t.total_amount||0),0));let f=0;c&&(f=c.reduce((e,t)=>e+D(t.total_spent),0));let y=0;x&&(y=x.filter(e=>(e.stock_quantity||0)<=(e.min_stock_level||10)).length);const N=[];u&&u.slice(0,5).forEach(e=>{const t=D(e.total_amount||0);N.push({id:e.id,title:"New sale completed",amount:"TSh "+$(t),time:O(e.created_at),icon:m,type:"sale"})}),w({todaySales:p,todayOrders:g,lowStock:y,totalRevenue:f,totalCustomers:(null==c?void 0:c.length)||0,totalProducts:(null==x?void 0:x.length)||0,yesterdaySales:0,yesterdayOrders:0}),S(N),t&&h.success("Dashboard updated")}catch(s){h.error("Failed to load dashboard data")}};s.useEffect(()=>{const e=async()=>{z(!0),await T(!1),z(!1)};e();const t=()=>{e()};return window.addEventListener("branchChanged",t),()=>{window.removeEventListener("branchChanged",t)}},[j,y]),s.useEffect(()=>{const t=e.channel("sales-changes").on("postgres_changes",{event:"*",schema:"public",table:"lats_sales"},()=>T(!1)).subscribe(),s=e.channel("products-changes").on("postgres_changes",{event:"*",schema:"public",table:"lats_products"},()=>T(!1)).subscribe();return()=>{t.unsubscribe(),s.unsubscribe()}},[]);const E=(e,t)=>{if(0===t)return{value:e>0?"+100%":"0%",trend:"up"};const s=(e-t)/t*100;return{value:`${s>=0?"+":""}${s.toFixed(0)}%`,trend:s>=0?"up":"down"}},q=E(N.todaySales,N.yesterdaySales);return E(N.todayOrders,N.yesterdayOrders),t.jsx("div",{className:"flex flex-col h-full bg-white overflow-hidden",children:t.jsxs("div",{className:"flex-1 overflow-y-auto pb-20",children:[t.jsx("div",{className:"px-4 pt-3 pb-2",children:t.jsx("h1",{className:"text-[32px] font-bold text-black tracking-tight",children:"Home"})}),_&&t.jsx("div",{className:"flex-1 flex items-center justify-center min-h-[400px]",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-3"}),t.jsx("p",{className:"text-gray-500 text-[15px]",children:"Loading dashboard..."})]})}),F>0&&!_&&t.jsxs("div",{className:"flex items-center justify-center py-2 transition-all",style:{transform:`translateY(${Math.min(F,80)}px)`,opacity:Math.min(F/80,1)},children:[t.jsx(a,{size:20,className:"text-blue-500 "+(W||F>80?"animate-spin":""),strokeWidth:2.5}),t.jsx("span",{className:"ml-2 text-[14px] text-blue-500 font-medium",children:F>80?"Release to refresh":"Pull to refresh"})]}),!_&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"px-4 py-3 bg-gradient-to-br from-blue-50 to-indigo-50 border-y border-blue-100",children:[t.jsx("div",{className:"text-[13px] text-blue-600 mb-2 uppercase tracking-wide font-semibold",children:"TODAY'S SUMMARY"}),t.jsxs("div",{className:"flex items-baseline gap-2",children:[t.jsxs("span",{className:"text-[28px] font-bold text-gray-900",children:["TSh ",$(N.todaySales)]}),t.jsxs("span",{className:"text-[15px] font-medium flex items-center gap-1 "+("up"===q.trend?"text-green-600":"text-red-600"),children:["up"===q.trend?t.jsx(r,{size:14,strokeWidth:3}):t.jsx(l,{size:14,strokeWidth:3}),q.value]})]}),t.jsxs("div",{className:"text-[15px] text-gray-700 mt-1 flex items-center gap-2",children:[t.jsxs("span",{children:[N.todayOrders," orders"]}),N.lowStock>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"Â·"}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(i,{size:14,className:"text-orange-500"}),N.lowStock," items low stock"]})]})]})]}),t.jsx("div",{className:"px-4 py-3 border-b border-gray-200",children:t.jsx("div",{className:"flex gap-2",children:R.map((e,s)=>{const a=e.icon;return t.jsxs("button",{onClick:()=>f(e.path),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-[13px] font-medium shadow-sm",children:[t.jsx(a,{size:18,strokeWidth:2.5}),t.jsx("span",{children:e.label})]},s)})})}),t.jsxs("div",{className:"px-4 py-4 border-b border-gray-200",children:[t.jsx("div",{className:"text-[13px] text-gray-500 mb-3 uppercase tracking-wide font-semibold",children:"OVERVIEW"}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",style:{display:"grid",gridTemplateColumns:"1fr 1fr"},children:[t.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl border border-purple-200 shadow-sm",children:[t.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center flex-shrink-0",children:t.jsx(n,{size:22,className:"text-purple-600",strokeWidth:2.5})}),t.jsxs("div",{className:"flex-1 text-left min-w-0",children:[t.jsx("div",{className:"text-[11px] text-purple-700 uppercase font-semibold mb-0.5",children:"Revenue"}),t.jsxs("div",{className:"text-[18px] font-bold text-purple-900 truncate",children:["TSh ",$(N.totalRevenue)]})]})]}),t.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl border border-green-200 shadow-sm",children:[t.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center flex-shrink-0",children:t.jsx(o,{size:22,className:"text-green-600",strokeWidth:2.5})}),t.jsxs("div",{className:"flex-1 text-left min-w-0",children:[t.jsx("div",{className:"text-[11px] text-green-700 uppercase font-semibold mb-0.5",children:"Customers"}),t.jsx("div",{className:"text-[18px] font-bold text-green-900",children:N.totalCustomers})]})]}),t.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200 shadow-sm",children:[t.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0",children:t.jsx(d,{size:22,className:"text-blue-600",strokeWidth:2.5})}),t.jsxs("div",{className:"flex-1 text-left min-w-0",children:[t.jsx("div",{className:"text-[11px] text-blue-700 uppercase font-semibold mb-0.5",children:"Products"}),t.jsx("div",{className:"text-[18px] font-bold text-blue-900",children:N.totalProducts})]})]}),t.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br rounded-2xl border shadow-sm "+(N.lowStock>0?"from-orange-50 to-orange-100 border-orange-200":"from-gray-50 to-gray-100 border-gray-200"),children:[t.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 "+(N.lowStock>0?"bg-orange-100":"bg-gray-100"),children:t.jsx(i,{size:22,className:N.lowStock>0?"text-orange-600":"text-gray-600",strokeWidth:2.5})}),t.jsxs("div",{className:"flex-1 text-left min-w-0",children:[t.jsx("div",{className:"text-[11px] uppercase font-semibold mb-0.5 "+(N.lowStock>0?"text-orange-700":"text-gray-700"),children:"Low Stock"}),t.jsx("div",{className:"text-[18px] font-bold "+(N.lowStock>0?"text-orange-900":"text-gray-900"),children:N.lowStock})]})]})]})]}),t.jsxs("div",{className:"pb-4",children:[t.jsx("div",{className:"px-4 pt-4 pb-2",children:t.jsx("div",{className:"text-[13px] text-gray-500 uppercase tracking-wide font-semibold",children:"RECENT ACTIVITY"})}),k.length>0?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-b border-gray-200",children:k.map((e,s)=>{const a=e.icon,r=s===k.length-1;return t.jsxs("div",{className:"px-4 py-3 flex items-center justify-between border-b border-gray-200 hover:bg-gray-50 active:bg-gray-100 transition-colors",style:{borderBottomWidth:r?"0":"0.5px"},children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0",children:t.jsx(a,{size:18,className:"text-blue-500",strokeWidth:2})}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("div",{className:"text-[16px] text-gray-900 truncate",children:e.title}),t.jsxs("div",{className:"text-[13px] text-gray-500 flex items-center gap-1",children:[t.jsx(c,{size:11}),e.time]})]})]}),t.jsx("div",{className:"text-[15px] font-semibold text-blue-500 flex-shrink-0 ml-2",children:e.amount})]},e.id)})}),t.jsxs("button",{onClick:()=>f("/mobile/analytics"),className:"w-full px-4 py-4 flex items-center justify-center gap-2 text-blue-500 hover:bg-gray-50 active:bg-gray-100 transition-colors",children:[t.jsx("span",{className:"text-[16px] font-medium",children:"View All Activity"}),t.jsx(x,{size:18,strokeWidth:2})]})]}):t.jsxs("div",{className:"text-center py-16 px-4",children:[t.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4",children:t.jsx(m,{size:40,className:"text-gray-400",strokeWidth:1.5})}),t.jsx("p",{className:"text-gray-900 text-[17px] font-semibold mb-2",children:"No recent activity"}),t.jsx("p",{className:"text-[15px] text-gray-500 mb-6 max-w-sm mx-auto",children:"Start making sales to see recent activity here"}),t.jsxs("button",{onClick:()=>f("/mobile/pos"),className:"inline-flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm",children:[t.jsx(m,{size:20,strokeWidth:2.5}),"New Sale"]})]})]})]})]})})};export{f as default};
