import{_ as e}from"./supabase-7e851d02.js";import{t,j as a,s,u as r,N as n}from"./index-222cfb29.js";import{r as i,b as c}from"./vendor-a2ff445a.js";import{D as o,aC as l,m as d,aA as m,n as u,X as x,bx as h,e as g,R as b,bd as p,Q as y,g as f}from"./ui-551a39a6.js";import{u as j}from"./useBodyScrollLock-0216d39f.js";const N=({type:e,name:t,size:s="md",className:r="",customIcon:n})=>{const i={sm:"w-4 h-4",md:"w-6 h-6",lg:"w-8 h-8"},c=n||((e,t)=>{const a=e.toLowerCase(),s=(null==t?void 0:t.toLowerCase())||"";return"cash"===a?"/icons/payment-methods/cash-logo.png":"credit_card"===a||"card"===a?"/icons/payment-methods/mastercard-logo.jpg":"mobile_money"===a?s.includes("mpesa")?"/icons/payment-methods/mpesa-google.png":s.includes("airtel")?"/icons/payment-methods/airtel-money.svg":"/icons/payment-methods/mpesa-google.png":"bank"===a||"bank_transfer"===a?(s.includes("crdb"),"/icons/payment-methods/crdb-bank.png"):s.includes("mpesa")?"/icons/payment-methods/mpesa-google.png":s.includes("visa")?"/icons/payment-methods/visa-logo.jpg":s.includes("mastercard")||s.includes("master")?"/icons/payment-methods/mastercard-logo.jpg":s.includes("airtel")?"/icons/payment-methods/airtel-money.svg":s.includes("crdb")||s.includes("bank")&&s.includes("transfer")||s.includes("bank")?"/icons/payment-methods/crdb-bank.png":s.includes("cash")?"/icons/payment-methods/cash-logo.png":null})(e,t);if(c)return/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(c)?a.jsx("span",{className:`${i[s]} ${r} flex items-center justify-center text-lg`,children:c}):a.jsx("img",{src:c,alt:`${t||e} payment method`,className:r||i[s],style:{objectFit:"contain"},onError:e=>{e.currentTarget.style.display="none"}});return(()=>{switch(e.toLowerCase()){case"cash":default:return a.jsx(o,{className:`${i[s]} ${r}`});case"credit_card":case"card":return a.jsx(m,{className:`${i[s]} ${r}`});case"mobile_money":return a.jsx(d,{className:`${i[s]} ${r}`});case"bank":case"bank_transfer":return a.jsx(l,{className:`${i[s]} ${r}`})}})()};const v=new class{async updateDeviceRepairPrice(e){try{const{data:t,error:a}=await s.from("devices").select("repair_price").eq("id",e.deviceId).single();if(a)throw new Error("Failed to fetch current device price");const r=(null==t?void 0:t.repair_price)||0,{error:n}=await s.from("devices").update({repair_price:e.repairPrice,updated_at:(new Date).toISOString()}).eq("id",e.deviceId);if(n)throw new Error("Failed to update device repair price");return await this.recordPriceChange({deviceId:e.deviceId,oldPrice:r,newPrice:e.repairPrice,reason:e.reason||"Price adjustment",updatedBy:e.updatedBy}),!0}catch(t){throw t}}async recordPriceChange(e){try{const{error:t}=await s.from("device_price_history").insert({device_id:e.deviceId,old_price:e.oldPrice,new_price:e.newPrice,reason:e.reason,updated_by:e.updatedBy,updated_at:(new Date).toISOString()})}catch(t){}}async getDevicePriceHistory(e){try{const{data:t,error:a}=await s.from("device_price_history").select("*").eq("device_id",e).order("updated_at",{ascending:!1});if(a)throw a;return t||[]}catch(t){return[]}}async getDeviceRepairPrice(e){try{const{data:t,error:a}=await s.from("devices").select("repair_price").eq("id",e).single();return a?0:(null==t?void 0:t.repair_price)||0}catch(t){return 0}}},w=[{code:"TZS",name:"Tanzanian Shilling",symbol:"TZS",flag:"ðŸ‡¹ðŸ‡¿"},{code:"USD",name:"US Dollar",symbol:"$",flag:"ðŸ‡ºðŸ‡¸"},{code:"EUR",name:"Euro",symbol:"â‚¬",flag:"ðŸ‡ªðŸ‡º"},{code:"GBP",name:"British Pound",symbol:"Â£",flag:"ðŸ‡¬ðŸ‡§"},{code:"AED",name:"UAE Dirham",symbol:"Ø¯.Ø¥",flag:"ðŸ‡¦ðŸ‡ª"},{code:"KES",name:"Kenyan Shilling",symbol:"KSh",flag:"ðŸ‡°ðŸ‡ª"},{code:"CNY",name:"Chinese Yuan",symbol:"Â¥",flag:"ðŸ‡¨ðŸ‡³"}],S=w[0],P=e=>w.find(t=>t.code===e),_=(e,t)=>{const a=((e,t)=>"TZS"===t.code?new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0,maximumFractionDigits:2}).format(e).replace(/\.00$/,"").replace(/\.0$/,""):"AED"===t.code?new Intl.NumberFormat("en-AE",{style:"currency",currency:"AED",minimumFractionDigits:2,maximumFractionDigits:2}).format(e):`${t.symbol}${e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`)(e,t);return`${t.flag} ${a}`},F=(e,t)=>"TZS"===t.code?new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0,maximumFractionDigits:2}).format(e).replace(/\.00$/,"").replace(/\.0$/,""):`${t.symbol}${e.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:2})}`.replace(/\.00$/,"").replace(/\.0$/,""),D=e=>`${e.flag} ${e.code} (${e.symbol})`,I=()=>w.map(e=>({value:e.code,label:D(e),currency:e})),$=({isOpen:s,onClose:l,amount:d,customerId:P,customerName:F,description:D,onPaymentComplete:I,deviceId:$,allowPriceEdit:A=!1,paymentType:C="cash_in",currency:k,exchangeRate:T})=>{const{currentUser:L}=r(),{paymentMethods:E,loading:Z}=n(),{paymentAccounts:U,refreshPaymentAccounts:B}=(()=>{const[e,a]=i.useState([]),[s,r]=i.useState(!0);i.useEffect(()=>{n()},[]);const n=async()=>{r(!0);try{const e=await t.getPaymentMethods();a(e)}catch(e){}finally{r(!1)}};return{paymentAccounts:e,loading:s,getPOSPaymentAccounts:async()=>{try{return await t.getPOSPaymentMethods()}catch(e){return[]}},getFinancePaymentAccounts:async()=>{try{return await t.getFinancePaymentMethods()}catch(e){return[]}},getPaymentAccountById:async e=>{try{return await t.getFinanceAccountById(e)}catch(a){return null}},getPaymentAccountsByType:async e=>{try{return await t.getFinanceAccountsByType(e)}catch(a){return[]}},createPaymentAccount:async e=>{try{const s=await t.createFinanceAccount(e);return s&&a(e=>[...e,s]),s}catch(s){return null}},updatePaymentAccount:async(e,s)=>{try{const r=await t.updateFinanceAccount(e,s);return r&&a(t=>t.map(t=>t.id===e?r:t)),r}catch(r){return null}},deletePaymentAccount:async e=>{try{const s=await t.deleteFinanceAccount(e);return s&&a(t=>t.filter(t=>t.id!==e)),s}catch(s){return!1}},refreshPaymentAccounts:()=>{n()}}})(),[M,R]=i.useState([]),[O,q]=i.useState(!1),[Y,K]=i.useState(!1);j(s),i.useEffect(()=>{E&&0!==E.length||Z||(q(!0),e(()=>import("./index-222cfb29.js").then(e=>e.aW),["assets/index-222cfb29.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/index-d3868143.css"]).then(({financeAccountService:e})=>{e.getPaymentMethods().then(e=>{R(e),q(!1)}).catch(e=>{u.error("Failed to load payment methods. Please refresh the page."),R([]),q(!1)})}))},[E,Z,s]);const z=E&&E.length>0?E:M,W=Z||O,[G,H]=i.useState(""),[V,Q]=i.useState(S),[J,X]=i.useState(!1),[ee,te]=i.useState(!1),[ae,se]=i.useState([]),[re,ne]=i.useState(""),[ie,ce]=i.useState(!1),[oe,le]=i.useState(""),[de,me]=i.useState(""),[ue,xe]=i.useState(!1);i.useEffect(()=>{if(s){H(""),Q(S),X(!1),te(!1),se([]),ne(""),xe(!1),ce(!1),le(""),me("");(async()=>{K(!0);try{B?await B():e(()=>import("./index-222cfb29.js").then(e=>e.aW),["assets/index-222cfb29.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/index-d3868143.css"]).then(({financeAccountService:e})=>{e.getPaymentMethods().then(e=>{})})}catch(t){}finally{K(!1)}})()}},[s]);const he=(ge=re?Number(re):d,pe=T,(be=k)&&"TZS"!==be&&pe&&1!==pe?Math.round(ge*pe):null);var ge,be,pe;const ye=k&&"TZS"!==k&&T&&T>1,fe=ae.reduce((e,t)=>e+t.amount,0),je=re?Number(re):fe,Ne=(he||d)-fe,ve=k||"TZS",we="USD"===ve?"$":"EUR"===ve?"â‚¬":"GBP"===ve?"Â£":"TZS"===ve?"TSh":ve,Se=e=>{const t=U.find(t=>t.payment_method_id===e);if(t)return{id:t.id,name:t.name||t.account_name,payment_method_id:e};const a=E.find(t=>t.id===e);return a?{id:a.id,name:a.name,payment_method_id:e}:null},Pe=(e,t)=>{const a=E.find(t=>t.id===e),s=Se(e);if(!a)return void u.error("Payment method not found");if(!s||!s.id)return void u.error("No payment account found for this method. Please set up a finance account first.");let r;if(void 0!==t&&t>0)r=t;else if(re&&""!==re.trim()){const e=parseFloat(re);if(isNaN(e))return void u.error("Please enter a valid number for amount");r=e}else r=Ne;if(isNaN(r)||r<=0)return void u.error("Please enter a valid amount greater than 0");if(r>Ne)return void u.error(`Amount (${r.toLocaleString()}) exceeds remaining balance (${Ne.toLocaleString()})`);const n={id:crypto.randomUUID(),method:a.name,methodId:a.id,amount:r,currency:V.code,account:s.name,accountId:s.id,reference:"",notes:""};se(e=>[...e,n]),ne("")};return s?c.createPortal(a.jsxs("div",{className:"fixed inset-0 flex items-center justify-center p-4",style:{zIndex:99999},children:[a.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm",onClick:l}),a.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100 bg-white",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center "+("cash_out"===C?"bg-red-500":"bg-blue-500"),children:a.jsx(m,{className:"w-6 h-6 text-white"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"cash_out"===C?"Make Payment":"Complete Your Payment"}),a.jsx("p",{className:"text-sm text-gray-600",children:"cash_out"===C?F?`Payment to ${F}`:"Process outgoing payment":F?`Thank you, ${F}!`:"Secure payment processing"})]})]}),a.jsx("button",{onClick:l,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-white/50 rounded-lg transition-colors",children:a.jsx(x,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"flex-1 p-6 overflow-y-auto",children:[a.jsx("div",{className:"mb-6 p-6 rounded-xl border bg-white border-gray-200",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 "+("cash_out"===C?"bg-red-500":"bg-green-500"),children:a.jsx(o,{className:"w-8 h-8 text-white"})}),a.jsxs("div",{className:"flex items-center justify-center gap-3 mb-2",children:[a.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"cash_out"===C?"Amount to Pay":"Total Amount Due"}),a.jsx("button",{onClick:()=>{xe(!0)},className:"p-1 hover:bg-green-100 rounded-full transition-colors",title:"Edit amount",children:a.jsx(h,{className:"w-4 h-4 text-green-600"})})]}),ue?a.jsxs("div",{className:"space-y-4",children:[a.jsx("div",{className:"max-w-sm mx-auto",children:a.jsxs("div",{className:"flex items-center bg-white border border-gray-300 rounded-lg focus-within:border-orange-500 transition-colors h-16",children:[a.jsxs("div",{className:"flex items-center gap-2 px-4 py-4 border-r border-gray-200 h-full",children:[a.jsx("span",{className:"text-lg",children:V.flag}),a.jsx("select",{value:V.code,onChange:e=>{const t=w.find(t=>t.code===e.target.value);t&&Q(t)},className:"bg-transparent border-none text-gray-700 text-base focus:outline-none focus:ring-0 cursor-pointer",children:w.map(e=>a.jsxs("option",{value:e.code,children:[e.flag," ",e.code]},e.code))})]}),a.jsx("div",{className:"flex-1 px-4 py-4 h-full",children:a.jsx("input",{type:"text",value:re?Number(re).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):"",onChange:e=>{const t=e.target.value.replace(/,/g,"");(""===t||!isNaN(Number(t))&&Number(t)>=0)&&ne(t)},className:"w-full border-0 focus:outline-none focus:ring-0 text-3xl font-bold text-gray-900 placeholder-gray-400 bg-transparent h-full",placeholder:"0",autoFocus:!0})})]})}),a.jsxs("div",{className:"flex gap-2 justify-center",children:[a.jsx("button",{onClick:()=>xe(!1),className:"px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors",children:"Save"}),a.jsx("button",{onClick:()=>{ne(""),xe(!1)},className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition-colors",children:"Cancel"})]})]}):a.jsxs("div",{children:[a.jsxs("p",{className:"text-3xl font-bold text-green-600 mb-2",children:[we," ",(re?Number(re):d).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})]}),a.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[ve," â€¢ Amount to Pay"]}),ye&&he&&a.jsxs("div",{className:"mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-center gap-2 text-blue-700 mb-2",children:[a.jsx(g,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm font-medium",children:"Currency Conversion"})]}),a.jsxs("div",{className:"text-center space-y-1",children:[a.jsxs("p",{className:"text-xs text-blue-600",children:["Exchange Rate: 1 ",k," = ",null==T?void 0:T.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," TZS"]}),a.jsxs("p",{className:"text-lg font-bold text-blue-900",children:["â‰ˆ TZS ",he.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})]}),a.jsx("p",{className:"text-xs text-blue-600 italic",children:"Payment will be processed in TZS"})]})]}),"cash_out"===C&&a.jsxs("div",{className:"mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-2 text-orange-700",children:[a.jsx(g,{className:"w-4 h-4"}),a.jsx("span",{className:"text-sm font-medium",children:"Account Balance Will Be Deducted"})]}),a.jsx("p",{className:"text-xs text-orange-600 mt-1",children:"The payment amount will be deducted from your selected payment account"})]})]}),ee&&a.jsxs("div",{className:"mt-4 p-4 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl border border-blue-200",children:[a.jsxs("h4",{className:"text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2",children:[a.jsx(m,{className:"w-5 h-5"}),"Payment Breakdown"]}),a.jsxs("div",{className:"space-y-4",children:[ae.length>0&&a.jsx("div",{className:"space-y-3",children:ae.map((e,t)=>{const s=w.find(t=>t.code===e.currency)||S;return a.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200 shadow-sm",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:a.jsx(m,{className:"w-4 h-4 text-blue-600"})}),a.jsx("p",{className:"font-semibold text-gray-900 text-lg",children:e.method?e.method.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()):"Unknown Method"})]}),a.jsxs("div",{className:"space-y-1",children:[e.reference&&a.jsxs("p",{className:"text-sm text-gray-600",children:[a.jsx("span",{className:"font-medium",children:"Reference:"})," ",e.reference]}),e.notes&&a.jsxs("p",{className:"text-sm text-gray-600",children:[a.jsx("span",{className:"font-medium",children:"Note:"})," ",e.notes]})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("p",{className:"text-xl font-bold text-green-600 mb-2",children:_(e.amount,s)}),a.jsx("span",{className:"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800",children:"READY"})]})]})},t)})}),a.jsxs("div",{className:"mt-4 p-4 bg-white rounded-lg border border-gray-200",children:[a.jsxs("h5",{className:"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2",children:[a.jsx(o,{className:"w-4 h-4 text-green-600"}),"Payment Summary"]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-gray-600",children:"Total Payments"}),a.jsx("div",{className:"text-lg font-semibold text-blue-900",children:ae.length})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-gray-600",children:"Paid Amount"}),a.jsx("div",{className:"text-lg font-semibold text-green-600",children:_(fe,V)})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-gray-600",children:"Remaining"}),a.jsx("div",{className:"text-lg font-semibold text-orange-600",children:_(Ne,V)})]})]})]})]})]})]})}),a.jsx("div",{className:"mb-6",children:a.jsxs("div",{className:"flex items-center justify-center gap-4",children:[a.jsxs("button",{onClick:()=>te(!1),className:"px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200 border-2 "+(ee?"bg-white border-gray-200 hover:border-gray-300 hover:shadow-md":"cash_out"===C?"bg-white border-red-500 ring-4 ring-red-200 shadow-xl":"bg-white border-blue-500 ring-4 ring-blue-200 shadow-xl"),children:["ðŸ’³ Single ","Payment"]}),a.jsxs("button",{onClick:()=>te(!0),className:"px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200 border-2 "+(ee?"cash_out"===C?"bg-white border-red-500 ring-4 ring-red-200 shadow-xl":"bg-white border-blue-500 ring-4 ring-blue-200 shadow-xl":"bg-white border-gray-200 hover:border-gray-300 hover:shadow-md"),children:["ðŸ’° Split ","Payment"]})]})}),Y&&a.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2 text-blue-700",children:[a.jsx(b,{className:"w-4 h-4 animate-spin"}),a.jsx("span",{className:"text-sm font-medium",children:"Refreshing account balances..."})]}),W?a.jsxs("div",{className:"flex items-center justify-center py-8",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),a.jsx("span",{className:"ml-2 text-gray-600",children:"Loading payment methods..."})]}):a.jsx("div",{className:"space-y-4",children:ee?a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"text-center mb-4",children:[a.jsx("h5",{className:"text-md font-semibold text-gray-900 mb-2",children:"Split Your Payment"}),a.jsx("p",{className:"text-sm text-gray-600",children:"Use multiple payment methods if needed"})]}),a.jsxs("div",{className:"p-5 bg-white rounded-xl border border-gray-200",children:[a.jsxs("h4",{className:"text-sm font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[a.jsx(y,{className:"w-4 h-4"}),"Add Another Payment Method"]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount"}),a.jsx("input",{type:"number",value:re,onChange:e=>ne(e.target.value),placeholder:"Enter amount",className:"w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Method"}),a.jsxs("select",{onChange:e=>{e.target.value&&(Pe(e.target.value),e.target.value="")},className:"w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a.jsx("option",{value:"",children:"Choose method"}),E.map(e=>{const t=U.find(t=>t.payment_method_id===e.id);return a.jsxs("option",{value:e.id,children:[e.name," - Accept ",e.currency," payments",t?` (Balance: ${t.balance.toLocaleString()} ${t.currency||"TZS"})`:""]},e.id)})]})]}),a.jsx("div",{className:"flex items-end",children:a.jsxs("button",{onClick:()=>{G&&Pe(G)},className:"w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2",children:[a.jsx(y,{className:"w-4 h-4"}),"Add Method"]})})]})]}),!1]}):a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"text-center mb-4",children:[a.jsx("h5",{className:"text-md font-semibold text-gray-900 mb-2",children:"How would you like to pay?"}),M.length>0&&0===E.length&&a.jsx("div",{className:"text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full inline-block",children:"âœ… Loaded payment methods"})]}),a.jsx("div",{className:"grid grid-cols-2 gap-3",children:z&&z.length>0?z.map(e=>{const t=U.find(t=>t.payment_method_id===e.id),s=he||d,r="cash_out"===C&&t&&t.balance<s,n="cash_out"===C&&t&&t.balance>=s;return a.jsx("button",{onClick:()=>{r?u.error(`Insufficient balance in ${t.name}. Please select another account or add funds.`):H(e.id)},disabled:r,className:"p-4 rounded-xl border-2 transition-all duration-200 "+(r?"border-red-300 bg-red-50 opacity-60 cursor-not-allowed":G===e.id?"border-blue-500 bg-white ring-4 ring-blue-200 shadow-xl":n?"border-green-300 bg-green-50 hover:border-green-400 hover:shadow-md":"border-gray-200 bg-white hover:border-blue-300 hover:shadow-md"),children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(N,{type:e.type,name:e.name,className:"w-16 h-16"}),a.jsxs("div",{className:"flex-1 text-left",children:[a.jsx("p",{className:"font-semibold text-gray-900",children:e.name}),t&&a.jsxs("div",{className:"mt-1",children:[a.jsxs("div",{className:"text-xs "+(r?"text-red-700":"text-gray-600"),children:[a.jsx("span",{className:"font-medium",children:"Balance:"})," ",t.balance.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",t.currency||"TZS"]}),"cash_out"===C&&r&&a.jsxs("div",{className:"mt-1 flex items-center gap-1 text-xs text-red-600 font-medium",children:[a.jsx(g,{className:"w-3 h-3"}),"Insufficient (Need: ",s.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}),")"]}),"cash_out"===C&&n&&a.jsxs("div",{className:"mt-1 flex items-center gap-1 text-xs text-green-600 font-medium",children:[a.jsx(p,{className:"w-3 h-3"}),"Sufficient Funds"]})]})]}),G===e.id&&!r&&a.jsx("div",{className:"w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center",children:a.jsx(p,{className:"w-3 h-3 text-white"})})]})},e.id)}):a.jsxs("div",{className:"col-span-2 text-center py-8",children:[a.jsx("div",{className:"text-gray-500 mb-2",children:"âš ï¸ No payment methods available"}),a.jsx("div",{className:"text-sm text-gray-400",children:"Please contact administrator to set up payment methods"})]})}),G&&(()=>{const e=z.find(e=>e.id===G),t=U.find(e=>e.payment_method_id===G);if(!e||!t)return null;const s=he||d,r=t.balance-s;return a.jsx("div",{className:"mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl shadow-md",children:a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Selected Account:"}),a.jsx("span",{className:"text-base font-bold text-blue-900",children:e.name})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Current Balance:"}),a.jsxs("span",{className:"text-lg font-bold text-green-600",children:[t.balance.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",t.currency||"TZS"]})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"text-sm font-semibold text-gray-700",children:["Amount to ","cash_out"===C?"Pay":"Receive",":"]}),a.jsxs("span",{className:"text-lg font-bold text-orange-600",children:[s.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",t.currency||"TZS"]})]}),a.jsx("div",{className:"pt-2 border-t border-blue-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Balance After Payment:"}),a.jsxs("span",{className:"text-xl font-bold "+(r>=0?"text-green-700":"text-red-600"),children:[r.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",t.currency||"TZS"]})]})})]})})})()]})}),A&&$&&je>d&&a.jsxs("div",{className:"mt-6 p-5 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx("div",{className:"w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center",children:a.jsx(h,{className:"w-5 h-5 text-white"})}),a.jsx("h4",{className:"text-lg font-semibold text-amber-800",children:"Customer Paid More"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsx("div",{className:"p-3 bg-white/50 rounded-lg",children:a.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-600",children:"Original Price:"}),a.jsx("p",{className:"font-semibold text-gray-700",children:_(d,V)})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),a.jsx("p",{className:"font-semibold text-green-600",children:_(je,V)})]})]})}),ie?a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-amber-800 mb-2",children:"New Repair Price"}),a.jsx("input",{type:"number",value:oe,onChange:e=>le(e.target.value),className:"w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent",placeholder:"Enter new price"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-amber-800 mb-2",children:"Reason for Price Change"}),a.jsx("textarea",{value:de,onChange:e=>me(e.target.value),className:"w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent",rows:2,placeholder:"e.g., Customer paid more, additional services provided..."})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:async()=>{if($&&(null==L?void 0:L.id))try{await v.updateDeviceRepairPrice({deviceId:$,repairPrice:parseFloat(oe),updatedBy:null==L?void 0:L.id,reason:de||"Price adjusted to match customer payment"}),u.success("Device price updated successfully"),ce(!1)}catch(e){u.error("Failed to update device price")}},className:"flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors",children:"Update Price"}),a.jsx("button",{onClick:()=>ce(!1),className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors",children:"Cancel"})]})]}):a.jsxs("div",{className:"space-y-3",children:[a.jsxs("p",{className:"text-sm text-amber-700",children:["Customer paid ",a.jsx("span",{className:"font-semibold",children:_(je-d,V)})," more than the original price."]}),a.jsx("button",{onClick:()=>{le(je.toString()),ce(!0)},className:"w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium transition-colors",children:"Update Price to Match Payment"})]})]})]})]}),a.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-100 flex-shrink-0 bg-white",children:[a.jsxs("div",{className:"text-sm text-gray-600",children:[Ne>0?a.jsxs("span",{className:"text-orange-600 flex items-center gap-1",children:[a.jsx(g,{className:"w-4 h-4"}),"cash_out"===C?"Amount to pay":"Amount remaining",": ",Ne.toLocaleString()," TZS"]}):a.jsxs("span",{className:"text-green-600 flex items-center gap-1",children:[a.jsx(p,{className:"w-4 h-4"}),"Payment complete"]}),"cash_out"===C&&G&&a.jsx("div",{className:"mt-1 text-xs text-gray-500",children:(()=>{const e=U.find(e=>e.payment_method_id===G);if(e){const t=ee?fe:he||d,s=e.balance-t;return a.jsxs("span",{children:["Account balance: ",e.balance.toLocaleString()," â†’ ",s.toLocaleString()," ",e.currency||"TZS"]})}return null})()})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:l,className:"px-6 py-3 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors text-sm font-medium",children:"Cancel"}),a.jsx("button",{onClick:async()=>{if(ee){if(0===ae.length)return void u.error("Please add at least one payment");if(Ne<0)return void u.error("Payment amount exceeds required amount");if("cash_out"===C)for(const e of ae){const t=U.find(t=>t.id===e.accountId);if(t&&t.balance<e.amount)return void u.error(`Insufficient balance in ${t.name}. Available: ${t.balance.toLocaleString()}, Required: ${e.amount.toLocaleString()}`)}}else{if(!G)return void u.error("Please select a payment method");if("cash_out"===C){const e=U.find(e=>e.payment_method_id===G),t=he||d;if(e&&e.balance<t)return void u.error(`Insufficient balance in ${e.name}. Available: ${e.balance.toLocaleString()} ${e.currency||"TZS"}, Required: ${t.toLocaleString()}`)}}X(!0);try{const e=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);if(ee){for(const a of ae){if(!a.accountId)return u.error(`Missing account ID for payment method: ${a.method}. Please remove and re-add this payment.`),void X(!1);if(!e(a.methodId))return u.error(`Invalid payment method ID: ${a.method}. Please refresh and try again.`),void X(!1);if(!e(a.accountId))return u.error(`Invalid account ID for: ${a.method}. Please refresh and try again.`),void X(!1)}const t=ae.map(e=>{const t="number"==typeof e.amount?e.amount:parseFloat(String(e.amount));if(isNaN(t)||t<=0)throw new Error(`Invalid amount for payment method ${e.method}: ${e.amount}`);return{amount:t,currency:e.currency||k||"TZS",paymentMethod:e.method,paymentMethodId:e.methodId,paymentAccountId:e.accountId,customerId:P,customerName:F,description:D,timestamp:(new Date).toISOString()}});await I(t,fe)}else{const t=E.find(e=>e.id===G),a=Se(G);if(!t)return u.error("Payment method not found"),void X(!1);if(!a||!a.id)return u.error("No payment account found for this method. Please set up a finance account first."),void X(!1);if(!e(t.id))return u.error("Invalid payment method ID. Please refresh and try again."),void X(!1);if(!e(a.id))return u.error("Invalid account ID. Please refresh and try again."),void X(!1);const s=he||("number"==typeof d?d:parseFloat(String(d)));if(isNaN(s)||s<=0)return u.error(`Invalid payment amount: ${d}. Please refresh and try again.`),void X(!1);const r=[{amount:s,currency:"TZS",originalCurrency:k,originalAmount:d,paymentMethod:t.name,paymentMethodId:t.id,paymentAccountId:a.id,customerId:P,customerName:F,description:D,timestamp:(new Date).toISOString()}],n=s;await I(r,n)}l()}catch(e){u.error("Payment failed. Please try again.")}finally{X(!1)}},disabled:J||(ee?0===ae.length:!G)||"cash_out"===C&&!ee&&G&&(()=>{const e=U.find(e=>e.payment_method_id===G),t=he||d;return e&&e.balance<t})()||"cash_out"===C&&ee&&ae.some(e=>{const t=U.find(t=>t.id===e.accountId);return t&&t.balance<e.amount}),className:"px-8 py-3 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg transition-all duration-200 text-sm font-semibold flex items-center gap-2 "+("cash_out"===C?"bg-red-600 hover:bg-red-700 shadow-lg disabled:hover:bg-gray-400":"bg-green-600 hover:bg-green-700 shadow-lg disabled:hover:bg-gray-400"),title:"cash_out"===C&&!ee&&G?(()=>{const e=U.find(e=>e.payment_method_id===G),t=he||d;return e&&e.balance<t?`Insufficient balance: ${e.balance.toLocaleString()} available, ${t.toLocaleString()} required`:""})():"",children:J?a.jsxs(a.Fragment,{children:[a.jsx(f,{className:"w-4 h-4 animate-spin"}),"Processing..."]}):a.jsxs(a.Fragment,{children:[a.jsx(m,{className:"w-4 h-4"}),"cash_out"===C?"Make Payment":"Complete Payment"]})})]})]})]})]}),document.body):null};export{S as D,$ as P,w as S,P as a,I as b,F as f,D as g};
