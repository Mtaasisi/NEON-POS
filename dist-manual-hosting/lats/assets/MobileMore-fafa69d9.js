import{a6 as e,u as s,v as t,s as a,j as i}from"./index-222cfb29.js";import{r as n}from"./vendor-a2ff445a.js";import{z as l,t as c,v as r,ao as d,bm as o,W as x,R as h,b7 as m,az as u,ah as g,a5 as y,x as f,aa as p,aA as b,am as j,bJ as v,aJ as N,V as w,ax as S}from"./ui-551a39a6.js";import{m as C}from"./mobileOfflineCache-7b8975c6.js";import{a as k}from"./routing-a2f0f6d2.js";import"./supabase-7e851d02.js";import"./supabase-460661f2.js";const O=new class{constructor(){this.isOnline=navigator.onLine,this.isSyncing=!1,this.syncInterval=null,this.branchId=null,this.init()}init(){window.addEventListener("online",()=>{this.isOnline=!0,this.handleOnline()}),window.addEventListener("offline",()=>{this.isOnline=!1,this.handleOffline()}),this.isOnline&&this.performInitialSync(),this.setupPeriodicSync()}setBranchId(e){this.branchId=e}async performInitialSync(){try{const e=await C.isCacheValid("products"),s=await C.isCacheValid("customers");if(e&&s){await C.getCacheStats()}else await this.syncNow()}catch(e){}}async handleOnline(){l.success("Back online! Syncing data...",{duration:2e3}),await this.syncPendingSales(),await this.syncNow()}handleOffline(){l("You're offline. Changes will be saved locally.",{icon:"ðŸ“µ",duration:3e3})}setupPeriodicSync(){this.syncInterval&&clearInterval(this.syncInterval),this.syncInterval=setInterval(()=>{this.isOnline&&!this.isSyncing&&this.syncNow(!1)},18e5)}async syncNow(e=!0){if(this.isSyncing)return!1;if(!this.isOnline)return e&&l.error("Cannot sync while offline"),!1;this.isSyncing=!0,e&&l.loading("Syncing data...",{id:"sync-toast"});try{const s=await C.syncAll(this.branchId||void 0);return s.success?(e&&l.success("Data synced successfully!",{id:"sync-toast"}),window.dispatchEvent(new CustomEvent("dataSynced",{detail:{synced:s.synced}})),!0):(e&&l.error("Some data failed to sync",{id:"sync-toast"}),!1)}catch(s){return e&&l.error("Sync failed",{id:"sync-toast"}),!1}finally{this.isSyncing=!1}}async syncPendingSales(){try{const s=await C.getPendingSales();if(0===s.length)return;let t=0,a=0;for(const i of s)try{await C.markSaleSynced(i.id),t++}catch(e){a++}t>0&&l.success(`Synced ${t} offline sales`),a>0&&l.error(`Failed to sync ${a} sales`)}catch(e){}}async forceSyncNow(){return this.syncNow(!0)}getSyncStatus(){return{isOnline:this.isOnline,isSyncing:this.isSyncing}}async getCacheStats(){return await C.getCacheStats()}async clearCache(){try{await C.clearAll(),l.success("Cache cleared successfully")}catch(e){l.error("Failed to clear cache")}}cleanup(){this.syncInterval&&clearInterval(this.syncInterval)}},I=()=>{var I;const P=k(),{currentUser:z}=s(),{currentBranch:E,availableBranches:W,switchBranch:L,loading:A}=t(),[_,B]=n.useState(!1),[D,F]=n.useState(!1),{isOnline:M,isSyncing:R,isNativeApp:T,syncNow:U,getCacheStats:V}=(()=>{const[s,t]=n.useState(navigator.onLine),[a,i]=n.useState(!1),[l,c]=n.useState([]),[r,d]=n.useState([]),[o,x]=n.useState([]),[h,m]=n.useState([]),[u,g]=n.useState([]),[y,f]=n.useState([]),[p,b]=n.useState(!0),[j,v]=n.useState(!0),N=n.useCallback(async()=>{try{const[e,s,t,a,i,n]=await Promise.all([C.getProducts(),C.getCustomers(),C.getSales(),C.getBranches(),C.getCategories(),C.getPaymentAccounts()]);c(e),d(s),x(t),m(a),g(i),f(n)}catch(e){}finally{b(!1),v(!1)}},[]);n.useEffect(()=>{e()&&N()},[N]),n.useEffect(()=>{const e=()=>{t(!0)},s=()=>{t(!1)},a=()=>{N()};return window.addEventListener("online",e),window.addEventListener("offline",s),window.addEventListener("dataSynced",a),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",s),window.removeEventListener("dataSynced",a)}},[N]);const w=n.useCallback(async()=>{i(!0);try{const e=await O.forceSyncNow();return e&&await N(),e}finally{i(!1)}},[N]),S=n.useCallback(async()=>await C.getCacheStats(),[]),k=n.useCallback(async()=>{await C.clearAll(),c([]),d([]),x([]),m([]),g([]),f([])},[]),I=n.useCallback(async e=>await C.savePendingSale(e),[]),P=n.useCallback(async()=>{b(!0);try{const e=await C.getProducts();c(e)}finally{b(!1)}},[]),z=n.useCallback(async()=>{v(!0);try{const e=await C.getCustomers();d(e)}finally{v(!1)}},[]);return{isOnline:s,isSyncing:a,isNativeApp:e(),products:l,customers:r,sales:o,branches:h,categories:u,paymentAccounts:y,productsLoading:p,customersLoading:j,syncNow:w,getCacheStats:S,clearCache:k,savePendingSale:I,refreshProducts:P,refreshCustomers:z}})(),[$,q]=n.useState(null),[G,H]=n.useState({sales:0,clients:0,products:0,loading:!0});n.useEffect(()=>{E&&Y()},[E]),n.useEffect(()=>{T&&J()},[T]);const J=async()=>{try{const e=await V();q(e)}catch(e){}},Y=async()=>{if(E)try{H(e=>({...e,loading:!0}));const{count:e,error:s}=await a.from("lats_sales").select("*",{count:"exact",head:!0}).eq("branch_id",E.id);if(s)throw s;const{count:t,error:i}=await a.from("lats_customers").select("*",{count:"exact",head:!0}).eq("branch_id",E.id);if(i)throw i;const{count:n,error:l}=await a.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",E.id);if(l)throw l;H({sales:e||0,clients:t||0,products:n||0,loading:!1})}catch(e){l.error("Failed to load statistics"),H(e=>({...e,loading:!1}))}},K=[{section:"MAIN",items:[{icon:g,label:"Analytics",path:"/mobile/analytics"},{icon:y,label:"Invoices",path:"/mobile/invoices"},{icon:c,label:"Employees",path:"/mobile/employees"},{icon:f,label:"Suppliers",path:"/mobile/suppliers"}]},{section:"SETTINGS",items:[{icon:p,label:"General Settings",path:"/mobile/settings"},{icon:b,label:"Payment Methods",path:"/mobile/payments"},{icon:j,label:"Notifications",path:"/mobile/notifications"}]},{section:"SUPPORT",items:[{icon:v,label:"Help & Support",path:"/mobile/help"},{icon:N,label:"Logout",path:"/logout",isDestructive:!0}]}],Q=[{icon:w,label:"New Sale",path:"/mobile/pos"},{icon:S,label:"Reports",path:"/mobile/analytics"}];return i.jsxs("div",{className:"flex flex-col h-full bg-[#f2f2f7]",children:[i.jsx("div",{className:"bg-white px-4 pt-3 pb-4 border-b border-gray-200",children:i.jsx("h1",{className:"text-[34px] font-bold text-black tracking-tight",style:{letterSpacing:"-0.5px"},children:"More"})}),i.jsxs("div",{className:"flex-1 overflow-y-auto pb-20",children:[i.jsx("div",{className:"mx-4 mt-4 bg-white rounded-2xl overflow-hidden shadow-sm",children:i.jsxs("div",{className:"p-4",children:[i.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[i.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md",children:i.jsx(c,{size:32,className:"text-white",strokeWidth:2})}),i.jsxs("div",{className:"flex-1",children:[i.jsx("h2",{className:"text-[20px] font-semibold text-gray-900",children:(null==(I=null==z?void 0:z.email)?void 0:I.split("@")[0])||"Admin User"}),i.jsx("p",{className:"text-[15px] text-gray-500",children:(null==z?void 0:z.email)||"admin@latsepos.com"})]})]}),i.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[i.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[i.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:G.loading?"...":G.sales}),i.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Sales"})]}),i.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[i.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:G.loading?"...":G.clients}),i.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Clients"})]}),i.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[i.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:G.loading?"...":G.products}),i.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Products"})]})]})]})}),!A&&W.length>0&&i.jsxs("div",{className:"mx-4 mt-4",children:[i.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:"CURRENT BRANCH"}),i.jsx("button",{onClick:()=>B(!0),className:"w-full bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md active:scale-[0.98] transition-all",children:i.jsxs("div",{className:"px-4 py-3.5 flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-sm",children:i.jsx(r,{size:20,className:"text-white",strokeWidth:2.5})}),i.jsxs("div",{className:"text-left",children:[i.jsx("div",{className:"text-[16px] font-semibold text-gray-900",children:(null==E?void 0:E.name)||"Select Branch"}),i.jsx("div",{className:"text-[13px] text-gray-500",children:(null==E?void 0:E.city)||"No branch selected"})]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[W.length>1&&i.jsxs("span",{className:"text-[11px] font-semibold text-blue-500 bg-blue-50 px-2 py-1 rounded-full",children:[W.length," available"]}),i.jsx(d,{size:18,className:"text-gray-400",strokeWidth:2.5})]})]})})]}),T&&i.jsxs("div",{className:"mx-4 mt-4",children:[i.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:"OFFLINE MODE"}),i.jsxs("div",{className:"bg-white rounded-2xl overflow-hidden shadow-sm",children:[i.jsxs("div",{className:"px-4 py-3 flex items-center justify-between border-b border-gray-100",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[M?i.jsx("div",{className:"w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center",children:i.jsx(o,{size:20,className:"text-green-600",strokeWidth:2.5})}):i.jsx("div",{className:"w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center",children:i.jsx(x,{size:20,className:"text-orange-600",strokeWidth:2.5})}),i.jsxs("div",{children:[i.jsx("div",{className:"text-[15px] font-semibold text-gray-900",children:M?"Online":"Offline"}),i.jsx("div",{className:"text-[12px] text-gray-500",children:M?"Connected to server":"Working offline"})]})]}),M&&i.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"})]}),i.jsxs("button",{onClick:async()=>{try{await U()?(await J(),l.success("Data synced successfully!")):l.error("Sync failed. Please try again.")}catch(e){l.error("Sync error occurred")}},disabled:R||!M,className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center",children:i.jsx(h,{size:20,className:"text-blue-600 "+(R?"animate-spin":""),strokeWidth:2.5})}),i.jsxs("div",{className:"text-left",children:[i.jsx("div",{className:"text-[15px] font-medium text-gray-900",children:R?"Syncing...":"Sync Data"}),i.jsx("div",{className:"text-[12px] text-gray-500",children:R?"Please wait":"Update offline data"})]})]}),i.jsx(d,{size:18,className:"text-gray-400",strokeWidth:2.5})]}),i.jsxs("button",{onClick:()=>F(!D),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors border-t border-gray-100",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center",children:i.jsx(m,{size:20,className:"text-purple-600",strokeWidth:2.5})}),i.jsxs("div",{className:"text-left",children:[i.jsx("div",{className:"text-[15px] font-medium text-gray-900",children:"Cache Statistics"}),i.jsx("div",{className:"text-[12px] text-gray-500",children:"View offline data status"})]})]}),i.jsx(d,{size:18,className:"text-gray-400 transition-transform "+(D?"rotate-90":""),strokeWidth:2.5})]}),D&&$&&i.jsx("div",{className:"px-4 py-3 bg-gray-50 border-t border-gray-100",children:i.jsx("div",{className:"space-y-2",children:Object.entries($).map(([e,s])=>"pending_sales"===e?i.jsxs("div",{className:"flex justify-between text-[13px]",children:[i.jsx("span",{className:"text-gray-600 capitalize",children:e.replace("_"," ")}),i.jsx("span",{className:"font-semibold text-orange-600",children:s.count})]},e):i.jsxs("div",{className:"flex justify-between text-[13px]",children:[i.jsx("span",{className:"text-gray-600 capitalize",children:e.replace("_"," ")}),i.jsx("span",{className:"font-semibold text-gray-900",children:s.count||0})]},e))})})]})]}),i.jsx("div",{className:"px-4 mt-4",children:i.jsx("div",{className:"flex gap-2",children:Q.map((e,s)=>{const t=e.icon;return i.jsxs("button",{onClick:()=>P(e.path),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-[13px] font-medium shadow-sm",children:[i.jsx(t,{size:18,strokeWidth:2.5}),i.jsx("span",{children:e.label})]},s)})})}),K.map((e,s)=>i.jsxs("div",{className:"px-4 mt-6",children:[i.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:e.section}),i.jsx("div",{className:"bg-white rounded-2xl overflow-hidden shadow-sm",children:e.items.map((s,t)=>{const a=s.icon,n=t===e.items.length-1;return i.jsxs("button",{onClick:()=>P(s.path),className:"w-full px-4 py-3.5 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors "+(n?"":"border-b border-gray-100"),children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center "+(s.isDestructive?"bg-red-50":"bg-blue-50"),children:i.jsx(a,{size:18,className:s.isDestructive?"text-red-500":"text-blue-500",strokeWidth:2.5})}),i.jsx("span",{className:`text-[16px] ${s.isDestructive?"text-red-500":"text-gray-900"} font-normal`,children:s.label}),s.badge&&i.jsx("span",{className:`text-[10px] font-bold text-white ${s.badgeColor||"bg-blue-500"} px-2 py-0.5 rounded-full`,children:s.badge})]}),i.jsx(d,{size:18,className:"text-gray-400",strokeWidth:2.5})]},t)})})]},s)),i.jsxs("div",{className:"px-4 py-8 text-center",children:[i.jsx("p",{className:"text-[13px] text-gray-400 font-medium",children:"LATS POS Mobile"}),i.jsx("p",{className:"text-[13px] text-gray-400 mt-1",children:"Version 1.0.0"})]})]}),_&&i.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-end",onClick:()=>B(!1),children:i.jsxs("div",{className:"w-full bg-white rounded-t-3xl max-h-[70vh] flex flex-col animate-slide-up",onClick:e=>e.stopPropagation(),children:[i.jsx("div",{className:"flex justify-center pt-2 pb-1",children:i.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),i.jsx("div",{className:"px-4 py-3 border-b border-gray-200",children:i.jsx("h2",{className:"text-[20px] font-semibold text-gray-900 text-center",children:"Select Branch"})}),i.jsx("div",{className:"flex-1 overflow-y-auto",children:W.map((e,s)=>{const t=(null==E?void 0:E.id)===e.id,a=s===W.length-1;return i.jsxs("button",{onClick:()=>(async e=>{try{await L(e),B(!1)}catch(s){l.error("Failed to switch branch")}})(e.id),className:"w-full px-4 py-4 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors "+(a?"":"border-b border-gray-100"),children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-10 h-10 rounded-xl flex items-center justify-center "+(t?"bg-gradient-to-br from-green-500 to-emerald-600":"bg-gray-100"),children:i.jsx(r,{size:20,className:t?"text-white":"text-gray-500",strokeWidth:2.5})}),i.jsxs("div",{className:"text-left",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"text-[16px] font-semibold "+(t?"text-gray-900":"text-gray-700"),children:e.name}),e.is_main&&i.jsx("span",{className:"text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full",children:"MAIN"})]}),i.jsxs("div",{className:"text-[13px] text-gray-500 flex items-center gap-2",children:[i.jsx("span",{children:e.city}),e.code&&i.jsxs(i.Fragment,{children:[i.jsx("span",{className:"text-gray-300",children:"â€¢"}),i.jsx("span",{className:"text-[12px] font-mono",children:e.code})]})]})]})]}),t&&i.jsx("div",{className:"w-6 h-6 bg-green-500 rounded-full flex items-center justify-center",children:i.jsx(u,{size:14,className:"text-white",strokeWidth:3})})]},e.id)})}),i.jsx("div",{className:"p-4 border-t border-gray-200",children:i.jsx("button",{onClick:()=>B(!1),className:"w-full py-3 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 rounded-xl text-[16px] font-semibold text-gray-900 transition-colors",children:"Cancel"})})]})})]})};export{I as default};
