import{u as e,a as s,v as t,t as a,j as r,s as l}from"./index-222cfb29.js";import{r as n}from"./vendor-a2ff445a.js";import{i as d}from"./installmentService-e14bbda4.js";import{u as i,S as c}from"./useSuccessModal-e8b7d685.js";import{B as o}from"./BackButton-e41d1482.js";import{n as m,Q as x,y as u,aA as g,A as p,u as h,q as b,D as y,r as j,a7 as f,by as N,$ as v,X as w,e as _,a5 as C,x as S,aC as k,am as P,d as D,a8 as T,U as F}from"./ui-551a39a6.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";import"./whatsappService-37f3bd6b.js";import"./useBodyScrollLock-0216d39f.js";const z=()=>{const{currentUser:l}=e(),{customers:c}=s(),{currentBranch:w}=t();i();const[_,C]=n.useState([]),[S,k]=n.useState(null),[P,D]=n.useState(!0),[T,F]=n.useState(!1),[z,R]=n.useState(!1),[Z,M]=n.useState(!1),[U,E]=n.useState(!1),[$,W]=n.useState(!1),[Q,V]=n.useState(!1),[H,K]=n.useState(null),[Y,G]=n.useState("all"),[J,X]=n.useState(""),[ee,se]=n.useState(""),[te,ae]=n.useState(""),[re,le]=n.useState([]),ne=n.useCallback(async()=>{if(null==w?void 0:w.id){D(!0);try{const e=await d.getAllInstallmentPlans(w.id);C(e);const s=await d.getStatistics(w.id);k(s)}catch(e){m.error("Failed to load installment plans")}finally{D(!1)}}else D(!1)},[null==w?void 0:w.id]),de=n.useCallback(async()=>{try{const e=await a.getPaymentMethods();le(e)}catch(e){}},[]);n.useEffect(()=>{ne(),de()},[ne,de,w]);const ie=n.useMemo(()=>_.filter(e=>{var s;const t="all"===Y||e.status===Y,a=""===J||e.plan_number.toLowerCase().includes(J.toLowerCase())||(null==(s=e.customer)?void 0:s.name.toLowerCase().includes(J.toLowerCase())),r=new Date(e.created_at),l=!ee||r>=new Date(ee);return t&&a&&l&&(!te||r<=new Date(te+"T23:59:59"))}),[_,Y,J,ee,te]),ce=e=>"active"===e.status&&new Date(e.next_payment_date)<new Date,oe=e=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e);return P?r.jsx("div",{className:"flex items-center justify-center min-h-screen",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Loading installment plans..."})]})}):r.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[r.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx(o,{to:"/dashboard"}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Installment Plans"}),r.jsx("p",{className:"text-gray-600 mt-1",children:"Manage customer payment plans"})]})]}),r.jsxs("button",{onClick:()=>F(!0),className:"flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm",children:[r.jsx(x,{size:18}),"New Installment Plan"]})]}),S&&r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3",children:[r.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[r.jsx("div",{className:"text-2xl font-bold text-gray-900",children:S.total}),r.jsx("div",{className:"text-xs text-gray-600",children:"Total Plans"})]}),r.jsxs("div",{className:"bg-green-50 rounded-lg p-4 border border-green-200",children:[r.jsx("div",{className:"text-2xl font-bold text-green-600",children:S.active}),r.jsx("div",{className:"text-xs text-green-600",children:"Active"})]}),r.jsxs("div",{className:"bg-red-50 rounded-lg p-4 border border-red-200",children:[r.jsx("div",{className:"text-2xl font-bold text-red-600",children:S.overdue_count}),r.jsx("div",{className:"text-xs text-red-600",children:"Overdue"})]}),r.jsxs("div",{className:"bg-yellow-50 rounded-lg p-4 border border-yellow-200",children:[r.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:S.due_this_week}),r.jsx("div",{className:"text-xs text-yellow-600",children:"Due This Week"})]}),r.jsxs("div",{className:"bg-purple-50 rounded-lg p-4 border border-purple-200",children:[r.jsx("div",{className:"text-2xl font-bold text-purple-600",children:oe(S.total_balance_due)}),r.jsx("div",{className:"text-xs text-purple-600",children:"Balance Due"})]})]}),r.jsx("div",{className:"bg-white rounded-lg p-4 border border-gray-200 space-y-4",children:r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[r.jsxs("div",{className:"flex-1 relative",children:[r.jsx(u,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:18}),r.jsx("input",{type:"text",placeholder:"Search plans, customers...",value:J,onChange:e=>X(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),r.jsxs("select",{value:Y,onChange:e=>G(e.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[r.jsx("option",{value:"all",children:"All Status"}),r.jsx("option",{value:"active",children:"Active"}),r.jsx("option",{value:"completed",children:"Completed"}),r.jsx("option",{value:"defaulted",children:"Defaulted"}),r.jsx("option",{value:"cancelled",children:"Cancelled"})]}),r.jsx("input",{type:"date",value:ee,onChange:e=>se(e.target.value),placeholder:"From Date",className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),r.jsx("input",{type:"date",value:te,onChange:e=>ae(e.target.value),placeholder:"To Date",className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),(ee||te||J||"all"!==Y)&&r.jsx("button",{onClick:()=>{se(""),ae(""),X(""),G("all")},className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors text-sm font-medium",children:"Clear"})]})}),r.jsx("div",{className:"space-y-3",children:0===ie.length?r.jsxs("div",{className:"bg-white rounded-lg p-12 text-center border border-gray-200",children:[r.jsx(g,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No installment plans found"}),r.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Create your first installment plan to get started"}),r.jsxs("button",{onClick:()=>F(!0),className:"mt-4 px-5 py-2.5 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm inline-flex items-center gap-2",children:[r.jsx(x,{size:18}),"New Installment Plan"]})]}):ie.map(e=>{var s,t;return r.jsx("div",{className:"bg-white rounded-lg p-5 border-2 transition-shadow "+(ce(e)?"border-red-300 bg-red-50/30":"border-gray-200 hover:shadow-md"),children:r.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[r.jsx("div",{className:"flex-1 space-y-2",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"p-2 rounded-lg "+(ce(e)?"bg-red-100":"bg-blue-100"),children:r.jsx(g,{className:"w-5 h-5 "+(ce(e)?"text-red-600":"text-blue-600")})}),r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r.jsx("h3",{className:"text-lg font-bold text-gray-900",children:e.plan_number}),r.jsx("span",{className:`px-2.5 py-1 rounded-full text-xs font-semibold ${t=e.status,{active:"bg-green-100 text-green-700",completed:"bg-gray-100 text-gray-700",defaulted:"bg-red-100 text-red-700",cancelled:"bg-orange-100 text-orange-700"}[t]||"bg-gray-100 text-gray-700"}`,children:e.status.toUpperCase()}),ce(e)&&r.jsxs("span",{className:"px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 flex items-center gap-1",children:[r.jsx(p,{size:12}),"OVERDUE"]})]}),r.jsx("p",{className:"text-gray-700 font-medium mt-1",children:null==(s=e.customer)?void 0:s.name}),r.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 mt-1",children:[r.jsxs("span",{children:[Number(e.installment_amount).toFixed(2)," TZS / ",e.payment_frequency]}),r.jsx("span",{children:"â€¢"}),r.jsxs("span",{children:[e.installments_paid," / ",e.number_of_installments," paid"]}),r.jsx("span",{children:"â€¢"}),r.jsxs("span",{className:"flex items-center gap-1",children:[r.jsx(h,{size:14}),"Next: ",new Date(e.next_payment_date).toLocaleDateString()]})]})]})]})}),r.jsxs("div",{className:"flex flex-col lg:items-end gap-3",children:[r.jsxs("div",{className:"space-y-1",children:[r.jsxs("div",{className:"text-xs text-gray-600",children:["Total: ",r.jsx("span",{className:"font-bold text-gray-900",children:oe(e.total_amount)})]}),r.jsxs("div",{className:"text-xs text-green-600",children:["Paid: ",r.jsx("span",{className:"font-bold",children:oe(e.total_paid)})]}),r.jsxs("div",{className:"text-xs text-red-600",children:["Balance: ",r.jsx("span",{className:"font-bold",children:oe(e.balance_due)})]}),r.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-2",children:r.jsx("div",{className:"bg-green-600 h-2 rounded-full transition-all",style:{width:e.total_paid/e.total_amount*100+"%"}})})]}),r.jsxs("div",{className:"flex gap-2 flex-wrap",children:[r.jsxs("button",{onClick:()=>{K(e),E(!0)},className:"px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(b,{size:14}),"Details"]}),"active"===e.status&&r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:()=>{K(e),R(!0)},className:"px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(y,{size:14}),"Pay"]}),r.jsxs("button",{onClick:()=>{K(e),W(!0)},className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(j,{size:14}),"Edit"]}),r.jsxs("button",{onClick:()=>(async e=>{const s=await d.sendPaymentReminder(e,null==l?void 0:l.id);s.success?(m.success("Payment reminder sent successfully!"),ne()):m.error(s.error||"Failed to send reminder")})(e.id),className:"px-3 py-1.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(f,{size:14}),"Remind"]})]}),r.jsxs("button",{onClick:()=>{K(e),M(!0)},className:"px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(h,{size:14}),"Schedule"]}),r.jsxs("button",{onClick:()=>{K(e),V(!0)},className:"px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs font-medium flex items-center gap-1",children:[r.jsx(N,{size:14}),"History"]}),"active"===e.status&&r.jsx("button",{onClick:()=>(async e=>{if(!confirm("Are you sure you want to cancel this installment plan?"))return;const s=await d.cancelPlan(e);s.success?(m.success("Installment plan cancelled successfully"),ne()):m.error(s.error||"Failed to cancel plan")})(e.id),className:"px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-xs font-medium",children:r.jsx(v,{size:14})})]})]})]})},e.id)})}),T&&r.jsx(I,{isOpen:T,onClose:()=>F(!1),onSuccess:()=>{F(!1),ne()},customers:c,paymentAccounts:re,currentUser:l}),U&&H&&r.jsx(q,{isOpen:U,onClose:()=>{E(!1),K(null)},plan:H}),$&&H&&r.jsx(B,{isOpen:$,onClose:()=>{W(!1),K(null)},onSuccess:()=>{W(!1),K(null),ne()},plan:H}),z&&H&&r.jsx(A,{isOpen:z,onClose:()=>{R(!1),K(null)},onSuccess:()=>{R(!1),K(null),ne()},plan:H,paymentAccounts:re,currentUser:l}),Z&&H&&r.jsx(L,{isOpen:Z,onClose:()=>{M(!1),K(null)},plan:H}),Q&&H&&r.jsx(O,{isOpen:Q,onClose:()=>{V(!1),K(null)},plan:H})]})},I=({isOpen:e,onClose:s,onSuccess:a,customers:i,paymentAccounts:c,currentUser:o})=>{const{currentBranch:x}=t(),[u,p]=n.useState([]),[h,b]=n.useState(!1),[y,j]=n.useState({customer_id:"",sale_id:"",total_amount:0,down_payment:0,number_of_installments:3,payment_frequency:"monthly",start_date:(new Date).toISOString().split("T")[0],late_fee_amount:0,notes:"",payment_method:"cash",account_id:""}),[f,N]=n.useState(!1);n.useEffect(()=>{(async()=>{if(e){b(!0);try{const{data:e,error:s}=await l.from("lats_sales").select("\n            id,\n            sale_number,\n            customer_id,\n            total_amount,\n            payment_status,\n            created_at,\n            customers (name, phone)\n          ").eq("branch_id",null==x?void 0:x.id).in("payment_status",["unpaid","partial"]).order("created_at",{ascending:!1}).limit(50);!s&&e&&p(e)}catch(s){}finally{b(!1)}}})()},[e,null==x?void 0:x.id]);const v=(y.total_amount||0)-(y.down_payment||0),_=v/(y.number_of_installments||1);return e?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:r.jsx(g,{className:"w-5 h-5 text-blue-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Create Installment Plan"}),r.jsx("p",{className:"text-sm text-gray-600",children:"Set up payment plan for customer"})]})]}),r.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:r.jsx(w,{size:20})})]}),r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),y.customer_id&&y.account_id){N(!0);try{const e=await d.createInstallmentPlan(y,null==o?void 0:o.id,null==x?void 0:x.id);e.success?(a(),successModal.show("Installment plan has been created successfully!",{title:"Plan Created",actionButtons:[{label:"View Plans",onClick:()=>{},variant:"primary"}]})):m.error(e.error||"Failed to create installment plan")}catch(s){m.error(s.message||"An error occurred")}finally{N(!1)}}else m.error("Please fill in all required fields")},className:"p-6 space-y-4",children:[r.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[r.jsx("label",{className:"block text-sm font-medium text-blue-900 mb-1",children:"Link to Existing Sale (Optional)"}),r.jsxs("select",{value:y.sale_id,onChange:e=>(e=>{const s=u.find(s=>s.id===e);j(s?t=>({...t,sale_id:e,customer_id:s.customer_id,total_amount:s.total_amount,notes:`Linked to sale ${s.sale_number}`}):e=>({...e,sale_id:"",total_amount:0,notes:""}))})(e.target.value),className:"w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white",disabled:h,children:[r.jsx("option",{value:"",children:"-- Create New Installment (No Sale Link) --"}),u.map(e=>{var s;return r.jsxs("option",{value:e.id,children:[e.sale_number," - ",null==(s=e.customers)?void 0:s.name," - ",new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e.total_amount)," (",e.payment_status,")"]},e.id)})]}),r.jsx("p",{className:"text-xs text-blue-700 mt-2",children:"ðŸ’¡ Link to an unpaid sale to auto-populate customer and amount"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Customer ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:y.customer_id,onChange:e=>j(s=>({...s,customer_id:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:!!y.sale_id,children:[r.jsx("option",{value:"",children:"Select Customer"}),i.map(e=>r.jsxs("option",{value:e.id,children:[e.name," - ",e.phone]},e.id))]}),y.sale_id&&r.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"âœ“ Auto-selected from linked sale"})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Total Amount ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"number",value:y.total_amount,onChange:e=>j(s=>({...s,total_amount:parseFloat(e.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed",min:"0",step:"0.01",required:!0,disabled:!!y.sale_id}),y.sale_id&&r.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"âœ“ Auto-populated from linked sale"})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Down Payment ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"number",value:y.down_payment,onChange:e=>j(s=>({...s,down_payment:parseFloat(e.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"0.01",required:!0})]})]}),r.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:r.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-600",children:"Amount to Finance:"}),r.jsx("div",{className:"font-bold text-blue-900",children:v.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-600",children:"Per Installment:"}),r.jsx("div",{className:"font-bold text-blue-900",children:_.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]})]})}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Number of Installments ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"number",value:y.number_of_installments,onChange:e=>j(s=>({...s,number_of_installments:parseInt(e.target.value)||1})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"1",required:!0})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Frequency ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:y.payment_frequency,onChange:e=>j(s=>({...s,payment_frequency:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[r.jsx("option",{value:"weekly",children:"Weekly"}),r.jsx("option",{value:"bi_weekly",children:"Bi-Weekly"}),r.jsx("option",{value:"monthly",children:"Monthly"})]})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Start Date ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"date",value:y.start_date,onChange:e=>j(s=>({...s,start_date:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Late Fee Amount"}),r.jsx("input",{type:"number",value:y.late_fee_amount,onChange:e=>j(s=>({...s,late_fee_amount:parseFloat(e.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"0.01"})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:y.payment_method,onChange:e=>j(s=>({...s,payment_method:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[r.jsx("option",{value:"cash",children:"Cash"}),r.jsx("option",{value:"mobile_money",children:"Mobile Money"}),r.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),r.jsx("option",{value:"card",children:"Card"})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Account ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:y.account_id,onChange:e=>j(s=>({...s,account_id:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[r.jsx("option",{value:"",children:"Select Account"}),c.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),r.jsx("textarea",{value:y.notes,onChange:e=>j(s=>({...s,notes:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Plan details...",rows:2})]}),r.jsxs("div",{className:"flex gap-3 pt-4",children:[r.jsx("button",{type:"button",onClick:s,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),r.jsx("button",{type:"submit",disabled:f,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:f?"Creating...":"Create Installment Plan"})]})]})]})}):null},A=({isOpen:e,onClose:s,onSuccess:t,plan:a,paymentAccounts:l,currentUser:i})=>{var c;const o=()=>{const e=Number(a.installment_amount||0),s=Number(a.balance_due||0);return Number(s>0&&s<e?s.toFixed(2):e.toFixed(2))},x=o(),[u,g]=n.useState({installment_plan_id:a.id,customer_id:a.customer_id,amount:x,payment_method:"cash",account_id:"",reference_number:"",notes:""}),[p,h]=n.useState(!1);n.useEffect(()=>{if(e){const e=o();g({installment_plan_id:a.id,customer_id:a.customer_id,amount:e,payment_method:"cash",account_id:"",reference_number:"",notes:""})}},[e,a.id,a.customer_id,a.installment_amount,a.balance_due]);return e?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:r.jsx(y,{className:"w-5 h-5 text-green-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Record Payment"}),r.jsx("p",{className:"text-sm text-gray-600",children:a.plan_number})]})]}),r.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:r.jsx(w,{size:20})})]}),r.jsx("div",{className:"p-6 bg-gray-50 border-b border-gray-200",children:r.jsxs("div",{className:"space-y-3 text-sm",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{className:"text-gray-600",children:"Customer:"}),r.jsx("span",{className:"font-medium text-gray-900",children:null==(c=a.customer)?void 0:c.name})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{className:"text-gray-600",children:"Installments Paid:"}),r.jsxs("span",{className:"font-medium text-gray-900",children:[a.installments_paid," / ",a.number_of_installments]})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{className:"text-gray-600",children:"Remaining Balance:"}),r.jsx("span",{className:"font-bold text-red-600",children:a.balance_due.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]}),r.jsxs("div",{className:"flex justify-between border-t border-gray-300 pt-2 mt-2",children:[r.jsx("span",{className:"text-gray-600",children:"Calculated Installment Amount:"}),r.jsxs("span",{className:"font-bold text-blue-600",children:[Number(a.installment_amount).toFixed(2)," TZS"]})]}),a.balance_due>0&&a.balance_due<a.installment_amount&&r.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx(_,{className:"w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-xs font-semibold text-yellow-800",children:"Final Payment"}),r.jsxs("p",{className:"text-xs text-yellow-700 mt-1",children:["This is the last payment. Amount set to remaining balance: ",r.jsx("strong",{children:a.balance_due.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]})]})]})})]})}),r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),u.account_id){h(!0);try{const e=await d.recordPayment(u,null==i?void 0:i.id);e.success?(m.success("Payment recorded successfully!"),t()):m.error(e.error||"Failed to record payment")}catch(s){m.error(s.message||"An error occurred")}finally{h(!1)}}else m.error("Please select a payment account")},className:"p-6 space-y-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Amount ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("div",{className:"relative",children:r.jsx("input",{type:"number",value:u.amount||"",onChange:e=>g(s=>({...s,amount:parseFloat(e.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter payment amount",min:"0",max:a.balance_due,step:"0.01",required:!0})}),r.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["ðŸ’¡ Default amount is set to the calculated installment price (",Number(a.installment_amount).toFixed(2)," TZS). You can adjust if needed."]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:u.payment_method,onChange:e=>g(s=>({...s,payment_method:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[r.jsx("option",{value:"cash",children:"Cash"}),r.jsx("option",{value:"mobile_money",children:"Mobile Money"}),r.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),r.jsx("option",{value:"card",children:"Card"})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Account ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("select",{value:u.account_id,onChange:e=>g(s=>({...s,account_id:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[r.jsx("option",{value:"",children:"Select Account"}),l.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),r.jsx("input",{type:"text",value:u.reference_number,onChange:e=>g(s=>({...s,reference_number:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Transaction reference"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),r.jsx("textarea",{value:u.notes,onChange:e=>g(s=>({...s,notes:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Payment notes...",rows:2})]}),r.jsxs("div",{className:"flex gap-3 pt-4",children:[r.jsx("button",{type:"button",onClick:s,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),r.jsx("button",{type:"submit",disabled:p,className:"flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?"Recording...":"Record Payment"})]})]})]})}):null},L=({isOpen:e,onClose:s,plan:t})=>{var a;const[l,i]=n.useState([]),[c,o]=n.useState(!0);return n.useEffect(()=>{e&&(async()=>{o(!0);const e=await d.getPaymentSchedule(t.id);i(e),o(!1)})()},[e,t.id]),e?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:r.jsx(h,{className:"w-5 h-5 text-purple-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Payment Schedule"}),r.jsxs("p",{className:"text-sm text-gray-600",children:[t.plan_number," - ",null==(a=t.customer)?void 0:a.name]})]})]}),r.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:r.jsx(w,{size:20})})]}),r.jsx("div",{className:"p-6",children:c?r.jsxs("div",{className:"text-center py-8",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),r.jsx("p",{className:"text-gray-600 mt-2",children:"Loading schedule..."})]}):r.jsx("div",{className:"space-y-2",children:l.map(e=>r.jsx("div",{className:"p-4 rounded-lg border-2 "+("paid"===e.status?"bg-green-50 border-green-200":"overdue"===e.status?"bg-red-50 border-red-200":"bg-gray-50 border-gray-200"),children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("div",{className:"w-10 h-10 rounded-full flex items-center justify-center font-bold "+("paid"===e.status?"bg-green-100 text-green-700":"overdue"===e.status?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"),children:["#",e.installment_number]}),r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium text-gray-900",children:["Due: ",new Date(e.due_date).toLocaleDateString()]}),e.paid_date&&r.jsxs("div",{className:"text-xs text-gray-600",children:["Paid: ",new Date(e.paid_date).toLocaleDateString()]})]})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("div",{className:"font-bold text-gray-900",children:e.amount.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})}),r.jsx("div",{className:"text-xs font-semibold uppercase "+("paid"===e.status?"text-green-600":"overdue"===e.status?"text-red-600":"text-gray-600"),children:e.status})]})]})},e.installment_number))})}),r.jsx("div",{className:"p-6 border-t border-gray-200",children:r.jsx("button",{onClick:s,className:"w-full px-4 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})})]})}):null},q=({isOpen:e,onClose:s,plan:t})=>{var a,i,c,o,x,u;const[g,p]=n.useState([]),[b,j]=n.useState(!0),[f,v]=n.useState(t),[z,I]=n.useState([]),[A,L]=n.useState(null),[q,B]=n.useState(null);if(n.useEffect(()=>{(async()=>{if(!e||!t.id)return;j(!0);const s=await d.getInstallmentPlanById(t.id);if(s){if(v(s),p(s.payments||[]),s.sale_id){const{data:e}=await l.from("lats_sale_items").select("*").eq("sale_id",s.sale_id);if(e&&e.length>0){const s=[...new Set(e.map(e=>e.product_id).filter(Boolean))],t=[...new Set(e.map(e=>e.variant_id).filter(Boolean))],[a,r]=await Promise.all([s.length>0?l.from("lats_products").select("id, name, sku").in("id",s):{data:[]},t.length>0?l.from("lats_product_variants").select("id, name, variant_name, sku").in("id",t):{data:[]}]),n=new Map((a.data||[]).map(e=>[e.id,e])),d=new Map((r.data||[]).map(e=>[e.id,{...e,name:e.name||e.variant_name||"Unnamed"}])),i=e.map(e=>({...e,lats_products:n.get(e.product_id),lats_product_variants:d.get(e.variant_id)}));I(i)}}if(s.branch_id){const{data:e}=await l.from("store_locations").select("id, name, address").eq("id",s.branch_id).single();e&&L(e)}if(s.created_by){const{data:e}=await l.from("users").select("id, full_name, email").eq("id",s.created_by).single();e&&B(e)}}j(!1)})()},[e,t.id,t.updated_at]),!e)return null;const O=e=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e),R=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),Z=(()=>{const e=[],s=new Date(f.start_date);for(let t=0;t<f.number_of_installments;t++){const a=new Date(s);"weekly"===f.payment_frequency?a.setDate(s.getDate()+7*t):"monthly"===f.payment_frequency?a.setMonth(s.getMonth()+t):"bi-weekly"===f.payment_frequency&&a.setDate(s.getDate()+14*t);const r=g.find(e=>e.installment_number===t+1),l=r&&"paid"===r.status,n=!l&&new Date>a;e.push({installmentNumber:t+1,dueDate:a.toISOString(),amount:f.installment_amount,status:l?"paid":n?"overdue":"pending",payment:r,daysOverdue:n?Math.floor(((new Date).getTime()-a.getTime())/864e5):0})}return e})();return r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-indigo-500 to-indigo-600",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-white rounded-lg",children:r.jsx(C,{className:"w-6 h-6 text-indigo-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-xl font-bold text-white",children:f.plan_number}),r.jsx("p",{className:"text-sm text-indigo-100",children:"Installment Plan Details"})]})]}),r.jsx("button",{onClick:s,className:"p-2 text-white hover:bg-white/20 rounded-lg transition-colors",children:r.jsx(w,{size:24})})]}),r.jsxs("div",{className:"p-6 space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-3",children:"Customer Information"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Name:"}),r.jsx("span",{className:"font-medium text-gray-900",children:null==(a=f.customer)?void 0:a.name})]}),r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Phone:"}),r.jsx("span",{className:"font-medium text-gray-900",children:null==(i=f.customer)?void 0:i.phone})]}),(null==(c=f.customer)?void 0:c.email)&&r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Email:"}),r.jsx("span",{className:"font-medium text-gray-900",children:f.customer.email})]})]})]}),r.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border border-purple-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-purple-900 mb-3",children:"Plan Status"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Status:"}),r.jsx("span",{className:"font-bold uppercase px-2 py-1 rounded text-xs "+("active"===f.status?"bg-green-100 text-green-700":"completed"===f.status?"bg-gray-100 text-gray-700":"defaulted"===f.status?"bg-red-100 text-red-700":"bg-orange-100 text-orange-700"),children:f.status})]}),r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Created:"}),r.jsx("span",{className:"font-medium text-gray-900",children:R(f.created_at)})]}),r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{className:"text-gray-600",children:"Reminders Sent:"}),r.jsx("span",{className:"font-medium text-gray-900",children:f.reminder_count})]})]})]})]}),r.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200",children:[r.jsx("h4",{className:"text-lg font-semibold text-green-900 mb-4",children:"Financial Summary"}),r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Amount"}),r.jsx("p",{className:"text-lg font-bold text-gray-900",children:O(f.total_amount)})]}),r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Down Payment"}),r.jsx("p",{className:"text-lg font-bold text-blue-600",children:O(f.down_payment)})]}),r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Paid"}),r.jsx("p",{className:"text-lg font-bold text-green-600",children:O(f.total_paid||0)})]}),r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Balance Due"}),r.jsx("p",{className:"text-lg font-bold text-red-600",children:O(f.balance_due)})]})]}),r.jsxs("div",{className:"mt-4 pt-4 border-t border-green-200",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsx("span",{className:"text-sm text-gray-600",children:"Payment Progress"}),r.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:[((f.total_paid||0)/f.total_amount*100).toFixed(1),"%"]})]}),r.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:r.jsx("div",{className:"bg-green-600 h-3 rounded-full transition-all",style:{width:(f.total_paid||0)/f.total_amount*100+"%"}})})]})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Installment Amount"}),r.jsx("p",{className:"text-xl font-bold text-gray-900",children:O(f.installment_amount)}),r.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["per ",f.payment_frequency]})]}),r.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Installments"}),r.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[f.installments_paid," / ",f.number_of_installments]}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"paid"})]}),r.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Next Payment"}),r.jsx("p",{className:"text-xl font-bold text-gray-900",children:f.next_payment_date?R(f.next_payment_date):"Completed"}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"due date"})]})]}),r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[r.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50",children:r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[r.jsx(h,{size:16,className:"text-indigo-600"}),"Installment Schedule"]})}),r.jsx("div",{className:"overflow-x-auto",children:r.jsxs("table",{className:"w-full",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"#"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Due Date"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Amount"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Status"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Paid On"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200",children:Z.map(e=>r.jsxs("tr",{className:`\n                        ${"paid"===e.status?"bg-green-50":""}\n                        ${"overdue"===e.status?"bg-red-50":""}\n                        hover:bg-gray-50 transition-colors\n                      `,children:[r.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.installmentNumber}),r.jsxs("td",{className:"px-4 py-3 text-sm text-gray-900",children:[R(e.dueDate),"overdue"===e.status&&r.jsxs("span",{className:"ml-2 text-xs text-red-600",children:["(",e.daysOverdue," days late)"]})]}),r.jsx("td",{className:"px-4 py-3 text-sm font-semibold text-gray-900",children:O(e.amount)}),r.jsx("td",{className:"px-4 py-3",children:r.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+("paid"===e.status?"bg-green-100 text-green-800":"overdue"===e.status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:e.status.toUpperCase()})}),r.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.payment?R(e.payment.payment_date):"-"})]},e.installmentNumber))})]})})]}),z.length>0&&r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[r.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50",children:r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[r.jsx(S,{size:16,className:"text-blue-600"}),"Product Details ",(null==(o=f.sale)?void 0:o.sale_number)&&r.jsxs("span",{className:"text-xs text-gray-600 ml-2",children:["(Sale: ",f.sale.sale_number,")"]})]})}),r.jsx("div",{className:"overflow-x-auto",children:r.jsxs("table",{className:"w-full",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Product"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"SKU"}),r.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Qty"}),r.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Unit Price"}),r.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Total"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200",children:z.map((e,s)=>{var t,a,l,n;return r.jsxs("tr",{className:"hover:bg-gray-50",children:[r.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:r.jsxs("div",{children:[r.jsx("div",{className:"font-medium",children:(null==(t=e.lats_products)?void 0:t.name)||"Unknown Product"}),(null==(a=e.lats_product_variants)?void 0:a.name)&&r.jsx("div",{className:"text-xs text-gray-500",children:e.lats_product_variants.name})]})}),r.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:(null==(l=e.lats_product_variants)?void 0:l.sku)||(null==(n=e.lats_products)?void 0:n.sku)||"-"}),r.jsx("td",{className:"px-4 py-3 text-sm text-right font-medium text-gray-900",children:e.quantity}),r.jsx("td",{className:"px-4 py-3 text-sm text-right text-gray-900",children:O(e.unit_price||e.price||0)}),r.jsx("td",{className:"px-4 py-3 text-sm text-right font-semibold text-gray-900",children:O(e.total_price||0)})]},e.id||s)})})]})})]}),(A||q)&&r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[r.jsx(k,{size:16,className:"text-purple-600"}),"Business Context"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[A&&r.jsxs("div",{className:"bg-purple-50 p-3 rounded-lg",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Branch"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:A.name}),A.address&&r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:A.address})]}),q&&r.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Created By"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:q.full_name}),q.email&&r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:q.email})]})]})]}),r.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Important Dates"}),r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600",children:"Start Date"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:R(f.start_date)})]}),r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600",children:"End Date"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:R(f.end_date)})]}),f.completion_date&&r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600",children:"Completed On"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:R(f.completion_date)})]}),f.last_reminder_sent&&r.jsxs("div",{children:[r.jsx("p",{className:"text-xs text-gray-600",children:"Last Reminder"}),r.jsx("p",{className:"text-sm font-medium text-gray-900",children:R(f.last_reminder_sent)})]})]})]}),r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[r.jsx(_,{size:16,className:"text-orange-600"}),"Payment Terms"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Late Fee Rate"}),r.jsx("p",{className:"text-lg font-bold text-orange-600",children:O(f.late_fee_amount||0)}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"per missed payment"})]}),r.jsxs("div",{className:"p-3 rounded-lg "+(f.late_fee_applied>0?"bg-red-50":"bg-gray-50"),children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Late Fees Applied"}),r.jsx("p",{className:"text-lg font-bold "+(f.late_fee_applied>0?"text-red-600":"text-gray-500"),children:O(f.late_fee_applied||0)}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"accumulated"})]}),r.jsxs("div",{className:"p-3 rounded-lg "+(f.days_overdue>0?"bg-red-50":"bg-green-50"),children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Days Overdue"}),r.jsx("p",{className:"text-lg font-bold "+(f.days_overdue>0?"text-red-600":"text-green-600"),children:f.days_overdue||0}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:f.days_overdue>0?"action required":"on track"})]})]})]}),r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[r.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50",children:r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[r.jsx(P,{size:16,className:"text-yellow-600"}),"Activity & Reminders"]})}),r.jsxs("div",{className:"p-4 space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Total Reminders Sent"}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"WhatsApp notifications to customer"})]}),r.jsx("span",{className:"text-2xl font-bold text-blue-600",children:f.reminder_count||0})]}),f.last_reminder_sent&&r.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Last Reminder Sent"}),r.jsx("p",{className:"text-xs text-blue-600 mt-1",children:R(f.last_reminder_sent)})]}),r.jsx(D,{className:"text-blue-600",size:20})]}),f.terms_accepted&&r.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-green-900",children:"Terms Accepted"}),r.jsx("p",{className:"text-xs text-green-600 mt-1",children:R(f.terms_accepted_date||f.created_at)})]}),r.jsx(D,{className:"text-green-600",size:20})]}),!f.terms_accepted&&r.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-red-900",children:"Terms Not Accepted"}),r.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Customer agreement pending"})]}),r.jsx(_,{className:"text-red-600",size:20})]})]})]}),f.notes&&r.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-yellow-900 mb-2",children:"Notes"}),r.jsx("p",{className:"text-sm text-gray-700",children:f.notes})]}),r.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[r.jsx("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:r.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[r.jsx(N,{size:16}),"Recent Payments (",g.length,")"]})}),r.jsx("div",{className:"max-h-60 overflow-y-auto",children:b?r.jsx("div",{className:"p-8 text-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"})}):0===g.length?r.jsx("div",{className:"p-8 text-center text-gray-500",children:"No payments recorded yet"}):r.jsx("div",{className:"divide-y divide-gray-200",children:g.map((e,s)=>r.jsx("div",{className:"p-4 hover:bg-gray-50",children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("p",{className:"font-medium text-gray-900",children:["Payment #",e.installment_number]}),r.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[R(e.payment_date)," â€¢ ",e.payment_method]}),e.reference_number&&r.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ref: ",e.reference_number]})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("p",{className:"text-lg font-bold text-green-600",children:O(e.amount)}),r.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-semibold rounded",children:e.status})]})]})},e.id||s))})})]})]}),r.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:r.jsxs("div",{className:"flex flex-wrap gap-3",children:["active"===f.status&&f.balance_due>0&&r.jsxs("button",{onClick:()=>{s()},className:"flex-1 min-w-[200px] px-4 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[r.jsx(y,{size:18}),"Record Payment"]}),"active"===f.status&&(null==(x=f.customer)?void 0:x.phone)&&r.jsxs("button",{onClick:async()=>{try{await d.sendPaymentReminder(f.id),m.success("Reminder sent successfully!");const e=await d.getInstallmentPlanById(f.id);e&&v(e)}catch(e){m.error(e.message||"Failed to send reminder")}},className:"flex-1 min-w-[200px] px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2",children:[r.jsx(P,{size:18}),"Send Reminder"]}),r.jsxs("button",{onClick:()=>{window.print()},className:"px-4 py-2.5 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2",children:[r.jsx(T,{size:18}),"Print"]}),(null==(u=f.customer)?void 0:u.id)&&r.jsxs("button",{onClick:()=>{window.location.href=`/customers?id=${f.customer.id}`},className:"px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2",children:[r.jsx(F,{size:18}),"View Customer"]}),r.jsx("button",{onClick:s,className:"px-6 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})]})})]})})},B=({isOpen:e,onClose:s,onSuccess:t,plan:a})=>{const[l,i]=n.useState({late_fee_amount:a.late_fee_amount,notes:a.notes||"",status:a.status}),[c,o]=n.useState(!1);return e?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:r.jsx(j,{className:"w-5 h-5 text-blue-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Installment Plan"}),r.jsx("p",{className:"text-sm text-gray-600",children:a.plan_number})]})]}),r.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:r.jsx(w,{size:20})})]}),r.jsxs("form",{onSubmit:async e=>{e.preventDefault(),o(!0);try{const e=await d.updateInstallmentPlan(a.id,l);e.success?(m.success("Installment plan updated successfully!"),t()):m.error(e.error||"Failed to update installment plan")}catch(s){m.error(s.message||"An error occurred")}finally{o(!1)}},className:"p-6 space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),r.jsxs("select",{value:l.status,onChange:e=>i(s=>({...s,status:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[r.jsx("option",{value:"active",children:"Active"}),r.jsx("option",{value:"completed",children:"Completed"}),r.jsx("option",{value:"defaulted",children:"Defaulted"}),r.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Late Fee Amount"}),r.jsx("input",{type:"number",value:l.late_fee_amount,onChange:e=>i(s=>({...s,late_fee_amount:parseFloat(e.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"0.01"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),r.jsx("textarea",{value:l.notes,onChange:e=>i(s=>({...s,notes:e.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Plan notes...",rows:3})]}),r.jsxs("div",{className:"flex gap-3 pt-4",children:[r.jsx("button",{type:"button",onClick:s,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),r.jsx("button",{type:"submit",disabled:c,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Updating...":"Update Plan"})]})]})]})}):null},O=({isOpen:e,onClose:s,plan:t})=>{var a;const[l,i]=n.useState([]),[o,m]=n.useState(!0);if(n.useEffect(()=>{(async()=>{if(!e||!t.id)return;m(!0);const s=await d.getInstallmentPlanById(t.id);(null==s?void 0:s.payments)&&i(s.payments),m(!1)})()},[e,t.id]),!e)return null;const x=e=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e),u=l.reduce((e,s)=>e+Number(s.amount||0),0);return r.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:[r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:r.jsx(N,{className:"w-5 h-5 text-gray-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Payment History"}),r.jsxs("p",{className:"text-sm text-gray-600",children:[t.plan_number," - ",null==(a=t.customer)?void 0:a.name]})]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>{window.print()},className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Print",children:r.jsx(T,{size:20})}),r.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:r.jsx(w,{size:20})})]})]}),r.jsx("div",{className:"p-6 bg-gray-50 border-b border-gray-200",children:r.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[r.jsxs("div",{className:"text-center",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Payments"}),r.jsx("p",{className:"text-2xl font-bold text-gray-900",children:l.length})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Paid"}),r.jsx("p",{className:"text-2xl font-bold text-green-600",children:x(u)})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Balance"}),r.jsx("p",{className:"text-2xl font-bold text-red-600",children:x(t.balance_due)})]})]})}),r.jsx("div",{className:"p-6",children:o?r.jsxs("div",{className:"text-center py-8",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Loading payment history..."})]}):0===l.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(N,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No payments recorded yet"}),r.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Payment history will appear here"})]}):r.jsx("div",{className:"space-y-3",children:l.map((e,s)=>{return r.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow",children:[r.jsxs("div",{className:"flex justify-between items-start mb-3",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center",children:r.jsxs("span",{className:"text-green-700 font-bold",children:["#",e.installment_number]})}),r.jsxs("div",{children:[r.jsxs("p",{className:"font-semibold text-gray-900",children:["Installment Payment ",e.installment_number]}),r.jsx("p",{className:"text-xs text-gray-600",children:(t=e.payment_date,new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}))})]})]}),r.jsxs("div",{className:"text-right",children:[r.jsx("p",{className:"text-xl font-bold text-green-600",children:x(e.amount)}),r.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded "+("paid"===e.status?"bg-green-100 text-green-700":"late"===e.status?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"),children:e.status})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-600",children:"Payment Method:"}),r.jsx("span",{className:"font-medium text-gray-900 ml-2",children:e.payment_method})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-600",children:"Due Date:"}),r.jsx("span",{className:"font-medium text-gray-900 ml-2",children:new Date(e.due_date).toLocaleDateString()})]}),e.reference_number&&r.jsxs("div",{className:"col-span-2",children:[r.jsx("span",{className:"text-gray-600",children:"Reference:"}),r.jsx("span",{className:"font-medium text-gray-900 ml-2",children:e.reference_number})]}),e.late_fee>0&&r.jsxs("div",{className:"col-span-2",children:[r.jsx("span",{className:"text-red-600",children:"Late Fee:"}),r.jsx("span",{className:"font-medium text-red-600 ml-2",children:x(e.late_fee)})]}),e.notes&&r.jsxs("div",{className:"col-span-2",children:[r.jsx("span",{className:"text-gray-600",children:"Notes:"}),r.jsx("p",{className:"text-gray-700 mt-1 text-sm",children:e.notes})]})]})]},e.id||s);var t})})}),r.jsx("div",{className:"p-6 border-t border-gray-200",children:r.jsx("button",{onClick:s,className:"w-full px-4 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})})]}),r.jsx(c,{...successModal.props})]})};export{z as default};
