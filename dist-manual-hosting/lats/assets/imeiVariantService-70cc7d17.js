import{s as t}from"./index-222cfb29.js";import"./vendor-a2ff445a.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";import"./ui-551a39a6.js";const a=async a=>{try{const{data:r,error:e}=await t.rpc("get_parent_variants",{product_id_param:a});if(e)throw e;return r||[]}catch(r){try{const{data:r,error:e}=await t.from("lats_product_variants").select("*").eq("product_id",a).eq("is_active",!0).in("variant_type",["parent","standard"]).order("created_at",{ascending:!0});if(e)throw e;return r||[]}catch(e){return[]}}},r=async a=>{try{const r=Date.now().toString(36),e=a.sku||`VAR-${r}`,{data:i,error:n}=await t.from("lats_product_variants").insert({product_id:a.product_id,variant_name:a.variant_name,sku:e,cost_price:a.cost_price||0,selling_price:a.selling_price||0,quantity:0,is_active:!0,is_parent:!0,variant_type:"parent",variant_attributes:a.attributes||{},branch_id:a.branch_id}).select().single();if(n)throw n;return{success:!0,data:i}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to create parent variant"}}},e=async a=>{try{const{error:r}=await t.from("lats_product_variants").update({is_parent:!0,variant_type:"parent",updated_at:(new Date).toISOString()}).eq("id",a);if(r)throw r;return{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to convert variant"}}},i=async a=>{try{const{data:r,error:e}=await t.from("lats_product_variants").select("id").eq("variant_attributes->>imei",a).maybeSingle();return(!e||"PGRST116"===e.code)&&!!r}catch(r){return!1}},n=async(a,r)=>{try{const e={parent_variant_id_param:a,imei_param:r.imei,serial_number_param:r.serial_number,mac_address_param:r.mac_address,cost_price_param:r.cost_price,selling_price_param:r.selling_price,condition_param:r.condition||"new",notes_param:r.notes},{data:i,error:n}=await t.rpc("add_imei_to_parent_variant",e);if(n)throw n;const s=null==i?void 0:i[0];if(!(null==s?void 0:s.success))throw new Error((null==s?void 0:s.error_message)||"Failed to add IMEI");return{success:!0,child_variant_id:s.child_variant_id,imei:r.imei}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to add IMEI"}}},s=async(t,a)=>{const r=[],e=[];for(const i of a){0;const a=await n(t,i);a.success?r.push(a):e.push({imei:i.imei,error:a.error})}return e.length,{success:0===e.length,created:r.length,failed:e.length,data:r,errors:e}},c=async a=>{try{const{data:r,error:e}=await t.rpc("get_child_imeis",{parent_variant_id_param:a});if(e)throw e;return(r||[]).map(t=>{var r;return{id:t.child_id,parent_variant_id:a,product_id:"",imei:t.imei,serial_number:t.serial_number,condition:(null==(r=t.variant_attributes)?void 0:r.condition)||"new",cost_price:t.cost_price,selling_price:t.selling_price,quantity:t.quantity,is_active:"available"===t.status,created_at:t.created_at,variant_attributes:t.variant_attributes}})}catch(r){try{const{data:r,error:e}=await t.from("lats_product_variants").select("*").eq("parent_variant_id",a).eq("variant_type","imei_child").order("created_at",{ascending:!1});if(e)throw e;return(r||[]).map(t=>{var r,e,i;return{id:t.id,parent_variant_id:a,product_id:t.product_id,imei:null==(r=t.variant_attributes)?void 0:r.imei,serial_number:null==(e=t.variant_attributes)?void 0:e.serial_number,condition:(null==(i=t.variant_attributes)?void 0:i.condition)||"new",cost_price:t.cost_price,selling_price:t.selling_price,quantity:t.quantity,is_active:t.is_active,created_at:t.created_at,variant_attributes:t.variant_attributes}})}catch(e){return[]}}},_=async a=>{try{const{data:r,error:e}=await t.rpc("get_available_imeis_for_pos",{parent_variant_id_param:a});if(e)throw e;return(r||[]).map(t=>({id:t.child_id,parent_variant_id:a,product_id:"",imei:t.imei,serial_number:t.serial_number,condition:t.condition||"new",cost_price:t.cost_price,selling_price:t.selling_price,quantity:1,is_active:!0,created_at:t.created_at,variant_attributes:{}}))}catch(r){return(await c(a)).filter(t=>t.is_active&&t.quantity>0)}},o=async(a,r)=>{try{const{data:e,error:i}=await t.rpc("mark_imei_as_sold",{child_variant_id_param:a,sale_id_param:r});if(i)throw i;return{success:!0,data:e}}catch(e){try{const{error:r}=await t.from("lats_product_variants").update({quantity:0,is_active:!1,variant_attributes:t.rpc("jsonb_set",{target:t.sql`variant_attributes`,path:"{sold_at}",value:(new Date).toISOString()}),updated_at:(new Date).toISOString()}).eq("id",a);if(r)throw r;return{success:!0}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Failed to mark as sold"}}}},d=async t=>{const{product_id:a,variants:r,branch_id:e}=t;return t.parent_variant_id?await s(t.parent_variant_id,r):{success:!1,error:"parent_variant_id is required. Create a parent variant first."}},u=async a=>{try{const{data:r,error:e}=await t.from("lats_product_variants").select("\n        *,\n        parent:lats_product_variants!parent_variant_id(\n          id,\n          variant_name,\n          name,\n          sku\n        ),\n        product:lats_products(\n          id,\n          name,\n          sku\n        )\n      ").eq("variant_attributes->>imei",a).maybeSingle();return e&&"PGRST116"!==e.code?null:r}catch(r){return null}},p=async(a,r)=>{try{let e=t.from("lats_product_variants").select("\n        *,\n        parent:lats_product_variants!parent_variant_id(\n          id,\n          variant_name,\n          name\n        ),\n        product:lats_products(\n          id,\n          name\n        )\n      ").eq("variant_type","imei_child").or(`variant_attributes->>imei.ilike.%${a}%,variant_attributes->>serial_number.ilike.%${a}%`);r&&(e=e.eq("branch_id",r));const{data:i,error:n}=await e.order("created_at",{ascending:!1}).limit(50);if(n)throw n;return i||[]}catch(e){return[]}},l=async(a,r)=>{try{let e=t.from("lats_product_variants").select("\n        *,\n        parent:lats_product_variants!parent_variant_id(\n          id,\n          variant_name,\n          name\n        )\n      ").eq("product_id",a).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0);r&&(e=e.eq("branch_id",r));const{data:i,error:n}=await e.order("created_at",{ascending:!1});if(n)throw n;return i||[]}catch(e){return[]}},v=async a=>{try{const{data:r,error:e}=await t.rpc("calculate_parent_variant_stock",{parent_variant_id_param:a});if(e)throw e;return r||0}catch(r){return 0}},m=async(t,a,r,e)=>{const i=a.map(t=>({imei:t.trim(),cost_price:r,selling_price:e,condition:"new",source:"purchase"}));return await s(t,i)},h=async a=>{try{const{data:r,error:e}=await t.from("lats_product_variants").select("\n        *,\n        parent:lats_product_variants!parent_variant_id(\n          id,\n          variant_name,\n          name,\n          sku\n        ),\n        product:lats_products(\n          id,\n          name,\n          description,\n          sku,\n          category:lats_categories(id, name)\n        )\n      ").eq("id",a).single();if(e)throw e;return{success:!0,data:r}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to get variant details"}}},y=async(a,r)=>{try{const{data:e}=await t.from("lats_product_variants").select("variant_attributes").eq("id",a).single(),i={...(null==e?void 0:e.variant_attributes)||{},...r},{data:n,error:s}=await t.from("lats_product_variants").update({cost_price:r.cost_price,selling_price:r.selling_price,variant_attributes:i,updated_at:(new Date).toISOString()}).eq("id",a).select().single();if(s)throw s;return{success:!0,data:n}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to update variant"}}},w=async a=>{try{const{error:r}=await t.from("lats_product_variants").update({is_active:!1,quantity:0,updated_at:(new Date).toISOString()}).eq("id",a);if(r)throw r;return{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to delete variant"}}},g=o,f=l;export{n as addIMEIToParentVariant,s as addIMEIsToParentVariant,m as batchAddIMEIVariants,v as calculateParentStock,i as checkIMEIExists,e as convertToParentVariant,d as createIMEIVariants,r as createParentVariant,w as deleteIMEIVariant,f as getAvailableIMEIVariants,l as getAvailableIMEIVariantsForProduct,_ as getAvailableIMEIsForPOS,c as getChildIMEIs,h as getIMEIVariantDetails,a as getParentVariantsForProduct,u as getVariantByIMEI,o as markIMEIAsSold,p as searchIMEIVariants,g as selectIMEIVariantForSale,y as updateIMEIVariant};
