import{s as e,j as s,d as a,G as t,u as r}from"./index-222cfb29.js";import{r as i}from"./vendor-a2ff445a.js";import{S as n}from"./SearchBar-2b6f451f.js";import{G as l}from"./GlassSelect-3b56e5f5.js";import{B as c}from"./BackButton-e41d1482.js";import{o,s as d,e as m,b as x,a as u,u as p,C as h}from"./forms-fd94c8fb.js";import{t as g}from"./zod-4c7d126c.js";import{G as j}from"./GlassInput-ba5c3c0d.js";import{n as y,o as f,X as b,U as v,j as N,P as w,a4 as C,k as _,d as k,ay as S,v as A,ak as z,q as D,bi as P,K as U,a2 as R,N as B,Q as M,r as E,$ as F,t as I,bd as L,A as $,aE as O,e as q,bc as V,bh as T,bp as G,bb as H,R as J,ai as K,aj as W,a0 as Y,bq as Q,br as Z}from"./ui-551a39a6.js";import{u as X}from"./useBodyScrollLock-0216d39f.js";import{e as ee}from"./employeeService-806781a0.js";import{a as se}from"./routing-a2f0f6d2.js";import"./supabase-7e851d02.js";import"./utils-fb833cf6.js";import"./charts-66cc82bb.js";async function ae(s){try{const{data:a,error:t}=await e.from("user_branch_assignments").select("\n        *,\n        branch:store_locations!branch_id (\n          id,\n          name,\n          code,\n          city,\n          is_main\n        )\n      ").eq("user_id",s).order("is_primary",{ascending:!1});if(t)throw t;return a||[]}catch(a){return[]}}async function te(){try{const{data:s,error:a}=await e.from("store_locations").select("id, name, code, city, is_main, is_active").eq("is_active",!0).order("is_main",{ascending:!1}).order("name");if(a)throw a;return s||[]}catch(s){return[]}}async function re(s,a,t){try{if(await e.from("user_branch_assignments").delete().eq("user_id",s),a.length>0){const r=a.map(e=>({user_id:s,branch_id:e.branch_id,is_primary:e.is_primary||!1,can_manage:e.can_manage||!1,can_view_reports:e.can_view_reports||!1,can_manage_inventory:e.can_manage_inventory||!1,can_manage_staff:e.can_manage_staff||!1,assigned_by:t})),{error:i}=await e.from("user_branch_assignments").insert(r);if(i)throw i}return!0}catch(r){return!1}}const ie={general:{label:"General Access",permissions:[{id:"all",name:"Full Access",description:"Complete system access (Admin only)"},{id:"dashboard",name:"Dashboard Access",description:"View dashboard and analytics"},{id:"pos",name:"POS Access",description:"Access point of sale system"},{id:"reports",name:"View Reports",description:"View business reports"},{id:"settings",name:"Manage Settings",description:"Manage system settings"}]},inventory:{label:"Inventory Management",permissions:[{id:"inventory_view",name:"View Inventory",description:"View inventory levels and products"},{id:"inventory_add",name:"Add Products",description:"Add new products to inventory"},{id:"inventory_edit",name:"Edit Products",description:"Modify existing products"},{id:"inventory_delete",name:"Delete Products",description:"Remove products from inventory"},{id:"inventory_adjust",name:"Adjust Stock",description:"Adjust stock levels"},{id:"inventory_history",name:"View Stock History",description:"View stock movement history"}]},customers:{label:"Customer Management",permissions:[{id:"customers_view",name:"View Customers",description:"View customer information"},{id:"customers_add",name:"Add Customers",description:"Create new customers"},{id:"customers_edit",name:"Edit Customers",description:"Modify customer details"},{id:"customers_delete",name:"Delete Customers",description:"Remove customers"},{id:"customers_history",name:"View Customer History",description:"View customer purchase history"}]},devices:{label:"Device & Repair Management",permissions:[{id:"devices_view",name:"View Devices",description:"View device repairs"},{id:"devices_add",name:"Add Devices",description:"Register new device repairs"},{id:"devices_edit",name:"Edit Devices",description:"Modify device repair information"},{id:"spare_parts",name:"Spare Parts",description:"Manage spare parts inventory"}]},financial:{label:"Financial Operations",permissions:[{id:"sales_process",name:"Process Sales",description:"Complete sales transactions"},{id:"sales_refund",name:"Process Refunds",description:"Issue refunds to customers"},{id:"sales_discount",name:"Apply Discounts",description:"Apply discounts to sales"},{id:"financial_reports",name:"Financial Reports",description:"View financial reports"},{id:"pricing_manage",name:"Manage Pricing",description:"Set and modify product prices"},{id:"payments_view",name:"View Payments",description:"View payment transactions"}]},users:{label:"User Management",permissions:[{id:"users_view",name:"View Users",description:"View user accounts"},{id:"users_create",name:"Create Users",description:"Create new user accounts"},{id:"users_edit",name:"Edit Users",description:"Modify user accounts"},{id:"users_delete",name:"Delete Users",description:"Remove user accounts"},{id:"roles_manage",name:"Manage Roles",description:"Manage user roles and permissions"}]},system:{label:"System Administration",permissions:[{id:"audit_logs",name:"View Audit Logs",description:"View system audit logs"},{id:"backup_data",name:"Backup Data",description:"Create data backups"},{id:"restore_data",name:"Restore Data",description:"Restore from backups"},{id:"integrations",name:"Manage Integrations",description:"Configure system integrations"},{id:"database_setup",name:"Database Setup",description:"Manage database configuration"}]},features:{label:"Additional Features",permissions:[{id:"appointments",name:"Appointments",description:"Manage appointments"},{id:"whatsapp",name:"WhatsApp Integration",description:"Use WhatsApp features"},{id:"sms",name:"SMS Features",description:"Send SMS messages"},{id:"loyalty",name:"Loyalty Program",description:"Manage loyalty programs"},{id:"employees",name:"Employee Management",description:"Manage employee records"}]}},ne={admin:["all"],manager:["dashboard","pos","reports","inventory_view","inventory_add","inventory_edit","inventory_adjust","inventory_history","customers_view","customers_add","customers_edit","customers_history","devices_view","devices_add","devices_edit","sales_process","sales_refund","sales_discount","financial_reports","payments_view","employees"],technician:["dashboard","devices_view","devices_add","devices_edit","spare_parts","customers_view","inventory_view"],"customer-care":["dashboard","pos","customers_view","customers_add","customers_edit","customers_history","devices_view","devices_add","appointments","whatsapp","sms"],user:["dashboard","inventory_view","customers_view"]},le=o({firstName:d().min(2,"First name must be at least 2 characters"),lastName:d().min(2,"Last name must be at least 2 characters"),email:d().email("Invalid email address"),username:d().min(3,"Username must be at least 3 characters").optional(),phone:d().optional(),role:m(["admin","manager","technician","customer-care","user"]),department:d().optional(),password:d().min(8,"Password must be at least 8 characters"),confirmPassword:d(),accessAllBranches:x().optional(),assignedBranches:u(d()).optional(),permissions:u(d()).optional(),customPermissions:x().optional()}).refine(e=>e.password===e.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),ce=({isOpen:e,onClose:a,onSubmit:t,loading:r=!1})=>{var n;const[c,o]=i.useState(!1),[d,m]=i.useState(!1),[x,u]=i.useState([]),[P,U]=i.useState(!1),[R,B]=i.useState(!1);X(e);const{control:M,handleSubmit:E,formState:{errors:F,isDirty:I},reset:L,watch:$,setValue:O}=p({resolver:g(le),defaultValues:{firstName:"",lastName:"",email:"",username:"",phone:"",role:"user",department:"",password:"",confirmPassword:"",accessAllBranches:!1,assignedBranches:[],permissions:[],customPermissions:!1}}),q=$();i.useEffect(()=>{if(q.role&&!q.customPermissions){const e=ne[q.role]||[];O("permissions",e,{shouldDirty:!0})}},[q.role,q.customPermissions,O]),i.useEffect(()=>{e&&V()},[e]);const V=async()=>{U(!0);try{const e=await te();u(e)}catch(e){y.error("Failed to load branches")}finally{U(!1)}},T=e=>(q.permissions||[]).includes(e),G=[{value:"admin",label:"Administrator",description:"Full system access"},{value:"manager",label:"Manager",description:"Department management"},{value:"technician",label:"Technician",description:"Device repairs"},{value:"customer-care",label:"Customer Care",description:"Customer support"},{value:"user",label:"User",description:"Basic access"}],H=[{value:"IT",label:"IT Department"},{value:"Sales",label:"Sales Department"},{value:"Service",label:"Service Department"},{value:"Support",label:"Support Department"},{value:"Marketing",label:"Marketing Department"},{value:"Finance",label:"Finance Department"},{value:"HR",label:"Human Resources"},{value:"Operations",label:"Operations"}],J=()=>{I?confirm("Are you sure you want to cancel? Your changes will be lost.")&&(L(),a()):a()};return e?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed bg-black/50",onClick:a,style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:35}}),s.jsx("div",{className:"fixed flex items-center justify-center p-4",style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:50,pointerEvents:"none"},children:s.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),style:{pointerEvents:"auto"},children:s.jsxs("form",{onSubmit:E(async e=>{try{await t(e),L(),a()}catch(s){}}),className:"p-6 space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:s.jsx(f,{className:"w-5 h-5 text-blue-600"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Create New User"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Add a new user to the system"})]})]}),s.jsx("button",{type:"button",onClick:J,className:"text-gray-400 hover:text-gray-600 transition-colors",children:s.jsx(b,{className:"w-6 h-6"})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"User Information"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(h,{name:"firstName",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"First Name",placeholder:"Enter first name",value:e.value,onChange:e.onChange,error:null==(a=F.firstName)?void 0:a.message,required:!0,icon:s.jsx(v,{size:16})})}}),s.jsx(h,{name:"lastName",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Last Name",placeholder:"Enter last name",value:e.value,onChange:e.onChange,error:null==(a=F.lastName)?void 0:a.message,required:!0,icon:s.jsx(v,{size:16})})}})]}),s.jsx(h,{name:"email",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Email Address",type:"email",placeholder:"user@company.com",value:e.value,onChange:e.onChange,error:null==(a=F.email)?void 0:a.message,required:!0,icon:s.jsx(N,{size:16})})}}),s.jsx(h,{name:"username",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Username",type:"text",placeholder:"username",value:e.value,onChange:e.onChange,error:null==(a=F.username)?void 0:a.message,icon:s.jsx(v,{size:16}),helperText:"Used for login (optional)"})}}),s.jsx(h,{name:"phone",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Phone Number",type:"tel",placeholder:"+255 123 456 789",value:e.value,onChange:e.onChange,error:null==(a=F.phone)?void 0:a.message,icon:s.jsx(w,{size:16})})}})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Role & Department"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(h,{name:"role",control:M,render:({field:e})=>{var a;return s.jsx(l,{label:"Role",placeholder:"Select role",value:e.value,onChange:e.onChange,error:null==(a=F.role)?void 0:a.message,options:G,required:!0,icon:s.jsx(C,{size:16})})}}),s.jsx(h,{name:"department",control:M,render:({field:e})=>{var a;return s.jsx(l,{label:"Department",placeholder:"Select department",value:e.value,onChange:e.onChange,error:null==(a=F.department)?void 0:a.message,options:H,clearable:!0})}})]}),q.role&&s.jsx("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:s.jsxs("p",{className:"text-sm text-blue-800",children:[s.jsx("strong",{children:"Role Description:"})," ",(e=>{const s=G.find(s=>s.value===e);return(null==s?void 0:s.description)||""})(q.role)]})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[s.jsx(_,{size:20}),"Permissions & Access Control"]}),s.jsxs("button",{type:"button",onClick:()=>B(!R),className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:[R?"Hide":"Show"," Permissions"]})]}),s.jsx("div",{className:"flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-200",children:s.jsx("div",{className:"flex-1",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:q.customPermissions,onChange:e=>{if(O("customPermissions",e.target.checked,{shouldDirty:!0}),!e.target.checked&&q.role){const e=ne[q.role]||[];O("permissions",e,{shouldDirty:!0})}},className:"w-4 h-4 text-amber-600 bg-gray-100 border-gray-300 rounded focus:ring-amber-500"}),s.jsxs("div",{children:[s.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Custom Permissions"}),s.jsx("p",{className:"text-xs text-gray-600",children:"Override role defaults with custom permissions"})]})]})})}),s.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Selected Permissions: ",(q.permissions||[]).length]}),s.jsx("p",{className:"text-xs text-gray-500",children:q.customPermissions?"Custom permissions configured":`Using ${q.role} role defaults`})]}),T("all")&&s.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[s.jsx(k,{size:16}),s.jsx("span",{className:"text-sm font-medium",children:"Full Access"})]})]})}),R&&s.jsxs("div",{className:"space-y-4 border-2 border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Configure Permissions"}),!T("all")&&s.jsx("button",{type:"button",onClick:()=>O("permissions",["all"],{shouldDirty:!0}),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Grant Full Access"})]}),T("all")?s.jsxs("div",{className:"p-6 bg-green-50 rounded-lg border border-green-200 text-center",children:[s.jsx(k,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),s.jsx("p",{className:"text-sm font-medium text-green-900",children:"Full Access Granted"}),s.jsx("p",{className:"text-xs text-green-700 mt-1",children:"This user has complete access to all system features"}),s.jsx("button",{type:"button",onClick:()=>{const e=ne[q.role]||[];O("permissions",e,{shouldDirty:!0})},className:"mt-3 text-xs text-green-700 hover:text-green-800 font-medium underline",children:"Revoke Full Access"})]}):s.jsx("div",{className:"space-y-4",children:Object.entries(ie).map(([e,a])=>{const t=a.permissions.map(e=>e.id),r=t.every(e=>T(e));return s.jsxs("div",{className:"border border-gray-200 rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1",children:[s.jsx("input",{type:"checkbox",checked:r,onChange:()=>(e=>{const s=q.permissions||[];if(e.every(e=>s.includes(e)))O("permissions",s.filter(s=>!e.includes(s)),{shouldDirty:!0});else{const a=[...new Set([...s,...e])];O("permissions",a,{shouldDirty:!0})}})(t),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("span",{className:"font-medium text-sm text-gray-900",children:a.label})]}),s.jsxs("span",{className:"text-xs text-gray-500",children:[t.filter(e=>T(e)).length,"/",t.length]})]}),s.jsx("div",{className:"ml-6 space-y-2",children:a.permissions.map(e=>s.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors",children:[s.jsx("input",{type:"checkbox",checked:T(e.id),onChange:()=>(e=>{const s=q.permissions||[];s.includes(e)?O("permissions",s.filter(s=>s!==e),{shouldDirty:!0}):O("permissions",[...s,e],{shouldDirty:!0})})(e.id),disabled:"all"===e.id&&"admin"!==q.role,className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-0.5"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm font-medium text-gray-800",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.description})]})]},e.id))})]},e)})})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[s.jsx(S,{size:20}),"Branch Access"]}),s.jsx("div",{className:"flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200",children:s.jsx("div",{className:"flex-1",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:q.accessAllBranches,onChange:e=>{O("accessAllBranches",e.target.checked,{shouldDirty:!0}),e.target.checked&&O("assignedBranches",[],{shouldDirty:!0})},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsxs("div",{children:[s.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Access All Branches"}),s.jsx("p",{className:"text-xs text-gray-600",children:"User can access and manage all branches/stores"})]})]})})}),!q.accessAllBranches&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Assigned Branches"}),s.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3",children:P?s.jsx("div",{className:"text-center py-4 text-gray-500",children:"Loading branches..."}):0===x.length?s.jsx("div",{className:"text-center py-4 text-gray-500",children:"No branches available"}):x.map(e=>s.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all "+((q.assignedBranches||[]).includes(e.id)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"),children:[s.jsx("input",{type:"checkbox",checked:(q.assignedBranches||[]).includes(e.id),onChange:()=>(e=>{const s=q.assignedBranches||[];s.includes(e)?O("assignedBranches",s.filter(s=>s!==e),{shouldDirty:!0}):O("assignedBranches",[...s,e],{shouldDirty:!0})})(e.id),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(A,{size:16,className:"text-gray-400"}),s.jsx("span",{className:"font-medium text-gray-900",children:e.name}),e.is_main&&s.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded",children:"Main"})]}),s.jsxs("p",{className:"text-xs text-gray-500 ml-6",children:[e.city," â€¢ ",e.code]})]})]},e.id))}),s.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Selected: ",(q.assignedBranches||[]).length," branch(es)"]})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Password"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(h,{name:"password",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Password",type:c?"text":"password",placeholder:"Enter password",value:e.value,onChange:e.onChange,error:null==(a=F.password)?void 0:a.message,required:!0,rightIcon:c?s.jsx(z,{size:16}):s.jsx(D,{size:16}),onRightIconClick:()=>o(!c),helperText:"Minimum 8 characters"})}}),s.jsx(h,{name:"confirmPassword",control:M,render:({field:e})=>{var a;return s.jsx(j,{label:"Confirm Password",type:d?"text":"password",placeholder:"Confirm password",value:e.value,onChange:e.onChange,error:null==(a=F.confirmPassword)?void 0:a.message,required:!0,rightIcon:d?s.jsx(z,{size:16}):s.jsx(D,{size:16}),onRightIconClick:()=>m(!d)})}})]}),s.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[s.jsx("p",{className:"text-sm text-gray-600 font-medium mb-2",children:"Password Requirements:"}),s.jsxs("ul",{className:"text-xs text-gray-500 space-y-1",children:[s.jsx("li",{children:"â€¢ Minimum 8 characters"}),s.jsx("li",{children:"â€¢ Should include uppercase and lowercase letters"}),s.jsx("li",{children:"â€¢ Should include numbers"}),s.jsx("li",{children:"â€¢ Should include special characters"})]})]})]}),s.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[s.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"User Preview"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Name:"}),s.jsxs("p",{className:"font-medium text-gray-900",children:[q.firstName," ",q.lastName]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Email:"}),s.jsx("p",{className:"font-medium text-gray-900",children:q.email||"Not provided"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Username:"}),s.jsx("p",{className:"font-medium text-gray-900",children:q.username||"Not set"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Role:"}),s.jsx("p",{className:"font-medium text-gray-900",children:(null==(n=G.find(e=>e.value===q.role))?void 0:n.label)||"Not selected"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Department:"}),s.jsx("p",{className:"font-medium text-gray-900",children:q.department||"Not assigned"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Permissions:"}),s.jsxs("p",{className:"font-medium text-gray-900",children:[(q.permissions||[]).length," selected",T("all")&&s.jsx("span",{className:"ml-2 text-green-600",children:"(Full Access)"})]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Branch Access:"}),s.jsx("p",{className:"font-medium text-gray-900",children:q.accessAllBranches?"All Branches":`${(q.assignedBranches||[]).length} branch(es)`})]})]})]}),s.jsxs("div",{className:"flex gap-3 mt-6",children:[s.jsx("button",{type:"button",onClick:J,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:!I||r,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:r?"Creating...":"Create User"})]})]})})})]}):null},oe=o({firstName:d().min(2,"First name must be at least 2 characters"),lastName:d().min(2,"Last name must be at least 2 characters"),email:d().email("Invalid email address"),username:d().min(3,"Username must be at least 3 characters").optional(),phone:d().optional(),role:m(["admin","manager","technician","customer-care","user"]),department:d().optional(),isActive:x().optional(),password:d().optional(),confirmPassword:d().optional(),permissions:u(d()).optional(),accessAllBranches:x().optional(),assignedBranches:u(d()).optional()}).refine(e=>!(e.password&&e.password.length>0)||e.password===e.confirmPassword&&e.password.length>=8,{message:"Passwords must match and be at least 8 characters",path:["confirmPassword"]}),de=({isOpen:e,onClose:r,onSubmit:n,user:c,loading:o=!1})=>{var d;const[m,x]=i.useState(!0),[u,f]=i.useState(!1),[M,E]=i.useState(!1),[F,I]=i.useState(!1),[L,$]=i.useState([]),[O,q]=i.useState(!1),[V,T]=i.useState([]),[G,H]=i.useState(!1),[J,K]=i.useState(!1);X(e);const{control:W,handleSubmit:Y,formState:{errors:Q,isDirty:Z},reset:ee,watch:se,setValue:re}=p({resolver:g(oe),defaultValues:{firstName:"",lastName:"",email:"",username:"",phone:"",role:"user",department:"",isActive:!0,password:"",confirmPassword:"",permissions:[],accessAllBranches:!1,assignedBranches:[]}}),le=se();i.useEffect(()=>{c&&(ee({firstName:c.firstName||"",lastName:c.lastName||"",email:c.email||"",username:c.username||"",phone:c.phone||"",role:c.role||"user",department:c.department||"",isActive:"active"===c.status,password:"",confirmPassword:"",permissions:c.permissions||[],accessAllBranches:!1,assignedBranches:[]}),x("active"===c.status),I(!1),de(c.id))},[c,ee]),i.useEffect(()=>{e&&ce()},[e]);const ce=async()=>{q(!0);try{const e=await te();$(e)}catch(e){y.error("Failed to load branches")}finally{q(!1)}},de=async e=>{try{const s=(await ae(e)).map(e=>e.branch_id);T(s),re("assignedBranches",s),re("accessAllBranches",0===s.length)}catch(s){}},me=e=>{const s=le.permissions||[];s.includes(e)?re("permissions",s.filter(s=>s!==e),{shouldDirty:!0}):re("permissions",[...s,e],{shouldDirty:!0})},xe=e=>(le.permissions||[]).includes(e),ue=[{value:"admin",label:"Administrator",description:"Full system access"},{value:"manager",label:"Manager",description:"Department management"},{value:"technician",label:"Technician",description:"Device repairs"},{value:"customer-care",label:"Customer Care",description:"Customer support"},{value:"user",label:"User",description:"Basic access"}],pe=[{value:"IT",label:"IT Department"},{value:"Sales",label:"Sales Department"},{value:"Service",label:"Service Department"},{value:"Support",label:"Support Department"},{value:"Marketing",label:"Marketing Department"},{value:"Finance",label:"Finance Department"},{value:"HR",label:"Human Resources"},{value:"Operations",label:"Operations"}],he=()=>{Z?confirm("Are you sure you want to cancel? Your changes will be lost.")&&(ee(),r()):r()},ge=e=>(le.permissions||[]).includes(e);return e&&c?s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:r,children:s.jsx(a,{className:"max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:s.jsxs("form",{onSubmit:Y(async e=>{try{const s={...e,isActive:m};e.password&&0!==e.password.length||(delete s.password,delete s.confirmPassword),await n(s),r()}catch(s){}}),className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:s.jsx(P,{className:"w-6 h-6 text-indigo-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit User"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Update user information and settings"})]})]}),s.jsx(t,{variant:"ghost",size:"sm",onClick:he,icon:s.jsx(b,{size:20})})]}),s.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"User Status"}),s.jsx("p",{className:"text-xs text-gray-500",children:m?"User can access the system":"User is blocked from accessing the system"})]}),s.jsx("button",{type:"button",onClick:()=>x(!m),className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors "+(m?"bg-green-600":"bg-red-400"),children:s.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+(m?"translate-x-6":"translate-x-1")})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"User Information"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(h,{name:"firstName",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"First Name",placeholder:"Enter first name",value:e.value,onChange:e.onChange,error:null==(a=Q.firstName)?void 0:a.message,required:!0,icon:s.jsx(v,{size:16})})}}),s.jsx(h,{name:"lastName",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"Last Name",placeholder:"Enter last name",value:e.value,onChange:e.onChange,error:null==(a=Q.lastName)?void 0:a.message,required:!0,icon:s.jsx(v,{size:16})})}})]}),s.jsx(h,{name:"email",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"Email Address",type:"email",placeholder:"user@company.com",value:e.value,onChange:e.onChange,error:null==(a=Q.email)?void 0:a.message,required:!0,icon:s.jsx(N,{size:16})})}}),s.jsx(h,{name:"username",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"Username",type:"text",placeholder:"username",value:e.value,onChange:e.onChange,error:null==(a=Q.username)?void 0:a.message,icon:s.jsx(v,{size:16}),helperText:"Used for login"})}}),s.jsx(h,{name:"phone",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"Phone Number",type:"tel",placeholder:"+255 123 456 789",value:e.value,onChange:e.onChange,error:null==(a=Q.phone)?void 0:a.message,icon:s.jsx(w,{size:16})})}})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Role & Department"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(h,{name:"role",control:W,render:({field:e})=>{var a;return s.jsx(l,{label:"Role",placeholder:"Select role",value:e.value,onChange:e.onChange,error:null==(a=Q.role)?void 0:a.message,options:ue,required:!0,icon:s.jsx(C,{size:16})})}}),s.jsx(h,{name:"department",control:W,render:({field:e})=>{var a;return s.jsx(l,{label:"Department",placeholder:"Select department",value:e.value,onChange:e.onChange,error:null==(a=Q.department)?void 0:a.message,options:pe,clearable:!0})}})]}),le.role&&s.jsx("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:s.jsxs("p",{className:"text-sm text-blue-800",children:[s.jsx("strong",{children:"Role Description:"})," ",(e=>{const s=ue.find(s=>s.value===e);return(null==s?void 0:s.description)||""})(le.role)]})})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[s.jsx(_,{size:20}),"Permissions & Access Control"]}),s.jsxs("button",{type:"button",onClick:()=>H(!G),className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:[G?"Hide":"Show"," Permissions"]})]}),s.jsx("div",{className:"flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-200",children:s.jsx("div",{className:"flex-1",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:J,onChange:e=>{if(K(e.target.checked),!e.target.checked&&le.role){const e=ne[le.role]||[];re("permissions",e,{shouldDirty:!0})}},className:"w-4 h-4 text-amber-600 bg-gray-100 border-gray-300 rounded focus:ring-amber-500"}),s.jsxs("div",{children:[s.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Custom Permissions"}),s.jsx("p",{className:"text-xs text-gray-600",children:"Override role defaults with custom permissions"})]})]})})}),s.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Selected Permissions: ",(le.permissions||[]).length]}),s.jsx("p",{className:"text-xs text-gray-500",children:J?"Custom permissions configured":`Using ${le.role} role defaults`})]}),xe("all")&&s.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[s.jsx(k,{size:16}),s.jsx("span",{className:"text-sm font-medium",children:"Full Access"})]})]})}),G&&s.jsxs("div",{className:"space-y-4 border-2 border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Configure Permissions"}),!xe("all")&&s.jsx("button",{type:"button",onClick:()=>re("permissions",["all"],{shouldDirty:!0}),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Grant Full Access"})]}),xe("all")?s.jsxs("div",{className:"p-6 bg-green-50 rounded-lg border border-green-200 text-center",children:[s.jsx(k,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),s.jsx("p",{className:"text-sm font-medium text-green-900",children:"Full Access Granted"}),s.jsx("p",{className:"text-xs text-green-700 mt-1",children:"This user has complete access to all system features"}),s.jsx("button",{type:"button",onClick:()=>{const e=ne[le.role]||[];re("permissions",e,{shouldDirty:!0})},className:"mt-3 text-xs text-green-700 hover:text-green-800 font-medium underline",children:"Revoke Full Access"})]}):s.jsx("div",{className:"space-y-4",children:Object.entries(ie).map(([e,a])=>{const t=a.permissions.map(e=>e.id),r=t.every(e=>xe(e));return s.jsxs("div",{className:"border border-gray-200 rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1",children:[s.jsx("input",{type:"checkbox",checked:r,onChange:()=>(e=>{const s=le.permissions||[];if(e.every(e=>s.includes(e)))re("permissions",s.filter(s=>!e.includes(s)),{shouldDirty:!0});else{const a=[...new Set([...s,...e])];re("permissions",a,{shouldDirty:!0})}})(t),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("span",{className:"font-medium text-sm text-gray-900",children:a.label})]}),s.jsxs("span",{className:"text-xs text-gray-500",children:[t.filter(e=>xe(e)).length,"/",t.length]})]}),s.jsx("div",{className:"ml-6 space-y-2",children:a.permissions.map(e=>s.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors",children:[s.jsx("input",{type:"checkbox",checked:xe(e.id),onChange:()=>me(e.id),disabled:"all"===e.id&&"admin"!==le.role,className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-0.5"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm font-medium text-gray-800",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.description})]})]},e.id))})]},e)})})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Password Reset"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Leave blank to keep current password"})]}),s.jsx(t,{type:"button",variant:"secondary",size:"sm",icon:F?s.jsx(z,{size:16}):s.jsx(U,{size:16}),onClick:()=>I(!F),children:F?"Hide":"Change Password"})]}),F&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-200",children:[s.jsx(h,{name:"password",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"New Password",type:u?"text":"password",placeholder:"Enter new password",value:e.value,onChange:e.onChange,error:null==(a=Q.password)?void 0:a.message,icon:u?s.jsx(z,{size:16}):s.jsx(D,{size:16}),onIconClick:()=>f(!u),helperText:"Minimum 8 characters"})}}),s.jsx(h,{name:"confirmPassword",control:W,render:({field:e})=>{var a;return s.jsx(j,{label:"Confirm New Password",type:M?"text":"password",placeholder:"Confirm new password",value:e.value,onChange:e.onChange,error:null==(a=Q.confirmPassword)?void 0:a.message,icon:M?s.jsx(z,{size:16}):s.jsx(D,{size:16}),onIconClick:()=>E(!M)})}}),s.jsxs("div",{className:"md:col-span-2 p-3 bg-yellow-50 rounded-lg border border-yellow-200",children:[s.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Password Requirements:"}),s.jsxs("ul",{className:"text-xs text-yellow-700 space-y-1",children:[s.jsx("li",{children:"â€¢ Minimum 8 characters"}),s.jsx("li",{children:"â€¢ Should include uppercase and lowercase letters"}),s.jsx("li",{children:"â€¢ Should include numbers"}),s.jsx("li",{children:"â€¢ Should include special characters"})]})]})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[s.jsx(S,{size:20}),"Branch Access"]}),s.jsx("div",{className:"flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200",children:s.jsx("div",{className:"flex-1",children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:le.accessAllBranches,onChange:e=>{re("accessAllBranches",e.target.checked,{shouldDirty:!0}),e.target.checked&&re("assignedBranches",[],{shouldDirty:!0})},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsxs("div",{children:[s.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Access All Branches"}),s.jsx("p",{className:"text-xs text-gray-600",children:"User can access and manage all branches/stores"})]})]})})}),!le.accessAllBranches&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Assigned Branches"}),s.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3",children:O?s.jsx("div",{className:"text-center py-4 text-gray-500",children:"Loading branches..."}):0===L.length?s.jsx("div",{className:"text-center py-4 text-gray-500",children:"No branches available"}):L.map(e=>s.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all "+((le.assignedBranches||[]).includes(e.id)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"),children:[s.jsx("input",{type:"checkbox",checked:(le.assignedBranches||[]).includes(e.id),onChange:()=>(e=>{const s=le.assignedBranches||[];s.includes(e)?re("assignedBranches",s.filter(s=>s!==e),{shouldDirty:!0}):re("assignedBranches",[...s,e],{shouldDirty:!0})})(e.id),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(A,{size:16,className:"text-gray-400"}),s.jsx("span",{className:"font-medium text-gray-900",children:e.name}),e.is_main&&s.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded",children:"Main"})]}),s.jsxs("p",{className:"text-xs text-gray-500 ml-6",children:[e.city," â€¢ ",e.code]})]})]},e.id))}),s.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Selected: ",(le.assignedBranches||[]).length," branch(es)"]})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Permissions"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Select specific permissions for this user"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[{value:"all",label:"All Permissions",description:"Full system access"},{value:"inventory",label:"Inventory Management",description:"Manage stock and products"},{value:"customers",label:"Customer Management",description:"Manage customer data"},{value:"reports",label:"Reports & Analytics",description:"View reports"},{value:"employees",label:"Employee Management",description:"Manage employees"},{value:"devices",label:"Device Management",description:"Manage devices"},{value:"spare-parts",label:"Spare Parts",description:"Manage spare parts"},{value:"appointments",label:"Appointments",description:"Manage appointments"},{value:"basic",label:"Basic Access",description:"Limited access"}].map(e=>s.jsx("div",{onClick:()=>me(e.value),className:"p-3 rounded-lg border-2 cursor-pointer transition-all "+(ge(e.value)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"),children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-0.5 "+(ge(e.value)?"text-blue-600":"text-gray-400"),children:s.jsx(R,{size:20})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h4",{className:"text-sm font-medium text-gray-900",children:e.label}),s.jsx("p",{className:"text-xs text-gray-500",children:e.description})]})]})},e.value))}),s.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:s.jsxs("p",{className:"text-sm text-gray-700",children:[s.jsx("strong",{children:(le.permissions||[]).length})," permission(s) selected"]})})]}),s.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[s.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"Updated User Preview"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Name:"}),s.jsxs("p",{className:"font-medium text-gray-900",children:[le.firstName," ",le.lastName]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Status:"}),s.jsx("p",{className:"font-medium "+(m?"text-green-600":"text-red-600"),children:m?"Active":"Inactive"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Email:"}),s.jsx("p",{className:"font-medium text-gray-900",children:le.email||"Not provided"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Username:"}),s.jsx("p",{className:"font-medium text-gray-900",children:le.username||"Not set"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Role:"}),s.jsx("p",{className:"font-medium text-gray-900",children:(null==(d=ue.find(e=>e.value===le.role))?void 0:d.label)||"Not selected"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Department:"}),s.jsx("p",{className:"font-medium text-gray-900",children:le.department||"Not assigned"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Phone:"}),s.jsx("p",{className:"font-medium text-gray-900",children:le.phone||"Not provided"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-gray-600",children:"Permissions:"}),s.jsxs("p",{className:"font-medium text-gray-900",children:[(le.permissions||[]).length," selected"]})]}),le.password&&le.password.length>0&&s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("p",{className:"text-gray-600",children:"Password:"}),s.jsx("p",{className:"font-medium text-orange-600",children:"Will be changed âœ“"})]})]})]}),s.jsxs("div",{className:"pt-6 border-t border-gray-200 flex gap-3",children:[s.jsx(t,{type:"button",variant:"secondary",onClick:he,className:"flex-1",children:"Cancel"}),s.jsx(t,{type:"submit",variant:"primary",loading:o,disabled:!Z&&m===("active"===c.status),className:"flex-1",icon:s.jsx(B,{size:20}),children:o?"Saving Changes...":"Save Changes"})]})]})})}):null},me=o({name:d().min(2,"Role name must be at least 2 characters"),description:d().min(5,"Description must be at least 5 characters"),permissions:u(d()).min(1,"Select at least one permission")}),xe=({isOpen:e,onClose:r,roles:n,onRoleCreate:l,onRoleUpdate:c,onRoleDelete:o})=>{const[d,m]=i.useState(!1),[x,u]=i.useState(null),[f,v]=i.useState(null);X(e);const{control:N,handleSubmit:w,formState:{errors:_},reset:k,setValue:S,watch:A}=p({resolver:g(me),defaultValues:{name:"",description:"",permissions:[]}}),z=A("permissions"),D=[{value:"all",label:"All Permissions",description:"Complete system access",icon:"ðŸ”“"},{value:"inventory",label:"Inventory Management",description:"Manage stock and products",icon:"ðŸ“¦"},{value:"customers",label:"Customer Management",description:"Manage customer data",icon:"ðŸ‘¥"},{value:"reports",label:"Reports & Analytics",description:"View and generate reports",icon:"ðŸ“Š"},{value:"employees",label:"Employee Management",description:"Manage team members",icon:"ðŸ‘”"},{value:"devices",label:"Device Management",description:"Manage devices and equipment",icon:"ðŸ“±"},{value:"spare-parts",label:"Spare Parts",description:"Manage spare parts inventory",icon:"âš™ï¸"},{value:"appointments",label:"Appointments",description:"Schedule and manage appointments",icon:"ðŸ“…"},{value:"pos",label:"Point of Sale",description:"Access POS system",icon:"ðŸ’°"},{value:"sms",label:"SMS Messaging",description:"Send SMS messages",icon:"ðŸ’¬"},{value:"settings",label:"System Settings",description:"Configure system settings",icon:"âš™ï¸"},{value:"users",label:"User Management",description:"Manage users and permissions",icon:"ðŸ”"},{value:"basic",label:"Basic Access",description:"Limited system access",icon:"ðŸ‘¤"}],P=()=>{m(!0),u(null),k({name:"",description:"",permissions:[]})},U=e=>(z||[]).includes(e);return e?s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:r,children:s.jsxs(a,{className:"max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:s.jsx(C,{className:"w-6 h-6 text-purple-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"Role Management"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Create and manage user roles and permissions"})]})]}),s.jsx(t,{variant:"ghost",size:"sm",onClick:r,icon:s.jsx(b,{size:20})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 p-6",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Existing Roles"}),s.jsx(t,{onClick:P,size:"sm",icon:s.jsx(M,{size:16}),className:"bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"New Role"})]}),s.jsxs("div",{className:"space-y-3",children:[n.map(e=>s.jsxs(a,{className:"p-4 cursor-pointer transition-all hover:shadow-md "+((null==f?void 0:f.id)===e.id?"ring-2 ring-purple-500 bg-purple-50":""),onClick:()=>v(e),children:[s.jsxs("div",{className:"flex items-start justify-between mb-2",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx(C,{size:18,className:"text-purple-600"}),s.jsx("h4",{className:"font-semibold text-gray-900",children:e.name})]}),s.jsx("p",{className:"text-sm text-gray-600",children:e.description})]}),s.jsxs("div",{className:"flex gap-1 ml-2",children:[s.jsx("button",{onClick:s=>{s.stopPropagation(),(e=>{u(e),m(!1),k({name:e.name,description:e.description,permissions:e.permissions})})(e)},className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"Edit role",children:s.jsx(E,{size:16})}),0===e.userCount&&s.jsx("button",{onClick:s=>{s.stopPropagation(),(async e=>{const s=n.find(s=>s.id===e);if(s)if(s.userCount>0)y.error(`Cannot delete role with ${s.userCount} assigned user(s)`);else if(confirm(`Are you sure you want to delete the "${s.name}" role?`))try{await(null==o?void 0:o(e)),y.success("Role deleted successfully"),(null==f?void 0:f.id)===e&&v(null)}catch(a){y.error(a.message||"Failed to delete role")}})(e.id)},className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete role",children:s.jsx(F,{size:16})})]})]}),s.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[s.jsx(I,{size:14}),s.jsxs("span",{children:[e.userCount," user",1!==e.userCount?"s":""]})]}),s.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[s.jsx(R,{size:14}),s.jsxs("span",{children:[e.permissions.length," permission",1!==e.permissions.length?"s":""]})]})]}),(null==f?void 0:f.id)===e.id&&s.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200",children:[s.jsx("p",{className:"text-xs font-medium text-gray-700 mb-2",children:"Permissions:"}),s.jsx("div",{className:"flex flex-wrap gap-1",children:e.permissions.map(e=>{const a=D.find(s=>s.value===e);return s.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs",children:[s.jsx("span",{children:(null==a?void 0:a.icon)||"â€¢"}),s.jsx("span",{children:(null==a?void 0:a.label)||e})]},e)})})]})]},e.id)),0===n.length&&s.jsxs("div",{className:"text-center py-8",children:[s.jsx(C,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),s.jsx("p",{className:"text-gray-600",children:"No custom roles yet"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Create your first role to get started"})]})]})]}),s.jsx("div",{children:d||x?s.jsxs("form",{onSubmit:w(async e=>{try{x?(await(null==c?void 0:c(x.id,e)),y.success("Role updated successfully")):(await(null==l?void 0:l(e)),y.success("Role created successfully")),m(!1),u(null),k()}catch(s){y.error(s.message||"Failed to save role")}}),className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[s.jsx(C,{className:"text-purple-600",size:20}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:x?"Edit Role":"Create New Role"})]}),s.jsx(h,{name:"name",control:N,render:({field:e})=>{var a;return s.jsx(j,{label:"Role Name",placeholder:"e.g., Store Manager, Sales Rep",value:e.value,onChange:e.onChange,error:null==(a=_.name)?void 0:a.message,required:!0,icon:s.jsx(C,{size:16})})}}),s.jsx(h,{name:"description",control:N,render:({field:e})=>s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Description ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("textarea",{value:e.value,onChange:e.onChange,placeholder:"Describe what this role does...",className:"w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none",rows:3}),_.description&&s.jsx("p",{className:"mt-1 text-sm text-red-600",children:_.description.message})]})}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["Permissions ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto pr-2",children:D.map(e=>s.jsx("div",{onClick:()=>(e=>{const s=z||[];s.includes(e)?S("permissions",s.filter(s=>s!==e),{shouldDirty:!0}):S("permissions",[...s,e],{shouldDirty:!0})})(e.value),className:"p-3 rounded-lg border-2 cursor-pointer transition-all "+(U(e.value)?"border-purple-500 bg-purple-50":"border-gray-200 bg-white hover:border-gray-300"),children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-0.5 transition-colors "+(U(e.value)?"text-purple-600":"text-gray-400"),children:U(e.value)?s.jsx(L,{size:20}):s.jsx("div",{className:"w-5 h-5 rounded border-2 border-current"})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-lg",children:e.icon}),s.jsx("h4",{className:"text-sm font-medium text-gray-900",children:e.label})]}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:e.description})]})]})},e.value))}),_.permissions&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:_.permissions.message}),s.jsx("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:s.jsxs("p",{className:"text-sm text-gray-700",children:[s.jsx("strong",{children:(z||[]).length})," permission(s) selected"]})})]}),s.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[s.jsx(t,{type:"button",variant:"secondary",onClick:()=>{m(!1),u(null),k()},className:"flex-1",children:"Cancel"}),s.jsx(t,{type:"submit",variant:"primary",className:"flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white",icon:s.jsx(B,{size:18}),children:x?"Update Role":"Create Role"})]})]}):s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsxs("div",{className:"text-center",children:[s.jsx(C,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Select a role or create a new one"}),s.jsx("p",{className:"text-gray-500 mb-6",children:"Choose a role from the list to view details, or create a new role"}),s.jsx(t,{onClick:P,icon:s.jsx(M,{size:18}),className:"bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"Create New Role"})]})})})]})}),s.jsx("div",{className:"border-t border-gray-200 p-4 bg-gray-50",children:s.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[s.jsx($,{size:16,className:"text-yellow-600"}),s.jsxs("p",{children:[s.jsx("strong",{children:"Note:"})," Roles with assigned users cannot be deleted. Reassign users before deleting a role."]})]})})]})}):null},ue=e=>Array.isArray(e)?e.map(ue):null!==e&&e.constructor===Object?Object.keys(e).reduce((s,a)=>(s[a.replace(/_([a-z])/g,(e,s)=>s.toUpperCase())]=ue(e[a]),s),{}):e;async function pe(){try{const{data:s,error:a}=await e.from("employees").select("\n        id,\n        user_id,\n        first_name,\n        last_name,\n        email,\n        position,\n        department,\n        created_at,\n        users:users!user_id (\n          id,\n          email,\n          full_name,\n          role\n        )\n      ").not("user_id","is",null);if(a)throw a;return(s||[]).map(e=>{var s,a,t;return{userId:e.user_id,employeeId:e.id,userName:(null==(s=e.users)?void 0:s.full_name)||"Unknown",userEmail:(null==(a=e.users)?void 0:a.email)||"",userRole:(null==(t=e.users)?void 0:t.role)||"",employeeName:`${e.first_name} ${e.last_name}`||"Unknown",employeeEmail:e.email,employeePosition:e.position,employeeDepartment:e.department,linkedAt:e.created_at}})}catch(s){return(null==s?void 0:s.code)&&"PGRST116"!==s.code&&s.code,[]}}async function he(){try{const{data:s,error:a}=await e.from("users").select("id, email, full_name, role, is_active").eq("is_active",!0);if(a)throw a;const{data:t,error:r}=await e.from("employees").select("user_id").not("user_id","is",null);if(r)throw r;const i=new Set((t||[]).map(e=>e.user_id));return(s||[]).filter(e=>!i.has(e.id)).map(ue)}catch(s){return(null==s?void 0:s.code)&&"PGRST116"!==s.code&&s.code,[]}}async function ge(){try{const{data:s,error:a}=await e.from("employees").select("id, email, first_name, last_name, position, status").is("user_id",null).eq("status","active");if(a)throw a;return(s||[]).map(e=>({...ue(e),fullName:`${e.first_name} ${e.last_name}`}))}catch(s){return[]}}const je=({isOpen:r,onClose:n,onLinksUpdated:c})=>{const[o,d]=i.useState("linked"),[m,x]=i.useState(!0),[u,p]=i.useState([]),[h,g]=i.useState([]),[N,w]=i.useState([]),[C,_]=i.useState(!1),[S,A]=i.useState(""),[z,D]=i.useState(""),[P,U]=i.useState(!1),[R,B]=i.useState({userId:"",position:"",department:"",salary:0});i.useEffect(()=>{r&&M()},[r]);const M=async()=>{x(!0);try{const[e,s,a]=await Promise.all([pe(),he(),ge()]);p(e),g(s),w(a)}catch(e){}finally{x(!1)}},E=async s=>{if(confirm("Are you sure you want to unlink this user from the employee record?")){const a=await async function(s){try{const{error:a}=await e.from("employees").update({user_id:null,updated_at:(new Date).toISOString()}).eq("id",s);if(a)throw a;return y.success("Unlinked user from employee"),!0}catch(a){return y.error(a.message||"Failed to unlink"),!1}}(s);a&&(await M(),null==c||c())}};return r?s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:n,children:s.jsxs(a,{className:"max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:s.jsx(O,{className:"w-6 h-6 text-blue-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"User-Employee Links"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Manage relationships between user accounts and employee records"})]})]}),s.jsx(t,{variant:"ghost",size:"sm",onClick:n,icon:s.jsx(b,{size:20})})]}),s.jsxs("div",{className:"flex gap-4 px-6 pt-4 border-b border-gray-200",children:[s.jsx("button",{onClick:()=>d("linked"),className:"pb-3 px-2 font-medium transition-colors "+("linked"===o?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(k,{size:18}),s.jsxs("span",{children:["Linked (",u.length,")"]})]})}),s.jsx("button",{onClick:()=>d("unlinked"),className:"pb-3 px-2 font-medium transition-colors "+("unlinked"===o?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(q,{size:18}),s.jsxs("span",{children:["Unlinked (",h.length+N.length,")"]})]})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:m?s.jsxs("div",{className:"flex items-center justify-center h-64",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),s.jsx("span",{className:"ml-3 text-gray-600",children:"Loading..."})]}):"linked"===o?s.jsx("div",{className:"space-y-4",children:s.jsx("div",{className:"grid gap-4",children:0===u.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(O,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Linked Accounts"}),s.jsx("p",{className:"text-gray-500 mb-6",children:"Users and employees are not yet linked"}),s.jsx(t,{onClick:()=>d("unlinked"),icon:s.jsx(V,{size:18}),children:"Link Users and Employees"})]}):u.map(e=>s.jsx(a,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-6 flex-1",children:[s.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[s.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:s.jsx(v,{size:20,className:"text-blue-600"})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.userName}),s.jsx("p",{className:"text-sm text-gray-600",children:e.userEmail}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Role: ",e.userRole]})]})]}),s.jsx("div",{className:"flex items-center",children:s.jsx(V,{className:"text-blue-600",size:24})}),s.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[s.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:s.jsx(T,{size:20,className:"text-green-600"})}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium text-gray-900",children:e.employeeName}),s.jsx("p",{className:"text-sm text-gray-600",children:e.employeePosition}),s.jsx("p",{className:"text-xs text-gray-500",children:e.employeeDepartment})]})]})]}),s.jsx(t,{onClick:()=>E(e.employeeId),variant:"ghost",size:"sm",icon:s.jsx(G,{size:16}),className:"text-red-600 hover:text-red-700",children:"Unlink"})]})},e.employeeId))})}):s.jsxs("div",{className:"space-y-6",children:[s.jsx(a,{className:"p-6 bg-gradient-to-r from-blue-50 to-indigo-50",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Auto-Link by Email"}),s.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Automatically link users to employees by matching email addresses. This will only link accounts with exact email matches."}),s.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(I,{className:"w-4 h-4 text-orange-600"}),s.jsxs("span",{children:[h.length," unlinked users"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(T,{className:"w-4 h-4 text-purple-600"}),s.jsxs("span",{children:[N.length," unlinked employees"]})]})]})]}),s.jsx(t,{onClick:async()=>{_(!0);try{const s=await async function(){try{const{data:a,error:t}=await e.from("users").select("id, email").eq("is_active",!0);if(t)throw t;const{data:r,error:i}=await e.from("employees").select("id, email, user_id").is("user_id",null);if(i)throw i;let n=0,l=0,c=0;for(const o of r||[])try{const s=null==a?void 0:a.find(e=>e.email.toLowerCase()===o.email.toLowerCase());if(s){const{error:a}=await e.from("employees").update({user_id:s.id,updated_at:(new Date).toISOString()}).eq("id",o.id);a?c++:n++}else l++}catch(s){c++}return n>0&&y.success(`Linked ${n} users to employees`),c>0&&y.error(`${c} errors occurred during linking`),{linked:n,skipped:l,errors:c}}catch(s){return y.error(s.message||"Failed to auto-link"),{linked:0,skipped:0,errors:0}}}();y.success(`Auto-link complete: ${s.linked} linked, ${s.skipped} skipped, ${s.errors} errors`),await M(),null==c||c()}catch(s){y.error("Auto-link failed")}finally{_(!1)}},loading:C,icon:s.jsx(H,{size:18}),className:"bg-gradient-to-r from-blue-500 to-indigo-600 text-white",children:"Run Auto-Link"})]})}),s.jsxs(a,{className:"p-6",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Manual Link"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[s.jsx(l,{label:"Select User",value:S,onChange:A,options:[{value:"",label:"Choose a user..."},...h.map(e=>({value:e.id,label:`${e.firstName} ${e.lastName} (${e.email})`}))],icon:s.jsx(v,{size:16})}),s.jsx(l,{label:"Select Employee",value:z,onChange:D,options:[{value:"",label:"Choose an employee..."},...N.map(e=>({value:e.id,label:`${e.firstName} ${e.lastName} - ${e.position}`}))],icon:s.jsx(T,{size:16})}),s.jsx(t,{onClick:async()=>{if(!S||!z)return void y.error("Please select both user and employee");await async function(s,a){try{const{data:t,error:r}=await e.from("users").select("id, email, full_name").eq("id",s).single();if(r||!t)return y.error("User not found"),!1;const{data:i,error:n}=await e.from("employees").select("id, email, user_id, first_name, last_name").eq("id",a).single();if(n||!i)return y.error("Employee not found"),!1;if(i.user_id&&i.user_id!==s)return y.error("Employee already linked to another user"),!1;const{error:l}=await e.from("employees").update({user_id:s,updated_at:(new Date).toISOString()}).eq("id",a);if(l)throw l;const c=`${i.first_name} ${i.last_name}`;return y.success(`Linked ${t.full_name} to ${c}`),!0}catch(t){return y.error(t.message||"Failed to link user and employee"),!1}}(S,z)&&(A(""),D(""),await M(),null==c||c())},disabled:!S||!z,icon:s.jsx(O,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Link"})]})]}),s.jsxs(a,{className:"p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Create Employee for User"}),!P&&s.jsx(t,{onClick:()=>U(!0),variant:"secondary",size:"sm",icon:s.jsx(f,{size:16}),children:"Create Employee"})]}),P&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsx(l,{label:"Select User",value:R.userId,onChange:e=>B({...R,userId:e}),options:[{value:"",label:"Choose a user..."},...h.map(e=>({value:e.id,label:`${e.firstName} ${e.lastName} (${e.email})`}))],required:!0}),s.jsx(j,{label:"Position",value:R.position,onChange:e=>B({...R,position:e.target.value}),placeholder:"e.g. Sales Manager",required:!0}),s.jsx(j,{label:"Department",value:R.department,onChange:e=>B({...R,department:e.target.value}),placeholder:"e.g. Sales",required:!0}),s.jsx(j,{label:"Salary (optional)",type:"number",value:R.salary,onChange:e=>B({...R,salary:parseFloat(e.target.value)||0}),placeholder:"0"})]}),s.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[s.jsx(t,{onClick:()=>{U(!1),B({userId:"",position:"",department:"",salary:0})},variant:"secondary",className:"flex-1",children:"Cancel"}),s.jsx(t,{onClick:async()=>{if(!R.userId||!R.position||!R.department)return void y.error("Please fill in all required fields");await async function(s,a){try{const{data:t,error:r}=await e.from("users").select("id, email, full_name, phone").eq("id",s).single();if(r||!t)return y.error("User not found"),null;const{data:i}=await e.from("employees").select("id").eq("user_id",s).maybeSingle();if(i)return y("Employee record already exists for this user",{icon:"â„¹ï¸"}),i.id;const n=(t.full_name||"Unknown User").split(" "),l=n[0]||"Unknown",c=n.slice(1).join(" ")||"User";return(await ee.createEmployee({userId:t.id,firstName:l,lastName:c,email:t.email,phone:t.phone||"",position:a.position,department:a.department,hireDate:a.hireDate||(new Date).toISOString().split("T")[0],salary:a.salary||0,currency:"TZS",status:"active",employmentType:"full-time",performanceRating:3,skills:null})).id}catch(t){return y.error(t.message||"Failed to create employee record"),null}}(R.userId,{position:R.position,department:R.department,salary:R.salary||0})&&(U(!1),B({userId:"",position:"",department:"",salary:0}),await M(),null==c||c())},icon:s.jsx(f,{size:18}),className:"flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"Create Employee"})]})]})]}),h.length>0&&s.jsxs("div",{children:[s.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:["Unlinked Users (",h.length,")"]}),s.jsxs("div",{className:"grid gap-3",children:[h.slice(0,5).map(e=>s.jsx(a,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-orange-100 rounded",children:s.jsx(v,{size:18,className:"text-orange-600"})}),s.jsxs("div",{children:[s.jsxs("p",{className:"font-medium text-gray-900",children:[e.firstName," ",e.lastName]}),s.jsx("p",{className:"text-sm text-gray-600",children:e.email})]})]}),s.jsx("span",{className:"text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded",children:"No employee record"})]})},e.id)),h.length>5&&s.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["... and ",h.length-5," more"]})]})]}),N.length>0&&s.jsxs("div",{children:[s.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:["Unlinked Employees (",N.length,")"]}),s.jsxs("div",{className:"grid gap-3",children:[N.slice(0,5).map(e=>s.jsx(a,{className:"p-3",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-purple-100 rounded",children:s.jsx(T,{size:18,className:"text-purple-600"})}),s.jsxs("div",{children:[s.jsxs("p",{className:"font-medium text-gray-900",children:[e.firstName," ",e.lastName]}),s.jsxs("p",{className:"text-sm text-gray-600",children:[e.position," â€¢ ",e.department]})]})]}),s.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded",children:"No user account"})]})},e.id)),N.length>5&&s.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["... and ",N.length-5," more"]})]})]})]})}),s.jsxs("div",{className:"border-t border-gray-200 p-4 bg-gray-50 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[s.jsx(q,{size:16,className:"text-yellow-600"}),s.jsx("p",{children:"Linking users to employees enables attendance tracking and employee self-service features"})]}),s.jsx(t,{onClick:M,variant:"secondary",size:"sm",icon:s.jsx(J,{size:16}),children:"Refresh"})]})]})}):null};async function ye(s,a){var t;try{const i={updated_at:(new Date).toISOString()};if(a.firstName||a.lastName){const r=await async function(s){try{const{data:a,error:t}=await e.from("users").select("*").eq("id",s).single();if(t)throw new Error(`Failed to fetch user: ${t.message}`);return a}catch(l){return null}}(s);if(r){const e=(null==(t=r.full_name)?void 0:t.split(" "))||["",""],s=a.firstName||e[0],n=a.lastName||e[1];i.full_name=`${s} ${n}`}}a.email&&(i.email=a.email),a.username&&(i.username=a.username),a.password&&(i.password=a.password),a.role&&(i.role=a.role,a.permissions||(i.permissions=be(a.role))),a.permissions&&(i.permissions=a.permissions),void 0!==a.phone&&(i.phone=a.phone),void 0!==a.department&&(i.department=a.department),void 0!==a.is_active&&(i.is_active=a.is_active);const{data:n,error:l}=await e.from("users").update(i).eq("id",s).select().single();if(l)throw new Error(`Failed to update user: ${l.message}`);try{const t={updated_at:(new Date).toISOString()};a.username&&(t.username=a.username),a.email&&(t.email=a.email),i.full_name&&(t.name=i.full_name),a.role&&(t.role=a.role),void 0!==a.is_active&&(t.is_active=a.is_active),a.permissions&&(t.permissions=a.permissions),await e.from("auth_users").update(t).eq("id",s)}catch(r){}return n}catch(i){throw i}}async function fe(s,a){try{const{error:t}=await e.from("users").update({is_active:a,updated_at:(new Date).toISOString()}).in("id",s);if(t)throw new Error(`Failed to bulk update users: ${t.message}`)}catch(t){throw t}}function be(e){switch(e){case"admin":return["all"];case"manager":return["inventory","customers","reports","employees"];case"technician":return["devices","spare-parts"];case"customer-care":return["customers","appointments"];default:return["basic"]}}function ve(e){const{firstName:s,lastName:a}=function(e){if(!e)return{firstName:"",lastName:""};const s=e.trim().split(" ");return{firstName:s[0]||"",lastName:s.slice(1).join(" ")||""}}(e.full_name);return{id:e.id,email:e.email,username:e.username,firstName:s,lastName:a,role:e.role,status:e.is_active?"active":"inactive",lastLogin:e.last_login,createdAt:e.created_at,phone:e.phone,department:e.department,permissions:e.permissions||[]}}const Ne=()=>{const{currentUser:o}=r();se();const[d,m]=i.useState([]),[x,u]=i.useState([]),[p,h]=i.useState(!0),[g,j]=i.useState(""),[f,b]=i.useState("all"),[v,N]=i.useState("all"),[S,A]=i.useState([]),[z,D]=i.useState(!1),[P,U]=i.useState(!1),[R,B]=i.useState(!1),[L,q]=i.useState(!1),[V,T]=i.useState(null),[G,H]=i.useState(!1),[X,ee]=i.useState(!1);i.useEffect(()=>{te()},[]);const te=async()=>{h(!0);try{const s=await async function(){try{const{data:s,error:a}=await e.from("users").select("*").order("created_at",{ascending:!1});if(a)throw new Error(`Failed to fetch users: ${a.message}`);return s||[]}catch(s){throw s}}(),a=await Promise.all(s.map(async e=>{try{const s=(await ae(e.id)).map(e=>e.branch_id);return{...ve(e),assignedBranches:s,accessAllBranches:0===s.length}}catch(s){return{...ve(e),assignedBranches:[],accessAllBranches:!0}}}));m(a);const t=new Map;s.forEach(e=>{const s=t.get(e.role)||0;t.set(e.role,s+1)});const r=[{id:"admin",name:"Administrator",description:"Full system access and control",permissions:["all"],userCount:t.get("admin")||0},{id:"manager",name:"Manager",description:"Department management and reporting",permissions:["inventory","customers","reports","employees"],userCount:t.get("manager")||0},{id:"technician",name:"Technician",description:"Device repair",permissions:["devices","spare-parts"],userCount:t.get("technician")||0},{id:"customer-care",name:"Customer Care",description:"Customer support and service",permissions:["customers","appointments"],userCount:t.get("customer-care")||0},{id:"user",name:"User",description:"Basic system access",permissions:["basic"],userCount:t.get("user")||0}];u(r)}catch(s){y.error("Failed to load users")}finally{h(!1)}},ie=d.filter(e=>{var s,a;const t=!g||e.firstName.toLowerCase().includes(g.toLowerCase())||e.lastName.toLowerCase().includes(g.toLowerCase())||e.email.toLowerCase().includes(g.toLowerCase())||(null==(s=e.username)?void 0:s.toLowerCase().includes(g.toLowerCase()))||(null==(a=e.department)?void 0:a.toLowerCase().includes(g.toLowerCase())),r="all"===f||e.role===f,i="all"===v||e.status===v;return t&&r&&i}),ne={totalUsers:d.length,activeUsers:d.filter(e=>"active"===e.status).length,pendingUsers:d.filter(e=>"pending"===e.status).length,inactiveUsers:d.filter(e=>"inactive"===e.status).length},le=()=>{D(!0)},oe=async s=>{if(confirm("Are you sure you want to delete this user? This action cannot be undone."))try{await async function(s){try{const{error:a}=await e.from("users").delete().eq("id",s);if(a)throw new Error(`Failed to delete user: ${a.message}`)}catch(a){throw a}}(s),y.success("User deleted successfully"),await te()}catch(a){y.error(a.message||"Failed to delete user")}},me=async s=>{try{const a=d.find(e=>e.id===s);if(a){const t="active"!==a.status;await async function(s,a){try{const{data:t,error:r}=await e.from("users").update({is_active:a,updated_at:(new Date).toISOString()}).eq("id",s).select().single();if(r)throw new Error(`Failed to toggle user status: ${r.message}`);return t}catch(t){throw t}}(s,t),y.success(`User ${t?"activated":"deactivated"} successfully`),await te()}}catch(a){y.error(a.message||"Failed to update user status")}},ue=async s=>{if(0!==S.length)try{switch(s){case"activate":await fe(S,!0),y.success(`${S.length} users activated`);break;case"deactivate":await fe(S,!1),y.success(`${S.length} users deactivated`);break;case"delete":if(!confirm(`Are you sure you want to delete ${S.length} users?`))return;await async function(s){try{const{error:a}=await e.from("users").delete().in("id",s);if(a)throw new Error(`Failed to bulk delete users: ${a.message}`)}catch(a){throw a}}(S),y.success(`${S.length} users deleted`);break;default:return void y.error("Unknown action")}A([]),await te()}catch(a){y.error(a.message||"Failed to perform action")}else y.error("Please select users first")},pe=e=>{switch(e){case"admin":return"bg-red-100 text-red-800";case"manager":return"bg-blue-100 text-blue-800";case"technician":return"bg-green-100 text-green-800";case"customer-care":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},he=e=>{switch(e){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";case"pending":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},ge=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return p?s.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:s.jsxs("div",{className:"flex items-center justify-center h-64",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),s.jsx("span",{className:"ml-3 text-gray-600",children:"Loading users..."})]})}):s.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[s.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(c,{to:"/dashboard"}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"User Management"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"Manage users, roles, and permissions"})]})]}),s.jsxs("div",{className:"flex flex-wrap gap-3",children:[s.jsx(t,{onClick:()=>{y.promise(te(),{loading:"Refreshing users...",success:"Users refreshed successfully",error:"Failed to refresh users"})},variant:"secondary",icon:s.jsx(J,{size:18}),title:"Refresh users list",children:"Refresh"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"file",accept:".json",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(!a)return;const t=new FileReader;t.onload=async e=>{var s;try{const a=null==(s=e.target)?void 0:s.result,t=JSON.parse(a),r=t.users||t;if(!Array.isArray(r))throw new Error("Invalid file format");y.success(`Ready to import ${r.length} users. Feature coming soon!`)}catch(a){y.error("Failed to import users. Please check file format.")}},t.readAsText(a),e.target.value=""},className:"hidden",id:"import-users"}),s.jsx("label",{htmlFor:"import-users",children:s.jsx(t,{variant:"secondary",icon:s.jsx(K,{size:18}),as:"span",children:"Import"})})]}),s.jsxs("div",{className:"relative group",children:[s.jsx(t,{variant:"secondary",icon:s.jsx(W,{size:18}),children:"Export"}),s.jsxs("div",{className:"hidden group-hover:block absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10",children:[s.jsxs("button",{onClick:()=>{try{const e=["ID","First Name","Last Name","Email","Username","Phone","Role","Department","Status","Created At","Last Login"],s=ie.map(e=>[e.id,e.firstName,e.lastName,e.email,e.username||"",e.phone||"",e.role,e.department||"",e.status,e.createdAt,e.lastLogin||""]),a=[e.join(","),...s.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),t=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),i=URL.createObjectURL(t);r.setAttribute("href",i),r.setAttribute("download",`users_export_${(new Date).toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),y.success(`Exported ${ie.length} users to CSV`)}catch(e){y.error("Failed to export users")}},className:"w-full text-left px-4 py-2 hover:bg-gray-50 rounded-t-lg flex items-center gap-2",children:[s.jsx(W,{size:16}),s.jsx("span",{children:"Export as CSV"})]}),s.jsxs("button",{onClick:()=>{try{const e={exportDate:(new Date).toISOString(),totalUsers:ie.length,users:ie},s=JSON.stringify(e,null,2),a=new Blob([s],{type:"application/json"}),t=document.createElement("a"),r=URL.createObjectURL(a);t.setAttribute("href",r),t.setAttribute("download",`users_export_${(new Date).toISOString().split("T")[0]}.json`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t),y.success(`Exported ${ie.length} users to JSON`)}catch(e){y.error("Failed to export users")}},className:"w-full text-left px-4 py-2 hover:bg-gray-50 rounded-b-lg flex items-center gap-2",children:[s.jsx(W,{size:16}),s.jsx("span",{children:"Export as JSON"})]})]})]}),s.jsx(t,{onClick:()=>q(!0),variant:"secondary",icon:s.jsx(O,{size:18}),title:"Link users to employee records",children:"User-Employee Links"}),s.jsx(t,{onClick:()=>B(!0),variant:"secondary",icon:s.jsx(C,{size:18}),children:"Manage Roles"}),s.jsx(t,{onClick:le,icon:s.jsx(M,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Add User"})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[s.jsx(a,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Users"}),s.jsx("p",{className:"text-2xl font-bold text-blue-900",children:ne.totalUsers})]}),s.jsx(I,{className:"w-8 h-8 text-blue-600"})]})}),s.jsx(a,{className:"bg-gradient-to-br from-green-50 to-green-100",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-green-600",children:"Active Users"}),s.jsx("p",{className:"text-2xl font-bold text-green-900",children:ne.activeUsers})]}),s.jsx(Y,{className:"w-8 h-8 text-green-600"})]})}),s.jsx(a,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Admins"}),s.jsx("p",{className:"text-2xl font-bold text-purple-900",children:d.filter(e=>"admin"===e.role).length}),s.jsx("p",{className:"text-xs text-purple-500",children:"Full Access"})]}),s.jsx(C,{className:"w-8 h-8 text-purple-600"})]})}),s.jsx(a,{className:"bg-gradient-to-br from-red-50 to-red-100",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-red-600",children:"Inactive Users"}),s.jsx("p",{className:"text-2xl font-bold text-red-900",children:ne.inactiveUsers})]}),s.jsx(Q,{className:"w-8 h-8 text-red-600"})]})})]}),s.jsx(a,{className:"p-6",children:s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsx(n,{onSearch:j,placeholder:"Search users by name, email, username, or department...",className:"w-full",suggestions:d.map(e=>`${e.firstName} ${e.lastName}`),searchKey:"user_management_search"})}),s.jsxs("div",{className:"flex flex-wrap gap-3",children:[s.jsx(l,{options:[{value:"all",label:"All Roles"},{value:"admin",label:"Administrator"},{value:"manager",label:"Manager"},{value:"technician",label:"Technician"},{value:"customer-care",label:"Customer Care"},{value:"user",label:"User"}],value:f,onChange:b,placeholder:"Filter by Role",className:"min-w-[150px]"}),s.jsx(l,{options:[{value:"all",label:"All Status"},{value:"active",label:"Active"},{value:"inactive",label:"Inactive"},{value:"pending",label:"Pending"}],value:v,onChange:N,placeholder:"Filter by Status",className:"min-w-[150px]"})]})]})}),S.length>0&&s.jsx(a,{className:"p-4 bg-blue-50 border-blue-200",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-blue-800 font-medium",children:[S.length," user(s) selected"]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(t,{onClick:()=>ue("activate"),variant:"secondary",size:"sm",icon:s.jsx(Y,{size:16}),children:"Activate"}),s.jsx(t,{onClick:()=>ue("deactivate"),variant:"secondary",size:"sm",icon:s.jsx(Q,{size:16}),children:"Deactivate"}),s.jsx(t,{onClick:()=>ue("delete"),variant:"danger",size:"sm",icon:s.jsx(F,{size:16}),children:"Delete"})]})]})}),s.jsxs(a,{className:"p-6",children:[s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b border-gray-200",children:[s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:s.jsx("input",{type:"checkbox",checked:S.length===ie.length&&ie.length>0,onChange:e=>{e.target.checked?A(ie.map(e=>e.id)):A([])},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"User"}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Role & Status"}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Branch Access"}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Permissions"}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Last Activity"}),s.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Actions"})]})}),s.jsx("tbody",{children:ie.map(e=>{var a,r;return s.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[s.jsx("td",{className:"py-3 px-4",children:s.jsx("input",{type:"checkbox",checked:S.includes(e.id),onChange:s=>{s.target.checked?A([...S,e.id]):A(S.filter(s=>s!==e.id))},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),s.jsx("td",{className:"py-3 px-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0",children:s.jsxs("span",{className:"text-white font-semibold text-sm",children:[null==(a=e.firstName)?void 0:a[0],null==(r=e.lastName)?void 0:r[0]]})}),s.jsxs("div",{className:"min-w-0",children:[s.jsxs("p",{className:"font-medium text-gray-900 truncate",children:[e.firstName," ",e.lastName]}),s.jsx("p",{className:"text-sm text-gray-500 truncate",children:e.email}),s.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.username&&s.jsxs("span",{className:"text-xs text-gray-400 font-mono",children:["@",e.username]}),e.phone&&s.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[s.jsx(w,{size:10}),e.phone]})]})]})]})}),s.jsx("td",{className:"py-3 px-4",children:s.jsxs("div",{className:"space-y-1",children:[s.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${pe(e.role)}`,children:e.role.replace("-"," ")}),s.jsx("div",{className:"flex items-center gap-1",children:s.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${he(e.status)}`,children:e.status})}),e.department&&s.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.department})]})}),s.jsx("td",{className:"py-3 px-4",children:!0===e.accessAllBranches?s.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[s.jsx(k,{size:14}),s.jsx("span",{className:"text-xs font-medium",children:"All Branches"})]}):e.assignedBranches&&e.assignedBranches.length>0?s.jsx("div",{className:"text-xs",children:s.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium",children:[e.assignedBranches.length," ",1===e.assignedBranches.length?"Branch":"Branches"]})}):s.jsxs("span",{className:"text-xs text-yellow-600 flex items-center gap-1",children:[s.jsx($,{size:12}),"No access"]})}),s.jsx("td",{className:"py-3 px-4",children:e.permissions&&e.permissions.length>0?e.permissions.includes("all")?s.jsx("div",{className:"flex items-center gap-1",children:s.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium",children:"Full Access âœ“"})}):s.jsx("div",{children:s.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium cursor-help",title:e.permissions.join(", "),children:[e.permissions.length," permission",1!==e.permissions.length?"s":""]})}):s.jsx("span",{className:"text-gray-400 italic text-xs",children:"None"})}),s.jsx("td",{className:"py-3 px-4",children:s.jsxs("div",{className:"text-sm",children:[e.lastLogin?s.jsxs("div",{children:[s.jsx("div",{className:"text-gray-900 font-medium",children:ge(e.lastLogin)}),s.jsx("div",{className:"text-xs text-gray-500",children:"Last login"})]}):s.jsx("div",{children:s.jsx("div",{className:"text-gray-400 italic",children:"Not logged in"})}),s.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Created: ",ge(e.createdAt)]})]})}),s.jsx("td",{className:"py-3 px-4",children:s.jsxs("div",{className:"flex gap-1",children:[s.jsx(t,{onClick:()=>(e=>{T(e),U(!0)})(e),variant:"ghost",size:"sm",icon:s.jsx(E,{size:14}),title:"Edit user"}),s.jsx(t,{onClick:()=>me(e.id),variant:"ghost",size:"sm",icon:"active"===e.status?s.jsx(_,{size:14}):s.jsx(Z,{size:14}),title:"active"===e.status?"Deactivate":"Activate",className:"active"===e.status?"text-orange-600":"text-green-600"}),s.jsx(t,{onClick:()=>oe(e.id),variant:"ghost",size:"sm",icon:s.jsx(F,{size:14}),className:"text-red-600 hover:text-red-700",title:"Delete user"})]})})]},e.id)})})]})}),0===ie.length&&s.jsxs("div",{className:"text-center py-8",children:[s.jsx(I,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No users found"}),s.jsx("p",{className:"text-gray-500 mb-6",children:g||"all"!==f||"all"!==v?"Try adjusting your search or filters":"Get started by adding your first user"}),!g&&"all"===f&&"all"===v&&s.jsx(t,{onClick:le,icon:s.jsx(M,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Add Your First User"})]})]}),s.jsx(ce,{isOpen:z,onClose:()=>D(!1),onSubmit:async s=>{H(!0);try{const a=await async function(s){var a;try{const a=`${s.firstName} ${s.lastName}`,t=s.permissions&&s.permissions.length>0?s.permissions:be(s.role),r=s.username||s.email.split("@")[0],{data:i,error:n}=await e.from("users").insert([{email:s.email,password:s.password,full_name:a,username:r,role:s.role,phone:s.phone||null,department:s.department||null,permissions:t,is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}]).select().single();if(n)throw new Error(`Failed to create user: ${n.message}`);return i}catch(t){if((null==(a=t.message)?void 0:a.includes("duplicate key value"))||"23505"===t.code)throw new Error("A user with this email already exists");throw t}}(s);if(!s.accessAllBranches&&s.assignedBranches&&s.assignedBranches.length>0){const e=s.assignedBranches.map((e,s)=>({branch_id:e,is_primary:0===s,can_manage:!1,can_view_reports:!0,can_manage_inventory:!1,can_manage_staff:!1}));await re(a.id,e,null==o?void 0:o.id)}y.success("User created successfully with branch assignments"),await te(),D(!1)}catch(a){throw y.error(a.message||"Failed to create user"),a}finally{H(!1)}},loading:G}),s.jsx(de,{isOpen:P,onClose:()=>{U(!1),T(null)},onSubmit:async e=>{if(V){ee(!0);try{const s={firstName:e.firstName,lastName:e.lastName,email:e.email,username:e.username,role:e.role,phone:e.phone,department:e.department,is_active:e.isActive,permissions:e.permissions};if(await ye(V.id,s),!e.accessAllBranches&&e.assignedBranches&&e.assignedBranches.length>0){const s=e.assignedBranches.map((e,s)=>({branch_id:e,is_primary:0===s,can_manage:!1,can_view_reports:!0,can_manage_inventory:!1,can_manage_staff:!1}));await re(V.id,s,null==o?void 0:o.id)}else e.accessAllBranches&&await re(V.id,[],null==o?void 0:o.id);y.success("User updated successfully with branch assignments"),await te(),U(!1),T(null)}catch(s){throw y.error(s.message||"Failed to update user"),s}finally{ee(!1)}}},user:V,loading:X}),s.jsx(xe,{isOpen:R,onClose:()=>B(!1),roles:x,onRoleCreate:async e=>{y.success("Role creation API coming soon!")},onRoleUpdate:async(e,s)=>{y.success("Role update API coming soon!")},onRoleDelete:async e=>{y.success("Role deletion API coming soon!")}}),s.jsx(je,{isOpen:L,onClose:()=>q(!1),onLinksUpdated:()=>te()})]})};export{Ne as default};
