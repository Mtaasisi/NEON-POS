import{s as e}from"./index-222cfb29.js";const t=new class{async getComprehensiveFinancialData(){try{const[e,t,a,n,r,s,o,i]=await Promise.all([this.getDevicePayments(),this.getPOSSales(),this.getRepairPayments(),this.getExpenses(),this.getAccounts(),this.getTransfers(),this.getRevenueAnalytics(),this.getFinancialTrends()]),c=[...e||[],...t||[],...a||[]];if(!c)return null;return{summary:this.calculateFinancialSummary(c,n||[],r||[],o),payments:c,expenses:n||[],accounts:r||[],transfers:s||[],revenue:o,trends:i}}catch(e){return null}}async getDevicePayments(){try{const{data:{user:t},error:a}=await e.auth.getUser();if(a||!t)return[];const n="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;let r=e.from("customer_payments").select("*").order("payment_date",{ascending:!1});n&&(r=r.eq("branch_id",n));const{data:s,error:o}=await r;if(o)return[];if(!s||0===s.length)return[];const i=[...new Set(s.map(e=>e.device_id).filter(Boolean))],c=[...new Set(s.map(e=>e.customer_id).filter(Boolean))];let m={};if(i.length>0){const{data:t}=await e.from("devices").select("id, brand, model").in("id",i);t&&(m=Object.fromEntries(t.map(e=>[e.id,e])))}let d={};if(c.length>0){const{data:t}=await e.from("customers").select("id, name").in("id",c);t&&(d=Object.fromEntries(t.map(e=>[e.id,e])))}return s.map(e=>{const t=m[e.device_id],a=d[e.customer_id];return{id:e.id,customer_id:e.customer_id,amount:e.amount,method:e.method,device_id:e.device_id,payment_date:e.payment_date,payment_type:e.payment_type,status:e.status,created_by:e.created_by,created_at:e.created_at,device_name:t?`${t.brand||""} ${t.model||""}`.trim():void 0,customer_name:(null==a?void 0:a.name)||void 0,source:"device_payment",repairType:e.repair_type,diagnosis:e.diagnosis,deviceBrand:null==t?void 0:t.brand,deviceModel:null==t?void 0:t.model}})}catch(t){return[]}}async getPOSSales(){try{const t="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;let a=e.from("lats_sales").select("*").order("created_at",{ascending:!1});t&&(a=a.eq("branch_id",t));const{data:n,error:r}=await a;return r?[]:(null==n?void 0:n.map(e=>{var t;return{id:e.id,customer_id:e.customer_id,amount:e.total_amount,method:e.payment_method,device_id:null,payment_date:e.created_at,payment_type:"payment",status:"completed"===e.status?"completed":"pending"===e.status?"pending":"failed",created_by:e.created_by,created_at:e.created_at,device_name:void 0,customer_name:(null==(t=e.customers)?void 0:t.name)||void 0,source:"pos_sale",orderId:e.id,orderStatus:e.status,totalAmount:e.total_amount,discountAmount:0,taxAmount:0,shippingCost:0,amountPaid:e.total_amount,balanceDue:0,customerType:"retail",deliveryMethod:"pickup",deliveryAddress:"",deliveryCity:"",deliveryNotes:""}}))||[]}catch(t){return[]}}async getRepairPayments(){try{return(await this.getDevicePayments()).map(e=>({...e,source:"repair_payment"}))}catch(e){return[]}}async getPayments(){try{const[e,t]=await Promise.all([this.getDevicePayments(),this.getPOSSales()]),a=[...e,...t];return a.sort((e,t)=>{const a=new Date(e.payment_date||e.created_at);return new Date(t.payment_date||t.created_at).getTime()-a.getTime()}),a}catch(e){return[]}}async getFinancialDataBySource(){try{const[e,t,a]=await Promise.all([this.getDevicePayments(),this.getPOSSales(),this.getRepairPayments()]),n=e.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),r=t.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),s=a.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0);return{devicePayments:e,posSales:t,repairPayments:a,totalRevenue:n+r+s,devicePaymentsRevenue:n,posSalesRevenue:r,repairPaymentsRevenue:s}}catch(e){return{devicePayments:[],posSales:[],repairPayments:[],totalRevenue:0,devicePaymentsRevenue:0,posSalesRevenue:0,repairPaymentsRevenue:0}}}async getExpenses(){try{const t="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;let a=e.from("finance_expenses").select("*").order("expense_date",{ascending:!1});t&&(a=a.eq("branch_id",t));const{data:n,error:r}=await a;if(r)return[];if(!n||0===n.length)return[];const s=[...new Set(n.map(e=>e.account_id).filter(Boolean))];let o={};if(s.length>0){const{data:t}=await e.from("finance_accounts").select("id, name").in("id",s);t&&(o=Object.fromEntries(t.map(e=>[e.id,e.name])))}return n.map(e=>({...e,account_name:o[e.account_id]||void 0}))}catch(t){return[]}}async getAccounts(){try{const{data:t,error:a}=await e.from("finance_accounts").select("*").order("created_at",{ascending:!1});return a?[]:t&&0!==t.length&&t||[]}catch(t){return[]}}async getTransfers(){try{const{data:t,error:a}=await e.from("finance_transfers").select("*").order("created_at",{ascending:!1});if(a)return[];const n=new Set;null==t||t.forEach(e=>{e.from_account_id&&n.add(e.from_account_id),e.to_account_id&&n.add(e.to_account_id)});let r=new Map;if(n.size>0){const{data:t}=await e.from("finance_accounts").select("id, name").in("id",Array.from(n));null==t||t.forEach(e=>{r.set(e.id,e.name)})}return(null==t?void 0:t.map(e=>({...e,from_account_name:r.get(e.from_account_id)||void 0,to_account_name:r.get(e.to_account_id)||void 0})))||[]}catch(t){return[]}}async getRevenueAnalytics(){try{const{data:t,error:a}=await e.from("customer_payments").select("amount, payment_date, status").eq("status","completed");if(a)throw a;if(!t||0===t.length)return{total:0,this_month:0,last_month:0,this_week:0,today:0,growth_percentage:0};const n=new Date,r=new Date(n.getFullYear(),n.getMonth(),1),s=new Date(n.getFullYear(),n.getMonth()-1,1),o=new Date(n.getFullYear(),n.getMonth(),0),i=new Date(n.getTime()-6048e5),c=new Date(n.getFullYear(),n.getMonth(),n.getDate());let m=0,d=0,u=0,l=0,p=0;t.forEach(e=>{const t=e.amount||0;if(m+=t,e.payment_date){const a=new Date(e.payment_date);a>=r&&(d+=t),a>=s&&a<=o&&(u+=t),a>=i&&(l+=t),a>=c&&(p+=t)}});return{total:m,this_month:d,last_month:u,this_week:l,today:p,growth_percentage:u>0?(d-u)/u*100:0}}catch(t){return{total:0,this_month:0,last_month:0,this_week:0,today:0,growth_percentage:0}}}async getFinancialTrends(){try{const[e,t]=await Promise.all([this.getPayments(),this.getExpenses()]),a=new Map,n=new Map;e.forEach(e=>{if("completed"===e.status){const t=new Date(e.payment_date),r=t.toISOString().slice(0,7),s=t.toISOString().slice(0,10);a.has(r)||a.set(r,{revenue:0,expenses:0,profit:0,payments:0});const o=a.get(r);o.revenue+=e.amount||0,o.payments+=1,o.profit=o.revenue-o.expenses,n.has(s)||n.set(s,{revenue:0,expenses:0,profit:0,payments:0});const i=n.get(s);i.revenue+=e.amount||0,i.payments+=1,i.profit=i.revenue-i.expenses}}),t.forEach(e=>{if("approved"===e.status){const t=new Date(e.expense_date),r=t.toISOString().slice(0,7),s=t.toISOString().slice(0,10);a.has(r)||a.set(r,{revenue:0,expenses:0,profit:0,payments:0});const o=a.get(r);o.expenses+=e.amount,o.profit=o.revenue-o.expenses,n.has(s)||n.set(s,{revenue:0,expenses:0,profit:0,payments:0});const i=n.get(s);i.expenses+=e.amount,i.profit=i.revenue-i.expenses}});const r=Array.from(a.entries()).map(([e,t])=>({month:e,...t})).sort((e,t)=>e.month.localeCompare(t.month));return{monthly:r,daily:Array.from(n.entries()).map(([e,t])=>({day:e,...t})).sort((e,t)=>e.day.localeCompare(t.day))}}catch(e){return{monthly:[],daily:[]}}}calculateFinancialSummary(e,t,a,n){const r=new Date,s=new Date(r.getFullYear(),r.getMonth(),1),o=e=>new Date(e)>=s,i=e.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),c=e.filter(e=>"pending"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),m=e.filter(e=>"completed"===e.status&&o(e.payment_date)).reduce((e,t)=>e+(Number(t.amount)||0),0),d=t.filter(e=>"approved"===e.status).reduce((e,t)=>e+t.amount,0),u=t.filter(e=>"approved"===e.status&&o(e.expense_date)).reduce((e,t)=>e+t.amount,0),l=a.reduce((e,t)=>e+t.balance,0),p=e.filter(e=>"completed"===e.status).length,y=e.filter(e=>"pending"===e.status).length,h=t.filter(e=>"approved"===e.status).length,_=t.filter(e=>"pending"===e.status).length,f=p>0?i/p:0,g=i-d,v=m-u,w=n.growth_percentage,S=w-0;return{totalRevenue:i,totalOutstanding:c,totalAccounts:a.length,monthlyRevenue:m,pendingPayments:y,completedPayments:p,totalBalance:l,averageTransaction:f,totalExpenses:d,monthlyExpenses:u,pendingExpenses:_,approvedExpenses:h,netProfit:g,monthlyProfit:v,activeAccounts:a.filter(e=>e.is_active).length,revenueGrowth:w,expenseGrowth:0,profitGrowth:S}}async getFinancialDataForPeriod(t,a){try{const{data:n,error:r}=await e.from("customer_payments").select("*").gte("payment_date",t).lte("payment_date",a).order("payment_date",{ascending:!1}),{data:s,error:o}=await e.from("finance_expenses").select("*").gte("expense_date",t).lte("expense_date",a).order("expense_date",{ascending:!1});if(r)throw new Error("Failed to fetch period payments");let i=[];if(n&&n.length>0){const t=[...new Set(n.map(e=>e.device_id).filter(Boolean))],a=[...new Set(n.map(e=>e.customer_id).filter(Boolean))];let r={};if(t.length>0){const{data:a}=await e.from("devices").select("id, brand, model").in("id",t);a&&(r=Object.fromEntries(a.map(e=>[e.id,e])))}let s={};if(a.length>0){const{data:t}=await e.from("customers").select("id, name").in("id",a);t&&(s=Object.fromEntries(t.map(e=>[e.id,e])))}i=n.map(e=>{const t=r[e.device_id],a=s[e.customer_id];return{...e,device_name:t?`${t.brand||""} ${t.model||""}`.trim():void 0,customer_name:(null==a?void 0:a.name)||void 0}})}let c=[];if(s&&s.length>0){const t=[...new Set(s.map(e=>e.account_id).filter(Boolean))];let a={};if(t.length>0){const{data:n}=await e.from("finance_accounts").select("id, name").in("id",t);n&&(a=Object.fromEntries(n.map(e=>[e.id,e.name])))}c=s.map(e=>({...e,account_name:a[e.account_id]||void 0}))}const[m,d]=await Promise.all([this.getAccounts(),this.getRevenueAnalytics()]);return{summary:this.calculateFinancialSummary(i,c,m,d),payments:i,expenses:c,accounts:m,transfers:[],revenue:d,trends:{monthly:[],daily:[]}}}catch(n){return null}}async exportFinancialData(e="csv"){try{const t=await this.getComprehensiveFinancialData();if(!t)throw new Error("Failed to fetch financial data");if("json"===e)return JSON.stringify(t,null,2);const a=[];return a.push(["Financial Summary"]),a.push(["Total Revenue",t.summary.totalRevenue]),a.push(["Total Expenses",t.summary.totalExpenses]),a.push(["Net Profit",t.summary.netProfit]),a.push(["Total Balance",t.summary.totalBalance]),a.push([]),a.push(["Payments"]),a.push(["Date","Customer","Amount","Method","Status","Device"]),t.payments.forEach(e=>{a.push([e.payment_date,e.customer_name||"N/A",e.amount,e.method,e.status,e.device_name||"N/A"])}),a.push([]),a.push(["Expenses"]),a.push(["Date","Title","Category","Amount","Status","Account"]),t.expenses.forEach(e=>{a.push([e.expense_date,e.title,e.category,e.amount,e.status,e.account_name||"N/A"])}),a.map(e=>e.join(",")).join("\n")}catch(t){throw t}}};export{t as f};
