import{r as e,b as t,g as a,R as r}from"./vendor-a2ff445a.js";import{_ as s}from"./supabase-7e851d02.js";import{u as n,a as i,N as o,B as c,R as l,b as d}from"./routing-a2f0f6d2.js";import{z as u,n as m,X as h,Z as p,C as g,a as _,b as f,c as y,R as v,E as w,L as b,d as S,A as x,I as k,e as E,f as I,g as A,h as P,i as C,H as T,F as j}from"./ui-551a39a6.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var D={exports:{}},R={},L=e,O=Symbol.for("react.element"),q=Symbol.for("react.fragment"),N=Object.prototype.hasOwnProperty,M=L.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,U={key:!0,ref:!0,__self:!0,__source:!0};function B(e,t,a){var r,s={},n=null,i=null;for(r in void 0!==a&&(n=""+a),void 0!==t.key&&(n=""+t.key),void 0!==t.ref&&(i=t.ref),t)N.call(t,r)&&!U.hasOwnProperty(r)&&(s[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===s[r]&&(s[r]=t[r]);return{$$typeof:O,type:e,key:n,ref:i,props:s,_owner:M.current}}R.Fragment=q,R.jsx=B,R.jsxs=B,D.exports=R;var $=D.exports,F={},z=t;F.createRoot=z.createRoot,F.hydrateRoot=z.hydrateRoot;var V,W,H,Q,G=Object.create,K=Object.defineProperty,Y=Object.getOwnPropertyDescriptor,J=Object.getOwnPropertyNames,X=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty,ee=(e,t)=>K(e,"name",{value:t,configurable:!0}),te=(e,t)=>()=>(e&&(t=e(e=0)),t),ae=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),re=(e,t)=>{for(var a in t)K(e,a,{get:t[a],enumerable:!0})},se=(e,t,a,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of J(t))!Z.call(e,s)&&s!==a&&K(e,s,{get:()=>t[s],enumerable:!(r=Y(t,s))||r.enumerable});return e},ne=(e,t,a)=>(a=null!=e?G(X(e)):{},se(!t&&e&&e.__esModule?a:K(a,"default",{value:e,enumerable:!0}),e)),ie=e=>se(K({},"__esModule",{value:!0}),e),oe=(e,t,a)=>((e,t,a)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a),ce=ae(e=>{ue(),e.byteLength=o,e.toByteArray=l,e.fromByteArray=m;var t,a=[],r=[],s=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(t=0,64;t<64;++t)a[t]=n[t],r[n.charCodeAt(t)]=t;function i(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=e.indexOf("=");return-1===a&&(a=t),[a,a===t?0:4-a%4]}function o(e){var t=i(e),a=t[0],r=t[1];return 3*(a+r)/4-r}function c(e,t,a){return 3*(t+a)/4-a}function l(e){var t,a,n=i(e),o=n[0],l=n[1],d=new s(c(0,o,l)),u=0,m=l>0?o-4:o;for(a=0;a<m;a+=4)t=r[e.charCodeAt(a)]<<18|r[e.charCodeAt(a+1)]<<12|r[e.charCodeAt(a+2)]<<6|r[e.charCodeAt(a+3)],d[u++]=t>>16&255,d[u++]=t>>8&255,d[u++]=255&t;return 2===l&&(t=r[e.charCodeAt(a)]<<2|r[e.charCodeAt(a+1)]>>4,d[u++]=255&t),1===l&&(t=r[e.charCodeAt(a)]<<10|r[e.charCodeAt(a+1)]<<4|r[e.charCodeAt(a+2)]>>2,d[u++]=t>>8&255,d[u++]=255&t),d}function d(e){return a[e>>18&63]+a[e>>12&63]+a[e>>6&63]+a[63&e]}function u(e,t,a){for(var r,s=[],n=t;n<a;n+=3)r=(e[n]<<16&16711680)+(e[n+1]<<8&65280)+(255&e[n+2]),s.push(d(r));return s.join("")}function m(e){for(var t,r=e.length,s=r%3,n=[],i=16383,o=0,c=r-s;o<c;o+=i)n.push(u(e,o,o+i>c?c:o+i));return 1===s?(t=e[r-1],n.push(a[t>>2]+a[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],n.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"=")),n.join("")}r[45]=62,r[95]=63,ee(i,"getLens"),ee(o,"byteLength"),ee(c,"_byteLength"),ee(l,"toByteArray"),ee(d,"tripletToBase64"),ee(u,"encodeChunk"),ee(m,"fromByteArray")}),le=ae(e=>{ue(),e.read=function(e,t,a,r,s){var n,i,o=8*s-r-1,c=(1<<o)-1,l=c>>1,d=-7,u=a?s-1:0,m=a?-1:1,h=e[t+u];for(u+=m,n=h&(1<<-d)-1,h>>=-d,d+=o;d>0;n=256*n+e[t+u],u+=m,d-=8);for(i=n&(1<<-d)-1,n>>=-d,d+=r;d>0;i=256*i+e[t+u],u+=m,d-=8);if(0===n)n=1-l;else{if(n===c)return i?NaN:1/0*(h?-1:1);i+=Math.pow(2,r),n-=l}return(h?-1:1)*i*Math.pow(2,n-r)},e.write=function(e,t,a,r,s,n){var i,o,c,l=8*n-s-1,d=(1<<l)-1,u=d>>1,m=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:n-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,i=d):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),(t+=i+u>=1?m/c:m*Math.pow(2,1-u))*c>=2&&(i++,c/=2),i+u>=d?(o=0,i=d):i+u>=1?(o=(t*c-1)*Math.pow(2,s),i+=u):(o=t*Math.pow(2,u-1)*Math.pow(2,s),i=0));s>=8;e[a+h]=255&o,h+=p,o/=256,s-=8);for(i=i<<s|o,l+=s;l>0;e[a+h]=255&i,h+=p,i/=256,l-=8);e[a+h-p]|=128*g}}),de=ae(e=>{ue();var t=ce(),a=le(),r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=o,e.SlowBuffer=y,e.INSPECT_MAX_BYTES=50;var s=2147483647;function n(){try{let e=new Uint8Array(1),t={foo:ee(function(){return 42},"foo")};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch{return!1}}function i(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');let t=new Uint8Array(e);return Object.setPrototypeOf(t,o.prototype),t}function o(e,t,a){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return c(e,t,a)}function c(e,t,a){if("string"==typeof e)return m(e,t);if(ArrayBuffer.isView(e))return p(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(ne(e,ArrayBuffer)||e&&ne(e.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(ne(e,SharedArrayBuffer)||e&&ne(e.buffer,SharedArrayBuffer)))return g(e,t,a);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');let r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return o.from(r,t,a);let s=_(e);if(s)return s;if(typeof Symbol<"u"&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e,t,a){return l(e),e<=0?i(e):void 0!==t?"string"==typeof a?i(e).fill(t,a):i(e).fill(t):i(e)}function u(e){return l(e),i(e<0?0:0|f(e))}function m(e,t){if(("string"!=typeof t||""===t)&&(t="utf8"),!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let a=0|v(e,t),r=i(a),s=r.write(e,t);return s!==a&&(r=r.slice(0,s)),r}function h(e){let t=e.length<0?0:0|f(e.length),a=i(t);for(let r=0;r<t;r+=1)a[r]=255&e[r];return a}function p(e){if(ne(e,Uint8Array)){let t=new Uint8Array(e);return g(t.buffer,t.byteOffset,t.byteLength)}return h(e)}function g(e,t,a){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(a||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===a?new Uint8Array(e):void 0===a?new Uint8Array(e,t):new Uint8Array(e,t,a),Object.setPrototypeOf(r,o.prototype),r}function _(e){if(o.isBuffer(e)){let t=0|f(e.length),a=i(t);return 0===a.length||e.copy(a,0,0,t),a}return void 0!==e.length?"number"!=typeof e.length||ie(e.length)?i(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}function f(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function y(e){return+e!=e&&(e=0),o.alloc(+e)}function v(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||ne(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);let a=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===a)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return Z(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*a;case"hex":return a>>>1;case"base64":return re(e).length;default:if(s)return r?-1:Z(e).length;t=(""+t).toLowerCase(),s=!0}}function w(e,t,a){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length||((void 0===a||a>this.length)&&(a=this.length),a<=0)||(a>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,a);case"utf8":case"utf-8":return T(this,t,a);case"ascii":return R(this,t,a);case"latin1":case"binary":return L(this,t,a);case"base64":return C(this,t,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return q(this,t,a);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function b(e,t,a){let r=e[t];e[t]=e[a],e[a]=r}function S(e,t,a,r,s){if(0===e.length)return-1;if("string"==typeof a?(r=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),ie(a=+a)&&(a=s?0:e.length-1),a<0&&(a=e.length+a),a>=e.length){if(s)return-1;a=e.length-1}else if(a<0){if(!s)return-1;a=0}if("string"==typeof t&&(t=o.from(t,r)),o.isBuffer(t))return 0===t.length?-1:x(e,t,a,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,a):Uint8Array.prototype.lastIndexOf.call(e,t,a):x(e,[t],a,r,s);throw new TypeError("val must be string, number or Buffer")}function x(e,t,a,r,s){let n,i=1,o=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;i=2,o/=2,c/=2,a/=2}function l(e,t){return 1===i?e[t]:e.readUInt16BE(t*i)}if(ee(l,"read"),s){let r=-1;for(n=a;n<o;n++)if(l(e,n)===l(t,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===c)return r*i}else-1!==r&&(n-=n-r),r=-1}else for(a+c>o&&(a=o-c),n=a;n>=0;n--){let a=!0;for(let r=0;r<c;r++)if(l(e,n+r)!==l(t,r)){a=!1;break}if(a)return n}return-1}function k(e,t,a,r){a=Number(a)||0;let s=e.length-a;r?(r=Number(r))>s&&(r=s):r=s;let n,i=t.length;for(r>i/2&&(r=i/2),n=0;n<r;++n){let r=parseInt(t.substr(2*n,2),16);if(ie(r))return n;e[a+n]=r}return n}function E(e,t,a,r){return se(Z(t,e.length-a),e,a,r)}function I(e,t,a,r){return se(te(t),e,a,r)}function A(e,t,a,r){return se(re(t),e,a,r)}function P(e,t,a,r){return se(ae(t,e.length-a),e,a,r)}function C(e,a,r){return 0===a&&r===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(a,r))}function T(e,t,a){a=Math.min(e.length,a);let r=[],s=t;for(;s<a;){let t=e[s],n=null,i=t>239?4:t>223?3:t>191?2:1;if(s+i<=a){let a,r,o,c;switch(i){case 1:t<128&&(n=t);break;case 2:a=e[s+1],128==(192&a)&&(c=(31&t)<<6|63&a,c>127&&(n=c));break;case 3:a=e[s+1],r=e[s+2],128==(192&a)&&128==(192&r)&&(c=(15&t)<<12|(63&a)<<6|63&r,c>2047&&(c<55296||c>57343)&&(n=c));break;case 4:a=e[s+1],r=e[s+2],o=e[s+3],128==(192&a)&&128==(192&r)&&128==(192&o)&&(c=(15&t)<<18|(63&a)<<12|(63&r)<<6|63&o,c>65535&&c<1114112&&(n=c))}}null===n?(n=65533,i=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=i}return D(r)}e.kMaxLength=s,o.TYPED_ARRAY_SUPPORT=n(),!o.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&console.error,ee(n,"typedArraySupport"),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:ee(function(){if(o.isBuffer(this))return this.buffer},"get")}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:ee(function(){if(o.isBuffer(this))return this.byteOffset},"get")}),ee(i,"createBuffer"),ee(o,"Buffer"),o.poolSize=8192,ee(c,"from"),o.from=function(e,t,a){return c(e,t,a)},Object.setPrototypeOf(o.prototype,Uint8Array.prototype),Object.setPrototypeOf(o,Uint8Array),ee(l,"assertSize"),ee(d,"alloc"),o.alloc=function(e,t,a){return d(e,t,a)},ee(u,"allocUnsafe"),o.allocUnsafe=function(e){return u(e)},o.allocUnsafeSlow=function(e){return u(e)},ee(m,"fromString"),ee(h,"fromArrayLike"),ee(p,"fromArrayView"),ee(g,"fromArrayBuffer"),ee(_,"fromObject"),ee(f,"checked"),ee(y,"SlowBuffer"),o.isBuffer=ee(function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},"isBuffer"),o.compare=ee(function(e,t){if(ne(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),ne(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let a=e.length,r=t.length;for(let s=0,n=Math.min(a,r);s<n;++s)if(e[s]!==t[s]){a=e[s],r=t[s];break}return a<r?-1:r<a?1:0},"compare"),o.isEncoding=ee(function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},"isEncoding"),o.concat=ee(function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);let a;if(void 0===t)for(t=0,a=0;a<e.length;++a)t+=e[a].length;let r=o.allocUnsafe(t),s=0;for(a=0;a<e.length;++a){let t=e[a];if(ne(t,Uint8Array))s+t.length>r.length?(o.isBuffer(t)||(t=o.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!o.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},"concat"),ee(v,"byteLength"),o.byteLength=v,ee(w,"slowToString"),o.prototype._isBuffer=!0,ee(b,"swap"),o.prototype.swap16=ee(function(){let e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)b(this,t,t+1);return this},"swap16"),o.prototype.swap32=ee(function(){let e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)b(this,t,t+3),b(this,t+1,t+2);return this},"swap32"),o.prototype.swap64=ee(function(){let e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)b(this,t,t+7),b(this,t+1,t+6),b(this,t+2,t+5),b(this,t+3,t+4);return this},"swap64"),o.prototype.toString=ee(function(){let e=this.length;return 0===e?"":0===arguments.length?T(this,0,e):w.apply(this,arguments)},"toString"),o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=ee(function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},"equals"),o.prototype.inspect=ee(function(){let t="",a=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(t+=" ... "),"<Buffer "+t+">"},"inspect"),r&&(o.prototype[r]=o.prototype.inspect),o.prototype.compare=ee(function(e,t,a,r,s){if(ne(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===a&&(a=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||a>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=a)return 0;if(r>=s)return-1;if(t>=a)return 1;if(this===e)return 0;let n=(s>>>=0)-(r>>>=0),i=(a>>>=0)-(t>>>=0),c=Math.min(n,i),l=this.slice(r,s),d=e.slice(t,a);for(let o=0;o<c;++o)if(l[o]!==d[o]){n=l[o],i=d[o];break}return n<i?-1:i<n?1:0},"compare"),ee(S,"bidirectionalIndexOf"),ee(x,"arrayIndexOf"),o.prototype.includes=ee(function(e,t,a){return-1!==this.indexOf(e,t,a)},"includes"),o.prototype.indexOf=ee(function(e,t,a){return S(this,e,t,a,!0)},"indexOf"),o.prototype.lastIndexOf=ee(function(e,t,a){return S(this,e,t,a,!1)},"lastIndexOf"),ee(k,"hexWrite"),ee(E,"utf8Write"),ee(I,"asciiWrite"),ee(A,"base64Write"),ee(P,"ucs2Write"),o.prototype.write=ee(function(e,t,a,r){if(void 0===t)r="utf8",a=this.length,t=0;else if(void 0===a&&"string"==typeof t)r=t,a=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(a)?(a>>>=0,void 0===r&&(r="utf8")):(r=a,a=void 0)}let s=this.length-t;if((void 0===a||a>s)&&(a=s),e.length>0&&(a<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return k(this,e,t,a);case"utf8":case"utf-8":return E(this,e,t,a);case"ascii":case"latin1":case"binary":return I(this,e,t,a);case"base64":return A(this,e,t,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,e,t,a);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},"write"),o.prototype.toJSON=ee(function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},"toJSON"),ee(C,"base64Slice"),ee(T,"utf8Slice");var j=4096;function D(e){let t=e.length;if(t<=j)return String.fromCharCode.apply(String,e);let a="",r=0;for(;r<t;)a+=String.fromCharCode.apply(String,e.slice(r,r+=j));return a}function R(e,t,a){let r="";a=Math.min(e.length,a);for(let s=t;s<a;++s)r+=String.fromCharCode(127&e[s]);return r}function L(e,t,a){let r="";a=Math.min(e.length,a);for(let s=t;s<a;++s)r+=String.fromCharCode(e[s]);return r}function O(e,t,a){let r=e.length;(!t||t<0)&&(t=0),(!a||a<0||a>r)&&(a=r);let s="";for(let n=t;n<a;++n)s+=oe[e[n]];return s}function q(e,t,a){let r=e.slice(t,a),s="";for(let n=0;n<r.length-1;n+=2)s+=String.fromCharCode(r[n]+256*r[n+1]);return s}function N(e,t,a){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>a)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,a,r,s,n){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(a+r>e.length)throw new RangeError("Index out of range")}function U(e,t,a,r,s){G(t,r,s,e,a,7);let n=Number(t&BigInt(4294967295));e[a++]=n,n>>=8,e[a++]=n,n>>=8,e[a++]=n,n>>=8,e[a++]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return e[a++]=i,i>>=8,e[a++]=i,i>>=8,e[a++]=i,i>>=8,e[a++]=i,a}function B(e,t,a,r,s){G(t,r,s,e,a,7);let n=Number(t&BigInt(4294967295));e[a+7]=n,n>>=8,e[a+6]=n,n>>=8,e[a+5]=n,n>>=8,e[a+4]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return e[a+3]=i,i>>=8,e[a+2]=i,i>>=8,e[a+1]=i,i>>=8,e[a]=i,a+8}function $(e,t,a,r,s,n){if(a+r>e.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function F(e,t,r,s,n){return t=+t,r>>>=0,n||$(e,0,r,4),a.write(e,t,r,s,23,4),r+4}function z(e,t,r,s,n){return t=+t,r>>>=0,n||$(e,0,r,8),a.write(e,t,r,s,52,8),r+8}ee(D,"decodeCodePointsArray"),ee(R,"asciiSlice"),ee(L,"latin1Slice"),ee(O,"hexSlice"),ee(q,"utf16leSlice"),o.prototype.slice=ee(function(e,t){let a=this.length;(e=~~e)<0?(e+=a)<0&&(e=0):e>a&&(e=a),(t=void 0===t?a:~~t)<0?(t+=a)<0&&(t=0):t>a&&(t=a),t<e&&(t=e);let r=this.subarray(e,t);return Object.setPrototypeOf(r,o.prototype),r},"slice"),ee(N,"checkOffset"),o.prototype.readUintLE=o.prototype.readUIntLE=ee(function(e,t,a){e>>>=0,t>>>=0,a||N(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return r},"readUIntLE"),o.prototype.readUintBE=o.prototype.readUIntBE=ee(function(e,t,a){e>>>=0,t>>>=0,a||N(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},"readUIntBE"),o.prototype.readUint8=o.prototype.readUInt8=ee(function(e,t){return e>>>=0,t||N(e,1,this.length),this[e]},"readUInt8"),o.prototype.readUint16LE=o.prototype.readUInt16LE=ee(function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]|this[e+1]<<8},"readUInt16LE"),o.prototype.readUint16BE=o.prototype.readUInt16BE=ee(function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]<<8|this[e+1]},"readUInt16BE"),o.prototype.readUint32LE=o.prototype.readUInt32LE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},"readUInt32LE"),o.prototype.readUint32BE=o.prototype.readUInt32BE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},"readUInt32BE"),o.prototype.readBigUInt64LE=de(ee(function(e){K(e>>>=0,"offset");let t=this[e],a=this[e+7];(void 0===t||void 0===a)&&Y(e,this.length-8);let r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+a*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))},"readBigUInt64LE")),o.prototype.readBigUInt64BE=de(ee(function(e){K(e>>>=0,"offset");let t=this[e],a=this[e+7];(void 0===t||void 0===a)&&Y(e,this.length-8);let r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+a;return(BigInt(r)<<BigInt(32))+BigInt(s)},"readBigUInt64BE")),o.prototype.readIntLE=ee(function(e,t,a){e>>>=0,t>>>=0,a||N(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},"readIntLE"),o.prototype.readIntBE=ee(function(e,t,a){e>>>=0,t>>>=0,a||N(e,t,this.length);let r=t,s=1,n=this[e+--r];for(;r>0&&(s*=256);)n+=this[e+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*t)),n},"readIntBE"),o.prototype.readInt8=ee(function(e,t){return e>>>=0,t||N(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},"readInt8"),o.prototype.readInt16LE=ee(function(e,t){e>>>=0,t||N(e,2,this.length);let a=this[e]|this[e+1]<<8;return 32768&a?4294901760|a:a},"readInt16LE"),o.prototype.readInt16BE=ee(function(e,t){e>>>=0,t||N(e,2,this.length);let a=this[e+1]|this[e]<<8;return 32768&a?4294901760|a:a},"readInt16BE"),o.prototype.readInt32LE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},"readInt32LE"),o.prototype.readInt32BE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},"readInt32BE"),o.prototype.readBigInt64LE=de(ee(function(e){K(e>>>=0,"offset");let t=this[e],a=this[e+7];(void 0===t||void 0===a)&&Y(e,this.length-8);let r=this[e+4]+256*this[e+5]+65536*this[e+6]+(a<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)},"readBigInt64LE")),o.prototype.readBigInt64BE=de(ee(function(e){K(e>>>=0,"offset");let t=this[e],a=this[e+7];(void 0===t||void 0===a)&&Y(e,this.length-8);let r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+a)},"readBigInt64BE")),o.prototype.readFloatLE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),a.read(this,e,!0,23,4)},"readFloatLE"),o.prototype.readFloatBE=ee(function(e,t){return e>>>=0,t||N(e,4,this.length),a.read(this,e,!1,23,4)},"readFloatBE"),o.prototype.readDoubleLE=ee(function(e,t){return e>>>=0,t||N(e,8,this.length),a.read(this,e,!0,52,8)},"readDoubleLE"),o.prototype.readDoubleBE=ee(function(e,t){return e>>>=0,t||N(e,8,this.length),a.read(this,e,!1,52,8)},"readDoubleBE"),ee(M,"checkInt"),o.prototype.writeUintLE=o.prototype.writeUIntLE=ee(function(e,t,a,r){if(e=+e,t>>>=0,a>>>=0,!r){M(this,e,t,a,Math.pow(2,8*a)-1,0)}let s=1,n=0;for(this[t]=255&e;++n<a&&(s*=256);)this[t+n]=e/s&255;return t+a},"writeUIntLE"),o.prototype.writeUintBE=o.prototype.writeUIntBE=ee(function(e,t,a,r){if(e=+e,t>>>=0,a>>>=0,!r){M(this,e,t,a,Math.pow(2,8*a)-1,0)}let s=a-1,n=1;for(this[t+s]=255&e;--s>=0&&(n*=256);)this[t+s]=e/n&255;return t+a},"writeUIntBE"),o.prototype.writeUint8=o.prototype.writeUInt8=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,1,255,0),this[t]=255&e,t+1},"writeUInt8"),o.prototype.writeUint16LE=o.prototype.writeUInt16LE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},"writeUInt16LE"),o.prototype.writeUint16BE=o.prototype.writeUInt16BE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},"writeUInt16BE"),o.prototype.writeUint32LE=o.prototype.writeUInt32LE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},"writeUInt32LE"),o.prototype.writeUint32BE=o.prototype.writeUInt32BE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},"writeUInt32BE"),ee(U,"wrtBigUInt64LE"),ee(B,"wrtBigUInt64BE"),o.prototype.writeBigUInt64LE=de(ee(function(e,t=0){return U(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))},"writeBigUInt64LE")),o.prototype.writeBigUInt64BE=de(ee(function(e,t=0){return B(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))},"writeBigUInt64BE")),o.prototype.writeIntLE=ee(function(e,t,a,r){if(e=+e,t>>>=0,!r){let r=Math.pow(2,8*a-1);M(this,e,t,a,r-1,-r)}let s=0,n=1,i=0;for(this[t]=255&e;++s<a&&(n*=256);)e<0&&0===i&&0!==this[t+s-1]&&(i=1),this[t+s]=(e/n|0)-i&255;return t+a},"writeIntLE"),o.prototype.writeIntBE=ee(function(e,t,a,r){if(e=+e,t>>>=0,!r){let r=Math.pow(2,8*a-1);M(this,e,t,a,r-1,-r)}let s=a-1,n=1,i=0;for(this[t+s]=255&e;--s>=0&&(n*=256);)e<0&&0===i&&0!==this[t+s+1]&&(i=1),this[t+s]=(e/n|0)-i&255;return t+a},"writeIntBE"),o.prototype.writeInt8=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},"writeInt8"),o.prototype.writeInt16LE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},"writeInt16LE"),o.prototype.writeInt16BE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},"writeInt16BE"),o.prototype.writeInt32LE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},"writeInt32LE"),o.prototype.writeInt32BE=ee(function(e,t,a){return e=+e,t>>>=0,a||M(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},"writeInt32BE"),o.prototype.writeBigInt64LE=de(ee(function(e,t=0){return U(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))},"writeBigInt64LE")),o.prototype.writeBigInt64BE=de(ee(function(e,t=0){return B(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))},"writeBigInt64BE")),ee($,"checkIEEE754"),ee(F,"writeFloat"),o.prototype.writeFloatLE=ee(function(e,t,a){return F(this,e,t,!0,a)},"writeFloatLE"),o.prototype.writeFloatBE=ee(function(e,t,a){return F(this,e,t,!1,a)},"writeFloatBE"),ee(z,"writeDouble"),o.prototype.writeDoubleLE=ee(function(e,t,a){return z(this,e,t,!0,a)},"writeDoubleLE"),o.prototype.writeDoubleBE=ee(function(e,t,a){return z(this,e,t,!1,a)},"writeDoubleBE"),o.prototype.copy=ee(function(e,t,a,r){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(a||(a=0),!r&&0!==r&&(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<a&&(r=a),r===a||0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-a&&(r=e.length-t+a);let s=r-a;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,a,r):Uint8Array.prototype.set.call(e,this.subarray(a,r),t),s},"copy"),o.prototype.fill=ee(function(e,t,a,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,a=this.length):"string"==typeof a&&(r=a,a=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!o.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){let t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<a)throw new RangeError("Out of range index");if(a<=t)return this;let s;if(t>>>=0,a=void 0===a?this.length:a>>>0,e||(e=0),"number"==typeof e)for(s=t;s<a;++s)this[s]=e;else{let n=o.isBuffer(e)?e:o.from(e,r),i=n.length;if(0===i)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<a-t;++s)this[s+t]=n[s%i]}return this},"fill");var V={};function W(e,t,a){var r;V[e]=(r=class extends a{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}},ee(r,"NodeError"),r)}function H(e){let t="",a=e.length,r="-"===e[0]?1:0;for(;a>=r+4;a-=3)t=`_${e.slice(a-3,a)}${t}`;return`${e.slice(0,a)}${t}`}function Q(e,t,a){K(t,"offset"),(void 0===e[t]||void 0===e[t+a])&&Y(t,e.length-(a+1))}function G(e,t,a,r,s,n){if(e>a||e<t){let r,s="bigint"==typeof t?"n":"";throw r=n>3?0===t||t===BigInt(0)?`>= 0${s} and < 2${s} ** ${8*(n+1)}${s}`:`>= -(2${s} ** ${8*(n+1)-1}${s}) and < 2 ** ${8*(n+1)-1}${s}`:`>= ${t}${s} and <= ${a}${s}`,new V.ERR_OUT_OF_RANGE("value",r,e)}Q(r,s,n)}function K(e,t){if("number"!=typeof e)throw new V.ERR_INVALID_ARG_TYPE(t,"number",e)}function Y(e,t,a){throw Math.floor(e)!==e?(K(e,a),new V.ERR_OUT_OF_RANGE(a||"offset","an integer",e)):t<0?new V.ERR_BUFFER_OUT_OF_BOUNDS:new V.ERR_OUT_OF_RANGE(a||"offset",`>= ${a?1:0} and <= ${t}`,e)}ee(W,"E"),W("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),W("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError),W("ERR_OUT_OF_RANGE",function(e,t,a){let r=`The value of "${e}" is out of range.`,s=a;return Number.isInteger(a)&&Math.abs(a)>2**32?s=H(String(a)):"bigint"==typeof a&&(s=String(a),(a>BigInt(2)**BigInt(32)||a<-(BigInt(2)**BigInt(32)))&&(s=H(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError),ee(H,"addNumericalSeparator"),ee(Q,"checkBounds"),ee(G,"checkIntBI"),ee(K,"validateNumber"),ee(Y,"boundsError");var J=/[^+/0-9A-Za-z-_]/g;function X(e){if((e=(e=e.split("=")[0]).trim().replace(J,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function Z(e,t){t=t||1/0;let a,r=e.length,s=null,n=[];for(let i=0;i<r;++i){if(a=e.charCodeAt(i),a>55295&&a<57344){if(!s){if(a>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(i+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=a;continue}if(a<56320){(t-=3)>-1&&n.push(239,191,189),s=a;continue}a=65536+(s-55296<<10|a-56320)}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,a<128){if((t-=1)<0)break;n.push(a)}else if(a<2048){if((t-=2)<0)break;n.push(a>>6|192,63&a|128)}else if(a<65536){if((t-=3)<0)break;n.push(a>>12|224,a>>6&63|128,63&a|128)}else{if(!(a<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}}return n}function te(e){let t=[];for(let a=0;a<e.length;++a)t.push(255&e.charCodeAt(a));return t}function ae(e,t){let a,r,s,n=[];for(let i=0;i<e.length&&!((t-=2)<0);++i)a=e.charCodeAt(i),r=a>>8,s=a%256,n.push(s),n.push(r);return n}function re(e){return t.toByteArray(X(e))}function se(e,t,a,r){let s;for(s=0;s<r&&!(s+a>=t.length||s>=e.length);++s)t[s+a]=e[s];return s}function ne(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function ie(e){return e!=e}ee(X,"base64clean"),ee(Z,"utf8ToBytes"),ee(te,"asciiToBytes"),ee(ae,"utf16leToBytes"),ee(re,"base64ToBytes"),ee(se,"blitBuffer"),ee(ne,"isInstance"),ee(ie,"numberIsNaN");var oe=function(){let e="0123456789abcdef",t=new Array(256);for(let a=0;a<16;++a){let r=16*a;for(let s=0;s<16;++s)t[r+s]=e[a]+e[s]}return t}();function de(e){return typeof BigInt>"u"?me:e}function me(){throw new Error("BigInt not supported")}ee(de,"defineBigIntMethod"),ee(me,"BufferBigIntNotDefined")}),ue=te(()=>{V=globalThis,W=globalThis.setImmediate??(e=>setTimeout(e,0)),H="function"==typeof globalThis.Buffer&&"function"==typeof globalThis.Buffer.allocUnsafe?globalThis.Buffer:de().Buffer,(Q=globalThis.process??{}).env??(Q.env={});try{Q.nextTick(()=>{})}catch{let e=Promise.resolve();Q.nextTick=e.then.bind(e)}}),me=ae((e,t)=>{ue();var a,r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:ee(function(e,t,a){return Function.prototype.apply.call(e,t,a)},"ReflectApply");function n(e){console&&console.warn}a=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?ee(function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))},"ReflectOwnKeys"):ee(function(e){return Object.getOwnPropertyNames(e)},"ReflectOwnKeys"),ee(n,"ProcessEmitWarning");var i=Number.isNaN||ee(function(e){return e!=e},"NumberIsNaN");function o(){o.init.call(this)}ee(o,"EventEmitter"),t.exports=o,t.exports.once=v,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var c=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function d(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,a,r){var s,i,o;if(l(a),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,a.listener?a.listener:a),i=e._events),o=i[t]),void 0===o)o=i[t]=a,++e._eventsCount;else if("function"==typeof o?o=i[t]=r?[a,o]:[o,a]:r?o.unshift(a):o.push(a),(s=d(e))>0&&o.length>s&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,n()}return e}function m(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,a){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:a},s=m.bind(r);return s.listener=a,r.wrapFn=s,s}function p(e,t,a){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?a?[s.listener||s]:[s]:a?y(s):_(s,s.length)}function g(e){var t=this._events;if(void 0!==t){var a=t[e];if("function"==typeof a)return 1;if(void 0!==a)return a.length}return 0}function _(e,t){for(var a=new Array(t),r=0;r<t;++r)a[r]=e[r];return a}function f(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function y(e){for(var t=new Array(e.length),a=0;a<t.length;++a)t[a]=e[a].listener||e[a];return t}function v(e,t){return new Promise(function(a,r){function s(a){e.removeListener(t,n),r(a)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",s),a([].slice.call(arguments))}ee(s,"errorListener"),ee(n,"resolver"),b(e,t,n,{once:!0}),"error"!==t&&w(e,s,{once:!0})})}function w(e,t,a){"function"==typeof e.on&&b(e,"error",t,a)}function b(e,t,a,r){if("function"==typeof e.on)r.once?e.once(t,a):e.on(t,a);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,ee(function s(n){r.once&&e.removeEventListener(t,s),a(n)},"wrapListener"))}}ee(l,"checkListener"),Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:ee(function(){return c},"get"),set:ee(function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e},"set")}),o.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=ee(function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},"setMaxListeners"),ee(d,"_getMaxListeners"),o.prototype.getMaxListeners=ee(function(){return d(this)},"getMaxListeners"),o.prototype.emit=ee(function(e){for(var t=[],a=1;a<arguments.length;a++)t.push(arguments[a]);var r="error"===e,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var o=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw o.context=i,o}var c=n[e];if(void 0===c)return!1;if("function"==typeof c)s(c,this,t);else{var l=c.length,d=_(c,l);for(a=0;a<l;++a)s(d[a],this,t)}return!0},"emit"),ee(u,"_addListener"),o.prototype.addListener=ee(function(e,t){return u(this,e,t,!1)},"addListener"),o.prototype.on=o.prototype.addListener,o.prototype.prependListener=ee(function(e,t){return u(this,e,t,!0)},"prependListener"),ee(m,"onceWrapper"),ee(h,"_onceWrap"),o.prototype.once=ee(function(e,t){return l(t),this.on(e,h(this,e,t)),this},"once"),o.prototype.prependOnceListener=ee(function(e,t){return l(t),this.prependListener(e,h(this,e,t)),this},"prependOnceListener"),o.prototype.removeListener=ee(function(e,t){var a,r,s,n,i;if(l(t),void 0===(r=this._events))return this;if(void 0===(a=r[e]))return this;if(a===t||a.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,a.listener||t));else if("function"!=typeof a){for(s=-1,n=a.length-1;n>=0;n--)if(a[n]===t||a[n].listener===t){i=a[n].listener,s=n;break}if(s<0)return this;0===s?a.shift():f(a,s),1===a.length&&(r[e]=a[0]),void 0!==r.removeListener&&this.emit("removeListener",e,i||t)}return this},"removeListener"),o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=ee(function(e){var t,a,r;if(void 0===(a=this._events))return this;if(void 0===a.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==a[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete a[e]),this;if(0===arguments.length){var s,n=Object.keys(a);for(r=0;r<n.length;++r)"removeListener"!==(s=n[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=a[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},"removeAllListeners"),ee(p,"_listeners"),o.prototype.listeners=ee(function(e){return p(this,e,!0)},"listeners"),o.prototype.rawListeners=ee(function(e){return p(this,e,!1)},"rawListeners"),o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},o.prototype.listenerCount=g,ee(g,"listenerCount"),o.prototype.eventNames=ee(function(){return this._eventsCount>0?a(this._events):[]},"eventNames"),ee(_,"arrayClone"),ee(f,"spliceOne"),ee(y,"unwrapListeners"),ee(v,"once"),ee(w,"addErrorHandlerIfEventEmitter"),ee(b,"eventTargetAgnosticAddListener")}),he={};function pe(e){return 0}re(he,{Socket:()=>ye,isIP:()=>pe});var ge,_e,fe,ye,ve=te(()=>{ue(),ge=ne(me(),1),ee(pe,"isIP"),_e=/^[^.]+\./,fe=class e extends ge.EventEmitter{constructor(){super(...arguments),oe(this,"opts",{}),oe(this,"connecting",!1),oe(this,"pending",!0),oe(this,"writable",!0),oe(this,"encrypted",!1),oe(this,"authorized",!1),oe(this,"destroyed",!1),oe(this,"ws",null),oe(this,"writeBuffer"),oe(this,"tlsState",0),oe(this,"tlsRead"),oe(this,"tlsWrite")}static get poolQueryViaFetch(){return e.opts.poolQueryViaFetch??e.defaults.poolQueryViaFetch}static set poolQueryViaFetch(t){e.opts.poolQueryViaFetch=t}static get fetchEndpoint(){return e.opts.fetchEndpoint??e.defaults.fetchEndpoint}static set fetchEndpoint(t){e.opts.fetchEndpoint=t}static get fetchConnectionCache(){return!0}static set fetchConnectionCache(e){}static get fetchFunction(){return e.opts.fetchFunction??e.defaults.fetchFunction}static set fetchFunction(t){e.opts.fetchFunction=t}static get webSocketConstructor(){return e.opts.webSocketConstructor??e.defaults.webSocketConstructor}static set webSocketConstructor(t){e.opts.webSocketConstructor=t}get webSocketConstructor(){return this.opts.webSocketConstructor??e.webSocketConstructor}set webSocketConstructor(e){this.opts.webSocketConstructor=e}static get wsProxy(){return e.opts.wsProxy??e.defaults.wsProxy}static set wsProxy(t){e.opts.wsProxy=t}get wsProxy(){return this.opts.wsProxy??e.wsProxy}set wsProxy(e){this.opts.wsProxy=e}static get coalesceWrites(){return e.opts.coalesceWrites??e.defaults.coalesceWrites}static set coalesceWrites(t){e.opts.coalesceWrites=t}get coalesceWrites(){return this.opts.coalesceWrites??e.coalesceWrites}set coalesceWrites(e){this.opts.coalesceWrites=e}static get useSecureWebSocket(){return e.opts.useSecureWebSocket??e.defaults.useSecureWebSocket}static set useSecureWebSocket(t){e.opts.useSecureWebSocket=t}get useSecureWebSocket(){return this.opts.useSecureWebSocket??e.useSecureWebSocket}set useSecureWebSocket(e){this.opts.useSecureWebSocket=e}static get forceDisablePgSSL(){return e.opts.forceDisablePgSSL??e.defaults.forceDisablePgSSL}static set forceDisablePgSSL(t){e.opts.forceDisablePgSSL=t}get forceDisablePgSSL(){return this.opts.forceDisablePgSSL??e.forceDisablePgSSL}set forceDisablePgSSL(e){this.opts.forceDisablePgSSL=e}static get disableSNI(){return e.opts.disableSNI??e.defaults.disableSNI}static set disableSNI(t){e.opts.disableSNI=t}get disableSNI(){return this.opts.disableSNI??e.disableSNI}set disableSNI(e){this.opts.disableSNI=e}static get disableWarningInBrowsers(){return e.opts.disableWarningInBrowsers??e.defaults.disableWarningInBrowsers}static set disableWarningInBrowsers(t){e.opts.disableWarningInBrowsers=t}get disableWarningInBrowsers(){return this.opts.disableWarningInBrowsers??e.disableWarningInBrowsers}set disableWarningInBrowsers(e){this.opts.disableWarningInBrowsers=e}static get pipelineConnect(){return e.opts.pipelineConnect??e.defaults.pipelineConnect}static set pipelineConnect(t){e.opts.pipelineConnect=t}get pipelineConnect(){return this.opts.pipelineConnect??e.pipelineConnect}set pipelineConnect(e){this.opts.pipelineConnect=e}static get subtls(){return e.opts.subtls??e.defaults.subtls}static set subtls(t){e.opts.subtls=t}get subtls(){return this.opts.subtls??e.subtls}set subtls(e){this.opts.subtls=e}static get pipelineTLS(){return e.opts.pipelineTLS??e.defaults.pipelineTLS}static set pipelineTLS(t){e.opts.pipelineTLS=t}get pipelineTLS(){return this.opts.pipelineTLS??e.pipelineTLS}set pipelineTLS(e){this.opts.pipelineTLS=e}static get rootCerts(){return e.opts.rootCerts??e.defaults.rootCerts}static set rootCerts(t){e.opts.rootCerts=t}get rootCerts(){return this.opts.rootCerts??e.rootCerts}set rootCerts(e){this.opts.rootCerts=e}wsProxyAddrForHost(e,t){let a=this.wsProxy;if(void 0===a)throw new Error("No WebSocket proxy is configured. Please see https://github.com/neondatabase/serverless/blob/main/CONFIG.md#wsproxy-string--host-string-port-number--string--string");return"function"==typeof a?a(e,t):`${a}?address=${e}:${t}`}setNoDelay(){return this}setKeepAlive(){return this}ref(){return this}unref(){return this}connect(e,t,a){this.connecting=!0,a&&this.once("connect",a);let r,s=ee(()=>{this.connecting=!1,this.pending=!1,this.emit("connect"),this.emit("ready")},"handleWebSocketOpen"),n=ee((e,t=!1)=>{e.binaryType="arraybuffer",e.addEventListener("error",e=>{this.emit("error",e),this.emit("close")}),e.addEventListener("message",e=>{if(0===this.tlsState){let t=H.from(e.data);this.emit("data",t)}}),e.addEventListener("close",()=>{this.emit("close")}),t?s():e.addEventListener("open",s)},"configureWebSocket");try{r=this.wsProxyAddrForHost(t,"string"==typeof e?parseInt(e,10):e)}catch(i){return this.emit("error",i),void this.emit("close")}try{let e=(this.useSecureWebSocket?"wss:":"ws:")+"//"+r;if(void 0!==this.webSocketConstructor)this.ws=new this.webSocketConstructor(e),n(this.ws);else try{this.ws=new WebSocket(e),n(this.ws)}catch{this.ws=new __unstable_WebSocket(e),n(this.ws)}}catch(i){let e=(this.useSecureWebSocket?"https:":"http:")+"//"+r;fetch(e,{headers:{Upgrade:"websocket"}}).then(e=>{if(this.ws=e.webSocket,null==this.ws)throw i;this.ws.accept(),n(this.ws,!0)}).catch(e=>{this.emit("error",new Error(`All attempts to open a WebSocket to connect to the database failed. Please refer to https://github.com/neondatabase/serverless/blob/main/CONFIG.md#websocketconstructor-typeof-websocket--undefined. Details: ${e}`)),this.emit("close")})}}async startTls(e){if(void 0===this.subtls)throw new Error("For Postgres SSL connections, you must set `neonConfig.subtls` to the subtls library. See https://github.com/neondatabase/serverless/blob/main/CONFIG.md for more information.");this.tlsState=1;let t=await this.subtls.TrustedCert.databaseFromPEM(this.rootCerts),a=new this.subtls.WebSocketReadQueue(this.ws),r=a.read.bind(a),s=this.rawWrite.bind(this),{read:n,write:i}=await this.subtls.startTls(e,t,r,s,{useSNI:!this.disableSNI,expectPreData:this.pipelineTLS?new Uint8Array([83]):void 0});this.tlsRead=n,this.tlsWrite=i,this.tlsState=2,this.encrypted=!0,this.authorized=!0,this.emit("secureConnection",this),this.tlsReadLoop()}async tlsReadLoop(){for(;;){let e=await this.tlsRead();if(void 0===e)break;{let t=H.from(e);this.emit("data",t)}}}rawWrite(e){if(this.coalesceWrites)if(void 0===this.writeBuffer)this.writeBuffer=e,setTimeout(()=>{this.ws&&this.ws.send(this.writeBuffer),this.writeBuffer=void 0},0);else{let t=new Uint8Array(this.writeBuffer.length+e.length);t.set(this.writeBuffer),t.set(e,this.writeBuffer.length),this.writeBuffer=t}else this.ws&&this.ws.send(e)}write(e,t="utf8",a=e=>{}){return 0===e.length?(a(),!0):("string"==typeof e&&(e=H.from(e,t)),0===this.tlsState?(this.rawWrite(e),a()):1===this.tlsState?this.once("secureConnection",()=>{this.write(e,t,a)}):(this.tlsWrite(e),a()),!0)}end(e=H.alloc(0),t="utf8",a=()=>{}){return this.write(e,t,()=>{this.ws.close(),a()}),this}destroy(){return this.destroyed=!0,this.end()}},ee(fe,"Socket"),oe(fe,"defaults",{poolQueryViaFetch:!1,fetchEndpoint:ee((e,t,a)=>{let r;return r=(null==a?void 0:a.jwtAuth)?e.replace(_e,"apiauth."):e.replace(_e,"api."),"https://"+r+"/sql"},"fetchEndpoint"),fetchConnectionCache:!0,fetchFunction:void 0,webSocketConstructor:void 0,wsProxy:ee(e=>e+"/v2","wsProxy"),useSecureWebSocket:!0,forceDisablePgSSL:!0,coalesceWrites:!0,pipelineConnect:"password",subtls:void 0,rootCerts:"",pipelineTLS:!1,disableSNI:!1,disableWarningInBrowsers:!1}),oe(fe,"opts",{}),ye=fe}),we={};function be(e,t=!1){let{protocol:a}=new URL(e),r="http:"+e.substring(a.length),{username:s,password:n,host:i,hostname:o,port:c,pathname:l,search:d,searchParams:u,hash:m}=new URL(r);return n=decodeURIComponent(n),s=decodeURIComponent(s),l=decodeURIComponent(l),{href:e,protocol:a,auth:s+":"+n,username:s,password:n,host:i,hostname:o,port:c,pathname:l,search:d,query:t?Object.fromEntries(u.entries()):d,hash:m}}re(we,{parse:()=>be});var Se=te(()=>{ue(),ee(be,"parse")}),xe=ae(e=>{ue(),e.parse=function(e,t){return new a(e,t).parse()};var t=class e{constructor(e,t){this.source=e,this.transform=t||r,this.position=0,this.entries=[],this.recorded=[],this.dimension=0}isEof(){return this.position>=this.source.length}nextCharacter(){var e=this.source[this.position++];return"\\"===e?{value:this.source[this.position++],escaped:!0}:{value:e,escaped:!1}}record(e){this.recorded.push(e)}newEntry(e){var t;(this.recorded.length>0||e)&&("NULL"===(t=this.recorded.join(""))&&!e&&(t=null),null!==t&&(t=this.transform(t)),this.entries.push(t),this.recorded=[])}consumeDimensions(){if("["===this.source[0])for(;!this.isEof();){if("="===this.nextCharacter().value)break}}parse(t){var a,r,s;for(this.consumeDimensions();!this.isEof();)if("{"!==(a=this.nextCharacter()).value||s){if("}"!==a.value||s)'"'!==a.value||a.escaped?","!==a.value||s?this.record(a.value):this.newEntry():(s&&this.newEntry(!0),s=!s);else if(this.dimension--,!this.dimension&&(this.newEntry(),t))return this.entries}else this.dimension++,this.dimension>1&&(r=new e(this.source.substr(this.position-1),this.transform),this.entries.push(r.parse(!0)),this.position+=r.position-2);if(0!==this.dimension)throw new Error("array dimension not balanced");return this.entries}};ee(t,"ArrayParser");var a=t;function r(e){return e}ee(r,"identity")}),ke=ae((e,t)=>{ue();var a=xe();t.exports={create:ee(function(e,t){return{parse:ee(function(){return a.parse(e,t)},"parse")}},"create")}}),Ee=ae((e,t)=>{ue();var a=/(\d{1,})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.\d{1,})?.*?( BC)?$/,r=/^(\d{1,})-(\d{2})-(\d{2})( BC)?$/,s=/([Z+-])(\d{2})?:?(\d{2})?:?(\d{2})?/,n=/^-?infinity$/;function i(e){var t=r.exec(e);if(t){var a=parseInt(t[1],10);!!t[4]&&(a=c(a));var s=parseInt(t[2],10)-1,n=t[3],i=new Date(a,s,n);return l(a)&&i.setFullYear(a),i}}function o(e){if(e.endsWith("+00"))return 0;var t=s.exec(e.split(" ")[1]);if(t){var a=t[1];if("Z"===a)return 0;var r="-"===a?-1:1;return(3600*parseInt(t[2],10)+60*parseInt(t[3]||0,10)+parseInt(t[4]||0,10))*r*1e3}}function c(e){return-(e-1)}function l(e){return e>=0&&e<100}t.exports=ee(function(e){if(n.test(e))return Number(e.replace("i","I"));var t=a.exec(e);if(!t)return i(e)||null;var r=!!t[8],s=parseInt(t[1],10);r&&(s=c(s));var d=parseInt(t[2],10)-1,u=t[3],m=parseInt(t[4],10),h=parseInt(t[5],10),p=parseInt(t[6],10),g=t[7];g=g?1e3*parseFloat(g):0;var _,f=o(e);return null!=f?(_=new Date(Date.UTC(s,d,u,m,h,p,g)),l(s)&&_.setUTCFullYear(s),0!==f&&_.setTime(_.getTime()-f)):(_=new Date(s,d,u,m,h,p,g),l(s)&&_.setFullYear(s)),_},"parseDate"),ee(i,"getDate"),ee(o,"timeZoneOffset"),ee(c,"bcYearToNegativeYear"),ee(l,"is0To99")}),Ie=ae((e,t)=>{ue(),t.exports=r;var a=Object.prototype.hasOwnProperty;function r(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)a.call(r,s)&&(e[s]=r[s])}return e}ee(r,"extend")}),Ae=ae((e,t)=>{ue();var a=Ie();function r(e){if(!(this instanceof r))return new r(e);a(this,h(e))}t.exports=r,ee(r,"PostgresInterval");var s=["seconds","minutes","hours","days","months","years"];r.prototype.toPostgres=function(){var e=s.filter(this.hasOwnProperty,this);return this.milliseconds&&e.indexOf("seconds")<0&&e.push("seconds"),0===e.length?"0":e.map(function(e){var t=this[e]||0;return"seconds"===e&&this.milliseconds&&(t=(t+this.milliseconds/1e3).toFixed(6).replace(/\.?0+$/,"")),t+" "+e},this).join(" ")};var n={years:"Y",months:"M",days:"D",hours:"H",minutes:"M",seconds:"S"},i=["years","months","days"],o=["hours","minutes","seconds"];r.prototype.toISOString=r.prototype.toISO=function(){return"P"+i.map(e,this).join("")+"T"+o.map(e,this).join("");function e(e){var t=this[e]||0;return"seconds"===e&&this.milliseconds&&(t=(t+this.milliseconds/1e3).toFixed(6).replace(/0+$/,"")),t+n[e]}};var c="([+-]?\\d+)",l=new RegExp([c+"\\s+years?",c+"\\s+mons?",c+"\\s+days?","([+-])?([\\d]*):(\\d\\d):(\\d\\d)\\.?(\\d{1,6})?"].map(function(e){return"("+e+")?"}).join("\\s*")),d={years:2,months:4,days:6,hours:9,minutes:10,seconds:11,milliseconds:12},u=["hours","minutes","seconds","milliseconds"];function m(e){var t=e+"000000".slice(e.length);return parseInt(t,10)/1e3}function h(e){if(!e)return{};var t=l.exec(e),a="-"===t[8];return Object.keys(d).reduce(function(e,r){var s=d[r],n=t[s];return!n||!(n="milliseconds"===r?m(n):parseInt(n,10))||(a&&~u.indexOf(r)&&(n*=-1),e[r]=n),e},{})}ee(m,"parseMilliseconds"),ee(h,"parse")}),Pe=ae((e,t)=>{ue(),t.exports=ee(function(e){if(/^\\x/.test(e))return new H(e.substr(2),"hex");for(var t="",a=0;a<e.length;)if("\\"!==e[a])t+=e[a],++a;else if(/[0-7]{3}/.test(e.substr(a+1,3)))t+=String.fromCharCode(parseInt(e.substr(a+1,3),8)),a+=4;else{for(var r=1;a+r<e.length&&"\\"===e[a+r];)r++;for(var s=0;s<Math.floor(r/2);++s)t+="\\";a+=2*Math.floor(r/2)}return new H(t,"binary")},"parseBytea")}),Ce=ae((e,t)=>{ue();var a=xe(),r=ke(),s=Ee(),n=Ae(),i=Pe();function o(e){return ee(function(t){return null===t?t:e(t)},"nullAllowed")}function c(e){return null===e?e:"TRUE"===e||"t"===e||"true"===e||"y"===e||"yes"===e||"on"===e||"1"===e}function l(e){return e?a.parse(e,c):null}function d(e){return parseInt(e,10)}function u(e){return e?a.parse(e,o(d)):null}function m(e){return e?a.parse(e,o(function(e){return w(e).trim()})):null}ee(o,"allowNull"),ee(c,"parseBool"),ee(l,"parseBoolArray"),ee(d,"parseBaseTenInt"),ee(u,"parseIntegerArray"),ee(m,"parseBigIntegerArray");var h=ee(function(e){return e?r.create(e,function(e){return null!==e&&(e=S(e)),e}).parse():null},"parsePointArray"),p=ee(function(e){return e?r.create(e,function(e){return null!==e&&(e=parseFloat(e)),e}).parse():null},"parseFloatArray"),g=ee(function(e){return e?r.create(e).parse():null},"parseStringArray"),_=ee(function(e){return e?r.create(e,function(e){return null!==e&&(e=s(e)),e}).parse():null},"parseDateArray"),f=ee(function(e){return e?r.create(e,function(e){return null!==e&&(e=n(e)),e}).parse():null},"parseIntervalArray"),y=ee(function(e){return e?a.parse(e,o(i)):null},"parseByteAArray"),v=ee(function(e){return parseInt(e,10)},"parseInteger"),w=ee(function(e){var t=String(e);return/^\d+$/.test(t)?t:e},"parseBigInteger"),b=ee(function(e){return e?a.parse(e,o(JSON.parse)):null},"parseJsonArray"),S=ee(function(e){return"("!==e[0]?null:(e=e.substring(1,e.length-1).split(","),{x:parseFloat(e[0]),y:parseFloat(e[1])})},"parsePoint"),x=ee(function(e){if("<"!==e[0]&&"("!==e[1])return null;for(var t="(",a="",r=!1,s=2;s<e.length-1;s++)r||(t+=e[s]),")"!==e[s]?r&&","!==e[s]&&(a+=e[s]):r=!0;var n=S(t);return n.radius=parseFloat(a),n},"parseCircle"),k=ee(function(e){e(20,w),e(21,v),e(23,v),e(26,v),e(700,parseFloat),e(701,parseFloat),e(16,c),e(1082,s),e(1114,s),e(1184,s),e(600,S),e(651,g),e(718,x),e(1e3,l),e(1001,y),e(1005,u),e(1007,u),e(1028,u),e(1016,m),e(1017,h),e(1021,p),e(1022,p),e(1231,p),e(1014,g),e(1015,g),e(1008,g),e(1009,g),e(1040,g),e(1041,g),e(1115,_),e(1182,_),e(1185,_),e(1186,n),e(1187,f),e(17,i),e(114,JSON.parse.bind(JSON)),e(3802,JSON.parse.bind(JSON)),e(199,b),e(3807,b),e(3907,g),e(2951,g),e(791,g),e(1183,g),e(1270,g)},"init");t.exports={init:k}}),Te=ae((e,t)=>{ue();var a=1e6;function r(e){var t=e.readInt32BE(0),r=e.readUInt32BE(4),s="";t<0&&(t=~t+(0===r),r=1+~r>>>0,s="-");var n,i,o,c,l,d,u="";if(n=t%a,t=t/a>>>0,o=""+((i=4294967296*n+r)-a*(r=i/a>>>0)),0===r&&0===t)return s+o+u;for(c="",l=6-o.length,d=0;d<l;d++)c+="0";if(u=c+o+u,n=t%a,t=t/a>>>0,o=""+((i=4294967296*n+r)-a*(r=i/a>>>0)),0===r&&0===t)return s+o+u;for(c="",l=6-o.length,d=0;d<l;d++)c+="0";if(u=c+o+u,n=t%a,t=t/a>>>0,o=""+((i=4294967296*n+r)-a*(r=i/a>>>0)),0===r&&0===t)return s+o+u;for(c="",l=6-o.length,d=0;d<l;d++)c+="0";return u=c+o+u,s+(o=""+(i=4294967296*(n=t%a)+r)%a)+u}ee(r,"readInt8"),t.exports=r}),je=ae((e,t)=>{ue();var a=Te(),r=ee(function(e,t,a,r,s){r=r||!1,s=s||function(e,t,a){return e*Math.pow(2,a)+t};var n=(a=a||0)>>3,i=ee(function(e){return r?255&~e:e},"inv"),o=255,c=8-a%8;t<c&&(o=255<<8-t&255,c=t),a&&(o>>=a%8);var l=0;a%8+t>=8&&(l=s(0,i(e[n])&o,c));for(var d=t+a>>3,u=n+1;u<d;u++)l=s(l,i(e[u]),8);var m=(t+a)%8;return m>0&&(l=s(l,i(e[d])>>8-m,m)),l},"parseBits"),s=ee(function(e,t,a){var s=Math.pow(2,a-1)-1,n=r(e,1),i=r(e,a,1);if(0===i)return 0;var o=1,c=ee(function(e,t,a){0===e&&(e=1);for(var r=1;r<=a;r++)o/=2,(t&1<<a-r)>0&&(e+=o);return e},"parsePrecisionBits"),l=r(e,t,a+1,!1,c);return i==Math.pow(2,a+1)-1?0===l?0===n?1/0:-1/0:NaN:(0===n?1:-1)*Math.pow(2,i-s)*l},"parseFloatFromBits"),n=ee(function(e){return 1==r(e,1)?-1*(r(e,15,1,!0)+1):r(e,15,1)},"parseInt16"),i=ee(function(e){return 1==r(e,1)?-1*(r(e,31,1,!0)+1):r(e,31,1)},"parseInt32"),o=ee(function(e){return s(e,23,8)},"parseFloat32"),c=ee(function(e){return s(e,52,11)},"parseFloat64"),l=ee(function(e){var t=r(e,16,32);if(49152==t)return NaN;for(var a=Math.pow(1e4,r(e,16,16)),s=0,n=r(e,16),i=0;i<n;i++)s+=r(e,16,64+16*i)*a,a/=1e4;var o=Math.pow(10,r(e,16,48));return(0===t?1:-1)*Math.round(s*o)/o},"parseNumeric"),d=ee(function(e,t){var a=r(t,1),s=r(t,63,1),n=new Date((0===a?1:-1)*s/1e3+9466848e5);return e||n.setTime(n.getTime()+6e4*n.getTimezoneOffset()),n.usec=s%1e3,n.getMicroSeconds=function(){return this.usec},n.setMicroSeconds=function(e){this.usec=e},n.getUTCMicroSeconds=function(){return this.usec},n},"parseDate"),u=ee(function(e){for(var t=r(e,32),a=(r(e,32,32),r(e,32,64)),s=96,n=[],i=0;i<t;i++)n[i]=r(e,32,s),s+=32,s+=32;var o=ee(function(t){var a,n=r(e,32,s);return s+=32,4294967295==n?null:23==t||20==t?(a=r(e,8*n,s),s+=8*n,a):25==t?a=e.toString(this.encoding,s>>3,(s+=n<<3)>>3):void 0},"parseElement"),c=ee(function(e,t){var a,r=[];if(e.length>1){var s=e.shift();for(a=0;a<s;a++)r[a]=c(e,t);e.unshift(s)}else for(a=0;a<e[0];a++)r[a]=o(t);return r},"parse");return c(n,a)},"parseArray"),m=ee(function(e){return e.toString("utf8")},"parseText"),h=ee(function(e){return null===e?null:r(e,8)>0},"parseBool"),p=ee(function(e){e(20,a),e(21,n),e(23,i),e(26,i),e(1700,l),e(700,o),e(701,c),e(16,h),e(1114,d.bind(null,!1)),e(1184,d.bind(null,!0)),e(1e3,u),e(1007,u),e(1016,u),e(1008,u),e(1009,u),e(25,m)},"init");t.exports={init:p}}),De=ae((e,t)=>{ue(),t.exports={BOOL:16,BYTEA:17,CHAR:18,INT8:20,INT2:21,INT4:23,REGPROC:24,TEXT:25,OID:26,TID:27,XID:28,CID:29,JSON:114,XML:142,PG_NODE_TREE:194,SMGR:210,PATH:602,POLYGON:604,CIDR:650,FLOAT4:700,FLOAT8:701,ABSTIME:702,RELTIME:703,TINTERVAL:704,CIRCLE:718,MACADDR8:774,MONEY:790,MACADDR:829,INET:869,ACLITEM:1033,BPCHAR:1042,VARCHAR:1043,DATE:1082,TIME:1083,TIMESTAMP:1114,TIMESTAMPTZ:1184,INTERVAL:1186,TIMETZ:1266,BIT:1560,VARBIT:1562,NUMERIC:1700,REFCURSOR:1790,REGPROCEDURE:2202,REGOPER:2203,REGOPERATOR:2204,REGCLASS:2205,REGTYPE:2206,UUID:2950,TXID_SNAPSHOT:2970,PG_LSN:3220,PG_NDISTINCT:3361,PG_DEPENDENCIES:3402,TSVECTOR:3614,TSQUERY:3615,GTSVECTOR:3642,REGCONFIG:3734,REGDICTIONARY:3769,JSONB:3802,REGNAMESPACE:4089,REGROLE:4096}}),Re=ae(e=>{ue();var t=Ce(),a=je(),r=ke(),s=De();e.getTypeParser=o,e.setTypeParser=c,e.arrayParser=r,e.builtins=s;var n={text:{},binary:{}};function i(e){return String(e)}function o(e,t){return n[t=t||"text"]&&n[t][e]||i}function c(e,t,a){"function"==typeof t&&(a=t,t="text"),n[t][e]=a}ee(i,"noParse"),ee(o,"getTypeParser"),ee(c,"setTypeParser"),t.init(function(e,t){n.text[e]=t}),a.init(function(e,t){n.binary[e]=t})}),Le=ae((e,t)=>{ue();var a=Re();function r(e){this._types=e||a,this.text={},this.binary={}}ee(r,"TypeOverrides"),r.prototype.getOverrides=function(e){switch(e){case"text":return this.text;case"binary":return this.binary;default:return{}}},r.prototype.setTypeParser=function(e,t,a){"function"==typeof t&&(a=t,t="text"),this.getOverrides(t)[e]=a},r.prototype.getTypeParser=function(e,t){return t=t||"text",this.getOverrides(t)[e]||this._types.getTypeParser(e,t)},t.exports=r});function Oe(e){let t=1779033703,a=3144134277,r=1013904242,s=2773480762,n=1359893119,i=2600822924,o=528734635,c=1541459225,l=0,d=0,u=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],m=ee((e,t)=>e>>>t|e<<32-t,"rrot"),h=new Uint32Array(64),p=new Uint8Array(64),g=ee(()=>{for(let t=0,a=0;t<16;t++,a+=4)h[t]=p[a]<<24|p[a+1]<<16|p[a+2]<<8|p[a+3];for(let t=16;t<64;t++){let e=m(h[t-15],7)^m(h[t-15],18)^h[t-15]>>>3,a=m(h[t-2],17)^m(h[t-2],19)^h[t-2]>>>10;h[t]=h[t-16]+e+h[t-7]+a|0}let e=t,l=a,g=r,_=s,f=n,y=i,v=o,w=c;for(let t=0;t<64;t++){let a=w+(m(f,6)^m(f,11)^m(f,25))+(f&y^~f&v)+u[t]+h[t]|0,r=e&l^e&g^l&g;w=v,v=y,y=f,f=_+a|0,_=g,g=l,l=e,e=a+((m(e,2)^m(e,13)^m(e,22))+r|0)|0}t=t+e|0,a=a+l|0,r=r+g|0,s=s+_|0,n=n+f|0,i=i+y|0,o=o+v|0,c=c+w|0,d=0},"process"),_=ee(e=>{"string"==typeof e&&(e=(new TextEncoder).encode(e));for(let t=0;t<e.length;t++)p[d++]=e[t],64===d&&g();l+=e.length},"add"),f=ee(()=>{if(p[d++]=128,64==d&&g(),d+8>64){for(;d<64;)p[d++]=0;g()}for(;d<58;)p[d++]=0;let e=8*l;p[d++]=e/1099511627776&255,p[d++]=e/4294967296&255,p[d++]=e>>>24,p[d++]=e>>>16&255,p[d++]=e>>>8&255,p[d++]=255&e,g();let u=new Uint8Array(32);return u[0]=t>>>24,u[1]=t>>>16&255,u[2]=t>>>8&255,u[3]=255&t,u[4]=a>>>24,u[5]=a>>>16&255,u[6]=a>>>8&255,u[7]=255&a,u[8]=r>>>24,u[9]=r>>>16&255,u[10]=r>>>8&255,u[11]=255&r,u[12]=s>>>24,u[13]=s>>>16&255,u[14]=s>>>8&255,u[15]=255&s,u[16]=n>>>24,u[17]=n>>>16&255,u[18]=n>>>8&255,u[19]=255&n,u[20]=i>>>24,u[21]=i>>>16&255,u[22]=i>>>8&255,u[23]=255&i,u[24]=o>>>24,u[25]=o>>>16&255,u[26]=o>>>8&255,u[27]=255&o,u[28]=c>>>24,u[29]=c>>>16&255,u[30]=c>>>8&255,u[31]=255&c,u},"digest");return void 0===e?{add:_,digest:f}:(_(e),f())}var qe,Ne,Me=te(()=>{ue(),ee(Oe,"sha256")}),Ue=te(()=>{ue(),ee(qe=class e{constructor(){oe(this,"_dataLength",0),oe(this,"_bufferLength",0),oe(this,"_state",new Int32Array(4)),oe(this,"_buffer",new ArrayBuffer(68)),oe(this,"_buffer8"),oe(this,"_buffer32"),this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}static hashByteArray(e,t=!1){return this.onePassHasher.start().appendByteArray(e).end(t)}static hashStr(e,t=!1){return this.onePassHasher.start().appendStr(e).end(t)}static hashAsciiStr(e,t=!1){return this.onePassHasher.start().appendAsciiStr(e).end(t)}static _hex(t){let a,r,s,n,i=e.hexChars,o=e.hexOut;for(n=0;n<4;n+=1)for(r=8*n,a=t[n],s=0;s<8;s+=2)o[r+1+s]=i.charAt(15&a),a>>>=4,o[r+0+s]=i.charAt(15&a),a>>>=4;return o.join("")}static _md5cycle(e,t){let a=e[0],r=e[1],s=e[2],n=e[3];a+=(r&s|~r&n)+t[0]-680876936|0,a=(a<<7|a>>>25)+r|0,n+=(a&r|~a&s)+t[1]-389564586|0,n=(n<<12|n>>>20)+a|0,s+=(n&a|~n&r)+t[2]+606105819|0,s=(s<<17|s>>>15)+n|0,r+=(s&n|~s&a)+t[3]-1044525330|0,r=(r<<22|r>>>10)+s|0,a+=(r&s|~r&n)+t[4]-176418897|0,a=(a<<7|a>>>25)+r|0,n+=(a&r|~a&s)+t[5]+1200080426|0,n=(n<<12|n>>>20)+a|0,s+=(n&a|~n&r)+t[6]-1473231341|0,s=(s<<17|s>>>15)+n|0,r+=(s&n|~s&a)+t[7]-45705983|0,r=(r<<22|r>>>10)+s|0,a+=(r&s|~r&n)+t[8]+1770035416|0,a=(a<<7|a>>>25)+r|0,n+=(a&r|~a&s)+t[9]-1958414417|0,n=(n<<12|n>>>20)+a|0,s+=(n&a|~n&r)+t[10]-42063|0,s=(s<<17|s>>>15)+n|0,r+=(s&n|~s&a)+t[11]-1990404162|0,r=(r<<22|r>>>10)+s|0,a+=(r&s|~r&n)+t[12]+1804603682|0,a=(a<<7|a>>>25)+r|0,n+=(a&r|~a&s)+t[13]-40341101|0,n=(n<<12|n>>>20)+a|0,s+=(n&a|~n&r)+t[14]-1502002290|0,s=(s<<17|s>>>15)+n|0,r+=(s&n|~s&a)+t[15]+1236535329|0,r=(r<<22|r>>>10)+s|0,a+=(r&n|s&~n)+t[1]-165796510|0,a=(a<<5|a>>>27)+r|0,n+=(a&s|r&~s)+t[6]-1069501632|0,n=(n<<9|n>>>23)+a|0,s+=(n&r|a&~r)+t[11]+643717713|0,s=(s<<14|s>>>18)+n|0,r+=(s&a|n&~a)+t[0]-373897302|0,r=(r<<20|r>>>12)+s|0,a+=(r&n|s&~n)+t[5]-701558691|0,a=(a<<5|a>>>27)+r|0,n+=(a&s|r&~s)+t[10]+38016083|0,n=(n<<9|n>>>23)+a|0,s+=(n&r|a&~r)+t[15]-660478335|0,s=(s<<14|s>>>18)+n|0,r+=(s&a|n&~a)+t[4]-405537848|0,r=(r<<20|r>>>12)+s|0,a+=(r&n|s&~n)+t[9]+568446438|0,a=(a<<5|a>>>27)+r|0,n+=(a&s|r&~s)+t[14]-1019803690|0,n=(n<<9|n>>>23)+a|0,s+=(n&r|a&~r)+t[3]-187363961|0,s=(s<<14|s>>>18)+n|0,r+=(s&a|n&~a)+t[8]+1163531501|0,r=(r<<20|r>>>12)+s|0,a+=(r&n|s&~n)+t[13]-1444681467|0,a=(a<<5|a>>>27)+r|0,n+=(a&s|r&~s)+t[2]-51403784|0,n=(n<<9|n>>>23)+a|0,s+=(n&r|a&~r)+t[7]+1735328473|0,s=(s<<14|s>>>18)+n|0,r+=(s&a|n&~a)+t[12]-1926607734|0,r=(r<<20|r>>>12)+s|0,a+=(r^s^n)+t[5]-378558|0,a=(a<<4|a>>>28)+r|0,n+=(a^r^s)+t[8]-2022574463|0,n=(n<<11|n>>>21)+a|0,s+=(n^a^r)+t[11]+1839030562|0,s=(s<<16|s>>>16)+n|0,r+=(s^n^a)+t[14]-35309556|0,r=(r<<23|r>>>9)+s|0,a+=(r^s^n)+t[1]-1530992060|0,a=(a<<4|a>>>28)+r|0,n+=(a^r^s)+t[4]+1272893353|0,n=(n<<11|n>>>21)+a|0,s+=(n^a^r)+t[7]-155497632|0,s=(s<<16|s>>>16)+n|0,r+=(s^n^a)+t[10]-1094730640|0,r=(r<<23|r>>>9)+s|0,a+=(r^s^n)+t[13]+681279174|0,a=(a<<4|a>>>28)+r|0,n+=(a^r^s)+t[0]-358537222|0,n=(n<<11|n>>>21)+a|0,s+=(n^a^r)+t[3]-722521979|0,s=(s<<16|s>>>16)+n|0,r+=(s^n^a)+t[6]+76029189|0,r=(r<<23|r>>>9)+s|0,a+=(r^s^n)+t[9]-640364487|0,a=(a<<4|a>>>28)+r|0,n+=(a^r^s)+t[12]-421815835|0,n=(n<<11|n>>>21)+a|0,s+=(n^a^r)+t[15]+530742520|0,s=(s<<16|s>>>16)+n|0,r+=(s^n^a)+t[2]-995338651|0,r=(r<<23|r>>>9)+s|0,a+=(s^(r|~n))+t[0]-198630844|0,a=(a<<6|a>>>26)+r|0,n+=(r^(a|~s))+t[7]+1126891415|0,n=(n<<10|n>>>22)+a|0,s+=(a^(n|~r))+t[14]-1416354905|0,s=(s<<15|s>>>17)+n|0,r+=(n^(s|~a))+t[5]-57434055|0,r=(r<<21|r>>>11)+s|0,a+=(s^(r|~n))+t[12]+1700485571|0,a=(a<<6|a>>>26)+r|0,n+=(r^(a|~s))+t[3]-1894986606|0,n=(n<<10|n>>>22)+a|0,s+=(a^(n|~r))+t[10]-1051523|0,s=(s<<15|s>>>17)+n|0,r+=(n^(s|~a))+t[1]-2054922799|0,r=(r<<21|r>>>11)+s|0,a+=(s^(r|~n))+t[8]+1873313359|0,a=(a<<6|a>>>26)+r|0,n+=(r^(a|~s))+t[15]-30611744|0,n=(n<<10|n>>>22)+a|0,s+=(a^(n|~r))+t[6]-1560198380|0,s=(s<<15|s>>>17)+n|0,r+=(n^(s|~a))+t[13]+1309151649|0,r=(r<<21|r>>>11)+s|0,a+=(s^(r|~n))+t[4]-145523070|0,a=(a<<6|a>>>26)+r|0,n+=(r^(a|~s))+t[11]-1120210379|0,n=(n<<10|n>>>22)+a|0,s+=(a^(n|~r))+t[2]+718787259|0,s=(s<<15|s>>>17)+n|0,r+=(n^(s|~a))+t[9]-343485551|0,r=(r<<21|r>>>11)+s|0,e[0]=a+e[0]|0,e[1]=r+e[1]|0,e[2]=s+e[2]|0,e[3]=n+e[3]|0}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(e.stateIdentity),this}appendStr(t){let a,r,s=this._buffer8,n=this._buffer32,i=this._bufferLength;for(r=0;r<t.length;r+=1){if(a=t.charCodeAt(r),a<128)s[i++]=a;else if(a<2048)s[i++]=(a>>>6)+192,s[i++]=63&a|128;else if(a<55296||a>56319)s[i++]=(a>>>12)+224,s[i++]=a>>>6&63|128,s[i++]=63&a|128;else{if(a=1024*(a-55296)+(t.charCodeAt(++r)-56320)+65536,a>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");s[i++]=(a>>>18)+240,s[i++]=a>>>12&63|128,s[i++]=a>>>6&63|128,s[i++]=63&a|128}i>=64&&(this._dataLength+=64,e._md5cycle(this._state,n),i-=64,n[0]=n[16])}return this._bufferLength=i,this}appendAsciiStr(t){let a,r=this._buffer8,s=this._buffer32,n=this._bufferLength,i=0;for(;;){for(a=Math.min(t.length-i,64-n);a--;)r[n++]=t.charCodeAt(i++);if(n<64)break;this._dataLength+=64,e._md5cycle(this._state,s),n=0}return this._bufferLength=n,this}appendByteArray(t){let a,r=this._buffer8,s=this._buffer32,n=this._bufferLength,i=0;for(;;){for(a=Math.min(t.length-i,64-n);a--;)r[n++]=t[i++];if(n<64)break;this._dataLength+=64,e._md5cycle(this._state,s),n=0}return this._bufferLength=n,this}getState(){let e=this._state;return{buffer:String.fromCharCode.apply(null,Array.from(this._buffer8)),buflen:this._bufferLength,length:this._dataLength,state:[e[0],e[1],e[2],e[3]]}}setState(e){let t,a=e.buffer,r=e.state,s=this._state;for(this._dataLength=e.length,this._bufferLength=e.buflen,s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=r[3],t=0;t<a.length;t+=1)this._buffer8[t]=a.charCodeAt(t)}end(t=!1){let a=this._bufferLength,r=this._buffer8,s=this._buffer32,n=1+(a>>2);this._dataLength+=a;let i=8*this._dataLength;if(r[a]=128,r[a+1]=r[a+2]=r[a+3]=0,s.set(e.buffer32Identity.subarray(n),n),a>55&&(e._md5cycle(this._state,s),s.set(e.buffer32Identity)),i<=4294967295)s[14]=i;else{let e=i.toString(16).match(/(.*?)(.{0,8})$/);if(null===e)return;let t=parseInt(e[2],16),a=parseInt(e[1],16)||0;s[14]=t,s[15]=a}return e._md5cycle(this._state,s),t?this._state:e._hex(this._state)}},"Md5"),oe(qe,"stateIdentity",new Int32Array([1732584193,-271733879,-1732584194,271733878])),oe(qe,"buffer32Identity",new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),oe(qe,"hexChars","0123456789abcdef"),oe(qe,"hexOut",[]),oe(qe,"onePassHasher",new qe),Ne=qe}),Be={};function $e(e){return crypto.getRandomValues(H.alloc(e))}function Fe(e){if("sha256"===e)return{update:ee(function(e){return{digest:ee(function(){return H.from(Oe(e))},"digest")}},"update")};if("md5"===e)return{update:ee(function(e){return{digest:ee(function(){return"string"==typeof e?Ne.hashStr(e):Ne.hashByteArray(e)},"digest")}},"update")};throw new Error(`Hash type '${e}' not supported`)}function ze(e,t){if("sha256"!==e)throw new Error(`Only sha256 is supported (requested: '${e}')`);return{update:ee(function(e){return{digest:ee(function(){"string"==typeof t&&(t=(new TextEncoder).encode(t)),"string"==typeof e&&(e=(new TextEncoder).encode(e));let a=t.length;if(a>64)t=Oe(t);else if(a<64){let e=new Uint8Array(64);e.set(t),t=e}let r=new Uint8Array(64),s=new Uint8Array(64);for(let e=0;e<64;e++)r[e]=54^t[e],s[e]=92^t[e];let n=new Uint8Array(e.length+64);n.set(r,0),n.set(e,64);let i=new Uint8Array(96);return i.set(s,0),i.set(Oe(n),64),H.from(Oe(i))},"digest")}},"update")}}re(Be,{createHash:()=>Fe,createHmac:()=>ze,randomBytes:()=>$e});var Ve=te(()=>{ue(),Me(),Ue(),ee($e,"randomBytes"),ee(Fe,"createHash"),ee(ze,"createHmac")}),We=ae((e,t)=>{ue(),t.exports={host:"localhost",user:"win32"===Q.platform?Q.env.USERNAME:Q.env.USER,database:void 0,password:null,connectionString:void 0,port:5432,rows:0,binary:!1,max:10,idleTimeoutMillis:3e4,client_encoding:"",ssl:!1,application_name:void 0,fallback_application_name:void 0,options:void 0,parseInputDatesAsUTC:!1,statement_timeout:!1,lock_timeout:!1,idle_in_transaction_session_timeout:!1,query_timeout:!1,connect_timeout:0,keepalives:1,keepalives_idle:0};var a=Re(),r=a.getTypeParser(20,"text"),s=a.getTypeParser(1016,"text");t.exports.__defineSetter__("parseInt8",function(e){a.setTypeParser(20,"text",e?a.getTypeParser(23,"text"):r),a.setTypeParser(1016,"text",e?a.getTypeParser(1007,"text"):s)})}),He=ae((e,t)=>{ue();var a=(Ve(),ie(Be)),r=We();function s(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function n(e){for(var t="{",a=0;a<e.length;a++)a>0&&(t+=","),null===e[a]||typeof e[a]>"u"?t+="NULL":Array.isArray(e[a])?t+=n(e[a]):e[a]instanceof H?t+="\\\\x"+e[a].toString("hex"):t+=s(i(e[a]));return t+="}"}ee(s,"escapeElement"),ee(n,"arrayString");var i=ee(function(e,t){if(null==e)return null;if(e instanceof H)return e;if(ArrayBuffer.isView(e)){var a=H.from(e.buffer,e.byteOffset,e.byteLength);return a.length===e.byteLength?a:a.slice(e.byteOffset,e.byteOffset+e.byteLength)}return e instanceof Date?r.parseInputDatesAsUTC?d(e):l(e):Array.isArray(e)?n(e):"object"==typeof e?o(e,t):e.toString()},"prepareValue");function o(e,t){if(e&&"function"==typeof e.toPostgres){if(-1!==(t=t||[]).indexOf(e))throw new Error('circular reference detected while preparing "'+e+'" for query');return t.push(e),i(e.toPostgres(i),t)}return JSON.stringify(e)}function c(e,t){for(e=""+e;e.length<t;)e="0"+e;return e}function l(e){var t=-e.getTimezoneOffset(),a=e.getFullYear(),r=a<1;r&&(a=Math.abs(a)+1);var s=c(a,4)+"-"+c(e.getMonth()+1,2)+"-"+c(e.getDate(),2)+"T"+c(e.getHours(),2)+":"+c(e.getMinutes(),2)+":"+c(e.getSeconds(),2)+"."+c(e.getMilliseconds(),3);return t<0?(s+="-",t*=-1):s+="+",s+=c(Math.floor(t/60),2)+":"+c(t%60,2),r&&(s+=" BC"),s}function d(e){var t=e.getUTCFullYear(),a=t<1;a&&(t=Math.abs(t)+1);var r=c(t,4)+"-"+c(e.getUTCMonth()+1,2)+"-"+c(e.getUTCDate(),2)+"T"+c(e.getUTCHours(),2)+":"+c(e.getUTCMinutes(),2)+":"+c(e.getUTCSeconds(),2)+"."+c(e.getUTCMilliseconds(),3);return r+="+00:00",a&&(r+=" BC"),r}function u(e,t,a){return e="string"==typeof e?{text:e}:e,t&&("function"==typeof t?e.callback=t:e.values=t),a&&(e.callback=a),e}ee(o,"prepareObject"),ee(c,"pad"),ee(l,"dateToString"),ee(d,"dateToStringUTC"),ee(u,"normalizeQueryConfig");var m=ee(function(e){return a.createHash("md5").update(e,"utf-8").digest("hex")},"md5"),h=ee(function(e,t,a){var r=m(t+e);return"md5"+m(H.concat([H.from(r),a]))},"postgresMd5PasswordHash");t.exports={prepareValue:ee(function(e){return i(e)},"prepareValueWrapper"),normalizeQueryConfig:u,postgresMd5PasswordHash:h,md5:m}}),Qe={};re(Qe,{default:()=>Ge});var Ge,Ke=te(()=>{ue(),Ge={}}),Ye=ae((e,t)=>{ue();var a=(Ve(),ie(Be));function r(e){if(-1===e.indexOf("SCRAM-SHA-256"))throw new Error("SASL: Only mechanism SCRAM-SHA-256 is currently supported");let t=a.randomBytes(18).toString("base64");return{mechanism:"SCRAM-SHA-256",clientNonce:t,response:"n,,n=*,r="+t,message:"SASLInitialResponse"}}function s(e,t,a){if("SASLInitialResponse"!==e.message)throw new Error("SASL: Last message was not SASLInitialResponse");if("string"!=typeof t)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string");if("string"!=typeof a)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: serverData must be a string");let r=l(a);if(!r.nonce.startsWith(e.clientNonce))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");if(r.nonce.length===e.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short");var s=p(t,H.from(r.salt,"base64"),r.iteration),n=h(s,"Client Key"),i=m(n),o="n=*,r="+e.clientNonce,c="r="+r.nonce+",s="+r.salt+",i="+r.iteration,d="c=biws,r="+r.nonce,g=o+","+c+","+d,_=u(n,h(i,g)).toString("base64"),f=h(s,"Server Key"),y=h(f,g);e.message="SASLResponse",e.serverSignature=y.toString("base64"),e.response=d+",p="+_}function n(e,t){if("SASLResponse"!==e.message)throw new Error("SASL: Last message was not SASLResponse");if("string"!=typeof t)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: serverData must be a string");let{serverSignature:a}=d(t);if(a!==e.serverSignature)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature does not match")}function i(e){if("string"!=typeof e)throw new TypeError("SASL: text must be a string");return e.split("").map((t,a)=>e.charCodeAt(a)).every(e=>e>=33&&e<=43||e>=45&&e<=126)}function o(e){return/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(e)}function c(e){if("string"!=typeof e)throw new TypeError("SASL: attribute pairs text must be a string");return new Map(e.split(",").map(e=>{if(!/^.=/.test(e))throw new Error("SASL: Invalid attribute pair entry");return[e[0],e.substring(2)]}))}function l(e){let t=c(e),a=t.get("r");if(!a)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");if(!i(a))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce must only contain printable characters");let r=t.get("s");if(!r)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");if(!o(r))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt must be base64");let s=t.get("i");if(!s)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");if(!/^[1-9][0-9]*$/.test(s))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: invalid iteration count");return{nonce:a,salt:r,iteration:parseInt(s,10)}}function d(e){let t=c(e).get("v");if(!t)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing");if(!o(t))throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature must be base64");return{serverSignature:t}}function u(e,t){if(!H.isBuffer(e))throw new TypeError("first argument must be a Buffer");if(!H.isBuffer(t))throw new TypeError("second argument must be a Buffer");if(e.length!==t.length)throw new Error("Buffer lengths must match");if(0===e.length)throw new Error("Buffers cannot be empty");return H.from(e.map((a,r)=>e[r]^t[r]))}function m(e){return a.createHash("sha256").update(e).digest()}function h(e,t){return a.createHmac("sha256",e).update(t).digest()}function p(e,t,a){for(var r=h(e,H.concat([t,H.from([0,0,0,1])])),s=r,n=0;n<a-1;n++)s=u(s,r=h(e,r));return s}ee(r,"startSession"),ee(s,"continueSession"),ee(n,"finalizeSession"),ee(i,"isPrintableChars"),ee(o,"isBase64"),ee(c,"parseAttributePairs"),ee(l,"parseServerFirstMessage"),ee(d,"parseServerFinalMessage"),ee(u,"xorBuffers"),ee(m,"sha256"),ee(h,"hmacSha256"),ee(p,"Hi"),t.exports={startSession:r,continueSession:s,finalizeSession:n}}),Je={};function Xe(...e){return e.join("/")}re(Je,{join:()=>Xe});var Ze=te(()=>{ue(),ee(Xe,"join")}),et={};function tt(e,t){t(new Error("No filesystem"))}re(et,{stat:()=>tt});var at=te(()=>{ue(),ee(tt,"stat")}),rt={};re(rt,{default:()=>st});var st,nt=te(()=>{ue(),st={}}),it={};re(it,{StringDecoder:()=>ct});var ot,ct,lt=te(()=>{ue(),ee(ot=class{constructor(e){oe(this,"td"),this.td=new TextDecoder(e)}write(e){return this.td.decode(e,{stream:!0})}end(e){return this.td.decode(e)}},"StringDecoder"),ct=ot}),dt=ae((e,t)=>{ue();var{Transform:a}=(nt(),ie(rt)),{StringDecoder:r}=(lt(),ie(it)),s=Symbol("last"),n=Symbol("decoder");function i(e,t,a){let r;if(this.overflow){if(r=this[n].write(e).split(this.matcher),1===r.length)return a();r.shift(),this.overflow=!1}else this[s]+=this[n].write(e),r=this[s].split(this.matcher);this[s]=r.pop();for(let s=0;s<r.length;s++)try{c(this,this.mapper(r[s]))}catch(i){return a(i)}this.overflow=this[s].length>this.maxLength,!this.overflow||this.skipOverflow?a():a(new Error("maximum buffer reached"))}function o(e){if(this[s]+=this[n].end(),this[s])try{c(this,this.mapper(this[s]))}catch(t){return e(t)}e()}function c(e,t){void 0!==t&&e.push(t)}function l(e){return e}function d(e,t,c){switch(e=e||/\r?\n/,t=t||l,c=c||{},arguments.length){case 1:"function"==typeof e?(t=e,e=/\r?\n/):"object"==typeof e&&!(e instanceof RegExp)&&!e[Symbol.split]&&(c=e,e=/\r?\n/);break;case 2:"function"==typeof e?(c=t,t=e,e=/\r?\n/):"object"==typeof t&&(c=t,t=l)}(c=Object.assign({},c)).autoDestroy=!0,c.transform=i,c.flush=o,c.readableObjectMode=!0;let d=new a(c);return d[s]="",d[n]=new r("utf8"),d.matcher=e,d.mapper=t,d.maxLength=c.maxLength,d.skipOverflow=c.skipOverflow||!1,d.overflow=!1,d._destroy=function(e,t){this._writableState.errorEmitted=!1,t(e)},d}ee(i,"transform"),ee(o,"flush"),ee(c,"push"),ee(l,"noop"),ee(d,"split"),t.exports=d}),ut=ae((e,t)=>{ue();var a=(Ze(),ie(Je)),r=(nt(),ie(rt)).Stream,s=dt(),n=(Ke(),ie(Qe)),i="win32"===Q.platform,o=Q.stderr;function c(e){return 32768==(61440&e)}ee(c,"isRegFile");var l=["host","port","database","user","password"],d=l.length,u=l[d-1];function m(){if(o instanceof r&&!0===o.writable){var e=Array.prototype.slice.call(arguments).concat("\n");o.write(n.format.apply(n,e))}}ee(m,"warn"),Object.defineProperty(t.exports,"isWin",{get:ee(function(){return i},"get"),set:ee(function(e){i=e},"set")}),t.exports.warnTo=function(e){var t=o;return o=e,t},t.exports.getFileName=function(e){var t=e||Q.env;return t.PGPASSFILE||(i?a.join(t.APPDATA||"./","postgresql","pgpass.conf"):a.join(t.HOME||"./",".pgpass"))},t.exports.usePgPass=function(e,t){return!Object.prototype.hasOwnProperty.call(Q.env,"PGPASSWORD")&&(!!i||(t=t||"<unkn>",c(e.mode)?!(63&e.mode)||(m('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',t),!1):(m('WARNING: password file "%s" is not a plain file',t),!1)))};var h=t.exports.match=function(e,t){return l.slice(0,-1).reduce(function(a,r,s){return 1==s&&Number(e[r]||5432)===Number(t[r])?a&&!0:a&&("*"===t[r]||t[r]===e[r])},!0)};t.exports.getPassword=function(e,t,a){var r,n=t.pipe(s());function i(t){var a=p(t);a&&g(a)&&h(e,a)&&(r=a[u],n.end())}ee(i,"onLine");var o=ee(function(){t.destroy(),a(r)},"onEnd"),c=ee(function(e){t.destroy(),m("WARNING: error on reading file: %s",e),a(void 0)},"onErr");t.on("error",c),n.on("data",i).on("end",o).on("error",c)};var p=t.exports.parseLine=function(e){if(e.length<11||e.match(/^\s+#/))return null;for(var t="",a="",r=0,s=0,n={},i=ee(function(t,a,r){var s=e.substring(a,r);Object.hasOwnProperty.call(Q.env,"PGPASS_NO_DEESCAPE")||(s=s.replace(/\\([:\\])/g,"$1")),n[l[t]]=s},"addToObj"),o=0;o<e.length-1;o+=1){if(t=e.charAt(o+1),a=e.charAt(o),r==d-1){i(r,s);break}o>=0&&":"==t&&"\\"!==a&&(i(r,s,o+1),s=o+2,r+=1)}return n=Object.keys(n).length===d?n:null},g=t.exports.isValidEntry=function(e){for(var t={0:function(e){return e.length>0},1:function(e){return"*"===e||(e=Number(e),isFinite(e)&&e>0&&e<9007199254740992&&Math.floor(e)===e)},2:function(e){return e.length>0},3:function(e){return e.length>0},4:function(e){return e.length>0}},a=0;a<l.length;a+=1){if(!(0,t[a])(e[l[a]]||""))return!1}return!0}}),mt=ae((e,t)=>{ue(),Ze(),ie(Je);var a=(at(),ie(et)),r=ut();t.exports=function(e,t){var s=r.getFileName();a.stat(s,function(n,i){if(n||!r.usePgPass(i,s))return t(void 0);var o=a.createReadStream(s);r.getPassword(e,o,t)})},t.exports.warnTo=r.warnTo}),ht={};re(ht,{default:()=>pt});var pt,gt=te(()=>{ue(),pt={}}),_t=ae((e,t)=>{ue();var a=(Se(),ie(we)),r=(at(),ie(et));function s(e){if("/"===e.charAt(0))return{host:(s=e.split(" "))[0],database:s[1]};var t=a.parse(/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(e)?encodeURI(e).replace(/\%25(\d\d)/g,"%$1"):e,!0),s=t.query;for(var n in s)Array.isArray(s[n])&&(s[n]=s[n][s[n].length-1]);var i=(t.auth||":").split(":");if(s.user=i[0],s.password=i.splice(1).join(":"),s.port=t.port,"socket:"==t.protocol)return s.host=decodeURI(t.pathname),s.database=t.query.db,s.client_encoding=t.query.encoding,s;s.host||(s.host=t.hostname);var o=t.pathname;if(!s.host&&o&&/^%2f/i.test(o)){var c=o.split("/");s.host=decodeURIComponent(c[0]),o=c.splice(1).join("/")}switch(o&&"/"===o.charAt(0)&&(o=o.slice(1)||null),s.database=o&&decodeURI(o),("true"===s.ssl||"1"===s.ssl)&&(s.ssl=!0),"0"===s.ssl&&(s.ssl=!1),(s.sslcert||s.sslkey||s.sslrootcert||s.sslmode)&&(s.ssl={}),s.sslcert&&(s.ssl.cert=r.readFileSync(s.sslcert).toString()),s.sslkey&&(s.ssl.key=r.readFileSync(s.sslkey).toString()),s.sslrootcert&&(s.ssl.ca=r.readFileSync(s.sslrootcert).toString()),s.sslmode){case"disable":s.ssl=!1;break;case"prefer":case"require":case"verify-ca":case"verify-full":break;case"no-verify":s.ssl.rejectUnauthorized=!1}return s}ee(s,"parse"),t.exports=s,s.parse=s}),ft=ae((e,t)=>{ue();var a=(gt(),ie(ht)),r=We(),s=_t().parse,n=ee(function(e,t,a){return void 0===a?a=Q.env["PG"+e.toUpperCase()]:!1===a||(a=Q.env[a]),t[e]||a||r[e]},"val"),i=ee(function(){switch(Q.env.PGSSLMODE){case"disable":return!1;case"prefer":case"require":case"verify-ca":case"verify-full":return!0;case"no-verify":return{rejectUnauthorized:!1}}return r.ssl},"readSSLConfigFromEnvironment"),o=ee(function(e){return"'"+(""+e).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},"quoteParamValue"),c=ee(function(e,t,a){var r=t[a];null!=r&&e.push(a+"="+o(r))},"add"),l=class{constructor(e){(e="string"==typeof e?s(e):e||{}).connectionString&&(e=Object.assign({},e,s(e.connectionString))),this.user=n("user",e),this.database=n("database",e),void 0===this.database&&(this.database=this.user),this.port=parseInt(n("port",e),10),this.host=n("host",e),Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:n("password",e)}),this.binary=n("binary",e),this.options=n("options",e),this.ssl=typeof e.ssl>"u"?i():e.ssl,"string"==typeof this.ssl&&"true"===this.ssl&&(this.ssl=!0),"no-verify"===this.ssl&&(this.ssl={rejectUnauthorized:!1}),this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this.client_encoding=n("client_encoding",e),this.replication=n("replication",e),this.isDomainSocket=!(this.host||"").indexOf("/"),this.application_name=n("application_name",e,"PGAPPNAME"),this.fallback_application_name=n("fallback_application_name",e,!1),this.statement_timeout=n("statement_timeout",e,!1),this.lock_timeout=n("lock_timeout",e,!1),this.idle_in_transaction_session_timeout=n("idle_in_transaction_session_timeout",e,!1),this.query_timeout=n("query_timeout",e,!1),void 0===e.connectionTimeoutMillis?this.connect_timeout=Q.env.PGCONNECT_TIMEOUT||0:this.connect_timeout=Math.floor(e.connectionTimeoutMillis/1e3),!1===e.keepAlive?this.keepalives=0:!0===e.keepAlive&&(this.keepalives=1),"number"==typeof e.keepAliveInitialDelayMillis&&(this.keepalives_idle=Math.floor(e.keepAliveInitialDelayMillis/1e3))}getLibpqConnectionString(e){var t=[];c(t,this,"user"),c(t,this,"password"),c(t,this,"port"),c(t,this,"application_name"),c(t,this,"fallback_application_name"),c(t,this,"connect_timeout"),c(t,this,"options");var r="object"==typeof this.ssl?this.ssl:this.ssl?{sslmode:this.ssl}:{};if(c(t,r,"sslmode"),c(t,r,"sslca"),c(t,r,"sslkey"),c(t,r,"sslcert"),c(t,r,"sslrootcert"),this.database&&t.push("dbname="+o(this.database)),this.replication&&t.push("replication="+o(this.replication)),this.host&&t.push("host="+o(this.host)),this.isDomainSocket)return e(null,t.join(" "));this.client_encoding&&t.push("client_encoding="+o(this.client_encoding)),a.lookup(this.host,function(a,r){return a?e(a,null):(t.push("hostaddr="+o(r)),e(null,t.join(" ")))})}};ee(l,"ConnectionParameters");var d=l;t.exports=d}),yt=ae((e,t)=>{ue();var a=Re(),r=/^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/,s=class{constructor(e,t){this.command=null,this.rowCount=null,this.oid=null,this.rows=[],this.fields=[],this._parsers=void 0,this._types=t,this.RowCtor=null,this.rowAsArray="array"===e,this.rowAsArray&&(this.parseRow=this._parseRowAsArray)}addCommandComplete(e){var t;(t=e.text?r.exec(e.text):r.exec(e.command))&&(this.command=t[1],t[3]?(this.oid=parseInt(t[2],10),this.rowCount=parseInt(t[3],10)):t[2]&&(this.rowCount=parseInt(t[2],10)))}_parseRowAsArray(e){for(var t=new Array(e.length),a=0,r=e.length;a<r;a++){var s=e[a];t[a]=null!==s?this._parsers[a](s):null}return t}parseRow(e){for(var t={},a=0,r=e.length;a<r;a++){var s=e[a],n=this.fields[a].name;t[n]=null!==s?this._parsers[a](s):null}return t}addRow(e){this.rows.push(e)}addFields(e){this.fields=e,this.fields.length&&(this._parsers=new Array(e.length));for(var t=0;t<e.length;t++){var r=e[t];this._types?this._parsers[t]=this._types.getTypeParser(r.dataTypeID,r.format||"text"):this._parsers[t]=a.getTypeParser(r.dataTypeID,r.format||"text")}}};ee(s,"Result");var n=s;t.exports=n}),vt=ae((e,t)=>{ue();var{EventEmitter:a}=me(),r=yt(),s=He(),n=class extends a{constructor(e,t,a){super(),e=s.normalizeQueryConfig(e,t,a),this.text=e.text,this.values=e.values,this.rows=e.rows,this.types=e.types,this.name=e.name,this.binary=e.binary,this.portal=e.portal||"",this.callback=e.callback,this._rowMode=e.rowMode,Q.domain&&e.callback&&(this.callback=Q.domain.bind(e.callback)),this._result=new r(this._rowMode,this.types),this._results=this._result,this.isPreparedStatement=!1,this._canceledDueToError=!1,this._promise=null}requiresPreparation(){return!(!this.name&&!this.rows)||!(!this.text||!this.values)&&this.values.length>0}_checkForMultirow(){this._result.command&&(Array.isArray(this._results)||(this._results=[this._result]),this._result=new r(this._rowMode,this.types),this._results.push(this._result))}handleRowDescription(e){this._checkForMultirow(),this._result.addFields(e.fields),this._accumulateRows=this.callback||!this.listeners("row").length}handleDataRow(e){let t;if(!this._canceledDueToError){try{t=this._result.parseRow(e.fields)}catch(a){return void(this._canceledDueToError=a)}this.emit("row",t,this._result),this._accumulateRows&&this._result.addRow(t)}}handleCommandComplete(e,t){this._checkForMultirow(),this._result.addCommandComplete(e),this.rows&&t.sync()}handleEmptyQuery(e){this.rows&&e.sync()}handleError(e,t){if(this._canceledDueToError&&(e=this._canceledDueToError,this._canceledDueToError=!1),this.callback)return this.callback(e);this.emit("error",e)}handleReadyForQuery(e){if(this._canceledDueToError)return this.handleError(this._canceledDueToError,e);if(this.callback)try{this.callback(null,this._results)}catch(t){Q.nextTick(()=>{throw t})}this.emit("end",this._results)}submit(e){if("string"!=typeof this.text&&"string"!=typeof this.name)return new Error("A query must have either text or a name. Supplying neither is unsupported.");let t=e.parsedStatements[this.name];return this.text&&t&&this.text!==t?new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`):this.values&&!Array.isArray(this.values)?new Error("Query values must be an array"):(this.requiresPreparation()?this.prepare(e):e.query(this.text),null)}hasBeenParsed(e){return this.name&&e.parsedStatements[this.name]}handlePortalSuspended(e){this._getRows(e,this.rows)}_getRows(e,t){e.execute({portal:this.portal,rows:t}),t?e.flush():e.sync()}prepare(e){this.isPreparedStatement=!0,this.hasBeenParsed(e)||e.parse({text:this.text,name:this.name,types:this.types});try{e.bind({portal:this.portal,statement:this.name,values:this.values,binary:this.binary,valueMapper:s.prepareValue})}catch(t){return void this.handleError(t,e)}e.describe({type:"P",name:this.portal||""}),this._getRows(e,this.rows)}handleCopyInResponse(e){e.sendCopyFail("No source stream defined")}handleCopyData(e,t){}};ee(n,"Query");var i=n;t.exports=i}),wt=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.NoticeMessage=e.DataRowMessage=e.CommandCompleteMessage=e.ReadyForQueryMessage=e.NotificationResponseMessage=e.BackendKeyDataMessage=e.AuthenticationMD5Password=e.ParameterStatusMessage=e.ParameterDescriptionMessage=e.RowDescriptionMessage=e.Field=e.CopyResponse=e.CopyDataMessage=e.DatabaseError=e.copyDone=e.emptyQuery=e.replicationStart=e.portalSuspended=e.noData=e.closeComplete=e.bindComplete=e.parseComplete=void 0,e.parseComplete={name:"parseComplete",length:5},e.bindComplete={name:"bindComplete",length:5},e.closeComplete={name:"closeComplete",length:5},e.noData={name:"noData",length:5},e.portalSuspended={name:"portalSuspended",length:5},e.replicationStart={name:"replicationStart",length:4},e.emptyQuery={name:"emptyQuery",length:4},e.copyDone={name:"copyDone",length:4};var t=class extends Error{constructor(e,t,a){super(e),this.length=t,this.name=a}};ee(t,"DatabaseError");var a=t;e.DatabaseError=a;var r=class{constructor(e,t){this.length=e,this.chunk=t,this.name="copyData"}};ee(r,"CopyDataMessage");var s=r;e.CopyDataMessage=s;var n=class{constructor(e,t,a,r){this.length=e,this.name=t,this.binary=a,this.columnTypes=new Array(r)}};ee(n,"CopyResponse");var i=n;e.CopyResponse=i;var o=class{constructor(e,t,a,r,s,n,i){this.name=e,this.tableID=t,this.columnID=a,this.dataTypeID=r,this.dataTypeSize=s,this.dataTypeModifier=n,this.format=i}};ee(o,"Field");var c=o;e.Field=c;var l=class{constructor(e,t){this.length=e,this.fieldCount=t,this.name="rowDescription",this.fields=new Array(this.fieldCount)}};ee(l,"RowDescriptionMessage");var d=l;e.RowDescriptionMessage=d;var u=class{constructor(e,t){this.length=e,this.parameterCount=t,this.name="parameterDescription",this.dataTypeIDs=new Array(this.parameterCount)}};ee(u,"ParameterDescriptionMessage");var m=u;e.ParameterDescriptionMessage=m;var h=class{constructor(e,t,a){this.length=e,this.parameterName=t,this.parameterValue=a,this.name="parameterStatus"}};ee(h,"ParameterStatusMessage");var p=h;e.ParameterStatusMessage=p;var g=class{constructor(e,t){this.length=e,this.salt=t,this.name="authenticationMD5Password"}};ee(g,"AuthenticationMD5Password");var _=g;e.AuthenticationMD5Password=_;var f=class{constructor(e,t,a){this.length=e,this.processID=t,this.secretKey=a,this.name="backendKeyData"}};ee(f,"BackendKeyDataMessage");var y=f;e.BackendKeyDataMessage=y;var v=class{constructor(e,t,a,r){this.length=e,this.processId=t,this.channel=a,this.payload=r,this.name="notification"}};ee(v,"NotificationResponseMessage");var w=v;e.NotificationResponseMessage=w;var b=class{constructor(e,t){this.length=e,this.status=t,this.name="readyForQuery"}};ee(b,"ReadyForQueryMessage");var S=b;e.ReadyForQueryMessage=S;var x=class{constructor(e,t){this.length=e,this.text=t,this.name="commandComplete"}};ee(x,"CommandCompleteMessage");var k=x;e.CommandCompleteMessage=k;var E=class{constructor(e,t){this.length=e,this.fields=t,this.name="dataRow",this.fieldCount=t.length}};ee(E,"DataRowMessage");var I=E;e.DataRowMessage=I;var A=class{constructor(e,t){this.length=e,this.message=t,this.name="notice"}};ee(A,"NoticeMessage");var P=A;e.NoticeMessage=P}),bt=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.Writer=void 0;var t=class{constructor(e=256){this.size=e,this.offset=5,this.headerPosition=0,this.buffer=H.allocUnsafe(e)}ensure(e){if(this.buffer.length-this.offset<e){let t=this.buffer,a=t.length+(t.length>>1)+e;this.buffer=H.allocUnsafe(a),t.copy(this.buffer)}}addInt32(e){return this.ensure(4),this.buffer[this.offset++]=e>>>24&255,this.buffer[this.offset++]=e>>>16&255,this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addInt16(e){return this.ensure(2),this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addCString(e){if(e){let t=H.byteLength(e);this.ensure(t+1),this.buffer.write(e,this.offset,"utf-8"),this.offset+=t}else this.ensure(1);return this.buffer[this.offset++]=0,this}addString(e=""){let t=H.byteLength(e);return this.ensure(t),this.buffer.write(e,this.offset),this.offset+=t,this}add(e){return this.ensure(e.length),e.copy(this.buffer,this.offset),this.offset+=e.length,this}join(e){if(e){this.buffer[this.headerPosition]=e;let t=this.offset-(this.headerPosition+1);this.buffer.writeInt32BE(t,this.headerPosition+1)}return this.buffer.slice(e?0:5,this.offset)}flush(e){let t=this.join(e);return this.offset=5,this.headerPosition=0,this.buffer=H.allocUnsafe(this.size),t}};ee(t,"Writer");var a=t;e.Writer=a}),St=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.serialize=void 0;var t=bt(),a=new t.Writer,r=ee(e=>{a.addInt16(3).addInt16(0);for(let t of Object.keys(e))a.addCString(t).addCString(e[t]);a.addCString("client_encoding").addCString("UTF8");let r=a.addCString("").flush(),s=r.length+4;return(new t.Writer).addInt32(s).add(r).flush()},"startup"),s=ee(()=>{let e=H.allocUnsafe(8);return e.writeInt32BE(8,0),e.writeInt32BE(80877103,4),e},"requestSsl"),n=ee(e=>a.addCString(e).flush(112),"password"),i=ee(function(e,t){return a.addCString(e).addInt32(H.byteLength(t)).addString(t),a.flush(112)},"sendSASLInitialResponseMessage"),o=ee(function(e){return a.addString(e).flush(112)},"sendSCRAMClientFinalMessage"),c=ee(e=>a.addCString(e).flush(81),"query"),l=[],d=ee(e=>{let t=e.name||"";t.length;let r=e.types||l,s=r.length,n=a.addCString(t).addCString(e.text).addInt16(s);for(let a=0;a<s;a++)n.addInt32(r[a]);return a.flush(80)},"parse"),u=new t.Writer,m=ee(function(e,t){for(let r=0;r<e.length;r++){let s=t?t(e[r],r):e[r];null==s?(a.addInt16(0),u.addInt32(-1)):s instanceof H?(a.addInt16(1),u.addInt32(s.length),u.add(s)):(a.addInt16(0),u.addInt32(H.byteLength(s)),u.addString(s))}},"writeValues"),h=ee((e={})=>{let t=e.portal||"",r=e.statement||"",s=e.binary||!1,n=e.values||l,i=n.length;return a.addCString(t).addCString(r),a.addInt16(i),m(n,e.valueMapper),a.addInt16(i),a.add(u.flush()),a.addInt16(s?1:0),a.flush(66)},"bind"),p=H.from([69,0,0,0,9,0,0,0,0,0]),g=ee(e=>{if(!e||!e.portal&&!e.rows)return p;let t=e.portal||"",a=e.rows||0,r=H.byteLength(t),s=4+r+1+4,n=H.allocUnsafe(1+s);return n[0]=69,n.writeInt32BE(s,1),n.write(t,5,"utf-8"),n[r+5]=0,n.writeUInt32BE(a,n.length-4),n},"execute"),_=ee((e,t)=>{let a=H.allocUnsafe(16);return a.writeInt32BE(16,0),a.writeInt16BE(1234,4),a.writeInt16BE(5678,6),a.writeInt32BE(e,8),a.writeInt32BE(t,12),a},"cancel"),f=ee((e,t)=>{let a=4+H.byteLength(t)+1,r=H.allocUnsafe(1+a);return r[0]=e,r.writeInt32BE(a,1),r.write(t,5,"utf-8"),r[a]=0,r},"cstringMessage"),y=a.addCString("P").flush(68),v=a.addCString("S").flush(68),w=ee(e=>e.name?f(68,`${e.type}${e.name||""}`):"P"===e.type?y:v,"describe"),b=ee(e=>{let t=`${e.type}${e.name||""}`;return f(67,t)},"close"),S=ee(e=>a.add(e).flush(100),"copyData"),x=ee(e=>f(102,e),"copyFail"),k=ee(e=>H.from([e,0,0,0,4]),"codeOnlyBuffer"),E=k(72),I=k(83),A=k(88),P=k(99),C={startup:r,password:n,requestSsl:s,sendSASLInitialResponseMessage:i,sendSCRAMClientFinalMessage:o,query:c,parse:d,bind:h,execute:g,describe:w,close:b,flush:ee(()=>E,"flush"),sync:ee(()=>I,"sync"),end:ee(()=>A,"end"),copyData:S,copyDone:ee(()=>P,"copyDone"),copyFail:x,cancel:_};e.serialize=C}),xt=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.BufferReader=void 0;var t=H.allocUnsafe(0),a=class{constructor(e=0){this.offset=e,this.buffer=t,this.encoding="utf-8"}setBuffer(e,t){this.offset=e,this.buffer=t}int16(){let e=this.buffer.readInt16BE(this.offset);return this.offset+=2,e}byte(){let e=this.buffer[this.offset];return this.offset++,e}int32(){let e=this.buffer.readInt32BE(this.offset);return this.offset+=4,e}uint32(){let e=this.buffer.readUInt32BE(this.offset);return this.offset+=4,e}string(e){let t=this.buffer.toString(this.encoding,this.offset,this.offset+e);return this.offset+=e,t}cstring(){let e=this.offset,t=e;for(;0!==this.buffer[t++];);return this.offset=t,this.buffer.toString(this.encoding,e,t-1)}bytes(e){let t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}};ee(a,"BufferReader");var r=a;e.BufferReader=r}),kt=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.Parser=void 0;var t=wt(),a=xt(),r=H.allocUnsafe(0),s=class{constructor(e){if(this.buffer=r,this.bufferLength=0,this.bufferOffset=0,this.reader=new a.BufferReader,"binary"===(null==e?void 0:e.mode))throw new Error("Binary mode not supported yet");this.mode=(null==e?void 0:e.mode)||"text"}parse(e,t){this.mergeBuffer(e);let a=this.bufferOffset+this.bufferLength,s=this.bufferOffset;for(;s+5<=a;){let e=this.buffer[s],r=this.buffer.readUInt32BE(s+1),n=1+r;if(!(n+s<=a))break;t(this.handlePacket(s+5,e,r,this.buffer)),s+=n}s===a?(this.buffer=r,this.bufferLength=0,this.bufferOffset=0):(this.bufferLength=a-s,this.bufferOffset=s)}mergeBuffer(e){if(this.bufferLength>0){let t=this.bufferLength+e.byteLength;if(t+this.bufferOffset>this.buffer.byteLength){let e;if(t<=this.buffer.byteLength&&this.bufferOffset>=this.bufferLength)e=this.buffer;else{let a=2*this.buffer.byteLength;for(;t>=a;)a*=2;e=H.allocUnsafe(a)}this.buffer.copy(e,0,this.bufferOffset,this.bufferOffset+this.bufferLength),this.buffer=e,this.bufferOffset=0}e.copy(this.buffer,this.bufferOffset+this.bufferLength),this.bufferLength=t}else this.buffer=e,this.bufferOffset=0,this.bufferLength=e.byteLength}handlePacket(e,a,r,s){switch(a){case 50:return t.bindComplete;case 49:return t.parseComplete;case 51:return t.closeComplete;case 110:return t.noData;case 115:return t.portalSuspended;case 99:return t.copyDone;case 87:return t.replicationStart;case 73:return t.emptyQuery;case 68:return this.parseDataRowMessage(e,r,s);case 67:return this.parseCommandCompleteMessage(e,r,s);case 90:return this.parseReadyForQueryMessage(e,r,s);case 65:return this.parseNotificationMessage(e,r,s);case 82:return this.parseAuthenticationResponse(e,r,s);case 83:return this.parseParameterStatusMessage(e,r,s);case 75:return this.parseBackendKeyData(e,r,s);case 69:return this.parseErrorMessage(e,r,s,"error");case 78:return this.parseErrorMessage(e,r,s,"notice");case 84:return this.parseRowDescriptionMessage(e,r,s);case 116:return this.parseParameterDescriptionMessage(e,r,s);case 71:return this.parseCopyInMessage(e,r,s);case 72:return this.parseCopyOutMessage(e,r,s);case 100:return this.parseCopyData(e,r,s);default:return new t.DatabaseError("received invalid response: "+a.toString(16),r,"error")}}parseReadyForQueryMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.string(1);return new t.ReadyForQueryMessage(a,s)}parseCommandCompleteMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.cstring();return new t.CommandCompleteMessage(a,s)}parseCopyData(e,a,r){let s=r.slice(e,e+(a-4));return new t.CopyDataMessage(a,s)}parseCopyInMessage(e,t,a){return this.parseCopyMessage(e,t,a,"copyInResponse")}parseCopyOutMessage(e,t,a){return this.parseCopyMessage(e,t,a,"copyOutResponse")}parseCopyMessage(e,a,r,s){this.reader.setBuffer(e,r);let n=0!==this.reader.byte(),i=this.reader.int16(),o=new t.CopyResponse(a,s,n,i);for(let t=0;t<i;t++)o.columnTypes[t]=this.reader.int16();return o}parseNotificationMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int32(),n=this.reader.cstring(),i=this.reader.cstring();return new t.NotificationResponseMessage(a,s,n,i)}parseRowDescriptionMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int16(),n=new t.RowDescriptionMessage(a,s);for(let t=0;t<s;t++)n.fields[t]=this.parseField();return n}parseField(){let e=this.reader.cstring(),a=this.reader.uint32(),r=this.reader.int16(),s=this.reader.uint32(),n=this.reader.int16(),i=this.reader.int32(),o=0===this.reader.int16()?"text":"binary";return new t.Field(e,a,r,s,n,i,o)}parseParameterDescriptionMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int16(),n=new t.ParameterDescriptionMessage(a,s);for(let t=0;t<s;t++)n.dataTypeIDs[t]=this.reader.int32();return n}parseDataRowMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int16(),n=new Array(s);for(let t=0;t<s;t++){let e=this.reader.int32();n[t]=-1===e?null:this.reader.string(e)}return new t.DataRowMessage(a,n)}parseParameterStatusMessage(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.cstring(),n=this.reader.cstring();return new t.ParameterStatusMessage(a,s,n)}parseBackendKeyData(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int32(),n=this.reader.int32();return new t.BackendKeyDataMessage(a,s,n)}parseAuthenticationResponse(e,a,r){this.reader.setBuffer(e,r);let s=this.reader.int32(),n={name:"authenticationOk",length:a};switch(s){case 0:break;case 3:8===n.length&&(n.name="authenticationCleartextPassword");break;case 5:if(12===n.length){n.name="authenticationMD5Password";let e=this.reader.bytes(4);return new t.AuthenticationMD5Password(a,e)}break;case 10:{let e;n.name="authenticationSASL",n.mechanisms=[];do{e=this.reader.cstring(),e&&n.mechanisms.push(e)}while(e)}break;case 11:n.name="authenticationSASLContinue",n.data=this.reader.string(a-8);break;case 12:n.name="authenticationSASLFinal",n.data=this.reader.string(a-8);break;default:throw new Error("Unknown authenticationOk message type "+s)}return n}parseErrorMessage(e,a,r,s){this.reader.setBuffer(e,r);let n={},i=this.reader.string(1);for(;"\0"!==i;)n[i]=this.reader.cstring(),i=this.reader.string(1);let o=n.M,c="notice"===s?new t.NoticeMessage(a,o):new t.DatabaseError(o,a,s);return c.severity=n.S,c.code=n.C,c.detail=n.D,c.hint=n.H,c.position=n.P,c.internalPosition=n.p,c.internalQuery=n.q,c.where=n.W,c.schema=n.s,c.table=n.t,c.column=n.c,c.dataType=n.d,c.constraint=n.n,c.file=n.F,c.line=n.L,c.routine=n.R,c}};ee(s,"Parser");var n=s;e.Parser=n}),Et=ae(e=>{ue(),Object.defineProperty(e,"__esModule",{value:!0}),e.DatabaseError=e.serialize=e.parse=void 0;var t=wt();Object.defineProperty(e,"DatabaseError",{enumerable:!0,get:ee(function(){return t.DatabaseError},"get")});var a=St();Object.defineProperty(e,"serialize",{enumerable:!0,get:ee(function(){return a.serialize},"get")});var r=kt();function s(e,t){let a=new r.Parser;return e.on("data",e=>a.parse(e,t)),new Promise(t=>e.on("end",()=>t()))}ee(s,"parse"),e.parse=s}),It={};function At({socket:e,servername:t}){return e.startTls(t),e}re(It,{connect:()=>At});var Pt=te(()=>{ue(),ee(At,"connect")}),Ct=ae((e,t)=>{ue();var a=(ve(),ie(he)),r=me().EventEmitter,{parse:s,serialize:n}=Et(),i=n.flush(),o=n.sync(),c=n.end(),l=class extends r{constructor(e){super(),e=e||{},this.stream=e.stream||new a.Socket,this._keepAlive=e.keepAlive,this._keepAliveInitialDelayMillis=e.keepAliveInitialDelayMillis,this.lastBuffer=!1,this.parsedStatements={},this.ssl=e.ssl||!1,this._ending=!1,this._emitMessage=!1;var t=this;this.on("newListener",function(e){"message"===e&&(t._emitMessage=!0)})}connect(e,t){var r=this;this._connecting=!0,this.stream.setNoDelay(!0),this.stream.connect(e,t),this.stream.once("connect",function(){r._keepAlive&&r.stream.setKeepAlive(!0,r._keepAliveInitialDelayMillis),r.emit("connect")});let s=ee(function(e){r._ending&&("ECONNRESET"===e.code||"EPIPE"===e.code)||r.emit("error",e)},"reportStreamError");if(this.stream.on("error",s),this.stream.on("close",function(){r.emit("end")}),!this.ssl)return this.attachListeners(this.stream);this.stream.once("data",function(e){switch(e.toString("utf8")){case"S":break;case"N":return r.stream.end(),r.emit("error",new Error("The server does not support SSL connections"));default:return r.stream.end(),r.emit("error",new Error("There was an error establishing an SSL connection"))}var n=(Pt(),ie(It));let i={socket:r.stream};!0!==r.ssl&&(Object.assign(i,r.ssl),"key"in r.ssl&&(i.key=r.ssl.key)),0===a.isIP(t)&&(i.servername=t);try{r.stream=n.connect(i)}catch(o){return r.emit("error",o)}r.attachListeners(r.stream),r.stream.on("error",s),r.emit("sslconnect")})}attachListeners(e){e.on("end",()=>{this.emit("end")}),s(e,e=>{var t="error"===e.name?"errorMessage":e.name;this._emitMessage&&this.emit("message",e),this.emit(t,e)})}requestSsl(){this.stream.write(n.requestSsl())}startup(e){this.stream.write(n.startup(e))}cancel(e,t){this._send(n.cancel(e,t))}password(e){this._send(n.password(e))}sendSASLInitialResponseMessage(e,t){this._send(n.sendSASLInitialResponseMessage(e,t))}sendSCRAMClientFinalMessage(e){this._send(n.sendSCRAMClientFinalMessage(e))}_send(e){return!!this.stream.writable&&this.stream.write(e)}query(e){this._send(n.query(e))}parse(e){this._send(n.parse(e))}bind(e){this._send(n.bind(e))}execute(e){this._send(n.execute(e))}flush(){this.stream.writable&&this.stream.write(i)}sync(){this._ending=!0,this._send(i),this._send(o)}ref(){this.stream.ref()}unref(){this.stream.unref()}end(){if(this._ending=!0,this._connecting&&this.stream.writable)return this.stream.write(c,()=>{this.stream.end()});this.stream.end()}close(e){this._send(n.close(e))}describe(e){this._send(n.describe(e))}sendCopyFromChunk(e){this._send(n.copyData(e))}endCopyFrom(){this._send(n.copyDone())}sendCopyFail(e){this._send(n.copyFail(e))}};ee(l,"Connection");var d=l;t.exports=d}),Tt=ae((e,t)=>{ue();var a=me().EventEmitter;Ke(),ie(Qe);var r=He(),s=Ye(),n=mt(),i=Le(),o=ft(),c=vt(),l=We(),d=Ct(),u=class extends a{constructor(e){super(),this.connectionParameters=new o(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;var t=e||{};this._Promise=t.Promise||V.Promise,this._types=new i(t.types),this._ending=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.connection=t.connection||new d({stream:t.stream,ssl:this.connectionParameters.ssl,keepAlive:t.keepAlive||!1,keepAliveInitialDelayMillis:t.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=t.binary||l.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=t.connectionTimeoutMillis||0}_errorAllQueries(e){let t=ee(t=>{Q.nextTick(()=>{t.handleError(e,this.connection)})},"enqueueError");this.activeQuery&&(t(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(t),this.queryQueue.length=0}_connect(e){var t=this,a=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let t=new Error("Client has already been connected. You cannot reuse a client.");return void Q.nextTick(()=>{e(t)})}this._connecting=!0,this.connectionTimeoutHandle,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{a._ending=!0,a.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis)),this.host&&0===this.host.indexOf("/")?a.connect(this.host+"/.s.PGSQL."+this.port):a.connect(this.port,this.host),a.on("connect",function(){t.ssl?a.requestSsl():a.startup(t.getStartupConf())}),a.on("sslconnect",function(){a.startup(t.getStartupConf())}),this._attachListeners(a),a.once("end",()=>{let e=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(e),this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(e):this._handleErrorEvent(e):this._connectionError||this._handleErrorEvent(e)),Q.nextTick(()=>{this.emit("end")})})}connect(e){if(!e)return new this._Promise((e,t)=>{this._connect(a=>{a?t(a):e()})});this._connect(e)}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let t=this.connection;"function"==typeof this.password?this._Promise.resolve().then(()=>this.password()).then(a=>{if(void 0!==a){if("string"!=typeof a)return void t.emit("error",new TypeError("Password must be a string"));this.connectionParameters.password=this.password=a}else this.connectionParameters.password=this.password=null;e()}).catch(e=>{t.emit("error",e)}):null!==this.password?e():n(this.connectionParameters,t=>{void 0!==t&&(this.connectionParameters.password=this.password=t),e()})}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(()=>{let t=r.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(t)})}_handleAuthSASL(e){this._checkPgPass(()=>{this.saslSession=s.startSession(e.mechanisms),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)})}_handleAuthSASLContinue(e){s.continueSession(this.saslSession,this.password,e.data),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}_handleAuthSASLFinal(e){s.finalizeSession(this.saslSession,e.data),this.saslSession=null}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:t}=this;this.activeQuery=null,this.readyForQuery=!0,t&&t.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let t=this.activeQuery;t?(this.activeQuery=null,t.handleError(e,this.connection)):this._handleErrorEvent(e)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(e){this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){var e=this.connectionParameters,t={user:e.user,database:e.database},a=e.application_name||e.fallback_application_name;return a&&(t.application_name=a),e.replication&&(t.replication=""+e.replication),e.statement_timeout&&(t.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(t.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(t.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(t.options=e.options),t}cancel(e,t){if(e.activeQuery===t){var a=this.connection;this.host&&0===this.host.indexOf("/")?a.connect(this.host+"/.s.PGSQL."+this.port):a.connect(this.port,this.host),a.on("connect",function(){a.cancel(e.processID,e.secretKey)})}else-1!==e.queryQueue.indexOf(t)&&e.queryQueue.splice(e.queryQueue.indexOf(t),1)}setTypeParser(e,t,a){return this._types.setTypeParser(e,t,a)}getTypeParser(e,t){return this._types.getTypeParser(e,t)}escapeIdentifier(e){return'"'+e.replace(/"/g,'""')+'"'}escapeLiteral(e){for(var t=!1,a="'",r=0;r<e.length;r++){var s=e[r];"'"===s?a+=s+s:"\\"===s?(a+=s+s,t=!0):a+=s}return a+="'",!0===t&&(a=" E"+a),a}_pulseQueryQueue(){if(!0===this.readyForQuery)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&Q.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,t,a){var r,s,n,i,o;if(null==e)throw new TypeError("Client was passed a null or undefined query");return"function"==typeof e.submit?(n=e.query_timeout||this.connectionParameters.query_timeout,s=r=e,"function"==typeof t&&(r.callback=r.callback||t)):(n=this.connectionParameters.query_timeout,(r=new c(e,t,a)).callback||(s=new this._Promise((e,t)=>{r.callback=(a,r)=>a?t(a):e(r)}))),n&&(o=r.callback,i=setTimeout(()=>{var e=new Error("Query read timeout");Q.nextTick(()=>{r.handleError(e,this.connection)}),o(e),r.callback=()=>{};var t=this.queryQueue.indexOf(r);t>-1&&this.queryQueue.splice(t,1),this._pulseQueryQueue()},n),r.callback=(e,t)=>{clearTimeout(i),o(e,t)}),this.binary&&!r.binary&&(r.binary=!0),r._result&&!r._result._types&&(r._result._types=this._types),this._queryable?this._ending?(Q.nextTick(()=>{r.handleError(new Error("Client was closed and is not queryable"),this.connection)}),s):(this.queryQueue.push(r),this._pulseQueryQueue(),s):(Q.nextTick(()=>{r.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),s)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting){if(!e)return this._Promise.resolve();e()}if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),!e)return new this._Promise(e=>{this.connection.once("end",e)});this.connection.once("end",e)}};ee(u,"Client");var m=u;m.Query=c,t.exports=m}),jt=ae((e,t)=>{ue();var a=me().EventEmitter,r=ee(function(){},"NOOP"),s=ee((e,t)=>{let a=e.findIndex(t);return-1===a?void 0:e.splice(a,1)[0]},"removeWhere"),n=class{constructor(e,t,a){this.client=e,this.idleListener=t,this.timeoutId=a}};ee(n,"IdleItem");var i=n,o=class{constructor(e){this.callback=e}};ee(o,"PendingItem");var c=o;function l(){throw new Error("Release called on client which has already been released to the pool.")}function d(e,t){if(t)return{callback:t,result:void 0};let a,r;return{callback:ee(function(e,t){e?a(e):r(t)},"cb"),result:new e(function(e,t){r=e,a=t}).catch(e=>{throw Error.captureStackTrace(e),e})}}function u(e,t){return ee(function a(r){r.client=t,t.removeListener("error",a),t.on("error",()=>{e.log("additional client error after disconnection due to error",r)}),e._remove(t),e.emit("error",r,t)},"idleListener")}ee(l,"throwOnDoubleRelease"),ee(d,"promisify"),ee(u,"makeIdleListener");var m=class extends a{constructor(e,t){super(),this.options=Object.assign({},e),null!=e&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),null!=e&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||t||Ut().Client,this.Promise=this.options.Promise||V.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended)return void this.log("pulse queue ended");if(this.ending)return this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(e=>{this._remove(e.client)}),void(this._clients.length||(this.ended=!0,this._endCallback()));if(!this._pendingQueue.length)return void this.log("no queued requests");if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let t=this._idle.pop();clearTimeout(t.timeoutId);let a=t.client;a.ref&&a.ref();let r=t.idleListener;return this._acquireClient(a,e,r,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e){let t=s(this._idle,t=>t.client===e);void 0!==t&&clearTimeout(t.timeoutId),this._clients=this._clients.filter(t=>t!==e),e.end(),this.emit("remove",e)}connect(e){if(this.ending){let t=new Error("Cannot use a pool after calling end on the pool");return e?e(t):this.Promise.reject(t)}let t=d(this.Promise,e),a=t.result;if(this._isFull()||this._idle.length){if(this._idle.length&&Q.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new c(t.callback)),a;let e=ee((e,a,r)=>{clearTimeout(n),t.callback(e,a,r)},"queueCallback"),r=new c(e),n=setTimeout(()=>{s(this._pendingQueue,t=>t.callback===e),r.timedOut=!0,t.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return n.unref&&n.unref(),this._pendingQueue.push(r),a}return this.newClient(new c(t.callback)),a}newClient(e){let t=new this.Client(this.options);this._clients.push(t);let a=u(this,t);this.log("checking client timeout");let s,n=!1;this.options.connectionTimeoutMillis&&(s=setTimeout(()=>{this.log("ending client due to timeout"),n=!0,t.connection?t.connection.stream.destroy():t.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),t.connect(i=>{if(s&&clearTimeout(s),t.on("error",a),!i){if(this.log("new client connected"),0!==this.options.maxLifetimeSeconds){let e=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(t),-1!==this._idle.findIndex(e=>e.client===t)&&this._acquireClient(t,new c((e,t,a)=>a()),a,!1)},1e3*this.options.maxLifetimeSeconds);e.unref(),t.once("end",()=>clearTimeout(e))}return this._acquireClient(t,e,a,!0)}this.log("client failed to connect",i),this._clients=this._clients.filter(e=>e!==t),n&&(i=new Error("Connection terminated due to connection timeout",{cause:i})),this._pulseQueue(),e.timedOut||e.callback(i,void 0,r)})}_acquireClient(e,t,a,s){s&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,a),e.removeListener("error",a),t.timedOut?s&&this.options.verify?this.options.verify(e,e.release):e.release():s&&this.options.verify?this.options.verify(e,a=>{if(a)return e.release(a),t.callback(a,void 0,r);t.callback(void 0,e,e.release)}):t.callback(void 0,e,e.release)}_releaseOnce(e,t){let a=!1;return r=>{a&&l(),a=!0,this._release(e,t,r)}}_release(e,t,a){if(e.on("error",t),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",a,e),a||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e),void this._pulseQueue();if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e),void this._pulseQueue();let r;this.options.idleTimeoutMillis&&this._isAboveMin()&&(r=setTimeout(()=>{this.log("remove idle client"),this._remove(e)},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&r.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new i(e,t,r)),this._pulseQueue()}query(e,t,a){if("function"==typeof e){let t=d(this.Promise,e);return W(function(){return t.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),t.result}"function"==typeof t&&(a=t,t=void 0);let r=d(this.Promise,a);return a=r.callback,this.connect((r,s)=>{if(r)return a(r);let n=!1,i=ee(e=>{n||(n=!0,s.release(e),a(e))},"onError");s.once("error",i),this.log("dispatching query");try{s.query(e,t,(e,t)=>{if(this.log("query dispatched"),s.removeListener("error",i),!n)return n=!0,s.release(e),e?a(e):a(void 0,t)})}catch(o){return s.release(o),a(o)}}),r.result}end(e){if(this.log("ending"),this.ending){let t=new Error("Called end on pool more than once");return e?e(t):this.Promise.reject(t)}this.ending=!0;let t=d(this.Promise,e);return this._endCallback=t.callback,this._pulseQueue(),t.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,t)=>e+(this._expired.has(t)?1:0),0)}get totalCount(){return this._clients.length}};ee(m,"Pool");var h=m;t.exports=h}),Dt={};re(Dt,{default:()=>Rt});var Rt,Lt=te(()=>{ue(),Rt={}}),Ot=ae((e,t)=>{t.exports={name:"pg",version:"8.8.0",description:"PostgreSQL client - pure javascript & libpq with the same API",keywords:["database","libpq","pg","postgre","postgres","postgresql","rdbms"],homepage:"https://github.com/brianc/node-postgres",repository:{type:"git",url:"git://github.com/brianc/node-postgres.git",directory:"packages/pg"},author:"Brian Carlson <brian.m.carlson@gmail.com>",main:"./lib",dependencies:{"buffer-writer":"2.0.0","packet-reader":"1.0.0","pg-connection-string":"^2.5.0","pg-pool":"^3.5.2","pg-protocol":"^1.5.0","pg-types":"^2.1.0",pgpass:"1.x"},devDependencies:{async:"2.6.4",bluebird:"3.5.2",co:"4.6.0","pg-copy-streams":"0.3.0"},peerDependencies:{"pg-native":">=3.0.1"},peerDependenciesMeta:{"pg-native":{optional:!0}},scripts:{test:"make test-all"},files:["lib","SPONSORS.md"],license:"MIT",engines:{node:">= 8.0.0"},gitHead:"c99fb2c127ddf8d712500db2c7b9a5491a178655"}}),qt=ae((e,t)=>{ue();var a=me().EventEmitter,r=(Ke(),ie(Qe)),s=He(),n=t.exports=function(e,t,r){a.call(this),e=s.normalizeQueryConfig(e,t,r),this.text=e.text,this.values=e.values,this.name=e.name,this.callback=e.callback,this.state="new",this._arrayMode="array"===e.rowMode,this._emitRowEvents=!1,this.on("newListener",function(e){"row"===e&&(this._emitRowEvents=!0)}.bind(this))};r.inherits(n,a);var i={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};n.prototype.handleError=function(e){var t=this.native.pq.resultErrorFields();if(t)for(var a in t){e[i[a]||a]=t[a]}this.callback?this.callback(e):this.emit("error",e),this.state="error"},n.prototype.then=function(e,t){return this._getPromise().then(e,t)},n.prototype.catch=function(e){return this._getPromise().catch(e)},n.prototype._getPromise=function(){return this._promise||(this._promise=new Promise(function(e,t){this._once("end",e),this._once("error",t)}.bind(this))),this._promise},n.prototype.submit=function(e){this.state="running";var t=this;this.native=e.native,e.native.arrayMode=this._arrayMode;var a=ee(function(a,r,s){if(e.native.arrayMode=!1,W(function(){t.emit("_done")}),a)return t.handleError(a);t._emitRowEvents&&(s.length>1?r.forEach((e,a)=>{e.forEach(e=>{t.emit("row",e,s[a])})}):r.forEach(function(e){t.emit("row",e,s)})),t.state="end",t.emit("end",s),t.callback&&t.callback(null,s)},"after");if(Q.domain&&(a=Q.domain.bind(a)),this.name){this.name.length;var r=(this.values||[]).map(s.prepareValue);if(e.namedQueries[this.name]){if(this.text&&e.namedQueries[this.name]!==this.text){let e=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return a(e)}return e.native.execute(this.name,r,a)}return e.native.prepare(this.name,this.text,r.length,function(s){return s?a(s):(e.namedQueries[t.name]=t.text,t.native.execute(t.name,r,a))})}if(this.values){if(!Array.isArray(this.values)){let e=new Error("Query values must be an array");return a(e)}var n=this.values.map(s.prepareValue);e.native.query(this.text,n,a)}else e.native.query(this.text,a)}}),Nt=ae((e,t)=>{ue();var a=(Lt(),ie(Dt)),r=Le();Ot();var s=me().EventEmitter,n=(Ke(),ie(Qe)),i=ft(),o=qt(),c=t.exports=function(e){s.call(this),e=e||{},this._Promise=e.Promise||V.Promise,this._types=new r(e.types),this.native=new a({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;var t=this.connectionParameters=new i(e);this.user=t.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:t.password}),this.database=t.database,this.host=t.host,this.port=t.port,this.namedQueries={}};c.Query=o,n.inherits(c,s),c.prototype._errorAllQueries=function(e){let t=ee(t=>{Q.nextTick(()=>{t.native=this.native,t.handleError(e)})},"enqueueError");this._hasActiveQuery()&&(t(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(t),this._queryQueue.length=0},c.prototype._connect=function(e){var t=this;this._connecting?Q.nextTick(()=>e(new Error("Client has already been connected. You cannot reuse a client."))):(this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(a,r){if(a)return e(a);t.native.connect(r,function(a){if(a)return t.native.end(),e(a);t._connected=!0,t.native.on("error",function(e){t._queryable=!1,t._errorAllQueries(e),t.emit("error",e)}),t.native.on("notification",function(e){t.emit("notification",{channel:e.relname,payload:e.extra})}),t.emit("connect"),t._pulseQueryQueue(!0),e()})}))},c.prototype.connect=function(e){if(!e)return new this._Promise((e,t)=>{this._connect(a=>{a?t(a):e()})});this._connect(e)},c.prototype.query=function(e,t,a){var r,s,n,i,c;if(null==e)throw new TypeError("Client was passed a null or undefined query");if("function"==typeof e.submit)n=e.query_timeout||this.connectionParameters.query_timeout,s=r=e,"function"==typeof t&&(e.callback=t);else if(n=this.connectionParameters.query_timeout,!(r=new o(e,t,a)).callback){let e,t;s=new this._Promise((a,r)=>{e=a,t=r}),r.callback=(a,r)=>a?t(a):e(r)}return n&&(c=r.callback,i=setTimeout(()=>{var e=new Error("Query read timeout");Q.nextTick(()=>{r.handleError(e,this.connection)}),c(e),r.callback=()=>{};var t=this._queryQueue.indexOf(r);t>-1&&this._queryQueue.splice(t,1),this._pulseQueryQueue()},n),r.callback=(e,t)=>{clearTimeout(i),c(e,t)}),this._queryable?this._ending?(r.native=this.native,Q.nextTick(()=>{r.handleError(new Error("Client was closed and is not queryable"))}),s):(this._queryQueue.push(r),this._pulseQueryQueue(),s):(r.native=this.native,Q.nextTick(()=>{r.handleError(new Error("Client has encountered a connection error and is not queryable"))}),s)},c.prototype.end=function(e){var t,a=this;return this._ending=!0,this._connected||this.once("connect",this.end.bind(this,e)),e||(t=new this._Promise(function(t,a){e=ee(e=>e?a(e):t(),"cb")})),this.native.end(function(){a._errorAllQueries(new Error("Connection terminated")),Q.nextTick(()=>{a.emit("end"),e&&e()})}),t},c.prototype._hasActiveQuery=function(){return this._activeQuery&&"error"!==this._activeQuery.state&&"end"!==this._activeQuery.state},c.prototype._pulseQueryQueue=function(e){if(this._connected&&!this._hasActiveQuery()){var t=this._queryQueue.shift();if(!t)return void(e||this.emit("drain"));this._activeQuery=t,t.submit(this);var a=this;t.once("_done",function(){a._pulseQueryQueue()})}},c.prototype.cancel=function(e){this._activeQuery===e?this.native.cancel(function(){}):-1!==this._queryQueue.indexOf(e)&&this._queryQueue.splice(this._queryQueue.indexOf(e),1)},c.prototype.ref=function(){},c.prototype.unref=function(){},c.prototype.setTypeParser=function(e,t,a){return this._types.setTypeParser(e,t,a)},c.prototype.getTypeParser=function(e,t){return this._types.getTypeParser(e,t)}}),Mt=ae((e,t)=>{ue(),t.exports=Nt()}),Ut=ae((e,t)=>{ue();var a=Tt(),r=We(),s=Ct(),n=jt(),{DatabaseError:i}=Et(),o=ee(e=>{var t;return ee(t=class extends n{constructor(t){super(t,e)}},"BoundPool"),t},"poolFactory"),c=ee(function(e){this.defaults=r,this.Client=e,this.Query=this.Client.Query,this.Pool=o(this.Client),this._pools=[],this.Connection=s,this.types=Re(),this.DatabaseError=i},"PG");typeof Q.env.NODE_PG_FORCE_NATIVE<"u"?t.exports=new c(Mt()):(t.exports=new c(a),Object.defineProperty(t.exports,"native",{configurable:!0,enumerable:!1,get(){var e=null;try{e=new c(Mt())}catch(a){if("MODULE_NOT_FOUND"!==a.code)throw a}return Object.defineProperty(t.exports,"native",{value:e}),e}}))});ue(),ue(),ve(),Se(),ue();var Bt,$t,Ft=Object.defineProperty,zt=Object.defineProperties,Vt=Object.getOwnPropertyDescriptors,Wt=Object.getOwnPropertySymbols,Ht=Object.prototype.hasOwnProperty,Qt=Object.prototype.propertyIsEnumerable,Gt=ee((e,t,a)=>t in e?Ft(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,"__defNormalProp"),Kt=ee((e,t)=>{for(var a in t||(t={}))Ht.call(t,a)&&Gt(e,a,t[a]);if(Wt)for(var a of Wt(t))Qt.call(t,a)&&Gt(e,a,t[a]);return e},"__spreadValues"),Yt=ee((e,t)=>zt(e,Vt(t)),"__spreadProps"),Jt=2===new Uint8Array(new Uint16Array([258]).buffer)[0],Xt=new TextDecoder,Zt=new TextEncoder,ea=Zt.encode("0123456789abcdef"),ta=Zt.encode("0123456789ABCDEF"),aa=Zt.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/").slice();function ra(e,{alphabet:t,scratchArr:a}={}){if(!Bt)if(Bt=new Uint16Array(256),$t=new Uint16Array(256),Jt)for(let h=0;h<256;h++)Bt[h]=ea[15&h]<<8|ea[h>>>4],$t[h]=ta[15&h]<<8|ta[h>>>4];else for(let h=0;h<256;h++)Bt[h]=ea[15&h]|ea[h>>>4]<<8,$t[h]=ta[15&h]|ta[h>>>4]<<8;e.byteOffset%4!=0&&(e=new Uint8Array(e));let r,s=e.length,n=s>>>1,i=s>>>2,o=a||new Uint16Array(s),c=new Uint32Array(e.buffer,e.byteOffset,i),l=new Uint32Array(o.buffer,o.byteOffset,n),d="upper"===t?$t:Bt,u=0,m=0;if(Jt)for(;u<i;)r=c[u++],l[m++]=d[r>>>8&255]<<16|d[255&r],l[m++]=d[r>>>24]<<16|d[r>>>16&255];else for(;u<i;)r=c[u++],l[m++]=d[r>>>24]<<16|d[r>>>16&255],l[m++]=d[r>>>8&255]<<16|d[255&r];for(u<<=2;u<s;)o[u]=d[e[u++]];return Xt.decode(o.subarray(0,s))}function sa(e,t={}){let a="",r=e.length,s=504e3,n=Math.ceil(r/s),i=new Uint16Array(n>1?s:r);for(let o=0;o<n;o++){let r=o*s,n=r+s;a+=ra(e.subarray(r,n),Yt(Kt({},t),{scratchArr:i}))}return a}function na(e,t={}){return"upper"!==t.alphabet&&"function"==typeof e.toHex?e.toHex():sa(e,t)}aa[62]=45,aa[63]=95,ee(ra,"_toHex"),ee(sa,"_toHexChunked"),ee(na,"toHex"),ue();var ia=class e{constructor(e,t){this.strings=e,this.values=t}toParameterizedQuery(t={query:"",params:[]}){var a;let{strings:r,values:s}=this;for(let n=0,i=r.length;n<i;n++)if(t.query+=r[n],n<s.length){let r=s[n];if(r instanceof la)t.query+=r.sql;else if(r instanceof ba)if(r.queryData instanceof e)r.queryData.toParameterizedQuery(t);else{if(null==(a=r.queryData.params)?void 0:a.length)throw new Error("This query is not composable");t.query+=r.queryData.query}else{let{params:e}=t;e.push(r),t.query+="$"+e.length,(r instanceof H||ArrayBuffer.isView(r))&&(t.query+="::bytea")}}return t}};ee(ia,"SqlTemplate");var oa=ia,ca=class{constructor(e){this.sql=e}};ee(ca,"UnsafeRawSql");var la=ca;function da(){typeof window<"u"&&typeof document<"u"&&typeof console<"u"&&console.warn}ue(),ee(da,"warnIfBrowser"),ve();var ua=ne(Le()),ma=ne(He()),ha=class e extends Error{constructor(t){super(t),oe(this,"name","NeonDbError"),oe(this,"severity"),oe(this,"code"),oe(this,"detail"),oe(this,"hint"),oe(this,"position"),oe(this,"internalPosition"),oe(this,"internalQuery"),oe(this,"where"),oe(this,"schema"),oe(this,"table"),oe(this,"column"),oe(this,"dataType"),oe(this,"constraint"),oe(this,"file"),oe(this,"line"),oe(this,"routine"),oe(this,"sourceError"),"captureStackTrace"in Error&&"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}};ee(ha,"NeonDbError");var pa=ha,ga="transaction() expects an array of queries, or a function returning an array of queries",_a=["severity","code","detail","hint","position","internalPosition","internalQuery","where","schema","table","column","dataType","constraint","file","line","routine"];function fa(e){return e instanceof H?"\\x"+na(e):e}function ya(e){let{query:t,params:a}=e instanceof oa?e.toParameterizedQuery():e;return{query:t,params:a.map(e=>fa((0,ma.prepareValue)(e)))}}function va(e,{arrayMode:t,fullResults:a,fetchOptions:r,isolationLevel:s,readOnly:n,deferrable:i,authToken:o,disableWarningInBrowsers:c}={}){if(!e)throw new Error("No database connection string was provided to `neon()`. Perhaps an environment variable has not been set?");let l;try{l=be(e)}catch{throw new Error("Database connection string provided to `neon()` is not a valid URL. Connection string: "+String(e))}let{protocol:d,username:u,hostname:m,port:h,pathname:p}=l;if("postgres:"!==d&&"postgresql:"!==d||!u||!m||!p)throw new Error("Database connection string format for `neon()` should be: postgresql://user:password@host.tld/dbname?option=value");function g(e,...t){if(!(Array.isArray(e)&&Array.isArray(e.raw)&&Array.isArray(t)))throw new Error('This function can now be called only as a tagged-template function: sql`SELECT ${value}`, not sql("SELECT $1", [value], options). For a conventional function call with value placeholders ($1, $2, etc.), use sql.query("SELECT $1", [value], options).');return new ba(_,new oa(e,t))}async function _(l,d,u){let{fetchEndpoint:p,fetchFunction:g}=ye,_=Array.isArray(l)?{queries:l.map(e=>ya(e))}:ya(l),f=r??{},y=t??!1,v=a??!1,w=s,b=n,S=i;void 0!==u&&(void 0!==u.fetchOptions&&(f={...f,...u.fetchOptions}),void 0!==u.arrayMode&&(y=u.arrayMode),void 0!==u.fullResults&&(v=u.fullResults),void 0!==u.isolationLevel&&(w=u.isolationLevel),void 0!==u.readOnly&&(b=u.readOnly),void 0!==u.deferrable&&(S=u.deferrable)),void 0!==d&&!Array.isArray(d)&&void 0!==d.fetchOptions&&(f={...f,...d.fetchOptions});let x=o;!Array.isArray(d)&&void 0!==(null==d?void 0:d.authToken)&&(x=d.authToken);let k,E="function"==typeof p?p(m,h,{jwtAuth:void 0!==x}):p,I={"Neon-Connection-String":e,"Neon-Raw-Text-Output":"true","Neon-Array-Mode":"true"},A=await xa(x);A&&(I.Authorization=`Bearer ${A}`),Array.isArray(l)&&(void 0!==w&&(I["Neon-Batch-Isolation-Level"]=w),void 0!==b&&(I["Neon-Batch-Read-Only"]=String(b)),void 0!==S&&(I["Neon-Batch-Deferrable"]=String(S))),c||ye.disableWarningInBrowsers||da();try{k=await(g??fetch)(E,{method:"POST",body:JSON.stringify(_),headers:I,...f})}catch(P){let e=new pa(`Error connecting to database: ${P}`);throw e.sourceError=P,e}if(k.ok){let e=await k.json();if(Array.isArray(l)){let t=e.results;if(!Array.isArray(t))throw new pa("Neon internal error: unexpected result format");return t.map((e,t)=>{let a=d[t]??{};return Sa(e,{arrayMode:a.arrayMode??y,fullResults:a.fullResults??v,types:a.types})})}{let t=d??{};return Sa(e,{arrayMode:t.arrayMode??y,fullResults:t.fullResults??v,types:t.types})}}{let{status:e}=k;if(400===e){let e=await k.json(),t=new pa(e.message);for(let a of _a)t[a]=e[a]??void 0;throw t}{let t=await k.text();throw new pa(`Server error (HTTP status ${e}): ${t}`)}}}return ee(g,"templateFn"),g.query=(e,t,a)=>new ba(_,{query:e,params:t??[]},a),g.unsafe=e=>new la(e),g.transaction=async(e,t)=>{if("function"==typeof e&&(e=e(g)),!Array.isArray(e))throw new Error(ga);return e.forEach(e=>{if(!(e instanceof ba))throw new Error(ga)}),_(e.map(e=>e.queryData),e.map(e=>e.opts??{}),t)},ee(_,"execute"),g}ee(fa,"encodeBuffersAsBytea"),ee(ya,"prepareQuery"),ee(va,"neon");var wa=class{constructor(e,t,a){this.execute=e,this.queryData=t,this.opts=a}then(e,t){return this.execute(this.queryData,this.opts).then(e,t)}catch(e){return this.execute(this.queryData,this.opts).catch(e)}finally(e){return this.execute(this.queryData,this.opts).finally(e)}};ee(wa,"NeonQueryPromise");var ba=wa;function Sa(e,{arrayMode:t,fullResults:a,types:r}){let s=new ua.default(r),n=e.fields.map(e=>e.name),i=e.fields.map(e=>s.getTypeParser(e.dataTypeID)),o=!0===t?e.rows.map(e=>e.map((e,t)=>null===e?null:i[t](e))):e.rows.map(e=>Object.fromEntries(e.map((e,t)=>[n[t],null===e?null:i[t](e)])));return a?(e.viaNeonFetch=!0,e.rowAsArray=t,e.rows=o,e._parsers=i,e._types=s,e):o}async function xa(e){if("string"==typeof e)return e;if("function"==typeof e)try{return await Promise.resolve(e())}catch(t){let e=new pa("Error getting auth token.");throw t instanceof Error&&(e=new pa(`Error getting auth token: ${t.message}`)),e}}ee(Sa,"processQueryResult"),ee(xa,"getAuthToken"),ue();var ka=ne(Ut());ue();var Ea=ne(Ut()),Ia=class extends Ea.Client{constructor(e){super(e),this.config=e}get neonConfig(){return this.connection.stream}connect(e){var t,a;let{neonConfig:r}=this;r.forceDisablePgSSL&&(this.ssl=this.connection.ssl=!1),this.ssl&&r.useSecureWebSocket;let s="string"!=typeof this.config&&void 0!==(null==(t=this.config)?void 0:t.host)||"string"!=typeof this.config&&void 0!==(null==(a=this.config)?void 0:a.connectionString)||void 0!==Q.env.PGHOST,n=Q.env.USER??Q.env.USERNAME;if(!s&&"localhost"===this.host&&this.user===n&&this.database===n&&null===this.password)throw new Error(`No database host or connection string was set, and key parameters have default values (host: localhost, user: ${n}, db: ${n}, password: null). Is an environment variable missing? Alternatively, if you intended to connect with these parameters, please set the host to 'localhost' explicitly.`);let i=super.connect(e),o=r.pipelineTLS&&this.ssl,c="password"===r.pipelineConnect;if(!o&&!r.pipelineConnect)return i;let l=this.connection;if(o&&l.on("connect",()=>l.stream.emit("data","S")),c){l.removeAllListeners("authenticationCleartextPassword"),l.removeAllListeners("readyForQuery"),l.once("readyForQuery",()=>l.on("readyForQuery",this._handleReadyForQuery.bind(this)));let e=this.ssl?"sslconnect":"connect";l.on(e,()=>{this.neonConfig.disableWarningInBrowsers||da(),this._handleAuthCleartextPassword(),this._handleReadyForQuery()})}return i}async _handleAuthSASLContinue(e){if(typeof crypto>"u"||void 0===crypto.subtle||void 0===crypto.subtle.importKey)throw new Error("Cannot use SASL auth when `crypto.subtle` is not defined");let t=crypto.subtle,a=this.saslSession,r=this.password,s=e.data;if("SASLInitialResponse"!==a.message||"string"!=typeof r||"string"!=typeof s)throw new Error("SASL: protocol error");let n=Object.fromEntries(s.split(",").map(e=>{if(!/^.=/.test(e))throw new Error("SASL: Invalid attribute pair entry");return[e[0],e.substring(2)]})),i=n.r,o=n.s,c=n.i;if(!i||!/^[!-+--~]+$/.test(i))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing/unprintable");if(!o||!/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(o))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing/not base64");if(!c||!/^[1-9][0-9]*$/.test(c))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: missing/invalid iteration count");if(!i.startsWith(a.clientNonce))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");if(i.length===a.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short");let l=parseInt(c,10),d=H.from(o,"base64"),u=new TextEncoder,m=u.encode(r),h=await t.importKey("raw",m,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),p=new Uint8Array(await t.sign("HMAC",h,H.concat([d,H.from([0,0,0,1])]))),g=p;for(var _=0;_<l-1;_++)p=new Uint8Array(await t.sign("HMAC",h,p)),g=H.from(g.map((e,t)=>g[t]^p[t]));let f=g,y=await t.importKey("raw",f,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),v=new Uint8Array(await t.sign("HMAC",y,u.encode("Client Key"))),w=await t.digest("SHA-256",v),b="c=biws,r="+i,S="n=*,r="+a.clientNonce+","+("r="+i+",s="+o+",i="+l)+","+b,x=await t.importKey("raw",w,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);var k=new Uint8Array(await t.sign("HMAC",x,u.encode(S))),E=H.from(v.map((e,t)=>v[t]^k[t])).toString("base64");let I=await t.importKey("raw",f,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),A=await t.sign("HMAC",I,u.encode("Server Key")),P=await t.importKey("raw",A,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);var C=H.from(await t.sign("HMAC",P,u.encode(S)));a.message="SASLResponse",a.serverSignature=C.toString("base64"),a.response=b+",p="+E,this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}};ee(Ia,"NeonClient");var Aa=Ia;ve();var Pa=ne(ft());function Ca(e,t){if(t)return{callback:t,result:void 0};let a,r;return{callback:ee(function(e,t){e?a(e):r(t)},"cb"),result:new e(function(e,t){r=e,a=t})}}ee(Ca,"promisify");var Ta=class extends ka.Pool{constructor(){super(...arguments),oe(this,"Client",Aa),oe(this,"hasFetchUnsupportedListeners",!1),oe(this,"addListener",this.on)}on(e,t){return"error"!==e&&(this.hasFetchUnsupportedListeners=!0),super.on(e,t)}query(e,t,a){var r;if(!ye.poolQueryViaFetch||this.hasFetchUnsupportedListeners||"function"==typeof e)return super.query(e,t,a);"function"==typeof t&&(a=t,t=void 0);let s=Ca(this.Promise,a);a=s.callback;try{let s=new Pa.default(this.options),n=encodeURIComponent,i=encodeURI,o=`postgresql://${n(s.user)}:${n(s.password)}@${n(s.host)}/${i(s.database)}`,c="string"==typeof e?e:e.text,l=t??e.values??[];va(o,{fullResults:!0,arrayMode:"array"===e.rowMode}).query(c,l,{types:e.types??(null==(r=this.options)?void 0:r.types)}).then(e=>a(void 0,e)).catch(e=>a(e))}catch(n){a(n)}return s.result}};ee(Ta,"NeonPool");var ja=Ta;ve();var Da=ne(Ut());Da.DatabaseError,Da.defaults,Da.escapeIdentifier,Da.escapeLiteral,Da.types,ye.wsProxy=e=>`${e}:443/v2`,ye.useSecureWebSocket=!0,ye.pipelineConnect=!1,ye.disableWarningInBrowsers=!0;let Ra,La;if("undefined"!=typeof window){const e=console.error;console.error=(...t)=>{const a=t.join(" ");a.includes("@neondatabase/serverless")&&a.includes("Unhandled error")||e.apply(console,t)}}try{La=new ja({connectionString:"postgresql://neondb_owner:npg_vABqUKk73tEW@ep-young-firefly-adlvuhdv-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"}),Ra=async(e,...t)=>{let a=e[0];for(let r=0;r<t.length;r++){const s=t[r];let n;n=null==s?"NULL":"string"==typeof s?`'${s.replace(/'/g,"''")}'`:"boolean"==typeof s?s?"TRUE":"FALSE":s instanceof Date?`'${s.toISOString()}'`:Array.isArray(s)?`ARRAY[${s.map(e=>`'${String(e).replace(/'/g,"''")}'`).join(",")}]`:"object"==typeof s?`'${JSON.stringify(s).replace(/'/g,"''")}'::jsonb`:String(s),a+=n+e[r+1]}return(await La.query(a)).rows}}catch(iu){throw iu}const Oa=e=>{if(!e)return"Unknown error";if(e instanceof Event)return`Connection error: ${e.type||"Unknown event"}`;if(e instanceof Error)return e.message||"Unknown error";if("object"==typeof e&&e.message)return String(e.message);if("string"==typeof e)return e;try{const t=JSON.stringify(e);if(t&&"{}"!==t)return t}catch(t){}return"Unknown error occurred"},qa=e=>{var t,a,r;if(e instanceof Event)return!0;const s=(null==(t=null==e?void 0:e.message)?void 0:t.toLowerCase())||"",n=(null==(a=null==e?void 0:e.name)?void 0:a.toLowerCase())||"",i=(null==(r=null==e?void 0:e.type)?void 0:r.toLowerCase())||"";return s.includes("network")||s.includes("err_network_changed")||s.includes("err_name_not_resolved")||s.includes("err_internet_disconnected")||s.includes("err_connection_closed")||s.includes("err_connection_refused")||s.includes("err_connection_reset")||s.includes("failed to fetch")||s.includes("network request failed")||s.includes("websocket")||s.includes("connection lost")||i.includes("error")||n.includes("networkerror")||n.includes("typeerror")&&s.includes("fetch")},Na=async(e,t=[],a=!1,r=0)=>{try{return(await La.query(e)).rows||[]}catch(iu){const n=Oa(iu).includes("400")||400===(null==iu?void 0:iu.status)||400===(null==iu?void 0:iu.statusCode),i=qa(iu);if(n&&r<5||i&&r<5){if(i&&!a){Oa(iu)}0;const n=i?1600:800;return await new Promise(e=>setTimeout(e,n*(r+1))),Na(e,t,a,r+1)}if(!a){Oa(iu),null==iu||iu.code}throw iu}};class Ma{constructor(e){this.selectFields="*",this.whereConditions=[],this.orderByClause="",this.limitClause="",this.rangeClause=null,this.suppressErrors=!1,this.countMode=null,this.headMode=!1,this.joins=[],this.tableName=e}select(e="*",t){if((null==t?void 0:t.count)&&(this.countMode=t.count),(null==t?void 0:t.head)&&(this.headMode=!0),e.includes("(")&&e.includes(")")){const t=[];let a=e;const r=/(\w+):(\w+)!(\w+)\s*\(([^)]*(?:\([^)]*\))?[^)]*)\)/g;let s;for(;null!==(s=r.exec(a));){const[e,n,i,o,c]=s,l=c.split(",").map(e=>e.trim()).filter(e=>e&&e.length>0&&!e.includes(":")&&!e.includes("(")&&"undefined"!==e);t.push({alias:n,table:i,foreignKey:o,columns:l}),a=a.replace(e,""),r.lastIndex=0}const n=/(\w+):(\w+)\s*\(([^)]*(?:\([^)]*\))?[^)]*)\)/g;for(;null!==(s=n.exec(a));){const[e,r,i,o]=s;if(t.some(e=>e.alias===r&&e.table===i)){n.lastIndex=0;continue}let c=`${r}_id`;if(["variants","items","details","lines"].some(e=>r.includes(e)||i.includes(`_${e}`))){const e=/^(.+)_(variants|items|details|lines)$/,t=i.match(e);if(t){const e=t[1].split("_");c=`${e[e.length-1]}_id`}}const l=o.split(",").map(e=>e.trim()).filter(e=>e&&e.length>0&&!e.includes(":")&&!e.includes("(")&&"undefined"!==e);t.push({alias:r,table:i,foreignKey:c,columns:l}),a=a.replace(e,""),n.lastIndex=0}const i=/(\w+)\s*\(([^)]*)\)/g;for(;null!==(s=i.exec(a));){const[e,r,n]=s;if(t.some(e=>e.alias===r)){i.lastIndex=0;continue}const o=r,c=r;let l=`${r}_id`;if(r.endsWith("s")&&r.length>1){l=`${r.slice(0,-1)}_id`}const d=n.split(",").map(e=>e.trim()).filter(e=>e&&e.length>0&&!e.includes(":")&&!e.includes("(")&&"undefined"!==e);t.push({alias:o,table:c,foreignKey:l,columns:d}),a=a.replace(e,""),i.lastIndex=0}if(a=a.replace(/,\s*,/g,",").replace(/,\s*$/,"").replace(/^\s*,/,"").trim(),this.joins=t.map(e=>({table:e.table,alias:e.alias,on:e.foreignKey,columns:e.columns.filter(e=>e&&"string"==typeof e&&e.length>0&&"undefined"!==e)})),a&&"*"!==a&&a.length>0){const e=a.split(",").map(e=>e.trim()).filter(e=>e);this.selectFields=e.map(e=>"*"===e?`${this.tableName}.*`:`${this.tableName}.${e} as ${e}`).join(", ")}else this.selectFields=`${this.tableName}.*`;for(const e of this.joins){const t=e.columns.filter(e=>e&&"string"==typeof e&&e.length>0&&"undefined"!==e);if(t.length>0){const a=t.map(t=>`'${t}', ${e.alias}.${t}`).join(", ");this.selectFields+=`, json_build_object(${a}) as ${e.alias}`}else this.selectFields+=`, row_to_json(${e.alias}.*) as ${e.alias}`}}else this.selectFields=e;return this}qualifyColumn(e){return this.joins.length>0&&!e.includes(".")?`${this.tableName}.${e}`:e}eq(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} = ${this.formatValue(t)}`),this}neq(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} != ${this.formatValue(t)}`),this}gt(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} > ${this.formatValue(t)}`),this}gte(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} >= ${this.formatValue(t)}`),this}lt(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} < ${this.formatValue(t)}`),this}lte(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} <= ${this.formatValue(t)}`),this}like(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} LIKE ${this.formatValue(t)}`),this}ilike(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} ILIKE ${this.formatValue(t)}`),this}is(e,t){return null===t?this.whereConditions.push(`${this.qualifyColumn(e)} IS NULL`):this.whereConditions.push(`${this.qualifyColumn(e)} = ${this.formatValue(t)}`),this}in(e,t){if(!t||0===t.length)return this.whereConditions.push("1 = 0"),this;const a=t.map(e=>this.formatValue(e)).join(", ");return this.whereConditions.push(`${this.qualifyColumn(e)} IN (${a})`),this}order(e,t){const a=!1===(null==t?void 0:t.ascending)?"DESC":"ASC",r=this.joins.length>0&&!e.includes(".")?`${this.tableName}.${e}`:e;return this.orderByClause=`ORDER BY ${r} ${a}`,this}limit(e){return this.limitClause=`LIMIT ${e}`,this}range(e,t){return this.rangeClause={from:e,to:t},this}single(){return this.limitClause="LIMIT 1",this.then(e=>e.data&&e.data.length>0?{data:e.data[0],error:null}:{data:null,error:null})}maybeSingle(){return this.single()}formatValue(e){return null==e?"NULL":"string"==typeof e?`'${e.replace(/'/g,"''")}'`:"boolean"==typeof e?e?"TRUE":"FALSE":e instanceof Date?`'${e.toISOString()}'`:Array.isArray(e)?0===e.length||"string"==typeof e[0]?(e.map(e=>`"${String(e).replace(/"/g,'\\"')}"`).join(","),`ARRAY[${e.map(e=>`'${String(e).replace(/'/g,"''")}'`).join(",")}]`):`'${JSON.stringify(e).replace(/'/g,"''")}'::jsonb`:"object"==typeof e?`'${JSON.stringify(e).replace(/'/g,"''")}'::jsonb`:String(e)}buildQuery(){if(this.headMode&&this.countMode){let e=`SELECT COUNT(*) as count FROM ${this.tableName}`;return this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),e}let e=`SELECT ${this.selectFields} FROM ${this.tableName}`;for(const t of this.joins)t.on.endsWith("_id")?e+=` LEFT JOIN ${t.table} AS ${t.alias} ON ${this.tableName}.${t.on} = ${t.alias}.id`:e+=` LEFT JOIN ${t.table} AS ${t.alias} ON ${this.tableName}.id = ${t.alias}.${t.on}`;if(this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),this.orderByClause&&(e+=` ${this.orderByClause}`),this.rangeClause){const t=this.rangeClause.from;e+=` LIMIT ${this.rangeClause.to-this.rangeClause.from+1} OFFSET ${t}`}else this.limitClause&&(e+=` ${this.limitClause}`);return this.joins.length,e}then(e,t){return this.execute().then(e,t)}async execute(){let e;this.isInsert;if(this.isUpsert){const t=this.upsertData,a=this.upsertOptions;if(Array.isArray(t)){if(0===t.length)return{data:[],error:null};const r=new Set;t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{void 0!==t&&r.add(e)})});const s=Array.from(r),n=s.join(", "),i=t.map(e=>`(${s.map(t=>{const a=e[t];return void 0!==a?this.formatValue(a):"NULL"}).join(", ")})`).join(", "),o=(null==a?void 0:a.onConflict)||s.join(","),c=s.map(e=>`${e} = EXCLUDED.${e}`).join(", ");e=`INSERT INTO ${this.tableName} (${n}) VALUES ${i} ON CONFLICT (${o}) DO UPDATE SET ${c} RETURNING *`}else{const r=Object.fromEntries(Object.entries(t).filter(([e,t])=>void 0!==t)),s=Object.keys(r).join(", "),n=Object.values(r).map(e=>this.formatValue(e)).join(", "),i=(null==a?void 0:a.onConflict)||Object.keys(r)[0],o=Object.entries(r).map(([e,t])=>`${e} = ${this.formatValue(t)}`).join(", ");e=`INSERT INTO ${this.tableName} (${s}) VALUES (${n}) ON CONFLICT (${i}) DO UPDATE SET ${o} RETURNING *`}}else if(this.isInsert){const t=this.insertData;if(Array.isArray(t)){if(0===t.length)return{data:[],error:null};const a=new Set;t.forEach(e=>{Object.entries(e).forEach(([e,t])=>{void 0!==t&&a.add(e)})});const r=Array.from(a),s=r.join(", "),n=t.map(e=>`(${r.map(t=>{const a=e[t];return void 0!==a?this.formatValue(a):"NULL"}).join(", ")})`).join(", ");e=`INSERT INTO ${this.tableName} (${s}) VALUES ${n} RETURNING *`}else{const a=Object.fromEntries(Object.entries(t).filter(([e,t])=>void 0!==t)),r=Object.keys(a).join(", "),s=Object.values(a).map(e=>this.formatValue(e)).join(", ");e=`INSERT INTO ${this.tableName} (${r}) VALUES (${s}) RETURNING *`}}else if(this.isUpdate){const t=this.updateData,a=Object.entries(t).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e} = ${this.formatValue(t)}`).join(", ");e=`UPDATE ${this.tableName} SET ${a}`,this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),e+=" RETURNING *"}else this.isDelete?(e=`DELETE FROM ${this.tableName}`,this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),e+=" RETURNING *"):e=this.buildQuery();try{this.suppressErrors,0;let t=await Na(e,[],this.suppressErrors);0;let a=null;return this.headMode&&this.countMode&&t&&t.length>0&&(a=parseInt(t[0].count,10),t=null),{data:t,error:null,count:a}}catch(iu){const t=Oa(iu),a=(null==iu?void 0:iu.code)||"";t.includes("does not exist")||t.includes("relation")||"42P01"===a||t.includes("column"),t.includes("400")||400===(null==iu?void 0:iu.status)||(null==iu||iu.statusCode);return this.suppressErrors,{data:null,error:{message:t,code:a||"400"},count:null}}}catch(e){return this.then(void 0,e)}insert(e){return this.insertData=e,this.isInsert=!0,this}update(e){return this.updateData=e,this.isUpdate=!0,this}delete(){return this.isDelete=!0,this}upsert(e,t){return this.upsertData=e,this.upsertOptions=t,this.isUpsert=!0,this}match(e){return Object.entries(e).forEach(([e,t])=>{this.eq(e,t)}),this}not(e,t,a){return this.whereConditions.push(`NOT (${e} ${t} ${this.formatValue(a)})`),this}or(e){const t=e.split(",").map(e=>{const t=e.trim().match(/^(\w+)\.(eq|neq|gt|gte|lt|lte|like|ilike|is)\.(.+)$/);if(t){const[,e,a,r]=t;let s="=";switch(a){case"eq":s="=";break;case"neq":s="!=";break;case"gt":s=">";break;case"gte":s=">=";break;case"lt":s="<";break;case"lte":s="<=";break;case"like":s="LIKE";break;case"ilike":s="ILIKE";break;case"is":s="IS"}return"is"===a&&"null"===r.toLowerCase()?`${e} IS NULL`:`${e} ${s} ${this.formatValue(r)}`}return e.trim()});return this.whereConditions.push(`(${t.join(" OR ")})`),this}filter(e,t,a){return this.whereConditions.push(`${e} ${t} ${this.formatValue(a)}`),this}contains(e,t){return this.whereConditions.push(`${e} @> ${this.formatValue(t)}`),this}containedBy(e,t){return this.whereConditions.push(`${e} <@ ${this.formatValue(t)}`),this}rangeGt(e,t){return this.whereConditions.push(`${e} >> ${this.formatValue(t)}`),this}rangeGte(e,t){return this.whereConditions.push(`${e} >>= ${this.formatValue(t)}`),this}rangeLt(e,t){return this.whereConditions.push(`${e} << ${this.formatValue(t)}`),this}rangeLte(e,t){return this.whereConditions.push(`${e} <<= ${this.formatValue(t)}`),this}rangeAdjacent(e,t){return this.whereConditions.push(`${e} -|- ${this.formatValue(t)}`),this}overlaps(e,t){return this.whereConditions.push(`${e} && ${this.formatValue(t)}`),this}textSearch(e,t){return this.whereConditions.push(`to_tsvector(${e}) @@ plainto_tsquery(${this.formatValue(t)})`),this}csv(){return this}}const Ua={signInWithPassword:async({email:e,password:t})=>{try{const a=e.replace(/'/g,"''"),r=`\n        SELECT id, email, full_name, role, is_active, created_at, updated_at \n        FROM users \n        WHERE email = '${a}'\n        AND password = '${t.replace(/'/g,"''")}'\n        AND is_active = true\n        LIMIT 1\n      `,s=(await La.query(r)).rows;if(s&&Array.isArray(s)&&s.length>0){const e=s[0],t={access_token:btoa(JSON.stringify({userId:e.id,email:e.email})),refresh_token:btoa(JSON.stringify({userId:e.id})),expires_at:Date.now()+36e5,user:e};return localStorage.setItem("supabase.auth.session",JSON.stringify(t)),{data:{user:e,session:t},error:null}}return{data:{user:null,session:null},error:{message:"Invalid login credentials"}}}catch(iu){return{data:{user:null,session:null},error:{message:iu.message}}}},signIn:async e=>Ua.signInWithPassword(e),signUp:async({email:e,password:t,options:a})=>{try{const r=(null==a?void 0:a.data)||{},s=r.full_name||"",n=r.role||"customer-care",i=e.replace(/'/g,"''"),o=t.replace(/'/g,"''"),c=s.replace(/'/g,"''"),l=`\n        INSERT INTO users (email, password, full_name, role, is_active, created_at, updated_at)\n        VALUES ('${i}', '${o}', '${c}', '${n.replace(/'/g,"''")}', true, NOW(), NOW())\n        RETURNING id, email, full_name, role, is_active, created_at, updated_at\n      `,d=await La.query(l);return d.rows&&d.rows.length>0?{data:{user:d.rows[0]},error:null}:{data:null,error:{message:"Failed to create user"}}}catch(iu){return{data:null,error:{message:iu.message}}}},signOut:async()=>(localStorage.removeItem("supabase.auth.session"),{error:null}),getSession:async()=>{try{const e=localStorage.getItem("supabase.auth.session");if(e){const t=JSON.parse(e);if(t.expires_at>Date.now())return{data:{session:t},error:null}}return{data:{session:null},error:null}}catch(iu){return{data:{session:null},error:null}}},getUser:async()=>{try{const e=localStorage.getItem("supabase.auth.session");if(e){const t=JSON.parse(e);if(t.expires_at>Date.now())return{data:{user:t.user},error:null}}return{data:{user:null},error:null}}catch(iu){return{data:{user:null},error:null}}},onAuthStateChange:e=>(Ua.getSession().then(({data:t})=>{t.session?e("SIGNED_IN",t.session):e("SIGNED_OUT",null)}),{data:{subscription:{unsubscribe:()=>{}}}}),updateUser:async e=>{try{const t=localStorage.getItem("supabase.auth.session");if(!t)return{data:null,error:{message:"Not authenticated"}};const a=JSON.parse(t),r=a.user.id,s=`\n        UPDATE users \n        SET ${Object.entries(e).map(([e,t])=>"string"==typeof t?`${e} = '${t.replace(/'/g,"''")}'`:`${e} = ${t}`).join(", ")}, updated_at = NOW()\n        WHERE id = '${r}'\n        RETURNING id, email, full_name, role, is_active, created_at, updated_at\n      `,n=await Na(s);return n&&n.length>0?(a.user=n[0],localStorage.setItem("supabase.auth.session",JSON.stringify(a)),{data:{user:n[0]},error:null}):{data:null,error:{message:"Failed to update user"}}}catch(iu){return{data:null,error:{message:iu.message}}}},setSession:async e=>(e&&localStorage.setItem("supabase.auth.session",JSON.stringify(e)),{data:{session:e},error:null}),refreshSession:async()=>{const{data:e}=await Ua.getSession();return e.session?(e.session.expires_at=Date.now()+36e5,localStorage.setItem("supabase.auth.session",JSON.stringify(e.session)),{data:e,error:null}):{data:{session:null,user:null},error:{message:"No session to refresh"}}}},Ba=()=>({on:()=>Ba(),subscribe:()=>Ba(),unsubscribe:()=>Promise.resolve()}),$a={from:e=>new Ma(e),auth:Ua,storage:{from:()=>({upload:()=>Promise.resolve({data:null,error:null}),download:()=>Promise.resolve({data:null,error:null}),list:()=>Promise.resolve({data:[],error:null}),remove:()=>Promise.resolve({data:null,error:null}),createSignedUrl:()=>Promise.resolve({data:null,error:null}),getPublicUrl:()=>({data:{publicUrl:""}})})},rpc:async(e,t)=>{try{const a=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e),r=`SELECT * FROM ${e}(${t?Object.entries(t).map(([e,t])=>{if(null===t)return"NULL";if("boolean"==typeof t)return t?"TRUE":"FALSE";if("number"==typeof t)return String(t);if("string"==typeof t){const r=t.replace(/'/g,"''");return(e.endsWith("_id")||e.endsWith("_id_param"))&&a(t)?`'${r}'::uuid`:`'${r}'::text`}return String(t)}).join(", "):""})`;return{data:await Na(r,[],!1),error:null}}catch(iu){return{data:null,error:{message:Oa(iu),code:(null==iu?void 0:iu.code)||"400"}}}},channel:Ba};async function Fa(e,t=3,a=1e3){let r;for(let s=0;s<t;s++)try{return await e()}catch(iu){if(r=iu,iu&&"object"==typeof iu){const t=Oa(iu);if(t.includes("401")||t.includes("403")||t.includes("Invalid")||t.includes("not found"))throw iu;qa(iu)}if(s===t-1)throw r;const n=(qa(r)?2*a:a)*Math.pow(2,s),i=.3*Math.random()*n,o=Math.round(n+i);await new Promise(e=>setTimeout(e,o))}throw r}const za=Object.freeze(Object.defineProperty({__proto__:null,default:$a,get pool(){return La},retryWithBackoff:Fa,get sql(){return Ra},supabase:$a,testSupabaseConnection:async function(){try{const e=await La.query("SELECT 1 as test");return e.rows&&e.rows.length>0?{success:!0,message:"Database connection successful",details:{connected:!0}}:{success:!1,message:"Database query returned no results",details:{connected:!1}}}catch(iu){return{success:!1,message:`Database connection failed: ${iu.message}`,details:{error:iu.message}}}}},Symbol.toStringTag,{value:"Module"}));const Va=new class{constructor(){this.cachedInfo=null,this.cacheTimestamp=0,this.CACHE_DURATION=3e5}async getBusinessInfo(){const e=Date.now();if(this.cachedInfo&&e-this.cacheTimestamp<this.CACHE_DURATION)return this.cachedInfo;try{const{data:t,error:a}=await $a.from("lats_pos_general_settings").select("business_name, business_address, business_phone, business_email, business_website, business_logo").limit(1).single();if(!a&&t)return this.cachedInfo={name:t.business_name||"inauzwa",address:t.business_address||"Dar es Salaam, Tanzania",phone:t.business_phone||"+255 123 456 789",email:t.business_email||void 0,website:t.business_website||void 0,logo:t.business_logo||null},this.cacheTimestamp=e,this.cachedInfo}catch(t){}return{name:"inauzwa",address:"Dar es Salaam, Tanzania",phone:"+255 123 456 789",email:"info@mystore.com",website:void 0,logo:null}}clearCache(){this.cachedInfo=null,this.cacheTimestamp=0}async updateBusinessInfo(e){try{const t={business_name:e.name,business_address:e.address,business_phone:e.phone,business_email:e.email,business_website:e.website,business_logo:e.logo},{data:a}=await $a.from("lats_pos_general_settings").select("id").limit(1).single();if(!a)return!1;const{error:r}=await $a.from("lats_pos_general_settings").update(t).eq("id",a.id);if(r)throw r;return this.clearCache(),!0}catch(t){return!1}}},Wa=Object.freeze(Object.defineProperty({__proto__:null,businessInfoService:Va},Symbol.toStringTag,{value:"Module"})),Ha={general:"lats_pos_general_settings",pricing:"lats_pos_dynamic_pricing_settings",receipt:"lats_pos_receipt_settings",scanner:"lats_pos_barcode_scanner_settings",delivery:"lats_pos_delivery_settings",search:"lats_pos_search_filter_settings",permissions:"lats_pos_user_permissions_settings",loyalty:"lats_pos_loyalty_customer_settings",analytics:"lats_pos_analytics_reporting_settings",notifications:"lats_pos_notification_settings",advanced:"lats_pos_advanced_settings"};let Qa=null;let Ga=null;class Ka{static async getCurrentUser(){if(Qa&&Date.now()-Qa.timestamp<6e5)return Qa.user;if(Ga)return await Ga;Ga=this.performAuthRefresh();try{return await Ga}finally{Ga=null}}static async performAuthRefresh(){try{const{data:{session:e},error:t}=await $a.auth.getSession();if(t||!e)throw new Error("No active session");const{data:{user:a},error:r}=await $a.auth.getUser();if(r||!a)throw new Error("User not authenticated");return Qa={user:a,timestamp:Date.now()},a}catch(iu){throw iu}}static clearUserCache(){Qa=null}static getDefaultSettings(e,t){const a={user_id:t,business_id:null};switch(e){case"general":return{...a,theme:"light",language:"en",currency:"TZS",timezone:"Africa/Dar_es_Salaam",date_format:"DD/MM/YYYY",time_format:"24",font_size:"medium",show_product_images:!0,show_stock_levels:!0,show_prices:!0,show_barcodes:!0,products_per_page:20,auto_complete_search:!0,confirm_delete:!0,show_confirmations:!0,enable_sound_effects:!0,enable_animations:!0,enable_caching:!0,cache_duration:300,enable_lazy_loading:!0,max_search_results:50,enable_tax:!0,tax_rate:16};case"pricing":return{...a,enable_dynamic_pricing:!0,enable_loyalty_pricing:!0,enable_bulk_pricing:!0,enable_time_based_pricing:!1,enable_customer_pricing:!1,enable_special_events:!1,loyalty_discount_percent:5,loyalty_points_threshold:1e3,loyalty_max_discount:20,bulk_discount_enabled:!0,bulk_discount_threshold:10,bulk_discount_percent:10,time_based_discount_enabled:!1,time_based_start_time:"18:00",time_based_end_time:"22:00",time_based_discount_percent:15,customer_pricing_enabled:!1,vip_customer_discount:10,regular_customer_discount:5,special_events_enabled:!1,special_event_discount_percent:20};case"receipt":return{...a,receipt_template:"standard",receipt_width:80,receipt_font_size:12,show_business_logo:!0,show_business_name:!0,show_business_address:!0,show_business_phone:!0,show_business_email:!1,show_business_website:!1,show_transaction_id:!0,show_date_time:!0,show_cashier_name:!0,show_customer_name:!0,show_customer_phone:!1,show_product_names:!0,show_product_skus:!1,show_product_barcodes:!1,show_quantities:!0,show_unit_prices:!0,show_discounts:!0,show_subtotal:!0,show_tax:!0,show_discount_total:!0,show_grand_total:!0,show_payment_method:!0,show_change_amount:!0,auto_print_receipt:!1,print_duplicate_receipt:!1,enable_email_receipt:!1,enable_sms_receipt:!1,enable_receipt_numbering:!0,receipt_number_prefix:"RCP",receipt_number_start:1,receipt_number_format:"RCP-{YEAR}-{NUMBER}",show_footer_message:!0,footer_message:"Thank you for your business!",show_return_policy:!1,return_policy_text:"Returns accepted within 7 days with receipt",sms_header_message:"Thank you for your purchase!",sms_footer_message:"Thank you for choosing us!"};case"scanner":return{...a,enable_barcode_scanner:!0,enable_camera_scanner:!1,enable_keyboard_input:!0,enable_manual_entry:!0,auto_add_to_cart:!0,auto_focus_search:!0,play_sound_on_scan:!0,vibrate_on_scan:!1,show_scan_feedback:!0,show_invalid_barcode_alert:!0,allow_unknown_products:!1,prompt_for_unknown_products:!0,retry_on_error:!0,max_retry_attempts:3,scanner_connection_type:"usb",scanner_timeout:5e3,support_ean13:!0,support_ean8:!0,support_upc_a:!0,support_upc_e:!0,support_code128:!0,support_code39:!0,support_qr_code:!0,support_data_matrix:!1,enable_continuous_scanning:!1,scan_delay:500,enable_scan_history:!0,max_scan_history:50};case"delivery":return{...a,enable_delivery:!0,default_delivery_fee:5e3,free_delivery_threshold:5e4,max_delivery_distance:20,enable_delivery_areas:!1,delivery_areas:null,area_delivery_fees:null,area_delivery_times:null,enable_delivery_hours:!1,delivery_start_time:"08:00",delivery_end_time:"18:00",enable_same_day_delivery:!0,enable_next_day_delivery:!0,delivery_time_slots:null,notify_customer_on_delivery:!0,notify_driver_on_assignment:!0,enable_sms_notifications:!1,enable_email_notifications:!1,enable_driver_assignment:!1,driver_commission:10,require_signature:!1,enable_driver_tracking:!1,enable_scheduled_delivery:!1,enable_partial_delivery:!1,require_advance_payment:!1,advance_payment_percent:50};case"search":return{...a,enable_product_search:!0,enable_customer_search:!0,enable_sales_search:!0,search_by_name:!0,search_by_barcode:!0,search_by_sku:!0,search_by_category:!0,search_by_supplier:!0,search_by_description:!0,search_by_tags:!0,enable_fuzzy_search:!0,enable_autocomplete:!0,min_search_length:2,max_search_results:50,search_timeout:5e3,search_debounce_time:300,enable_search_history:!0,max_search_history:50,enable_recent_searches:!0,enable_popular_searches:!0,enable_search_suggestions:!0};case"permissions":return{...a,enable_pos_access:!0,enable_sales_access:!0,enable_refunds_access:!0,enable_void_access:!1,enable_discount_access:!0,enable_inventory_view:!0,enable_inventory_edit:!0,enable_stock_adjustments:!0,enable_product_creation:!0,enable_product_deletion:!1,enable_customer_view:!0,enable_customer_creation:!0,enable_customer_edit:!0,enable_customer_deletion:!1,enable_customer_history:!0,enable_payment_processing:!0,enable_cash_management:!0,enable_daily_reports:!0,enable_financial_reports:!1,enable_tax_management:!1,enable_settings_access:!1,enable_user_management:!1,enable_backup_restore:!1,enable_system_maintenance:!1,enable_api_access:!1,enable_audit_logs:!1,enable_security_settings:!1,enable_password_reset:!1,enable_session_management:!1,enable_data_export:!0};case"loyalty":return{...a,enable_loyalty_program:!0,loyalty_program_name:"Loyalty Rewards",points_per_currency:1,points_redemption_rate:100,minimum_points_redemption:500,points_expiry_days:365,enable_customer_registration:!0,require_customer_info:!1,enable_customer_categories:!0,enable_customer_tags:!0,enable_customer_notes:!0,enable_automatic_rewards:!0,enable_manual_rewards:!0,enable_birthday_rewards:!0,enable_anniversary_rewards:!1,enable_referral_rewards:!1,enable_email_communication:!1,enable_sms_communication:!1,enable_push_notifications:!1,enable_marketing_emails:!1,enable_customer_analytics:!0,enable_purchase_history:!0,enable_spending_patterns:!0,enable_customer_segmentation:!1,enable_customer_insights:!1};case"analytics":return{...a,enable_analytics:!0,enable_real_time_analytics:!0,analytics_refresh_interval:3e4,enable_data_export:!0,enable_sales_analytics:!0,enable_sales_trends:!0,enable_product_performance:!0,enable_customer_analytics:!0,enable_revenue_tracking:!0,enable_inventory_analytics:!0,enable_stock_alerts:!0,enable_low_stock_reports:!0,enable_inventory_turnover:!0,enable_supplier_analytics:!1,enable_automated_reports:!1,report_generation_time:"08:00",enable_email_reports:!1,enable_pdf_reports:!0,enable_excel_reports:!0,enable_custom_dashboard:!0,enable_kpi_widgets:!0,enable_chart_animations:!0,enable_data_drill_down:!0,enable_comparative_analysis:!0,enable_predictive_analytics:!1,enable_data_retention:!0,data_retention_days:365,enable_data_backup:!0,enable_api_export:!1};case"notifications":return{...a,enable_notifications:!0,enable_sound_notifications:!0,enable_visual_notifications:!0,enable_push_notifications:!1,notification_timeout:5e3,enable_sales_notifications:!0,notify_on_sale_completion:!0,notify_on_refund:!0,notify_on_void:!0,notify_on_discount:!1,enable_inventory_notifications:!0,notify_on_low_stock:!0,low_stock_threshold:10,notify_on_out_of_stock:!0,notify_on_stock_adjustment:!1,enable_customer_notifications:!1,notify_on_customer_registration:!1,notify_on_loyalty_points:!1,notify_on_customer_birthday:!1,notify_on_customer_anniversary:!1,enable_system_notifications:!0,notify_on_system_errors:!0,notify_on_backup_completion:!1,notify_on_sync_completion:!1,notify_on_maintenance:!0,enable_email_notifications:!1,enable_sms_notifications:!1,enable_in_app_notifications:!0,enable_desktop_notifications:!1};case"advanced":return{...a,enable_performance_mode:!0,enable_caching:!0,cache_size:100,enable_lazy_loading:!0,max_concurrent_requests:5,enable_database_optimization:!0,enable_auto_backup:!1,backup_frequency:"daily",enable_data_compression:!1,enable_query_optimization:!0,enable_two_factor_auth:!1,enable_session_timeout:!0,session_timeout_minutes:60,enable_audit_logging:!1,enable_encryption:!1,enable_api_access:!1,enable_webhooks:!1,enable_third_party_integrations:!1,enable_data_sync:!0,sync_interval:3e5,enable_debug_mode:!1,enable_error_reporting:!0,enable_performance_monitoring:!1,enable_logging:!0,log_level:"error",enable_experimental_features:!1,enable_beta_features:!1,enable_custom_scripts:!1,enable_plugin_system:!1,enable_auto_updates:!1};default:return a}}static async loadSettings(e){var t,a,r,s,n,i;try{const o=await this.getCurrentUser(),c=Ha[e],{data:l,error:d}=await $a.from(c).select("*").eq("user_id",o.id);if(d)return"400"===d.code||(null==(t=d.message)?void 0:t.includes("400"))||(null==(a=d.message)?void 0:a.includes("Bad Request"))||"406"===d.code||(null==(r=d.message)?void 0:r.includes("Not Acceptable"))||"42P01"===d.code||(null==(s=d.message)?void 0:s.includes("does not exist"))||"PGRST301"===d.code||null==(n=d.message)||n.includes("JWT"),this.getDefaultSettings(e,o.id);if(l&&l.length>0)return l.length,l[0];const{data:u}=await $a.from("users").select("id").eq("id",o.id).single(),m=this.getDefaultSettings(e,u?o.id:null),{data:h,error:p}=await $a.from(c).insert(m).select().single();return p?"23503"===p.code||(null==(i=p.message)?void 0:i.includes("foreign key constraint"))?this.getDefaultSettings(e,null):m:h}catch(iu){try{const t=await this.getCurrentUser();return this.getDefaultSettings(e,t.id)}catch(o){return null}}}static async saveSettings(e,t){var a,r,s,n;try{const i=await this.getCurrentUser(),o=Ha[e],{data:c,error:l}=await $a.from(o).select("id").eq("user_id",i.id).single();if(l&&"PGRST116"!==l.code&&("400"===l.code||(null==(a=l.message)?void 0:a.includes("400"))||(null==(r=l.message)?void 0:r.includes("Bad Request"))))return this.getDefaultSettings(e,i.id);if(c){const{id:a,...r}=t,{data:n,error:c}=await $a.from(o).update({...r,user_id:i.id}).eq("user_id",i.id).select().single();return c?("23503"===c.code||null==(s=c.message)||s.includes("foreign key constraint"),null):("general"===e&&Va.clearCache(),n)}{const{data:a,error:r}=await $a.from(o).insert({...t,user_id:i.id}).select().single();return r?("23503"===r.code||null==(n=r.message)||n.includes("foreign key constraint"),null):("general"===e&&Va.clearCache(),a)}}catch(iu){return null}}static async updateSettings(e,t){try{const a=await this.getCurrentUser(),r=Ha[e],{data:s,error:n}=await $a.from(r).update({...t,updated_at:(new Date).toISOString()}).eq("user_id",a.id).select().single();return n?null:s}catch(iu){return null}}static async deleteSettings(e){try{const t=await this.getCurrentUser(),a=Ha[e],{error:r}=await $a.from(a).delete().eq("user_id",t.id);return!r}catch(iu){return!1}}static async loadAllSettings(){const e={};for(const t of Object.keys(Ha))e[t]=await this.loadSettings(t);return e}static async saveAllSettings(e){const t={};for(const[a,r]of Object.entries(e))r&&(t[a]=await this.saveSettings(a,r));return t}static async resetSettings(e){try{const t=await this.getCurrentUser(),a=Ha[e],{error:r}=await $a.from(a).delete().eq("user_id",t.id);return!r}catch(iu){return!1}}static async exportSettings(e){try{const t=await this.loadSettings(e);return JSON.stringify(t,null,2)}catch(iu){return""}}static async importSettings(e,t){try{const a=JSON.parse(t);return null!==await this.saveSettings(e,a)}catch(iu){return!1}}static subscribeToSettings(e,t){const a=$a.auth.getUser(),r=Ha[e];return $a.channel(`${r}_changes`).on("postgres_changes",{event:"*",schema:"public",table:r,filter:`user_id=eq.${a.then(e=>{var t;return null==(t=e.data.user)?void 0:t.id})}`},e=>{t(e.new)}).subscribe()}static unsubscribeFromSettings(e){const t=Ha[e];$a.removeChannel(`${t}_changes`)}}const Ya={loadGeneralSettings:()=>Ka.loadSettings("general"),saveGeneralSettings:e=>Ka.saveSettings("general",e),updateGeneralSettings:e=>Ka.updateSettings("general",e),loadDynamicPricingSettings:()=>Ka.loadSettings("pricing"),saveDynamicPricingSettings:e=>Ka.saveSettings("pricing",e),updateDynamicPricingSettings:e=>Ka.updateSettings("pricing",e),loadReceiptSettings:()=>Ka.loadSettings("receipt"),saveReceiptSettings:e=>Ka.saveSettings("receipt",e),updateReceiptSettings:e=>Ka.updateSettings("receipt",e),loadBarcodeScannerSettings:()=>Ka.loadSettings("scanner"),saveBarcodeScannerSettings:e=>Ka.saveSettings("scanner",e),updateBarcodeScannerSettings:e=>Ka.updateSettings("scanner",e),loadDeliverySettings:()=>Ka.loadSettings("delivery"),saveDeliverySettings:e=>Ka.saveSettings("delivery",e),updateDeliverySettings:e=>Ka.updateSettings("delivery",e),loadSearchFilterSettings:()=>Ka.loadSettings("search"),saveSearchFilterSettings:e=>Ka.saveSettings("search",e),updateSearchFilterSettings:e=>Ka.updateSettings("search",e),loadUserPermissionsSettings:()=>Ka.loadSettings("permissions"),saveUserPermissionsSettings:e=>Ka.saveSettings("permissions",e),updateUserPermissionsSettings:e=>Ka.updateSettings("permissions",e),loadLoyaltyCustomerSettings:()=>Ka.loadSettings("loyalty"),saveLoyaltyCustomerSettings:e=>Ka.saveSettings("loyalty",e),updateLoyaltyCustomerSettings:e=>Ka.updateSettings("loyalty",e),loadAnalyticsReportingSettings:()=>Ka.loadSettings("analytics"),saveAnalyticsReportingSettings:e=>Ka.saveSettings("analytics",e),updateAnalyticsReportingSettings:e=>Ka.updateSettings("analytics",e),loadNotificationSettings:()=>Ka.loadSettings("notifications"),saveNotificationSettings:e=>Ka.saveSettings("notifications",e),updateNotificationSettings:e=>Ka.updateSettings("notifications",e),loadAdvancedSettings:()=>Ka.loadSettings("advanced"),saveAdvancedSettings:e=>Ka.saveSettings("advanced",e),updateAdvancedSettings:e=>Ka.updateSettings("advanced",e),loadAllSettings:()=>Ka.loadAllSettings(),saveAllSettings:e=>Ka.saveAllSettings(e),resetAllSettings:async()=>{const e={};for(const t of Object.keys(Ha))e[t]=await Ka.resetSettings(t);return e}},Ja=Object.freeze(Object.defineProperty({__proto__:null,POSSettingsAPI:Ka,POSSettingsService:Ya,SETTINGS_TABLES:Ha},Symbol.toStringTag,{value:"Module"}));class Xa{constructor(){this.initializedComponents=new Set,this.config={enabled:!1,logLevel:"error"}}static getInstance(){return Xa.instance||(Xa.instance=new Xa),Xa.instance}log(e,t,a,...r){if(!this.config.enabled)return;const s={none:0,error:1,warn:2,info:3,debug:4},n=s[this.config.logLevel];if(s[e]<=n){t.toUpperCase();e}}trackInitialization(e){return this.initializedComponents.has(e)?(this.log("warn",e,"Already initialized, skipping..."),!1):(this.initializedComponents.add(e),this.log("info",e,"Initializing..."),!0)}resetInitialization(e){e?(this.initializedComponents.delete(e),this.log("info",e,"Reset initialization state")):(this.initializedComponents.clear(),this.log("info","DEBUG","Reset all initialization states"))}getInitializedComponents(){return Array.from(this.initializedComponents)}}const Za=Xa.getInstance(),er=(e,t,...a)=>Za.log("error",e,t,...a),tr=(e,t,...a)=>Za.log("info",e,t,...a),ar=async()=>{try{if(await $a.auth.signOut(),"undefined"!=typeof window){["lats-app-auth-token","sb-jxhzveborezjhsmzsgbc-auth-token","supabase.auth.token","supabase.auth.session"].forEach(e=>{localStorage.removeItem(e)}),Object.keys(localStorage).forEach(e=>{(e.includes("supabase")||e.includes("auth")||e.includes("session"))&&localStorage.removeItem(e)})}}catch(iu){}},rr=async()=>{await ar(),"undefined"!=typeof window&&alert("Your session has expired. Please log in again.")},sr={all:"all",view_devices:"devices",add_device:"devices",edit_device:"devices",delete_device:"devices",update_device_status:"devices",assign_devices:"devices",view_customers:"customers",create_customers:"customers",edit_customers:"customers",delete_customers:"customers",view_inventory:"inventory",add_products:"inventory",edit_products:"inventory",delete_products:"inventory",adjust_stock:"inventory",view_stock_history:"inventory",access_pos:"pos",process_sales:"pos",process_refunds:"pos",apply_discounts:"pos",view_reports:"reports",view_financial_reports:"reports",daily_close:"reports",view_settings:"settings",edit_settings:"settings",manage_users:"settings",view_purchase_orders:"purchase_orders",create_purchase_orders:"purchase_orders",edit_purchase_orders:"purchase_orders",delete_purchase_orders:"purchase_orders",approve_purchase_orders:"purchase_orders",view_spare_parts:"spare_parts",create_spare_parts:"spare_parts",edit_spare_parts:"spare_parts",delete_spare_parts:"spare_parts"},nr={admin:["all"],manager:["all"],"customer-care":["view_devices","add_device","edit_device","assign_devices","view_customers","create_customers","edit_customers","access_pos","process_sales","apply_discounts","view_reports"],technician:["view_devices","update_device_status","view_customers","view_inventory","view_stock_history","view_spare_parts"],sales:["view_customers","create_customers","edit_customers","access_pos","process_sales","apply_discounts","view_reports"],user:["view_devices","view_customers"]},ir={"/lats/pos":["access_pos"],"/lats/inventory/management":["view_inventory","edit_settings"],"/lats/inventory/new":["add_products"],"/lats/inventory/products":["view_inventory"],"/lats/inventory/products/:id/edit":["edit_products"],"/lats/inventory/purchase-orders":["view_purchase_orders"],"/lats/inventory/purchase-orders/new":["create_purchase_orders"],"/lats/add-product":["add_products"],"/lats/spare-parts":["view_spare_parts"],"/lats/reports":["view_reports"],"/lats/sales-reports":["view_reports"],"/settings":["view_settings"],"/admin":["manage_users"],"/users":["manage_users"]};function or(e,t){if(!e)return!1;const a=dr(e);if(a.includes("all"))return!0;if(a.includes(t))return!0;const r=sr[t];return!(!r||!a.includes(r))}function cr(e,t){return!(!e||!t||0===t.length)&&t.some(t=>or(e,t))}function lr(e,t){return!(!e||!t||0===t.length)&&t.every(t=>or(e,t))}function dr(e){if(!e)return[];if(e.permissions&&Array.isArray(e.permissions)&&e.permissions.length>0)return e.permissions;const t=e.role;return nr[t]||nr.user}function ur(e,t){if(!e||!e.role)return!1;return(Array.isArray(t)?t:[t]).includes(e.role)}const mr={canViewDevices:e=>or(e,"view_devices"),canAddDevice:e=>or(e,"add_device"),canEditDevice:e=>or(e,"edit_device"),canDeleteDevice:e=>or(e,"delete_device"),canUpdateDeviceStatus:e=>or(e,"update_device_status"),canViewCustomers:e=>or(e,"view_customers"),canCreateCustomers:e=>or(e,"create_customers"),canEditCustomers:e=>or(e,"edit_customers"),canDeleteCustomers:e=>or(e,"delete_customers"),canViewInventory:e=>or(e,"view_inventory"),canAddProducts:e=>or(e,"add_products"),canEditProducts:e=>or(e,"edit_products"),canDeleteProducts:e=>or(e,"delete_products"),canAdjustStock:e=>or(e,"adjust_stock"),canAccessPOS:e=>or(e,"access_pos"),canProcessSales:e=>or(e,"process_sales"),canProcessRefunds:e=>or(e,"process_refunds"),canApplyDiscounts:e=>or(e,"apply_discounts"),canViewReports:e=>or(e,"view_reports"),canViewFinancialReports:e=>or(e,"view_financial_reports"),canCloseDailySales:e=>or(e,"daily_close"),canViewSettings:e=>or(e,"view_settings"),canEditSettings:e=>or(e,"edit_settings"),canManageUsers:e=>or(e,"manage_users"),canViewPurchaseOrders:e=>or(e,"view_purchase_orders"),canCreatePurchaseOrders:e=>or(e,"create_purchase_orders"),canEditPurchaseOrders:e=>or(e,"edit_purchase_orders"),canApprovePurchaseOrders:e=>or(e,"approve_purchase_orders"),isAdmin:e=>or(e,"all")||ur(e,["admin","manager"])},hr=e=>{let t;const a=new Set,r=(e,r)=>{const s="function"==typeof e?e(t):e;if(!Object.is(s,t)){const e=t;t=(null!=r?r:"object"!=typeof s||null===s)?s:Object.assign({},t,s),a.forEach(a=>a(t,e))}},s=()=>t,n={setState:r,getState:s,getInitialState:()=>i,subscribe:e=>(a.add(e),()=>a.delete(e)),destroy:()=>{a.clear()}},i=t=e(r,s,n);return n};var pr={exports:{}},gr={},_r={exports:{}},fr={},yr=e;var vr="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},wr=yr.useState,br=yr.useEffect,Sr=yr.useLayoutEffect,xr=yr.useDebugValue;function kr(e){var t=e.getSnapshot;e=e.value;try{var a=t();return!vr(e,a)}catch(iu){return!0}}var Er="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var a=t(),r=wr({inst:{value:a,getSnapshot:t}}),s=r[0].inst,n=r[1];return Sr(function(){s.value=a,s.getSnapshot=t,kr(s)&&n({inst:s})},[e,a,t]),br(function(){return kr(s)&&n({inst:s}),e(function(){kr(s)&&n({inst:s})})},[e]),xr(a),a};fr.useSyncExternalStore=void 0!==yr.useSyncExternalStore?yr.useSyncExternalStore:Er,_r.exports=fr;var Ir=_r.exports,Ar=e,Pr=Ir;var Cr="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},Tr=Pr.useSyncExternalStore,jr=Ar.useRef,Dr=Ar.useEffect,Rr=Ar.useMemo,Lr=Ar.useDebugValue;gr.useSyncExternalStoreWithSelector=function(e,t,a,r,s){var n=jr(null);if(null===n.current){var i={hasValue:!1,value:null};n.current=i}else i=n.current;n=Rr(function(){function e(e){if(!c){if(c=!0,n=e,e=r(e),void 0!==s&&i.hasValue){var t=i.value;if(s(t,e))return o=t}return o=e}if(t=o,Cr(n,e))return t;var a=r(e);return void 0!==s&&s(t,a)?(n=e,t):(n=e,o=a)}var n,o,c=!1,l=void 0===a?null:a;return[function(){return e(t())},null===l?void 0:function(){return e(l())}]},[t,a,r,s]);var o=Tr(e,n[0],n[1]);return Dr(function(){i.hasValue=!0,i.value=o},[o]),Lr(o),o},pr.exports=gr;const Or=a(pr.exports),{useDebugValue:qr}=r,{useSyncExternalStoreWithSelector:Nr}=Or;const Mr=e=>e;const Ur=e=>{const t="function"==typeof e?(e=>e?hr(e):hr)(e):e,a=(e,a)=>function(e,t=Mr,a){const r=Nr(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,a);return qr(r),r}(t,e,a);return Object.assign(a,t),a},Br=e=>e?Ur(e):Ur,$r=new Map,Fr=e=>{const t=$r.get(e);return t?Object.fromEntries(Object.entries(t.stores).map(([e,t])=>[e,t.getState()])):{}},zr=(e,t={})=>(a,r,s)=>{const{enabled:n,anonymousActionType:i,store:o,...c}=t;let l;try{l=null!=n&&n&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(g){}if(!l)return e(a,r,s);const{connection:d,...u}=((e,t,a)=>{if(void 0===e)return{type:"untracked",connection:t.connect(a)};const r=$r.get(a.name);if(r)return{type:"tracked",store:e,...r};const s={connection:t.connect(a),stores:{}};return $r.set(a.name,s),{type:"tracked",store:e,...s}})(o,l,c);let m=!0;s.setState=(e,t,n)=>{const l=a(e,t);if(!m)return l;const u=void 0===n?{type:i||"anonymous"}:"string"==typeof n?{type:n}:n;return void 0===o?(null==d||d.send(u,r()),l):(null==d||d.send({...u,type:`${o}/${u.type}`},{...Fr(c.name),[o]:s.getState()}),l)};const h=(...e)=>{const t=m;m=!1,a(...e),m=t},p=e(s.setState,r,s);if("untracked"===u.type?null==d||d.init(p):(u.stores[u.store]=s,null==d||d.init(Object.fromEntries(Object.entries(u.stores).map(([e,t])=>[e,e===u.store?p:t.getState()])))),s.dispatchFromDevtools&&"function"==typeof s.dispatch){const e=s.dispatch;s.dispatch=(...t)=>{e(...t)}}return d.subscribe(e=>{var t;switch(e.type){case"ACTION":if("string"!=typeof e.payload)return;return Vr(e.payload,e=>{if("__setState"===e.type){if(void 0===o)return void h(e.state);Object.keys(e.state).length;const t=e.state[o];if(null==t)return;return void(JSON.stringify(s.getState())!==JSON.stringify(t)&&h(t))}s.dispatchFromDevtools&&"function"==typeof s.dispatch&&s.dispatch(e)});case"DISPATCH":switch(e.payload.type){case"RESET":return h(p),void 0===o?null==d?void 0:d.init(s.getState()):null==d?void 0:d.init(Fr(c.name));case"COMMIT":return void 0===o?void(null==d||d.init(s.getState())):null==d?void 0:d.init(Fr(c.name));case"ROLLBACK":return Vr(e.state,e=>{if(void 0===o)return h(e),void(null==d||d.init(s.getState()));h(e[o]),null==d||d.init(Fr(c.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return Vr(e.state,e=>{void 0!==o?JSON.stringify(s.getState())!==JSON.stringify(e[o])&&h(e[o]):h(e)});case"IMPORT_STATE":{const{nextLiftedState:a}=e.payload,r=null==(t=a.computedStates.slice(-1)[0])?void 0:t.state;if(!r)return;return h(void 0===o?r:r[o]),void(null==d||d.send(null,a))}case"PAUSE_RECORDING":return m=!m}return}}),p},Vr=(e,t)=>{let a;try{a=JSON.parse(e)}catch(r){}void 0!==a&&t(a)},Wr=e=>(t,a,r)=>{const s=r.subscribe;r.subscribe=(e,t,a)=>{let n=e;if(t){const s=(null==a?void 0:a.equalityFn)||Object.is;let i=e(r.getState());n=a=>{const r=e(a);if(!s(i,r)){const e=i;t(i=r,e)}},(null==a?void 0:a.fireImmediately)&&t(i,i)}return s(n)};return e(t,a,r)};const Hr=new class{constructor(){this.errors=[],this.maxErrors=1e3,this.isDevelopment=!1}log(e,t,a,r,s={}){const n={id:this.generateId(),level:e,category:t,message:a,error:r,context:{...s,timestamp:new Date},timestamp:new Date,stack:null==r?void 0:r.stack};this.errors.unshift(n),this.errors.length>this.maxErrors&&(this.errors=this.errors.slice(0,this.maxErrors)),this.logToConsole(n),(!this.isDevelopment&&"error"===e||"critical"===e)&&this.sendToExternalService(n),"critical"===e&&this.showCriticalErrorNotification(n)}logDatabase(e,t,a={}){this.log("error","database",e,t,a)}logNetwork(e,t,a={}){this.log("error","network",e,t,a)}logValidation(e,t,a={}){this.log("warn","validation",e,t,a)}logAuth(e,t,a={}){this.log("error","authentication",e,t,a)}logBusiness(e,t,a={}){this.log("error","business_logic",e,t,a)}logUI(e,t,a={}){this.log("warn","ui",e,t,a)}logDebug(e,t={}){this.isDevelopment&&this.log("debug","unknown",e,void 0,t)}logInfo(e,t={}){this.log("info","unknown",e,void 0,t)}logWarning(e,t={}){this.log("warn","unknown",e,void 0,t)}getRecentErrors(e=50){return this.errors.slice(0,e)}getErrorsByCategory(e){return this.errors.filter(t=>t.category===e)}clearErrors(){this.errors=[]}getErrorStats(){const e={debug:0,info:0,warn:0,error:0,critical:0},t={database:0,network:0,validation:0,authentication:0,business_logic:0,ui:0,unknown:0};return this.errors.forEach(a=>{e[a.level]++,t[a.category]++}),{total:this.errors.length,byLevel:e,byCategory:t,recent:this.errors.slice(0,10)}}generateId(){return`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}logToConsole(e){const{level:t,category:a,message:r,error:s,context:n}=e,i=e.timestamp.toISOString(),o=n.component?`[${n.component}]`:"",c=n.action?`(${n.action})`:"";t.toUpperCase(),a.toUpperCase()}sendToExternalService(e){this.isDevelopment}showCriticalErrorNotification(e){this.isDevelopment}};Hr.log.bind(Hr);const Qr=Hr.logDatabase.bind(Hr);Hr.logNetwork.bind(Hr),Hr.logValidation.bind(Hr),Hr.logAuth.bind(Hr),Hr.logBusiness.bind(Hr),Hr.logUI.bind(Hr),Hr.logDebug.bind(Hr),Hr.logInfo.bind(Hr),Hr.logWarning.bind(Hr);class Gr{static isDevelopment(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname}static validateFile(e){return e?this.ALLOWED_TYPES.includes(e.type)?e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size: ${this.MAX_FILE_SIZE/1048576}MB`}:{valid:!0}:{valid:!1,error:`Invalid file type. Allowed: ${this.ALLOWED_TYPES.join(", ")}`}:{valid:!1,error:"No file provided"}}static generateSafeFileName(e,t){var a;const r=Date.now(),s=Math.random().toString(36).substring(2,15);return`${e.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}_${r}_${s}.${(null==(a=t.split(".").pop())?void 0:a.toLowerCase())||"jpg"}`}static async fileToBase64(e){return new Promise((t,a)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=e=>a(e),r.readAsDataURL(e)})}static async uploadProductImage(e,t,a,r="gallery"){try{if(!e)return{success:!1,error:"No file provided"};if(!t)return{success:!1,error:"Product name is required"};if(!a)return{success:!1,error:"Product ID is required"};const n=this.validateFile(e);if(!n.valid)return{success:!1,error:n.error};let i="system";try{const{data:{user:e},error:t}=await $a.auth.getUser();if(e&&!t)i=e.id;else{const e=localStorage.getItem("user");if(e){i=JSON.parse(e).id||"system"}}}catch(s){}if(this.isDevelopment()){const a=await this.fileToBase64(e);return{success:!0,url:a,fileName:this.generateSafeFileName(t,e.name),isDevelopment:!0}}const o=this.generateSafeFileName(t,e.name),c=`${this.BASE_UPLOAD_PATH}/${o}`,l=(this.BASE_THUMBNAIL_PATH,`${this.BASE_URL_PATH}/${o}`),d=`${this.BASE_THUMBNAIL_URL_PATH}/${o}`,u=new FormData;u.append("file",e),u.append("product_id",a),u.append("product_name",t),u.append("file_path",c),u.append("image_type",r);const m="/server-product-upload-handler.php",h=await fetch(m,{method:"POST",body:u});if(!h.ok){const e=await h.text();throw new Error(`Upload failed: ${h.status} ${h.statusText} - ${e}`)}const p=await h.json();return p.success?{success:!0,url:p.url||l,thumbnailUrl:p.thumbnail_url||d}:{success:!1,error:p.error||"Upload failed"}}catch(iu){return{success:!1,error:iu.message||"Upload failed"}}}static async uploadMultipleProductImages(e,t,a){const r=[];for(let s=0;s<e.length;s++){const n=e[s],i=0===s?"main":"gallery",o=await this.uploadProductImage(n,t,a,i);r.push(o),o.success}return r}static async getProductImages(e){try{if(e.startsWith("temp-product-")||e.startsWith("test-product-")||e.startsWith("temp-sparepart-"))return[];const{data:t,error:a}=await $a.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1});return a?[]:t.map(e=>({id:e.id,url:e.image_url,thumbnailUrl:e.thumbnail_url,localPath:e.local_path||"",fileName:e.file_name,fileSize:e.file_size,mimeType:e.mime_type||"image/jpeg",uploadedAt:e.created_at,isPrimary:e.is_primary}))}catch(iu){return[]}}static async deleteProductImage(e){try{const{data:t,error:a}=await $a.from("product_images").select("*").eq("id",e).single();if(a||!t)return{success:!1,error:"Image not found"};const r=await fetch("/server-product-upload-handler.php",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:t.image_url})});if(!r.ok){await r.text();return{success:!1,error:"Failed to delete from server"}}const{error:s}=await $a.from("product_images").delete().eq("id",e);return s?{success:!1,error:"Failed to delete database record"}:{success:!0}}catch(iu){return{success:!1,error:iu.message||"Delete failed"}}}static async setPrimaryImage(e){try{const{error:t}=await $a.from("product_images").update({is_primary:!0}).eq("id",e);return t?{success:!1,error:t.message}:{success:!0}}catch(iu){return{success:!1,error:iu.message||"Failed to set primary image"}}}}Gr.MAX_FILE_SIZE=10485760,Gr.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif"],Gr.BASE_UPLOAD_PATH="/public/uploads/products",Gr.BASE_THUMBNAIL_PATH="/public/uploads/thumbnails",Gr.BASE_URL_PATH="/uploads/products",Gr.BASE_THUMBNAIL_URL_PATH="/uploads/thumbnails";class Kr{static async compressImage(e,t={}){const a={...this.DEFAULT_OPTIONS,...t};return new Promise((t,r)=>{const s=document.createElement("canvas"),n=s.getContext("2d");if(!n)return void r(new Error("Canvas context not available"));const i=new Image;i.onload=()=>{try{const{width:o,height:c}=this.calculateDimensions(i.width,i.height,a.maxWidth,a.maxHeight,a.maintainAspectRatio);s.width=o,s.height=c,n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.drawImage(i,0,0,o,c);const l=this.getMimeType(a.format);s.toBlob(s=>{if(s){const r=e.size/s.size;t({blob:s,width:o,height:c,size:s.size,format:a.format,compressionRatio:r})}else r(new Error("Failed to create compressed image"))},l,a.quality)}catch(iu){r(iu)}},i.onerror=()=>{r(new Error("Failed to load image"))},i.src=URL.createObjectURL(e)})}static async generateOptimalThumbnail(e,t="SMALL"){const a=this.THUMBNAIL_SPECS[t];try{const t=await this.compressImage(e,{maxWidth:a.width,maxHeight:a.height,quality:a.quality,format:"webp",maintainAspectRatio:!1});if(t.size<=1024*a.maxSizeKB)return t;const r=Math.max(.5,a.quality-.1),s=await this.compressImage(e,{maxWidth:a.width,maxHeight:a.height,quality:r,format:"webp",maintainAspectRatio:!1});if(s.size<=1024*a.maxSizeKB)return s}catch(r){}try{const t=await this.compressImage(e,{maxWidth:a.width,maxHeight:a.height,quality:a.quality,format:"jpeg",maintainAspectRatio:!1});if(t.size>1024*a.maxSizeKB){const t=Math.max(.4,a.quality-.2);return await this.compressImage(e,{maxWidth:a.width,maxHeight:a.height,quality:t,format:"jpeg",maintainAspectRatio:!1})}return t}catch(s){throw new Error("Failed to generate optimal thumbnail in any format")}}static async generateThumbnailSet(e){const[t,a,r]=await Promise.all([this.generateOptimalThumbnail(e,"SMALL"),this.generateOptimalThumbnail(e,"MEDIUM"),this.generateOptimalThumbnail(e,"LARGE")]);return{small:t,medium:a,large:r}}static async uploadCompressedThumbnail(e,t,a,r="product-images"){try{const a=Date.now(),s=Math.random().toString(36).substring(2,15),n=this.getFileExtension(e.format),i=`${t}/thumbnails/${`thumb_${a}_${s}.${n}`}`,{data:o,error:c}=await $a.storage.from(r).upload(i,e.blob,{cacheControl:"31536000",upsert:!1,contentType:this.getMimeType(e.format)});if(c)return null;if(!o)return null;const{data:l}=$a.storage.from(r).getPublicUrl(o.path);return l&&l.publicUrl?l.publicUrl:null}catch(iu){return null}}static calculateDimensions(e,t,a,r,s){if(!s)return{width:a,height:r};const n=e/t;let i=a,o=r;return n>1?(o=i/n,o>r&&(o=r,i=o*n)):(i=o*n,i>a&&(i=a,o=i/n)),{width:Math.round(i),height:Math.round(o)}}static getOptimalFormat(e){const t=document.createElement("canvas");if(t.getContext("2d")){t.width=1,t.height=1;if(t.toDataURL("image/webp").startsWith("data:image/webp"))return"webp"}return e.includes("png")||e.includes("transparent")?"png":"jpeg"}static isWebPSupported(){const e=document.createElement("canvas");return!!e.getContext("2d")&&(e.width=1,e.height=1,e.toDataURL("image/webp").startsWith("data:image/webp"))}static getFileExtension(e){switch(e.toLowerCase()){case"webp":return"webp";case"jpeg":case"jpg":default:return"jpg";case"png":return"png"}}static getMimeType(e){switch(e.toLowerCase()){case"webp":return"image/webp";case"jpeg":case"jpg":default:return"image/jpeg";case"png":return"image/png"}}static formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(2))} ${["B","KB","MB","GB"][t]}`}static getCompressionStats(e,t){const a=e-t,r=(a/e*100).toFixed(1);return{originalSize:this.formatFileSize(e),compressedSize:this.formatFileSize(t),savings:this.formatFileSize(a),savingsPercent:r,compressionRatio:(e/t).toFixed(2)}}}Kr.DEFAULT_OPTIONS={maxWidth:300,maxHeight:300,quality:.8,format:"webp",maintainAspectRatio:!0},Kr.THUMBNAIL_SPECS={SMALL:{width:150,height:150,quality:.85,maxSizeKB:50},MEDIUM:{width:200,height:200,quality:.8,maxSizeKB:80},LARGE:{width:300,height:300,quality:.75,maxSizeKB:120}};class Yr{static getDevImages(e){return this.devImageStorage.get(e)||[]}static clearImageCache(e){e?this.imageCache.delete(e):this.imageCache.clear()}static clearDevImages(e){this.devImageStorage.delete(e)}static async diagnoseUploadEnvironment(){const e=[],t=navigator.onLine;t||e.push("No internet connection");let a=!1;try{const{data:t,error:r}=await $a.from("devices").select("id").limit(1);a=!r,r&&e.push(`Supabase connection failed: ${r.message}`)}catch(iu){e.push(`Supabase connection error: ${iu.message}`)}let r=!1;try{const{data:t,error:a}=await $a.storage.from("product-images").list("",{limit:1});r=!a,a&&e.push(`Storage access failed: ${a.message}`)}catch(iu){e.push(`Storage access error: ${iu.message}`)}return{networkStatus:t,supabaseConnection:a,storageAccess:r,fileSizeLimit:!0,issues:e}}static async convertPngToWhiteBackground(e){return new Promise((t,a)=>{const r=new Image;r.onload=()=>{try{const s=document.createElement("canvas");s.width=r.width,s.height=r.height;const n=s.getContext("2d");if(!n)return void a(new Error("Failed to get canvas context"));n.fillStyle="#FFFFFF",n.fillRect(0,0,s.width,s.height),n.drawImage(r,0,0),s.toBlob(r=>{if(!r)return void a(new Error("Failed to convert canvas to blob"));const s=new File([r],e.name,{type:"image/png",lastModified:Date.now()});t(s)},"image/png",.95)}catch(iu){a(iu)}},r.onerror=()=>{a(new Error("Failed to load image"))},r.src=URL.createObjectURL(e)})}static async uploadImage(e,t,a,r={}){var s;try{if(!e)return{success:!1,error:"No file provided"};if(!t)return{success:!1,error:"Product ID is required"};if(!a)return{success:!1,error:"User ID is required"};let o=e;if("image/png"===e.type)try{o=await this.convertPngToWhiteBackground(e)}catch(iu){}const{bucket:c="product-images",maxFileSize:l=this.DEFAULT_MAX_FILE_SIZE,allowedTypes:d=this.DEFAULT_ALLOWED_TYPES,generateThumbnail:u=!0,thumbnailSize:m={width:300,height:300},isPrimary:h=!1}=r,p=this.validateFile(o,l,d);if(!p.valid)return{success:!1,error:p.error};let g=a&&"system"!==a?a:null;try{const{data:{user:e},error:t}=await $a.auth.getUser();if(e&&!t)g=e.id;else{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);g=t.id&&"system"!==t.id?t.id:null}}}catch(n){}const _=Date.now(),f=Math.random().toString(36).substring(2,15),y=(null==(s=e.name.split(".").pop())?void 0:s.toLowerCase())||"jpg",v=`${t}/${`${_}_${f}.${y}`}`,w=async()=>{const e=$a.storage.from(c).upload(v,o,{cacheControl:"3600",upsert:!1,contentType:o.type}),t=new Promise((e,t)=>{setTimeout(()=>t(new Error("Upload timeout after 30 seconds")),3e4)});return Promise.race([e,t])},{data:b,error:S}=await w();if(S){if(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-"))try{const a=URL.createObjectURL(o),r={id:`local-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,url:a,thumbnailUrl:a,fileName:e.name,fileSize:o.size,mimeType:o.type,isPrimary:h,uploadedAt:(new Date).toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(r),{success:!0,image:r}}catch(i){}return{success:!1,error:this.getErrorMessage(S)}}const{data:x}=$a.storage.from(c).getPublicUrl(v),k=await this.getImageDimensions(o);let E;if(u&&"image/svg+xml"!==o.type)try{const a=await Kr.generateOptimalThumbnail(o,"SMALL");Kr.getCompressionStats(o.size,a.size);E=await Kr.uploadCompressedThumbnail(a,t,e.name,c)}catch(iu){}if(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-")){const a={id:`temp-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,url:x.publicUrl,thumbnailUrl:E,fileName:e.name,fileSize:o.size,mimeType:o.type,width:null==k?void 0:k.width,height:null==k?void 0:k.height,isPrimary:h,uploadedAt:(new Date).toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(a),{success:!0,image:a}}const{data:I,error:A}=await $a.from("product_images").insert({product_id:t,image_url:x.publicUrl,thumbnail_url:E,file_name:e.name,file_size:o.size,is_primary:h,uploaded_by:a}).select().single();if(A)return await $a.storage.from(c).remove([v]),{success:!1,error:`Upload succeeded but database record failed: ${A.message}`};return{success:!0,image:{id:I.id,url:x.publicUrl,thumbnailUrl:E,fileName:e.name,fileSize:o.size,mimeType:o.type,width:null==k?void 0:k.width,height:null==k?void 0:k.height,isPrimary:h,uploadedAt:I.created_at}}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async uploadMultipleImages(e,t,a,r={}){const s=[];for(let n=0;n<e.length;n++){const i=e[n],o=0===n,c=await this.uploadImage(i,t,a,{...r,isPrimary:o});s.push(c),n<e.length-1&&await new Promise(e=>setTimeout(e,100))}return s}static async deleteImage(e,t="product-images",a){try{if(a&&(a.startsWith("temp-product-")||a.startsWith("test-product-")||a.startsWith("temp-sparepart-"))){const t=this.devImageStorage.get(a)||[];if(!t.find(t=>t.id===e))return{success:!1,error:"Image not found"};const r=t.filter(t=>t.id!==e);return this.devImageStorage.set(a,r),{success:!0}}const{data:r,error:s}=await $a.from("product_images").select("*").eq("id",e).single();if(s||!r)return{success:!1,error:"Image not found"};const n=r.image_url.split("/"),i=n[n.length-1],o=`${n[n.length-2]}/${i}`,{error:c}=await $a.storage.from(t).remove([o]);if(c)return{success:!1,error:this.getErrorMessage(c)};const{error:l}=await $a.from("product_images").delete().eq("id",e);return l?{success:!1,error:this.getErrorMessage(l)}:{success:!0}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async setPrimaryImage(e,t){try{if(t&&(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-"))){const a=this.devImageStorage.get(t)||[];a.forEach(e=>{e.isPrimary=!1});const r=a.find(t=>t.id===e);return r?(r.isPrimary=!0,{success:!0}):{success:!1,error:"Image not found"}}const{data:a,error:r}=await $a.from("product_images").update({is_primary:!0}).eq("id",e).select().single();return r?{success:!1,error:this.getErrorMessage(r)}:{success:!0}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async getProductImages(e){try{const{data:t,error:a}=await $a.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1});return a?[]:t.map(e=>({id:e.id,url:e.image_url,thumbnailUrl:e.thumbnail_url,fileName:e.file_name,fileSize:e.file_size,mimeType:e.mime_type,width:e.width,height:e.height,isPrimary:e.is_primary,uploadedAt:e.created_at}))}catch(iu){return[]}}static validateFile(e,t,a){return e.size>t?{valid:!1,error:`File size exceeds maximum allowed size of ${Math.round(t/1024/1024)}MB`}:a.includes(e.type)?{valid:!0}:{valid:!1,error:`File type ${e.type} is not allowed. Allowed types: ${a.join(", ")}`}}static async getImageDimensions(e){return new Promise(t=>{if("image/svg+xml"===e.type)return void t(null);const a=new Image;a.onload=()=>{t({width:a.width,height:a.height})},a.onerror=()=>{t(null)},a.src=URL.createObjectURL(e)})}static getErrorMessage(e){return"string"==typeof e?e:(null==e?void 0:e.message)?e.message:(null==e?void 0:e.error_description)?e.error_description:"Unknown error occurred"}static async updateProductImages(e,t){try{const{data:{user:a},error:r}=await $a.auth.getUser();if(r||!a)return{success:!1,error:"Authentication required"};const s=this.getDevImages(e);if(s&&s.length>0){const r=s.map((e,r)=>({product_id:t,image_url:e.url,thumbnail_url:e.thumbnailUrl,file_name:e.fileName,file_size:e.fileSize,is_primary:0===r,uploaded_by:a.id})),{data:n,error:i}=await $a.from("product_images").insert(r).select();return i?{success:!1,error:i.message}:(this.clearDevImages(e),this.clearImageCache(t),{success:!0})}return{success:!0}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async testBucketAccess(e="product-images"){try{const{data:t,error:a}=await $a.storage.from(e).list("",{limit:1});return a?{success:!1,error:this.getErrorMessage(a)}:{success:!0}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error"}}}}Yr.DEFAULT_MAX_FILE_SIZE=10485760,Yr.DEFAULT_ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif","image/svg+xml"],Yr.devImageStorage=new Map,Yr.imageCache=new Map,Yr.CACHE_DURATION=3e5;const Jr=Object.freeze(Object.defineProperty({__proto__:null,EnhancedImageUploadService:Yr},Symbol.toStringTag,{value:"Module"})),Xr=$a;class Zr{static async convertPngToWhiteBackground(e){return new Promise((t,a)=>{const r=new Image;r.onload=()=>{try{const s=document.createElement("canvas");s.width=r.width,s.height=r.height;const n=s.getContext("2d");if(!n)return void a(new Error("Failed to get canvas context"));n.fillStyle="#FFFFFF",n.fillRect(0,0,s.width,s.height),n.drawImage(r,0,0),s.toBlob(r=>{if(!r)return void a(new Error("Failed to convert canvas to blob"));const s=new File([r],e.name,{type:"image/png",lastModified:Date.now()});t(s)},"image/png",.95)}catch(iu){a(iu)}},r.onerror=()=>{a(new Error("Failed to load image"))},r.src=URL.createObjectURL(e)})}static async uploadImage(e,t,a,r=!1){try{let n=e;if("image/png"===e.type)try{n=await this.convertPngToWhiteBackground(e)}catch(iu){}if(!e)return{success:!1,error:"No file provided"};if(!t)return{success:!1,error:"Product ID is required"};if(!a)return{success:!1,error:"User ID is required"};const i=this.validateFile(n);if(!i.valid)return{success:!1,error:i.error};let o=a&&"system"!==a?a:null;try{const{data:{user:e},error:t}=await Xr.auth.getUser();if(e&&!t)o=e.id;else{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);o=t.id&&"system"!==t.id?t.id:null}}}catch(s){}const c="product",l=await Gr.uploadProductImage(n,c,t,r?"main":"gallery");if(!l.success)return{success:!1,error:l.error};if(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-")){const a={id:`temp-${Date.now()}-${crypto.randomUUID().replace(/-/g,"").substring(0,8)}`,url:l.url||"",fileName:e.name,fileSize:n.size,mimeType:n.type,isPrimary:r,uploadedAt:(new Date).toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(a),{success:!0,image:a}}const d=await this.getProductImages(t);return{success:!0,image:d.find(t=>t.fileName===e.name)||{id:`temp-${Date.now()}`,url:l.url||"",fileName:e.name,fileSize:n.size,mimeType:n.type,isPrimary:r,uploadedAt:(new Date).toISOString()}}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async uploadMultipleImages(e,t,a){const r=[];for(let s=0;s<e.length;s++){const n=e[s],i=0===s,o=await this.uploadImage(n,t,a,i);r.push(o),o.success}return r}static async deleteImage(e){try{const t=await Gr.deleteProductImage(e);return t.success?{success:!0}:{success:!1,error:t.error}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async updateProductImages(e,t){var a;try{const{data:{user:r},error:s}=await Xr.auth.getUser();if(s||!r)return{success:!1,error:"Authentication required"};const n=this.devImageStorage.get(e),i=Yr.getDevImages(e),o=[...n||[],...i||[]];if(o.length>0){const a=o.map((e,a)=>({product_id:t,image_url:e.url,file_name:e.fileName,file_size:e.fileSize,is_primary:0===a,uploaded_by:r.id})),{data:s,error:n}=await Xr.from("product_images").insert(a).select();return n?{success:!1,error:n.message}:(this.devImageStorage.delete(e),Yr.clearDevImages(e),this.clearImageCache(t),{success:!0})}const{data:c,error:l}=await Xr.storage.from("product-images").list("temp",{limit:100,offset:0});if(l)return{success:!1,error:l.message};if(!c||0===c.length)return{success:!0};const d=e.replace("temp-product-",""),u=[];let m=!1,h=!1;for(const e of c){if(!e.name.match(/\.(jpg|jpeg|png|gif|webp)$/i))continue;const s=e.name.split("_");if(s.length<2)continue;if(s[1]!==d)continue;h=!0;const n=`temp/${e.name}`,{data:i}=Xr.storage.from("product-images").getPublicUrl(n),o={product_id:t,image_url:i.publicUrl,file_name:e.name,file_size:(null==(a=e.metadata)?void 0:a.size)||0,is_primary:!m,uploaded_by:r.id};m||(m=!0),u.push(o)}if(!h)return{success:!0};if(0===u.length)return{success:!0};const{data:p,error:g}=await Xr.from("product_images").insert(u).select();return g?{success:!1,error:g.message}:(this.clearImageCache(t),{success:!0})}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}static async getProductImages(e){try{if(e.startsWith("temp-product-")||e.startsWith("test-product-")||e.startsWith("temp-sparepart-")){const{EnhancedImageUploadService:t}=await s(()=>Promise.resolve().then(()=>Jr),void 0);return t.getDevImages(e)}const t=this.imageCache.get(e);if(t&&Date.now()-t.timestamp<this.CACHE_DURATION)return t.images;const a=(await Gr.getProductImages(e)).map(e=>({id:e.id,url:e.url,thumbnailUrl:e.thumbnailUrl,fileName:e.fileName,fileSize:e.fileSize,mimeType:e.mimeType,isPrimary:e.isPrimary,uploadedAt:e.uploadedAt}));return this.imageCache.set(e,{images:a,timestamp:Date.now()}),a}catch(iu){return[]}}static clearImageCache(e){e?this.imageCache.delete(e):this.imageCache.clear()}static validateFile(e){return e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File size ${(e.size/1024/1024).toFixed(2).replace(/\.00$/,"").replace(/\.0$/,"")}MB exceeds limit of ${(()=>(this.MAX_FILE_SIZE/1024/1024).toFixed(2).replace(/\.00$/,"").replace(/\.0$/,""))()}MB`}:this.ALLOWED_TYPES.includes(e.type)?e.type.startsWith("image/")?{valid:!0}:{valid:!1,error:"File must be an image"}:{valid:!1,error:`File type ${e.type} is not allowed. Allowed types: ${this.ALLOWED_TYPES.join(", ")}`}}static getErrorMessage(e){const t=e.message||"Unknown error",a=e.statusCode||e.status;return 400===a?t.includes("duplicate")?"File with this name already exists. Please rename the file.":t.includes("size")?"File size is too large. Please use a smaller image.":t.includes("type")||t.includes("mime")?"File type not supported. Please use JPEG, PNG, or WebP.":t.includes("bucket")?"Storage bucket not found. Please contact support.":`Upload failed (400): ${t}`:401===a?"Authentication failed. Please log in again.":403===a?"Permission denied. Please check your account access.":404===a?"Storage bucket not found. Please contact support.":413===a?"File size is too large. Please use a smaller image.":t.includes("permission")?"Permission denied. Please check your account access.":t.includes("bucket")?"Storage bucket not found. Please contact support.":`Upload failed: ${t}`}}Zr.devImageStorage=new Map,Zr.imageCache=new Map,Zr.CACHE_DURATION=3e5,Zr.MAX_FILE_SIZE=10485760,Zr.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif"];const es=new class{constructor(){this.pendingRequests=new Map,this.REQUEST_TIMEOUT=3e4}async deduplicate(e,t,a){const r=(null==a?void 0:a.timeout)||this.REQUEST_TIMEOUT,s=(null==a?void 0:a.forceRefresh)||!1;this.cleanupExpiredRequests();const n=this.pendingRequests.get(e);if(n&&!s)return n.promise;const i=t();this.pendingRequests.set(e,{promise:i,timestamp:Date.now()});try{return await Promise.race([i,new Promise((t,a)=>setTimeout(()=>a(new Error(`Request timeout: ${e}`)),r))])}finally{this.pendingRequests.delete(e)}}clear(e){this.pendingRequests.delete(e)}clearAll(){this.pendingRequests.clear()}cleanupExpiredRequests(){const e=Date.now();for(const[t,a]of this.pendingRequests.entries())e-a.timestamp>this.REQUEST_TIMEOUT&&this.pendingRequests.delete(t)}getStats(){return{pendingCount:this.pendingRequests.size,keys:Array.from(this.pendingRequests.keys())}}};async function ts(e,t,a){return es.deduplicate(e,t,a)}const as=new class{constructor(){this.cache=new Map,this.DEFAULT_TTL=3e5,this.MAX_CACHE_SIZE=100}async get(e,t,a){const r=(null==a?void 0:a.ttl)||this.DEFAULT_TTL,s=(null==a?void 0:a.staleWhileRevalidate)||!1;this.cleanupExpired();const n=this.cache.get(e),i=Date.now();if(n){if(n.expiresAt>i)return n.data;if(s)return this.revalidateInBackground(e,t,r),n.data}return this.fetchAndCache(e,t,r)}async fetchAndCache(e,t,a){const r=await t();return this.set(e,r,a),r}set(e,t,a){const r=Date.now(),s=a||this.DEFAULT_TTL;if(this.cache.size>=this.MAX_CACHE_SIZE&&!this.cache.has(e)){const e=this.getOldestKey();e&&this.cache.delete(e)}this.cache.set(e,{data:t,timestamp:r,expiresAt:r+s})}invalidate(e){this.cache.delete(e)}invalidatePattern(e){const t="string"==typeof e?new RegExp(e):e;for(const a of this.cache.keys())t.test(a)&&this.cache.delete(a)}clear(){this.cache.size;this.cache.clear()}async revalidateInBackground(e,t,a){try{const r=await t();this.set(e,r,a)}catch(iu){}}cleanupExpired(){const e=Date.now();for(const[t,a]of this.cache.entries())a.expiresAt<e&&this.cache.delete(t)}getOldestKey(){let e=null,t=1/0;for(const[a,r]of this.cache.entries())r.timestamp<t&&(t=r.timestamp,e=a);return e}getStats(){const e=Date.now(),t=Array.from(this.cache.entries()).map(([t,a])=>({key:t,age:e-a.timestamp,ttl:a.expiresAt-e}));return{size:this.cache.size,maxSize:this.MAX_CACHE_SIZE,hitRate:0,entries:t}}};async function rs(e,t,a){return as.get(e,t,a)}async function ss(e,t){try{const{images:a,...r}=e,s=localStorage.getItem("current_branch_id"),n={name:r.name,description:r.description,sku:r.sku,category_id:r.categoryId,is_active:r.isActive??!0,total_quantity:0,total_value:0,branch_id:s};void 0!==r.costPrice&&(n.cost_price=r.costPrice),void 0===r.sellingPrice&&void 0===r.price||(n.selling_price=r.sellingPrice??r.price),void 0===r.quantity&&void 0===r.stockQuantity||(n.stock_quantity=r.quantity??r.stockQuantity),void 0===r.minQuantity&&void 0===r.minStockLevel||(n.min_stock_level=r.minQuantity??r.minStockLevel),r.storageRoomId&&(n.storage_room_id=r.storageRoomId),r.shelfId&&(n.shelf_id=r.shelfId),r.barcode&&(n.barcode=r.barcode),r.attributes&&(n.attributes=r.attributes),r.metadata&&(n.metadata=r.metadata),r.supplierId&&(n.supplier_id=r.supplierId);const{data:i,error:o}=await $a.from("lats_products").insert(n).select().single();if(o)throw o;if(r.variants&&r.variants.length>0){const e=r.variants.map(e=>({product_id:i.id,sku:e.sku,name:e.name,attributes:e.attributes||{},cost_price:e.costPrice??0,selling_price:e.sellingPrice??e.price??0,quantity:e.quantity??e.stockQuantity??0,min_quantity:e.minQuantity??e.minStockLevel??0,branch_id:s,is_shared:!1,sharing_mode:"isolated",visible_to_branches:s?[s]:null})),{error:t}=await $a.from("lats_product_variants").insert(e);if(t)throw t}if(a&&a.length>0)for(let e=0;e<a.length;e++){const r=a[e];if(r.image_url.startsWith("blob:"))continue;const{error:s}=await $a.from("product_images").insert({product_id:i.id,image_url:r.image_url,thumbnail_url:r.thumbnail_url,file_name:r.file_name,file_size:r.file_size,is_primary:r.is_primary,uploaded_by:t})}return{id:i.id,name:i.name,description:i.description,sku:r.sku,categoryId:i.category_id,supplierId:i.supplier_id,isActive:i.is_active,totalQuantity:i.total_quantity,totalValue:i.total_value,createdAt:i.created_at,updatedAt:i.updated_at}}catch(iu){throw iu}}async function ns(e,t){const a=`products:${e}`;return ts(a,async()=>rs(a,()=>async function(e){var t,a,r;if(!e||"undefined"===e||"null"===e)throw new Error(`Invalid product ID: ${e}`);const{data:s,error:n}=await $a.from("lats_products").select("*").eq("id",e).single();if(n)throw n;if(!s)throw new Error("Product not found");const[i,o,c,l,d]=await Promise.all([s.category_id?$a.from("lats_categories").select("id, name").eq("id",s.category_id).single():Promise.resolve({data:null}),s.supplier_id?$a.from("lats_suppliers").select("id, name, contact_person, email, phone, address").eq("id",s.supplier_id).single():Promise.resolve({data:null}),$a.from("lats_product_variants").select("*").eq("product_id",e).is("parent_variant_id",null).order("created_at",{ascending:!0}),s.storage_room_id?$a.from("storage_rooms").select("id, name").eq("id",s.storage_room_id).single():Promise.resolve({data:null}),s.shelf_id?$a.from("shelves").select("id, name, code").eq("id",s.shelf_id).single():Promise.resolve({data:null})]);let u=[];try{u=await Zr.getProductImages(e)}catch(h){null==h||h.code,u=[]}const m=await Promise.all((c.data||[]).map(async e=>{let t=e.quantity||0;if(e.is_parent||"parent"===e.variant_type)try{const{data:a,error:r}=await $a.from("lats_product_variants").select("quantity, is_active").eq("parent_variant_id",e.id).eq("variant_type","imei_child").eq("is_active",!0);!r&&a&&(t=a.reduce((e,t)=>e+(t.quantity||0),0))}catch(a){}return{id:e.id,productId:e.product_id,name:e.variant_name||e.name||"Unnamed Variant",sku:e.sku,attributes:e.attributes||{},variantAttributes:e.variant_attributes||{},variant_attributes:e.variant_attributes||{},price:e.selling_price,costPrice:e.cost_price,cost_price:e.cost_price,sellingPrice:e.selling_price,selling_price:e.selling_price,stockQuantity:t,quantity:t,minQuantity:e.min_quantity,minStockLevel:e.min_quantity,isPrimary:e.is_primary||!1,isActive:e.is_active,is_parent:e.is_parent||!1,variant_type:e.variant_type||"standard",createdAt:e.created_at,updatedAt:e.updated_at}}));return{id:s.id,name:s.name,description:s.description,sku:s.sku,categoryId:s.category_id,supplierId:s.supplier_id,isActive:s.is_active,totalQuantity:s.total_quantity,totalValue:s.total_value,createdAt:s.created_at,updatedAt:s.updated_at,images:u,variants:m,category:i.data?{id:i.data.id,name:i.data.name}:null,supplier:o.data?{id:o.data.id,name:o.data.name,contactPerson:o.data.contact_person,email:o.data.email,phone:o.data.phone,address:o.data.address}:null,storageRoomId:s.storage_room_id,storageRoomName:null==(t=l.data)?void 0:t.name,shelfId:s.shelf_id,shelfName:null==(a=d.data)?void 0:a.name,shelfCode:null==(r=d.data)?void 0:r.code,barcode:s.barcode,specification:s.specification,condition:s.condition,brand:s.brand,model:s.model,weight:s.weight,length:s.length,width:s.width,height:s.height,shippingClass:s.shipping_class,requiresSpecialHandling:s.requires_special_handling,shippingStatus:s.shipping_status,trackingNumber:s.tracking_number,expectedDelivery:s.expected_delivery,shippingAgent:s.shipping_agent,usdPrice:s.usd_price,eurPrice:s.eur_price,exchangeRate:s.exchange_rate,baseCurrency:s.base_currency,isDigital:s.is_digital,requiresShipping:s.requires_shipping,isFeatured:s.is_featured,tags:s.tags,metadata:s.metadata}}(e),{ttl:18e4,staleWhileRevalidate:!0}),{forceRefresh:null==t?void 0:t.forceRefresh})}async function is(e){const t=`products:${localStorage.getItem("current_branch_id")||"default"}`;return ts(t,async()=>rs(t,()=>async function(){try{Date.now();const t=localStorage.getItem("current_branch_id");let a=null;if(t){const{data:e,error:r}=await $a.from("store_locations").select("id, name, data_isolation_mode, share_products").eq("id",t).single();a=e}let r=$a.from("lats_products").select("id, name, description, sku, barcode, category_id, supplier_id, cost_price, stock_quantity, min_stock_level, max_stock_level, is_active, image_url, brand, model, warranty_period, created_at, updated_at, specification, condition, selling_price, total_quantity, total_value, storage_room_id, shelf_id, branch_id, is_shared, sharing_mode, visible_to_branches").order("created_at",{ascending:!1});t&&a?"isolated"===a.data_isolation_mode?r=r.or(`branch_id.eq.${t},is_shared.eq.true`):"shared"===a.data_isolation_mode||(r="hybrid"===a.data_isolation_mode?r.or(`branch_id.eq.${t},is_shared.eq.true,branch_id.is.null`):r.or(`branch_id.eq.${t},branch_id.is.null`)):t&&!a&&(r=r.or(`branch_id.eq.${t},branch_id.is.null`));const{data:s,error:n}=await r;if(Date.now(),n)throw new Error(`Failed to fetch products: ${n.message}`);const i=s||[],o=Array.from(new Map(i.map(e=>[e.id,e])).values());if(!o||0===o.length)return[];o.slice(0,3).forEach((e,t)=>{e&&e.name});const c=o.filter(e=>!(!e||!e.name)),l=[...new Set(c.map(e=>e.category_id).filter(Boolean))],d=(new Set(c.map(e=>e.supplier_id).filter(Boolean)),c.map(e=>e.id).filter(Boolean)),u=(Date.now(),l.length>0?$a.from("lats_categories").select("id, name").in("id",l):Promise.resolve({data:[]})),m=$a.from("lats_suppliers").select("id, name").eq("is_active",!0).order("name"),h=localStorage.getItem("current_branch_id");let p=$a.from("lats_product_variants").select("id, product_id, name, variant_name, sku, attributes, variant_attributes, cost_price, selling_price, quantity, reserved_quantity, min_quantity, created_at, updated_at, branch_id, is_shared, is_parent, variant_type, parent_variant_id").in("product_id",d).is("parent_variant_id",null).order("name");h&&a?"isolated"===a.data_isolation_mode?p=p.or(`is_shared.eq.true,branch_id.eq.${h}`):"hybrid"===a.data_isolation_mode&&(p=p.or(`is_shared.eq.true,branch_id.eq.${h},branch_id.is.null`)):h&&(p=p.or(`branch_id.eq.${h},branch_id.is.null`));const g=d.length>0?$a.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",d).order("is_primary",{ascending:!1}):Promise.resolve({data:[]}),[_,f,y,v]=await Promise.all([u,m,p,g]);Date.now(),_.error,f&&"error"in f&&f.error,y.error,v.error;const w=_.data||[],b=f.data||[];let S=y.data||[],x=(v.data||[]).map(e=>({...e,thumbnail_url:e.thumbnail_url||e.image_url}));const k=new Map;(w||[]).forEach(e=>{k.set(e.id,e)});const E=new Map;(b||[]).forEach(e=>{E.set(e.id,e)});const I=new Map;S.forEach(e=>{I.has(e.product_id)||I.set(e.product_id,[]),I.get(e.product_id).push(e)});const A=new Map;x&&x.length>0&&x.forEach(e=>{A.has(e.product_id)||A.set(e.product_id,[]),A.get(e.product_id).push(e)});const P=new Map;try{const e=c.filter(e=>e.shelf_id).map(e=>e.shelf_id);if(e.length>0){const{data:t}=await $a.from("lats_store_shelves").select("id, name, code").in("id",e);t&&t.forEach(e=>{P.set(e.id,e)})}}catch(e){}const C=(c||[]).map(e=>{var t,a;const r=[];e.image_url&&r.push(e.image_url),(A.get(e.id)||[]).forEach(e=>{e.image_url&&!r.includes(e.image_url)&&r.push(e.image_url)});const s=I.get(e.id)||[],n=s[0];return{id:e.id,name:e.name,description:e.description,sku:e.sku,barcode:e.barcode,specification:e.specification,images:r,categoryId:e.category_id,supplierId:e.supplier_id,isActive:e.is_active,price:e.selling_price||(null==n?void 0:n.selling_price)||0,costPrice:e.cost_price||(null==n?void 0:n.cost_price)||0,stockQuantity:e.stock_quantity||0,minStockLevel:e.min_stock_level||0,totalQuantity:e.total_quantity||0,totalValue:e.total_value||0,supplier:e.supplier_id?E.get(e.supplier_id):void 0,category:e.category_id?k.get(e.category_id):void 0,shelfId:e.shelf_id,storageRoomId:e.storage_room_id,shelfName:e.shelf_id?null==(t=P.get(e.shelf_id))?void 0:t.name:void 0,shelfCode:e.shelf_id?null==(a=P.get(e.shelf_id))?void 0:a.code:void 0,storageRoomName:void 0,createdAt:e.created_at,updatedAt:e.updated_at,variants:s.map(e=>({id:e.id,productId:e.product_id,sku:e.sku,name:e.variant_name||e.name||"Unnamed",attributes:e.variant_attributes||e.attributes||{},costPrice:e.cost_price||0,sellingPrice:e.selling_price||0,price:e.selling_price||0,stockQuantity:e.quantity||0,minStockLevel:e.min_quantity||0,quantity:e.quantity||0,minQuantity:e.min_quantity||0,weight:null,dimensions:null,createdAt:e.created_at,updatedAt:e.updated_at}))}});return C.filter(e=>e.supplier).length,C.filter(e=>!e.supplier&&e.supplierId).length,C.filter(e=>!e.supplierId).length,C}catch(iu){throw iu instanceof Error?new Error(`getProducts failed: ${iu.message}`):new Error("getProducts failed: Unknown error")}}(),{ttl:18e4,staleWhileRevalidate:!0}),{forceRefresh:null==e?void 0:e.forceRefresh})}const os=Object.freeze(Object.defineProperty({__proto__:null,createProduct:ss,deleteProduct:async function(e){const{error:t}=await $a.from("lats_products").delete().eq("id",e);if(t)throw t},getProduct:ns,getProducts:is,updateProduct:async function(e,t,a){try{r="^products:",as.invalidatePattern(r);const{data:a,error:s}=await $a.from("lats_products").select("id, name").eq("id",e).single();if(s)throw new Error(`Product with ID ${e} not found`);if(!a)throw new Error(`Product with ID ${e} does not exist in database`);const{images:n,variants:i,...o}=t,c={updated_at:(new Date).toISOString()};void 0!==o.name&&(c.name=o.name),void 0!==o.description&&(c.description=o.description),void 0!==o.categoryId&&(c.category_id=o.categoryId),void 0!==o.supplierId&&(c.supplier_id=o.supplierId),void 0!==o.tags&&(c.tags=o.tags),void 0!==o.isActive&&(c.is_active=o.isActive);const{error:l}=await $a.from("lats_products").update(c).eq("id",e);if(l)throw l;const{data:d,error:u}=await $a.from("lats_products").select("*").eq("id",e).single();if(u||!d)return{id:e,name:c.name||a.name,description:c.description||"",sku:c.sku||"",categoryId:c.category_id||"",supplierId:c.supplier_id,tags:c.tags||[],isActive:c.is_active??!0,isFeatured:!1,isDigital:!1,requiresShipping:!0,taxRate:0,totalQuantity:0,totalValue:0,createdAt:(new Date).toISOString(),updatedAt:c.updated_at};if(i&&Array.isArray(i)){const{data:t,error:a}=await $a.from("lats_product_variants").select("id, sku, variant_name").eq("product_id",e);if(a)throw a;const r=Array.isArray(t)?t:[],s=new Map(r.map(e=>[e.id,e]));for(let n=0;n<i.length;n++){const t=i[n];if(!t||!t.sku)continue;const a={product_id:e,variant_name:t.name||"Default",variant_attributes:t.attributes||{},cost_price:t.costPrice||0,selling_price:t.sellingPrice||t.price||0,quantity:t.quantity??t.stockQuantity??0,min_quantity:t.minQuantity??t.minStockLevel??0},o=t.id?s.get(t.id):null;if(o&&o.sku===t.sku||(a.sku=t.sku),t.id){const{error:e}=await $a.from("lats_product_variants").update(a).eq("id",t.id);if(e)throw e}else{const e=r.find(e=>e&&e.sku===t.sku);if(e&&e.id){const{error:t}=await $a.from("lats_product_variants").update(a).eq("id",e.id);if(t)throw t}else{a.sku||(a.sku=t.sku);const{error:e}=await $a.from("lats_product_variants").insert(a);if(e)throw e}}}if(r.length>i.length&&r.length>1){const e=i.map(e=>null==e?void 0:e.sku).filter(Boolean),t=r.filter(t=>t&&t.sku&&!e.includes(t.sku)).slice(0,Math.max(0,r.length-1));for(const a of t)if(a&&a.id){const{error:e}=await $a.from("lats_product_variants").delete().eq("id",a.id);if(e)throw e}}}if(!d||!d.id)throw new Error("Product update returned null or invalid product");return{id:d.id,name:d.name,description:d.description,sku:d.sku,categoryId:d.category_id,supplierId:d.supplier_id,tags:d.tags,isActive:d.is_active,isFeatured:d.is_featured,isDigital:d.is_digital,requiresShipping:d.requires_shipping,taxRate:d.tax_rate,totalQuantity:d.total_quantity,totalValue:d.total_value,createdAt:d.created_at,updatedAt:d.updated_at}}catch(iu){throw iu}var r}},Symbol.toStringTag,{value:"Module"})),cs=async()=>{try{const{data:e,error:t}=await $a.from("lats_categories").select("*").order("name");if(t)throw t;return e||[]}catch(iu){throw iu}},ls=async()=>{try{const{data:e,error:t}=await $a.from("lats_categories").select("*").eq("is_active",!0).order("sort_order").order("name");if(t)throw t;return e||[]}catch(iu){throw iu}},ds=async e=>{try{const{data:t,error:a}=await $a.from("lats_categories").insert([e]).select().single();if(a)throw a;return t}catch(iu){throw iu}},us=async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_categories").update({...t,updated_at:(new Date).toISOString()}).eq("id",e).select().single();if(r)throw r;return a}catch(iu){throw iu}},ms=async e=>{try{const{error:t}=await $a.from("lats_categories").delete().eq("id",e);if(t)throw t}catch(iu){throw iu}},hs=async e=>{try{const{data:t,error:a}=await $a.from("lats_categories").select("*").or(`name.ilike.%${e}%,description.ilike.%${e}%`).order("name");if(a)throw a;return t||[]}catch(iu){throw iu}},ps=async()=>{try{const{data:e,error:t}=await $a.from("lats_suppliers").select("*").order("name");if(t)throw new Error(`Failed to fetch suppliers: ${t.message}`);const a=(e||[]).filter(e=>!1!==e.is_active&&!0!==e.is_trade_in_customer);a.length;return a}catch(iu){throw iu}},gs=async()=>{try{const{data:e,error:t}=await $a.from("lats_suppliers").select("*").order("name");if(t)throw new Error("Failed to fetch suppliers");return(e||[]).filter(e=>!0!==e.is_trade_in_customer)}catch(iu){throw iu}},_s=async e=>{try{const t={...e};t.is_active=!0,Object.keys(t).forEach(e=>{void 0===t[e]&&delete t[e]});const{data:a,error:r}=await $a.from("lats_suppliers").insert(t).select().single();if(r)throw new Error(`Failed to create supplier: ${r.message}`);return a}catch(iu){throw iu}},fs=async(e,t)=>{try{const a={...t};Object.keys(a).forEach(e=>{void 0===a[e]&&delete a[e]});const{data:r,error:s}=await $a.from("lats_suppliers").update(a).eq("id",e).select().single();if(s)throw new Error(`Failed to update supplier: ${s.message}`);return r}catch(iu){throw iu}},ys=async e=>{try{const{data:t,error:a}=await $a.from("lats_purchase_orders").select("id").eq("supplier_id",e).limit(1);if(a)throw new Error(`Failed to check supplier references: ${a.message}`);if(t&&t.length>0)throw new Error("Cannot delete supplier: This supplier has associated purchase orders. Please delete or reassign the purchase orders first.");const{data:r,error:s}=await $a.from("lats_products").select("id").eq("supplier_id",e).limit(1);if(s)throw new Error(`Failed to check supplier references: ${s.message}`);if(r&&r.length>0)throw new Error("Cannot delete supplier: This supplier has associated products. Please delete or reassign the products first.");const{error:n}=await $a.from("lats_suppliers").delete().eq("id",e);if(n)throw new Error(`Failed to delete supplier: ${n.message}`)}catch(iu){throw iu}},vs=async e=>{try{const{data:t,error:a}=await $a.from("lats_suppliers").select("*").or(`name.ilike.%${e}%,contact_person.ilike.%${e}%`).order("name");if(a)throw new Error("Failed to search suppliers");return(t||[]).filter(e=>!1!==e.is_active&&!0!==e.is_trade_in_customer)}catch(iu){throw iu}},ws=Object.freeze(Object.defineProperty({__proto__:null,createSupplier:_s,deleteSupplier:ys,getActiveSuppliers:ps,getAllSuppliers:gs,getSuppliersByCountry:async e=>{try{const{data:t,error:a}=await $a.from("lats_suppliers").select("*").eq("country",e).order("name");if(a)throw new Error("Failed to fetch suppliers by country");return(t||[]).filter(e=>!1!==e.is_active&&!0!==e.is_trade_in_customer)}catch(iu){throw iu}},getSuppliersByPaymentTerms:async e=>{try{const{data:t,error:a}=await $a.from("lats_suppliers").select("*").eq("payment_terms",e).order("name");if(a)throw new Error("Failed to fetch suppliers by payment terms");return(t||[]).filter(e=>!1!==e.is_active&&!0!==e.is_trade_in_customer)}catch(iu){throw iu}},hardDeleteSupplier:async e=>{try{const{error:t}=await $a.from("lats_suppliers").delete().eq("id",e);if(t)throw new Error(`Failed to hard delete supplier: ${t.message}`)}catch(iu){throw iu}},searchSuppliers:vs,updateSupplier:fs},Symbol.toStringTag,{value:"Module"}));class bs{constructor(){this.errorHistory=[]}static getInstance(){return bs.instance||(bs.instance=new bs),bs.instance}logError(e,t,a={},r){const s={context:{operation:e,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href,...a},error:t,databaseError:r};this.errorHistory.push(s),this.errorHistory.length>100&&(this.errorHistory=this.errorHistory.slice(-100)),this.logToConsole(s),this.logToStorage(s)}logToConsole(e){const{context:t,error:a,databaseError:r}=e}logToStorage(e){try{const t=JSON.parse(localStorage.getItem("purchase_order_errors")||"[]");t.push(e);const a=t.slice(-50);localStorage.setItem("purchase_order_errors",JSON.stringify(a))}catch(iu){}}getUserFriendlyMessage(e,t){var a,r,s,n,i,o,c,l;if(e.code)switch(e.code){case"PGRST301":return"Database connection error: Please check your internet connection and try again";case"PGRST116":return"Resource not found: The requested purchase order does not exist";case"23505":return"Duplicate entry: This purchase order already exists";case"23503":return"Invalid reference: The supplier or product does not exist";case"23502":return"Missing required information: Please fill in all required fields";default:return`Database error (${e.code}): ${e.message}`}return(null==(a=e.message)?void 0:a.includes("Failed to fetch"))||(null==(r=e.message)?void 0:r.includes("ERR_CONNECTION_CLOSED"))?"Network error: Please check your internet connection and try again":(null==(s=e.message)?void 0:s.includes("timeout"))?"Request timeout: The server is taking too long to respond":(null==(n=e.message)?void 0:n.includes("permission"))||(null==(i=e.message)?void 0:i.includes("unauthorized"))?"Permission denied: You do not have access to this resource":(null==(o=e.message)?void 0:o.includes("not found"))?`The requested ${t.operation.replace("get_","").replace("_"," ")} was not found`:(null==(c=e.message)?void 0:c.includes("Invalid"))||(null==(l=e.message)?void 0:l.includes("validation"))?e.message:e.message||"An unexpected error occurred. Please try again."}getErrorHistory(){return[...this.errorHistory]}clearErrorHistory(){this.errorHistory=[],localStorage.removeItem("purchase_order_errors")}exportErrors(){return JSON.stringify(this.errorHistory,null,2)}}const Ss=(e,t,a={},r)=>{const s=bs.getInstance();return s.logError(e,t,a,r),s.getUserFriendlyMessage(t,{...a,operation:e,timestamp:"",userAgent:"",url:""})},xs=(e,t="Product ID")=>{if(!e)return{isValid:!1,error:`${t} is required`};if("string"!=typeof e)return{isValid:!1,error:`${t} must be a string, got ${typeof e}`};const a=e.trim();if(""===a)return{isValid:!1,error:`${t} cannot be empty or whitespace only`};return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)?{isValid:!0}:{isValid:!1,error:`${t} has invalid format: "${a}". Expected UUID format.`}};const ks=new class{constructor(){this.handlers=new Map,this.globalHandlers=[]}subscribe(e,t){return this.handlers.has(e)||this.handlers.set(e,[]),this.handlers.get(e).push(t),()=>{const a=this.handlers.get(e);if(a){const e=a.indexOf(t);e>-1&&a.splice(e,1)}}}subscribeToAll(e){return this.globalHandlers.push(e),()=>{const t=this.globalHandlers.indexOf(e);t>-1&&this.globalHandlers.splice(t,1)}}emit(e,t,a){const r={type:e,data:t,timestamp:(new Date).toISOString(),source:a},s=this.handlers.get(e);s&&s.forEach(e=>{try{e(r)}catch(iu){}}),this.globalHandlers.forEach(e=>{try{e(r)}catch(iu){}})}clear(){this.handlers.clear(),this.globalHandlers=[]}getHandlers(){const e={};return this.handlers.forEach((t,a)=>{e[a]=t.length}),e.global=this.globalHandlers.length,e}},Es=(e,t,a)=>{ks.emit("lats:stock.updated",{productId:e,variantId:t,quantity:a})},Is=e=>{ks.emit("lats:sale.completed",{sale:e})};class As{static async retryOperation(e,t,a=this.MAX_RETRIES,r){var s,n,i,o,c,l;try{return await e()}catch(iu){const m={operation:t,attempt:this.MAX_RETRIES-a+1,maxRetries:this.MAX_RETRIES,errorCode:null==iu?void 0:iu.code,errorMessage:null==iu?void 0:iu.message,errorDetails:null==iu?void 0:iu.details,errorHint:null==iu?void 0:iu.hint,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href},h=(null==(s=null==iu?void 0:iu.message)?void 0:s.includes("ERR_CONNECTION_CLOSED"))||(null==(n=null==iu?void 0:iu.message)?void 0:n.includes("Failed to fetch"))||(null==(i=null==iu?void 0:iu.message)?void 0:i.includes("net::ERR_CONNECTION_CLOSED"))||"PGRST301"===(null==iu?void 0:iu.code)||"PGRST116"===(null==iu?void 0:iu.code)||"PGRST301"===(null==iu?void 0:iu.code);(null==(o=null==iu?void 0:iu.code)?void 0:o.startsWith("PGRST"))||(null==(c=null==iu?void 0:iu.code)?void 0:c.startsWith("42"))||(null==(l=null==iu?void 0:iu.code)||l.startsWith("23"));if(a>1){const s=this.RETRY_DELAY*(this.MAX_RETRIES-a+1);return await new Promise(e=>setTimeout(e,s)),this.retryOperation(e,t,a-1,r)}if(r)try{return await r()}catch(d){}if(h)return[];const p=new Error(`Purchase Order Service Error: ${t} failed after ${this.MAX_RETRIES} attempts. Original error: ${iu.message}`);throw p.originalError=iu,p.context=m,p}}static async getMessages(e){return this.retryOperation(async()=>{const{data:t,error:a}=await $a.from("purchase_order_messages").select("*").eq("purchase_order_id",e).order("timestamp",{ascending:!1});if(a)throw a;return(t||[]).map(e=>({id:e.id,purchaseOrderId:e.purchase_order_id,sender:e.sender,content:e.content,type:e.type,timestamp:e.timestamp}))},"get_messages")}static async sendMessage(e){return this.retryOperation(async()=>{const{error:t}=await $a.from("purchase_order_messages").insert({purchase_order_id:e.purchaseOrderId,sender:e.sender,content:e.content,type:e.type,timestamp:(new Date).toISOString()});if(t)throw t;return!0},"send_message")}static async getPayments(e){return this.retryOperation(async()=>{const{data:t,error:a}=await $a.from("purchase_order_payments").select("id, purchase_order_id, payment_method, amount, currency, status, reference, payment_date, created_at").eq("purchase_order_id",e).order("created_at",{ascending:!1}).limit(100);if(a)throw a;return(t||[]).map(e=>({id:e.id,purchaseOrderId:e.purchase_order_id,method:e.payment_method,amount:e.amount,currency:e.currency,status:e.status,reference:e.reference,timestamp:e.payment_date||e.created_at}))},"get_payments")}static async addPayment(e){return this.retryOperation(async()=>{const{error:t}=await $a.from("purchase_order_payments").insert({purchase_order_id:e.purchaseOrderId,payment_method:e.method,amount:e.amount,currency:e.currency,status:e.status,reference:e.reference,payment_date:(new Date).toISOString()});if(t)throw t;return!0},"add_payment")}static async getAuditHistory(e){return this.retryOperation(async()=>{const{data:t,error:a}=await $a.from("purchase_order_audit").select("*").eq("purchase_order_id",e).order("timestamp",{ascending:!1});if(a)throw a;return(t||[]).map(e=>({id:e.id,purchaseOrderId:e.purchase_order_id,action:e.action,user:e.user_id||e.created_by,details:e.details,timestamp:e.timestamp}))},"get_audit_history")}static async addAuditEntry(e){try{let t=e.user;if(!t||""===t.trim()){const{data:{user:e},error:a}=await $a.auth.getUser();t=a?"system":e?e.id:"system"}const a="string"==typeof e.details?e.details:JSON.stringify(e.details),{data:r,error:s}=await $a.rpc("log_purchase_order_audit",{p_purchase_order_id:e.purchaseOrderId,p_action:e.action,p_details:a,p_user_id:t});if(s){const{error:r}=await $a.from("purchase_order_audit").insert({purchase_order_id:e.purchaseOrderId,action:e.action,user_id:t,created_by:t,details:a,timestamp:(new Date).toISOString()});if(r)return!1}return!0}catch(iu){return!1}}static async updateOrderStatus(e,t,a,r){return this.retryOperation(async()=>{const s={status:t,updated_at:(new Date).toISOString(),...r},{error:n}=await $a.from("lats_purchase_orders").update(s).eq("id",e);if(n)throw n;return await this.addAuditEntry({purchaseOrderId:e,action:`Status changed to ${t}`,user:a,details:JSON.stringify({message:`Order status updated to ${t}`,previous_status:(null==r?void 0:r.previous_status)||"unknown",new_status:t})}),{success:!0,message:"Order status updated successfully"}},"update_order_status")}static async loadShippedItems(e){return(async(e,t,a={})=>{try{return{success:!0,data:await e()}}catch(iu){return{success:!1,error:Ss(t,iu,a)}}})(async()=>{const t=xs(e,"Purchase Order ID");if(!t.isValid)throw new Error(t.error);const a=e.trim();return this.retryOperation(async()=>{var e,t;const{data:r,error:s}=await $a.from("lats_purchase_order_items").select("*").eq("purchase_order_id",a);if(s)throw Ss("load_shipped_items_main_query",s,{purchaseOrderId:a,operation:"load_shipped_items"},{code:s.code,message:s.message,details:s.details,hint:s.hint,table:"lats_purchase_order_items"}),s;if(!r||0===r.length)return[];const n=r.map(e=>e.product_id).filter(Boolean),i=r.map(e=>e.variant_id).filter(Boolean),[o,c]=await Promise.all([n.length>0?$a.from("lats_products").select("id, name, sku, description").in("id",n):Promise.resolve({data:[],error:null}),i.length>0?$a.from("lats_product_variants").select("id, name, variant_name, sku").in("id",i):Promise.resolve({data:[],error:null})]),l=new Map((null==(e=o.data)?void 0:e.map(e=>[e.id,e]))||[]),d=new Map((null==(t=c.data)?void 0:t.map(e=>[e.id,{...e,name:e.name||e.variant_name||"Unnamed"}]))||[]);return r.map((e,t)=>{const r=e.product_id?l.get(e.product_id):null,s=e.variant_id?d.get(e.variant_id):null;return e.product_id||Ss("missing_product_id",new Error("Missing product_id"),{purchaseOrderId:a,productId:e.product_id,variantId:e.variant_id,itemId:e.id}),e.variant_id||Ss("missing_variant_id",new Error("Missing variant_id"),{purchaseOrderId:a,productId:e.product_id,variantId:e.variant_id,itemId:e.id}),{...e,product:r,variant:s,name:(null==r?void 0:r.name)||(null==s?void 0:s.name)||"Unknown Product",sku:(null==r?void 0:r.sku)||(null==s?void 0:s.sku)||"N/A",description:(null==r?void 0:r.description)||"",productName:(null==r?void 0:r.name)||"Unknown Product",variantName:(null==s?void 0:s.name)||"Default Variant"}})},"load_shipped_items",this.MAX_RETRIES,async()=>{const{data:e,error:t}=await $a.from("lats_purchase_order_items").select("*").eq("purchase_order_id",a);if(t)throw Ss("load_shipped_items_fallback_query",t,{purchaseOrderId:a,operation:"load_shipped_items_fallback"},{code:t.code,message:t.message,details:t.details,table:"lats_purchase_order_items"}),t;return(e||[]).map((e,t)=>({...e,name:`Product ID: ${e.product_id||"Unknown"}`,sku:`SKU-${e.product_id||"Unknown"}`,description:"Product details not available",productName:`Product ID: ${e.product_id||"Unknown"}`,variantName:`Variant ID: ${e.variant_id||"Unknown"}`,product:null,variant:null}))})},"load_shipped_items",{purchaseOrderId:e}).then(e=>{if(e.success)return e.data||[];throw new Error(e.error)})}static async updateShippedItem(e,t){return this.retryOperation(async()=>{const{error:a}=await $a.from("lats_purchase_order_items").update(t).eq("id",e);if(a)throw a;return!0},"update_shipped_item")}static async markItemAsReceived(e,t,a){return this.retryOperation(async()=>{const{error:r}=await $a.from("lats_purchase_order_items").update({quantity_received:t,notes:a||null,updated_at:(new Date).toISOString()}).eq("id",e);if(r)throw r;return!0},"mark_item_received")}static async reportDamage(e,t){return this.retryOperation(async()=>{const{error:a}=await $a.from("lats_purchase_order_items").update({damage_report:t,status:"damaged",updated_at:(new Date).toISOString()}).eq("id",e);if(a)throw a;return!0},"report_damage")}static async updateReceivedQuantities(e,t,a){try{if(!t||0===t.length)return{success:!1,message:"No items provided for update",updatedItems:0};const{data:r,error:s}=await $a.from("lats_purchase_order_items").select("id, purchase_order_id, quantity_ordered, quantity_received").eq("purchase_order_id",e);if(s)return{success:!1,message:"Failed to fetch existing items",updatedItems:0};if(!r||0===r.length)return{success:!1,message:"No items found for this purchase order",updatedItems:0};const n=new Map(r.map(e=>[e.id,e])),i=[],o=[];for(const e of t){const t=n.get(e.id);t?e.receivedQuantity<0?o.push(`Item ${e.id}: Received quantity cannot be negative`):e.receivedQuantity>t.quantity?o.push(`Item ${e.id}: Received quantity (${e.receivedQuantity}) cannot exceed ordered quantity (${t.quantity})`):i.push({id:e.id,receivedQuantity:e.receivedQuantity,maxQuantity:t.quantity}):o.push(`Item ${e.id} not found in purchase order`)}if(o.length>0)return{success:!1,message:`Validation errors: ${o.join("; ")}`,updatedItems:0};if(0===i.length)return{success:!1,message:"No valid items found for update",updatedItems:0};let c=0;const l=[];for(const t of i){const{error:a}=await $a.from("lats_purchase_order_items").update({quantity_received:t.receivedQuantity,updated_at:(new Date).toISOString()}).eq("id",t.id).eq("purchase_order_id",e);a?l.push(`Item ${t.id}: ${a.message}`):c++}if(l.length>0&&0===c)return{success:!1,message:`All updates failed: ${l.join("; ")}`,updatedItems:0};const{data:d,error:u}=await $a.from("lats_purchase_order_items").select("id, quantity_received").eq("purchase_order_id",e).in("id",i.map(e=>e.id));if(u)return{success:!1,message:"Update completed but verification failed",updatedItems:i.length};const m=(null==d?void 0:d.filter(e=>i.find(t=>t.id===e.id&&t.receivedQuantity===e.quantity_received)).length)||0;return await this.processSerialNumbers(e,t,a),await this.createInventoryAdjustments(e,t,a),{success:!0,message:`Successfully updated ${m} items`,updatedItems:m}}catch(iu){return{success:!1,message:`Unexpected error: ${iu instanceof Error?iu.message:"Unknown error"}`,updatedItems:0}}}static async getPurchaseOrderItemsWithProducts(e){try{const{data:t,error:a}=await $a.rpc("get_purchase_order_items_with_products",{purchase_order_id_param:e});if(a)return{success:!1,message:"Failed to fetch purchase order items"};const r=(t||[]).map(e=>({id:e.id,productId:e.product_id,variantId:e.variant_id,quantity:e.quantity,costPrice:parseFloat(e.unit_cost.toString()),totalPrice:parseFloat(e.total_cost.toString()),receivedQuantity:e.received_quantity||0,notes:e.notes,createdAt:e.created_at,updatedAt:e.updated_at,product:{id:e.product_id,name:e.product_name,sku:e.product_sku},variant:{id:e.variant_id,name:e.variant_name,sku:e.variant_sku}}));return{success:!0,data:r,message:`Found ${r.length} purchase order items`}}catch(iu){return{success:!1,message:`Failed to fetch purchase order items: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async completePurchaseOrder(e,t,a){try{const{data:r,error:s}=await $a.rpc("complete_purchase_order",{purchase_order_id_param:e,user_id_param:t,completion_notes:a||"Purchase order completed"});if(s)throw s;let n=r;return Array.isArray(n)&&(n=n[0]),(null==n?void 0:n.complete_purchase_order)&&(n=n.complete_purchase_order),n&&!n.success?{success:!1,message:n.message||"Failed to complete purchase order",error_code:n.error_code,data:n}:{success:!0,data:(null==n?void 0:n.data)||n,message:(null==n?void 0:n.message)||"Purchase order completed successfully"}}catch(iu){return{success:!1,message:`Failed to complete purchase order: ${iu instanceof Error?iu.message:"Unknown error"}`,error_code:"NETWORK_ERROR"}}}static async checkCompletionStatus(e){try{const{data:t,error:a}=await $a.rpc("check_purchase_order_completion_status",{purchase_order_id_param:e});if(a)throw a;let r=t;return Array.isArray(r)&&(r=r[0]),(null==r?void 0:r.check_purchase_order_completion_status)&&(r=r.check_purchase_order_completion_status),{success:!0,data:(null==r?void 0:r.data)||r,message:(null==r?void 0:r.message)||"Completion status retrieved successfully"}}catch(iu){return{success:!1,message:`Failed to check completion status: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async fixReceivedQuantities(e,t){try{const{data:a,error:r}=await $a.rpc("fix_purchase_order_received_quantities",{purchase_order_id_param:e,user_id_param:t});if(r)throw r;return a&&!a.success?{success:!1,message:a.message||"Failed to fix received quantities"}:{success:!0,data:(null==a?void 0:a.data)||a,message:(null==a?void 0:a.message)||"Received quantities fixed successfully"}}catch(iu){return{success:!1,message:`Failed to fix received quantities: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async getReceivedItems(e){try{try{const t=await this.retryOperation(async()=>{var t,a;const{data:r,error:s}=await $a.rpc("get_received_items_for_po",{po_id:e});if(s){if((null==(t=s.message)?void 0:t.includes("function"))||(null==(a=s.message)?void 0:a.includes("does not exist")))throw new Error("RPC_FUNCTION_NOT_FOUND");throw s}return r},"get_received_items_for_po");if(t&&t.length>=0){const e=t.map(e=>{var t;return{id:e.id,product_id:e.product_id,variant_id:e.variant_id,serial_number:e.serial_number,item_number:e.item_number,imei:e.imei,mac_address:e.mac_address,barcode:e.barcode,status:e.status,location:e.location,shelf:e.shelf,bin:e.bin,purchase_date:e.purchase_date,warranty_start:e.warranty_start,warranty_end:e.warranty_end,cost_price:Number(e.cost_price)||0,selling_price:Number(e.selling_price)||0,notes:e.notes,metadata:e.metadata,created_at:e.created_at,product:{id:e.product_id,name:e.product_name,sku:e.product_sku},variant:{id:e.variant_id,name:e.variant_name,sku:e.variant_sku},item_type:"inventory_item",received_quantity:1,has_serial:!!e.serial_number,batch_number:(null==(t=e.metadata)?void 0:t.batch_number)||null}});return{success:!0,data:e,message:`Found ${e.length} received items`}}}catch(t){t.message}const a=[],r=await this.retryOperation(async()=>{var t,a;const{data:r,error:s}=await $a.from("inventory_items").select("id, product_id, variant_id, serial_number, item_number, mac_address, barcode, status, location, shelf, bin, purchase_date, warranty_start, warranty_end, cost_price, selling_price, notes, metadata, created_at").contains("metadata",{purchase_order_id:e}).order("created_at",{ascending:!1});if(s)throw s;if(!r||0===r.length)return[];const n=r.map(e=>e.product_id).filter(Boolean),i=r.map(e=>e.variant_id).filter(Boolean),[o,c]=await Promise.all([n.length>0?$a.from("lats_products").select("id, name, sku, category_id").in("id",n):Promise.resolve({data:[],error:null}),i.length>0?$a.from("lats_product_variants").select("id, name, variant_name, sku").in("id",i):Promise.resolve({data:[],error:null})]),l=new Map((null==(t=o.data)?void 0:t.map(e=>[e.id,e]))||[]),d=new Map((null==(a=c.data)?void 0:a.map(e=>[e.id,{...e,name:e.name||e.variant_name||"Unnamed"}]))||[]);return r.map(e=>({...e,product:e.product_id?l.get(e.product_id):null,variant:e.variant_id?d.get(e.variant_id):null}))},"get_inventory_items");if(r){const e=r.map(e=>{var t,a,r,s;return{id:e.id,product_id:e.product_id,variant_id:e.variant_id,serial_number:e.serial_number,item_number:e.item_number,imei:e.imei,mac_address:e.mac_address,barcode:e.barcode,status:e.status,location:e.location,shelf:e.shelf,bin:e.bin,purchase_date:e.purchase_date,warranty_start:e.warranty_start,warranty_end:e.warranty_end,cost_price:Number(e.cost_price)||0,selling_price:Number(e.selling_price)||0,notes:e.notes,created_at:e.created_at,product:{id:e.product_id,name:(null==(t=e.product)?void 0:t.name)||"Unknown Product",sku:(null==(a=e.product)?void 0:a.sku)||""},variant:{id:e.variant_id,name:(null==(r=e.variant)?void 0:r.name)||"",sku:(null==(s=e.variant)?void 0:s.sku)||""},item_type:"inventory_item",received_quantity:1,has_serial:!0}});a.push(...e)}const s=await this.retryOperation(async()=>{var t,a;const{data:r,error:s}=await $a.from("lats_inventory_adjustments").select("id, product_id, variant_id, quantity, cost_price, reason, adjustment_type, reference_id, created_at").eq("adjustment_type","receive").like("reason",`%purchase order ${e}%`).order("created_at",{ascending:!1});if(s)throw s;if(!r||0===r.length)return[];const n=r.map(e=>e.product_id).filter(Boolean),i=r.map(e=>e.variant_id).filter(Boolean),[o,c]=await Promise.all([n.length>0?$a.from("lats_products").select("id, name, sku").in("id",n):Promise.resolve({data:[],error:null}),i.length>0?$a.from("lats_product_variants").select("id, name, variant_name, sku").in("id",i):Promise.resolve({data:[],error:null})]),l=new Map((null==(t=o.data)?void 0:t.map(e=>[e.id,e]))||[]),d=new Map((null==(a=c.data)?void 0:a.map(e=>[e.id,{...e,name:e.name||e.variant_name||"Unnamed"}]))||[]);return r.map(e=>({...e,product:e.product_id?l.get(e.product_id):null,variant:e.variant_id?d.get(e.variant_id):null}))},"get_inventory_adjustments");if(s){const e=s.map(e=>{var t,a,r,s;return{id:e.id,product_id:e.product_id,variant_id:e.variant_id,serial_number:null,imei:null,mac_address:null,barcode:null,status:"received",location:null,shelf:null,bin:null,purchase_date:e.created_at,warranty_start:null,warranty_end:null,cost_price:e.cost_price,selling_price:null,notes:e.reason,created_at:e.created_at,product:{id:e.product_id,name:(null==(t=e.product)?void 0:t.name)||"Unknown Product",sku:(null==(a=e.product)?void 0:a.sku)||""},variant:{id:e.variant_id,name:(null==(r=e.variant)?void 0:r.name)||"",sku:(null==(s=e.variant)?void 0:s.sku)||""},item_type:"inventory_adjustment",received_quantity:e.quantity,has_serial:!1}});a.push(...e)}return a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),{success:!0,data:a,message:`Found ${a.length} received items (${a.filter(e=>"inventory_item"===e.item_type).length} inventory items, ${a.filter(e=>"inventory_adjustment"===e.item_type).length} adjustments)`}}catch(iu){return{success:!1,message:`Failed to fetch received items: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async completeReceive(e,t,a){try{const{data:r,error:s}=await $a.rpc("complete_purchase_order_receive",{purchase_order_id_param:e,user_id_param:t,receive_notes:a||null});if(s)return{success:!1,message:`Receive failed: ${s.message}`};if(r&&"object"==typeof r&&"success"in r&&!r.success)return{success:!1,message:r.message||"Receive operation failed"};const n=await this.getReceiveSummary(e);return ks.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:t,notes:a}),{success:!0,message:"Purchase order received successfully",summary:n.success?n.data:null}}catch(iu){return{success:!1,message:`Unexpected error: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async processReturn(e,t,a,r,s,n){try{const{data:i,error:o}=await $a.rpc("process_purchase_order_return",{purchase_order_id_param:e,item_id_param:t,return_type_param:a,return_quantity_param:r,return_reason_param:s,user_id_param:n});return o?{success:!1,message:`Return failed: ${o.message}`}:{success:!0,message:"Return processed successfully"}}catch(iu){return{success:!1,message:`Unexpected error: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async getReceiveSummary(e){try{const{data:t,error:a}=await $a.rpc("get_purchase_order_receive_summary",{purchase_order_id_param:e});return a?{success:!1,message:"Failed to get receive summary"}:{success:!0,data:(null==t?void 0:t[0])||null}}catch(iu){return{success:!1,message:`Unexpected error: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async getReturns(e){try{const{data:t,error:a}=await $a.rpc("get_purchase_order_returns",{purchase_order_id_param:e});return a?{success:!1,message:"Failed to get returns"}:{success:!0,data:t||[]}}catch(iu){return{success:!1,message:`Unexpected error: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async addQualityCheck(e,t,a){try{const{error:r}=await $a.from("purchase_order_quality_checks").insert({purchase_order_id:e,item_id:t,passed:a.passed,notes:a.notes,checked_by:a.checkedBy,timestamp:(new Date).toISOString()});if(r)throw r;return await this.addAuditEntry({purchaseOrderId:e,action:"Quality check",user:a.checkedBy,details:`Quality check ${a.passed?"passed":"failed"} for item ${t}`}),!0}catch(iu){return!1}}static async createInventoryAdjustments(e,t,a){try{const{data:r,error:s}=await $a.from("lats_purchase_order_items").select("id, product_id, variant_id, unit_cost").eq("purchase_order_id",e).in("id",t.map(e=>e.id));if(s)return;for(const n of t){if(n.serialNumbers&&n.serialNumbers.length>0)continue;if(n.receivedQuantity<=0)continue;const t=null==r?void 0:r.find(e=>e.id===n.id);if(!t)continue;const s=[];for(let r=0;r<n.receivedQuantity;r++)s.push({product_id:t.product_id,variant_id:t.variant_id,status:"pending_pricing",purchase_order_id:e,cost_price:t.unit_cost||0,selling_price:null,notes:`Received from purchase order ${e} - bulk item ${r+1}`,metadata:{purchase_order_id:e,purchase_order_item_id:n.id,received_by:a,received_at:(new Date).toISOString(),bulk_item:!0,bulk_index:r+1}});const{error:i}=await $a.from("inventory_items").insert(s)}}catch(iu){}}static async processSerialNumbers(e,t,a){try{const{data:r,error:n}=await $a.from("lats_purchase_order_items").select("\n          id, \n          product_id, \n          variant_id, \n          unit_cost,\n          product:lats_products(id, name, branch_id)\n        ").eq("purchase_order_id",e).in("id",t.map(e=>e.id));if(n)return;for(const i of t){if(!i.serialNumbers||0===i.serialNumbers.length)continue;const t=null==r?void 0:r.find(e=>e.id===i.id);if(!t)continue;const n=t.product;if(!n)continue;if(i.serialNumbers.some(e=>e.imei&&""!==e.imei.trim())){const r=i.serialNumbers.filter(e=>e.imei&&""!==e.imei.trim()).map(a=>({imei:a.imei,serial_number:a.serial_number,mac_address:a.mac_address,condition:a.condition||"new",cost_price:a.cost_price||t.unit_cost||0,selling_price:a.selling_price??null,location:a.location,warranty_start:a.warranty_start,warranty_end:a.warranty_end,notes:a.notes||`Received from PO ${e}`,source:"purchase"}));if(r.length>0&&t.variant_id){const{addIMEIsToParentVariant:e,convertToParentVariant:a}=await s(()=>import("./imeiVariantService-70cc7d17.js"),["assets/imeiVariantService-70cc7d17.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"]);await a(t.variant_id);const n=await e(t.variant_id,r);n.success&&n.failed}else if(r.length>0&&!t.variant_id){const{createParentVariant:e,addIMEIsToParentVariant:a}=await s(()=>import("./imeiVariantService-70cc7d17.js"),["assets/imeiVariantService-70cc7d17.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"]),i=await e({product_id:t.product_id,variant_name:"Default Variant",branch_id:n.branch_id,cost_price:r[0].cost_price,selling_price:r[0].selling_price});if(i.success&&i.data){(await a(i.data.id,r)).success}}const o=i.serialNumbers.filter(e=>!e.imei||""===e.imei.trim());o.length>0&&await this.createLegacyInventoryItems(e,t,o,a)}else await this.createLegacyInventoryItems(e,t,i.serialNumbers,a)}}catch(iu){}}static async createLegacyInventoryItems(e,t,a,r){try{const s=a.map(a=>({product_id:t.product_id,variant_id:t.variant_id,serial_number:a.serial_number,imei:a.imei||null,mac_address:a.mac_address||null,barcode:a.barcode||null,status:"available",purchase_order_id:e,location:a.location||null,warranty_start:a.warranty_start||null,warranty_end:a.warranty_end||null,cost_price:a.cost_price||t.unit_cost||0,selling_price:a.selling_price||null,notes:a.notes||`Received from purchase order ${e}`,metadata:{purchase_order_id:e,purchase_order_item_id:t.id,received_by:r,received_at:(new Date).toISOString(),warranty_months:a.warranty_months||12,system:"legacy"}})),{error:n}=await $a.from("inventory_items").insert(s)}catch(iu){}}static async fixOrderStatusIfNeeded(e,t){var a;try{const{data:t,error:a}=await $a.from("lats_purchase_orders").select("\n          id,\n          status\n        ").eq("id",e).single();if(a)return{success:!1,message:`Order query failed: ${a.message}`};if(!t)return{success:!1,message:"Order not found"};const{data:r,error:s}=await $a.from("lats_purchase_order_items").select("id, quantity_ordered, quantity_received").eq("purchase_order_id",e);if(s)return{success:!1,message:`Items query failed: ${s.message}`};if(!r||!Array.isArray(r)||0===r.length)return{success:!0,message:"Order has no items to check"};const n=r.some(e=>e.quantity_received>0);r.some(e=>e.quantity_received>=e.quantity_ordered);let i=t.status,o=!1;if("sent"===t.status&&n&&(i="received",o=!0),o){const{error:t}=await $a.from("lats_purchase_orders").update({status:i}).eq("id",e);return t?{success:!1,message:`Status update failed: ${t.message}`}:{success:!0,message:`Order status updated to ${i}`,statusChanged:!0}}return{success:!0,message:"Order status is correct"}}catch(iu){const s={purchaseOrderId:e,errorType:typeof iu,errorMessage:iu instanceof Error?iu.message:"Unknown error",errorStack:iu instanceof Error?iu.stack:void 0,errorConstructorName:null==(a=null==iu?void 0:iu.constructor)?void 0:a.name,errorKeys:iu?Object.keys(iu):[]};try{iu&&"object"==typeof iu&&Object.assign(s,{errorStringified:JSON.stringify(iu,null,2)})}catch(r){s.stringifyError="Could not stringify error"}let n="Unknown error occurred";return iu instanceof Error?n=iu.message:iu&&"object"==typeof iu&&"message"in iu?n=String(iu.message):"string"==typeof iu&&(n=iu),{success:!1,message:`Failed to fix order status: ${n}`}}}static async getPurchaseOrderInventoryStats(e){try{return{success:!0,data:{totalItems:0,receivedItems:0,pendingItems:0},message:"Inventory stats retrieved"}}catch(iu){return{success:!1,message:"Failed to get inventory stats"}}}static async updateInventoryItemStatus(e,t,a){try{return{success:!0,message:"Item status updated"}}catch(iu){return{success:!1,message:"Failed to update item status"}}}static async exportInventoryToCSV(e,t){try{return{success:!0,data:"csv-data-here",message:"Inventory exported to CSV"}}catch(iu){return{success:!1,message:"Failed to export inventory"}}}static async areAllItemsFullyReceived(e){try{return!1}catch(iu){return!1}}static async submitForApproval(e,t,a){try{const{data:r,error:s}=await $a.rpc("submit_po_for_approval",{purchase_order_id_param:e,user_id_param:t,approval_notes:a});if(s)throw s;return{success:!0,message:"Purchase order sent to supplier"}}catch(iu){return{success:!1,message:`Failed to send to supplier: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async markAsReceived(e,t,a){try{const{data:r,error:s}=await $a.rpc("mark_po_as_received",{purchase_order_id_param:e,user_id_param:t,received_notes:a});if(s)throw s;return ks.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:t,notes:a}),{success:!0,message:"Purchase order marked as received"}}catch(iu){return{success:!1,message:`Failed to mark as received: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async approvePurchaseOrder(e,t,a){try{const{data:r,error:s}=await $a.rpc("approve_po",{purchase_order_id_param:e,approver_id_param:t,approval_notes_param:a});if(s)throw s;return{success:!0,message:"Purchase order approved"}}catch(iu){return{success:!1,message:`Failed to approve purchase order: ${iu instanceof Error?iu.message:"Unknown error"}`}}}static async getReceivedItemsForPricing(e){var t,a;try{const{data:r,error:s}=await $a.from("inventory_items").select("id, product_id, variant_id, serial_number, cost_price, selling_price, location").eq("purchase_order_id",e).eq("status","pending_pricing");if(s)return[];if(!r||0===r.length)return[];const n=r.map(e=>e.product_id).filter(Boolean),i=r.map(e=>e.variant_id).filter(Boolean),[o,c]=await Promise.all([n.length>0?$a.from("lats_products").select("id, name").in("id",n):Promise.resolve({data:[],error:null}),i.length>0?$a.from("lats_product_variants").select("id, name, variant_name").in("id",i):Promise.resolve({data:[],error:null})]),l=new Map((null==(t=o.data)?void 0:t.map(e=>[e.id,e]))||[]),d=new Map((null==(a=c.data)?void 0:a.map(e=>[e.id,{...e,name:e.name||e.variant_name||"Unnamed"}]))||[]);return r.map(e=>{var t,a;return{inventory_item_id:e.id,product_name:e.product_id&&(null==(t=l.get(e.product_id))?void 0:t.name)||"Unknown Product",variant_name:e.variant_id&&(null==(a=d.get(e.variant_id))?void 0:a.name)||void 0,serial_number:e.serial_number||"",imei:e.imei,cost_price:e.cost_price||0,selling_price:e.selling_price,location:e.location}})}catch(iu){return[]}}static async updateItemsPrices(e,t){try{let t=0;for(const a of e){const{error:e}=await $a.from("inventory_items").update({selling_price:a.selling_price,status:"available",updated_at:(new Date).toISOString()}).eq("id",a.inventory_item_id);e||t++}return 0===t?{success:!1,message:"Failed to update any items",updatedItems:0}:(window.dispatchEvent(new CustomEvent("inventory-updated")),{success:!0,message:`Successfully updated ${t} item(s) with prices`,updatedItems:t})}catch(iu){return{success:!1,message:`Failed to update prices: ${iu instanceof Error?iu.message:"Unknown error"}`,updatedItems:0}}}static async hasPendingPricingItems(e){try{const{data:t,error:a}=await $a.from("inventory_items").select("id").eq("purchase_order_id",e).eq("status","pending_pricing").limit(1);return!a&&(t&&t.length>0||!1)}catch(iu){return!1}}static async rejectPurchaseOrder(e,t,a){try{const{data:r,error:s}=await $a.rpc("reject_po",{purchase_order_id_param:e,approver_id_param:t,rejection_reason:a});if(s)throw s;return{success:!0,message:"Purchase order rejected"}}catch(iu){return{success:!1,message:`Failed to reject purchase order: ${iu instanceof Error?iu.message:"Unknown error"}`}}}}As.MAX_RETRIES=3,As.RETRY_DELAY=1e3;const Ps=!0,Cs=!0,Ts=!0,js=!0,Ds=!0,Rs=()=>localStorage.getItem("current_branch_id"),Ls={getList:async(e,t)=>{try{let a=$a.from(e).select("*");if((null==t?void 0:t.filter)&&Object.entries(t.filter).forEach(([e,t])=>{a=a.eq(e,t)}),null==t?void 0:t.sort){const{field:e,order:r}=t.sort;a=a.order(e,{ascending:"ASC"===r})}if(null==t?void 0:t.pagination){const{page:e=1,perPage:r=10}=t.pagination,s=(e-1)*r,n=s+r-1;a=a.range(s,n)}return await a}catch(iu){return{data:null,error:iu}}},getOne:async(e,t)=>{try{return await $a.from(e).select("*").eq("id",t).single()}catch(iu){return{data:null,error:iu}}},create:async(e,t)=>{try{return await $a.from(e).insert(t)}catch(iu){return{data:null,error:iu}}},update:async(e,t,a)=>{try{return await $a.from(e).update(a).eq("id",t)}catch(iu){return{data:null,error:iu}}},delete:async(e,t)=>{try{return await $a.from(e).delete().eq("id",t)}catch(iu){return{data:null,error:iu}}},rpc:async(e,t)=>{try{return await $a.rpc(e,t)}catch(iu){return{data:null,error:iu}}},getCategories:async()=>{try{return{ok:!0,data:await cs()||[]}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch categories",data:[]}}},createCategory:async e=>{try{const{data:t,error:a}=await $a.from("lats_categories").insert({name:e.name,description:e.description,color:e.color,icon:e.icon,parent_id:e.parentId,is_active:e.isActive??!0}).select().single();if(a)throw a;return{ok:!0,data:{id:t.id,name:t.name,description:t.description,color:t.color,icon:t.icon,parentId:t.parent_id,isActive:t.is_active,createdAt:t.created_at,updatedAt:t.updated_at}}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to create category"}}},updateCategory:async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_categories").update({name:t.name,description:t.description,color:t.color,icon:t.icon,parent_id:t.parentId,is_active:t.isActive}).eq("id",e).select().single();if(r)throw r;return{ok:!0,data:{id:a.id,name:a.name,description:a.description,color:a.color,icon:a.icon,parentId:a.parent_id,isActive:a.is_active,createdAt:a.created_at,updatedAt:a.updated_at}}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to update category"}}},deleteCategory:async e=>{try{const{error:t}=await $a.from("lats_categories").delete().eq("id",e);if(t)throw t;return{ok:!0,data:null}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to delete category"}}},getSuppliers:async()=>{try{return{ok:!0,data:await gs()||[]}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch suppliers",data:[]}}},createSupplier:async e=>{try{const{data:t,error:a}=await $a.from("lats_suppliers").insert({name:e.name,contact_person:e.contactPerson,email:e.email,phone:e.phone,address:e.address,city:e.city,country:e.country,payment_terms:e.paymentTerms,is_active:e.isActive??!0,notes:e.notes}).select().single();if(a)throw a;return{ok:!0,data:{id:t.id,name:t.name,contactPerson:t.contact_person,email:t.email,phone:t.phone,address:t.address,city:t.city,country:t.country,paymentTerms:t.payment_terms,isActive:t.is_active,notes:t.notes,createdAt:t.created_at,updatedAt:t.updated_at}}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to create supplier"}}},updateSupplier:async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_suppliers").update({name:t.name,contact_person:t.contactPerson,email:t.email,phone:t.phone,address:t.address,city:t.city,country:t.country,payment_terms:t.paymentTerms,is_active:t.isActive,notes:t.notes}).eq("id",e).select().single();if(r)throw r;return{ok:!0,data:{id:a.id,name:a.name,contactPerson:a.contact_person,email:a.email,phone:a.phone,address:a.address,city:a.city,country:a.country,paymentTerms:a.payment_terms,isActive:a.is_active,notes:a.notes,createdAt:a.created_at,updatedAt:a.updated_at}}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to update supplier"}}},deleteSupplier:async e=>{try{const{data:t,error:a}=await $a.from("lats_purchase_orders").select("id").eq("supplier_id",e).limit(1);if(a)return{ok:!1,message:`Failed to check supplier references: ${a.message}`};if(t&&t.length>0)return{ok:!1,message:"Cannot delete supplier: This supplier has associated purchase orders. Please delete or reassign the purchase orders first."};const{data:r,error:s}=await $a.from("lats_products").select("id").eq("supplier_id",e).limit(1);if(s)return{ok:!1,message:`Failed to check supplier references: ${s.message}`};if(r&&r.length>0)return{ok:!1,message:"Cannot delete supplier: This supplier has associated products. Please delete or reassign the products first."};const{error:n}=await $a.from("lats_suppliers").delete().eq("id",e);if(n)throw n;return{ok:!0,data:null}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to delete supplier"}}},getProducts:async e=>{try{const t=await is();return{ok:!0,data:{data:t||[],page:(null==e?void 0:e.page)||1,limit:(null==e?void 0:e.limit)||100,total:(null==t?void 0:t.length)||0,totalPages:1}}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch products",data:{data:[],page:1,limit:100,total:0,totalPages:0}}}},getProduct:async e=>{try{return{ok:!0,data:await ns(e)}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch product"}}},getProductVariants:async e=>{try{const{data:t,error:a}=await $a.from("lats_product_variants").select("*").eq("product_id",e).is("parent_variant_id",null).order("variant_name");if(a)throw a;return{ok:!0,data:await Promise.all((t||[]).map(async e=>{let t=e.quantity||0;if(e.is_parent||"parent"===e.variant_type)try{const{data:a,error:r}=await $a.from("lats_product_variants").select("quantity, is_active").eq("parent_variant_id",e.id).eq("variant_type","imei_child").eq("is_active",!0);!r&&a&&(t=a.reduce((e,t)=>e+(t.quantity||0),0))}catch(a){}return{id:e.id,productId:e.product_id,name:e.variant_name||e.name||"Unnamed",sku:e.sku,attributes:e.attributes||e.variant_attributes||{},variant_attributes:e.variant_attributes||e.attributes||{},price:e.selling_price||0,costPrice:e.cost_price||0,sellingPrice:e.selling_price||0,stockQuantity:t,minStockLevel:e.min_quantity||0,quantity:t,minQuantity:e.min_quantity||0,isParent:e.is_parent||!1,variantType:e.variant_type||"standard",createdAt:e.created_at,updatedAt:e.updated_at}}))}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch product variants",data:[]}}},createProduct:async e=>{try{const{data:{user:t}}=await $a.auth.getUser();if(!t)return{ok:!1,message:"User not authenticated"};const a={name:e.name,description:e.description,shortDescription:e.shortDescription,sku:e.sku,categoryId:e.categoryId||null,supplierId:e.supplierId||null,costPrice:e.costPrice,sellingPrice:e.sellingPrice??e.price,price:e.price??e.sellingPrice,quantity:e.quantity??e.stockQuantity,stockQuantity:e.stockQuantity??e.quantity,minQuantity:e.minQuantity??e.minStockLevel,minStockLevel:e.minStockLevel??e.minQuantity,barcode:e.barcode,storageRoomId:e.storageRoomId,shelfId:e.shelfId,attributes:e.attributes,isActive:void 0===e.isActive||e.isActive,metadata:e.metadata,variants:e.variants&&e.variants.length>0?e.variants.map(e=>({sku:e.sku,name:e.name||"Default",sellingPrice:e.sellingPrice??e.price??0,costPrice:e.costPrice??0,quantity:e.quantity??e.stockQuantity??0,minQuantity:e.minQuantity??e.minStockLevel??0,attributes:e.attributes||{}})):void 0,images:e.images||[]},{createProduct:r}=await s(()=>Promise.resolve().then(()=>os),void 0),n=await r(a,t.id);if(!n||!n.id)return{ok:!1,message:"Product creation failed - database returned no data. This may be an RLS policy issue."};const i=await Ls.getProductVariants(n.id);return{ok:!0,data:{...n,variants:i.ok?i.data:[]},message:"Product created successfully"}}catch(iu){let t="Failed to create product";return(null==iu?void 0:iu.message)&&(t=iu.message),"23505"===(null==iu?void 0:iu.code)?t="Duplicate SKU detected. Please use a unique SKU.":"23503"===(null==iu?void 0:iu.code)?t="Invalid reference: Category or Supplier does not exist.":"42703"===(null==iu?void 0:iu.code)&&(t="Database column mismatch. Please contact support."),{ok:!1,message:t,error:iu}}},updateProduct:async(e,t)=>{try{const a={name:t.name,description:t.description,sku:t.sku,barcode:t.barcode,categoryId:t.categoryId,supplierId:t.supplierId||void 0,tags:t.tags||[],isActive:void 0===t.isActive||t.isActive,variants:t.variants?t.variants.map((e,t)=>({id:null==e?void 0:e.id,sku:null==e?void 0:e.sku,name:(null==e?void 0:e.name)||(null==e?void 0:e.variant_name)||"Default",attributes:(null==e?void 0:e.attributes)||{},costPrice:"number"==typeof(null==e?void 0:e.costPrice)?e.costPrice:(null==e?void 0:e.cost_price)??0,sellingPrice:"number"==typeof(null==e?void 0:e.sellingPrice)?e.sellingPrice:(null==e?void 0:e.selling_price)??(null==e?void 0:e.price)??0,quantity:"number"==typeof(null==e?void 0:e.quantity)?e.quantity:(null==e?void 0:e.stockQuantity)??0,minQuantity:"number"==typeof(null==e?void 0:e.minQuantity)?e.minQuantity:(null==e?void 0:e.minStockLevel)??0})):void 0},{updateProduct:r}=await s(()=>Promise.resolve().then(()=>os),void 0);return{ok:!0,data:await r(e,a,""),message:"Product updated successfully"}}catch(iu){let t="Failed to update product";return(null==iu?void 0:iu.message)&&(t=iu.message),"23505"===(null==iu?void 0:iu.code)?t="Duplicate SKU detected. Each variant must have a unique SKU.":"23503"===(null==iu?void 0:iu.code)?t="Invalid reference: Category or Supplier does not exist.":"42703"===(null==iu?void 0:iu.code)&&(t="Database column mismatch. Please contact support."),{ok:!1,message:t}}},updateProductVariantCostPrice:async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_product_variants").update({cost_price:t}).eq("id",e).select().single();if(r)throw r;return{ok:!0,data:a}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to update variant cost price"}}},deleteProduct:async e=>{try{const{error:t}=await $a.from("lats_products").delete().eq("id",e);if(t)throw t;return{ok:!0,data:null}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to delete product"}}},searchProducts:async e=>{try{const{data:t,error:a}=await $a.from("lats_products").select("*").or(`name.ilike.%${e}%,sku.ilike.%${e}%`).limit(20);if(a)throw a;if(!t||0===t.length)return{ok:!0,data:[]};const r=t.map(e=>e.id),s=[...new Set(t.map(e=>e.category_id).filter(Boolean))],n=[...new Set(t.map(e=>e.supplier_id).filter(Boolean))],{data:i}=r.length>0?await $a.from("lats_product_variants").select("*").in("product_id",r):{data:[]},{data:o}=s.length>0?await $a.from("lats_categories").select("id, name").in("id",s):{data:[]},{data:c}=n.length>0?await $a.from("lats_suppliers").select("id, name").in("id",n):{data:[]},l=(i||[]).reduce((e,t)=>(e[t.product_id]||(e[t.product_id]=[]),e[t.product_id].push(t),e),{}),d=(o||[]).reduce((e,t)=>(e[t.id]=t,e),{}),u=(c||[]).reduce((e,t)=>(e[t.id]=t,e),{});return{ok:!0,data:t.map(e=>{var t,a,r,s;const n=l[e.id]||[];return{id:e.id,name:e.name,sku:e.sku,categoryId:e.category_id,categoryName:null==(t=d[e.category_id])?void 0:t.name,supplierId:e.supplier_id,supplierName:null==(a=u[e.supplier_id])?void 0:a.name,price:(null==(r=n[0])?void 0:r.selling_price)||0,costPrice:(null==(s=n[0])?void 0:s.cost_price)||0,totalQuantity:e.total_quantity,variants:n.map(e=>({id:e.id,name:e.name,sku:e.sku,sellingPrice:e.selling_price||0,costPrice:e.cost_price,stockQuantity:e.quantity,quantity:e.quantity,barcode:e.barcode,variant_name:e.variant_name,variant_attributes:e.variant_attributes||e.attributes||{},attributes:e.attributes||e.variant_attributes||{}}))}})}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to search products",data:[]}}},adjustStock:async(e,t,a,r,s)=>{try{const{data:n,error:i}=await $a.from("lats_stock_movements").insert({product_id:e,variant_id:t,quantity:a,movement_type:a>0?"in":"out",reason:r,reference:s}).select().single();if(i)throw i;return{ok:!0,data:n}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to adjust stock"}}},getStockMovements:async e=>{try{let t=$a.from("lats_stock_movements").select("*").order("created_at",{ascending:!1});e&&(t=t.eq("product_id",e));const{data:a,error:r}=await t.limit(100);if(r)throw r;return{ok:!0,data:a||[]}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch stock movements",data:[]}}},getPurchaseOrders:async()=>{try{const e=Rs();let t=$a.from("lats_purchase_orders").select("*").order("created_at",{ascending:!1});Ps&&e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;if(r)return{ok:!1,message:r.message,data:[]};const s=(null==a?void 0:a.map(e=>e.id))||[];let n=new Map;if(s.length>0){const{data:e,error:t}=await $a.from("lats_purchase_order_items").select("purchase_order_id, id, quantity_ordered").in("purchase_order_id",s);!t&&e&&e.forEach(e=>{const t=e.purchase_order_id,a=n.get(t)||{count:0,totalQuantity:0,items:[]};a.count+=1,a.totalQuantity+=e.quantity_ordered||0,a.items.push({id:e.id,quantity:e.quantity_ordered||0}),n.set(t,a)})}const i=new Map,o=[...new Set((a||[]).map(e=>e.supplier_id).filter(Boolean))];if(o.length>0){const{data:e,error:t}=await $a.from("lats_suppliers").select("id, name, contact_person, email, phone").in("id",o);!t&&e&&e.forEach(e=>{i.set(e.id,e)})}return{ok:!0,data:(a||[]).map(e=>{const t=n.get(e.id)||{count:0,totalQuantity:0,items:[]},a="string"==typeof e.total_amount?parseFloat(e.total_amount)||0:e.total_amount||0,r="string"==typeof e.total_paid?parseFloat(e.total_paid)||0:e.total_paid||0,s="string"==typeof e.exchange_rate?parseFloat(e.exchange_rate)||void 0:e.exchange_rate,o="string"==typeof e.total_amount_base_currency?parseFloat(e.total_amount_base_currency)||void 0:e.total_amount_base_currency,c=e.supplier_id?i.get(e.supplier_id):void 0;return{id:e.id,orderNumber:e.po_number,supplierId:e.supplier_id,status:e.status,totalAmount:a,currency:e.currency||"TZS",notes:e.notes,orderDate:e.order_date,expectedDeliveryDate:e.expected_delivery_date,receivedDate:e.received_date,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:e.created_by,paymentStatus:e.payment_status,paymentTerms:e.payment_terms,totalPaid:r,exchangeRate:s,exchangeRateSource:e.exchange_rate_source,totalAmountBaseCurrency:o,supplier:c,items:t.items.map(e=>({id:e.id,quantity:e.quantity}))}})}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch purchase orders",data:[]}}},getPurchaseOrder:async e=>{try{const{data:t,error:a}=await $a.from("lats_purchase_orders").select("*").eq("id",e).single();if(a)return{ok:!1,message:a.message};let r=null;if(t.supplier_id){const{data:e,error:a}=await $a.from("lats_suppliers").select("*").eq("id",t.supplier_id).single();!a&&e&&(r=e)}const{data:s,error:n}=await $a.from("lats_purchase_order_items").select("*").eq("purchase_order_id",e);if(n)return{ok:!1,message:n.message};const i=[...new Set((s||[]).map(e=>e.product_id).filter(Boolean))],o=[...new Set((s||[]).map(e=>e.variant_id).filter(Boolean))];let c=new Map,l=new Map;if(i.length>0){const{data:e}=await $a.from("lats_products").select("*").in("id",i);null==e||e.forEach(e=>c.set(e.id,e))}if(o.length>0){const{data:e}=await $a.from("lats_product_variants").select("*").in("id",o);null==e||e.forEach(e=>{l.set(e.id,{...e,name:e.variant_name||e.name||"Default Variant"})})}return{ok:!0,data:{id:t.id,orderNumber:t.po_number,supplierId:t.supplier_id,status:t.status,totalAmount:t.total_amount||0,currency:t.currency||"TZS",notes:t.notes,orderDate:t.order_date,expectedDeliveryDate:t.expected_delivery_date,receivedDate:t.received_date,createdAt:t.created_at,updatedAt:t.updated_at,createdBy:t.created_by,paymentStatus:t.payment_status,paymentTerms:t.payment_terms,totalPaid:t.total_paid||0,exchangeRate:t.exchange_rate,exchangeRateSource:t.exchange_rate_source,totalAmountBaseCurrency:t.total_amount_base_currency,supplier:r?{id:r.id,name:r.name,contactPerson:r.contact_person,email:r.email,phone:r.phone,address:r.address,city:r.city,country:r.country,currency:r.currency,paymentTerms:r.payment_terms,isActive:r.is_active,notes:r.notes,createdAt:r.created_at,updatedAt:r.updated_at}:null,items:(null==s?void 0:s.map(e=>{const t=e.quantity_ordered||0,a=e.unit_cost||0,r=t*a;return{id:e.id,purchaseOrderId:e.purchase_order_id,productId:e.product_id,variantId:e.variant_id,quantity:t,quantityOrdered:t,receivedQuantity:e.quantity_received||0,costPrice:a,cost_price:a,unitCost:a,totalPrice:r,subtotal:r,status:e.status||"pending",notes:e.notes,createdAt:e.created_at,updatedAt:e.updated_at,product:c.get(e.product_id),variant:l.get(e.variant_id)}}))||[]}}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch purchase order"}}},createPurchaseOrder:async e=>{try{const a=e.po_number||`PO-${Date.now()}`,r=e.items.reduce((e,t)=>e+t.quantity*t.costPrice,0),s=e.exchangeRate||1,n=r*s,i=Rs(),{data:o,error:c}=await $a.from("lats_purchase_orders").insert({po_number:a,supplier_id:e.supplierId,status:e.status||"draft",total_amount:r,currency:e.currency||"TZS",payment_terms:e.paymentTerms||null,exchange_rate:s,base_currency:e.baseCurrency||"TZS",exchange_rate_source:e.exchangeRateSource||"manual",exchange_rate_date:e.exchangeRateDate||(new Date).toISOString(),total_amount_base_currency:n,notes:e.notes||"",order_date:e.orderDate||(new Date).toISOString(),expected_delivery_date:e.expectedDelivery||null,created_by:e.createdBy||null,branch_id:Ps?i:null}).select().single();if(c)return{ok:!1,message:c.message};const l=e.items.map(e=>({purchase_order_id:o.id,product_id:e.productId,variant_id:e.variantId,quantity_ordered:e.quantity,quantity_received:0,unit_cost:e.costPrice,subtotal:e.quantity*e.costPrice})),{data:d,error:u}=await $a.from("lats_purchase_order_items").insert(l).select();if(u)return await $a.from("lats_purchase_orders").delete().eq("id",o.id),{ok:!1,message:`Failed to create items: ${u.message}`};try{await As.addAuditEntry({purchaseOrderId:o.id,action:"Purchase Order Created",user:e.createdBy||"",details:`Purchase order ${a} created with ${l.length} items. Total: ${r}. Status: ${e.status||"draft"}`})}catch(t){}return{ok:!0,data:{...o,items:d||l},message:"Purchase order created successfully"}}catch(iu){return{ok:!1,message:iu.message||iu.toString()||"Failed to create purchase order"}}},updatePurchaseOrder:async(e,t)=>{try{const r={status:t.status,notes:t.notes,expected_delivery_date:t.expectedDelivery,updated_at:(new Date).toISOString()};if(t.currency&&(r.currency=t.currency),t.paymentTerms&&(r.payment_terms=t.paymentTerms),t.exchangeRate&&(r.exchange_rate=t.exchangeRate),t.baseCurrency&&(r.base_currency=t.baseCurrency),t.exchangeRateSource&&(r.exchange_rate_source=t.exchangeRateSource),t.exchangeRateDate&&(r.exchange_rate_date=t.exchangeRateDate),t.items&&t.exchangeRate){const e=t.items.reduce((e,t)=>e+t.quantity*t.costPrice,0);r.total_amount=e,r.total_amount_base_currency=e*t.exchangeRate}const{data:s,error:n}=await $a.from("lats_purchase_orders").update(r).eq("id",e).select().single();if(n)return{ok:!1,message:n.message};try{const a=[];t.status&&a.push(`Status: ${t.status}`),t.notes&&a.push("Notes updated"),t.expectedDelivery&&a.push(`Expected delivery: ${t.expectedDelivery}`),t.currency&&a.push(`Currency: ${t.currency}`),t.exchangeRate&&a.push(`Exchange rate: ${t.exchangeRate}`),t.paymentTerms&&a.push(`Payment terms: ${t.paymentTerms}`),await As.addAuditEntry({purchaseOrderId:e,action:"Purchase Order Updated",user:t.updatedBy||"",details:`Purchase order updated. Changes: ${a.join(", ")}`})}catch(a){}return{ok:!0,data:s,message:"Purchase order updated successfully"}}catch(iu){return{ok:!1,message:iu.message||"Failed to update purchase order"}}},receivePurchaseOrder:async e=>{try{const{data:{user:t}}=await $a.auth.getUser();if(!t)return{ok:!1,message:"User not authenticated"};const{data:a,error:r}=await $a.rpc("complete_purchase_order_receive",{purchase_order_id_param:e,user_id_param:t.id,receive_notes:"Received via PO system"});if(r)return{ok:!1,message:r.message||"Failed to receive purchase order"};ks.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:t.id,notes:"Received via PO system"});const{data:s,error:n}=await $a.from("lats_purchase_orders").select("*").eq("id",e).single();if(n)return{ok:!0,message:"Purchase order received successfully"};if(s&&s.supplier_id){const{data:e}=await $a.from("lats_suppliers").select("*").eq("id",s.supplier_id).single();e&&(s.supplier=e)}return{ok:!0,data:s}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Unknown error occurred"}}},deletePurchaseOrder:async e=>({ok:!1,message:"Not implemented"}),getSpareParts:async()=>{try{const{data:e,error:t}=await $a.from("lats_spare_parts").select("*").eq("is_active",!0).order("name",{ascending:!0});if(t)return{ok:!1,message:t.message||"Failed to fetch spare parts"};if(!e||0===e.length)return{ok:!0,data:[]};const a=[...new Set(e.map(e=>e.category_id).filter(Boolean))],r=[...new Set(e.map(e=>e.supplier_id).filter(Boolean))],s=e.map(e=>e.id),[n,i,o]=await Promise.all([a.length>0?$a.from("lats_categories").select("id, name").in("id",a):Promise.resolve({data:[]}),r.length>0?$a.from("lats_suppliers").select("id, name, email, phone").in("id",r):Promise.resolve({data:[]}),s.length>0?$a.from("lats_spare_part_variants").select("*").in("spare_part_id",s):Promise.resolve({data:[]})]),c=(n.data||[]).reduce((e,t)=>(e[t.id]=t,e),{}),l=(i.data||[]).reduce((e,t)=>(e[t.id]=t,e),{}),d=(o.data||[]).reduce((e,t)=>(e[t.spare_part_id]||(e[t.spare_part_id]=[]),e[t.spare_part_id].push(t),e),{});return{ok:!0,data:e.map(e=>({...e,category:c[e.category_id],supplier:l[e.supplier_id],variants:d[e.id]||[]}))}}catch(iu){return{ok:!1,message:"Failed to fetch spare parts"}}},getSparePart:async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_parts").select("*").eq("id",e).single();if(a)return{ok:!1,message:a.message||"Failed to fetch spare part"};const[r,s,n]=await Promise.all([t.category_id?$a.from("lats_categories").select("id, name").eq("id",t.category_id).single():Promise.resolve({data:null}),t.supplier_id?$a.from("lats_suppliers").select("id, name, email, phone").eq("id",t.supplier_id).single():Promise.resolve({data:null}),$a.from("lats_spare_part_variants").select("*").eq("spare_part_id",e)]);return{ok:!0,data:{...t,category:r.data,supplier:s.data,variants:n.data||[]}}}catch(iu){return{ok:!1,message:"Failed to fetch spare part"}}},createSparePart:async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_parts").insert(e).select().single();return a?{ok:!1,message:a.message||"Failed to create spare part"}:{ok:!0,data:t}}catch(iu){return{ok:!1,message:"Failed to create spare part"}}},updateSparePart:async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_spare_parts").update({...t,updated_at:(new Date).toISOString()}).eq("id",e).select().single();return r?{ok:!1,message:r.message||"Failed to update spare part"}:{ok:!0,data:a}}catch(iu){return{ok:!1,message:"Failed to update spare part"}}},deleteSparePart:async e=>{try{const{error:t}=await $a.from("lats_spare_parts").delete().eq("id",e);return t?{ok:!1,message:t.message||"Failed to delete spare part"}:{ok:!0}}catch(iu){return{ok:!1,message:"Failed to delete spare part"}}},useSparePart:async e=>{try{const{data:{user:t}}=await $a.auth.getUser();if(!t)return{ok:!1,message:"User not authenticated"};const{data:a,error:r}=await $a.from("lats_spare_part_usage").insert({...e,used_by:t.id,created_at:(new Date).toISOString()}).select().single();if(r)return{ok:!1,message:r.message||"Failed to record spare part usage"};const{error:s}=await $a.from("lats_spare_parts").update({quantity:$a.raw("quantity - ?",[e.quantity]),updated_at:(new Date).toISOString()}).eq("id",e.spare_part_id);return s?{ok:!1,message:"Failed to update spare part quantity"}:{ok:!0,data:a}}catch(iu){return{ok:!1,message:"Failed to use spare part"}}},getSparePartUsage:async()=>{try{const{data:e,error:t}=await $a.from("lats_spare_part_usage").select("*").order("created_at",{ascending:!1});if(t)return{ok:!1,message:t.message||"Failed to fetch spare part usage"};if(!e||0===e.length)return{ok:!0,data:[]};const a=[...new Set(e.map(e=>e.spare_part_id).filter(Boolean))],r=[...new Set(e.map(e=>e.device_id).filter(Boolean))],[s,n]=await Promise.all([a.length>0?$a.from("lats_spare_parts").select("id, name, part_number").in("id",a):Promise.resolve({data:[]}),r.length>0?$a.from("devices").select("id, device_name, customer_name").in("id",r):Promise.resolve({data:[]})]),i=(s.data||[]).reduce((e,t)=>(e[t.id]=t,e),{}),o=(n.data||[]).reduce((e,t)=>(e[t.id]=t,e),{});return{ok:!0,data:e.map(e=>({...e,spare_part:i[e.spare_part_id],device:o[e.device_id]}))}}catch(iu){return{ok:!1,message:"Failed to fetch spare part usage"}}},getCart:async()=>({ok:!0,data:null}),addToCart:async e=>({ok:!1,message:"Not implemented"}),updateCartItem:async(e,t)=>({ok:!1,message:"Not implemented"}),removeFromCart:async e=>({ok:!1,message:"Not implemented"}),clearCart:async()=>({ok:!0,data:null}),processSale:async e=>({ok:!1,message:"Not implemented"}),getSales:async()=>{try{const e=Rs();let t=$a.from("lats_sales").select("\n          id,\n          sale_number,\n          customer_id,\n          customer_name,\n          subtotal,\n          total_amount,\n          discount_amount,\n          tax_amount,\n          payment_method,\n          payment_status,\n          status,\n          sold_by,\n          user_id,\n          notes,\n          created_at,\n          updated_at,\n          branch_id\n        ").order("created_at",{ascending:!1}).limit(500);Cs&&e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;return r?{ok:!1,message:r.message,data:[]}:{ok:!0,data:a||[]}}catch(iu){return{ok:!1,message:iu instanceof Error?iu.message:"Failed to fetch sales",data:[]}}},getSale:async e=>({ok:!1,message:"Not implemented"}),getPOSSettings:async()=>({ok:!0,data:{}}),updatePOSSettings:async e=>({ok:!0,data:e}),getInventoryStats:async()=>({ok:!0,data:{}}),getSalesStats:async()=>({ok:!0,data:{}}),getLowStockItems:async()=>({ok:!0,data:[]}),getAllSaleItems:async()=>({ok:!0,data:[]}),getShippingAgents:async()=>({ok:!0,data:[]}),getShippingAgent:async e=>({ok:!1,message:"Not implemented"}),createShippingAgent:async e=>({ok:!1,message:"Not implemented"}),updateShippingAgent:async(e,t)=>({ok:!1,message:"Not implemented"}),deleteShippingAgent:async e=>({ok:!1,message:"Not implemented"}),toggleShippingAgentStatus:async e=>({ok:!1,message:"Not implemented"}),getShippingManagers:async()=>({ok:!0,data:[]}),getDevices:async()=>{try{const e=Rs();let t=$a.from("devices").select("*").order("created_at",{ascending:!1});Ts&&e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;return r?{ok:!1,message:r.message,data:[]}:{ok:!0,data:a||[]}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch devices",data:[]}}},getDevice:async e=>{try{const{data:t,error:a}=await $a.from("devices").select("*").eq("id",e).single();return a?{ok:!1,message:a.message}:{ok:!0,data:t}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch device"}}},createDevice:async e=>{try{const t=Rs(),a={...e,branch_id:Ts?t||"00000000-0000-0000-0000-000000000001":null},{data:r,error:s}=await $a.from("devices").insert(a).select().single();return s?{ok:!1,message:s.message}:{ok:!0,data:r}}catch(iu){return{ok:!1,message:iu.message||"Failed to create device"}}},updateDevice:async(e,t)=>{try{const{data:a,error:r}=await $a.from("devices").update(t).eq("id",e).select().single();return r?{ok:!1,message:r.message}:{ok:!0,data:a}}catch(iu){return{ok:!1,message:iu.message||"Failed to update device"}}},deleteDevice:async e=>{try{const{error:t}=await $a.from("devices").delete().eq("id",e);return t?{ok:!1,message:t.message}:{ok:!0}}catch(iu){return{ok:!1,message:iu.message||"Failed to delete device"}}},getRepairParts:async e=>{try{const t=Rs();let a=$a.from("repair_parts").select("*").eq("device_id",e);Ts&&t&&(a=a.eq("branch_id",t));const{data:r,error:s}=await a;return s?{ok:!1,message:s.message,data:[]}:{ok:!0,data:r||[]}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch repair parts",data:[]}}},getCustomerPayments:async e=>{try{const t=Rs();let a=$a.from("customer_payments").select("*").order("payment_date",{ascending:!1});(null==e?void 0:e.customer_id)&&(a=a.eq("customer_id",e.customer_id)),(null==e?void 0:e.device_id)&&(a=a.eq("device_id",e.device_id)),js&&t&&(a=a.eq("branch_id",t));const{data:r,error:s}=await a;return s?{ok:!1,message:s.message,data:[]}:{ok:!0,data:r||[]}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch customer payments",data:[]}}},createCustomerPayment:async e=>{try{const t=Rs(),a={...e,branch_id:js?t||"00000000-0000-0000-0000-000000000001":null},{data:r,error:s}=await $a.from("customer_payments").insert(a).select().single();return s?{ok:!1,message:s.message}:{ok:!0,data:r}}catch(iu){return{ok:!1,message:iu.message||"Failed to create payment"}}},getDeviceStatistics:async()=>{var e,t,a,r;try{const s=Rs();let n=$a.from("devices");const i=e=>{let t=n.select("id",{count:"exact"});return Ts&&s&&(t=t.eq("branch_id",s)),e&&(t=t.eq("status",e)),t},[o,c,l,d]=await Promise.all([i(),i("pending"),i("in-progress"),i("completed")]);return{ok:!0,data:{total:(null==(e=o.data)?void 0:e.length)||0,pending:(null==(t=c.data)?void 0:t.length)||0,inProgress:(null==(a=l.data)?void 0:a.length)||0,completed:(null==(r=d.data)?void 0:r.length)||0}}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch device statistics",data:{total:0,pending:0,inProgress:0,completed:0}}}},getTechnicians:async()=>{try{const e=Rs();let t=$a.from("users").select("*").in("role",["technician","tech","admin","manager"]).eq("is_active",!0).order("full_name");Ds&&e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;return r?{ok:!1,message:r.message,data:[]}:{ok:!0,data:a||[]}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch technicians",data:[]}}},getUsers:async e=>{try{const t=Rs();let a=$a.from("users").select("*").eq("is_active",!0).order("full_name");(null==e?void 0:e.role)&&(a=a.eq("role",e.role)),Ds&&t&&(a=a.eq("branch_id",t));const{data:r,error:s}=await a;return s?{ok:!1,message:s.message,data:[]}:{ok:!0,data:r||[]}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch users",data:[]}}},createUser:async e=>{try{const t=Rs(),a={...e,branch_id:Ds?t||"00000000-0000-0000-0000-000000000001":null},{data:r,error:s}=await $a.from("users").insert(a).select().single();return s?{ok:!1,message:s.message}:{ok:!0,data:r}}catch(iu){return{ok:!1,message:iu.message||"Failed to create user"}}},updateUser:async(e,t)=>{try{const{data:a,error:r}=await $a.from("users").update(t).eq("id",e).select().single();return r?{ok:!1,message:r.message}:{ok:!0,data:a}}catch(iu){return{ok:!1,message:iu.message||"Failed to update user"}}},deleteUser:async e=>{try{const{error:t}=await $a.from("users").update({is_active:!1}).eq("id",e);return t?{ok:!1,message:t.message}:{ok:!0}}catch(iu){return{ok:!1,message:iu.message||"Failed to deactivate user"}}},getUserStatistics:async()=>{try{const e=Rs();let t=$a.from("users").select("id, role",{count:"exact"}).eq("is_active",!0);Ds&&e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;if(r)return{ok:!1,message:r.message,data:{total:0,technicians:0,admins:0,managers:0,customerCare:0}};return{ok:!0,data:{total:(null==a?void 0:a.length)||0,technicians:(null==a?void 0:a.filter(e=>"technician"===e.role||"tech"===e.role).length)||0,admins:(null==a?void 0:a.filter(e=>"admin"===e.role).length)||0,managers:(null==a?void 0:a.filter(e=>"manager"===e.role).length)||0,customerCare:(null==a?void 0:a.filter(e=>"customer-care"===e.role).length)||0}}}catch(iu){return{ok:!1,message:iu.message||"Failed to fetch user statistics",data:{total:0,technicians:0,admins:0,managers:0,customerCare:0}}}}},Os=()=>Ls;const qs=new class{constructor(){this.enableLogging=!1}track(e,t){this.enableLogging}async getInventoryStats(){try{const{data:e,error:t}=await $a.rpc("get_inventory_stats");return t?null:e}catch(iu){return null}}async getSalesStats(){try{const{data:e,error:t}=await $a.rpc("get_sales_stats");return t?null:e}catch(iu){return null}}async getTopProducts(e=5){try{const{data:t,error:a}=await $a.from("lats_sale_items").select("\n          quantity,\n          total_price,\n          product_id\n        ").order("total_price",{ascending:!1}).limit(e);return a?[]:(null==t?void 0:t.map(e=>{var t;return{name:`Product ${(null==(t=e.product_id)?void 0:t.slice(0,8))||"Unknown"}`,revenue:parseFloat(e.total_price)||0,units:e.quantity||0,margin:0}}))||[]}catch(iu){return[]}}async getTopCustomers(e=5){try{const{data:t,error:a}=await $a.from("lats_sales").select("\n          total_amount,\n          created_at\n        ").eq("status","completed").order("total_amount",{ascending:!1}).limit(e);return a?[]:(null==t?void 0:t.map(e=>({name:"Customer",revenue:parseFloat(e.total_amount)||0,orders:1,avgOrder:parseFloat(e.total_amount)||0})))||[]}catch(iu){return[]}}async getProductCategoryPerformance(){try{const{data:e,error:t}=await $a.from("lats_sale_items").select("\n          quantity,\n          total_price,\n          product_id\n        ");if(t)return[];const a=new Map;return null==e||e.forEach(e=>{var t;const r=`Category ${(null==(t=e.product_id)?void 0:t.slice(0,8))||"Unknown"}`,s=a.get(r)||{category:r,revenue:0,units:0,margin:0};s.revenue+=parseFloat(e.total_price)||0,s.units+=e.quantity||0,a.set(r,s)}),Array.from(a.values())}catch(iu){return[]}}async getMonthlyRevenueTrend(e=6){try{const{data:t,error:a}=await $a.from("lats_sales").select("total_amount, created_at").eq("status","completed").gte("created_at",new Date(Date.now()-30*e*24*60*60*1e3).toISOString()).order("created_at");if(a)return[];const r=new Map,s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return null==t||t.forEach(e=>{const t=new Date(e.created_at),a=`${s[t.getMonth()]} ${t.getFullYear()}`,n=r.get(a)||0;r.set(a,n+parseFloat(e.total_amount))}),Array.from(r.entries()).map(([e,t])=>({month:e,value:t,target:1.1*t}))}catch(iu){return[]}}async getCustomerSegments(){try{const{data:e,error:t}=await $a.from("lats_sales").select("total_amount, customer_id").eq("status","completed");if(t)return[];const a=new Map;null==e||e.forEach(e=>{const t=e.customer_id||"walk-in",r=a.get(t)||0;a.set(t,r+parseFloat(e.total_amount))});const r=Array.from(a.entries()).sort(([,e],[,t])=>t-e),s=r.reduce((e,[,t])=>e+t,0),n=[{segment:"VIP Customers",count:0,revenue:0,percentage:0},{segment:"Regular Customers",count:0,revenue:0,percentage:0},{segment:"Walk-in Customers",count:0,revenue:0,percentage:0}];return r.forEach(([e,t],a)=>{"walk-in"===e?(n[2].count++,n[2].revenue+=t):a<Math.ceil(.2*r.length)?(n[0].count++,n[0].revenue+=t):(n[1].count++,n[1].revenue+=t)}),n.forEach(e=>{e.percentage=s>0?e.revenue/s*100:0}),n}catch(iu){return[]}}async generateBusinessInsights(){const e=[];try{const t=await this.getInventoryStats(),a=await this.getSalesStats();t&&(t.low_stock_items>0&&e.push({type:"warning",title:"Low Stock Alert",description:`${t.low_stock_items} items are running low on stock`,impact:"medium"}),t.out_of_stock_items>0&&e.push({type:"negative",title:"Out of Stock Items",description:`${t.out_of_stock_items} items are completely out of stock`,impact:"high"})),a&&(a.this_month_revenue>10*a.average_sale&&e.push({type:"positive",title:"Strong Monthly Performance",description:`Revenue this month is ${(a.this_month_revenue/(10*a.average_sale)*100).toFixed(1)}% above average`,impact:"high"}),a.today_revenue>0&&e.push({type:"positive",title:"Today's Sales",description:`Generated ${a.today_revenue.toLocaleString()} TZS in sales today`,impact:"medium"})),0===e.length&&e.push({type:"info",title:"System Ready",description:"Analytics system is connected and ready to provide insights",impact:"low"})}catch(iu){e.push({type:"info",title:"Analytics Loading",description:"Business insights are being calculated",impact:"low"})}return e}async getComprehensiveAnalytics(){try{const[e,t,a,r,s,n,i,o]=await Promise.all([this.getInventoryStats(),this.getSalesStats(),this.getTopProducts(),this.getTopCustomers(),this.getProductCategoryPerformance(),this.getMonthlyRevenueTrend(),this.getCustomerSegments(),this.generateBusinessInsights()]),c=(null==t?void 0:t.total_revenue)||0,l=new Date;l.setMonth(l.getMonth()-1);const d=new Date;d.setMonth(d.getMonth()-1),d.setDate(d.getDate()+30);const{data:u}=await $a.from("lats_sales").select("total_amount").gte("created_at",l.toISOString()).lt("created_at",d.toISOString()).eq("status","completed"),m=(null==u?void 0:u.reduce((e,t)=>e+("number"==typeof t.total_amount?t.total_amount:parseFloat(t.total_amount)||0),0))||0,h=m>0?(c-m)/m*100:0,{data:p}=await $a.from("lats_sales").select("id, total_amount").gte("created_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()).eq("status","completed");let g=0;if(p&&p.length>0){const e=p.map(e=>e.id),{data:t}=await $a.from("lats_sale_items").select("id, quantity, total_price, product_id, variant_id, cost_price").in("sale_id",e);null==t||t.forEach(e=>{const t=e.cost_price||0,a=e.total_price||0,r=e.quantity||1;g+=a-t*r})}const _=.3*m,f=_>0?(g-_)/_*100:0,y=i.reduce((e,t)=>e+t.count,0),v=.9*y,w=v>0?(y-v)/v*100:0,b=(null==t?void 0:t.total_sales)||0,S=.9*b,x=b>0?c/b:0,k=.95*x;return{kpis:{revenue:{current:c,previous:m,growth:h},profit:{current:g,previous:_,growth:f},customers:{current:y,previous:v,growth:w},orders:{current:b,previous:S,growth:S>0?(b-S)/S*100:0},avgOrderValue:{current:x,previous:k,growth:k>0?(x-k)/k*100:0},conversionRate:{current:await this.calculateConversionRate(),previous:await this.calculateConversionRate(!0),growth:0}},trends:{revenue:n,customers:await this.calculateCustomerTrends()},segments:{customerSegments:i,productCategories:s,geographicData:await this.calculateGeographicData()},performance:{topProducts:a,topCustomers:r},insights:o}}catch(iu){return{kpis:{revenue:{current:0,previous:0,growth:0},profit:{current:0,previous:0,growth:0},customers:{current:0,previous:0,growth:0},orders:{current:0,previous:0,growth:0},avgOrderValue:{current:0,previous:0,growth:0},conversionRate:{current:0,previous:0,growth:0}},trends:{revenue:[],customers:[]},segments:{customerSegments:[],productCategories:[],geographicData:[]},performance:{topProducts:[],topCustomers:[]},insights:[{type:"info",title:"Data Loading",description:"Analytics data is being loaded from the database",impact:"low"}]}}}async calculateConversionRate(e=!1){try{const t=e?{gte:this.getPreviousMonthStart(),lt:this.getCurrentMonthStart()}:{gte:this.getCurrentMonthStart()},{data:a}=await $a.from("customers").select("id").gte("last_visit",t.gte).lt("last_visit",t.lt),{data:r}=await $a.from("customers").select("id").gte("last_purchase_date",t.gte).lt("last_purchase_date",t.lt),s=(null==a?void 0:a.length)||0,n=(null==r?void 0:r.length)||0;return s>0?n/s*100:0}catch(iu){return 0}}async calculateCustomerTrends(){try{const e=[],t=this.getLast12Months();for(const a of t){const{data:t}=await $a.from("customers").select("id").gte("created_at",a.start).lt("created_at",a.end),{data:r}=await $a.from("customers").select("id").gte("last_visit",a.start).lt("last_visit",a.end).lt("created_at",a.start);e.push({month:a.name,new:(null==t?void 0:t.length)||0,returning:(null==r?void 0:r.length)||0})}return e}catch(iu){return[]}}async calculateGeographicData(){try{const{data:e}=await $a.from("customers").select("city, total_spent"),t=new Map;return null==e||e.forEach(e=>{const a=e.city||"Unknown",r=t.get(a)||{customers:0,revenue:0};t.set(a,{customers:r.customers+1,revenue:r.revenue+(e.total_spent||0)})}),Array.from(t.entries()).map(([e,t])=>({location:e,customers:t.customers,revenue:t.revenue})).sort((e,t)=>t.customers-e.customers)}catch(iu){return[]}}getCurrentMonthStart(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),1).toISOString()}getPreviousMonthStart(){const e=new Date;return new Date(e.getFullYear(),e.getMonth()-1,1).toISOString()}getLast12Months(){const e=[],t=new Date;for(let a=11;a>=0;a--){const r=new Date(t.getFullYear(),t.getMonth()-a,1),s=r.toISOString(),n=new Date(r.getFullYear(),r.getMonth()+1,1).toISOString();e.push({name:r.toLocaleDateString("en-US",{month:"short",year:"numeric"}),start:s,end:n})}return e}};class Ns{static sanitizeImageUrl(e,t){if(!e||"string"!=typeof e)return this.createFallbackResult(0,"fallback");const a=e.length;if(a>this.MAX_SAFE_URL_LENGTH)return this.createFallbackResult(a,"fallback");if(e.startsWith("data:")){if(a>this.MAX_SAFE_DATA_URL_LENGTH)return this.createFallbackResult(a,"fallback");if(this.hasBase64InPath(e))return this.createFallbackResult(a,"fallback");const t=e.split(",")[1];return t&&t.length>1e5?this.createFallbackResult(a,"fallback"):{url:e,isSanitized:!1,originalLength:a,sanitizedLength:a,method:"original"}}return this.hasProblematicPatterns(e)||this.hasBase64InUrlPath(e)?this.createFallbackResult(a,"fallback"):{url:e,isSanitized:!1,originalLength:a,sanitizedLength:a,method:"original"}}static hasBase64InPath(e){try{const t=new URL(e,window.location.origin).pathname;return/[A-Za-z0-9+/]{100,}={0,2}/.test(t)}catch{return/[A-Za-z0-9+/]{100,}={0,2}/.test(e)}}static hasBase64InUrlPath(e){return this.hasBase64InPath(e)}static hasProblematicPatterns(e){const t=e.match(/%[0-9A-Fa-f]{2,}/g);if(t){if(t.join("").length>this.MAX_SAFE_BASE64_IN_PATH)return!0}return!(!e.includes("data:image/")||!e.includes(","))}static createFallbackResult(e,t){const a=this.generatePlaceholderUrl();return{url:a,isSanitized:!0,originalLength:e,sanitizedLength:a.length,method:t}}static generatePlaceholderUrl(){return`data:image/svg+xml;base64,${btoa('\n      <svg width="300" height="300" xmlns="http://www.w3.org/2000/svg">\n        <rect width="100%" height="100%" fill="#f3f4f6"/>\n        <text x="50%" y="50%" font-family="Arial, sans-serif" font-size="14" \n              fill="#6b7280" text-anchor="middle" dy=".3em">\n          Product Image\n        </text>\n      </svg>\n    ')}`}static isUrlSafe(e){return!this.sanitizeImageUrl(e).isSanitized}static getUrlStats(e){const t=e.startsWith("data:"),a=this.hasBase64InPath(e),r=e.length>this.MAX_SAFE_URL_LENGTH,s=!r&&!a;return{length:e.length,isTooLong:r,isDataUrl:t,hasBase64InPath:a,isSafe:s}}static emergencyCleanup(e){return e&&"string"==typeof e?e.length>2e3||this.hasBase64InPath(e)?this.generatePlaceholderUrl():e:this.generatePlaceholderUrl()}}function Ms(e="Image",t=300,a=300){return`data:image/svg+xml;base64,${btoa(`\n    <svg width="${t}" height="${a}" viewBox="0 0 ${t} ${a}" fill="none" xmlns="http://www.w3.org/2000/svg">\n      <rect width="${t}" height="${a}" fill="#F3F4F6"/>\n      <text x="${t/2}" y="${a/2}" font-family="Arial, sans-serif" font-size="16" fill="#6B6B6B" text-anchor="middle" dy=".3em">${e}</text>\n    </svg>\n  `)}`}function Us(e="product",t){switch(e){case"thumbnail":return Ms("Thumbnail",100,100);case"avatar":return Ms(t||"U",40,40);default:return Ms(t||"Product Image",300,300)}}function Bs(e){return e&&"string"==typeof e&&e.startsWith("data:")}function $s(e,t){const a=Ns.sanitizeImageUrl(e,t);return a.isSanitized,a.url}function Fs(e){return e&&"string"==typeof e?e.length>2e3||Bs(e)&&e.length>1e4?Us("product"):e:Us("product")}function zs(e){return Array.isArray(e)?e.map(e=>{return!(t=e)||"string"!=typeof t||["via.placeholder.com","placehold.it","placehold.co","dummyimage.com","picsum.photos","lorempixel.com","loremflickr.com"].some(e=>t.toLowerCase().includes(e))?function(e="Image",t=300,a=300){return`data:image/svg+xml;base64,${btoa(`\n    <svg width="${t}" height="${a}" viewBox="0 0 ${t} ${a}" fill="none" xmlns="http://www.w3.org/2000/svg">\n      <rect width="${t}" height="${a}" fill="#F3F4F6"/>\n      <text x="${t/2}" y="${a/2}" font-family="Arial, sans-serif" font-size="16" fill="#6B6B6B" text-anchor="middle" dy=".3em">${e}</text>\n    </svg>\n  `)}`}("Product Image",400,400):e;var t}):[]}function Vs(e){return Array.isArray(e)?e.map((e,t)=>{const a={...e};var r,s;return void 0!==a.category_id&&(a.categoryId=a.category_id,delete a.category_id),void 0!==a.supplier_id&&(a.supplierId=a.supplier_id,delete a.supplier_id),void 0!==a.brand_id&&(a.brandId=a.brand_id,delete a.brand_id),void 0!==a.branch_id&&(a.branchId=a.branch_id,delete a.branch_id),void 0!==a.is_shared&&delete a.is_shared,void 0!==a.is_active&&(a.isActive=a.is_active,delete a.is_active),void 0!==a.storage_room_id&&(a.storageRoomId=a.storage_room_id,delete a.storage_room_id),void 0!==a.shelf_id&&(a.shelfId=a.shelf_id,delete a.shelf_id),void 0!==a.shelf_name&&(a.shelfName=a.shelf_name,delete a.shelf_name),void 0!==a.shelf_code&&(a.shelfCode=a.shelf_code,delete a.shelf_code),void 0!==a.selling_price&&(a.price=a.selling_price),void 0!==a.cost_price&&(a.costPrice=a.cost_price,delete a.cost_price),void 0!==a.stock_quantity&&(a.stockQuantity=a.stock_quantity,delete a.stock_quantity),void 0!==a.min_stock_level&&(a.minStockLevel=a.min_stock_level,delete a.min_stock_level),void 0!==a.created_at&&(a.createdAt=a.created_at,delete a.created_at),void 0!==a.updated_at&&(a.updatedAt=a.updated_at,delete a.updated_at),a.images&&Array.isArray(a.images)&&(a.images=zs((r=a.images,Array.isArray(r)?r.map(e=>(e&&"object"==typeof e&&(e.image_url&&(e.image_url=$s(e.image_url,e.file_name)),e.thumbnail_url&&(e.thumbnail_url=$s(e.thumbnail_url,e.file_name)),e.url&&(e.url=$s(e.url,e.fileName)),e.thumbnailUrl&&(e.thumbnailUrl=$s(e.thumbnailUrl,e.fileName))),e)):[]))),a.image_url&&(a.image_url=Fs(a.image_url)),a.thumbnail_url&&(a.thumbnail_url=Fs(a.thumbnail_url)),a.primary_image&&(a.primary_image=(s=a.primary_image)&&"object"==typeof s?(s.image_url&&Bs(s.image_url)&&s.image_url.length>8e3&&(s.image_url=Us("product",s.file_name)),s.thumbnail_url&&Bs(s.thumbnail_url)&&s.thumbnail_url.length>8e3&&(s.thumbnail_url=Us("product",s.file_name)),s.url&&Bs(s.url)&&s.url.length>8e3&&(s.url=Us("product",s.fileName)),s.thumbnailUrl&&Bs(s.thumbnailUrl)&&s.thumbnailUrl.length>8e3&&(s.thumbnailUrl=Us("product",s.fileName)),s):s),a.variants&&Array.isArray(a.variants)&&(a.variants=a.variants.map(e=>{const t={...e};if(void 0!==t.product_id&&(t.productId=t.product_id,delete t.product_id),void 0!==t.variant_name&&(t.name=t.variant_name),void 0!==t.selling_price){const e=t.selling_price;t.price=e,t.sellingPrice=e,delete t.selling_price}return void 0!==t.cost_price&&(t.costPrice=t.cost_price,delete t.cost_price),void 0!==t.min_quantity&&(t.minQuantity=t.min_quantity,t.minStockLevel=t.min_quantity,delete t.min_quantity),void 0!==t.quantity&&(t.stockQuantity=t.quantity),void 0!==t.created_at&&(t.createdAt=t.created_at,delete t.created_at),void 0!==t.updated_at&&(t.updatedAt=t.updated_at,delete t.updated_at),t})),a}):[]}function Ws(e){return function(e){return Array.isArray(e)?e.map((e,t)=>{const a={...e};return void 0!==a.parent_id&&(a.parentId=a.parent_id,delete a.parent_id),void 0!==a.is_active&&(a.isActive=a.is_active,delete a.is_active),void 0!==a.sort_order&&(a.sortOrder=a.sort_order,delete a.sort_order),void 0!==a.created_at&&(a.createdAt=a.created_at,delete a.created_at),void 0!==a.updated_at&&(a.updatedAt=a.updated_at,delete a.updated_at),a.image_url&&(a.image_url=Fs(a.image_url)),a}):[]}(e||[])}function Hs(e){return function(e){return Array.isArray(e)?e.map(e=>{const t={...e};return t.logo_url&&(t.logo_url=Fs(t.logo_url)),t}):[]}(e||[])}function Qs(e,t){if(!e)return!1;if(!Array.isArray(e))return!1;let a=!1;return e.forEach((e,t)=>{e&&"object"==typeof e&&Object.entries(e).forEach(([e,t])=>{"string"==typeof t&&t.length>2e3&&(a=!0)})}),!0}Ns.MAX_SAFE_URL_LENGTH=2e3,Ns.MAX_SAFE_DATA_URL_LENGTH=8e3,Ns.MAX_SAFE_BASE64_IN_PATH=500;const Gs="1.0",Ks=18e5,Ys=class e{saveProducts(t){try{const a={data:t,timestamp:Date.now(),version:Gs};localStorage.setItem(e.PRODUCTS_KEY,JSON.stringify(a))}catch(iu){}}getProducts(){try{const t=localStorage.getItem(e.PRODUCTS_KEY);if(!t)return null;const a=JSON.parse(t);if(a.version!==Gs)return this.clearProducts(),null;return Date.now()-a.timestamp>Ks?(this.clearProducts(),null):a.data}catch(iu){return null}}saveCategories(t){try{const a={data:t,timestamp:Date.now(),version:Gs};localStorage.setItem(e.CATEGORIES_KEY,JSON.stringify(a))}catch(iu){}}getCategories(){try{const t=localStorage.getItem(e.CATEGORIES_KEY);if(!t)return null;const a=JSON.parse(t);if(a.version!==Gs)return this.clearCategories(),null;return Date.now()-a.timestamp>Ks?(this.clearCategories(),null):a.data}catch(iu){return null}}clearProducts(){localStorage.removeItem(e.PRODUCTS_KEY)}clearCategories(){localStorage.removeItem(e.CATEGORIES_KEY)}clearAll(){this.clearProducts(),this.clearCategories()}};Ys.PRODUCTS_KEY="pos_products_cache",Ys.CATEGORIES_KEY="pos_categories_cache";const Js=new Ys;class Xs{constructor(){this.cache=null,this.CACHE_DURATION=3e5,this.loadingPromise=null}static getInstance(){return Xs.instance||(Xs.instance=new Xs),Xs.instance}isCacheValid(){return!!this.cache&&Date.now()<this.cache.expiresAt}clearCache(){this.cache=null}async getCategories(e=!1){if(!e&&this.isCacheValid())return this.cache.data;if(this.loadingPromise)return this.loadingPromise;this.loadingPromise=this.fetchCategoriesFromDatabase();try{return await this.loadingPromise}finally{this.loadingPromise=null}}async fetchCategoriesFromDatabase(){performance.now();try{const e=$a.from("lats_categories").select("*").order("name"),{data:t,error:a}=await e;if(a)throw a;const r=t||[];performance.now();return this.cache={data:r,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION},r}catch(iu){throw iu}}async getActiveCategories(e=!1){return(await this.getCategories(e)).filter(e=>!1!==e.isActive&&!1!==e.is_active)}async getActiveCategoriesExcludingSpare(e=!1){const t=await this.getCategories(e),a=["spare","parts","repair","replacement","component"],r=["screen replacement","battery replacement","charging port","logic board","motherboard","circuit board","flex cable","ribbon cable","charging cable","home button","power button","volume button","camera module","speaker module","microphone module","antenna module","vibration motor","charging dock","connector port","headphone jack","sim tray","battery connector"];return t.filter(e=>{if(!1===e.isActive||!1===e.is_active)return!1;const t=e.name.toLowerCase(),s=(e.description||"").toLowerCase(),n=a.some(e=>t.includes(e)||s.includes(e)),i=r.some(e=>t.includes(e)||s.includes(e)),o=t.includes("spare")||t.includes(" part")||t.includes("parts")||t.includes("component")&&!t.includes("software");return!(n||i||o)})}async getSparePartCategories(e=!1){const t=await this.getCategories(e),a=["spare","parts","components","accessories","repair","replacement","screen","battery","charger","cable","adapter","connector","button","speaker","microphone","camera","lens","antenna","circuit","board","chip","processor","memory","storage","keyboard","touchpad","hinge","case","cover","protector"];return t.filter(e=>{if(!1===e.isActive||!1===e.is_active)return!1;const t=e.name.toLowerCase(),r=(e.description||"").toLowerCase(),s=a.some(e=>t.includes(e)||r.includes(e)),n=e.parentId&&""!==e.parentId.trim(),i=t.includes("spare")||t.includes("part")||t.includes("component")||t.includes("accessory");return s||n||i})}async getCategoryById(e,t=!1){return(await this.getCategories(t)).find(t=>t.id===e)||null}async searchCategories(e,t=!1){const a=await this.getCategories(t),r=e.toLowerCase();return a.filter(e=>e.name.toLowerCase().includes(r)||e.description&&e.description.toLowerCase().includes(r))}invalidateCache(){this.clearCache()}async forceRefresh(){return this.clearCache(),await this.getCategories(!0)}async getCategoriesForProducts(e,t=!1){if(0===e.length)return[];return await this.getCategories(t)}async getCategoryStats(e=!1){const t=await this.getCategories(e),a=t.filter(e=>!1!==e.is_active).length,r=t.filter(e=>e.description&&e.description.trim()).length,s=new Set(t.map(e=>e.color).filter(Boolean)).size;return{total:t.length,active:a,inactive:t.length-a,withDescription:r,uniqueColors:s}}}const Zs=Xs.getInstance(),en=e=>{const t={name:e.name,part_number:e.partNumber,category_id:e.categoryId,brand:e.brand,supplier_id:e.supplierId,condition:e.condition||"new",description:e.description,cost_price:e.costPrice,selling_price:e.sellingPrice,quantity:e.quantity,min_quantity:e.minQuantity,location:e.location,compatible_devices:e.compatibleDevices};if(e.storageRoomId&&(t.storage_room_id=e.storageRoomId),e.shelfId&&(t.shelf_id=e.shelfId),e.images){const a=e.images.map(e=>e.image_url||e.url).filter(Boolean);t.images=a}return e.partType&&(t.part_type=e.partType),e.primaryDeviceType&&(t.primary_device_type=e.primaryDeviceType),e.searchTags&&(t.search_tags=e.searchTags),t},tn=async(e,t,a)=>{try{const r=t.map((t,r)=>({spare_part_id:e,image_url:t.image_url||t.url,thumbnail_url:t.thumbnail_url||t.thumbnailUrl||t.image_url||t.url,file_name:t.file_name||t.fileName||`spare-part-image-${r+1}`,file_size:t.file_size||t.fileSize||0,mime_type:t.mime_type||t.mimeType||"image/jpeg",is_primary:t.is_primary||t.isPrimary||0===r,uploaded_by:a})),{data:s,error:n}=await $a.from("spare_part_images").insert(r).select();if(n){if("42501"===n.code){const r=t.map((t,r)=>({product_id:e,image_url:t.image_url||t.url,thumbnail_url:t.thumbnail_url||t.thumbnailUrl||t.image_url||t.url,file_name:t.file_name||t.fileName||`spare-part-image-${r+1}`,file_size:t.file_size||t.fileSize||0,mime_type:t.mime_type||t.mimeType||"image/jpeg",is_primary:t.is_primary||t.isPrimary||0===r,uploaded_by:a})),{data:s,error:n}=await $a.from("product_images").insert(r).select();if(n)throw n;return}throw n}}catch(iu){throw iu}},an=async e=>{try{const{data:t,error:a}=await $a.from("spare_part_images").select("*").eq("spare_part_id",e).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(!a&&t&&t.length>0)return t;const{data:r,error:s}=await $a.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(!s&&r&&r.length>0)return r;const{data:n,error:i}=await $a.from("lats_spare_parts").select("images").eq("id",e).single();if(i)return[];if((null==n?void 0:n.images)&&Array.isArray(n.images)&&n.images.length>0){return n.images.map((t,a)=>({id:`main-record-${a}`,spare_part_id:e,image_url:t,thumbnail_url:t,file_name:`image-${a+1}.jpg`,file_size:0,mime_type:"image/jpeg",is_primary:0===a,uploaded_by:null,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}))}return[]}catch(iu){return[]}},rn=async()=>{try{const{data:e,error:t}=await $a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name),\n        variants:lats_spare_part_variants!spare_part_id(*)\n      ").eq("is_active",!0).order("name",{ascending:!0});if(t)throw t;return{success:!0,data:e||[],message:"Spare parts retrieved successfully"}}catch(iu){return{success:!1,data:null,message:iu instanceof Error?iu.message:"Failed to fetch spare parts"}}},sn=async e=>{var t,a;try{const{data:{user:t}}=await $a.auth.getUser(),a=e.useVariants||!1,r=e.variants||[],s=en(e);if(s.part_number){const{data:e,error:t}=await $a.from("lats_spare_parts").select("id, name, part_number").eq("part_number",s.part_number).maybeSingle();if(t)throw t;if(e)return{data:e,message:`DUPLICATE_PART_NUMBER: A spare part with part number "${s.part_number}" already exists (ID: ${e.id}, Name: "${e.name}"). Please use a different part number or update the existing part instead.`,ok:!1,errorType:"DUPLICATE_PART_NUMBER",existingPart:e}}let n=0,i=0;a&&r.length>0?(n=r.reduce((e,t)=>e+(t.quantity||0),0),i=r.reduce((e,t)=>e+(t.quantity||0)*(t.selling_price||0),0)):(n=s.quantity||0,i=(s.quantity||0)*(s.selling_price||0));const o={...s,quantity:a?0:s.quantity,cost_price:a?0:s.cost_price,selling_price:a?0:s.selling_price,min_quantity:a?0:s.min_quantity,metadata:{useVariants:a,variantCount:a?r.length:0,totalQuantity:n,totalValue:i},created_by:null==t?void 0:t.id,updated_by:null==t?void 0:t.id},{data:c,error:l}=await $a.from("lats_spare_parts").insert(o).select().single();if(l){if("23505"===l.code){const e=l.constraint||"unknown constraint";let t="field";return e.includes("part_number")?t="part number":e.includes("name")&&(t="name"),{data:null,message:`DUPLICATE_ERROR: A spare part with this ${t} already exists. Please use a different ${t}.`,ok:!1,errorType:"DUPLICATE_CONSTRAINT",constraint:e}}return"23503"===l.code?{data:null,message:"FOREIGN_KEY_ERROR: The selected category or supplier does not exist. Please select valid options.",ok:!1,errorType:"FOREIGN_KEY_VIOLATION"}:"23514"===l.code?{data:null,message:"VALIDATION_ERROR: Invalid data provided. Please check that condition is set to 'new', 'used', or 'refurbished'.",ok:!1,errorType:"CHECK_CONSTRAINT_VIOLATION"}:{data:null,message:`DATABASE_ERROR: ${l.message||"Unknown database error occurred"}`,ok:!1,errorType:"DATABASE_ERROR",originalError:l}}if(e.images&&e.images.length>0&&await tn(c.id,e.images,null==t?void 0:t.id),a&&r.length>0&&c){const e=r.map(e=>({spare_part_id:c.id,name:e.name,sku:e.sku,cost_price:e.cost_price,selling_price:e.selling_price,quantity:e.quantity,min_quantity:e.min_quantity,variant_attributes:e.attributes||{},image_url:e.image_url||null,created_by:null==t?void 0:t.id,updated_by:null==t?void 0:t.id})),{data:a,error:s}=await $a.from("lats_spare_part_variants").insert(e).select()}return{data:c,message:"Spare part created successfully",ok:!0}}catch(iu){null==iu||iu.response;let r="Failed to create spare part";return"23505"===(null==iu?void 0:iu.code)?r=(null==(t=null==iu?void 0:iu.message)?void 0:t.includes("part_number"))?"A spare part with this part number already exists. Please use a different part number.":(null==(a=null==iu?void 0:iu.message)?void 0:a.includes("name"))?"A spare part with this name already exists. Please use a different name.":"A spare part with this information already exists. Please check for duplicates.":"23503"===(null==iu?void 0:iu.code)?r="Invalid reference. Please check that the category, supplier, or other referenced data exists.":"23514"===(null==iu?void 0:iu.code)?r="Invalid data provided. Please check all required fields and constraints.":iu instanceof Error&&(r=iu.message),{data:null,message:r,ok:!1}}},nn=async e=>{try{const{error:t}=await $a.from("lats_spare_parts").delete().eq("id",e);if(t)throw t;return{message:"Spare part deleted successfully",ok:!0}}catch(iu){return{message:iu instanceof Error?iu.message:"Failed to delete spare part",ok:!1}}},on=async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),{data:a,error:r}=await $a.from("lats_spare_part_usage").insert({...e,used_by:null==t?void 0:t.id}).select().single();if(r)throw r;const{error:s}=await $a.from("lats_spare_parts").update({quantity:$a.raw(`quantity - ${e.quantity_used}`),updated_by:null==t?void 0:t.id}).eq("id",e.spare_part_id);if(s)throw s;return{data:a,message:"Usage recorded successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to record usage",ok:!1}}},cn=async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name)\n      ").eq("part_number",e).maybeSingle();if(a)throw a;return t?{data:t,message:"Spare part found successfully",ok:!0}:{data:null,message:"No spare part found with this part number",ok:!1}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to find spare part",ok:!1}}},ln=async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),a=en(e);if(a.part_number){const t=await cn(a.part_number);if(t.ok&&t.data){const r=await hn(t.data.id,e);return r.ok?{...r,message:`UPDATED_EXISTING: Spare part "${a.part_number}" was updated successfully. A spare part with this part number already existed (ID: ${t.data.id}, Previous Name: "${t.data.name}").`,operationType:"UPDATE_EXISTING",previousData:t.data}:{...r,message:`UPDATE_FAILED: Failed to update existing spare part "${a.part_number}" (ID: ${t.data.id}). ${r.message}`,operationType:"UPDATE_FAILED",existingPart:t.data}}}const r=await sn(e);return r.ok?{...r,message:`CREATED_NEW: Spare part "${a.part_number}" was created successfully as a new record.`,operationType:"CREATE_NEW"}:{...r,message:`CREATE_FAILED: Failed to create new spare part "${a.part_number}". ${r.message}`,operationType:"CREATE_FAILED"}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to create or update spare part",ok:!1}}},dn=async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_part_variants").select("\n        *,\n        spare_part:lats_spare_parts(\n          *,\n          category:lats_categories!category_id(name)\n        )\n      ").eq("spare_part.is_active",!0);if(a)throw a;return(t||[]).filter(t=>{if(!t.variant_attributes)return!1;const a=t.variant_attributes,r=e.toLowerCase();return Object.entries(a).some(([e,t])=>e.toLowerCase().includes(r)||String(t).toLowerCase().includes(r))})}catch(iu){return[]}},un=async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_part_variants").select("*").eq("spare_part_id",e).order("created_at",{ascending:!0});if(a)throw a;return t||[]}catch(iu){return[]}},mn=async e=>{try{let t=$a.from("lats_spare_part_variants").select("selling_price, quantity, min_quantity");e&&(t=t.eq("spare_part_id",e));const{data:a,error:r}=await t;if(r)throw r;const s=a||[],n=s.length;if(0===n)return{totalVariants:0,totalValue:0,inStockVariants:0,outOfStockVariants:0,lowStockVariants:0,averagePrice:0,priceRange:{min:0,max:0}};const i=s.reduce((e,t)=>e+t.selling_price*t.quantity,0),o=s.filter(e=>e.quantity>0).length,c=s.filter(e=>0===e.quantity).length,l=s.filter(e=>e.quantity>0&&e.quantity<=e.min_quantity).length,d=s.map(e=>e.selling_price).filter(e=>e>0),u=d.length>0?d.reduce((e,t)=>e+t,0)/d.length:0;return{totalVariants:n,totalValue:i,inStockVariants:o,outOfStockVariants:c,lowStockVariants:l,averagePrice:u,priceRange:d.length>0?{min:Math.min(...d),max:Math.max(...d)}:{min:0,max:0}}}catch(iu){return{totalVariants:0,totalValue:0,inStockVariants:0,outOfStockVariants:0,lowStockVariants:0,averagePrice:0,priceRange:{min:0,max:0}}}},hn=async(e,t)=>{var a,r;try{const{data:{user:n}}=await $a.auth.getUser(),i=t.useVariants||!1,o=t.variants||[],c=en(t);let l=0,d=0;i&&o.length>0?(l=o.reduce((e,t)=>e+(t.quantity||0),0),d=o.reduce((e,t)=>e+(t.quantity||0)*(t.selling_price||0),0)):(l=c.quantity||0,d=(c.quantity||0)*(c.selling_price||0));const u={...c,quantity:i?0:c.quantity,cost_price:i?0:c.cost_price,selling_price:i?0:c.selling_price,min_quantity:i?0:c.min_quantity,metadata:{useVariants:i,variantCount:i?o.length:0,totalQuantity:l,totalValue:d},updated_by:null==n?void 0:n.id};if(u.category_id){const{data:e}=await $a.from("lats_categories").select("id").eq("id",u.category_id).single();if(!e)throw new Error(`Category with ID ${u.category_id} does not exist`)}if(u.supplier_id){const{data:e}=await $a.from("lats_suppliers").select("id").eq("id",u.supplier_id).single();if(!e)throw new Error(`Supplier with ID ${u.supplier_id} does not exist`)}const{data:m,error:h}=await $a.from("lats_spare_parts").update(u).eq("id",e).select().single();if(h)throw h;const{data:p,error:g}=await $a.from("lats_spare_parts").select("*").eq("id",e).single();if(t.images&&t.images.length>0)try{await tn(e,t.images,null==n?void 0:n.id);const{error:s}=await $a.from("spare_part_images").delete().eq("spare_part_id",e).neq("image_url",(null==(a=t.images[0])?void 0:a.image_url)||(null==(r=t.images[0])?void 0:r.url))}catch(s){}if(i&&o.length>0){const{error:t}=await $a.from("lats_spare_part_variants").delete().eq("spare_part_id",e),a=o.map(t=>({spare_part_id:e,name:t.name,sku:t.sku,cost_price:t.cost_price,selling_price:t.selling_price,quantity:t.quantity,min_quantity:t.min_quantity,variant_attributes:t.attributes||{},image_url:t.image_url||null,created_by:null==n?void 0:n.id,updated_by:null==n?void 0:n.id})),{data:r,error:s}=await $a.from("lats_spare_part_variants").insert(a).select()}else{const{error:t}=await $a.from("lats_spare_part_variants").delete().eq("spare_part_id",e)}return{data:m,message:"Spare part updated successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to update spare part",ok:!1}}},pn=async e=>{try{const{data:t,error:a}=await $a.from("repair_parts").select("\n        *,\n        spare_part:lats_spare_parts!spare_part_id(\n          id,\n          name,\n          part_number,\n          quantity,\n          selling_price,\n          cost_price,\n          category_id,\n          brand,\n          description,\n          condition,\n          location,\n          min_quantity,\n          is_active,\n          created_at,\n          updated_at\n        )\n      ").eq("device_id",e).order("created_at",{ascending:!1});if(a){if(a.message.includes('relation "public.repair_parts" does not exist'))return{data:[],message:"Repair parts table not found. Please contact administrator to set up the database.",ok:!0,total:0};throw a}return{data:t||[],message:"Repair parts retrieved successfully",ok:!0,total:(null==t?void 0:t.length)||0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to fetch repair parts",ok:!1,total:0}}},gn=async e=>{var t,a;try{const{data:{user:r}}=await $a.auth.getUser();for(const t of e){const{data:e,error:a}=await $a.from("lats_spare_parts").select("quantity, name").eq("id",t.spare_part_id).single();if(a)throw new Error(`Failed to fetch spare part: ${a.message}`);if(!e)throw new Error(`Spare part not found: ${t.spare_part_id}`);if(e.quantity<t.quantity_needed)throw new Error(`Insufficient stock for ${e.name}. Available: ${e.quantity}, Needed: ${t.quantity_needed}`)}const s=e.map(e=>({...e,created_by:null==r?void 0:r.id,updated_by:null==r?void 0:r.id})),{data:n,error:i}=await $a.from("repair_parts").insert(s).select("\n        *,\n        spare_part:lats_spare_parts!spare_part_id(\n          id,\n          name,\n          part_number,\n          quantity,\n          selling_price,\n          cost_price,\n          category_id,\n          brand,\n          description,\n          condition,\n          location,\n          min_quantity,\n          is_active,\n          created_at,\n          updated_at\n        )\n      ");if(i)throw i;const o=[],c=[];let l=!1;const d=[];for(const t of e){const{data:e,error:a}=await $a.from("lats_spare_parts").select("quantity").eq("id",t.spare_part_id).single();if(a){d.push(`Failed to fetch stock for part ${t.spare_part_id}`),l=!0;continue}const{error:s}=await $a.from("lats_spare_parts").update({quantity:e.quantity-t.quantity_needed,updated_at:(new Date).toISOString()}).eq("id",t.spare_part_id);if(s){d.push(`Failed to update stock for part ${t.spare_part_id}`),l=!0;continue}o.push({spare_part_id:t.spare_part_id,original_quantity:e.quantity});const{error:n}=await $a.from("lats_spare_part_usage").insert({spare_part_id:t.spare_part_id,quantity:t.quantity_needed,device_id:t.device_id,reason:`Repair attachment - Device: ${t.device_id}`,notes:t.notes||"Spare part attached to device repair",used_by:null==r?void 0:r.id});n?(d.push(`Failed to record usage for part ${t.spare_part_id}`),l=!0):c.push(t.spare_part_id)}if(l){for(const e of o){const{error:t}=await $a.from("lats_spare_parts").update({quantity:e.original_quantity,updated_at:(new Date).toISOString()}).eq("id",e.spare_part_id)}for(const s of c){const{error:r}=await $a.from("lats_spare_part_usage").delete().eq("spare_part_id",s).eq("device_id",null==(t=e[0])?void 0:t.device_id).eq("reason",`Repair attachment - Device: ${null==(a=e[0])?void 0:a.device_id}`)}const r=(null==n?void 0:n.map(e=>e.id))||[];if(r.length>0){const{error:e}=await $a.from("repair_parts").delete().in("id",r)}throw new Error(`Operation failed: ${d.join(", ")}. All changes have been rolled back.`)}return"undefined"!=typeof window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("lats:spare-parts-updated",{detail:{action:"stock-deducted",partsCount:(null==n?void 0:n.length)||0}})),{data:n||[],message:`${(null==n?void 0:n.length)||0} repair parts created and stock deducted successfully`,ok:!0,total:(null==n?void 0:n.length)||0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to create repair parts",ok:!1,total:0}}},_n=async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),{data:a,error:r}=await $a.from("lats_spare_parts").select("quantity, name").eq("id",e.spare_part_id).single();if(r)throw new Error(`Failed to fetch spare part: ${r.message}`);if(!a)throw new Error(`Spare part not found: ${e.spare_part_id}`);if(a.quantity<e.quantity_needed)throw new Error(`Insufficient stock for ${a.name}. Available: ${a.quantity}, Needed: ${e.quantity_needed}`);const{data:s,error:n}=await $a.from("repair_parts").insert({...e,created_by:null==t?void 0:t.id,updated_by:null==t?void 0:t.id}).select("\n        *,\n        spare_part:lats_spare_parts!spare_part_id(\n          id,\n          name,\n          part_number,\n          quantity,\n          selling_price,\n          cost_price,\n          category_id,\n          brand,\n          description,\n          condition,\n          location,\n          min_quantity,\n          is_active,\n          created_at,\n          updated_at\n        )\n      ").single();if(n)throw n;const{error:i}=await $a.from("lats_spare_parts").update({quantity:a.quantity-e.quantity_needed,updated_at:(new Date).toISOString()}).eq("id",e.spare_part_id),{error:o}=await $a.from("lats_spare_part_usage").insert({spare_part_id:e.spare_part_id,quantity:e.quantity_needed,device_id:e.device_id,reason:`Repair attachment - Device: ${e.device_id}`,notes:e.notes||"Spare part attached to device repair",used_by:null==t?void 0:t.id});return"undefined"!=typeof window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("lats:spare-parts-updated",{detail:{action:"stock-deducted",partsCount:1}})),{data:s,message:"Repair part created and stock deducted successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to create repair part",ok:!1}}},fn=async(e,t)=>{try{const{data:{user:a}}=await $a.auth.getUser();if(!a)throw new Error("User not authenticated");const r={status:"needed",updated_by:a.id};t&&(r.notes=`Rejected by customer care: ${t}`);const{data:s,error:n}=await $a.from("repair_parts").update(r).in("id",e).select("\n        *,\n        spare_part:lats_spare_parts!spare_part_id(\n          id,\n          name,\n          part_number,\n          quantity,\n          selling_price,\n          cost_price,\n          category_id,\n          brand,\n          description,\n          condition,\n          location,\n          min_quantity,\n          is_active,\n          created_at,\n          updated_at\n        )\n      ");if(n)throw n;return{data:s||[],message:`${(null==s?void 0:s.length)||0} spare parts rejected successfully`,ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to reject spare parts",ok:!1}}},yn=Object.freeze(Object.defineProperty({__proto__:null,acceptSpareParts:async e=>{try{const{data:{user:t}}=await $a.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:a,error:r}=await $a.from("repair_parts").update({status:"accepted",updated_by:t.id}).in("id",e).select("\n        *,\n        spare_part:lats_spare_parts!spare_part_id(\n          id,\n          name,\n          part_number,\n          quantity,\n          selling_price,\n          cost_price,\n          category_id,\n          brand,\n          description,\n          condition,\n          location,\n          min_quantity,\n          is_active,\n          created_at,\n          updated_at\n        )\n      ");if(r)throw r;return{data:a||[],message:`${(null==a?void 0:a.length)||0} spare parts accepted successfully`,ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to accept spare parts",ok:!1}}},areAllSparePartsReady:async e=>{try{const t=await pn(e);if(!t.ok||!t.data)return{ready:!1,totalParts:0,readyParts:0,message:"Failed to fetch repair parts"};const a=t.data,r=a.length,s=a.filter(e=>"accepted"===e.status||"received"===e.status||"used"===e.status).length,n=r>0&&s===r;return{ready:n,totalParts:r,readyParts:s,message:n?`All ${r} parts are ready`:`${s}/${r} parts are ready`}}catch(iu){return{ready:!1,totalParts:0,readyParts:0,message:"Error checking parts status"}}},bulkCreateSparePartVariants:async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),a=e.map(e=>({...e,created_by:null==t?void 0:t.id,updated_by:null==t?void 0:t.id})),{data:r,error:s}=await $a.from("lats_spare_part_variants").insert(a).select();if(s)throw s;return{data:r||[],message:"Variants created successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to create variants",ok:!1}}},bulkUpdateQuantities:async e=>{try{const{data:{user:t}}=await $a.auth.getUser();for(const a of e){const{error:e}=await $a.from("lats_spare_parts").update({quantity:a.quantity,updated_by:null==t?void 0:t.id}).eq("id",a.id);if(e)throw e}return{message:"Quantities updated successfully",ok:!0}}catch(iu){return{message:iu instanceof Error?iu.message:"Failed to update quantities",ok:!1}}},checkPartNumberExists:async(e,t)=>{try{let a=$a.from("lats_spare_parts").select("id, name, part_number").eq("part_number",e);t&&(a=a.neq("id",t));const{data:r,error:s}=await a.maybeSingle();if(s)throw s;return r?{exists:!0,message:`Part number "${e}" is already used by "${r.name}"`}:{exists:!1,message:"Part number is available"}}catch(iu){return{exists:!1,message:"Unable to verify part number availability"}}},createOrUpdateSparePart:ln,createRepairPart:_n,createRepairParts:gn,createSparePart:sn,createSparePartVariant:async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),a={...e,created_by:null==t?void 0:t.id,updated_by:null==t?void 0:t.id},{data:r,error:s}=await $a.from("lats_spare_part_variants").insert(a).select().single();if(s)throw s;return{data:r,message:"Variant created successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to create variant",ok:!1}}},deleteSparePart:nn,deleteSparePartVariant:async e=>{try{const{error:t}=await $a.from("lats_spare_part_variants").delete().eq("id",e);if(t)throw t;return{message:"Variant deleted successfully",ok:!0}}catch(iu){return{message:iu instanceof Error?iu.message:"Failed to delete variant",ok:!1}}},findSparePartByPartNumber:cn,getAllSpareParts:rn,getRepairParts:pn,getSparePart:async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name),\n        variants:lats_spare_part_variants!spare_part_id(*)\n      ").eq("id",e).single();if(a)throw a;return{data:t,message:"Spare part retrieved successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to fetch spare part",ok:!1}}},getSparePartImages:an,getSparePartStats:async()=>{try{const{count:e}=await $a.from("lats_spare_parts").select("id",{count:"exact",head:!0}),{data:t}=await $a.from("lats_spare_parts").select("cost_price, quantity"),a=(null==t?void 0:t.reduce((e,t)=>e+t.cost_price*t.quantity,0))||0,{count:r}=await $a.from("lats_spare_parts").select("id",{count:"exact",head:!0}).lte("quantity",$a.raw("min_quantity")).gt("quantity",0),{count:s}=await $a.from("lats_spare_parts").select("id",{count:"exact",head:!0}).eq("quantity",0),{count:n}=await $a.from("lats_spare_parts").select("category_id",{count:"exact",head:!0}).not("category_id","is",null),{count:i}=await $a.from("lats_spare_parts").select("supplier_id",{count:"exact",head:!0}).not("supplier_id","is",null);return{total_spare_parts:e||0,total_value:a,low_stock_count:r||0,out_of_stock_count:s||0,categories_count:n||0,suppliers_count:i||0}}catch(iu){return{total_spare_parts:0,total_value:0,low_stock_count:0,out_of_stock_count:0,categories_count:0,suppliers_count:0}}},getSparePartUsage:async(e,t=1,a=20)=>{try{const r=(t-1)*a,s=r+a-1,{data:n,error:i,count:o}=await $a.from("lats_spare_part_usage").select("\n        *,\n        spare_part:lats_spare_parts(name, part_number)\n      ").eq("spare_part_id",e).order("created_at",{ascending:!1}).range(r,s);if(i)throw i;return{data:n||[],message:"Usage history retrieved successfully",ok:!0,total:o||0,page:t,limit:a}}catch(iu){return{data:[],message:iu instanceof Error?iu.message:"Failed to fetch usage history",ok:!1,total:0,page:t,limit:a}}},getSparePartVariants:un,getSpareParts:async(e={},t={field:"created_at",direction:"desc"},a=1,r=20)=>{var s;try{let n=$a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name),\n        variants:lats_spare_part_variants!spare_part_id(*)\n      ");if(e.category_id&&(n=n.eq("category_id",e.category_id)),e.supplier_id&&(n=n.eq("supplier_id",e.supplier_id)),e.condition&&(n=n.eq("condition",e.condition)),e.brand&&(n=n.ilike("brand",`%${e.brand}%`)),void 0!==e.is_active&&(n=n.eq("is_active",e.is_active)),e.low_stock&&(n=n.lte("quantity",$a.raw("min_quantity"))),e.out_of_stock&&(n=n.eq("quantity",0)),e.search){const{data:t,error:i}=await $a.rpc("search_spare_parts_fn",{search_query:e.search,page_number:a,page_size:r});if(i)throw i;if(!t||0===t.length)return{data:[],message:"No spare parts found",ok:!0,total:0,page:a,limit:r};const o=(null==(s=t[0])?void 0:s.total_count)||0,c=t.map(e=>e.id);n=n.in("id",c);const{data:l,error:d}=await n;if(d)throw d;return{data:l||[],message:"Spare parts retrieved successfully",ok:!0,total:o,page:a,limit:r}}n=n.order(t.field,{ascending:"asc"===t.direction});const i=(a-1)*r,o=i+r-1;n=n.range(i,o);const{data:c,error:l,count:d}=await n;if(l)throw l;return{data:c||[],message:"Spare parts retrieved successfully",ok:!0,total:d||0,page:a,limit:r}}catch(iu){return{data:[],message:iu instanceof Error?iu.message:"Failed to fetch spare parts",ok:!1,total:0,page:a,limit:r}}},getVariantStats:mn,getVariantsWithFilters:async e=>{try{let t=$a.from("lats_spare_part_variants").select("\n        *,\n        spare_part:lats_spare_parts(\n          *,\n          category:lats_categories!category_id(name)\n        )\n      ",{count:"exact"});e.sparePartId&&(t=t.eq("spare_part_id",e.sparePartId)),e.searchTerm&&(t=t.or(`name.ilike.%${e.searchTerm}%,sku.ilike.%${e.searchTerm}%`)),void 0!==e.minPrice&&(t=t.gte("selling_price",e.minPrice)),void 0!==e.maxPrice&&(t=t.lte("selling_price",e.maxPrice)),void 0!==e.inStock&&(t=e.inStock?t.gt("quantity",0):t.eq("quantity",0));const a=e.limit||20,r=e.offset||0;t=t.range(r,r+a-1),t=t.order("created_at",{ascending:!1});const{data:s,error:n,count:i}=await t;if(n)throw n;let o=s||[];return e.attributes&&Object.keys(e.attributes).length>0&&(o=o.filter(t=>!!t.variant_attributes&&Object.entries(e.attributes).every(([e,a])=>{const r=t.variant_attributes[e];return"string"==typeof a?String(r).toLowerCase().includes(a.toLowerCase()):r===a}))),{data:o,total:i||0,message:"Variants retrieved successfully",ok:!0}}catch(iu){return{data:[],total:0,message:iu instanceof Error?iu.message:"Failed to get variants",ok:!1}}},recordSparePartUsage:on,rejectSpareParts:fn,searchSpareParts:async e=>{try{const{data:t,error:a}=await $a.rpc("search_spare_parts_fn",{search_query:e,page_number:1,page_size:10});if(a)throw a;if(!t||0===t.length)return[];const r=t.map(e=>e.id),{data:s,error:n}=await $a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name),\n        variants:lats_spare_part_variants!spare_part_id(*)\n      ").in("id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw n;return s||[]}catch(iu){return[]}},searchSparePartsWithVariants:async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_parts").select("\n        *,\n        category:lats_categories!category_id(name),\n        variants:lats_spare_part_variants!spare_part_id(*)\n      ").or(`part_number.ilike.%${e}%,name.ilike.%${e}%,description.ilike.%${e}%`).eq("is_active",!0),{data:r,error:s}=await $a.from("lats_spare_part_variants").select("\n        *,\n        spare_part:lats_spare_parts(\n          *,\n          category:lats_categories!category_id(name)\n        )\n      ").or(`name.ilike.%${e}%,sku.ilike.%${e}%`).eq("spare_part.is_active",!0),n=new Map;(t||[]).forEach(e=>{n.set(e.id,e)}),(r||[]).forEach(e=>{if(e.spare_part){const t=e.spare_part;if(n.has(t.id)){const a=n.get(t.id);a.variants||(a.variants=[]);a.variants.some(t=>t.id===e.id)||a.variants.push(e)}else t.variants=[e],n.set(t.id,t)}});return Array.from(n.values()).sort((e,t)=>e.name.localeCompare(t.name)).slice(0,20)}catch(iu){return[]}},searchVariantsByAttributes:dn,searchVariantsComprehensive:async e=>{try{const{data:t,error:a}=await $a.from("lats_spare_part_variants").select("\n        *,\n        spare_part:lats_spare_parts(\n          *,\n          category:lats_categories!category_id(name)\n        )\n      ").or(`name.ilike.%${e}%,sku.ilike.%${e}%`),r=await dn(e),{data:s,error:n}=await $a.from("lats_spare_part_variants").select("\n        *,\n        spare_part:lats_spare_parts(\n          *,\n          category:lats_categories!category_id(name)\n        )\n      ").ilike("spare_part.name",`%${e}%`),i=new Map;(t||[]).forEach(e=>{i.set(e.id,e)}),r.forEach(e=>{i.set(e.id,e)}),(s||[]).forEach(e=>{i.set(e.id,e)});return{data:Array.from(i.values()).sort((e,t)=>e.name.localeCompare(t.name)).slice(0,50),message:"Variants found successfully",ok:!0}}catch(iu){return{data:[],message:iu instanceof Error?iu.message:"Failed to search variants",ok:!1}}},updateSparePart:async(e,t)=>{try{const{data:{user:a}}=await $a.auth.getUser(),r={...en(t),updated_by:null==a?void 0:a.id},{data:s,error:n}=await $a.from("lats_spare_parts").update(r).eq("id",e).select().single();if(n)throw n;return{data:s,message:"Spare part updated successfully",ok:!0}}catch(iu){return null==iu||iu.response,{data:null,message:iu instanceof Error?iu.message:"Failed to update spare part",ok:!1}}},updateSparePartVariant:async(e,t)=>{try{const{data:{user:a}}=await $a.auth.getUser(),r={...t,updated_by:null==a?void 0:a.id},{data:s,error:n}=await $a.from("lats_spare_part_variants").update(r).eq("id",e).select().single();if(n)throw n;return{data:s,message:"Variant updated successfully",ok:!0}}catch(iu){return{data:null,message:iu instanceof Error?iu.message:"Failed to update variant",ok:!1}}},updateSparePartWithVariants:hn,validateStockAvailability:async(e,t)=>{try{const{data:a,error:r}=await $a.from("lats_spare_parts").select("quantity, name").eq("id",e).single();return r?{isValid:!1,availableStock:0,partName:"Unknown",error:`Failed to fetch spare part: ${r.message}`}:a?a.quantity<t?{isValid:!1,availableStock:a.quantity,partName:a.name,error:`Insufficient stock for ${a.name}. Available: ${a.quantity}, Needed: ${t}`}:{isValid:!0,availableStock:a.quantity,partName:a.name}:{isValid:!1,availableStock:0,partName:"Unknown",error:`Spare part not found: ${e}`}}catch(iu){return{isValid:!1,availableStock:0,partName:"Unknown",error:iu instanceof Error?iu.message:"Unknown error"}}}},Symbol.toStringTag,{value:"Module"})),vn=Br()(zr(Wr((e,t)=>({isLoading:!1,isCreating:!1,isUpdating:!1,isDeleting:!1,isDataLoading:!1,isCategoriesLoading:!1,isSuppliersLoading:!1,lastDataLoadTime:0,dataCache:{categories:null,suppliers:null,products:null,stockMovements:null,sales:null,spareParts:null},cacheTimestamp:0,CACHE_DURATION:9e5,categories:[],suppliers:[],products:[],sales:[],stockMovements:[],purchaseOrders:[],spareParts:[],sparePartUsage:[],searchTerm:"",selectedCategory:null,selectedSupplier:null,stockFilter:"all",currentPage:1,itemsPerPage:20,totalItems:0,selectedProducts:[],selectedPurchaseOrders:[],error:null,setLoading:t=>e({isLoading:t}),setError:t=>e({error:t}),clearError:()=>e({error:null}),setSearchTerm:t=>e({searchTerm:t,currentPage:1}),setSelectedCategory:t=>e({selectedCategory:t,currentPage:1}),setSelectedSupplier:t=>e({selectedSupplier:t,currentPage:1}),setStockFilter:t=>e({stockFilter:t,currentPage:1}),clearFilters:()=>e({searchTerm:"",selectedCategory:null,selectedSupplier:null,stockFilter:"all",currentPage:1}),setCurrentPage:t=>e({currentPage:t}),setItemsPerPage:t=>e({itemsPerPage:t,currentPage:1}),toggleProductSelection:a=>{const{selectedProducts:r}=t(),s=r.includes(a)?r.filter(e=>e!==a):[...r,a];e({selectedProducts:s})},selectAllProducts:()=>{const{getFilteredProducts:a}=t(),r=a().map(e=>e.id);e({selectedProducts:r})},deselectAllProducts:()=>e({selectedProducts:[]}),forceRefreshProducts:async()=>{const a=t();e({dataCache:{...a.dataCache,products:null},cacheTimestamp:0,products:[],isDataLoading:!1,isLoading:!1}),await t().loadProducts({page:1,limit:200},!0)},togglePurchaseOrderSelection:a=>{const{selectedPurchaseOrders:r}=t(),s=r.includes(a)?r.filter(e=>e!==a):[...r,a];e({selectedPurchaseOrders:s})},selectAllPurchaseOrders:()=>{const{purchaseOrders:a}=t(),r=a.map(e=>e.id);e({selectedPurchaseOrders:r})},deselectAllPurchaseOrders:()=>e({selectedPurchaseOrders:[]}),isCacheValid:e=>{const a=t(),r=Date.now()-a.cacheTimestamp;return null!==a.dataCache[e]&&r<a.CACHE_DURATION},updateCache:(a,r)=>{const s=t();e({dataCache:{...s.dataCache,[a]:r},cacheTimestamp:Date.now()})},clearCache:a=>{const r=t();e(a?{dataCache:{...r.dataCache,[a]:null}}:{dataCache:{categories:null,suppliers:null,products:null,stockMovements:null,sales:null},cacheTimestamp:0})},invalidateCache:a=>{const r=t();e({dataCache:{...r.dataCache,[a]:null}})},loadCategories:async()=>{const a=t();if(a.isCacheValid("categories"),!a.isCategoriesLoading){e({isLoading:!0,isCategoriesLoading:!0,error:null});try{const a=await Zs.getCategories();a.length>0&&Qs(a);const r=Ws(a),s=t().categories;(!s||s.length!==r.length||s.some((e,t)=>!r[t]||e.id!==r[t].id||e.name!==r[t].name))&&(e({categories:r,lastDataLoadTime:Date.now(),error:null}),t().updateCache("categories",r),qs.track("categories_loaded",{count:r.length}))}catch(iu){Qr("Failed to load categories",iu,{component:"useInventoryStore",action:"loadCategories"});const a=[{id:"sample-category",name:"Electronics",description:"Electronic devices and accessories",color:"#3B82F6",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:1,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-category-2",name:"Accessories",description:"Phone and device accessories",color:"#10B981",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:2,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-category-3",name:"Repair Parts",description:"Repair and replacement parts",color:"#F59E0B",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:3,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}];e({categories:a,error:"Using sample categories due to database connection issue"})}finally{e({isLoading:!1,isCategoriesLoading:!1})}}},loadSparePartCategories:async()=>{if(!t().isDataLoading){e({isLoading:!0,isDataLoading:!0,error:null});try{const a=await Zs.getSparePartCategories();a.length>0&&Qs(a);const r=Ws(a),s=t().categories;(!s||s.length!==r.length||s.some((e,t)=>!r[t]||e.id!==r[t].id||e.name!==r[t].name))&&(e({categories:r,lastDataLoadTime:Date.now(),error:null}),qs.track("spare_part_categories_loaded",{count:r.length}))}catch(iu){e({error:"Failed to load spare part categories"})}finally{e({isLoading:!1,isDataLoading:!1})}}},createCategory:async a=>{var r;e({isCreating:!0,error:null});try{const e=Os(),s=await e.createCategory(a);return s.ok&&(t().invalidateCache("categories"),Zs.invalidateCache(),qs.track("category_created",{categoryId:null==(r=s.data)?void 0:r.id})),s}catch(iu){const a="Failed to create category";return e({error:a}),Qr("Failed to create category",iu,{component:"useInventoryStore",action:"createCategory"}),{ok:!1,message:a}}finally{e({isCreating:!1})}},updateCategory:async(a,r)=>{e({isUpdating:!0,error:null});try{const e=Os(),s=await e.updateCategory(a,r);return s.ok&&(t().invalidateCache("categories"),Zs.invalidateCache(),qs.track("category_updated",{categoryId:a})),s}catch(iu){const a="Failed to update category";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},deleteCategory:async a=>{e({isDeleting:!0,error:null});try{const e=Os(),r=await e.deleteCategory(a);return r.ok&&(t().invalidateCache("categories"),Zs.invalidateCache(),qs.track("category_deleted",{categoryId:a})),r}catch(iu){const a="Failed to delete category";return e({error:a}),{ok:!1,message:a}}finally{e({isDeleting:!1})}},loadSuppliers:async()=>{const a=t();if(a.isCacheValid("suppliers")){const t=a.dataCache.suppliers||[];return void e({suppliers:t})}if(a.isSuppliersLoading)return;e({isSuppliersLoading:!0,error:null});const r=new Promise((e,t)=>setTimeout(()=>t(new Error("Supplier fetch timeout")),15e3));try{const a=Hs(await Promise.race([ps(),r]));0===a.length?e({suppliers:[],error:"No suppliers found. Please run database setup."}):e({suppliers:a,lastDataLoadTime:Date.now(),error:null}),t().updateCache("suppliers",a),qs.track("suppliers_loaded",{count:a.length})}catch(iu){e({error:"Failed to load suppliers. Check database connection.",suppliers:[]})}finally{e({isSuppliersLoading:!1})}},createSupplier:async a=>{e({isCreating:!0,error:null});try{const e=await _s(a);return await t().loadSuppliers(),qs.track("supplier_created",{supplierId:e.id}),{ok:!0,data:e}}catch(iu){const a="Failed to create supplier";return e({error:a}),{ok:!1,message:a}}finally{e({isCreating:!1})}},updateSupplier:async(a,r)=>{e({isUpdating:!0,error:null});try{const e=await fs(a,r);return await t().loadSuppliers(),qs.track("supplier_updated",{supplierId:a}),{ok:!0,data:e}}catch(iu){const a="Failed to update supplier";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},deleteSupplier:async a=>{e({isDeleting:!0,error:null});try{const e=Os(),r=await e.deleteSupplier(a);return r.ok&&(await t().loadSuppliers(),qs.track("supplier_deleted",{supplierId:a})),r}catch(iu){const a="Failed to delete supplier";return e({error:a}),{ok:!1,message:a}}finally{e({isDeleting:!1})}},loadProducts:async(a,r=!1)=>{var s,n,i,o,c;const l=t();if(l.isDataLoading&&!r)return;const d={page:1,limit:200,...a};if(!a){const t=Js.getProducts();if(t&&t.length>0)return void e({products:t,isLoading:!1})}if(!a&&l.isCacheValid("products"))return void e({products:l.dataCache.products||[]});const u=Date.now();e({isLoading:!0,error:null,isDataLoading:!0});const m=new Promise((e,t)=>{setTimeout(()=>t(new Error("Products loading timeout after 75 seconds. This may indicate a database connectivity issue.")),75e3)});try{const r=Os(),l=await Promise.race([r.getProducts(d),m]);Date.now();if(l.ok){const r=(null==(s=l.data)?void 0:s.data)||l.data||[];r.length>0&&Qs(r);const d=Vs(r||[]),u={currentPage:(null==(n=l.data)?void 0:n.page)||1,totalItems:(null==(i=l.data)?void 0:i.total)||d.length,totalPages:(null==(o=l.data)?void 0:o.totalPages)||1,itemsPerPage:(null==(c=l.data)?void 0:c.limit)||200},m={supplier:0,category:0,variants:0,price:0,stock:0};d.forEach(e=>{e.supplier||m.supplier++,e.category||m.category++,e.variants&&0!==e.variants.length||m.variants++,e.price&&0!==e.price||m.price++,e.totalQuantity&&0!==e.totalQuantity||m.stock++}),e({products:d,...u,error:null}),a||(t().updateCache("products",d),Js.saveProducts(d)),qs.track("products_loaded",{count:d.length,page:u.currentPage,total:u.totalItems})}else{const t=l.message||"Failed to load products";Qr(`Provider returned error: ${t}`,void 0,{component:"useInventoryStore",action:"loadProducts",metadata:{message:l.message}}),e({error:t})}}catch(iu){const a=[{id:"sample-category",name:"Electronics",description:"Electronic devices and accessories",color:"#3B82F6",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:1,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-category-2",name:"Accessories",description:"Phone and device accessories",color:"#10B981",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:2,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-category-3",name:"Repair Parts",description:"Repair and replacement parts",color:"#F59E0B",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:3,metadata:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}],r=[{id:"sample-1",name:"Sample iPhone 13",shortDescription:"Sample iPhone 13 for testing",sku:"IPH13-SAMPLE",categoryId:"sample-category",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:10,totalValue:5e4,price:5e4,costPrice:4e4,priceRange:"50000",condition:"new",internalNotes:"Sample product for testing",attributes:{color:"Black",storage:"128GB"},variants:[{id:"sample-variant-1",productId:"sample-1",sku:"IPH13-SAMPLE-BLK-128",name:"Black 128GB",attributes:{color:"Black",storage:"128GB"},costPrice:4e4,sellingPrice:5e4,quantity:10,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-2",name:"Sample Samsung Galaxy",shortDescription:"Sample Samsung Galaxy for testing",sku:"SAMSUNG-SAMPLE",categoryId:"sample-category-2",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:15,totalValue:45e3,price:45e3,costPrice:35e3,priceRange:"45000",condition:"new",internalNotes:"Sample product for testing",attributes:{color:"Blue",storage:"256GB"},variants:[{id:"sample-variant-2",productId:"sample-2",sku:"SAMSUNG-SAMPLE-BLU-256",name:"Blue 256GB",attributes:{color:"Blue",storage:"256GB"},costPrice:35e3,sellingPrice:45e3,quantity:15,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},{id:"sample-3",name:"Sample iPhone Screen",shortDescription:"Sample iPhone screen replacement",sku:"IPH-SCREEN-SAMPLE",categoryId:"sample-category-3",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:5,totalValue:25e3,price:25e3,costPrice:2e4,priceRange:"25000",condition:"new",internalNotes:"Sample repair part for testing",attributes:{model:"iPhone 13",color:"Black"},variants:[{id:"sample-variant-3",productId:"sample-3",sku:"IPH-SCREEN-SAMPLE-BLK",name:"Black Screen",attributes:{model:"iPhone 13",color:"Black"},costPrice:2e4,sellingPrice:25e3,quantity:5,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}],createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}];e({products:r,categories:a,error:"Using sample products and categories due to database connection issue",isLoading:!1,isDataLoading:!1})}finally{e({isLoading:!1,isDataLoading:!1})}},loadProductVariants:async e=>{try{const t=Os(),a=await t.getProductVariants(e);return a.ok?{ok:!0,data:a.data}:{ok:!1,message:a.message}}catch(iu){return{ok:!1,message:"Failed to load product variants"}}},getProduct:async e=>{try{const t=Os();return await t.getProduct(e)}catch(iu){return{ok:!1,message:"Failed to get product"}}},createProduct:async a=>{var r;e({isCreating:!0,error:null});try{const s=Os(),n=await s.createProduct(a);return n.ok?(t().clearCache("products"),Js.clearProducts(),await t().loadProducts(null,!0),qs.track("product_created",{productId:null==(r=n.data)?void 0:r.id})):e({error:n.message||"Failed to create product"}),n}catch(iu){const a="Failed to create product";return e({error:a}),{ok:!1,message:a}}finally{e({isCreating:!1})}},updateProduct:async(a,r)=>{e({isUpdating:!0,error:null});try{const s=Os(),n=await s.updateProduct(a,r);return n.ok?(t().clearCache("products"),Js.clearProducts(),await t().loadProducts(null,!0),qs.track("product_updated",{productId:a})):e({error:n.message||"Failed to update product"}),n}catch(iu){const a="Failed to update product";return e({error:a}),{ok:!1,message:(null==iu?void 0:iu.message)||a}}finally{e({isUpdating:!1})}},deleteProduct:async a=>{e({isDeleting:!0,error:null});try{const e=Os(),r=await e.deleteProduct(a);if(!r.ok)throw new Error(r.message||"Failed to delete product");t().clearCache("products"),Js.clearProducts(),await t().loadProducts(null,!0),qs.track("product_deleted",{productId:a})}catch(iu){throw e({error:"Failed to delete product"}),iu}finally{e({isDeleting:!1})}},searchProducts:async e=>{try{const t=Os();return await t.searchProducts(e)}catch(iu){return{ok:!1,message:"Failed to search products",data:[]}}},loadStockMovements:async()=>{const a=t();if(a.isCacheValid("stockMovements"))e({stockMovements:a.dataCache.stockMovements||[]});else{e({isLoading:!0,error:null});try{const a=Os(),r=await a.getStockMovements();if(r.ok){const a=r.data||[];e({stockMovements:a}),t().updateCache("stockMovements",a),qs.track("stock_movements_loaded",{count:a.length})}else e({error:r.message||"Failed to load stock movements"})}catch(iu){e({error:"Failed to load stock movements"})}finally{e({isLoading:!1})}}},adjustStock:async(a,r,s,n)=>{e({isUpdating:!0,error:null});try{const e=Os(),i=await e.adjustStock(a,r,s,n);return i.ok&&(await t().loadProducts(),await t().loadStockMovements(),qs.track("stock_adjusted",{productId:a,variantId:r,quantity:s,reason:n})),i}catch(iu){const a="Failed to adjust stock";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},loadSales:async()=>{const a=t();if(a.isCacheValid("sales"))e({sales:a.dataCache.sales||[]});else{e({isLoading:!0,error:null});try{const a=Os(),r=await a.getSales();if(r.ok){const a=r.data||[];e({sales:a}),t().updateCache("sales",a),qs.track("sales_loaded",{count:a.length})}else e({error:r.message||"Failed to load sales"})}catch(iu){e({error:"Failed to load sales"})}finally{e({isLoading:!1})}}},getProductSales:async e=>{try{const t=Os();return await t.getProductSales(e)}catch(iu){return{ok:!1,message:"Failed to get product sales",data:[]}}},getSoldQuantity:(e,a)=>t().sales.filter(t=>t.product_id===e&&t.variant_id===a).reduce((e,t)=>e+t.quantity,0),loadPurchaseOrders:async()=>{var a;const r=t();if(!r.isLoading&&!r.isDataLoading){e({isLoading:!0,isDataLoading:!0,error:null});try{const t=Os(),r=await t.getPurchaseOrders();r.ok?(e({purchaseOrders:r.data||[]}),qs.track("purchase_orders_loaded",{count:(null==(a=r.data)?void 0:a.length)||0})):e({error:r.message||"Failed to load purchase orders"})}catch(iu){e({error:"Failed to load purchase orders"})}finally{e({isLoading:!1,isDataLoading:!1})}}},getPurchaseOrder:async e=>{try{if(!e)return{ok:!1,message:"Purchase order ID is required"};const t=Os(),a=await t.getPurchaseOrder(e);return a.ok,a}catch(iu){return iu instanceof Error?iu.message.includes("network")||iu.message.includes("fetch")?{ok:!1,message:"Network error: Please check your internet connection"}:iu.message.includes("timeout")?{ok:!1,message:"Request timeout: Please try again"}:{ok:!1,message:`Error: ${iu.message}`}:{ok:!1,message:"Failed to get purchase order: Unknown error occurred"}}},createPurchaseOrder:async a=>{var r;e({isCreating:!0,error:null});try{const e=Os(),s=await e.createPurchaseOrder(a);return s.ok&&(await t().loadPurchaseOrders(),qs.track("purchase_order_created",{orderId:null==(r=s.data)?void 0:r.id})),s}catch(iu){const a="Failed to create purchase order";return e({error:a}),{ok:!1,message:a}}finally{e({isCreating:!1})}},updatePurchaseOrder:async(a,r)=>{e({isUpdating:!0,error:null});try{const e=Os(),s=await e.updatePurchaseOrder(a,r);return s.ok&&(await t().loadPurchaseOrders(),qs.track("purchase_order_updated",{orderId:a})),s}catch(iu){const a="Failed to update purchase order";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},receivePurchaseOrder:async a=>{e({isUpdating:!0,error:null});try{const e=Os(),r=await e.receivePurchaseOrder(a);return r.ok&&(await t().loadPurchaseOrders(),await t().loadProducts(),qs.track("purchase_order_received",{orderId:a})),r}catch(iu){const a="Failed to receive purchase order";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},updatePurchaseOrderStatus:async(a,r)=>{e({isUpdating:!0,error:null});try{const e=Os(),s=await e.updatePurchaseOrder(a,{status:r});return s.ok&&(await t().loadPurchaseOrders(),qs.track("purchase_order_status_updated",{orderId:a,status:r})),s}catch(iu){const a="Failed to update purchase order status";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},approvePurchaseOrder:async a=>{var r;e({isUpdating:!0,error:null});try{const e=Os(),s=await e.updatePurchaseOrder(a,{status:"sent",approvedAt:(new Date).toISOString(),approvedBy:null==(r=t().currentUser)?void 0:r.id});return s.ok&&(await t().loadPurchaseOrders(),qs.track("purchase_order_approved",{orderId:a})),s}catch(iu){const a="Failed to approve purchase order";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},deletePurchaseOrder:async a=>{e({isDeleting:!0,error:null});try{const e=Os(),r=await e.deletePurchaseOrder(a);return r.ok&&(await t().loadPurchaseOrders(),qs.track("purchase_order_deleted",{orderId:a})),r}catch(iu){const a="Failed to delete purchase order";return e({error:a}),{ok:!1,message:a}}finally{e({isDeleting:!1})}},loadSpareParts:async()=>{e({isLoading:!0,error:null});try{const a=Os(),r=await a.getSpareParts();if(r.ok){const a=r.data||[];e({spareParts:a}),t().updateCache("spareParts",a),qs.track("spare_parts_loaded",{count:a.length})}else e({error:r.message||"Failed to load spare parts"})}catch(iu){e({error:"Failed to load spare parts"})}finally{e({isLoading:!1})}},getSparePart:async e=>{try{const t=Os();return await t.getSparePart(e)}catch(iu){return{ok:!1,message:"Failed to get spare part"}}},createSparePart:async a=>{var r;e({isCreating:!0,error:null});try{const e=await sn(a);return e.ok&&(t().clearCache("spareParts"),await t().loadSpareParts(),qs.track("spare_part_created",{sparePartId:null==(r=e.data)?void 0:r.id})),e}catch(iu){const a="Failed to create spare part";return e({error:a}),{ok:!1,message:a}}finally{e({isCreating:!1})}},createOrUpdateSparePart:async a=>{var r;e({isCreating:!0,error:null});try{const e=await ln(a);return e.ok&&(t().clearCache("spareParts"),await t().loadSpareParts(),qs.track("spare_part_created_or_updated",{sparePartId:null==(r=e.data)?void 0:r.id})),e}catch(iu){const a="Failed to create or update spare part";return e({error:a}),{ok:!1,message:a}}finally{e({isCreating:!1})}},updateSparePart:async(a,r)=>{e({isUpdating:!0,error:null});try{const e=await hn(a,r);return e.ok&&(t().clearCache("spareParts"),await t().loadSpareParts(),qs.track("spare_part_updated",{sparePartId:a})),e}catch(iu){const a="Failed to update spare part";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},deleteSparePart:async a=>{e({isDeleting:!0,error:null});try{const e=await nn(a);return e.ok&&(await t().loadSpareParts(),qs.track("spare_part_deleted",{sparePartId:a})),e}catch(iu){const a="Failed to delete spare part";return e({error:a}),{ok:!1,message:a}}finally{e({isDeleting:!1})}},useSparePart:async(a,r,s,n)=>{e({isUpdating:!0,error:null});try{const e={spare_part_id:a,quantity_used:r,reason:s,notes:n},i=await on(e);return i.ok&&(await t().loadSpareParts(),await t().loadSparePartUsage(),qs.track("spare_part_used",{sparePartId:a,quantity:r,reason:s})),i}catch(iu){const a="Failed to use spare part";return e({error:a}),{ok:!1,message:a}}finally{e({isUpdating:!1})}},loadSparePartUsage:async()=>{var t;e({isLoading:!0,error:null});try{const a=Os(),r=await a.getSparePartUsage();r.ok?(e({sparePartUsage:r.data||[]}),qs.track("spare_part_usage_loaded",{count:(null==(t=r.data)?void 0:t.length)||0})):e({error:r.message||"Failed to load spare part usage"})}catch(iu){e({error:"Failed to load spare part usage"})}finally{e({isLoading:!1})}},getFilteredProducts:()=>{const{products:e,searchTerm:a,selectedCategory:r,selectedSupplier:s,stockFilter:n}=t();return e.filter(e=>{var t,i;if(a){const r=a.toLowerCase();if(!(e.name.toLowerCase().includes(r)||e.description.toLowerCase().includes(r)||(null==(t=e.variants)?void 0:t.some(e=>{var t;return null==(t=e.sku)?void 0:t.toLowerCase().includes(r)}))||!1))return!1}if(r&&e.categoryId!==r)return!1;if(s&&e.supplierId!==s)return!1;if("all"!==n){const t=(null==(i=e.variants)?void 0:i.reduce((e,t)=>e+(t.quantity||0),0))||0;switch(n){case"in-stock":if(t<=0)return!1;break;case"low-stock":if(t>10)return!1;break;case"out-of-stock":if(t>0)return!1}}return!0})},getLowStockProducts:()=>{const{products:e}=t();return e.filter(e=>{var t;const a=(null==(t=e.variants)?void 0:t.reduce((e,t)=>e+(t.quantity||0),0))||0;return a>0&&a<=10})},getOutOfStockProducts:()=>{const{products:e}=t();return e.filter(e=>{var t;return((null==(t=e.variants)?void 0:t.reduce((e,t)=>e+(t.quantity||0),0))||0)<=0})},getProductById:e=>{const{products:a}=t();if(!e)return;if("object"==typeof e)return;const r=String(e).trim();return r?a.find(e=>e.id===r):void 0},getCategoryById:e=>{const{categories:a}=t();if(!e||"object"==typeof e)return;const r=String(e).trim();return a.find(e=>e.id===r)},getSupplierById:e=>{const{suppliers:a}=t();if(!e||"object"==typeof e)return;const r=String(e).trim();return a.find(e=>e.id===r)}})),{name:"lats-inventory-store",enabled:!1}));ks.subscribeToAll(e=>{const t=vn.getState();if(!t.isDataLoading)switch(e.type){case"lats:category.created":case"lats:category.updated":case"lats:category.deleted":t.isCacheValid("categories")||t.loadCategories();break;case"lats:supplier.created":case"lats:supplier.updated":case"lats:supplier.deleted":t.isCacheValid("suppliers")||t.loadSuppliers();break;case"lats:product.created":case"lats:product.updated":case"lats:product.deleted":t.forceRefreshProducts();break;case"lats:stock.updated":t.forceRefreshProducts(),t.isCacheValid("stockMovements")||t.loadStockMovements();break;case"lats:purchase-order.created":case"lats:purchase-order.updated":case"lats:purchase-order.received":case"lats:purchase-order.deleted":break;case"lats:spare-part.created":case"lats:spare-part.updated":case"lats:spare-part.deleted":t.isCacheValid("spareParts")||t.loadSpareParts();break;case"lats:spare-part.used":t.isCacheValid("spareParts")||t.loadSpareParts(),t.isCacheValid("sparePartUsage")||t.loadSparePartUsage();break;case"lats:sale.completed":t.isCacheValid("products")||t.loadProducts(),t.isCacheValid("stockMovements")||t.loadStockMovements(),t.isCacheValid("sales")||t.loadSales()}});const wn=e.createContext(void 0),bn=()=>{const t=e.useContext(wn);if(!t)throw new Error("useAuth must be used within an AuthProvider");return t};let Sn=!1;const xn=({children:t})=>{const[a,r]=e.useState(null),[n,i]=e.useState(!0),[o,c]=e.useState(null),l=e.useRef(!1),d=e.useRef(0),u=e.useRef(!1);e.useEffect(()=>{"undefined"!=typeof window&&(window.__AUTH_DATA_LOADED_FLAG__=u.current)},[]);const m=async()=>{if(!u.current)try{u.current=!0,await new Promise(e=>setTimeout(e,500));const t=[h(),p(),g()],a=await Promise.allSettled(t);try{const e=vn.getState(),t=[e.loadProducts({page:1,limit:50}),e.loadCategories(),e.loadSuppliers()],r=await Promise.allSettled(t),s=[...a,...r];s.filter(e=>"fulfilled"===e.status).length,s.length}catch(e){a.filter(e=>"fulfilled"===e.status).length}}catch(t){}},h=async()=>{try{let t=0;const a=3;for(;t<a;)try{const{fetchAllCustomersSimple:e}=await s(()=>import("./customerApi-3e6f5bd3.js"),["assets/customerApi-3e6f5bd3.js","assets/supabase-7e851d02.js","assets/appointments-4d8aac45.js","assets/search-674d386b.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"]);return await e()}catch(e){if(t++,!(t<a))throw e;await new Promise(e=>setTimeout(e,1e3))}return[]}catch(e){return[]}},p=async()=>{try{const{fetchAllDevices:e}=await s(()=>Promise.resolve().then(()=>ci),void 0);return await e()}catch(e){return[]}},g=async()=>{try{const{POSSettingsService:e}=await s(()=>Promise.resolve().then(()=>Ja),void 0);return await e.loadGeneralSettings()}catch(e){return null}},_=async e=>{var t,a,s,n;try{let{data:n,error:o}=await $a.from("users").select("*").eq("id",e.id).single();if(o||!n){const{data:t,error:a}=await $a.from("users").select("*").eq("email",e.email).single();!a&&t&&(n=t)}if(!n){const r="admin@pos.com"===e.email||"care@care.com"===e.email?"admin":"technician",s={id:e.id,email:e.email,username:(null==(t=e.email)?void 0:t.split("@")[0])||"user",full_name:(null==(a=e.email)?void 0:a.split("@")[0])||"User",password:"123456",role:r,is_active:!0,permissions:"admin"===r?["all"]:["view_devices","view_customers"],max_devices_allowed:1e3,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{error:i}=await $a.from("users").insert([s]);i||(n=s)}if(!n){const t="admin@pos.com"===e.email||"care@care.com"===e.email,a=t?"admin":"technician",n={...e,role:a,full_name:(null==(s=e.email)?void 0:s.split("@")[0])||"User",is_active:!0,permissions:t?["all"]:["view_devices","update_device_status","view_customers"]};return r(n),i(!1),void m()}const c=function(e){return{...e,isActive:e.is_active,maxDevicesAllowed:e.max_devices_allowed||10,requireApproval:e.require_approval||!1,failedLoginAttempts:e.failed_login_attempts||0,twoFactorEnabled:e.two_factor_enabled||!1,twoFactorSecret:e.two_factor_secret,lastLogin:e.last_login,permissions:e.permissions&&Array.isArray(e.permissions)&&e.permissions.length>0?e.permissions:(e=>{switch(e){case"admin":return["all"];case"technician":return["view_devices","update_device_status","view_customers","view_spare_parts"];case"customer-care":return["view_customers","create_customers","edit_customers","view_devices","assign_devices"];default:return["view_devices","update_device_status","view_customers"]}})(e.role),assignedDevices:[],assignedCustomers:[]}}(n);r(c),i(!1)}catch(o){const t="admin@pos.com"===e.email||"care@care.com"===e.email,a=t?"admin":"technician",s={...e,role:a,full_name:(null==(n=e.email)?void 0:n.split("@")[0])||"User",is_active:!0,permissions:t?["all"]:["view_devices","update_device_status","view_customers"]};r(s),i(!1)}},f=async()=>{try{const e=await Fa(async()=>await $a.auth.refreshSession()),{data:t,error:a}=e;return!a&&(!!t.session&&(await _(t.session.user),!0))}catch(e){return!1}};e.useEffect(()=>{if(l.current||Sn)return void((e,t,...a)=>{Za.log("warn",e,t,...a)})("AuthProvider","Already initialized, skipping...");if(e="AuthProvider",!Za.trackInitialization(e))return;var e;Sn=!0,d.current++,tr("AuthProvider",`Initializing (mount #${d.current})`);const{data:{subscription:t}}=$a.auth.onAuthStateChange((e,t)=>{var s;tr("AuthProvider",`Auth state change: ${e}`,null==(s=null==t?void 0:t.user)?void 0:s.email),"SIGNED_IN"===e&&(null==t?void 0:t.user)?(tr("AuthProvider",`User signed in: ${t.user.email}`),_(t.user)):"SIGNED_OUT"===e?(tr("AuthProvider","User signed out"),r(null),i(!1),u.current=!1):"TOKEN_REFRESHED"===e&&(null==t?void 0:t.user)&&(tr("AuthProvider",`Token refreshed for user: ${t.user.email}`),a||_(t.user))});return(async()=>{var e,t,a,s,n,c;try{i(!0),tr("AuthProvider","Checking for existing session...");const s=await(async()=>{try{const{data:{session:e},error:t}=await $a.auth.getSession();if(t)return!1;if(!e)return!1;const a=Math.floor(Date.now()/1e3);return!(e.expires_at&&e.expires_at<a)}catch(o){return!1}})();if(!s)return tr("AuthProvider","No valid session found, clearing auth state"),await ar(),r(null),i(!1),void(l.current=!0);const{data:{session:n},error:c}=await $a.auth.getSession();if(c)return er("AuthProvider","Session error:",c),((null==(e=c.message)?void 0:e.includes("403"))||(null==(t=c.message)?void 0:t.includes("Forbidden"))||(null==(a=c.message)?void 0:a.includes("bad_jwt")))&&(tr("AuthProvider","403 error detected, clearing auth state"),await rr()),r(null),void i(!1);(null==n?void 0:n.user)?(tr("AuthProvider",`Found existing session for user: ${n.user.email}`),await _(n.user)):(tr("AuthProvider","No existing session found"),r(null)),i(!1),l.current=!0,tr("AuthProvider","Auth initialization complete")}catch(d){er("AuthProvider","Error initializing auth:",d),((null==(s=null==d?void 0:d.message)?void 0:s.includes("403"))||(null==(n=null==d?void 0:d.message)?void 0:n.includes("Forbidden"))||(null==(c=null==d?void 0:d.message)?void 0:c.includes("bad_jwt")))&&(tr("AuthProvider","403 error in catch block, clearing auth state"),await rr()),r(null),i(!1),l.current=!0}})(),()=>{tr("AuthProvider","Cleaning up AuthProvider"),t.unsubscribe(),d.current--}},[]),e.useEffect(()=>{a&&!u.current&&m()},[a]);return $.jsx(wn.Provider,{value:{currentUser:a,login:async(e,t)=>{try{c(null),i(!0);const{data:a,error:r}=await $a.auth.signInWithPassword({email:e,password:t});return r?(c(r.message||"Invalid email or password"),i(!1),!1):a.user?(await _(a.user),i(!1),!0):(c("Login failed"),i(!1),!1)}catch(a){return c("An unexpected error occurred during login"),i(!1),!1}},logout:async()=>{try{i(!0),Ka.clearUserCache(),await $a.auth.signOut(),r(null),c(null),u.current=!1}catch(e){}finally{i(!1)}},isAuthenticated:!!a,error:o,clearError:()=>c(null),loading:n,refreshSession:f,handleAuthError:async e=>{var t,a,s,n,i,o;if(401===(null==e?void 0:e.status)||403===(null==e?void 0:e.status)||(null==(t=null==e?void 0:e.message)?void 0:t.includes("401"))||(null==(a=null==e?void 0:e.message)?void 0:a.includes("403"))||(null==(s=null==e?void 0:e.message)?void 0:s.includes("Unauthorized"))||(null==(n=null==e?void 0:e.message)?void 0:n.includes("Forbidden"))||(null==(i=null==e?void 0:e.message)?void 0:i.includes("bad_jwt"))||(null==(o=null==e?void 0:e.message)?void 0:o.includes("missing sub claim"))){const e=await f();return e||(await rr(),r(null),c("Session expired. Please log in again.")),e}return!1},hasPermission:e=>or(a,e),hasAnyPermission:e=>cr(a,e),hasAllPermissions:e=>lr(a,e),canAccessRoute:e=>function(e,t){if(!e)return!1;if(or(e,"all"))return!0;for(const[a,r]of Object.entries(ir)){const s=a.replace(/:\w+/g,"[^/]+");if(new RegExp(`^${s}$`).test(t))return cr(e,r)}return!0}(a,e),getUserPermissions:()=>dr(a),hasRole:e=>ur(a,e),checkAccess:e=>function(e,t){if(!e)return!1;const{roles:a,permissions:r,requireAll:s=!1}=t;return!!(a&&a.length>0&&ur(e,a))||!!(r&&r.length>0)&&(s?lr(e,r):cr(e,r))}(a,e),Permission:mr},children:t})},kn=e.createContext(void 0),En=({children:t})=>{const{currentUser:a}=bn(),[r,s]=e.useState(null),[n,i]=e.useState([]),[o,c]=e.useState(!0);e.useEffect(()=>{a&&l()},[a]);const l=async()=>{try{c(!0);const{data:t,error:r}=await $a.from("store_locations").select("*").eq("is_active",!0).order("is_main",{ascending:!1}).order("name",{ascending:!0});if(r)throw r;if(i(t||[]),"admin"===(null==a?void 0:a.role)){const e=localStorage.getItem("current_branch_id"),a=null==t?void 0:t.find(t=>t.id===e),r=null==t?void 0:t.find(e=>e.is_main),n=a||r||(null==t?void 0:t[0])||null;return n&&localStorage.setItem("current_branch_id",n.id),s(n),void c(!1)}try{const{data:e,error:r}=await $a.from("user_branch_assignments").select("*").eq("user_id",null==a?void 0:a.id);if(r){const e=null==t?void 0:t.find(e=>e.is_main);return s(e||(null==t?void 0:t[0])||null),void c(!1)}if(e&&e.length>0){const a=e.map(e=>e.branch_id).filter(Boolean),{data:r,error:n}=await $a.from("store_locations").select("*").in("id",a);if(n){const e=null==t?void 0:t.find(e=>e.is_main);return s(e||(null==t?void 0:t[0])||null),void c(!1)}const o=new Map((null==r?void 0:r.map(e=>[e.id,e]))||[]),l=e.map(e=>({...e,store_locations:o.get(e.branch_id)})),d=l.find(e=>e.is_primary),u=(null==d?void 0:d.store_locations)||l[0].store_locations;u&&localStorage.setItem("current_branch_id",u.id),s(u);const m=e.map(e=>e.branch_id);i((null==t?void 0:t.filter(e=>m.includes(e.id)))||[])}else{const e=(null==t?void 0:t.find(e=>e.is_main))||(null==t?void 0:t[0])||null;e&&localStorage.setItem("current_branch_id",e.id),s(e)}}catch(e){const a=(null==t?void 0:t.find(e=>e.is_main))||(null==t?void 0:t[0])||null;a&&localStorage.setItem("current_branch_id",a.id),s(a)}}catch(iu){u.error("Failed to load branch information")}finally{c(!1)}},d=e=>"admin"===(null==a?void 0:a.role)||n.some(t=>t.id===e),m={currentBranch:r,availableBranches:n,loading:o,switchBranch:async e=>{const t=n.find(t=>t.id===e);if(t)if(d(e)){s(t),localStorage.setItem("current_branch_id",e),u.success(`Switched to ${t.name}`);try{await $a.from("branch_activity_log").insert({branch_id:e,user_id:null==a?void 0:a.id,action_type:"BRANCH_SWITCH",description:`User switched to branch: ${t.name}`,metadata:{previous_branch:null==r?void 0:r.id}})}catch(i){}}else u.error("You do not have permission to access this branch");else u.error("Branch not found or not accessible")},canAccessBranch:d,isDataShared:e=>{if(!r)return!0;if("shared"===r.data_isolation_mode)return!0;if("isolated"===r.data_isolation_mode)return!1;return{products:r.share_products,customers:r.share_customers,inventory:r.share_inventory,suppliers:r.share_suppliers,categories:r.share_categories,employees:r.share_employees}[e]??!1},getBranchFilterClause:()=>r?"admin"===(null==a?void 0:a.role)&&r.can_view_other_branches?"":`(branch_id.eq.${r.id},or(is_shared.eq.true))`:"",refreshBranches:async()=>{await l()}};return $.jsx(kn.Provider,{value:m,children:t})},In=()=>{const t=e.useContext(kn);if(void 0===t)throw new Error("useBranch must be used within a BranchProvider");return t},An=e.createContext(void 0),Pn=({children:t})=>{const[a,r]=e.useState((()=>{const e=new Date,t=new Date;return t.setDate(e.getDate()-7),{startDate:t,endDate:e,preset:"7days"}})());return $.jsx(An.Provider,{value:{dateRange:a,setDateRange:r,getDateRangeForQuery:()=>({startDate:a.startDate.toISOString(),endDate:a.endDate.toISOString()})},children:t})},Cn=()=>{const t=e.useContext(An);if(!t)throw new Error("useDateRange must be used within a DateRangeProvider");return t};let Tn,jn;const Dn=new WeakMap,Rn=new WeakMap,Ln=new WeakMap,On=new WeakMap,qn=new WeakMap;let Nn={get(e,t,a){if(e instanceof IDBTransaction){if("done"===t)return Rn.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Ln.get(e);if("store"===t)return a.objectStoreNames[1]?void 0:a.objectStore(a.objectStoreNames[0])}return Bn(e[t])},set:(e,t,a)=>(e[t]=a,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Mn(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(jn||(jn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply($n(this),t),Bn(Dn.get(this))}:function(...t){return Bn(e.apply($n(this),t))}:function(t,...a){const r=e.call($n(this),t,...a);return Ln.set(r,t.sort?t.sort():[t]),Bn(r)}}function Un(e){return"function"==typeof e?Mn(e):(e instanceof IDBTransaction&&function(e){if(Rn.has(e))return;const t=new Promise((t,a)=>{const r=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",n),e.removeEventListener("abort",n)},s=()=>{t(),r()},n=()=>{a(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",s),e.addEventListener("error",n),e.addEventListener("abort",n)});Rn.set(e,t)}(e),t=e,(Tn||(Tn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some(e=>t instanceof e)?new Proxy(e,Nn):e);var t}function Bn(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,a)=>{const r=()=>{e.removeEventListener("success",s),e.removeEventListener("error",n)},s=()=>{t(Bn(e.result)),r()},n=()=>{a(e.error),r()};e.addEventListener("success",s),e.addEventListener("error",n)});return t.then(t=>{t instanceof IDBCursor&&Dn.set(t,e)}).catch(()=>{}),qn.set(t,e),t}(e);if(On.has(e))return On.get(e);const t=Un(e);return t!==e&&(On.set(e,t),qn.set(t,e)),t}const $n=e=>qn.get(e);function Fn(e,t,{blocked:a,upgrade:r,blocking:s,terminated:n}={}){const i=indexedDB.open(e,t),o=Bn(i);return r&&i.addEventListener("upgradeneeded",e=>{r(Bn(i.result),e.oldVersion,e.newVersion,Bn(i.transaction),e)}),a&&i.addEventListener("blocked",e=>a(e.oldVersion,e.newVersion,e)),o.then(e=>{n&&e.addEventListener("close",()=>n()),s&&e.addEventListener("versionchange",e=>s(e.oldVersion,e.newVersion,e))}).catch(()=>{}),o}const zn=["get","getKey","getAll","getAllKeys","count"],Vn=["put","add","delete","clear"],Wn=new Map;function Hn(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Wn.get(t))return Wn.get(t);const a=t.replace(/FromIndex$/,""),r=t!==a,s=Vn.includes(a);if(!(a in(r?IDBIndex:IDBObjectStore).prototype)||!s&&!zn.includes(a))return;const n=async function(e,...t){const n=this.transaction(e,s?"readwrite":"readonly");let i=n.store;return r&&(i=i.index(t.shift())),(await Promise.all([i[a](...t),s&&n.done]))[0]};return Wn.set(t,n),n}Nn=(e=>({...e,get:(t,a,r)=>Hn(t,a)||e.get(t,a,r),has:(t,a)=>!!Hn(t,a)||e.has(t,a)}))(Nn);const Qn="clean-app-cache",Gn=["customers","devices","returns"],Kn=3e5;async function Yn(){return Fn(Qn,4,{upgrade(e,t,a){for(const r of Gn)e.objectStoreNames.contains(r)||e.createObjectStore(r,{keyPath:"id"});e.objectStoreNames.contains("cache_metadata")||e.createObjectStore("cache_metadata",{keyPath:"store"})}})}async function Jn(e,t){try{const a=(await Yn()).transaction([e,"cache_metadata"],"readwrite");await a.objectStore(e).clear();const r=Date.now();for(const s of t)await a.objectStore(e).put({...s,_cachedAt:r});await a.objectStore("cache_metadata").put({store:e,lastUpdated:r,itemCount:t.length}),await a.done}catch(iu){}}async function Xn(e){try{const t=(await Yn()).transaction([e,"cache_metadata"],"readonly"),a=await t.objectStore("cache_metadata").get(e);if(a&&Date.now()-a.lastUpdated>Kn)return[];return(await t.objectStore(e).getAll()).map(e=>{const{_cachedAt:t,...a}=e;return a})}catch(iu){return[]}}async function Zn(){try{const e=(await Yn()).transaction([...Gn,"cache_metadata"],"readwrite");for(const t of Gn)await e.objectStore(t).clear();await e.objectStore("cache_metadata").clear(),await e.done}catch(iu){}}async function ei(){try{await async function(e){return new Promise((t,a)=>{const r=indexedDB.deleteDatabase(e);r.onsuccess=()=>t(),r.onerror=()=>a(r.error)})}(Qn)}catch(iu){}}async function ti(){try{const e=(await Yn()).transaction("cache_metadata","readonly");await e.objectStore("cache_metadata").get("test")}catch(iu){try{await ei(),await Yn()}catch(e){}}}"undefined"!=typeof window&&(window.resetCleanAppCache=async()=>{try{await ei()}catch(iu){}},window.clearCleanAppCache=async()=>{try{await Zn()}catch(iu){}});const ai=Object.freeze(Object.defineProperty({__proto__:null,cacheClear:async function(e){try{const t=(await Yn()).transaction([e,"cache_metadata"],"readwrite");await t.objectStore(e).clear(),await t.objectStore("cache_metadata").delete(e),await t.done}catch(iu){}},cacheGetAll:Xn,cacheGetStats:async function(){try{const e=await Yn(),t={};for(const a of Gn){const r=e.transaction("cache_metadata","readonly"),s=await r.objectStore("cache_metadata").get(a);s&&(t[a]={itemCount:s.itemCount,lastUpdated:new Date(s.lastUpdated),isValid:Date.now()-s.lastUpdated<=Kn})}return t}catch(iu){return{}}},cacheIsValid:async function(e){try{const t=(await Yn()).transaction("cache_metadata","readonly"),a=await t.objectStore("cache_metadata").get(e);return!!a&&Date.now()-a.lastUpdated<=Kn}catch(iu){return!1}},cacheSetAll:Jn,clearAllCache:Zn,getCacheDB:Yn,initializeCache:ti,resetCacheDatabase:ei},Symbol.toStringTag,{value:"Module"}));async function ri(){if(!navigator.onLine)return await Xn("devices");try{const e=localStorage.getItem("current_branch_id");let t=$a.from("devices").select("\n          id,\n          customer_id,\n          brand,\n          model,\n          serial_number,\n          problem_description,\n          status,\n          technician_id,\n          estimated_completion_date,\n          created_at,\n          updated_at,\n          estimated_cost,\n          actual_cost,\n          deposit_amount\n        ").order("created_at",{ascending:!1});e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;if(r){const{data:e,error:t}=await $a.from("devices").select("\n            id,\n            customer_id,\n            brand,\n            model,\n            serial_number,\n            problem_description,\n            status,\n            technician_id,\n            estimated_completion_date,\n            created_at,\n            updated_at,\n            estimated_cost,\n            actual_cost,\n            deposit_amount\n          ").order("created_at",{ascending:!1});if(t)throw t;const a=(e||[]).map(e=>{const t=(e.remarks||[]).map(e=>({id:e.id,content:e.content,createdBy:e.created_by,createdAt:e.created_at})),a=(e.transitions||[]).map(e=>({id:e.id,fromStatus:e.from_status,toStatus:e.to_status,performedBy:e.performed_by,timestamp:e.created_at,signature:e.signature||""})),r=(e.ratings||[]).map(e=>({id:e.id,deviceId:e.device_id,technicianId:e.technician_id,score:e.score||5,comment:e.comment,createdAt:e.created_at}));return{...e,serialNumber:e.serial_number,issueDescription:e.issue_description,customerId:e.customer_id,assignedTo:e.assigned_to,expectedReturnDate:e.expected_return_date,customerName:"",phoneNumber:"",remarks:t,transitions:a,ratings:r,createdAt:e.created_at,updatedAt:e.updated_at}});return await Jn("devices",a),a}const s=(a||[]).map(e=>{var t,a,r,s,n,i,o;return{...e,serialNumber:e.serial_number,issueDescription:e.issue_description,customerId:e.customer_id,assignedTo:e.assigned_to,expectedReturnDate:e.expected_return_date,customerName:(null==(t=e.customers)?void 0:t.name)||"",phoneNumber:(null==(a=e.customers)?void 0:a.phone)||"",customerEmail:(null==(r=e.customers)?void 0:r.email)||"",customerLoyaltyLevel:(null==(s=e.customers)?void 0:s.loyalty_level)||"",customerTotalSpent:(null==(n=e.customers)?void 0:n.total_spent)||0,customerLastVisit:(null==(i=e.customers)?void 0:i.last_visit)||null,customerColorTag:(null==(o=e.customers)?void 0:o.color_tag)||"",repairCost:e.repair_cost||null,depositAmount:e.deposit_amount||null,deviceCost:e.device_cost,repairPrice:e.repair_price||null,unlockCode:null,diagnosisRequired:e.diagnosis_required,deviceNotes:e.device_notes,deviceCondition:null,diagnosticChecklist:null,repairChecklist:null,remarks:[],transitions:[],ratings:[],createdAt:e.created_at,updatedAt:e.updated_at}});return await Jn("devices",s),s}catch(iu){return await Xn("devices")}}async function si(e){const t=localStorage.getItem("current_branch_id"),a={id:e.id,branch_id:t||"00000000-0000-0000-0000-000000000001",customer_id:e.customerId,device_name:e.model||`${e.brand} Device`||"Unknown Device",brand:e.brand,model:e.model,serial_number:e.serialNumber,problem_description:e.issueDescription,issue_description:e.issueDescription,status:e.status,technician_id:e.assignedTo||null,assigned_to:e.assignedTo||null,expected_return_date:""===e.expectedReturnDate?null:e.expectedReturnDate,estimated_completion_date:""===e.expectedReturnDate?null:e.expectedReturnDate,created_at:e.createdAt,updated_at:e.updatedAt,unlock_code:e.unlockCode||null,repair_cost:e.repairCost||null,repair_price:e.repairPrice||null,deposit_amount:e.depositAmount||null,diagnosis_required:e.diagnosisRequired||!1,device_notes:e.deviceNotes||null,device_cost:e.deviceCost||null,estimated_hours:e.estimatedHours||null,device_condition:e.deviceCondition||null},{data:r,error:s}=await $a.from("devices").insert([a]).select();if(s)throw s;return r&&r[0]?r[0]:null}async function ni(e,t){const a=["assigned","diagnosis-started","awaiting-parts","parts-arrived","in-repair","reassembled-testing","repair-complete","process-payments","returned-to-customer-care","done","failed"],r=["assignedTo","serialNumber","issueDescription","customerId","expectedReturnDate","estimatedHours","warrantyStart","warrantyEnd","warrantyStatus","repairCount","lastReturnDate","brand","model","status"],s={};if(Object.keys(t).forEach(e=>{if(r.includes(e)&&void 0!==t[e]){const r=t[e];if("status"===e){if("string"!=typeof r||!a.includes(r))return void("string"==typeof r&&r.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i));s[e]=r}else s[e]=r}}),0===Object.keys(s).length)return{success:!1,message:"No valid updates to process"};const n={...s};"assignedTo"in n&&(n.assigned_to=n.assignedTo,delete n.assignedTo),"serialNumber"in n&&(n.serial_number=n.serialNumber,delete n.serialNumber),"issueDescription"in n&&(n.issue_description=n.issueDescription,delete n.issueDescription),"customerId"in n&&(n.customer_id=n.customerId,delete n.customerId),"expectedReturnDate"in n&&(n.expected_return_date=n.expectedReturnDate,delete n.expectedReturnDate),"estimatedHours"in n&&(n.estimated_hours=n.estimatedHours,delete n.estimatedHours),"warrantyStart"in n&&(n.warranty_start=n.warrantyStart,delete n.warrantyStart),"warrantyEnd"in n&&(n.warranty_end=n.warrantyEnd,delete n.warrantyEnd),"warrantyStatus"in n&&(n.warranty_status=n.warrantyStatus,delete n.warrantyStatus),"repairCount"in n&&(n.repair_count=n.repairCount,delete n.repairCount),"lastReturnDate"in n&&(n.last_return_date=n.lastReturnDate,delete n.lastReturnDate);const i=["id","customer_id","brand","model","serial_number","issue_description","status","assigned_to","estimated_hours","expected_return_date","warranty_start","warranty_end","warranty_status","repair_count","last_return_date","diagnostic_checklist","created_at","updated_at"];Object.keys(n).forEach(e=>{i.includes(e)||delete n[e]});const{data:o,error:c}=await $a.from("devices").select("*").eq("id",e).single();if(c)throw new Error(`Device with ID ${e} not found`);Object.keys(n).forEach(e=>{o[e],n[e]});const{data:l,error:d}=await $a.from("devices").update(n).eq("id",e).select();if(d)throw d;return l&&l[0]?{...l[0],assignedTo:l[0].assigned_to}:null}async function ii(e){const{error:t}=await $a.from("devices").delete().eq("id",e);if(t)throw t;return!0}const oi={},ci=Object.freeze(Object.defineProperty({__proto__:null,addDeviceToDb:si,default:oi,deleteDeviceFromDb:ii,deviceServices:{},fetchAllDevices:ri,fetchAllDevicesDirect:async function(){const e=localStorage.getItem("current_branch_id");let t=$a.from("devices").select("\n      id,\n      customer_id,\n      brand,\n      model,\n      serial_number,\n      problem_description,\n      status,\n      technician_id,\n      estimated_completion_date,\n      created_at,\n      updated_at\n    ");e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;if(r)throw r;return(a||[]).map(e=>({...e,createdAt:e.created_at,updatedAt:e.updated_at}))},fetchDevicesPage:async function(e,t=20){const a=e*t,r=a+t-1;if(!navigator.onLine)return await Xn("devices");try{const e=localStorage.getItem("current_branch_id");let t=$a.from("devices").select("\n          id,\n          customer_id,\n          brand,\n          model,\n          serial_number,\n          problem_description,\n          status,\n          technician_id,\n          estimated_completion_date,\n          created_at,\n          updated_at,\n          estimated_cost,\n          actual_cost,\n          deposit_amount\n        ").order("created_at",{ascending:!1}).range(a,r);e&&(t=t.eq("branch_id",e));const{data:s,error:n}=await t;if(n){const{data:e,error:t}=await $a.from("devices").select("\n            id,\n            customer_id,\n            brand,\n            model,\n            serial_number,\n            problem_description,\n            status,\n            technician_id,\n            estimated_completion_date,\n            created_at,\n            updated_at,\n            estimated_cost,\n            actual_cost,\n            deposit_amount\n          ").order("created_at",{ascending:!1}).range(a,r);if(t)throw t;return(e||[]).map(e=>{const t=(e.remarks||[]).map(e=>({id:e.id,content:e.content,createdBy:e.created_by,createdAt:e.created_at})),a=(e.transitions||[]).map(e=>({id:e.id,fromStatus:e.from_status,toStatus:e.to_status,performedBy:e.performed_by,timestamp:e.created_at,signature:e.signature||""})),r=(e.ratings||[]).map(e=>({id:e.id,deviceId:e.device_id,technicianId:e.technician_id,score:e.score||5,comment:e.comment,createdAt:e.created_at}));return{...e,serialNumber:e.serial_number,issueDescription:e.issue_description,customerId:e.customer_id,assignedTo:e.assigned_to,expectedReturnDate:e.expected_return_date,customerName:"",phoneNumber:"",remarks:t,transitions:a,ratings:r,createdAt:e.created_at,updatedAt:e.updated_at}})}return(s||[]).map(e=>{var t,a,r,s,n,i,o;return{...e,serialNumber:e.serial_number,issueDescription:e.issue_description,customerId:e.customer_id,assignedTo:e.assigned_to,expectedReturnDate:e.expected_return_date,customerName:(null==(t=e.customers)?void 0:t.name)||"",phoneNumber:(null==(a=e.customers)?void 0:a.phone)||"",customerEmail:(null==(r=e.customers)?void 0:r.email)||"",customerLoyaltyLevel:(null==(s=e.customers)?void 0:s.loyalty_level)||"",customerTotalSpent:(null==(n=e.customers)?void 0:n.total_spent)||0,customerLastVisit:(null==(i=e.customers)?void 0:i.last_visit)||null,customerColorTag:(null==(o=e.customers)?void 0:o.color_tag)||"",repairCost:e.repair_cost||null,depositAmount:e.deposit_amount||null,deviceCost:e.device_cost,repairPrice:e.repair_price||null,unlockCode:null,diagnosisRequired:e.diagnosis_required,deviceNotes:e.device_notes,deviceCondition:null,diagnosticChecklist:null,repairChecklist:null,remarks:[],transitions:[],ratings:[],createdAt:e.created_at,updatedAt:e.updated_at}})}catch(iu){throw iu}},fixCorruptedDeviceData:async function(e){try{const{data:t,error:a}=await $a.from("devices").select("*").eq("id",e).single();if(a||!t)return!1;if(t.status&&t.status.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)){const{error:t}=await $a.from("devices").update({status:"assigned"}).eq("id",e);return!t}return!1}catch(iu){return!1}},getDevicesCount:async function(){if(navigator.onLine){const{count:e,error:t}=await $a.from("devices").select("id",{count:"exact",head:!0});if(t)throw t;return e||0}return(await Xn("devices")).length},inventoryService:oi,updateDeviceInDb:ni},Symbol.toStringTag,{value:"Module"})),li=class{static startKeepAlive(){this.keepAliveInterval||(this.keepAliveInterval=setInterval(async()=>{if(this.audioContext&&"suspended"===this.audioContext.state)try{await this.audioContext.resume()}catch(iu){}},1e3))}static stopKeepAlive(){this.keepAliveInterval&&(clearInterval(this.keepAliveInterval),this.keepAliveInterval=null)}static async initialize(){this.isInitialized&&this.audioContext||this.userInteracted&&(this.initializationPromise||(this.initializationPromise=this.createAudioContext()),await this.initializationPromise)}static async createAudioContext(){try{if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;if(!e)return void(this.isInitialized=!0);this.audioContext=new e,"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isInitialized=!0}}catch(iu){this.isInitialized=!0}}static markUserInteracted(){this.userInteracted||(this.userInteracted=!0,this.initialize())}static getStats(){var e;return{isInitialized:this.isInitialized,userInteracted:this.userInteracted,hasAudioContext:!!this.audioContext,audioContextState:(null==(e=this.audioContext)?void 0:e.state)||"not-created",soundsPlayed:this.soundsPlayed,soundErrors:this.soundErrors,successRate:this.soundsPlayed>0?(this.soundsPlayed/(this.soundsPlayed+this.soundErrors)*100).toFixed(1)+"%":"N/A"}}static logStatus(){this.getStats()}static forceUserInteraction(){this.userInteracted=!0,this.initialize()}static async playRemarkSound(){if(this.userInteracted)if(this.markUserInteracted(),await this.initialize(),this.audioContext&&"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.frequency.setValueAtTime(600,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(800,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}}}else this.playFallbackSound()}static playFallbackSound(){}static async playSuccessSound(){if(this.markUserInteracted(),await this.initialize(),this.audioContext&&"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(523,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(784,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}}}}static async playErrorSound(){if(this.markUserInteracted(),await this.initialize(),this.audioContext&&"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(784,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(523,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}}}}static async playClickSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext)return void this.soundErrors++;if("suspended"===this.audioContext.state&&await this.audioContext.resume(),"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(1e3,this.audioContext.currentTime),e.type="square",t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.05),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.05),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}},this.soundsPlayed++}else this.soundErrors++}catch(iu){this.soundErrors++}}static playCartAddSound(){try{if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;e&&(this.audioContext=new e,this.isInitialized=!0,this.userInteracted=!0)}if(!this.audioContext)return void this.soundErrors++;if("suspended"===this.audioContext.state)return void this.audioContext.resume().then(()=>{this.playCartAddSoundImmediate()});this.playCartAddSoundImmediate()}catch(iu){this.soundErrors++}}static playCartAddSoundImmediate(){try{if(!this.audioContext||"running"!==this.audioContext.state)return;const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.frequency.setValueAtTime(1e3,this.audioContext.currentTime+.05),e.type="sine",t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.15),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}},this.soundsPlayed++}catch(iu){this.soundErrors++}}static async playPaymentSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext)return void this.soundErrors++;if("suspended"===this.audioContext.state&&await this.audioContext.resume(),"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(523,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(784,this.audioContext.currentTime+.2),e.frequency.setValueAtTime(1047,this.audioContext.currentTime+.3),t.gain.setValueAtTime(.25,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.4),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.4),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}},this.soundsPlayed++}else this.soundErrors++}catch(iu){this.soundErrors++}}static async playDeleteSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext)return void this.soundErrors++;if("suspended"===this.audioContext.state&&await this.audioContext.resume(),"running"===this.audioContext.state){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(600,this.audioContext.currentTime),e.frequency.setValueAtTime(400,this.audioContext.currentTime+.1),e.type="sawtooth",t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.2),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.2),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch(a){}},this.soundsPlayed++}else this.soundErrors++}catch(iu){this.soundErrors++}}static async testSound(){try{await this.playRemarkSound()}catch(iu){}}};li.audioContext=null,li.isInitialized=!1,li.userInteracted=!1,li.initializationPromise=null,li.soundsPlayed=0,li.soundErrors=0,li.keepAliveInterval=null,(()=>{const e=async()=>{li.markUserInteracted();try{const e=window.AudioContext||window.webkitAudioContext;e&&!li.audioContext&&(li.audioContext=new e,"suspended"===li.audioContext.state&&await li.audioContext.resume(),li.isInitialized=!0,li.startKeepAlive())}catch(iu){}document.removeEventListener("click",e,!0),document.removeEventListener("keydown",e,!0),document.removeEventListener("touchstart",e,!0)};document.addEventListener("click",e,!0),document.addEventListener("keydown",e,!0),document.addEventListener("touchstart",e,!0)})();let di=li;async function ui(e,t="general"){try{const{error:a}=await $a.rpc("track_customer_activity",{customer_id:e,activity_type:t});if(a)throw a}catch(iu){throw iu}}async function mi(e){try{const{data:t,error:a}=await $a.rpc("get_customer_status",{customer_id:e});if(a)throw a;if(!t||0===t.length)return null;const r=t[0];return{id:r.id,name:r.name,isActive:r.is_active,memberSince:r.member_since,lastVisit:r.last_visit,daysSinceActivity:r.days_since_activity,statusReason:r.status_reason}}catch(iu){throw iu}}async function hi(e){try{const{error:t}=await $a.from("customers").update({is_active:!0,last_activity_date:(new Date).toISOString(),last_visit:(new Date).toISOString(),updated_at:(new Date).toISOString()}).eq("id",e);if(t)throw t}catch(iu){throw iu}}async function pi(e,t){try{const{data:a,error:r}=await $a.from("customers").select("is_active, name").eq("id",e).single();let s=!1;r||!a||a.is_active||(await hi(e),s=!0);const{error:n}=await $a.from("customer_checkins").insert([{customer_id:e,staff_id:t,checkin_date:(new Date).toISOString()}]);if(n)return{success:!1,message:"Failed to record check-in"};await ui(e,"checkin");return{success:!0,message:s?"Customer checked in and reactivated successfully!":"Customer checked in successfully!",wasReactivated:s}}catch(iu){return{success:!1,message:"Failed to check in customer"}}}const gi={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2};function _i(e){const t=e.message||e.toString(),a=e.name||"",r=e.code||"";if(t.includes("QUIC_PROTOCOL_ERROR")||t.includes("net::ERR_QUIC_PROTOCOL_ERROR"))return!0;const s=["Failed to fetch","NetworkError","NETWORK_ERROR","AbortError","TimeoutError","Connection refused","Connection reset","Connection timeout","Service Unavailable","Gateway Timeout","Internal Server Error"].some(e=>t.includes(e)||a.includes(e)),n=["NETWORK_ERROR","ABORT_ERR","TIMEOUT_ERR"].includes(r),i=e.status||e.code,o=[408,429,500,502,503,504].includes(i);return s||n||o}function fi(e){const{error:t,context:a,retryCount:r=0,maxRetries:s=0}=e,n=t.message||t.toString();n.includes("QUIC_PROTOCOL_ERROR")||n.includes("net::ERR_QUIC_PROTOCOL_ERROR"),n.includes("Failed to fetch"),n.includes("Service Unavailable")}async function yi(e,t={}){const a={...gi,...t};let r;for(let s=0;s<=a.maxRetries;s++)try{return await e()}catch(iu){if(r=iu,fi({error:iu,context:"Network request",retryCount:s,maxRetries:a.maxRetries}),!_i(iu)||s>=a.maxRetries)throw iu;const t=Math.min(a.baseDelay*Math.pow(a.backoffMultiplier,s),a.maxDelay)+1e3*Math.random();await new Promise(e=>setTimeout(e,t))}throw r}async function vi(e,t=9e4,a={}){return yi(async()=>function(e,t,a="Request timeout"){return Promise.race([e,new Promise((e,r)=>{setTimeout(()=>r(new Error(a)),t)})])}(e(),t,`Request timed out after ${t}ms`),a)}const wi=9e4,bi=new Map;function Si(){if(!$a)throw new Error("Supabase client not initialized");return $a}async function xi(e,t=3,a=1e3){return vi(e,wi,{maxRetries:t,baseDelay:a,maxDelay:1e4,backoffMultiplier:2})}async function ki(e,t=9e4){const a=new Promise((e,a)=>{setTimeout(()=>a(new Error(`Request timeout after ${t}ms`)),t)});return Promise.race([e,a])}function Ei(){const e=function(){const e={online:navigator.onLine,connectionType:"unknown",effectiveType:"unknown",downlink:0,rtt:0,saveData:!1};if("connection"in navigator){const t=navigator.connection;t&&(e.connectionType=t.effectiveType||"unknown",e.effectiveType=t.effectiveType||"unknown",e.downlink=t.downlink||0,e.rtt=t.rtt||0,e.saveData=t.saveData||!1)}return e}();return e.online?"slow-2g"===e.effectiveType||"2g"===e.effectiveType?{quality:"poor",message:"Slow connection detected"}:"3g"===e.effectiveType?{quality:"fair",message:"Moderate connection speed"}:"4g"===e.effectiveType?{quality:"good",message:"Good connection speed"}:{quality:"unknown",message:"Connection quality unknown"}:{quality:"offline",message:"No internet connection"}}function Ii(e){if(!e)return"new";return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[e.trim().toLowerCase()]||"new"}function Ai(e){return"Tsh "+Number(e).toLocaleString("en-TZ",{minimumFractionDigits:0,maximumFractionDigits:0})}async function Pi(){const e="fetchAllCustomers";if(bi.has(e))return bi.get(e);const t=async function(){if(!navigator.onLine){return await s(()=>Promise.resolve().then(()=>ai),void 0).then(e=>e.cacheGetAll("customers"))||[]}try{const a=localStorage.getItem("current_branch_id");let r="shared",s=!0;if(a)try{const{data:e}=await Si().from("store_locations").select("data_isolation_mode, share_customers").eq("id",a).single();e&&(r=e.data_isolation_mode,s="shared"===r||"hybrid"===r&&e.share_customers)}catch(e){}const{count:n,error:i}=await ki(xi(async()=>{let e=Si().from("customers").select("id",{count:"exact",head:!0});a&&!s&&(e=e.eq("branch_id",a));const t=await e;if(t.error)throw t.error;return t}),wi);if(i)throw i;const o=50,c=Math.ceil((n||0)/o),l=[],d=Math.min(c,100);for(let e=1;e<=d;e++){const r=(e-1)*o,n=r+o-1;try{const{data:i,error:o}=await ki(xi(async()=>{let e=Si().from("customers").select("\n                  id,name,phone,email,whatsapp,gender,city,country,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,birthday,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared,created_by_branch_id,created_by_branch_name,profile_image,whatsapp_opt_out,referred_by,created_by,last_purchase_date,total_purchases,total_calls,total_call_duration_minutes,incoming_calls,outgoing_calls,missed_calls,avg_call_duration_minutes,first_call_date,last_call_date,call_loyalty_level,total_returns\n                ").range(r,n).order("created_at",{ascending:!1});a&&!s&&(e=e.or(`branch_id.eq.${a},is_shared.eq.true`));const t=await e;if(t.error)throw t.error;return t}),wi);if(o)throw o;if(i&&i.length>0){new Set(i.map(e=>e.branch_id)),i.filter(e=>!e.branch_id).length}if(i&&Array.isArray(i)){const e=(e,t=0)=>{if(null==e)return t;const a="string"==typeof e?parseFloat(e):Number(e);return isNaN(a)||a>1e12||a<0?t:a};let a={};try{const e=[...new Set(i.map(e=>e.branch_id).filter(Boolean))];if(e.length>0){const t=Si().from("store_locations").select("id, name").in("id",e),r=await t;r.data&&(a=r.data.reduce((e,t)=>(e[t.id]=t.name,e),{}))}}catch(t){}const r=i.map(t=>({id:t.id,name:t.name,email:t.email,phone:t.phone,gender:t.gender,city:t.city,joinedDate:t.joined_date||t.created_at,loyaltyLevel:t.loyalty_level,colorTag:Ii(t.color_tag||"new"),referredBy:null,totalSpent:e(t.total_spent,0),points:e(t.points,0),lastVisit:t.last_visit,branchName:a[t.branch_id]||t.created_by_branch_name||"Unknown Branch",isActive:t.is_active,referralSource:t.referral_source,birthMonth:t.birth_month,birthDay:t.birth_day,totalReturns:0,profileImage:null,createdAt:t.created_at,updatedAt:t.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,whatsapp:t.phone,whatsappOptOut:!1,initialNotes:t.initial_notes,locationDescription:t.location_description,nationalId:t.national_id,notes:t.notes?"string"==typeof t.notes?(()=>{try{return JSON.parse(t.notes)}catch{return[]}})():t.notes:[],referrals:[],customerTag:t.customer_tag,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[],branchId:t.branch_id,createdByBranchId:t.created_by_branch_id,createdByBranchName:t.created_by_branch_name}));l.push(...r)}e<d&&await new Promise(e=>setTimeout(e,100))}catch(iu){break}}if(a){new Set(l.map(e=>e.branchId)),l.filter(e=>!e.branchId).length,l.filter(e=>e.branchId&&e.branchId!==a).length}else{new Set(l.map(e=>e.branchId).filter(Boolean)),l.filter(e=>!e.branchId).length}return l.slice(0,3).forEach((e,t)=>{}),l}catch(iu){throw iu}}();bi.set(e,t);try{return await t}finally{setTimeout(()=>{bi.delete(e)},1e3)}}async function Ci(){const e="fetchAllCustomersSimple";if(bi.has(e))return bi.get(e);const t=async function(){if(!navigator.onLine){return await s(()=>Promise.resolve().then(()=>ai),void 0).then(e=>e.cacheGetAll("customers"))||[]}try{const a=localStorage.getItem("current_branch_id");let r="shared",s=!0;if(a)try{const{data:e}=await Si().from("store_locations").select("data_isolation_mode, share_customers").eq("id",a).single();e&&(r=e.data_isolation_mode,s="shared"===r||"hybrid"===r&&e.share_customers)}catch(e){}const n=await ki(xi(async()=>{let e=Si().from("customers").select("id",{count:"exact",head:!0});a&&!s&&(e=e.eq("branch_id",a));return await e}),wi);if(n.error)throw n.error;const i=n.count??-1;if((i>0||-1===i)&&(i<=1e5||-1===i)){const{data:e,error:r}=await ki(xi(async()=>{let e=Si().from("customers").select("\n                id,name,phone,email,whatsapp,gender,city,country,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,birthday,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared,created_by_branch_id,created_by_branch_name,profile_image,whatsapp_opt_out,referred_by,created_by,last_purchase_date,total_purchases,total_calls,total_call_duration_minutes,incoming_calls,outgoing_calls,missed_calls,avg_call_duration_minutes,first_call_date,last_call_date,call_loyalty_level,total_returns\n              ").order("created_at",{ascending:!1}).limit(1e5);a&&!s&&(e=e.or(`branch_id.eq.${a},is_shared.eq.true`));const t=await e;if(t.error)throw t.error;return t}),wi);if(r)throw r;if(e&&Array.isArray(e)){e.length;const a=(e,t=0)=>{if(null==e)return t;const a="string"==typeof e?parseFloat(e):Number(e);return isNaN(a)||a>1e12||a<0?t:a};let r={};try{const t=[...new Set(e.map(e=>e.branch_id).filter(Boolean))];if(t.length>0){const e=Si().from("store_locations").select("id, name").in("id",t),a=await e;a.data&&(r=a.data.reduce((e,t)=>(e[t.id]=t.name,e),{}))}}catch(t){}return e.map(e=>({id:e.id,name:e.name||"Unknown Customer",phone:e.phone||`NO_PHONE_${e.id}`,email:e.email||"",gender:e.gender||"other",city:e.city||"",colorTag:Ii(e.color_tag||"new"),loyaltyLevel:e.loyalty_level||"interested",points:a(e.points,0),totalSpent:a(e.total_spent,0),lastVisit:e.last_visit||e.created_at,isActive:!1!==e.is_active,referralSource:e.referral_source,birthMonth:e.birth_month,birthDay:e.birth_day,totalReturns:0,profileImage:null,branchName:r[e.branch_id]||e.created_by_branch_name||"Unknown Branch",whatsapp:e.phone,whatsappOptOut:!1,initialNotes:e.initial_notes,notes:e.notes?"string"==typeof e.notes?(()=>{try{return JSON.parse(e.notes)}catch{return[]}})():e.notes:[],referrals:[],customerTag:e.customer_tag,joinedDate:e.joined_date||e.created_at,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:e.location_description,nationalId:e.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[],branchId:e.branch_id,createdByBranchId:e.created_by_branch_id,createdByBranchName:e.created_by_branch_name}))}return[]}{if(0===i)return[];const{data:e,error:t}=await ki(xi(async()=>{let e=Si().from("customers").select("id,name,phone,email,gender,city,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared").order("created_at",{ascending:!1}).limit(1e5);a&&!s&&(e=e.or(`branch_id.eq.${a},is_shared.eq.true`));const t=await e;if(t.error)throw t.error;return t}),wi);if(t)throw t;if(e&&Array.isArray(e)){e.length;return e.map(e=>({id:e.id,name:e.name||"Unknown Customer",phone:e.phone||`NO_PHONE_${e.id}`,email:e.email||"",gender:e.gender||"other",city:e.city||"",colorTag:Ii(e.color_tag||"new"),loyaltyLevel:e.loyalty_level||"bronze",points:e.points||0,totalSpent:e.total_spent||0,lastVisit:e.last_visit||e.created_at,isActive:!1!==e.is_active,referralSource:e.referral_source,birthMonth:e.birth_month,birthDay:e.birth_day,totalReturns:0,profileImage:null,whatsapp:e.phone,whatsappOptOut:!1,initialNotes:e.initial_notes,notes:e.notes?"string"==typeof e.notes?(()=>{try{return JSON.parse(e.notes)}catch{return[]}})():e.notes:[],referrals:[],customerTag:e.customer_tag,joinedDate:e.joined_date||e.created_at,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:e.location_description,nationalId:e.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]}))}return[]}}catch(iu){throw iu}}();bi.set(e,t);try{return await t}finally{setTimeout(()=>{bi.delete(e)},1e3)}}async function Ti(e){try{const{data:t,error:a}=await Si().from("customers").select("\n        id,\n        name,\n        phone,\n        email,\n        whatsapp,\n        gender,\n        city,\n        country,\n        address,\n        color_tag,\n        loyalty_level,\n        points,\n        total_spent,\n        last_visit,\n        is_active,\n        referral_source,\n        birth_month,\n        birth_day,\n        birthday,\n        initial_notes,\n        notes,\n        customer_tag,\n        location_description,\n        national_id,\n        joined_date,\n        created_at,\n        updated_at,\n        branch_id,\n        is_shared,\n        created_by_branch_id,\n        created_by_branch_name,\n        profile_image,\n        whatsapp_opt_out,\n        referred_by,\n        created_by,\n        last_purchase_date,\n        total_purchases,\n        total_calls,\n        total_call_duration_minutes,\n        incoming_calls,\n        outgoing_calls,\n        missed_calls,\n        avg_call_duration_minutes,\n        first_call_date,\n        last_call_date,\n        call_loyalty_level,\n        total_returns\n      ").eq("id",e).single();if(a)throw a;if(t&&!a&&"object"==typeof t&&"id"in t){return{id:t.id,name:t.name,phone:t.phone,email:t.email,gender:t.gender||"other",city:t.city||"",colorTag:Ii(t.color_tag||"new"),loyaltyLevel:t.loyalty_level||"bronze",points:t.points||0,totalSpent:t.total_spent||0,lastVisit:t.last_visit||t.created_at,isActive:!1!==t.is_active,referralSource:t.referral_source,birthMonth:t.birth_month,birthDay:t.birth_day,totalReturns:0,profileImage:null,whatsapp:t.phone,whatsappOptOut:!1,initialNotes:t.initial_notes,notes:t.notes?"string"==typeof t.notes?(()=>{try{return JSON.parse(t.notes)}catch{return[]}})():t.notes:[],referrals:[],customerTag:t.customer_tag,joinedDate:t.joined_date||t.created_at,createdAt:t.created_at,updatedAt:t.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:t.location_description,nationalId:t.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]}}return null}catch(iu){throw iu}}async function ji(e){try{const a={colorTag:"color_tag",isActive:"is_active",isShared:"is_shared",lastVisit:"last_visit",joinedDate:"joined_date",loyaltyLevel:"loyalty_level",totalSpent:"total_spent",referralSource:"referral_source",birthMonth:"birth_month",birthDay:"birth_day",totalReturns:"total_returns",initialNotes:"initial_notes",locationDescription:"location_description",nationalId:"national_id",customerTag:"customer_tag",createdAt:"created_at",updatedAt:"updated_at",createdBy:"created_by",whatsapp:"whatsapp",branchId:"branch_id",createdByBranchId:"created_by_branch_id",createdByBranchName:"created_by_branch_name"},r=["devices","promoHistory","payments","notes","referrals"],s={};Object.entries(e).forEach(([e,t])=>{if(!r.includes(e)&&null!=t){const r=a[e]||e;s[r]=t}});const n="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;if(n){s.branch_id=n,s.created_by_branch_id=n;try{const{data:e}=await Si().from("store_locations").select("name").eq("id",n).single();(null==e?void 0:e.name)&&(s.created_by_branch_name=e.name)}catch(t){}s.is_shared=!1}if(s.color_tag){s.color_tag;s.color_tag=Ii(s.color_tag)}if(!s.phone||""===s.phone.trim()){const e=`NO_PHONE_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;s.phone=e}const{data:i,error:o}=await Si().from("customers").insert([s]).select().single();if(o)throw o;return null==i||i.branch_id,i}catch(iu){throw iu}}async function Di(e,t){try{const r={colorTag:"color_tag",isActive:"is_active",isShared:"is_shared",lastVisit:"last_visit",joinedDate:"joined_date",loyaltyLevel:"loyalty_level",totalSpent:"total_spent",referralSource:"referral_source",birthMonth:"birth_month",birthDay:"birth_day",totalReturns:"total_returns",initialNotes:"initial_notes",locationDescription:"location_description",nationalId:"national_id",customerTag:"customer_tag",createdAt:"created_at",updatedAt:"updated_at",createdBy:"created_by",whatsapp:"whatsapp",branchId:"branch_id",createdByBranchId:"created_by_branch_id",createdByBranchName:"created_by_branch_name"},s={};Object.entries(t).forEach(([e,t])=>{if(null!=t){const a=r[e]||e;s[a]=t}}),s.updated_at=(new Date).toISOString(),s.color_tag&&(s.color_tag=Ii(s.color_tag)),void 0!==s.phone&&(s.phone&&""!==s.phone.trim()||(s.phone=`NO_PHONE_${Date.now()}_${Math.random().toString(36).substr(2,9)}`));const n=["id","name","email","phone","gender","city","address","joined_date","loyalty_level","color_tag","total_spent","points","last_visit","is_active","referral_source","birth_month","birth_day","total_returns","initial_notes","notes","customer_tag","location_description","national_id","created_at","updated_at","branch_id","is_shared","created_by_branch_id","created_by_branch_name","whatsapp"],i={},o=[];Object.entries(s).forEach(([e,t])=>{n.includes(e)?"notes"===e&&Array.isArray(t)?i[e]=JSON.stringify(t):i[e]="points"===e&&"string"==typeof t?parseInt(t,10)||0:"total_spent"===e&&"string"==typeof t?parseFloat(t)||0:"total_returns"===e&&"string"==typeof t?parseInt(t,10)||0:"is_active"===e&&"string"==typeof t?"true"===t||"1"===t:t:o.push(e)}),o.length;const{data:c,error:l}=await Si().from("lats_customers").update(i).eq("id",e).select().single();if(l)throw l;try{await ui(e,"profile_updated")}catch(a){}return c}catch(iu){throw iu}}const Ri=ji;class Li{constructor(){this.status={isAvailable:!0,requestCount:0,maxRequestsPerMinute:1}}static getInstance(){return Li.instance||(Li.instance=new Li),Li.instance}updateStatus(e){this.status={...this.status,...e}}getStatus(){return{...this.status}}isServiceAvailable(){if(!this.status.isAvailable){if(this.status.retryAfter&&Date.now()<this.status.retryAfter)return!1;this.status.isAvailable=!0,this.status.lastError=void 0,this.status.retryAfter=void 0}return this.status.isAvailable}getStatusMessage(){if(!this.status.isAvailable){if(this.status.retryAfter){return`AI service temporarily unavailable. Retry in ${Math.ceil((this.status.retryAfter-Date.now())/1e3)} seconds.`}return"AI service temporarily unavailable. Please try again later."}return this.status.requestCount>=this.status.maxRequestsPerMinute?"AI service rate limit reached. Please wait before making another request.":"AI service is available."}getStatusColor(){return this.status.isAvailable?this.status.requestCount>=this.status.maxRequestsPerMinute?"yellow":"green":"red"}incrementRequestCount(){this.status.requestCount++,setTimeout(()=>{this.status.requestCount=Math.max(0,this.status.requestCount-1)},6e4)}markServiceUnavailable(e,t=3e5){this.status.isAvailable=!1,this.status.lastError=e,this.status.lastErrorTime=Date.now(),this.status.retryAfter=Date.now()+t}}const Oi=Li.getInstance(),qi={websocket:{maxRetries:5,baseDelay:1e3,reconnectInterval:5e3},images:{maxFileSize:5242880,maxWidth:800,maxHeight:800,quality:.8,allowedTypes:["image/jpeg","image/png","image/webp"],loading:{timeout:1e4,retryAttempts:2,useFallbacks:!0,blockUnreliableUrls:!0}},api:{baseUrl:{}.VITE_API_URL||window.location.origin,timeout:3e4,maxRetries:3},realtime:{enabled:!0,stockUpdateInterval:5e3,productUpdateInterval:1e4,connection:{maxRetries:1,retryDelay:5e3,maxRetryDelay:15e3,connectionTimeout:1e4,cooldownPeriod:3e4,circuitBreakerTimeout:12e4}},audio:{enabled:!0,volume:.5,sounds:{notification:"/sounds/notification.mp3",error:"/sounds/error.mp3",success:"/sounds/success.mp3"}},errors:{showNotifications:!0,logToConsole:!0,retryOnFailure:!0},development:{debugMode:!1,mockData:"true"==={}.VITE_USE_MOCK_DATA,logLevel:"info"},http:{maxHeaderSize:8192,requestTimeout:3e4,retryAttempts:3},ai:{enabled:!0,gemini:{enabled:!0,maxRequestsPerMinute:2,minRequestInterval:3e4,errorCooldown:12e4},fallback:{enabled:!0}}};qi.realtime.connection;const Ni=new class{constructor(){this.apiKey=null,this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models",this.config={model:"gemini-1.5-flash",temperature:.7,maxTokens:1e3},this.requestCount=0,this.lastRequestTime=0,this.maxRequestsPerMinute=1,this.minRequestInterval=6e4,this.serviceAvailable=!0,this.lastErrorTime=0,this.errorCooldown=3e5,this.consecutiveErrors=0,this.maxConsecutiveErrors=2,this.requestQueue=[],this.isProcessingQueue=!1,this.apiKey={}.VITE_GEMINI_API_KEY||null,Oi.updateStatus({isAvailable:!0,requestCount:0,maxRequestsPerMinute:this.maxRequestsPerMinute}),this.loadApiKeyFromDatabase()}async loadApiKeyFromDatabase(){var e;try{const{getIntegration:t}=await s(()=>Promise.resolve().then(()=>Gi),void 0),a=await t("GEMINI_AI");a&&a.is_enabled&&(null==(e=a.credentials)?void 0:e.api_key)?this.apiKey=a.credentials.api_key:this.apiKey}catch(iu){}}setApiKey(e){this.apiKey=e}isServiceEnabled(){return qi.ai.enabled&&qi.ai.gemini.enabled}canMakeRequest(){const e=Date.now();return!(!this.serviceAvailable&&e-this.lastErrorTime<this.errorCooldown)&&(!(this.requestCount>=this.maxRequestsPerMinute)&&!(e-this.lastRequestTime<this.minRequestInterval))}updateRequestTracking(){this.requestCount++,this.lastRequestTime=Date.now(),Oi.incrementRequestCount(),setTimeout(()=>{this.requestCount=Math.max(0,this.requestCount-1)},6e4)}markServiceUnavailable(){this.serviceAvailable=!1,this.lastErrorTime=Date.now(),this.consecutiveErrors++;const e=Math.min(this.errorCooldown*Math.pow(2,this.consecutiveErrors-1),9e5);Oi.markServiceUnavailable("Rate limit exceeded",e),setTimeout(()=>{this.serviceAvailable=!0,Oi.updateStatus({isAvailable:!0})},e)}resetErrorCount(){this.consecutiveErrors=0}async processQueue(){if(!this.isProcessingQueue&&0!==this.requestQueue.length){for(this.isProcessingQueue=!0;this.requestQueue.length>0;){const e=this.requestQueue.shift();if(e)try{await e(),await new Promise(e=>setTimeout(e,this.minRequestInterval))}catch(iu){}}this.isProcessingQueue=!1}}async queueRequest(e){return new Promise((t,a)=>{this.requestQueue.push(async()=>{try{const a=await e();t(a)}catch(iu){a(iu)}}),this.processQueue()})}async testConnection(){return this.isServiceEnabled()?this.apiKey?this.queueRequest(async()=>{try{const e=await fetch(`${this.baseUrl}/${this.config.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:"Hello, this is a test message."}]}],generationConfig:{temperature:.1,maxOutputTokens:10}})});return e.ok?(this.serviceAvailable=!0,this.resetErrorCount(),{success:!0,data:"Connection successful"}):(this.markServiceUnavailable(),{success:!1,error:`Connection failed: ${e.status}`})}catch(iu){return this.markServiceUnavailable(),{success:!1,error:`Connection error: ${iu}`}}}):{success:!1,error:"API key not configured"}:{success:!1,error:"AI service disabled in configuration"}}async chat(e){return this.isServiceEnabled()?this.apiKey?this.canMakeRequest()?this.queueRequest(async()=>{var t,a,r,s,n,i;try{this.updateRequestTracking();const o=e.map(e=>({parts:[{text:e.content}],role:"user"===e.role?"user":"model"})),c=await fetch(`${this.baseUrl}/${this.config.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:o,generationConfig:{temperature:this.config.temperature,maxOutputTokens:this.config.maxTokens}})}),l=await c.json();return 429===c.status?(this.markServiceUnavailable(),{success:!1,error:"API rate limit exceeded. Please try again later."}):c.ok&&(null==(n=null==(s=null==(r=null==(a=null==(t=l.candidates)?void 0:t[0])?void 0:a.content)?void 0:r.parts)?void 0:s[0])?void 0:n.text)?(this.serviceAvailable=!0,this.resetErrorCount(),{success:!0,data:l.candidates[0].content.parts[0].text}):(this.markServiceUnavailable(),{success:!1,error:(null==(i=l.error)?void 0:i.message)||"AI request failed"})}catch(iu){return this.markServiceUnavailable(),{success:!1,error:`Network error: ${iu}`}}}):{success:!1,error:"Service temporarily unavailable due to rate limiting or errors"}:{success:!1,error:"API key not configured"}:{success:!1,error:"AI service disabled in configuration"}}async generateCustomerResponse(e,t){const a=await this.chat([{role:"user",content:`You are a helpful customer service representative. Please respond to this customer query in a friendly and professional manner: "${e}"${t?`\n\nContext: ${t}`:""}`}]);return a.success?a:{success:!0,data:this.getFallbackCustomerResponse(e)}}async generateInventoryResponse(e,t){const a=await this.chat([{role:"user",content:`You are an inventory management assistant. Please help with this inventory query: "${e}"${t?`\n\nProduct Data: ${JSON.stringify(t)}`:""}`}]);return a.success?a:{success:!0,data:this.getFallbackInventoryResponse(e)}}async analyzeExpense(e,t){const a=await this.chat([{role:"user",content:`Please analyze this business expense and provide insights: Description: "${e}", Amount: $${t}`}]);return a.success?a:{success:!0,data:this.getFallbackExpenseAnalysis(e,t)}}getFallbackCustomerResponse(e){const t=e.toLowerCase();return t.includes("hello")||t.includes("hi")?"Hello! Thank you for contacting us. How can I assist you today?":t.includes("help")||t.includes("support")?"I'm here to help! Please let me know what specific assistance you need, and I'll do my best to support you.":t.includes("price")||t.includes("cost")?"For pricing information, please contact our sales team or check our website. I can also help you find specific product details.":t.includes("order")||t.includes("purchase")?"I'd be happy to help you with your order! Please provide more details about what you're looking to purchase.":"Thank you for your message. I'm here to help with any questions or concerns you may have. Please let me know how I can assist you further."}getFallbackInventoryResponse(e){const t=e.toLowerCase();return t.includes("stock")||t.includes("available")?"I can help you check stock availability. Please specify which product you're looking for, and I'll check our inventory.":t.includes("product")||t.includes("item")?"I can help you find product information. Please provide the product name or category you're interested in.":t.includes("order")||t.includes("purchase")?"I can help you with inventory-related orders. Please let me know what products you need and the quantity.":"I'm here to help with inventory management. Please let me know what specific information you need about our products or stock levels."}getFallbackExpenseAnalysis(e,t){return`Expense Analysis:\n    \nDescription: ${e}\nAmount: $${t}\n\nKey Insights:\n This appears to be a business expense\n Amount: $${t}\n Category: ${this.categorizeExpense(e)}\n\nRecommendations:\n Keep detailed records for tax purposes\n Consider if this expense is necessary for business operations\n Review if there are more cost-effective alternatives\n\nPlease consult with your accountant for specific tax advice.`}categorizeExpense(e){const t=e.toLowerCase();return t.includes("office")||t.includes("supplies")?"Office Supplies":t.includes("travel")||t.includes("transport")?"Travel":t.includes("meal")||t.includes("food")?"Meals & Entertainment":t.includes("equipment")||t.includes("hardware")?"Equipment":t.includes("software")||t.includes("subscription")?"Software/Subscriptions":t.includes("marketing")||t.includes("advertising")?"Marketing":"General Business Expense"}getRateLimitStatus(){const e=Date.now()-this.lastRequestTime;return{requestsRemaining:Math.max(0,this.maxRequestsPerMinute-this.requestCount),timeSinceLastRequest:e,canMakeRequest:this.isServiceEnabled()&&this.canMakeRequest(),serviceStatus:this.isServiceEnabled()?this.serviceAvailable?"available":"unavailable":"disabled",maxRequestsPerMinute:this.maxRequestsPerMinute,minRequestInterval:this.minRequestInterval,errorCooldown:this.errorCooldown,isEnabled:this.isServiceEnabled()}}isServiceAvailable(){return this.isServiceEnabled()&&this.serviceAvailable&&this.canMakeRequest()}};async function Mi(){const{data:e,error:t}=await $a.from("lats_pos_integrations_settings").select("*").order("integration_type",{ascending:!0}).order("integration_name",{ascending:!0});if(t)throw t;return e||[]}async function Ui(e){const{data:t,error:a}=await $a.from("lats_pos_integrations_settings").select("*").eq("integration_name",e).single();if(a){if("PGRST116"===a.code)return null;throw a}return t}async function Bi(e){const t=await Ui(e);return t&&t.is_enabled?t.credentials:null}async function $i(e){var t;const{data:a}=await $a.auth.getUser(),{data:r,error:s}=await $a.from("lats_pos_integrations_settings").insert({...e,user_id:null==(t=null==a?void 0:a.user)?void 0:t.id}).select().single();if(s)throw s;return r}async function Fi(e,t){const{data:a,error:r}=await $a.from("lats_pos_integrations_settings").update({...t,updated_at:(new Date).toISOString()}).eq("integration_name",e).select().single();if(r)throw r;return a}async function zi(e){var t;const{data:a}=await $a.auth.getUser(),r=e.user_id||(null==(t=null==a?void 0:a.user)?void 0:t.id);return await Ui(e.integration_name)?await Fi(e.integration_name,{...e,user_id:r}):await $i({...e,user_id:r})}async function Vi(e){const{error:t}=await $a.from("lats_pos_integrations_settings").delete().eq("integration_name",e);if(t)throw t}async function Wi(e,t){const{error:a}=await $a.from("lats_pos_integrations_settings").update({is_enabled:t,is_active:t,updated_at:(new Date).toISOString()}).eq("integration_name",e);if(a)throw a}async function Hi(e,t){const a=await Ui(e);if(!a)return;const{error:r}=await $a.from("lats_pos_integrations_settings").update({last_used_at:(new Date).toISOString(),total_requests:(a.total_requests||0)+1,successful_requests:t?(a.successful_requests||0)+1:a.successful_requests,failed_requests:t?a.failed_requests:(a.failed_requests||0)+1,updated_at:(new Date).toISOString()}).eq("integration_name",e);if(r)throw r}function Qi(){return[{integration_name:"SMS_GATEWAY",integration_type:"sms",provider_name:"MShastra",icon:"Smartphone",description:"Send SMS notifications and receipts via MShastra (Tanzania)",credentials_fields:[{name:"api_key",label:"API Username",type:"text",required:!0,placeholder:"Your MShastra username"},{name:"api_password",label:"API Password",type:"password",required:!0,placeholder:"Your MShastra password"},{name:"sender_id",label:"Sender ID",type:"text",required:!0,placeholder:"LATS POS"}],config_fields:[{name:"api_url",label:"API URL",type:"url",required:!0,placeholder:"https://api.mshastra.com/sms"},{name:"priority",label:"Priority",type:"select",required:!1,options:[{value:"High",label:"High"},{value:"Medium",label:"Medium"},{value:"Low",label:"Low"}]},{name:"country_code",label:"Country Code",type:"text",required:!1,placeholder:"ALL"},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"3"},{name:"timeout",label:"Timeout (ms)",type:"number",required:!1,placeholder:"30000"}]},{integration_name:"WHATSAPP_GATEWAY",integration_type:"whatsapp",provider_name:"Green API",icon:"MessageCircle",description:"Send WhatsApp messages, receipts, and media via Green API",credentials_fields:[{name:"instance_id",label:"Instance ID",type:"text",required:!0,placeholder:"7105284900"},{name:"api_token",label:"API Token",type:"password",required:!0,placeholder:"Your Green API token"},{name:"phone_number",label:"WhatsApp Phone Number",type:"text",required:!1,placeholder:"+255712345678 (optional)"}],config_fields:[{name:"api_url",label:"API URL / Host",type:"url",required:!0,placeholder:"https://7105.api.greenapi.com"},{name:"webhook_url",label:"Webhook URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/whatsapp/webhook"},{name:"webhook_token",label:"Webhook Token",type:"password",required:!1,placeholder:"Webhook verification token"},{name:"link_preview",label:"Enable Link Preview",type:"checkbox",required:!1},{name:"mark_messages_read",label:"Auto-mark Messages as Read",type:"checkbox",required:!1},{name:"delay_send_ms",label:"Delay Between Messages (ms)",type:"number",required:!1,placeholder:"1000"}]},{integration_name:"EMAIL_SERVICE",integration_type:"email",provider_name:"SendGrid",icon:"Mail",description:"Send email receipts and notifications via SendGrid",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"SG.xxxxxx"},{name:"sender_email",label:"Sender Email",type:"text",required:!0,placeholder:"noreply@yourbusiness.com"},{name:"sender_name",label:"Sender Name",type:"text",required:!0,placeholder:"LATS CHANCE"}],config_fields:[{name:"template_id",label:"Default Template ID",type:"text",required:!1,placeholder:"d-xxxxxxxxxxxxxxxx"},{name:"enable_tracking",label:"Enable Open Tracking",type:"checkbox",required:!1},{name:"enable_click_tracking",label:"Enable Click Tracking",type:"checkbox",required:!1},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"2"},{name:"sandbox_mode",label:"Sandbox Mode",type:"checkbox",required:!1}]},{integration_name:"MPESA_PAYMENT",integration_type:"payment",provider_name:"M-Pesa",icon:"CreditCard",description:"Accept M-Pesa mobile money payments (Safaricom/Vodacom)",credentials_fields:[{name:"consumer_key",label:"Consumer Key",type:"password",required:!0,placeholder:"Your M-Pesa consumer key"},{name:"consumer_secret",label:"Consumer Secret",type:"password",required:!0,placeholder:"Your M-Pesa consumer secret"},{name:"business_short_code",label:"Business Shortcode",type:"text",required:!0,placeholder:"174379"},{name:"passkey",label:"Lipa Na M-Pesa Passkey",type:"password",required:!0,placeholder:"Your passkey"},{name:"initiator_name",label:"Initiator Name",type:"text",required:!1,placeholder:"testapi"},{name:"security_credential",label:"Security Credential",type:"password",required:!1,placeholder:"Encrypted password"}],config_fields:[{name:"transaction_type",label:"Transaction Type",type:"select",required:!0,options:[{value:"CustomerPayBillOnline",label:"Pay Bill"},{value:"CustomerBuyGoodsOnline",label:"Buy Goods"}]},{name:"callback_url",label:"Callback URL",type:"url",required:!0,placeholder:"https://yourapp.com/api/mpesa/callback"},{name:"timeout_url",label:"Timeout URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/mpesa/timeout"},{name:"result_url",label:"Result URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/mpesa/result"},{name:"enable_validation",label:"Enable Validation",type:"checkbox",required:!1}]},{integration_name:"STRIPE_PAYMENT",integration_type:"payment",provider_name:"Stripe",icon:"CreditCard",description:"Accept international card payments via Stripe",credentials_fields:[{name:"publishable_key",label:"Publishable Key",type:"text",required:!0,placeholder:"pk_test_xxxxx or pk_live_xxxxx"},{name:"secret_key",label:"Secret Key",type:"password",required:!0,placeholder:"sk_test_xxxxx or sk_live_xxxxx"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"whsec_xxxxx"}],config_fields:[{name:"currency",label:"Default Currency",type:"text",required:!0,placeholder:"usd"},{name:"capture_method",label:"Capture Method",type:"select",required:!1,options:[{value:"automatic",label:"Automatic"},{value:"manual",label:"Manual"}]},{name:"enable_saved_cards",label:"Enable Saved Cards",type:"checkbox",required:!1},{name:"statement_descriptor",label:"Statement Descriptor",type:"text",required:!1,placeholder:"LATS POS"}]},{integration_name:"GOOGLE_ANALYTICS",integration_type:"analytics",provider_name:"Google Analytics",icon:"BarChart",description:"Track user behavior, sales analytics, and ecommerce data",credentials_fields:[{name:"tracking_id",label:"Tracking ID (UA)",type:"text",required:!1,placeholder:"UA-XXXXXXXXX-X"},{name:"measurement_id",label:"Measurement ID (GA4)",type:"text",required:!0,placeholder:"G-XXXXXXXXXX"},{name:"api_secret",label:"API Secret (for server events)",type:"password",required:!1,placeholder:"Your API secret"}],config_fields:[{name:"enable_ecommerce",label:"Enable Ecommerce Tracking",type:"checkbox",required:!1},{name:"enable_enhanced_ecommerce",label:"Enable Enhanced Ecommerce",type:"checkbox",required:!1},{name:"anonymize_ip",label:"Anonymize IP Addresses",type:"checkbox",required:!1},{name:"debug_mode",label:"Debug Mode",type:"checkbox",required:!1}]},{integration_name:"GEMINI_AI",integration_type:"ai",provider_name:"Google Gemini",icon:"Zap",description:"AI-powered features, automation, and content generation",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"AIzaSy..."}],config_fields:[{name:"model",label:"Model",type:"select",required:!1,options:[{value:"gemini-1.5-flash",label:"Gemini 1.5 Flash (Fast)"},{value:"gemini-1.5-pro",label:"Gemini 1.5 Pro (Better Quality)"},{value:"gemini-pro",label:"Gemini Pro (Legacy)"}]},{name:"temperature",label:"Temperature (0-1)",type:"number",required:!1,placeholder:"0.7"},{name:"max_tokens",label:"Max Output Tokens",type:"number",required:!1,placeholder:"1000"},{name:"base_url",label:"API Base URL",type:"url",required:!1,placeholder:"https://generativelanguage.googleapis.com/v1beta/models"}]},{integration_name:"CUSTOM_API",integration_type:"custom",provider_name:"Custom API",icon:"Globe",description:"Integrate any custom API service or third-party platform",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your API key or token"},{name:"api_secret",label:"API Secret",type:"password",required:!1,placeholder:"API secret (if required)"},{name:"api_url",label:"API Base URL",type:"url",required:!0,placeholder:"https://api.example.com"},{name:"username",label:"Username",type:"text",required:!1,placeholder:"Username (if required)"}],config_fields:[{name:"auth_type",label:"Authentication Type",type:"select",required:!1,options:[{value:"bearer",label:"Bearer Token"},{value:"basic",label:"Basic Auth"},{value:"api_key",label:"API Key"},{value:"custom",label:"Custom"}]},{name:"timeout",label:"Timeout (ms)",type:"number",required:!1,placeholder:"30000"},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"3"},{name:"rate_limit",label:"Rate Limit (req/min)",type:"number",required:!1,placeholder:"60"}]},{integration_name:"BEEM_PAYMENT",integration_type:"payment",provider_name:"Beem Africa",icon:"CreditCard",description:"Accept payments via Beem Africa (Tanzania, Kenya, Uganda)",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your Beem API Key"},{name:"secret_key",label:"Secret Key",type:"password",required:!0,placeholder:"Your Beem Secret Key"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"Webhook verification secret"}],config_fields:[{name:"api_url",label:"API URL",type:"url",required:!0,placeholder:"https://beem.africa/api"},{name:"currency",label:"Default Currency",type:"select",required:!0,options:[{value:"TZS",label:"TZS - Tanzanian Shilling"},{value:"KES",label:"KES - Kenyan Shilling"},{value:"UGX",label:"UGX - Ugandan Shilling"},{value:"USD",label:"USD - US Dollar"}]},{name:"callback_url",label:"Callback URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/beem/callback"},{name:"auto_return",label:"Auto Return After Payment",type:"checkbox",required:!1},{name:"checkout_timeout",label:"Checkout Timeout (minutes)",type:"number",required:!1,placeholder:"30"}]},{integration_name:"ZENOPAY_PAYMENT",integration_type:"payment",provider_name:"ZenoPay",icon:"CreditCard",description:"Accept mobile money payments via ZenoPay with USSD popup",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your ZenoPay API Key"},{name:"merchant_id",label:"Merchant ID",type:"text",required:!0,placeholder:"Your ZenoPay Merchant ID"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"Webhook verification secret"}],config_fields:[{name:"api_url",label:"API Base URL",type:"url",required:!0,placeholder:"http://localhost:8000 (or production URL)"},{name:"callback_url",label:"Callback URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/zenopay/callback"},{name:"enable_ussd_popup",label:"Enable USSD Popup",type:"checkbox",required:!1},{name:"ussd_timeout",label:"USSD Popup Timeout (seconds)",type:"number",required:!1,placeholder:"300"},{name:"retry_attempts",label:"Retry Attempts",type:"number",required:!1,placeholder:"3"}]},{integration_name:"GOOGLE_MAPS",integration_type:"maps",provider_name:"Google Maps",icon:"MapPin",description:"Location services, maps, and geofencing for attendance tracking",credentials_fields:[{name:"api_key",label:"Google Maps API Key",type:"password",required:!0,placeholder:"AIzaSy..."}],config_fields:[{name:"default_lat",label:"Default Latitude",type:"text",required:!1,placeholder:"-6.7924"},{name:"default_lng",label:"Default Longitude",type:"text",required:!1,placeholder:"39.2083"},{name:"default_zoom",label:"Default Zoom Level",type:"number",required:!1,placeholder:"13"},{name:"enable_geofencing",label:"Enable Geofencing",type:"checkbox",required:!1},{name:"geofence_radius",label:"Geofence Radius (meters)",type:"number",required:!1,placeholder:"100"}]},{integration_name:"HOSTINGER_STORAGE",integration_type:"storage",provider_name:"Hostinger",icon:"HardDrive",description:"Cloud file storage for logos, images, and documents via Hostinger",credentials_fields:[{name:"api_token",label:"Hostinger API Token",type:"password",required:!0,placeholder:"Your Hostinger API token"},{name:"domain",label:"Domain",type:"text",required:!0,placeholder:"yourdomain.com"}],config_fields:[{name:"api_endpoint",label:"API Endpoint",type:"url",required:!1,placeholder:"https://api.hostinger.com/v1"},{name:"default_path",label:"Default Upload Path",type:"text",required:!1,placeholder:"/uploads"},{name:"max_file_size",label:"Max File Size (MB)",type:"number",required:!1,placeholder:"10"},{name:"allowed_types",label:"Allowed File Types",type:"text",required:!1,placeholder:"jpg,png,pdf,doc"},{name:"auto_optimize",label:"Auto-Optimize Images",type:"checkbox",required:!1}]}]}const Gi=Object.freeze(Object.defineProperty({__proto__:null,createIntegration:$i,deleteIntegration:Vi,getAllIntegrations:Mi,getCredentials:Bi,getEnabledIntegrations:async function(){const{data:e,error:t}=await $a.from("lats_pos_integrations_settings").select("*").eq("is_enabled",!0).eq("is_active",!0).order("integration_type",{ascending:!0});if(t)throw t;return e||[]},getIntegration:Ui,getIntegrationTemplates:Qi,getIntegrationsByType:async function(e){const{data:t,error:a}=await $a.from("lats_pos_integrations_settings").select("*").eq("integration_type",e).order("integration_name",{ascending:!0});if(a)throw a;return t||[]},toggleIntegration:Wi,updateIntegration:Fi,updateIntegrationUsage:Hi,upsertIntegration:zi},Symbol.toStringTag,{value:"Module"}));const Ki=new class{constructor(){this.apiKey=null,this.apiUrl=null,this.apiPassword=null,this.initialized=!1,this.initializationPromise=null,this.initializationPromise=this.initializeService()}async initializeService(){var e,t,a,r;try{const{getIntegration:n}=await s(()=>Promise.resolve().then(()=>Gi),void 0),i=await n("SMS_GATEWAY");if(!i||!i.is_enabled)return;this.apiKey=(null==(e=i.credentials)?void 0:e.api_key)||null,this.apiPassword=(null==(t=i.credentials)?void 0:t.api_password)||(null==(a=i.credentials)?void 0:a.api_secret)||null,this.apiUrl=(null==(r=i.config)?void 0:r.api_url)||"https://mshastra.com/sendurl.aspx",!this.apiKey||this.apiUrl,this.initialized=!0}catch(iu){this.initialized=!0}}async ensureInitialized(){!this.initialized&&this.initializationPromise&&await this.initializationPromise}async sendSMS(e,t,a){try{await this.ensureInitialized();let r=t,s=!1,n=null;if(null==a?void 0:a.ai_enhanced){const a=await this.enhanceMessageWithAI(t,e);a.success&&(r=a.enhanced_message,s=!0,n=a.personalization_data)}const i=await this.sendSMSToProvider(e,r);Hi("SMS_GATEWAY",i.success).catch(e=>{});const o={recipient_phone:e,message:r,status:i.success?"sent":"failed",sent_at:(new Date).toISOString(),created_at:(new Date).toISOString()};i.error&&(o.error_message=i.error);const{data:c,error:l}=await $a.from("sms_logs").insert(o).select().single();return{success:i.success,error:i.error,log_id:null==c?void 0:c.id}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}async sendBulkSMS(e){const t={success:!0,sent:0,failed:0,errors:[]};try{if(e.ai_enhanced){await this.analyzeBulkCampaign(e)}for(const a of e.recipients)try{let r=e.message;if(e.personalization_data&&e.personalization_data[a]){const t=e.personalization_data[a];r=this.personalizeMessage(e.message,t)}const s=await this.sendSMS(a,r,{ai_enhanced:e.ai_enhanced});s.success?t.sent++:(t.failed++,t.errors.push(`${a}: ${s.error}`)),await new Promise(e=>setTimeout(e,100))}catch(iu){t.failed++;const r=iu instanceof Error?iu.message:"Unknown error";t.errors.push(`${a}: ${r}`)}return t}catch(iu){const a=iu instanceof Error?iu.message:"Unknown error occurred";return{success:!1,sent:t.sent,failed:t.failed,errors:[...t.errors,a]}}}async enhanceMessageWithAI(e,t){try{let a=null;if(t){const{data:e}=await $a.from("customers").select("*").eq("phone",t).single();a=e}const r=`Enhance this SMS message for a device repair and sales business:\n\nOriginal Message: "${e}"\n${a?`Customer Data: ${JSON.stringify(a,null,2)}`:""}\n\nRequirements:\n- Keep the core message intact\n- Improve clarity and professionalism\n- Add personalization if customer data is available\n- Ensure it's under 160 characters\n- Make it more engaging and actionable\n- Use appropriate tone (friendly but professional)\n\nReturn only the enhanced message, no explanations.`,s=await Ni.chat([{role:"user",content:r}]);if(s.success&&s.data)return{success:!0,enhanced_message:s.data.trim(),personalization_data:a}}catch(iu){}return{success:!1,enhanced_message:e}}async analyzeBulkCampaign(e){try{const a=`Analyze this bulk SMS campaign for a device repair and sales business:\n\nMessage: "${e.message}"\nRecipients: ${e.recipients.length} customers\n${e.personalization_data?"Personalization: Enabled":"Personalization: Disabled"}\n\nPlease analyze and provide:\n1. Message quality score (0-1)\n2. Suggested improvements\n3. Personalization suggestions\n4. Optimal send time recommendations\n5. Customer segment insights\n\nRespond in JSON format:\n{\n  "message_quality": 0.8,\n  "suggested_improvements": ["Add call-to-action", "Include business name"],\n  "personalization_suggestions": ["Use customer name", "Reference loyalty level"],\n  "optimal_send_time": "10:00 AM - 2:00 PM",\n  "customer_segment_insights": "This message targets..."\n}`,r=await Ni.chat([{role:"user",content:a}]);if(r.success&&r.data)try{return JSON.parse(r.data)}catch(t){}}catch(iu){}return{message_quality:.5,suggested_improvements:[],personalization_suggestions:[]}}personalizeMessage(e,t){let a=e;return t.name&&(a=a.replace(/{name}/g,t.name)),t.loyaltyLevel&&(a=a.replace(/{loyaltyLevel}/g,t.loyaltyLevel)),t.totalSpent&&(a=a.replace(/{totalSpent}/g,t.totalSpent.toString())),t.points&&(a=a.replace(/{points}/g,t.points.toString())),a}async sendSMSToProvider(e,t){var a,r,n,i;if(await this.ensureInitialized(),!this.apiKey||!this.apiUrl)return{success:!1,error:"SMS provider not configured. Messages will be logged but not sent. Check console for setup instructions."};try{if("255700000000"===e||e.startsWith("255700"))return{success:!0};const o={}.VITE_API_URL?`${{}.VITE_API_URL}/api/sms-proxy`:"http://localhost:8000/api/sms-proxy",{getIntegration:c}=await s(()=>Promise.resolve().then(()=>Gi),void 0),l=await c("SMS_GATEWAY"),d=(null==(a=null==l?void 0:l.credentials)?void 0:a.sender_id)||"LATS POS",u=(null==(r=null==l?void 0:l.config)?void 0:r.api_url)||this.apiUrl||"https://mshastra.com/sendurl.aspx",m=(null==(n=null==l?void 0:l.credentials)?void 0:n.api_key)||this.apiKey,h=(null==(i=null==l?void 0:l.credentials)?void 0:i.api_password)||this.apiPassword,p=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e,message:t,apiUrl:u,apiKey:m,apiPassword:h,senderId:d})}),g=await p.json();return g.success?{success:!0}:{success:!1,error:g.error||"SMS sending failed"}}catch(iu){const t=iu instanceof Error?iu.message:"Unknown network error";return t.includes("Failed to fetch")||t.includes("ERR_CONNECTION_REFUSED")||t.includes("ECONNREFUSED")?{success:!1,error:"SMS proxy server not running - this is normal in development mode"}:{success:!1,error:`Network error: ${t}`}}}async getSMSLogs(e){try{let t=$a.from("sms_logs").select("*").order("created_at",{ascending:!1});(null==e?void 0:e.search)&&(t=t.or(`recipient_phone.ilike.%${e.search}%,message.ilike.%${e.search}%`));const{data:a,error:r}=await t;return r?[]:a||[]}catch(iu){return[]}}async getTemplates(){try{const{data:e}=await $a.from("communication_templates").select("*").eq("template_type","sms").eq("is_active",!0).order("created_at",{ascending:!1});return e||[]}catch(iu){return[]}}async getSMSStats(){try{const{data:e}=await $a.from("sms_logs").select("status, created_at");if(!e)return{total:0,sent:0,failed:0,pending:0,delivered:0,totalCost:0};return{total:e.length,sent:e.filter(e=>"sent"===e.status).length,failed:e.filter(e=>"failed"===e.status).length,pending:e.filter(e=>"pending"===e.status).length,delivered:e.filter(e=>"delivered"===e.status).length,totalCost:15*e.length}}catch(iu){return{total:0,sent:0,failed:0,pending:0,delivered:0,totalCost:0}}}async resendSMS(e){try{const{data:t}=await $a.from("sms_logs").select("*").eq("id",e).single();if(!t)return{success:!1,error:"SMS log not found"};const a=await this.sendSMS(t.recipient_phone,t.message);return await $a.from("sms_logs").update({status:a.success?"sent":"failed",error_message:a.error,sent_at:(new Date).toISOString()}).eq("id",e),a}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}async scheduleSMS(e){try{const{data:t}=await $a.from("scheduled_sms").insert({recipients:e.recipients,message:e.message,template_id:e.template_id,variables:e.variables,ai_enhanced:e.ai_enhanced,personalization_data:e.personalization_data,scheduled_for:e.scheduledFor.toISOString(),created_by:e.created_by,status:"pending"});return{success:!0}}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}async logManualSMS(e){try{const{data:t,error:a}=await $a.from("customers").select("phone").eq("id",e.customerId).single();if(a)return!1;const{error:r}=await $a.from("sms_logs").insert({recipient_phone:(null==t?void 0:t.phone)||"",message:e.message,status:"sent",sent_by:e.sentBy,device_id:e.deviceId,sent_at:(new Date).toISOString(),created_at:(new Date).toISOString()});return!r}catch(iu){return!1}}async sendDeviceReceivedSMS(e,t,a,r,s,n,i){try{const i=` Tumepokea Kimepokelewa!\n\nHellow Mtaasisi ${t},\n\nHabari njema! ${a} ${r} yako imepokelewa na sasa iko katika foleni ya ukarabati wa Inauzwa.\n\n Namba ya Kumbukumbu: #${s}\n Tarehe ya Kupokea: ${(new Date).toLocaleDateString("sw-TZ")}\n Tatizo: ${n}\n\nSubiri ujumbe kupitia SMS kikiwa tayari!\n\nAsante kwa kumtumaini Inauzwa `,c=await this.sendSMS(e,i,{ai_enhanced:!1});if(c.success&&c.log_id)try{await $a.from("sms_logs").update({device_id:s}).eq("id",c.log_id)}catch(o){}return c}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}async sendDeviceReadySMS(e,t,a,r,s,n){try{const n=` Kifaa Chako Tayari!\n\nHabari Mtaasisi ${t},\n\nHabari njema! ${a} ${r} yako imekamilika na tayari kuchukuliwa.\n\n Namba ya Kumbukumbu: #${s}\n Tarehe ya Kukamilisha: ${(new Date).toLocaleDateString("sw-TZ")}\n\nTafadhali uje kuchukua kifaa chako katika ofisi yetu ndani ya muda ili kuepuka usumbufu.\n\nAsante kwa kumtumaini Inauzwa! `,o=await this.sendSMS(e,n,{ai_enhanced:!1});if(o.success&&o.log_id)try{await $a.from("sms_logs").update({device_id:s}).eq("id",o.log_id)}catch(i){}return o}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}async sendTemplateSMS(e,t,a,r){try{const{data:r,error:s}=await $a.from("sms_templates").select("*").eq("id",t).single();if(s||!r)return{success:!1,error:"Template not found"};let n=r.content;Object.entries(a).forEach(([e,t])=>{const a=`{${e}}`;n=n.replace(new RegExp(a,"g"),t)});const i=await this.sendSMS(e,n,{ai_enhanced:!1});return i.success&&i.log_id,i}catch(iu){return{success:!1,error:iu instanceof Error?iu.message:"Unknown error occurred"}}}},Yi=Object.freeze(Object.defineProperty({__proto__:null,logManualSMS:async e=>Ki.logManualSMS(e),smsService:Ki},Symbol.toStringTag,{value:"Module"})),Ji={basePoints:100,brandBonuses:{apple:5,samsung:3,google:2,xiaomi:1,huawei:1},modelBonuses:{"iphone 15":3,"iphone 14":2,"galaxy s24":3,"galaxy s23":2,"pixel 8":2,"pixel 7":1},deviceTypeBonuses:{smartphone:0,tablet:2,laptop:5,desktop:3,smartwatch:1},enablePointsForNewDevices:!0,maxPointsPerDay:50,customerLoyaltyMultipliers:{interested:1,engaged:1.05,payment_customer:1.1,active:1.15,regular:1.2,premium:1.3,vip:1.5}};function Xi(e,t,a=Ji){if(!a.enablePointsForNewDevices)return 0;let r=a.basePoints;if(e.brand){const t=a.brandBonuses[e.brand.toLowerCase()];t&&(r+=t)}if(e.model){const t=e.model.toLowerCase();for(const[e,s]of Object.entries(a.modelBonuses))if(t.includes(e.toLowerCase())){r+=s;break}}if(e.deviceType){const t=a.deviceTypeBonuses[e.deviceType.toLowerCase()];t&&(r+=t)}if(t){const e=a.customerLoyaltyMultipliers[t.toLowerCase()]||1;r=Math.round(r*e)}return r}const Zi={sendEmail:async(e,t,a)=>({success:!0}),sendReminder:async e=>({success:!0}),sendNotification:async e=>({success:!0})},eo=async e=>{try{const{data:{user:t}}=await $a.auth.getUser(),a={action:e.action,details:e.details,user_id:e.user_id||(null==t?void 0:t.id),timestamp:e.timestamp||(new Date).toISOString(),entity_type:e.entity_type||"system",entity_id:e.entity_id,user_role:e.user_role||"user",ip_address:e.ip_address,user_agent:e.user_agent},{error:r}=await $a.from("audit_logs").insert(a);return!r}catch(iu){return!1}},to=async(e,t,a,r,s,n)=>eo({action:"device_status_change",details:`Device ${e} status changed from ${r} to ${s} by ${a} (${t}). Signature: ${n}`,entity_type:"device",entity_id:e,user_id:t,user_role:a}),ao=e.createContext(void 0),ro=()=>{const t=e.useContext(ao);if(!t)throw new Error("useDevices must be used within a DevicesProvider");return t};const so=r.memo(({children:t})=>{const[a,r]=e.useState([]),[n,i]=e.useState(!1),o=e.useContext(wn),c=(null==o?void 0:o.currentUser)||null,l=e.useRef(new Set);e.useEffect(()=>{if(c)for(const e of a)for(const t of e.remarks||[])l.current.has(t.id)||t.createdBy===c.id||(di.playRemarkSound().catch(()=>{}),l.current.add(t.id))},[a,c]),e.useEffect(()=>{if(!c)return;i(!0);(async()=>{try{let e;if("technician"===c.role){const{deviceServices:t}=await s(()=>import("./deviceServices-ec0bbef9.js"),["assets/deviceServices-ec0bbef9.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"]);e=await t.getDevicesByTechnician(c.id)}else e=await ri();r(e)}catch(iu){r([])}finally{i(!1)}})()},[c]);return $.jsx(ao.Provider,{value:{devices:a,loading:n,addDevice:async e=>{var t;if(!c)throw new Error("User not authenticated");if("technician"===c.role)throw new Error("Technicians are not allowed to create devices.");const a=crypto.randomUUID(),s=(new Date).toISOString(),n={...e,id:a,createdAt:s,updatedAt:s,status:"assigned",remarks:[],transitions:[{id:`t-${Date.now()}`,fromStatus:"assigned",toStatus:"assigned",performedBy:c.id,timestamp:s,signature:""}]},i=await si(n);if(!i)throw new Error("Failed to add device to database");try{const t=e.customerId,{data:a,error:r}=await $a.from("customers").select("points, loyalty_level").eq("id",t).single();if(!r&&a){const r=Xi(e,a.loyalty_level),s=(a.points||0)+r;try{await Di(t,{points:s})}catch(o){}try{const a={note:`+${r} points for new device: ${e.brand} ${e.model}`,created_by:c.id,customer_id:t};(await $a.from("customer_notes").insert(a)).error}catch(l){}m.success(`Added ${r} loyalty points to customer for new device intake!`)}}catch(iu){}r(e=>[...e.filter(e=>e.id!==i.id&&e.serialNumber!==i.serialNumber),i]);try{const{data:r,error:s}=await $a.from("customers").select("name, phone").eq("id",e.customerId).single();if(!s&&r&&r.phone){const s=await Ki.sendDeviceReceivedSMS(r.phone,r.name||"Mteja",e.brand,e.model,a,e.issueDescription||"Ukarabati wa kifaa",e.customerId);s.success?m.success("SMS notification sent to customer"):(null==(t=s.error)?void 0:t.includes("proxy server"))||m.error("SMS notification failed to send")}else null==r||r.phone}catch(d){}try{await di.playSuccessSound()}catch(iu){}return{...n,...i}},updateDeviceStatus:async(e,t,s)=>{if(!c)return!1;const n=a.find(t=>t.id===e);if(!n)return!1;const i={id:`t-${Date.now()}`,fromStatus:n.status,toStatus:t,performedBy:c.id,timestamp:(new Date).toISOString(),signature:s},o={...n,status:t,updatedAt:(new Date).toISOString(),transitions:[...n.transitions||[],i]};r(t=>t.map(t=>t.id===e?o:t));return(async()=>{try{await $a.from("device_transitions").insert({device_id:e,from_status:n.status,to_status:t,performed_by:c.id,created_at:i.timestamp,signature:s});const d=await ni(e,o);if(!d)return r(t=>t.map(t=>t.id===e?n:t)),m.error("Failed to update status in database"),!1;r(t=>t.map(t=>t.id===e?{...o,...d}:t));let u=[];try{const{data:e,error:a,status:r}=await $a.from("sms_triggers").select("*").or(`trigger_type.eq.${t},trigger_event.eq.${t}`);if(a&&406!==r&&400!==r)throw a;u=e||[]}catch(a){u=[]}if(u&&u.length>0)for(const a of u){const{data:r,error:s}=await $a.from("communication_templates").select("*").eq("id",a.template_id).eq("is_active",!0).single();if(!r||s)continue;const{data:i,error:o}=await $a.from("customers").select("*").eq("id",n.customerId).single();if(!i||o||!i.phone)continue;if(a.condition){if(a.condition.brand&&n.brand!==a.condition.brand)continue;if(a.condition.customerTag&&i.customerTag!==a.condition.customerTag)continue}const c={};let l=!1;if(r.variables&&Array.isArray(r.variables))for(const e of r.variables){const t=e,a=e;void 0!==n[t]?c[e]=String(n[t]):void 0!==i[a]?c[e]=String(i[a]):(l=!0,c[e]="")}if(l){await $a.from("sms_trigger_logs").insert({trigger_id:a.id,device_id:e,customer_id:n.customerId,status:t,template_id:r.id,recipient:i.phone,result:"skipped",error:"Missing variable(s) for template"});continue}const d=await Ki.sendTemplateSMS(i.phone,r.id,c,n.customerId);await $a.from("sms_trigger_logs").insert({trigger_id:a.id,device_id:e,customer_id:n.customerId,status:t,template_id:r.id,recipient:i.phone,result:d.success?"sent":"failed",error:d.error||null})}if("repair-complete"===t){if(n.assignedTo&&"technician"===(null==c?void 0:c.role))try{try{const{data:e,error:t}=await $a.from("users").select("points").eq("id",n.assignedTo).single();if(!t&&e){const t=(e.points||0)+20,{error:a}=await $a.from("users").update({points:t}).eq("id",n.assignedTo);if(a)m.success("Repair completed successfully!");else{m.success(`Repair completed! +20 points awarded. Total: ${t} points`);try{await $a.from("staff_points").insert({user_id:n.assignedTo,points:20,reason:`Repair completed for device ${n.brand} ${n.model}`,created_by:c.id})}catch(l){}}}else m.success("Repair completed successfully!")}catch(iu){m.success("Repair completed successfully!")}}catch(iu){}if(m.success("Device ready for handover. Customer care notified."),Zi.sendEmail){const e=await async function(){const{data:e,error:t}=await $a.from("users").select("email").eq("role","customer-care");return t||!e?[]:e.map(e=>e.email).filter(Boolean)}();e.length>0&&await Zi.sendEmail({to:e.join(","),subject:"Device Ready for Handover",content:`Device ${n.brand} ${n.model} (SN: ${n.serialNumber}) is ready for customer handover.`})}}if("done"===t){const{data:e,error:t}=await $a.from("customers").select("name, phone, email").eq("id",n.customerId).single();!t&&e&&(e.phone&&Ki&&Ki.sendDeviceReadySMS&&await Ki.sendDeviceReadySMS(e.phone,e.name||"Customer",n.brand,n.model,n.id,n.customerId),e.email&&Zi.sendEmail&&await Zi.sendEmail({to:e.email,subject:"Your Device is Ready for Pickup",content:`Dear ${e.name},\n\nYour device (${n.brand} ${n.model}, SN: ${n.serialNumber}) is ready for pickup.\n\nThank you.`}))}return await to(e,c.id,c.role,n.status,t,s),!0}catch(iu){return r(t=>t.map(t=>t.id===e?n:t)),m.error("Failed to update status"),!1}})().catch(e=>{}),!0},assignToTechnician:async(e,t,s)=>{if(!c)return!1;if(!a.find(t=>t.id===e))return!1;const n={assignedTo:t,updatedAt:(new Date).toISOString()};try{const t=await ni(e,n);return!!t&&(r(a=>a.map(a=>a.id===e?{...a,...n,...t,assignedTo:t.assigned_to}:a)),!0)}catch(i){return!1}},addRemark:async(e,t)=>{if(!c)return!1;const a={id:crypto.randomUUID(),content:t,createdBy:c.id,createdAt:(new Date).toISOString()};r(t=>t.map(t=>t.id===e?{...t,remarks:[...t.remarks,a],updatedAt:(new Date).toISOString()}:t));try{const{error:r}=await $a.from("device_remarks").insert({id:a.id,device_id:e,content:t,created_by:c.id,created_at:a.createdAt});if(r)return!1}catch(s){return!1}try{await di.playRemarkSound()}catch(iu){}return!0},getDeviceById:async e=>{const t=a.find(t=>t.id===e);if(t)return t;try{const{data:t,error:a}=await $a.from("devices").select("\n          id,\n          customer_id,\n          brand,\n          model,\n          serial_number,\n          issue_description,\n          status,\n          assigned_to,\n          expected_return_date,\n          created_at,\n          updated_at,\n          estimated_hours,\n          warranty_start,\n          warranty_end,\n          warranty_status,\n          repair_count,\n          last_return_date\n        ").eq("id",e).single();if(a)return null;if(t){const[a,r,s]=await Promise.all([$a.from("device_remarks").select("*").eq("device_id",e).order("created_at",{ascending:!1}),$a.from("device_transitions").select("*").eq("device_id",e).order("created_at",{ascending:!1}),$a.from("device_ratings").select("*").eq("device_id",e).order("created_at",{ascending:!1})]);return{...t,serialNumber:t.serial_number,issueDescription:t.issue_description,customerId:t.customer_id,assignedTo:t.assigned_to,expectedReturnDate:t.expected_return_date,customerName:"",phoneNumber:"",remarks:(a.data||[]).map(e=>({id:e.id,content:e.content,createdBy:e.created_by,createdAt:e.created_at})),transitions:(r.data||[]).map(e=>({id:e.id,fromStatus:e.from_status,toStatus:e.to_status,performedBy:e.performed_by,timestamp:e.created_at,signature:e.signature||""})),ratings:(s.data||[]).map(e=>({id:e.id,deviceId:e.device_id,technicianId:e.technician_id,score:e.score||5,comment:e.comment,createdAt:e.created_at})),createdAt:t.created_at,updatedAt:t.updated_at}}return null}catch(iu){return null}},getDevicesByStatus:e=>a.filter(t=>t.status===e),getDevicesByTechnician:e=>"technician"===(null==c?void 0:c.role)&&c.id===e?a:a.filter(t=>t.assignedTo===e),addRating:async(e,t,a,r)=>{if(!c)return!1;const s={id:`rating-${Date.now()}`,deviceId:e,technicianId:t,score:a,comment:r,createdAt:(new Date).toISOString()};return!!(await async function(e){const{data:t,error:a}=await $a.from("device_ratings").insert([e]).select();if(a)throw a;return t&&t[0]?t[0]:null}(s))},getTechnicianRating:()=>0,deleteDevice:async e=>(await ii(e),r(t=>t.filter(t=>t.id!==e)),!0),getDevicesDueToday:()=>{const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;return a.filter(e=>e.expectedReturnDate===t)},getOverdueDevices:()=>{const e=new Date;return a.filter(t=>{if("done"===t.status||"failed"===t.status)return!1;if(!t.expectedReturnDate)return!1;const a=new Date(t.expectedReturnDate),r=new Date(e.getFullYear(),e.getMonth(),e.getDate());if(a.getTime()===r.getTime()){return new Date(t.createdAt)<new Date(e.getTime()-864e5)}{const r=new Date(t.createdAt),s=Math.ceil((a.getTime()-r.getTime())/36e5),n=Math.max(s-4,24),i=new Date(r.getTime()+60*n*60*1e3);return e>i}})},getDeviceOverdueStatus:e=>{if("done"===e.status||"failed"===e.status)return{isOverdue:!1,overdueTime:null,status:"completed"};if(!e.expectedReturnDate)return{isOverdue:!1,overdueTime:null,status:"no-due-date"};const t=new Date,a=new Date(e.expectedReturnDate),r=new Date(t.getFullYear(),t.getMonth(),t.getDate());if(a.getTime()===r.getTime()){const a=new Date(e.createdAt),r=new Date(t.getTime()-864e5);if(a<r){const e=t.getTime()-r.getTime();return{isOverdue:!0,overdueTime:`${Math.floor(e/36e5)}h overdue`,status:"overdue"}}return{isOverdue:!1,overdueTime:null,status:"due-today"}}{const r=new Date(e.createdAt),s=Math.ceil((a.getTime()-r.getTime())/36e5),n=Math.max(s-4,24),i=new Date(r.getTime()+60*n*60*1e3);if(t>i){const e=t.getTime()-i.getTime(),a=Math.floor(e/864e5),r=Math.floor(e%864e5/36e5);let s="";return s=a>0?`${a}d ${r}h overdue`:`${r}h overdue`,{isOverdue:!0,overdueTime:s,status:"overdue"}}{const e=a.getTime()-t.getTime(),r=Math.floor(e/864e5),s=Math.floor(e%864e5/36e5);let n="";return n=r>0?`${r}d ${s}h remaining`:s>0?`${s}h remaining`:"Due soon",{isOverdue:!1,overdueTime:n,status:"on-time"}}}}},children:t})}),no=new Map;function io(t={}){const{autoFetch:a=!0,simple:r=!1,cacheKey:s="default"}=t,[n,i]=e.useState([]),[o,c]=e.useState(!1),[l,d]=e.useState(null),[u,m]=e.useState({online:navigator.onLine,quality:"unknown",message:"Checking connection..."}),h=e.useRef(!0),p=e.useRef(null);e.useEffect(()=>{const e=()=>{const e=Ei();m({online:navigator.onLine,quality:e.quality,message:e.message})};e();const t=()=>e(),a=()=>e();window.addEventListener("online",t),window.addEventListener("offline",a);const r=setInterval(e,3e4);return()=>{window.removeEventListener("online",t),window.removeEventListener("offline",a),clearInterval(r)}},[]),e.useEffect(()=>(h.current=!0,()=>{h.current=!1,p.current&&p.current.abort()}),[]);const g=async(e=!1)=>{if(!h.current)return;const t=`${s}_${r?"simple":"full"}`;if(!e){const e=no.get(t);if(e&&Date.now()-e.timestamp<3e5)return i(e.data),c(!1),void d(null);if(null==e?void 0:e.promise){c(!0);try{const t=await e.promise;h.current&&(i(t),c(!1),d(null))}catch(n){h.current&&(d(n instanceof Error?n.message:"Failed to fetch customers"),c(!1))}return}}const a=async()=>yi(async()=>{let e;try{c(!0),d(null),p.current=new AbortController,e=setTimeout(()=>{p.current&&p.current.abort()},12e4);const a=r?Ci():Pi();no.set(t,{data:[],timestamp:Date.now(),promise:a});const s=await a;return e&&clearTimeout(e),no.set(t,{data:s,timestamp:Date.now()}),h.current&&(i(s),c(!1),d(null)),s}catch(n){e&&clearTimeout(e);const s=n instanceof Error?n.message:"Failed to fetch customers";if((s.includes("503")||s.includes("Service Unavailable"))&&retryCount<maxRetries){const e=baseDelay*Math.pow(2,retryCount);return h.current&&d(`Database temporarily unavailable. Retrying in ${Math.round(e/1e3)} seconds...`),await new Promise(t=>setTimeout(t,e)),a(retryCount+1)}throw h.current&&(s.includes("QUIC_PROTOCOL_ERROR")||s.includes("net::ERR_QUIC_PROTOCOL_ERROR"),s.includes("timeout")||s.includes("Request timeout"),s.includes("503")||s.includes("Service Unavailable")?d("Database service is temporarily unavailable. Please try again in a few minutes."):d(s),c(!1)),no.delete(t),n}finally{e&&clearTimeout(e),p.current=null}});try{await a()}catch(n){}};return e.useEffect(()=>{a&&g()},[a,r,s]),{customers:n,loading:o,error:l,refetch:async()=>{await g(!0)},clearCache:()=>{no.clear(),bi.clear()},networkStatus:u}}const oo=e.createContext(void 0),co=()=>{const t=e.useContext(oo);if(!t)throw new Error("useCustomers must be used within a CustomersProvider");return t};const lo=({children:t})=>{const a=e.useContext(wn),r=(null==a?void 0:a.currentUser)||null,{customers:s,loading:n,error:i,refetch:o,clearCache:c}=io({simple:!0,autoFetch:!!r,cacheKey:"customers-context"}),l=async(e,t)=>{if(!r)return!1;const a={id:`note-${Date.now()}`,content:t,createdBy:r.id,createdAt:(new Date).toISOString()},s=await async function(e,t){const{data:a,error:r}=await $a.from("customer_notes").insert([{...e,customer_id:t}]).select();if(r)throw r;try{await di.playRemarkSound()}catch(s){}return a&&a[0]?a[0]:null}(a,e);return!!s};return $.jsx(oo.Provider,{value:{customers:s,loading:n,error:i,refreshCustomers:async()=>{await o()},addCustomer:async e=>{try{if(!r)throw new Error("User not authenticated");const a=crypto.randomUUID(),s=(new Date).toISOString(),n={id:a,name:e.name,email:e.email||"",phone:e.phone,gender:e.gender||"other",city:e.city||"",joinedDate:s,loyaltyLevel:"interested",colorTag:"new",referredBy:e.referredBy||void 0,referrals:[],totalSpent:0,points:0,lastVisit:s,isActive:!0,referralSource:e.referralSource||void 0,birthMonth:e.birthMonth||void 0,birthDay:e.birthDay||void 0,initialNotes:"string"==typeof e.notes?e.notes:"",notes:[],promoHistory:[],payments:[],devices:[],createdBy:r.id},i=await ji(n);if(!i)throw new Error("Failed to add customer to database - no data returned");try{const e="Welcome! 10 points awarded for new customer registration.",t={id:crypto.randomUUID(),note:e,created_by:r.id,created_at:(new Date).toISOString(),customer_id:a},{data:s,error:n}=await $a.from("customer_notes").insert(t)}catch(t){}return{...i,notes:i.notes||[],promoHistory:i.promoHistory||[],payments:i.payments||[],devices:i.devices||[]}}catch(a){throw a}},updateCustomer:async(e,t)=>{try{if(!r)return!1;const n=s.find(t=>t.id===e);let i=(null==n?void 0:n.colorTag)||"new",o=(null==n?void 0:n.isActive)??!0;const c=t.notes||(null==n?void 0:n.notes)||[];if(function(e){return!!e&&e.some(e=>e.content&&(e.content.toLowerCase().includes("complaint")||e.content.toLowerCase().includes("complain")))}(c))i="complainer";else{i=((a={...n,...t,notes:c,id:e})&&a.id&&a.notes?a.notes.filter(e=>e.content&&e.content.toLowerCase().includes("checked in")).length:0)>=10?"vip":"new"}const l=t.lastVisit||(null==n?void 0:n.lastVisit);if(l){const e=new Date(l).getTime();o=!(Date.now()-e>31536e6)}const d={...t,colorTag:i,isActive:o},u=await Di(e,d);if(!u)return!1;const m=Date.now(),h=m-new Date(u.lastVisit).getTime()<7776e6;let p=u;if(u.isActive!==h){const t=await Di(e,{isActive:h});p=t?{...t,notes:t.notes||[],promoHistory:t.promoHistory||[],payments:t.payments||[],devices:t.devices||[]}:{...u,notes:u.notes||[],promoHistory:u.promoHistory||[],payments:u.payments||[],devices:u.devices||[]}}else p={...u,notes:u.notes||[],promoHistory:u.promoHistory||[],payments:u.payments||[],devices:u.devices||[]};return!0}catch(n){return!1}var a},markCustomerAsRead:async e=>{try{return!!r}catch(t){return!1}},addNote:l,sendPromo:async(e,t)=>{if(!r)return!1;const a={...t,id:`promo-${Date.now()}`,sentAt:(new Date).toISOString(),status:"sent"},s=await async function(e,t){const{data:a,error:r}=await $a.from("promo_messages").insert([{...e,customer_id:t}]).select();if(r)throw r;return a&&a[0]?a[0]:null}(a,e);return!!s},addPoints:(e,t,a)=>!!r&&(l(e,`Added ${t} points - ${a}`),!0),getCustomerById:e=>s.find(t=>t.id===e),getCustomersByLoyalty:e=>s.filter(t=>t.loyaltyLevel===e),getInactiveCustomers:e=>{const t=new Date;return t.setDate(t.getDate()-e),s.filter(e=>new Date(e.lastVisit)<t)},clearCache:c},children:t})};async function uo(e){var t,a;try{const r=(new Date).toISOString().split("T")[0],{data:s,error:n}=await $a.from("user_daily_goals").select("*").eq("user_id",e).eq("date",r).eq("is_active",!0).order("goal_type");return n?("42P01"===n.code||(null==(t=n.message)?void 0:t.includes("does not exist"))||"406"===n.code||null==(a=n.message)||a.includes("Not Acceptable"),[]):s||[]}catch(iu){return[]}}async function mo(e){try{const t=e.date||(new Date).toISOString().split("T")[0],{data:a}=await $a.from("user_daily_goals").select("*").eq("user_id",e.user_id).eq("goal_type",e.goal_type).eq("date",t).eq("is_active",!0).single();if(a){const{data:t,error:r}=await $a.from("user_daily_goals").update({goal_value:e.goal_value}).eq("id",a.id).select().single();return r?null:t}const r={...e,date:e.date||(new Date).toISOString().split("T")[0]},{data:s,error:n}=await $a.from("user_daily_goals").insert(r).select().single();return n?null:s}catch(iu){return null}}async function ho(e,t,a){try{const a=await async function(e,t){var a,r;try{const s=(new Date).toISOString().split("T")[0],{data:n,error:i}=await $a.from("user_daily_goals").select("*").eq("user_id",e).eq("goal_type",t).eq("date",s).eq("is_active",!0).single();return i?("42P01"===i.code||(null==(a=i.message)?void 0:a.includes("does not exist"))||"PGRST116"===i.code||"406"===i.code||null==(r=i.message)||r.includes("Not Acceptable"),null):n}catch(iu){return null}}(e,t);if(!a)return{current:0,goal:5,progress:0};const s=(new Date).toISOString().slice(0,10);let n=0;try{switch(t){case"new_customers":const{count:t}=await $a.from("customers").select("id",{count:"exact",head:!0}).gte("created_at",`${s}T00:00:00`).lt("created_at",`${s}T23:59:59`);n=t||0;break;case"devices_processed":if(!e){n=0;break}const{count:a}=await $a.from("devices").select("id",{count:"exact",head:!0}).eq("assigned_to",e).gte("created_at",`${s}T00:00:00`).lt("created_at",`${s}T23:59:59`);n=a||0;break;case"checkins":const{count:r}=await $a.from("customer_checkins").select("id",{count:"exact",head:!0}).eq("staff_id",e).gte("checkin_at",s);n=r||0;break;case"repairs_completed":if(!e){n=0;break}const{count:i}=await $a.from("devices").select("id",{count:"exact",head:!0}).eq("assigned_to",e).eq("status","done").gte("updated_at",`${s}T00:00:00`).lt("updated_at",`${s}T23:59:59`);n=i||0}}catch(r){n=0}const i=Math.min(100,Math.round(n/a.goal_value*100));return{current:n,goal:a.goal_value,progress:i}}catch(iu){return{current:0,goal:5,progress:0}}}const po=e.createContext(void 0),go=({children:t})=>{const[a,r]=e.useState([]),[s,n]=e.useState(!0),[i,o]=e.useState(null),[c,l]=e.useState(null),d=e.useContext(wn),u=(null==d?void 0:d.currentUser)||null,m=e.useCallback(async()=>{var e,t;try{const{data:a,error:r}=await $a.from("user_daily_goals").select("id").limit(1);if(r){if("42P01"===r.code||(null==(e=r.message)?void 0:e.includes("does not exist")))return l(!1),!1;if("406"===r.code||(null==(t=r.message)?void 0:t.includes("Not Acceptable")))return l(!1),!1}return l(!0),!0}catch(a){return l(!1),!1}},[]),h=e.useCallback(async()=>{if(!(null==u?void 0:u.id))return r([]),void n(!1);try{n(!0),o(null);if(!(await m()))return r([]),void n(!1);const e=await async function(e,t){try{const r=await uo(e);if(r.length>0)return r;const s=[];"customer-care"===t?s.push({user_id:e,goal_type:"new_customers",goal_value:5},{user_id:e,goal_type:"checkins",goal_value:10}):"technician"===t?s.push({user_id:e,goal_type:"devices_processed",goal_value:8},{user_id:e,goal_type:"repairs_completed",goal_value:6}):s.push({user_id:e,goal_type:"new_customers",goal_value:3},{user_id:e,goal_type:"devices_processed",goal_value:5});const n=[];for(const e of s)try{const t=await mo(e);t&&n.push(t)}catch(a){}return 0===n.length?await uo(e):n}catch(i){return[]}}(u.id,u.role);r(e)}catch(e){o("Failed to load user goals"),r([])}finally{n(!1)}},[null==u?void 0:u.id,null==u?void 0:u.role,m]),p=e.useCallback(async e=>{if(!(null==u?void 0:u.id)||!c)return{current:0,goal:5,progress:0};try{return await ho(u.id,e)}catch(t){return{current:0,goal:5,progress:0}}},[null==u?void 0:u.id,u,c]),g=e.useCallback(async(e,t)=>{if(!c)return!1;try{const a=await async function(e,t){try{const{data:a,error:r}=await $a.from("user_daily_goals").update(t).eq("id",e).select().single();return r?null:a}catch(i){return null}}(e,t);return!!a&&(r(t=>t.map(t=>t.id===e?a:t)),!0)}catch(a){return!1}},[c]),_=e.useCallback(async e=>{if(!(null==u?void 0:u.id)||!c)return!1;try{const t=await mo({user_id:u.id,...e});return!!t&&(r(e=>[...e,t]),!0)}catch(t){return!1}},[null==u?void 0:u.id,c]),f=e.useCallback(async e=>{if(!c)return!1;try{const t=await async function(e){try{const{error:t}=await $a.from("user_daily_goals").update({is_active:!1}).eq("id",e);return!t}catch(i){return!1}}(e);return!!t&&(r(t=>t.filter(t=>t.id!==e)),!0)}catch(t){return!1}},[c]);e.useEffect(()=>{h()},[h]);const y={userGoals:a,loading:s,error:i,refreshGoals:h,getGoalProgress:p,updateGoal:g,createGoal:_,deleteGoal:f};return $.jsx(po.Provider,{value:y,children:t})};const _o=new class{constructor(){this.cache=new Map,this.pendingRequests=new Map,this.DEFAULT_CACHE_TIME=5e3}async query(e,t,a=this.DEFAULT_CACHE_TIME){const r=this.cache.get(e);if(r&&Date.now()-r.timestamp<a)return r.data;const s=this.pendingRequests.get(e);if(s)return s;const n=t().then(t=>(this.cache.set(e,{data:t,timestamp:Date.now()}),this.pendingRequests.delete(e),t)).catch(t=>{throw this.pendingRequests.delete(e),t});return this.pendingRequests.set(e,n),n}clearCache(e){e?this.cache.delete(e):this.cache.clear()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheKeys:Array.from(this.cache.keys())}}cleanupExpiredCache(e=6e4){const t=Date.now();for(const[a,r]of this.cache.entries())t-r.timestamp>e&&this.cache.delete(a)}};async function fo(e,t,a){return _o.query(e,t,a)}async function yo(e){const t=e||Io();if(!t)throw new Error("No branch selected. Please select a branch first.");const a=await Ao(t);if(!a)throw new Error("Branch not found");const r=[],s=await async function(e){try{const t=await Ao(e);if(!t)throw new Error("Branch not found");const a=vo("products",t);let r;r="isolated"===a?$a.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",e):$a.from("lats_products").select("*",{count:"exact",head:!0});const{count:s}=await r,{count:n}=await $a.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",e),{count:i}=await $a.from("lats_products").select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null),{count:o}=await $a.from("lats_products").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:i||0,shared:0,total:o||0};let l="unknown",d=!0,u="";return"isolated"===a?s===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${s} products visible (only from this branch). Database has ${i} products from other branches (correctly hidden)`):0===s&&0===n?(l="isolated",d=!0,u=` No products found for this branch yet. Database has ${i} products from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${s} products visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${s} total products visible (${c.currentBranch} from this branch, ${c.otherBranches} from others)`),{feature:"Products",passed:d,expected:a,actual:l,details:u,dataCount:c,timestamp:(new Date).toISOString()}}catch(iu){return{feature:"Products",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing products: ${iu.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:(new Date).toISOString()}}}(t);r.push(s);const n=await async function(e){try{const t=await Ao(e);if(!t)throw new Error("Branch not found");const a=vo("customers",t);let r;r="isolated"===a?$a.from("customers").select("*",{count:"exact",head:!0}).eq("branch_id",e):$a.from("customers").select("*",{count:"exact",head:!0});const{count:s}=await r,{count:n}=await $a.from("customers").select("*",{count:"exact",head:!0}).eq("branch_id",e),{count:i}=await $a.from("customers").select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null),{count:o}=await $a.from("customers").select("*",{count:"exact",head:!0});let c="unknown",l=!0,d="";return"isolated"===a?s===n&&n>0?(c="isolated",l=!0,d=` Isolation working: ${s} customers visible (only from this branch). Database has ${i} customers from other branches (correctly hidden)`):0===s&&0===n?(c="isolated",l=!0,d=` No customers found for this branch yet. Database has ${i} customers from other branches (correctly hidden)`):(c="shared",l=!1,d=` Isolation FAILED: ${s} customers visible but should only be ${n}`):(c="shared",l=!0,d=` Sharing working: ${s} total customers visible`),{feature:"Customers",passed:l,expected:a,actual:c,details:d,dataCount:{currentBranch:n||0,otherBranches:i||0,shared:0,total:o||0},timestamp:(new Date).toISOString()}}catch(iu){return{feature:"Customers",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing customers: ${iu.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:(new Date).toISOString()}}}(t);r.push(n);const i=await async function(e){try{const t=await Ao(e);if(!t)throw new Error("Branch not found");const a=vo("inventory",t);let r;r="isolated"===a?$a.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",e).gt("stock_quantity",0):$a.from("lats_products").select("*",{count:"exact",head:!0}).gt("stock_quantity",0);const{count:s}=await r,{count:n}=await $a.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",e).gt("stock_quantity",0),{count:i}=await $a.from("lats_products").select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null).gt("stock_quantity",0),{count:o}=await $a.from("lats_products").select("*",{count:"exact",head:!0}).gt("stock_quantity",0);let c="unknown",l=!0,d="";return"isolated"===a?s===n&&n>0?(c="isolated",l=!0,d=` Isolation working: ${s} inventory items visible (only from this branch). Database has ${i} items from other branches (correctly hidden)`):0===s&&0===n?(c="isolated",l=!0,d=` No inventory found for this branch yet. Database has ${i} items from other branches (correctly hidden)`):(c="shared",l=!1,d=` Isolation FAILED: ${s} inventory items visible but should only be ${n}`):(c="shared",l=!0,d=` Sharing working: ${s} total inventory items visible`),{feature:"Inventory",passed:l,expected:a,actual:c,details:d,dataCount:{currentBranch:n||0,otherBranches:i||0,shared:0,total:o||0},timestamp:(new Date).toISOString()}}catch(iu){return{feature:"Inventory",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing inventory: ${iu.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:(new Date).toISOString()}}}(t);r.push(i);const o=await async function(e){try{const t=await Ao(e);if(!t)throw new Error("Branch not found");const a=vo("suppliers",t);let r;r="isolated"===a?$a.from("lats_suppliers").select("*",{count:"exact",head:!0}).eq("branch_id",e):$a.from("lats_suppliers").select("*",{count:"exact",head:!0});const{count:s}=await r,{count:n}=await $a.from("lats_suppliers").select("*",{count:"exact",head:!0}).eq("branch_id",e),{count:i}=await $a.from("lats_suppliers").select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null),{count:o}=await $a.from("lats_suppliers").select("*",{count:"exact",head:!0});let c="unknown",l=!0,d="";return"isolated"===a?s===n&&n>0?(c="isolated",l=!0,d=` Isolation working: ${s} suppliers visible (only from this branch). Database has ${i} suppliers from other branches (correctly hidden)`):0===s&&0===n?(c="isolated",l=!0,d=` No suppliers found for this branch yet. Database has ${i} suppliers from other branches (correctly hidden)`):(c="shared",l=!1,d=` Isolation FAILED: ${s} suppliers visible but should only be ${n}`):(c="shared",l=!0,d=` Sharing working: ${s} total suppliers visible`),{feature:"Suppliers",passed:l,expected:a,actual:c,details:d,dataCount:{currentBranch:n||0,otherBranches:i||0,shared:0,total:o||0},timestamp:(new Date).toISOString()}}catch(iu){return{feature:"Suppliers",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing suppliers: ${iu.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:(new Date).toISOString()}}}(t);r.push(o);const c=await async function(e){try{const t=await Ao(e);if(!t)throw new Error("Branch not found");const a=vo("categories",t);let r;r="isolated"===a?$a.from("lats_categories").select("*",{count:"exact",head:!0}).eq("branch_id",e):$a.from("lats_categories").select("*",{count:"exact",head:!0});const{count:s}=await r,{count:n}=await $a.from("lats_categories").select("*",{count:"exact",head:!0}).eq("branch_id",e),{count:i}=await $a.from("lats_categories").select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null),{count:o}=await $a.from("lats_categories").select("*",{count:"exact",head:!0});let c="unknown",l=!0,d="";return"isolated"===a?s===n&&n>0?(c="isolated",l=!0,d=` Isolation working: ${s} categories visible (only from this branch). Database has ${i} categories from other branches (correctly hidden)`):0===s&&0===n?(c="isolated",l=!0,d=` No categories found for this branch yet. Database has ${i} categories from other branches (correctly hidden)`):(c="shared",l=!1,d=` Isolation FAILED: ${s} categories visible but should only be ${n}`):(c="shared",l=!0,d=` Sharing working: ${s} total categories visible`),{feature:"Categories",passed:l,expected:a,actual:c,details:d,dataCount:{currentBranch:n||0,otherBranches:i||0,shared:0,total:o||0},timestamp:(new Date).toISOString()}}catch(iu){return{feature:"Categories",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing categories: ${iu.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:(new Date).toISOString()}}}(t);r.push(c);const l=r.filter(e=>e.passed).length,d=r.filter(e=>!e.passed).length,u=r.filter(e=>e.details.includes("")).length;return{branchId:t,branchName:a.name,isolationMode:a.data_isolation_mode,settings:{share_products:a.share_products,share_customers:a.share_customers,share_inventory:a.share_inventory,share_suppliers:a.share_suppliers,share_categories:a.share_categories,share_employees:a.share_employees},testResults:r,summary:{totalTests:r.length,passed:l,failed:d,warnings:u}}}function vo(e,t){if("shared"===t.data_isolation_mode)return"shared";if("isolated"===t.data_isolation_mode)return"isolated";return{products:t.share_products,customers:t.share_customers,inventory:t.share_inventory,suppliers:t.share_suppliers,categories:t.share_categories,employees:t.share_employees}[e]?"shared":"isolated"}function wo(){localStorage.setItem("branch_isolation_debug","true")}function bo(){localStorage.removeItem("branch_isolation_debug")}function So(){return"true"===localStorage.getItem("branch_isolation_debug")}function xo(e,t,a,r){So()}"undefined"!=typeof window&&setInterval(()=>{_o.cleanupExpiredCache()},6e4),"undefined"!=typeof window&&(window.testBranchIsolation=async function(){try{return await yo()}catch(iu){throw iu}},window.enableBranchDebug=wo,window.disableBranchDebug=bo);const ko=new Map;let Eo=0;const Io=()=>localStorage.getItem("current_branch_id"),Ao=async e=>{try{const t=Date.now();if(t-Eo<6e4&&ko.has(e))return ko.get(e);const{data:a,error:r}=await $a.from("store_locations").select("*").eq("id",e).single();if(r)throw r;return ko.set(e,a),Eo=t,a}catch(iu){return null}},Po=async e=>{const t=Io();if(!t)return!0;try{const a=await Ao(t);if(!a)return!0;if("shared"===a.data_isolation_mode)return!0;if("isolated"===a.data_isolation_mode)return!1;return{products:a.share_products,customers:a.share_customers,inventory:a.share_inventory,suppliers:a.share_suppliers,categories:a.share_categories,employees:a.share_employees}[e]??!0}catch(iu){return!0}},Co=async(e,t)=>{const a=Io();if(!a)return xo(),e;const r=await Ao(a);return await Po(t)?(xo(0,0,null==r||r.data_isolation_mode),e):(xo(0,0,null==r||r.data_isolation_mode),e.or(`branch_id.eq.${a},is_shared.eq.true`))},To=async(e,t,a)=>{const r=Io(),s=await Po(a),n={...t,branch_id:s?null:r,is_shared:s},{data:i,error:o}=await $a.from(e).insert([n]).select().single();if(o)throw o;return i},jo=async e=>{const t={...e,branch_id:Io()||null},{data:a,error:r}=await $a.from("lats_sales").insert([t]).select().single();if(r)throw r;return a},Do=async()=>{let e=$a.from("lats_products").select("\n      *,\n      category:lats_categories!category_id(*),\n      variants:lats_product_variants!product_id(*)\n    ").eq("is_active",!0);const t=Io(),a=await Po("products");t&&!a&&(e=e.or(`branch_id.eq.${t},is_shared.eq.true`));const{data:r,error:s}=await e;if(s)throw s;return r},Ro=async(e,t)=>{const a=Io();let r=$a.from("lats_sales").select("*");a&&(r=r.eq("branch_id",a)),e&&(r=r.gte("created_at",e)),t&&(r=r.lte("created_at",t));const{data:s,error:n}=await r.order("created_at",{ascending:!1});if(n)throw n;return s},Lo={getCurrentBranchId:Io,getBranchSettings:Ao,isDataShared:Po,addBranchFilter:Co,createWithBranch:To,createSaleWithBranch:jo,getBranchProducts:Do,getBranchSales:Ro},Oo=Object.freeze(Object.defineProperty({__proto__:null,addBranchFilter:Co,clearBranchCache:()=>{ko.clear(),Eo=0},createSaleWithBranch:jo,createWithBranch:To,default:Lo,getBranchProducts:Do,getBranchSales:Ro,getBranchSettings:Ao,getCurrentBranchId:Io,isDataShared:Po},Symbol.toStringTag,{value:"Module"}));async function qo(e=5e3){const t=Io();return fo(`device-stats-${t||"all"}`,async()=>{let e=$a.from("devices").select("status, estimated_completion_date, created_at");t&&(e=e.eq("branch_id",t));const{data:a,error:r}=await e;if(r)throw r;return a||[]},e)}async function No(e=5e3){const t=Io();return fo(`customer-stats-${t||"all"}`,async()=>{let e=$a.from("customers").select("id, joined_date, is_active");t&&(e=e.eq("branch_id",t));const{data:a,error:r}=await e;if(r)throw r;return a||[]},e)}async function Mo(e=5e3){const t=Io();return fo(`payment-stats-${t||"all"}`,async()=>{let e=$a.from("customer_payments").select("amount, payment_date, status");t&&(e=e.eq("branch_id",t));const{data:a,error:r}=await e;if(r)throw r;return a||[]},e)}async function Uo(e=5e3){const t=Io();return fo(`inventory-stats-${t||"all"}`,async()=>{let e=$a.from("lats_products").select("id, name, is_active, branch_id, is_shared").eq("is_active",!0);t&&(e=e.or(`is_shared.eq.true,branch_id.eq.${t}`));const{data:a,error:r}=await e;if(r)throw r;const s=(a||[]).map(e=>e.id);if(0===s.length)return[];let n=$a.from("lats_product_variants").select("id, product_id, quantity, cost_price, unit_price, selling_price, min_quantity, branch_id, is_shared").in("product_id",s);t&&(n=n.or(`is_shared.eq.true,branch_id.eq.${t}`));const{data:i,error:o}=await n;if(o)throw o;return i||[]},e)}const Bo=e.createContext(void 0),$o=({children:t})=>{const[a,r]=e.useState([]),[s,n]=e.useState(!0),i=async()=>{n(!0);try{const{data:{user:e},error:t}=await $a.auth.getUser();if(t||!e)return r([]),void n(!1);let a=[],s=null;try{a=await async function(e=5e3){const t=Io();return fo(`customer-payments-${t||"all"}`,async()=>{let e=$a.from("customer_payments").select("*").order("payment_date",{ascending:!1});t&&(e=e.eq("branch_id",t));const{data:a,error:r}=await e;if(r)throw r;return a||[]},e)}()}catch(iu){s=iu;const t=(null==s?void 0:s.message)||"";t.includes('relation "public.customer_payments" does not exist'),t.includes("JWT")||t.includes("auth")}let i=[],o=null;try{try{i=await async function(e=5e3){return fo("lats-sales",async()=>{const e="undefined"!=typeof localStorage?localStorage.getItem("current_branch_id"):null;let t=$a.from("lats_sales").select("*").order("created_at",{ascending:!1});e&&(t=t.eq("branch_id",e));const{data:a,error:r}=await t;if(r)throw r;return a&&a.length>0&&a.slice(0,3).forEach((e,t)=>{}),a||[]},e)}(),o=null}catch(iu){i=[],o=iu}}catch(iu){i=[],o=iu}const c=[];if(!s&&a){const e=[...new Set(a.map(e=>e.device_id).filter(Boolean))],t=[...new Set(a.map(e=>e.customer_id).filter(Boolean))];let r={};if(e.length>0){const{data:t}=await $a.from("devices").select("id, brand, model").in("id",e);t&&(r=Object.fromEntries(t.map(e=>[e.id,e])))}let s={};if(t.length>0)try{const e=await async function(e,t=5e3){return fo(`customers-by-ids-${e.sort().join(",")}`,async()=>{const{data:t,error:a}=await $a.from("customers").select("id, name").in("id",e);if(a)throw a;return t||[]},t)}(t);s=Object.fromEntries(e.map(e=>[e.id,e]))}catch(iu){}const n=a.map(e=>{const t=r[e.device_id],a=s[e.customer_id];return{id:e.id,customer_id:e.customer_id,amount:e.amount,currency:e.currency||"TZS",method:e.method,device_id:e.device_id,payment_date:e.payment_date,payment_type:e.payment_type,status:e.status,created_by:e.created_by,created_at:e.created_at,device_name:t?`${t.brand||""} ${t.model||""}`.trim():void 0,customer_name:(null==a?void 0:a.name)||void 0,source:"device_payment",repairType:e.repair_type,diagnosis:e.diagnosis,deviceBrand:null==t?void 0:t.brand,deviceModel:null==t?void 0:t.model}});c.push(...n)}if(!o&&i){const e=i.map(e=>{var t;return{id:e.id,customer_id:e.customer_id,amount:e.total_amount,currency:e.currency||"TZS",method:e.payment_method,device_id:null,payment_date:e.created_at,payment_type:"payment",status:"completed"===e.status?"completed":"pending"===e.status?"pending":"failed",created_by:e.created_by,created_at:e.created_at,device_name:void 0,customer_name:(null==(t=e.customers)?void 0:t.name)||e.customer_name||void 0,source:"pos_sale",orderId:e.id,orderStatus:e.status,totalAmount:e.total_amount,discountAmount:0,taxAmount:0,shippingCost:0,amountPaid:e.total_amount,balanceDue:0,customerType:"retail",deliveryMethod:"pickup",deliveryAddress:"",deliveryCity:"",deliveryNotes:""}});c.push(...e)}c.sort((e,t)=>{const a=new Date(e.payment_date||e.created_at);return new Date(t.payment_date||t.created_at).getTime()-a.getTime()}),r(c)}catch(iu){}finally{n(!1)}},o=e=>a.filter(t=>t.source===e);return e.useEffect(()=>{let e;i();const{data:{subscription:t}}=$a.auth.onAuthStateChange((t,a)=>{e&&clearTimeout(e),e=setTimeout(()=>{"SIGNED_IN"===t&&a?i():"SIGNED_OUT"===t&&(r([]),n(!1))},100)});return()=>{e&&clearTimeout(e),t.unsubscribe()}},[]),$.jsx(Bo.Provider,{value:{payments:a,loading:s,refreshPayments:i,getPaymentsBySource:o,getPaymentsByStatus:e=>a.filter(t=>t.status===e),getPaymentsByDateRange:(e,t)=>{const r=new Date(e),s=new Date(t);return a.filter(e=>{const t=new Date(e.payment_date||e.created_at);return t>=r&&t<=s})},getTotalRevenue:()=>a.filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),getRevenueBySource:()=>{const e=o("device_payment").filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),t=o("pos_sale").filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0),a=o("repair_payment").filter(e=>"completed"===e.status).reduce((e,t)=>e+(Number(t.amount)||0),0);return{devicePayments:e,posSales:t,repairPayments:a,total:e+t+a}}},children:t})},Fo=e.createContext(void 0),zo=({children:t})=>{const[a,r]=e.useState(()=>localStorage.getItem("app-theme")||"light"),s="dark"===a||"dark-cards"===a;return e.useEffect(()=>{document.body.className=document.body.className.replace(/theme-\w+/g,""),document.body.classList.add(`theme-${a}`)},[a]),$.jsx(Fo.Provider,{value:{theme:a,setTheme:e=>{r(e),localStorage.setItem("app-theme",e),document.body.className=document.body.className.replace(/theme-\w+/g,""),document.body.classList.add(`theme-${e}`)},isDark:s},children:t})},Vo=()=>{const t=e.useContext(Fo);if(void 0===t)throw new Error("useTheme must be used within a ThemeProvider");return t},Wo=e.createContext(void 0),Ho=({children:t})=>{const[a,r]=e.useState([]),s={jobs:a,addJob:e.useCallback(e=>{const t=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={id:t,title:e,status:"pending",progress:0,timestamp:Date.now()};return r(e=>[...e,a]),t},[]),updateJob:e.useCallback((e,t)=>{r(a=>a.map(a=>a.id===e?{...a,...t}:a))},[]),removeJob:e.useCallback(e=>{r(t=>t.filter(t=>t.id!==e))},[]),cancelJob:e.useCallback(e=>{r(t=>t.map(t=>t.id===e&&"pending"===t.status?{...t,status:"failed",error:"Cancelled by user"}:t))},[]),clearCompletedJobs:e.useCallback(()=>{r(e=>e.filter(e=>"completed"!==e.status&&"failed"!==e.status))},[]),clearAllJobs:e.useCallback(()=>{r([])},[]),isVisible:a.length>0};return $.jsx(Wo.Provider,{value:s,children:t})},Qo={business_name:"inauzwa",business_address:"",business_phone:"",business_email:"",business_website:"",business_logo:null,theme:"light",language:"en",currency:"TZS",timezone:"Africa/Dar_es_Salaam",date_format:"DD/MM/YYYY",time_format:"24",font_size:"medium",show_product_images:!0,show_stock_levels:!0,show_prices:!0,show_barcodes:!0,products_per_page:20,auto_complete_search:!0,confirm_delete:!0,show_confirmations:!0,enable_sound_effects:!0,sound_volume:.5,enable_click_sounds:!0,enable_cart_sounds:!0,enable_payment_sounds:!0,enable_delete_sounds:!0,enable_animations:!0,enable_caching:!0,cache_duration:300,enable_lazy_loading:!0,max_search_results:50,enable_tax:!0,tax_rate:16,day_closing_passcode:"1234"},Go={enable_dynamic_pricing:!0,enable_loyalty_pricing:!0,enable_bulk_pricing:!0,enable_time_based_pricing:!1,enable_customer_pricing:!1,enable_special_events:!1,loyalty_discount_percent:5,loyalty_points_threshold:1e3,loyalty_max_discount:20,bulk_discount_enabled:!0,bulk_discount_threshold:10,bulk_discount_percent:10,time_based_discount_enabled:!1,time_based_start_time:"18:00",time_based_end_time:"22:00",time_based_discount_percent:15,customer_pricing_enabled:!1,vip_customer_discount:10,regular_customer_discount:5,special_events_enabled:!1,special_event_discount_percent:20},Ko={receipt_template:"standard",receipt_width:80,receipt_font_size:12,show_business_logo:!0,show_business_name:!0,show_business_address:!0,show_business_phone:!0,show_business_email:!1,show_business_website:!1,show_transaction_id:!0,show_date_time:!0,show_cashier_name:!0,show_customer_name:!0,show_customer_phone:!1,show_product_names:!0,show_product_skus:!1,show_product_barcodes:!1,show_quantities:!0,show_unit_prices:!0,show_discounts:!0,show_subtotal:!0,show_tax:!0,show_discount_total:!0,show_grand_total:!0,show_payment_method:!0,show_change_amount:!0,auto_print_receipt:!1,print_duplicate_receipt:!1,enable_email_receipt:!1,enable_sms_receipt:!1,enable_receipt_numbering:!0,receipt_number_prefix:"RCP",receipt_number_start:1,receipt_number_format:"RCP-{YEAR}-{NUMBER}",show_footer_message:!0,footer_message:"Thank you for your business!",show_return_policy:!1,return_policy_text:"Returns accepted within 7 days with receipt",enable_whatsapp_pdf:!0,whatsapp_pdf_auto_send:!1,whatsapp_pdf_show_preview:!0,whatsapp_pdf_format:"a4",whatsapp_pdf_quality:"standard",whatsapp_pdf_include_logo:!0,whatsapp_pdf_include_images:!1,whatsapp_pdf_include_qr:!0,whatsapp_pdf_include_barcode:!1,whatsapp_pdf_message:"Thank you for your purchase! Please find your receipt attached.",enable_email_pdf:!0,enable_print_pdf:!0,enable_download_pdf:!0,show_share_button:!0},Yo={enable_barcode_scanner:!0,enable_camera_scanner:!0,enable_keyboard_input:!0,enable_manual_entry:!0,auto_add_to_cart:!0,auto_focus_search:!0,play_sound_on_scan:!0,vibrate_on_scan:!0,show_scan_feedback:!0,show_invalid_barcode_alert:!0,allow_unknown_products:!1,prompt_for_unknown_products:!0,retry_on_error:!0,max_retry_attempts:3,scanner_connection_type:"usb",scanner_timeout:5e3,support_ean13:!0,support_ean8:!0,support_upc_a:!0,support_upc_e:!0,support_code128:!0,support_code39:!0,support_qr_code:!1,support_data_matrix:!1,enable_continuous_scanning:!1,scan_delay:100,enable_scan_history:!0,max_scan_history:100},Jo={enable_delivery:!0,default_delivery_fee:2e3,free_delivery_threshold:5e4,max_delivery_distance:20,enable_delivery_areas:!0,delivery_areas:["City Center","Suburbs","Outskirts"],area_delivery_fees:{"City Center":1500,Suburbs:2500,Outskirts:3500},area_delivery_times:{"City Center":30,Suburbs:60,Outskirts:90},enable_delivery_hours:!0,delivery_start_time:"08:00",delivery_end_time:"20:00",enable_same_day_delivery:!0,enable_next_day_delivery:!0,delivery_time_slots:["Morning","Afternoon","Evening"],notify_customer_on_delivery:!0,notify_driver_on_assignment:!0,enable_sms_notifications:!0,enable_email_notifications:!1,enable_driver_assignment:!0,driver_commission:15,require_signature:!0,enable_driver_tracking:!0,enable_scheduled_delivery:!1,enable_partial_delivery:!1,require_advance_payment:!1,advance_payment_percent:50},Xo={enable_product_search:!0,enable_customer_search:!0,enable_sales_search:!0,search_by_name:!0,search_by_barcode:!0,search_by_sku:!0,search_by_category:!0,search_by_supplier:!0,search_by_description:!1,search_by_tags:!1,enable_fuzzy_search:!0,enable_autocomplete:!0,min_search_length:2,max_search_results:50,search_timeout:3e3,search_debounce_time:300,enable_search_history:!0,max_search_history:20,enable_recent_searches:!0,enable_popular_searches:!0,enable_search_suggestions:!0},Zo={enable_performance_mode:!1,enable_caching:!0,cache_size:100,enable_lazy_loading:!0,max_concurrent_requests:10,enable_database_optimization:!0,enable_auto_backup:!0,backup_frequency:"daily",enable_data_compression:!0,enable_query_optimization:!0,enable_two_factor_auth:!1,enable_session_timeout:!0,session_timeout_minutes:30,enable_audit_logging:!0,enable_encryption:!0,enable_api_access:!1,enable_webhooks:!1,enable_third_party_integrations:!1,enable_data_sync:!1,sync_interval:60,enable_debug_mode:!1,enable_error_reporting:!0,enable_performance_monitoring:!0,enable_logging:!0,log_level:"info",enable_experimental_features:!1,enable_beta_features:!1,enable_custom_scripts:!1,enable_plugin_system:!1,enable_auto_updates:!0};function ec(t,a){const[r,s]=e.useState(a),[n,i]=e.useState(!0),[o,c]=e.useState(!1),[l,d]=e.useState(null);let u=!1;try{const e=bn();u=(null==e?void 0:e.isAuthenticated)||!1}catch(f){u=!1}const h=e.useCallback(async()=>{var e,r;try{i(!0),d(null);const n={general:"loadGeneralSettings",pricing:"loadDynamicPricingSettings",receipt:"loadReceiptSettings",scanner:"loadBarcodeScannerSettings",delivery:"loadDeliverySettings",search:"loadSearchFilterSettings",permissions:"loadUserPermissionsSettings",loyalty:"loadLoyaltyCustomerSettings",analytics:"loadAnalyticsReportingSettings",notifications:"loadNotificationSettings",advanced:"loadAdvancedSettings"}[t];let o=0;const c=3;let l=null;for(;o<c;)try{l=await Ya[n]();break}catch(f){if(o++,((null==(e=f.message)?void 0:e.includes("not authenticated"))||(null==(r=f.message)?void 0:r.includes("Auth session missing")))&&o<c){await new Promise(e=>setTimeout(e,1e3));continue}throw f}l?(Math.random(),s(l),window.dispatchEvent(new CustomEvent("posSettingsLoaded",{detail:{type:t,settings:l}}))):s(a)}catch(f){d(`Failed to load ${t} settings`),s(a)}finally{i(!1)}},[t,a]),p=e.useCallback(async e=>{try{c(!0),d(null);const a={general:"saveGeneralSettings",pricing:"saveDynamicPricingSettings",receipt:"saveReceiptSettings",scanner:"saveBarcodeScannerSettings",delivery:"saveDeliverySettings",search:"saveSearchFilterSettings",permissions:"saveUserPermissionsSettings",loyalty:"saveLoyaltyCustomerSettings",analytics:"saveAnalyticsReportingSettings",notifications:"saveNotificationSettings",advanced:"saveAdvancedSettings"}[t],r=await Ya[a](e);if(r)return s(r),m.success(`${t.charAt(0).toUpperCase()+t.slice(1)} settings saved successfully`),window.dispatchEvent(new CustomEvent("settingsSaved",{detail:{type:t,settings:r}})),await h(),!0;throw new Error("Failed to save settings")}catch(f){return d(`Failed to save ${t} settings`),m.error(`Failed to save ${t} settings`),!1}finally{c(!1)}},[t,h]),g=e.useCallback(async e=>{try{c(!0),d(null);const a={general:"updateGeneralSettings",pricing:"updateDynamicPricingSettings",receipt:"updateReceiptSettings",scanner:"updateBarcodeScannerSettings",delivery:"updateDeliverySettings",search:"updateSearchFilterSettings",permissions:"updateUserPermissionsSettings",loyalty:"updateLoyaltyCustomerSettings",analytics:"updateAnalyticsReportingSettings",notifications:"updateNotificationSettings",advanced:"updateAdvancedSettings"}[t],r=await Ya[a](e);if(r)return s(r),m.success(`${t.charAt(0).toUpperCase()+t.slice(1)} settings updated successfully`),await h(),!0;throw new Error("Failed to update settings")}catch(f){return d(`Failed to update ${t} settings`),m.error(`Failed to update ${t} settings`),!1}finally{c(!1)}},[t,h]),_=e.useCallback(async()=>{try{return c(!0),d(null),s(a),m.success(`${t.charAt(0).toUpperCase()+t.slice(1)} settings reset to defaults`),!0}catch(f){return d(`Failed to reset ${t} settings`),m.error(`Failed to reset ${t} settings`),!1}finally{c(!1)}},[t,a]);return e.useEffect(()=>{u?h():(s(a),i(!1))},[u,h,a]),{settings:r,setSettings:s,loading:n,saving:o,error:l,loadSettings:h,saveSettings:p,updateSettings:g,resetSettings:_,refreshSettings:h}}const tc=()=>ec("general",Qo),ac=()=>ec("pricing",Go),rc=()=>ec("receipt",Ko),sc=()=>ec("scanner",Yo),nc=()=>ec("delivery",Jo),ic=()=>ec("search",Xo),oc=()=>ec("advanced",Zo),cc={en:{"common.save":"Save","common.cancel":"Cancel","common.delete":"Delete","common.edit":"Edit","common.add":"Add","common.search":"Search","common.filter":"Filter","common.clear":"Clear","common.loading":"Loading...","common.error":"Error","common.success":"Success","common.warning":"Warning","common.info":"Info","common.yes":"Yes","common.no":"No","common.ok":"OK","common.close":"Close","common.back":"Back","common.next":"Next","common.previous":"Previous","common.submit":"Submit","common.reset":"Reset","common.refresh":"Refresh","common.export":"Export","common.import":"Import","common.download":"Download","common.upload":"Upload","common.print":"Print","common.copy":"Copy","common.paste":"Paste","common.select":"Select","common.selectAll":"Select All","common.deselectAll":"Deselect All","common.actions":"Actions","common.status":"Status","common.date":"Date","common.time":"Time","common.quantity":"Quantity","common.price":"Price","common.total":"Total","common.subtotal":"Subtotal","common.tax":"Tax","common.discount":"Discount","common.amount":"Amount","common.currency":"Currency","common.percentage":"Percentage","common.unit":"Unit","common.units":"Units","common.item":"Item","common.items":"Items","common.product":"Product","common.products":"Products","common.category":"Category","common.categories":"Categories","common.supplier":"Supplier","common.suppliers":"Suppliers","common.customer":"Customer","common.customers":"Customers","common.order":"Order","common.orders":"Orders","common.sale":"Sale","common.sales":"Sales","common.invoice":"Invoice","common.invoices":"Invoices","common.receipt":"Receipt","common.receipts":"Receipts","common.payment":"Payment","common.payments":"Payments","common.stock":"Stock","common.inventory":"Inventory","common.warehouse":"Warehouse","common.warehouses":"Warehouses","common.location":"Location","common.locations":"Locations","common.sku":"SKU","common.barcode":"Barcode","common.description":"Description","common.notes":"Notes","common.remarks":"Remarks","common.reason":"Reason","common.reference":"Reference","common.created":"Created","common.updated":"Updated","common.createdBy":"Created By","common.updatedBy":"Updated By","common.createdAt":"Created At","common.updatedAt":"Updated At","common.active":"Active","common.inactive":"Inactive","common.enabled":"Enabled","common.disabled":"Disabled","common.visible":"Visible","common.hidden":"Hidden","common.public":"Public","common.private":"Private","common.draft":"Draft","common.published":"Published","common.archived":"Archived","common.deleted":"Deleted","common.pending":"Pending","common.approved":"Approved","common.rejected":"Rejected","common.completed":"Completed","common.cancelled":"Cancelled","common.failed":"Failed","common.successful":"Successful","common.unsuccessful":"Unsuccessful","common.available":"Available","common.unavailable":"Unavailable","common.inStock":"In Stock","common.outOfStock":"Out of Stock","common.lowStock":"Low Stock","common.overStock":"Over Stock","common.zeroStock":"Zero Stock","common.negativeStock":"Negative Stock","common.positiveStock":"Positive Stock","common.stockLevel":"Stock Level","common.minimumStock":"Minimum Stock","common.maximumStock":"Maximum Stock","common.reorderPoint":"Reorder Point","common.reorderQuantity":"Reorder Quantity","common.leadTime":"Lead Time","common.supplierLeadTime":"Supplier Lead Time","common.customerLeadTime":"Customer Lead Time","common.processingTime":"Processing Time","common.deliveryTime":"Delivery Time","common.shippingTime":"Shipping Time","common.returnTime":"Return Time","common.refundTime":"Refund Time","common.exchangeTime":"Exchange Time","common.warrantyTime":"Warranty Time","common.guaranteeTime":"Guarantee Time","common.expiryTime":"Expiry Time","common.validityTime":"Validity Time","common.effectiveTime":"Effective Time","common.expirationTime":"Expiration Time","common.startTime":"Start Time","common.endTime":"End Time","common.beginTime":"Begin Time","common.finishTime":"Finish Time","common.openTime":"Open Time","common.closeTime":"Close Time","common.businessHours":"Business Hours","common.workingHours":"Working Hours","common.officeHours":"Office Hours","common.storeHours":"Store Hours","common.serviceHours":"Service Hours","common.supportHours":"Support Hours","common.helpHours":"Help Hours","common.contactHours":"Contact Hours","common.availability":"Availability","common.availableFrom":"Available From","common.availableTo":"Available To","common.availableUntil":"Available Until","common.availableSince":"Available Since","common.availableFor":"Available For","common.availableIn":"Available In","common.availableAt":"Available At","common.availableOn":"Available On","common.availableBy":"Available By","common.availableThrough":"Available Through","common.availableVia":"Available Via","common.availableWith":"Available With","common.availableWithout":"Available Without","common.availableWithin":"Available Within","common.availableOutside":"Available Outside","common.availableInside":"Available Inside","common.availableAbove":"Available Above","common.availableBelow":"Available Below","common.availableBefore":"Available Before","common.availableAfter":"Available After","common.availableDuring":"Available During","common.availableBetween":"Available Between","common.availableAmong":"Available Among","common.availableAmongst":"Available Amongst","common.availableAcross":"Available Across","common.availableAlong":"Available Along","common.availableAround":"Available Around","common.availableAbout":"Available About","common.availableAgainst":"Available Against","common.availableAlongside":"Available Alongside","common.availableAmid":"Available Amid","common.availableAmidst":"Available Amidst","common.availableAs":"Available As","common.availableBehind":"Available Behind","common.availableBeneath":"Available Beneath","common.availableBeside":"Available Beside","common.availableBesides":"Available Besides","common.availableBeyond":"Available Beyond","common.availableConcerning":"Available Concerning","common.availableConsidering":"Available Considering","common.availableDespite":"Available Despite","common.availableDown":"Available Down","common.availableExcept":"Available Except","common.availableInto":"Available Into","common.availableLike":"Available Like","common.availableMinus":"Available Minus","common.availableNear":"Available Near","common.availableOf":"Available Of","common.availableOff":"Available Off","common.availableOnto":"Available Onto","common.availableOut":"Available Out","common.availableOver":"Available Over","common.availablePast":"Available Past","common.availablePer":"Available Per","common.availablePlus":"Available Plus","common.availableRegarding":"Available Regarding","common.availableRound":"Available Round","common.availableSave":"Available Save","common.availableThan":"Available Than","common.availableThroughout":"Available Throughout","common.availableToward":"Available Toward","common.availableTowards":"Available Towards","common.availableUnder":"Available Under","common.availableUnderneath":"Available Underneath","common.availableUnlike":"Available Unlike","common.availableUp":"Available Up","common.availableUpon":"Available Upon","common.availableVersus":"Available Versus","common.availableWorth":"Available Worth","settings.title":"Settings","settings.posSettings":"POS Settings","settings.configure":"Configure your point of sale system","settings.searchSettings":"Search settings...","settings.noSettingsFound":"No settings found matching","settings.saveSettings":"Save Settings","settings.saving":"Saving...","settings.general":"General","settings.pricing":"Pricing & Discounts","settings.receipt":"Receipts","settings.notifications":"Notifications","settings.features":"Features","settings.permissions":"Users & Permissions","general.businessInfo":"Business Information","general.businessInfoHelp":"Enter your business details that will appear on receipts, invoices, and other documents.","general.businessName":"Business Name","general.businessPhone":"Business Phone","general.businessEmail":"Business Email","general.businessWebsite":"Business Website","general.businessAddress":"Business Address","general.uploadLogo":"Upload Logo","general.changeLogo":"Change","general.uploading":"Uploading...","interface.title":"Interface Settings","interface.help":"Control the visual appearance and language settings of your POS system.","interface.theme":"Theme","interface.light":"Light","interface.dark":"Dark","interface.auto":"Auto","interface.language":"Language","interface.english":"English","interface.swahili":"Swahili","interface.french":"French","interface.fontSize":"Font Size","interface.tiny":"Tiny","interface.extraSmall":"Extra Small","interface.small":"Small","interface.medium":"Medium","interface.large":"Large","interface.currency":"Currency","interface.dateFormat":"Date Format","interface.timeFormat":"Time Format","interface.12hour":"12-hour","interface.24hour":"24-hour"},sw:{"common.save":"Save","common.cancel":"Cancel","common.delete":"Delete","common.edit":"Edit","common.add":"Ongeza","common.search":"Tafuta","common.filter":"Filter","common.clear":"Clear","common.loading":"Inapakia...","common.error":"Kuna tatizo","common.success":"Imefanikiwa","common.warning":"Angalia","common.info":"Info","common.yes":"Ndiyo","common.no":"Hapana","common.ok":"Sawa","common.close":"Funga","common.back":"Rudi","common.next":"Next","common.previous":"Previous","common.submit":"Submit","common.reset":"Reset","common.refresh":"Refresh","common.export":"Export","common.import":"Import","common.download":"Download","common.upload":"Upload","common.print":"Print","common.copy":"Copy","common.paste":"Paste","common.select":"Chagua","common.selectAll":"Chagua Zote","common.deselectAll":"Ondoa Zote","common.actions":"Actions","common.status":"Status","common.date":"Tarehe","common.time":"Saa","common.quantity":"Idadi","common.price":"Bei","common.total":"Jumla","common.subtotal":"Jumla Ndogo","common.tax":"Tax","common.discount":"Discount","common.amount":"Kiasi","common.currency":"Currency","common.percentage":"Percent","common.unit":"Unit","common.units":"Units","common.item":"Item","common.items":"Items","common.product":"Bidhaa","common.products":"Bidhaa","common.category":"Category","common.categories":"Categories","common.supplier":"Supplier","common.suppliers":"Suppliers","common.customer":"Customer","common.customers":"Customers","common.order":"Order","common.orders":"Orders","common.sale":"Sale","common.sales":"Sales","common.invoice":"Invoice","common.invoices":"Invoices","common.receipt":"Receipt","common.receipts":"Receipts","common.payment":"Payment","common.payments":"Payments","common.stock":"Stock","common.inventory":"Inventory","common.warehouse":"Store","common.warehouses":"Stores","common.location":"Mahali","common.locations":"Mahali","common.sku":"SKU","common.barcode":"Barcode","common.description":"Maelezo","common.notes":"Notes","common.remarks":"Remarks","common.reason":"Sababu","common.reference":"Marejeleo","common.created":"Iliundwa","common.updated":"Iliyosasishwa","common.createdBy":"Iliundwa na","common.updatedBy":"Iliyosasishwa na","common.createdAt":"Iliundwa saa","common.updatedAt":"Iliyosasishwa saa","common.active":"Inatumika","common.inactive":"Haifanyi kazi","common.enabled":"Imeamilishwa","common.disabled":"Imezuiwa","common.visible":"Inaonekana","common.hidden":"Imejificha","common.public":"Ya umma","common.private":"Ya kibinafsi","common.draft":"Rasimu","common.published":"Imechapishwa","common.archived":"Imehifadhiwa","common.deleted":"Imeondolewa","common.pending":"Inasubiri","common.approved":"Imekubaliwa","common.rejected":"Imekataliwa","common.completed":"Imekamilika","common.cancelled":"Imeghairiwa","common.failed":"Imeshindwa","common.successful":"Imefanikiwa","common.unsuccessful":"Haijafanikiwa","common.available":"Inapatikana","common.unavailable":"Haipatikani","common.inStock":"Iko kwenye hifadhi","common.outOfStock":"Haiko kwenye hifadhi","common.lowStock":"Hifadhi ndogo","common.overStock":"Hifadhi kubwa","common.zeroStock":"Hifadhi sifuri","common.negativeStock":"Hifadhi hasi","common.positiveStock":"Hifadhi chanya","common.stockLevel":"Kiwango cha hifadhi","common.minimumStock":"Hifadhi ya chini","common.maximumStock":"Hifadhi ya juu","common.reorderPoint":"Hatua ya kuagiza tena","common.reorderQuantity":"Kiasi cha kuagiza tena","common.leadTime":"Muda wa kuongoza","common.supplierLeadTime":"Muda wa kuongoza wa mtoaji","common.customerLeadTime":"Muda wa kuongoza wa mteja","common.processingTime":"Muda wa kusindika","common.deliveryTime":"Muda wa kusambaza","common.shippingTime":"Muda wa kusafirisha","common.returnTime":"Muda wa kurudi","common.refundTime":"Muda wa kurudisha pesa","common.exchangeTime":"Muda wa kubadilisha","common.warrantyTime":"Muda wa dhamana","common.guaranteeTime":"Muda wa uhakikisho","common.expiryTime":"Muda wa kumalizika","common.validityTime":"Muda wa uhalali","common.effectiveTime":"Muda wa kufanya kazi","common.expirationTime":"Muda wa kumalizika","common.startTime":"Muda wa kuanza","common.endTime":"Muda wa kumaliza","common.beginTime":"Muda wa kuanza","common.finishTime":"Muda wa kumaliza","common.openTime":"Muda wa kufungua","common.closeTime":"Muda wa kufunga","common.businessHours":"Masaa ya biashara","common.workingHours":"Masaa ya kufanya kazi","common.officeHours":"Masaa ya ofisi","common.storeHours":"Masaa ya duka","common.serviceHours":"Masaa ya huduma","common.supportHours":"Masaa ya msaada","common.helpHours":"Masaa ya msaada","common.contactHours":"Masaa ya mawasiliano","common.availability":"Upatikanaji","common.availableFrom":"Inapatikana kutoka","common.availableTo":"Inapatikana hadi","common.availableUntil":"Inapatikana hadi","common.availableSince":"Inapatikana tangu","common.availableFor":"Inapatikana kwa","common.availableIn":"Inapatikana katika","common.availableAt":"Inapatikana saa","common.availableOn":"Inapatikana kwenye","common.availableBy":"Inapatikana na","common.availableThrough":"Inapatikana kupitia","common.availableVia":"Inapatikana kupitia","common.availableWith":"Inapatikana na","common.availableWithout":"Inapatikana bila","common.availableWithin":"Inapatikana ndani ya","common.availableOutside":"Inapatikana nje ya","common.availableInside":"Inapatikana ndani ya","common.availableAbove":"Inapatikana juu ya","common.availableBelow":"Inapatikana chini ya","common.availableBefore":"Inapatikana kabla ya","common.availableAfter":"Inapatikana baada ya","common.availableDuring":"Inapatikana wakati wa","common.availableBetween":"Inapatikana kati ya","common.availableAmong":"Inapatikana miongoni mwa","common.availableAmongst":"Inapatikana miongoni mwa","common.availableAcross":"Inapatikana kote","common.availableAlong":"Inapatikana pamoja na","common.availableAround":"Inapatikana karibu na","common.availableAbout":"Inapatikana kuhusu","common.availableAgainst":"Inapatikana dhidi ya","common.availableAlongside":"Inapatikana pamoja na","common.availableAmid":"Inapatikana kati ya","common.availableAmidst":"Inapatikana kati ya","common.availableAs":"Inapatikana kama","common.availableBehind":"Inapatikana nyuma ya","common.availableBeneath":"Inapatikana chini ya","common.availableBeside":"Inapatikana kando ya","common.availableBesides":"Inapatikana kando ya","common.availableBeyond":"Inapatikana zaidi ya","common.availableConcerning":"Inapatikana kuhusu","common.availableConsidering":"Inapatikana kwa kuzingatia","common.availableDespite":"Inapatikana licha ya","common.availableDown":"Inapatikana chini","common.availableExcept":"Inapatikana isipokuwa","common.availableInto":"Inapatikana ndani ya","common.availableLike":"Inapatikana kama","common.availableMinus":"Inapatikana toa","common.availableNear":"Inapatikana karibu na","common.availableOf":"Inapatikana ya","common.availableOff":"Inapatikana mbali na","common.availableOnto":"Inapatikana kwenye","common.availableOut":"Inapatikana nje","common.availableOver":"Inapatikana juu ya","common.availablePast":"Inapatikana zaidi ya","common.availablePer":"Inapatikana kwa","common.availablePlus":"Inapatikana pamoja na","common.availableRegarding":"Inapatikana kuhusu","common.availableRound":"Inapatikana kuzunguka","common.availableSave":"Inapatikana isipokuwa","common.availableThan":"Inapatikana kuliko","common.availableThroughout":"Inapatikana kote","common.availableToward":"Inapatikana kuelekea","common.availableTowards":"Inapatikana kuelekea","common.availableUnder":"Inapatikana chini ya","common.availableUnderneath":"Inapatikana chini ya","common.availableUnlike":"Inapatikana tofauti na","common.availableUp":"Inapatikana juu","common.availableUpon":"Inapatikana juu ya","common.availableVersus":"Inapatikana dhidi ya","common.availableWorth":"Inapatikana thamani ya","settings.title":"Settings","settings.posSettings":"POS Settings","settings.configure":"Weka settings za duka lako","settings.searchSettings":"Tafuta settings...","settings.noSettingsFound":"Hakuna settings","settings.saveSettings":"Save","settings.saving":"Inahifadhi...","settings.general":"General","settings.pricing":"Bei na Discounts","settings.receipt":"Receipt","settings.notifications":"Notifications","settings.features":"Features","settings.permissions":"Users na Permissions","general.businessInfo":"Taarifa za Duka","general.businessInfoHelp":"Weka jina la duka na taarifa zote hapa.","general.businessName":"Jina la Duka","general.businessPhone":"Namba ya Simu","general.businessEmail":"Email","general.businessWebsite":"Website","general.businessAddress":"Address ya Duka","general.uploadLogo":"Weka Logo","general.changeLogo":"Badilisha","general.uploading":"Inapakia...","interface.title":"Display Settings","interface.help":"Badilisha muonekano wa screen yako.","interface.theme":"Rangi","interface.light":"Mwangaza","interface.dark":"Dark","interface.auto":"Auto","interface.language":"Lugha","interface.english":"English","interface.swahili":"Swahili","interface.french":"French","interface.fontSize":"Size ya Maneno","interface.tiny":"Ndogo Sana","interface.extraSmall":"Ndogo Kidogo","interface.small":"Ndogo","interface.medium":"Wastani","interface.large":"Kubwa","interface.currency":"Currency","interface.dateFormat":"Format ya Tarehe","interface.timeFormat":"Format ya Saa","interface.12hour":"12 Saa","interface.24hour":"24 Saa","features.delivery":"Delivery","features.loyalty":"Loyalty Program","features.customerProfiles":"Customer Profiles","features.paymentTracking":"Payment Tracking","features.dynamicPricing":"Dynamic Pricing","features.enable":"Enable","features.disable":"Disable","receipt.template":"Receipt Template","receipt.logo":"Logo","receipt.showLogo":"Show Logo","receipt.businessInfo":"Business Info","receipt.items":"Items","receipt.totals":"Totals","receipt.footerMessage":"Footer Message","receipt.autoprint":"Auto Print","notifications.whatsapp":"WhatsApp","notifications.sms":"SMS","notifications.email":"Email","notifications.autoSend":"Auto Send","notifications.enabled":"Enabled","notifications.message":"Message","notifications.template":"Template"}};let lc="en";const dc=new Set;function uc(e){lc!==e&&(lc=e,dc.forEach(e=>e()))}function mc(){return lc}function hc(e){return dc.add(e),()=>{dc.delete(e)}}function pc(e,t){let a=(cc[lc]||cc.en)[e]||e;return t&&Object.entries(t).forEach(([e,t])=>{a=a.replace(new RegExp(`{${e}}`,"g"),String(t))}),a}const gc=e.createContext(void 0),_c=()=>{const t=e.useContext(gc);if(!t)throw new Error("useGeneralSettingsContext must be used within a GeneralSettingsProvider");return t},fc=({children:t})=>{let a;try{a=bn()}catch(w){return $.jsx(gc.Provider,{value:{settings:null,loading:!1,error:null,applyTheme:()=>{},applyLanguage:()=>{},applyCurrency:()=>{},applyTimezone:()=>{},formatCurrency:e=>`$${e.toFixed(2)}`,formatDate:e=>e.toLocaleDateString(),formatTime:e=>e.toLocaleTimeString(),showProductImages:!0,showStockLevels:!0,showPrices:!0,showBarcodes:!0,productsPerPage:20,productsPerRow:4,autoCompleteSearch:!0,confirmDelete:!0,showConfirmations:!0,enableSoundEffects:!0,enableAnimations:!0,refreshSettings:async()=>{}},children:t})}const{isAuthenticated:r}=a,{settings:s,loading:n,error:i,saveSettings:o,updateSettings:c,loadSettings:l,refreshSettings:d}=tc(),[u,m]=e.useState(null),h=e=>{const t=document.documentElement;if("auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.toggle("dark",e)}else t.classList.toggle("dark","dark"===e);localStorage.setItem("theme",e)},p=e=>{document.documentElement.lang=e,localStorage.setItem("language",e),uc(e)},g=e=>{localStorage.setItem("currency",e)},_=e=>{localStorage.setItem("timezone",e)},f=e=>{const t=document.documentElement;switch(e){case"tiny":t.style.fontSize="11px";break;case"extra-small":t.style.fontSize="12px";break;case"small":t.style.fontSize="14px";break;case"medium":t.style.fontSize="16px";break;case"large":t.style.fontSize="18px"}localStorage.setItem("fontSize",e)},y=e=>{h(e.theme),p(e.language),g(e.currency),_(e.timezone),e.font_size&&f(e.font_size),(e=>{const t=document.documentElement;t.style.setProperty("--show-product-images",e.show_product_images?"block":"none"),t.style.setProperty("--show-stock-levels",e.show_stock_levels?"block":"none"),t.style.setProperty("--show-prices",e.show_prices?"block":"none"),t.style.setProperty("--show-barcodes",e.show_barcodes?"block":"none")})(e),(e=>{const t=document.documentElement;localStorage.setItem("autoCompleteSearch",e.auto_complete_search.toString()),localStorage.setItem("confirmDelete",e.confirm_delete.toString()),localStorage.setItem("showConfirmations",e.show_confirmations.toString()),localStorage.setItem("enableSoundEffects",e.enable_sound_effects.toString()),localStorage.setItem("enableAnimations",e.enable_animations.toString()),t.setAttribute("data-enable-animations",e.enable_animations.toString()),t.setAttribute("data-enable-sounds",e.enable_sound_effects.toString()),t.setAttribute("data-auto-complete",e.auto_complete_search.toString()),t.setAttribute("data-confirm-delete",e.confirm_delete.toString()),t.setAttribute("data-show-confirmations",e.show_confirmations.toString()),e.enable_animations?document.body.classList.remove("animations-disabled"):document.body.classList.add("animations-disabled")})(e),(e=>{localStorage.setItem("enableCaching",e.enable_caching.toString()),localStorage.setItem("cacheDuration",e.cache_duration.toString()),localStorage.setItem("enableLazyLoading",e.enable_lazy_loading.toString()),localStorage.setItem("maxSearchResults",e.max_search_results.toString())})(e)};if(e.useEffect(()=>{s&&(m(s),y(s))},[s]),e.useEffect(()=>{const e=localStorage.getItem("fontSize");e&&f(e);const t=localStorage.getItem("language");t&&uc(t)},[]),e.useEffect(()=>{const e=e=>{"general"===e.detail.type&&l()},t=e=>{"general"===e.detail.type&&e.detail.settings&&(m(e.detail.settings),y(e.detail.settings))},a=e=>{"general"===e.detail.type&&e.detail.settings&&(m(e.detail.settings),y(e.detail.settings))};return window.addEventListener("settingsUpdated",e),window.addEventListener("settingsSaved",t),window.addEventListener("posSettingsLoaded",a),()=>{window.removeEventListener("settingsUpdated",e),window.removeEventListener("settingsSaved",t),window.removeEventListener("posSettingsLoaded",a)}},[l]),!r)return $.jsx(gc.Provider,{value:{settings:null,loading:!0,error:null,applyTheme:()=>{},applyLanguage:()=>{},applyCurrency:()=>{},applyTimezone:()=>{},formatCurrency:e=>e.toString(),formatDate:e=>e.toLocaleDateString(),formatTime:e=>e.toLocaleTimeString(),showProductImages:!0,showStockLevels:!0,showPrices:!0,showBarcodes:!0,productsPerPage:20,productsPerRow:4,autoCompleteSearch:!0,confirmDelete:!0,showConfirmations:!0,enableSoundEffects:!0,enableAnimations:!0,refreshSettings:async()=>{}},children:t});const v={settings:u,loading:n,error:i,applyTheme:h,applyLanguage:p,applyCurrency:g,applyTimezone:_,formatCurrency:e=>{const t=(null==u?void 0:u.currency)||"TZS",a="sw"===(null==u?void 0:u.language)?"sw-TZ":"en-TZ";return new Intl.NumberFormat(a,{style:"currency",currency:t,minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},formatDate:e=>{null==u||u.date_format;const t="sw"===(null==u?void 0:u.language)?"sw-TZ":"en-TZ";return new Intl.DateTimeFormat(t,{year:"numeric",month:"2-digit",day:"2-digit"}).format(e)},formatTime:e=>{const t=(null==u?void 0:u.time_format)||"24",a="sw"===(null==u?void 0:u.language)?"sw-TZ":"en-TZ",r={hour:"2-digit",minute:"2-digit",hour12:"12"===t};return new Intl.DateTimeFormat(a,r).format(e)},showProductImages:(null==u?void 0:u.show_product_images)??!0,showStockLevels:(null==u?void 0:u.show_stock_levels)??!0,showPrices:(null==u?void 0:u.show_prices)??!0,showBarcodes:(null==u?void 0:u.show_barcodes)??!0,productsPerPage:(null==u?void 0:u.products_per_page)??20,productsPerRow:(null==u?void 0:u.products_per_row)??4,autoCompleteSearch:(null==u?void 0:u.auto_complete_search)??!0,confirmDelete:(null==u?void 0:u.confirm_delete)??!0,showConfirmations:(null==u?void 0:u.show_confirmations)??!0,enableSoundEffects:(null==u?void 0:u.enable_sound_effects)??!0,enableAnimations:(null==u?void 0:u.enable_animations)??!0,refreshSettings:d};return $.jsx(gc.Provider,{value:v,children:t})};const yc=new class{constructor(){this.supabase=$a}async getPaymentMethods(){try{const e=await async function(e=3e4){return fo("payment-methods",async()=>{const{data:e,error:t}=await $a.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0).order("name",{ascending:!0});if(t)throw t;return e||[]},e)}();return e&&e.length,e||[]}catch(iu){return[]}}async getActiveFinanceAccounts(){try{const{data:e,error:t}=await $a.from("finance_accounts").select("*").eq("is_active",!0).order("name");if(t)throw t;return e||[]}catch(iu){return[]}}async getFinanceAccountsByType(e){try{const{data:t,error:a}=await $a.from("finance_accounts").select("*").eq("type",e).eq("is_active",!0).order("name");if(a)throw a;return t||[]}catch(iu){return[]}}async getFinanceAccountById(e){try{const{data:t,error:a}=await $a.from("finance_accounts").select("*").eq("id",e).eq("is_active",!0).single();if(a)throw a;return t}catch(iu){return null}}async getFinanceAccountsWithStats(){try{const{data:e,error:t}=await $a.from("finance_accounts").select("\n          *,\n          payment_transactions(\n            id\n          )\n        ").eq("is_active",!0).order("name");if(t)throw t;return(null==e?void 0:e.map(e=>{var t,a;return{...e,transaction_count:(null==(t=e.payment_transactions)?void 0:t.length)||0,total_transactions:(null==(a=e.payment_transactions)?void 0:a.length)||0}}))||[]}catch(iu){return[]}}async getDefaultPaymentMethod(){try{const{data:e,error:t}=await $a.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0).eq("type","cash").order("created_at",{ascending:!0}).limit(1).single();if(t)throw t;return e}catch(iu){return null}}async getPOSPaymentMethods(){try{const{data:e,error:t}=await $a.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0).in("type",["cash","mobile_money","credit_card"]).order("name");if(t)throw t;return e||[]}catch(iu){return[]}}async getFinancePaymentMethods(){try{const{data:e,error:t}=await $a.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0).in("type",["bank","savings","investment"]).order("name");if(t)throw t;return e||[]}catch(iu){return[]}}async createFinanceAccount(e){try{const{data:t,error:a}=await $a.from("finance_accounts").insert([e]).select().single();if(a)throw a;return t}catch(iu){return null}}async testUpdateField(e,t,a){try{const{data:r,error:s}=await $a.from("finance_accounts").update({[t]:a}).eq("id",e).select("*").single();return s?null:r}catch(iu){return null}}async updateFinanceAccount(e,t){var a,r,s,n,i;try{const{data:{user:o},error:c}=await $a.auth.getUser(),{data:l,error:d}=await $a.from("finance_accounts").update(t).eq("id",e).select("*").single();if(d)throw null==(a=d.message)||a.includes("column"),null==(r=d.message)||r.includes("type"),null==(s=d.message)||s.includes("constraint"),(null==(n=d.message)?void 0:n.includes("permission"))||null==(i=d.message)||i.includes("policy"),d;return l}catch(iu){Error;try{JSON.parse(iu.message)}catch(o){}return null}}async deleteFinanceAccount(e){try{const{error:t}=await $a.from("finance_accounts").delete().eq("id",e);if(t)throw t;return!0}catch(iu){return!1}}async getFinanceAccountStats(){try{const e=await this.getActiveFinanceAccounts();return{total:e.length,byType:e.reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{}),active:e.filter(e=>e.is_active).length,totalBalance:e.reduce((e,t)=>e+Number(t.balance),0),paymentMethods:e.filter(e=>e.is_payment_method).length}}catch(iu){return{total:0,byType:{},active:0,totalBalance:0,paymentMethods:0}}}getIconForAccountType(e){switch(e){case"bank":return"building";case"cash":return"dollar-sign";case"mobile_money":return"smartphone";case"credit_card":default:return"credit-card";case"savings":return"piggy-bank";case"investment":return"trending-up"}}getColorForAccountType(e){switch(e){case"bank":return"#059669";case"cash":case"investment":return"#10B981";case"mobile_money":return"#DC2626";case"credit_card":default:return"#3B82F6";case"savings":return"#F59E0B"}}},vc=Object.freeze(Object.defineProperty({__proto__:null,financeAccountService:yc},Symbol.toStringTag,{value:"Module"})),wc=e.createContext(void 0),bc=()=>{const t=e.useContext(wc);return t||{paymentMethods:[],loading:!1,error:null,refreshPaymentMethods:async()=>{},getPaymentMethodById:()=>{},getPaymentMethodsByType:()=>[]}},Sc=({children:t})=>{const[a,r]=e.useState([]),[s,n]=e.useState(!0),[i,o]=e.useState(null),[c,l]=e.useState(!1),d=e.useCallback(async()=>{var e,t,a,s;try{n(!0),o(null);const e=await yc.getPaymentMethods();r(e)}catch(i){const n=(null==(e=null==i?void 0:i.message)?void 0:e.includes("ERR_CONNECTION_CLOSED"))||(null==(t=null==i?void 0:i.message)?void 0:t.includes("Failed to fetch"))?"Connection issue. Using cached data.":"Failed to fetch payment methods";o(n),(null==(a=null==i?void 0:i.message)?void 0:a.includes("ERR_CONNECTION_CLOSED"))||(null==(s=null==i?void 0:i.message)?void 0:s.includes("Failed to fetch"))||r([])}finally{n(!1)}},[]),u=e.useCallback(e=>a.find(t=>t.id===e),[a]),h=e.useCallback(e=>a.filter(t=>t.type===e),[a]);e.useEffect(()=>{d()},[d]),e.useEffect(()=>{let e,t=0;let a=!1,r=!1,s=0;let n;const i=()=>{if(c)return;const o=Date.now();if(!(r||o-s<3e3))try{if(r=!0,s=o,e)try{e.unsubscribe()}catch(u){}e=yc.supabase.channel("payment_methods_changes").on("postgres_changes",{event:"*",schema:"public",table:"finance_accounts",filter:"is_payment_method=eq.true"},e=>{clearTimeout(n),n=setTimeout(()=>{d()},2e3)}).subscribe(e=>{if(r=!1,"SUBSCRIBED"===e)t=0,a=!0;else if("CLOSED"===e||"CHANNEL_ERROR"===e)if(a=!1,t<3){t++;const e=Math.min(5e3*Math.pow(1.5,t-1),3e4);setTimeout(()=>{a||r||i()},e)}else l(!0),m.error("Payment methods subscription disabled. Data will refresh manually.")})}catch(h){if(a=!1,r=!1,t<3){t++;const e=Math.min(5e3*Math.pow(1.5,t-1),3e4);setTimeout(()=>{a||r||i()},e)}else l(!0)}},o=setTimeout(()=>{i()},2e3);return()=>{if(clearTimeout(o),clearTimeout(undefined),clearTimeout(n),a=!1,r=!1,e)try{e.unsubscribe()}catch(t){}}},[d,c]);const p={paymentMethods:a,loading:s,error:i,refreshPaymentMethods:d,getPaymentMethodById:u,getPaymentMethodsByType:h};return $.jsx(wc.Provider,{value:p,children:t})},xc=e.createContext(void 0),kc=()=>{const t=e.useContext(xc);if(!t)throw new Error("useError must be used within an ErrorProvider");return t},Ec=({children:t,maxErrors:a=50})=>{const[r,s]=e.useState([]),[n,i]=e.useState(null),[o,c]=e.useState(!1),[l,d]=e.useState(!1),u=e.useCallback(e=>{var t;const r=`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n={id:r,title:e.title||"An error occurred",message:e.message||"An unexpected error occurred",code:e.code,type:e.type||"unknown",severity:e.severity||"medium",timestamp:new Date,context:e.context,stack:e.stack,fixSuggestions:e.fixSuggestions||[],technicalDetails:e.technicalDetails,affectedFeature:e.affectedFeature};s(e=>[n,...e].slice(0,a)),i(n),"high"!==n.severity&&"critical"!==n.severity||c(!0);const o=`${n.title}: ${n.message}`;return"critical"===n.severity?m.error(o,{duration:6e3}):"high"===n.severity?m.error(o,{duration:4e3}):"medium"===n.severity?m.error(o,{duration:3e3}):m(o,{duration:2e3}),null==(t=n.fixSuggestions)||t.length,r},[a]),h=e.useCallback(e=>{s(t=>t.filter(t=>t.id!==e)),i(t=>(null==t?void 0:t.id)===e?null:t)},[]),p=e.useCallback(()=>{s([]),i(null),c(!1)},[]),g=e.useCallback(e=>r.filter(t=>t.type===e),[r]),_={errors:r,currentError:n,addError:u,removeError:h,clearErrors:p,getErrorsByType:g,showErrorPanel:o,setShowErrorPanel:c,showDiagnostics:l,setShowDiagnostics:d};return $.jsx(xc.Provider,{value:_,children:t})},Ic=e.createContext(void 0),Ac=()=>{const t=e.useContext(Ic);if(!t)throw new Error("useGlobalSearchModal must be used within a GlobalSearchProvider");return t},Pc=({children:t})=>{const[a,r]=e.useState(!1),[s,n]=e.useState(""),i=e.useCallback((e="")=>{n(e),r(!0)},[]),o=e.useCallback(()=>{r(!1),n("")},[]);return $.jsx(Ic.Provider,{value:{isOpen:a,initialQuery:s,openSearch:i,closeSearch:o},children:t})},Cc=({error:t,onClose:a,onRetry:r})=>{const{currentError:s,removeError:n,setShowErrorPanel:i}=kc(),[o,c]=e.useState(0),[l,d]=e.useState(!1),u=t||s;if(!u)return null;const b=()=>{a?a():(i(!1),n(u.id))};return $.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200",children:$.jsxs("div",{className:`\n          relative w-full max-w-3xl max-h-[90vh] overflow-hidden\n          bg-white rounded-2xl shadow-2xl border-2 \n          ${(e=>{switch(e){case"critical":return"border-red-500 bg-red-50";case"high":return"border-orange-500 bg-orange-50";case"medium":return"border-yellow-500 bg-yellow-50";case"low":return"border-blue-500 bg-blue-50";default:return"border-gray-500 bg-gray-50"}})(u.severity)}\n          animate-in slide-in-from-bottom duration-300\n        `,children:[$.jsx("div",{className:"sticky top-0 z-10 bg-white border-b px-6 py-4",children:$.jsxs("div",{className:"flex items-start justify-between gap-4",children:[$.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[(e=>{switch(e){case"critical":return $.jsx(x,{className:"w-6 h-6 text-red-600"});case"high":return $.jsx(E,{className:"w-6 h-6 text-orange-600"});case"medium":return $.jsx(x,{className:"w-6 h-6 text-yellow-600"});case"low":return $.jsx(k,{className:"w-6 h-6 text-blue-600"});default:return $.jsx(x,{className:"w-6 h-6 text-gray-600"})}})(u.severity),$.jsxs("div",{className:"flex-1",children:[$.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[$.jsx("h2",{className:"text-xl font-bold text-gray-900",children:u.title}),u.code&&$.jsx("span",{className:"px-2 py-0.5 text-xs font-mono font-semibold bg-gray-200 text-gray-700 rounded",children:u.code})]}),$.jsx("p",{className:"text-sm text-gray-600",children:(S=u.type,{database:"Database Error",network:"Network Error",validation:"Validation Error",auth:"Authentication Error",api:"API Error",unknown:"Error"}[S]||"Error")})]})]}),$.jsx("button",{onClick:b,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Close",children:$.jsx(h,{className:"w-5 h-5 text-gray-500"})})]})}),$.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-140px)] px-6 py-6",children:[$.jsxs("div",{className:"mb-6 p-4 bg-white rounded-lg border border-gray-200 shadow-sm",children:[$.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-2",children:"What happened?"}),$.jsx("p",{className:"text-gray-900",children:u.message}),u.context&&$.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[$.jsx("span",{className:"font-medium",children:"Context:"})," ",u.context]})]}),u.fixSuggestions&&u.fixSuggestions.length>0&&$.jsxs("div",{className:"mb-6",children:[$.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-3 flex items-center gap-2",children:[$.jsx(p,{className:"w-5 h-5 text-yellow-500"}),"How to fix this"]}),$.jsx("div",{className:"space-y-3",children:u.fixSuggestions.map((e,t)=>$.jsx(Tc,{suggestion:e,index:t,isExpanded:o===t,onToggle:()=>c(o===t?null:t)},t))})]}),u.technicalDetails&&$.jsxs("div",{className:"mb-4",children:[$.jsxs("button",{onClick:()=>d(!l),className:"flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors",children:[$.jsx(g,{className:"w-4 h-4"}),"Technical Details",l?$.jsx(_,{className:"w-4 h-4"}):$.jsx(f,{className:"w-4 h-4"})]}),l&&$.jsxs("div",{className:"mt-3 p-4 bg-gray-900 rounded-lg overflow-x-auto",children:[$.jsx("pre",{className:"text-xs text-gray-100 font-mono",children:JSON.stringify(u.technicalDetails,null,2)}),$.jsxs("button",{onClick:()=>((e,t="text")=>{navigator.clipboard.writeText(e),m.success(`${t} copied to clipboard!`)})(JSON.stringify(u.technicalDetails,null,2),"Technical details"),className:"mt-2 px-3 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-white rounded flex items-center gap-1",children:[$.jsx(y,{className:"w-3 h-3"}),"Copy"]})]})]}),u.stack&&$.jsx("div",{className:"mb-4",children:$.jsxs("details",{className:"group",children:[$.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900 flex items-center gap-2",children:[$.jsx(g,{className:"w-4 h-4"}),"Stack Trace",$.jsx(f,{className:"w-4 h-4 group-open:rotate-180 transition-transform"})]}),$.jsx("div",{className:"mt-3 p-4 bg-gray-900 rounded-lg overflow-x-auto",children:$.jsx("pre",{className:"text-xs text-gray-100 font-mono whitespace-pre-wrap",children:u.stack})})]})}),$.jsxs("div",{className:"text-xs text-gray-500",children:["Error occurred at: ",new Date(u.timestamp).toLocaleString()]})]}),$.jsxs("div",{className:"sticky bottom-0 z-10 bg-white border-t px-6 py-4 flex gap-3",children:[r&&$.jsxs("button",{onClick:()=>{r(),b()},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center gap-2 transition-colors",children:[$.jsx(v,{className:"w-4 h-4"}),"Retry"]}),$.jsx("button",{onClick:b,className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors",children:"Close"}),$.jsxs("a",{href:"https://www.postgresql.org/docs/current/errcodes-appendix.html",target:"_blank",rel:"noopener noreferrer",className:"ml-auto px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center gap-2 transition-colors",children:[$.jsx(w,{className:"w-4 h-4"}),"PostgreSQL Docs"]})]})]})});var S},Tc=({suggestion:t,index:a,isExpanded:r,onToggle:s})=>{const[n,i]=e.useState(!1);return $.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow",children:[$.jsxs("button",{onClick:s,className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[$.jsxs("div",{className:"flex items-center gap-3 text-left",children:[$.jsx("span",{className:"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-sm font-bold",children:a+1}),$.jsxs("div",{children:[$.jsx("h4",{className:"font-semibold text-gray-900",children:t.title}),$.jsx("p",{className:"text-sm text-gray-600",children:t.description})]})]}),$.jsxs("div",{className:"flex items-center gap-2",children:[t.autoFixAvailable&&$.jsx("span",{className:"px-2 py-1 text-xs bg-green-100 text-green-700 rounded font-medium",children:"Auto-fix"}),r?$.jsx(_,{className:"w-5 h-5 text-gray-400"}):$.jsx(f,{className:"w-5 h-5 text-gray-400"})]})]}),r&&$.jsxs("div",{className:"px-4 py-4 border-t border-gray-100 bg-gray-50",children:[$.jsxs("div",{className:"mb-4",children:[$.jsxs("h5",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[$.jsx(b,{className:"w-4 h-4"}),"Steps to fix:"]}),$.jsx("ol",{className:"space-y-2",children:t.steps.map((e,t)=>$.jsxs("li",{className:"flex gap-2 text-sm text-gray-700",children:[$.jsx("span",{className:"flex-shrink-0 w-5 h-5 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold",children:t+1}),$.jsx("span",{children:e})]},t))})]}),t.sqlFix&&$.jsxs("div",{className:"mb-4",children:[$.jsxs("h5",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[$.jsx(g,{className:"w-4 h-4"}),"SQL Fix:"]}),$.jsxs("div",{className:"relative",children:[$.jsx("pre",{className:"p-3 bg-gray-900 text-gray-100 rounded-lg text-xs font-mono overflow-x-auto",children:t.sqlFix}),$.jsx("button",{onClick:()=>{return e=t.sqlFix,navigator.clipboard.writeText(e),void m.success("SQL copied to clipboard!");var e},className:"absolute top-2 right-2 p-2 bg-gray-800 hover:bg-gray-700 rounded text-white transition-colors",title:"Copy SQL",children:$.jsx(y,{className:"w-3 h-3"})})]})]}),t.autoFixAvailable&&t.onAutoFix&&$.jsx("button",{onClick:async()=>{if(t.onAutoFix){i(!0);try{await t.onAutoFix(),m.success("Auto-fix applied successfully!")}catch(iu){m.error("Auto-fix failed. Please apply manually.")}finally{i(!1)}}},disabled:n,className:"w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors",children:n?$.jsxs($.Fragment,{children:[$.jsx(v,{className:"w-4 h-4 animate-spin"}),"Applying fix..."]}):$.jsxs($.Fragment,{children:[$.jsx(S,{className:"w-4 h-4"}),"Apply Auto-fix"]})})]})]})},jc=()=>{const{showErrorPanel:e,currentError:t}=kc();return $.jsx($.Fragment,{children:e&&t&&$.jsx(Cc,{})})};async function Dc(e,t){try{const{count:a}=await $a.from(e).select("*",{count:"exact",head:!0}),{count:r}=await $a.from(e).select("*",{count:"exact",head:!0}).eq("branch_id",t),{count:s}=await $a.from(e).select("*",{count:"exact",head:!0}).neq("branch_id",t).not("branch_id","is",null),{count:n}=await $a.from(e).select("*",{count:"exact",head:!0}).is("branch_id",null),{data:i}=await $a.from(e).select("id, branch_id, name, created_at").neq("branch_id",t).not("branch_id","is",null).limit(100);return{table:e,totalRecords:a||0,currentBranchRecords:r||0,otherBranchRecords:s||0,unassignedRecords:n||0,recordsToCleanup:i||[]}}catch(iu){return{table:e,totalRecords:0,currentBranchRecords:0,otherBranchRecords:0,unassignedRecords:0,recordsToCleanup:[]}}}async function Rc(){const e=Io();if(!e)throw new Error("No branch selected. Please select a branch first.");const t=await Ao(e);if(!t)throw new Error("Branch settings not found");const a=["lats_products","customers","lats_suppliers","lats_categories"],r=[];for(const n of a){const t=await Dc(n,e);r.push(t)}const s=r.reduce((e,t)=>e+t.otherBranchRecords,0);return r.reduce((e,t)=>e+t.unassignedRecords,0),s>0&&t.data_isolation_mode,r}async function Lc(e,t,a){const r=[];let s=0;try{const{data:n,error:i}=await $a.from(e).select("id, branch_id").neq("branch_id",t).not("branch_id","is",null);if(i)return r.push(`Failed to fetch records: ${i.message}`),{success:!1,affected:0,errors:r};if(!n||0===n.length)return{success:!0,affected:0,errors:[]};if(a.dryRun)return{success:!0,affected:n.length,errors:[]};if("delete"===a.action){const t=n.map(e=>e.id),{error:a}=await $a.from(e).delete().in("id",t);if(a)return r.push(`Failed to delete records: ${a.message}`),{success:!1,affected:0,errors:r};s=t.length}else if("reassign"===a.action){const a=n.map(e=>e.id),{error:i}=await $a.from(e).update({branch_id:t}).in("id",a);if(i)return r.push(`Failed to reassign records: ${i.message}`),{success:!1,affected:0,errors:r};s=a.length}return{success:!0,affected:s,errors:[]}}catch(iu){return r.push(`Exception: ${iu.message}`),{success:!1,affected:0,errors:r}}}async function Oc(e){const t=Io();if(!t)throw new Error("No branch selected. Please select a branch first.");const a=await Ao(t);if(!a)throw new Error("Branch settings not found");if(a.data_isolation_mode,e.confirmationRequired&&!e.dryRun)return;const r=["lats_products","customers","lats_suppliers","lats_categories"];let s=0;const n=[];for(const i of r){const a=await Lc(i,t,e);s+=a.affected,n.push(...a.errors)}n.length>0&&n.forEach(e=>{})}"undefined"!=typeof window&&(window.analyzeBranchData=Rc,window.cleanupBranchData=Oc);const qc=({isVisible:t,jobs:a=[],onCancel:r,className:s=""})=>{const[n,i]=e.useState(!1),[o,c]=e.useState(0);if(e.useEffect(()=>{if(0===a.length)return void c(0);const e=a.reduce((e,t)=>e+t.progress,0)/a.length;c(Math.round(e))},[a]),!t)return null;const l=a.filter(e=>"completed"!==e.status&&"failed"!==e.status);return $.jsxs("div",{className:`fixed top-4 right-4 z-50 bg-white/95 backdrop-blur-md border border-white/20 rounded-lg shadow-xl p-4 min-w-80 ${s}`,children:[$.jsxs("div",{className:"flex items-center justify-between mb-3",children:[$.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{const e=a.some(e=>"failed"===e.status),t=a.length>0&&a.every(e=>"completed"===e.status),r=a.some(e=>"processing"===e.status),s=a.some(e=>"pending"===e.status);return e?$.jsx(P,{className:"w-5 h-5 text-red-500"}):t?$.jsx(S,{className:"w-5 h-5 text-green-500"}):r?$.jsx(A,{className:"w-5 h-5 animate-spin text-blue-500"}):s?$.jsx(I,{className:"w-5 h-5 text-yellow-500"}):$.jsx(A,{className:"w-5 h-5 animate-spin text-blue-500"})})(),$.jsxs("div",{className:"flex flex-col",children:[$.jsx("span",{className:`text-sm font-medium ${(()=>{const e=a.some(e=>"failed"===e.status),t=a.length>0&&a.every(e=>"completed"===e.status),r=a.some(e=>"processing"===e.status);return e?"text-red-600":t?"text-green-600":r?"text-blue-600":"text-yellow-600"})()}`,children:(()=>{const e=a.some(e=>"failed"===e.status),t=a.length>0&&a.every(e=>"completed"===e.status),r=a.some(e=>"processing"===e.status),s=a.some(e=>"pending"===e.status);return e?"Some operations failed":t?"All operations completed":r?"Processing...":s?"Queued for processing":"Loading..."})()}),a.length>0&&$.jsxs("span",{className:"text-xs text-gray-500",children:[a.length," operation",1!==a.length?"s":""]})]})]}),$.jsxs("div",{className:"flex items-center gap-2",children:[l.length>0&&r&&$.jsx("button",{onClick:()=>l.forEach(e=>r(e.id)),className:"text-xs text-gray-500 hover:text-red-500 transition-colors",children:"Cancel All"}),$.jsx("button",{onClick:()=>i(!n),className:"text-xs text-gray-500 hover:text-gray-700 transition-colors",children:n?"Hide":"Details"})]})]}),a.length>0&&$.jsxs("div",{className:"mb-3",children:[$.jsxs("div",{className:"flex items-center justify-between mb-1",children:[$.jsx("span",{className:"text-xs text-gray-600",children:"Overall Progress"}),$.jsxs("span",{className:"text-xs text-gray-600",children:[o,"%"]})]}),$.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:$.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-300",style:{width:`${o}%`}})})]}),n&&a.length>0&&$.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:a.map(e=>$.jsxs("div",{className:"border-t border-gray-200 pt-2",children:[$.jsxs("div",{className:"flex items-center justify-between mb-1",children:[$.jsx("span",{className:"text-xs font-medium text-gray-700 truncate",children:e.title}),$.jsxs("div",{className:"flex items-center gap-1",children:["pending"===e.status&&$.jsx(I,{className:"w-3 h-3 text-yellow-500"}),"processing"===e.status&&$.jsx(A,{className:"w-3 h-3 animate-spin text-blue-500"}),"completed"===e.status&&$.jsx(S,{className:"w-3 h-3 text-green-500"}),"failed"===e.status&&$.jsx(P,{className:"w-3 h-3 text-red-500"}),$.jsxs("span",{className:"text-xs text-gray-500",children:[e.progress,"%"]})]})]}),$.jsx("div",{className:"w-full h-1 bg-gray-200 rounded-full overflow-hidden",children:$.jsx("div",{className:"h-full rounded-full transition-all duration-300 "+("failed"===e.status?"bg-red-500":"completed"===e.status?"bg-green-500":"bg-blue-500"),style:{width:`${e.progress}%`}})}),e.error&&$.jsx("p",{className:"text-xs text-red-600 mt-1",children:e.error}),"pending"===e.status&&r&&$.jsx("button",{onClick:()=>r(e.id),className:"text-xs text-red-500 hover:text-red-700 mt-1",children:"Cancel"})]},e.id))}),a.length>0&&a.every(e=>"completed"===e.status)&&$.jsx("div",{className:"mt-2 text-xs text-green-600 text-center",children:"All operations completed successfully"})]})},Nc=({message:e="Loading page...",size:t="md",className:a=""})=>$.jsx("div",{className:`min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 ${a}`,children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"flex justify-center mb-4",children:$.jsx(A,{className:`${{sm:"h-6 w-6",md:"h-12 w-12",lg:"h-16 w-16"}[t]} text-blue-600 animate-spin`})}),$.jsx("p",{className:"text-gray-600 font-medium",children:e}),$.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Please wait while we load the page"})]})}),Mc=({children:e,onClick:t,type:a="button",variant:r="primary",size:s="md",disabled:n=!1,className:i="",icon:o,loading:c=!1})=>{const l=n||c?"opacity-50 cursor-not-allowed":"hover:shadow-lg active:scale-[0.98] focus:ring-2 focus:ring-white/30 hover:border-white/40 backdrop-blur-xl";return $.jsx("button",{type:a,onClick:t,disabled:n||c,className:`\n        flex items-center justify-center gap-2 backdrop-blur-md rounded-lg border transition-all duration-300\n        ${{primary:"bg-gradient-to-r from-blue-500/80 to-indigo-500/80 hover:from-blue-600/90 hover:to-indigo-600/90 text-white border-white/20",secondary:"bg-gradient-to-r from-purple-500/80 to-pink-500/80 hover:from-purple-600/90 hover:to-pink-600/90 text-white border-white/20",success:"bg-gradient-to-r from-emerald-500/80 to-green-500/80 hover:from-emerald-600/90 hover:to-green-600/90 text-white border-white/20",danger:"bg-gradient-to-r from-rose-500/80 to-red-500/80 hover:from-rose-600/90 hover:to-red-600/90 text-white border-white/20",warning:"bg-gradient-to-r from-amber-500/80 to-orange-500/80 hover:from-amber-600/90 hover:to-orange-600/90 text-white border-white/20",outline:"bg-transparent border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400",ghost:"bg-transparent text-gray-700 hover:bg-gray-100/50 border-transparent"}[r]}\n        ${{sm:"py-1 px-3 text-sm",md:"py-2 px-4 text-base",lg:"py-3 px-6 text-lg font-medium"}[s]}\n        ${l}\n        ${i}\n      `,children:c?$.jsxs($.Fragment,{children:[$.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[$.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),$.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Loading..."]}):$.jsxs($.Fragment,{children:[o&&$.jsx("span",{className:"mr-1",children:o}),e]})})},Uc=({children:e,className:t="",onClick:a})=>$.jsx("div",{className:`\n        backdrop-blur-xl rounded-xl \n        border shadow-lg \n        p-6 sm:p-8 transition-all duration-300 \n        hover:shadow-xl\n        ${a?"cursor-pointer active:scale-[0.98]":""}\n        ${t}\n      `,style:{backgroundColor:"var(--card-bg, rgba(255, 255, 255, 0.7))",borderColor:"var(--card-border, rgba(255, 255, 255, 0.3))",boxShadow:"var(--card-shadow, 0 4px 6px -1px rgba(0, 0, 0, 0.1))"},onClick:a,children:e});class Bc extends r.Component{constructor(e){super(e),this.handleRetry=()=>{const{maxRetries:e=3}=this.props,{retryCount:t}=this.state;t<e&&this.setState({hasError:!1,error:null,errorInfo:null,retryCount:t+1})},this.handleGoHome=()=>{window.location.href="/dashboard"},this.handleGoBack=()=>{window.history.back()},this.handleRefreshPage=()=>{window.location.reload()},this.handleReactRefreshError=()=>{"undefined"!=typeof window&&(sessionStorage.clear(),localStorage.removeItem("pos_setup_complete"),window.location.reload())},this.state={hasError:!1,error:null,errorInfo:null,retryCount:0}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){this.setState({errorInfo:t}),this.props.onError&&this.props.onError(e,t);e.message.includes("React Refresh")||e.message.includes("@react-refresh")||t.componentStack.includes("React Refresh")}render(){var e,t,a;const{hasError:s,error:n,errorInfo:i,retryCount:o}=this.state,{children:c,fallback:l,maxRetries:d=3}=this.props;if(s){if(l)return r.createElement(l,{error:n,errorInfo:i,retry:this.handleRetry});const s=(null==(e=null==n?void 0:n.message)?void 0:e.includes("React Refresh"))||(null==(t=null==n?void 0:n.message)?void 0:t.includes("@react-refresh"))||(null==(a=null==i?void 0:i.componentStack)?void 0:a.includes("React Refresh"));return $.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4",children:$.jsx(Uc,{className:"max-w-2xl w-full p-8",children:$.jsxs("div",{className:"text-center space-y-6",children:[$.jsx("div",{className:"flex justify-center",children:$.jsx("div",{className:"p-4 bg-red-100 rounded-full",children:$.jsx(x,{className:"w-12 h-12 text-red-600"})})}),$.jsxs("div",{children:[$.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:s?"Development Refresh Error":"Something went wrong"}),$.jsx("p",{className:"text-gray-600",children:s?"A refresh error occurred. This is usually temporary and can be resolved by refreshing the page.":"An unexpected error occurred. We're sorry for the inconvenience."}),s&&!1]}),n&&$.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-left",children:[$.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"Error Details:"}),$.jsx("p",{className:"text-sm text-red-600 font-mono mb-2",children:n.message}),i&&$.jsxs("details",{className:"text-sm text-gray-600",children:[$.jsx("summary",{className:"cursor-pointer hover:text-gray-800 mb-2",children:"Show technical details"}),$.jsx("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto max-h-32",children:i.componentStack})]})]}),o>0&&$.jsxs("div",{className:"text-sm text-gray-500",children:["Retry attempt ",o," of ",d]}),$.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[s?$.jsx(Mc,{onClick:this.handleRefreshPage,icon:$.jsx(v,{className:"w-4 h-4"}),className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Refresh Page"}):$.jsx(Mc,{onClick:this.handleRetry,disabled:o>=d,icon:$.jsx(v,{className:"w-4 h-4"}),className:"bg-blue-600 hover:bg-blue-700 text-white",children:o>=d?"Max Retries Reached":"Try Again"}),$.jsx(Mc,{onClick:this.handleGoBack,variant:"secondary",icon:$.jsx(C,{className:"w-4 h-4"}),children:"Go Back"}),$.jsx(Mc,{onClick:this.handleGoHome,variant:"secondary",icon:$.jsx(T,{className:"w-4 h-4"}),children:"Go Home"})]}),$.jsx("div",{className:"text-xs text-gray-500",children:"If this problem persists, please contact support with the error details above."})]})})})}return c}}class $c extends e.Component{constructor(e){super(e),this.handleRetry=()=>{this.setState({hasError:!1,error:void 0}),this.props.onRetry&&this.props.onRetry()},this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){}render(){return this.state.hasError?this.props.fallback?this.props.fallback:$.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:$.jsxs(Uc,{className:"max-w-md w-full text-center",children:[$.jsx(x,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),$.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Module Loading Error"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"Failed to load the requested page. This might be a temporary issue."}),$.jsxs("div",{className:"space-y-2",children:[$.jsx(Mc,{onClick:this.handleRetry,icon:$.jsx(v,{size:18}),className:"w-full",children:"Try Again"}),$.jsx(Mc,{onClick:()=>window.location.reload(),variant:"outline",className:"w-full",children:"Reload Page"})]}),!1]})}):this.props.children}}class Fc{static validateUrl(e){if(!e||"string"!=typeof e)return{isValid:!1,reason:"Invalid URL format",originalLength:0};const t=e.length;if(t>this.MAX_SAFE_URL_LENGTH)return{isValid:!1,reason:"URL too long for HTTP headers",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length};for(const a of this.PROBLEMATIC_PATTERNS)if(a.test(e))return{isValid:!1,reason:"URL contains problematic patterns (Base64 data)",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length};try{if(new URL(e,window.location.origin).pathname.length>this.MAX_SAFE_PATH_LENGTH)return{isValid:!1,reason:"URL path too long",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length}}catch(iu){return{isValid:!1,reason:"Invalid URL format",originalLength:t}}return{isValid:!0,originalLength:t}}static validateImageUrl(e){const t=Ns.sanitizeImageUrl(e);return{isValid:!t.isSanitized,sanitizedUrl:t.url,originalLength:t.originalLength,sanitizedLength:t.sanitizedLength,reason:t.isSanitized?"Image URL sanitized to prevent 431 error":void 0}}static isUrlSafeForNavigation(e){return this.validateUrl(e).isValid}static isUrlSafeForImages(e){return this.validateImageUrl(e).isValid}static generateSafeUrl(){return"/lats/unified-inventory"}static logUrlValidationIssue(e,t){t.isValid}static emergencyUrlCleanup(e){const t=this.validateUrl(e);return!t.isValid&&t.sanitizedUrl?t.sanitizedUrl:e}static getUrlStats(e){const t=[];let a=0,r=!1;try{a=new URL(e,window.location.origin).pathname.length}catch{t.push("Invalid URL format")}e.length>this.MAX_SAFE_URL_LENGTH&&t.push("URL too long"),a>this.MAX_SAFE_PATH_LENGTH&&t.push("Path too long");for(const s of this.PROBLEMATIC_PATTERNS)if(s.test(e)){r=!0,t.push("Contains problematic patterns");break}return{length:e.length,pathLength:a,hasProblematicPatterns:r,isTooLong:e.length>this.MAX_SAFE_URL_LENGTH,isSafe:0===t.length,issues:t}}}Fc.MAX_SAFE_URL_LENGTH=1500,Fc.MAX_SAFE_PATH_LENGTH=1e3,Fc.PROBLEMATIC_PATTERNS=[/data:image\/[^;]+;base64,/,/%[0-9A-Fa-f]{2,}/g,/[A-Za-z0-9+/]{100,}={0,2}/];const zc=({children:t,fallbackPath:a="/lats/unified-inventory",enableImageUrlValidation:r=!0,enableUrlLogging:s=!1})=>{const o=n(),c=i(),[l,d]=e.useState(!0),[u,m]=e.useState(null);return e.useEffect(()=>{(()=>{const e=o.pathname+o.search,t=Fc.validateUrl(e);if(!t.isValid)return m({isValid:!1,sanitizedUrl:t.sanitizedUrl,reason:t.reason}),void(t.sanitizedUrl?c(t.sanitizedUrl,{replace:!0}):c(a,{replace:!0}));if(r){const e=function(e){const t=/\/lats\/products\/([^\/]+)/,a=e.match(t);if(a){const e=a[1];if(/[A-Za-z0-9+/]{100,}={0,2}/.test(e))return{isValid:!1,sanitizedUrl:"/lats/unified-inventory",reason:"Product ID contains Base64 data"};if(e.length>100)return{isValid:!1,sanitizedUrl:"/lats/unified-inventory",reason:"Product ID too long"}}return{isValid:!0}}(o.pathname);if(!e.isValid)return m({isValid:!1,sanitizedUrl:e.sanitizedUrl,reason:e.reason}),void(e.sanitizedUrl?c(e.sanitizedUrl,{replace:!0}):c(a,{replace:!0}))}m({isValid:!0}),d(!1)})()},[o.pathname,o.search,c,a,r,s]),l?$.jsx("div",{className:"flex items-center justify-center min-h-screen",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),$.jsx("p",{className:"text-gray-600",children:"Validating URL..."})]})}):u&&!u.isValid?$.jsx("div",{className:"flex items-center justify-center min-h-screen",children:$.jsxs("div",{className:"text-center max-w-md mx-auto p-6 bg-white rounded-lg shadow-lg",children:[$.jsx("div",{className:"text-red-500 text-6xl mb-4",children:""}),$.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"URL Too Large"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"The URL you're trying to access is too large and could cause server errors."}),$.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Reason: ",u.reason]}),$.jsx("button",{onClick:()=>c(a),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"Go to Safe Page"})]})}):$.jsx($.Fragment,{children:t})};var Vc,Wc;(Wc=Vc||(Vc={})).Unimplemented="UNIMPLEMENTED",Wc.Unavailable="UNAVAILABLE";class Hc extends Error{constructor(e,t,a){super(e),this.message=e,this.code=t,this.data=a}}const Qc=e=>{const t=e.CapacitorCustomPlatform||null,a=e.Capacitor||{},r=a.Plugins=a.Plugins||{},s=()=>null!==t?t.name:(e=>{var t,a;return(null==e?void 0:e.androidBridge)?"android":(null===(a=null===(t=null==e?void 0:e.webkit)||void 0===t?void 0:t.messageHandlers)||void 0===a?void 0:a.bridge)?"ios":"web"})(e),n=e=>{var t;return null===(t=a.PluginHeaders)||void 0===t?void 0:t.find(t=>t.name===e)},i=new Map;return a.convertFileSrc||(a.convertFileSrc=e=>e),a.getPlatform=s,a.handleError=t=>e.console.error(t),a.isNativePlatform=()=>"web"!==s(),a.isPluginAvailable=e=>{const t=i.get(e);return!!(null==t?void 0:t.platforms.has(s()))||!!n(e)},a.registerPlugin=(e,o={})=>{const c=i.get(e);if(c)return c.proxy;const l=s(),d=n(e);let u;const m=r=>{let s;const n=(...n)=>{const i=(async()=>(!u&&l in o?u=u="function"==typeof o[l]?await o[l]():o[l]:null!==t&&!u&&"web"in o&&(u=u="function"==typeof o.web?await o.web():o.web),u))().then(t=>{const i=((t,r)=>{var s,n;if(!d){if(t)return null===(n=t[r])||void 0===n?void 0:n.bind(t);throw new Hc(`"${e}" plugin is not implemented on ${l}`,Vc.Unimplemented)}{const n=null==d?void 0:d.methods.find(e=>r===e.name);if(n)return"promise"===n.rtype?t=>a.nativePromise(e,r.toString(),t):(t,s)=>a.nativeCallback(e,r.toString(),t,s);if(t)return null===(s=t[r])||void 0===s?void 0:s.bind(t)}})(t,r);if(i){const e=i(...n);return s=null==e?void 0:e.remove,e}throw new Hc(`"${e}.${r}()" is not implemented on ${l}`,Vc.Unimplemented)});return"addListener"===r&&(i.remove=async()=>s()),i};return n.toString=()=>`${r.toString()}() { [capacitor code] }`,Object.defineProperty(n,"name",{value:r,writable:!1,configurable:!1}),n},h=m("addListener"),p=m("removeListener"),g=(e,t)=>{const a=h({eventName:e},t),r=async()=>{const r=await a;p({eventName:e,callbackId:r},t)},s=new Promise(e=>a.then(()=>e({remove:r})));return s.remove=async()=>{await r()},s},_=new Proxy({},{get(e,t){switch(t){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return d?g:h;case"removeListener":return p;default:return m(t)}}});return r[e]=_,i.set(e,{name:e,proxy:_,platforms:new Set([...Object.keys(o),...d?[l]:[]])}),_},a.Exception=Hc,a.DEBUG=!!a.DEBUG,a.isLoggingEnabled=!!a.isLoggingEnabled,a},Gc=(e=>e.Capacitor=Qc(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}),Kc=Gc.registerPlugin;class Yc{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let a=!1;this.listeners[e]||(this.listeners[e]=[],a=!0),this.listeners[e].push(t);const r=this.windowListeners[e];r&&!r.registered&&this.addWindowListener(r),a&&this.sendRetainedArgumentsForEvent(e);return Promise.resolve({remove:async()=>this.removeListener(e,t)})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,a){const r=this.listeners[e];if(r)r.forEach(e=>e(t));else if(a){let a=this.retainedEventArguments[e];a||(a=[]),a.push(t),this.retainedEventArguments[e]=a}}hasListeners(e){var t;return!!(null===(t=this.listeners[e])||void 0===t?void 0:t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:e=>{this.notifyListeners(t,e)}}}unimplemented(e="not implemented"){return new Gc.Exception(e,Vc.Unimplemented)}unavailable(e="not available"){return new Gc.Exception(e,Vc.Unavailable)}async removeListener(e,t){const a=this.listeners[e];if(!a)return;const r=a.indexOf(t);this.listeners[e].splice(r,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(t=>{this.notifyListeners(e,t)}))}}const Jc=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Xc=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Zc extends Yc{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(e=>{if(e.length<=0)return;let[a,r]=e.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=Xc(a).trim(),r=Xc(r).trim(),t[a]=r}),t}async setCookie(e){try{const t=Jc(e.key),a=Jc(e.value),r=`; expires=${(e.expires||"").replace("expires=","")}`,s=(e.path||"/").replace("path=",""),n=null!=e.url&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${a||""}${r}; path=${s}; ${n};`}catch(iu){return Promise.reject(iu)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(iu){return Promise.reject(iu)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(iu){return Promise.reject(iu)}}async clearAllCookies(){try{await this.clearCookies()}catch(iu){return Promise.reject(iu)}}}Kc("CapacitorCookies",{web:()=>new Zc});const el=(e,t={})=>{const a=Object.assign({method:e.method||"GET",headers:e.headers},t),r=((e={})=>{const t=Object.keys(e);return Object.keys(e).map(e=>e.toLocaleLowerCase()).reduce((a,r,s)=>(a[r]=e[t[s]],a),{})})(e.headers)["content-type"]||"";if("string"==typeof e.data)a.body=e.data;else if(r.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams;for(const[a,r]of Object.entries(e.data||{}))t.set(a,r);a.body=t.toString()}else if(r.includes("multipart/form-data")||e.data instanceof FormData){const t=new FormData;if(e.data instanceof FormData)e.data.forEach((e,a)=>{t.append(a,e)});else for(const a of Object.keys(e.data))t.append(a,e.data[a]);a.body=t;const r=new Headers(a.headers);r.delete("content-type"),a.headers=r}else(r.includes("application/json")||"object"==typeof e.data)&&(a.body=JSON.stringify(e.data));return a};class tl extends Yc{async request(e){const t=el(e,e.webFetchExtra),a=((e,t=!0)=>e?Object.entries(e).reduce((e,a)=>{const[r,s]=a;let n,i;return Array.isArray(s)?(i="",s.forEach(e=>{n=t?encodeURIComponent(e):e,i+=`${r}=${n}&`}),i.slice(0,-1)):(n=t?encodeURIComponent(s):s,i=`${r}=${n}`),`${e}&${i}`},"").substr(1):null)(e.params,e.shouldEncodeUrlParams),r=a?`${e.url}?${a}`:e.url,s=await fetch(r,t),n=s.headers.get("content-type")||"";let i,o,{responseType:c="text"}=s.ok?e:{};switch(n.includes("application/json")&&(c="json"),c){case"arraybuffer":case"blob":o=await s.blob(),i=await(async e=>new Promise((t,a)=>{const r=new FileReader;r.onload=()=>{const e=r.result;t(e.indexOf(",")>=0?e.split(",")[1]:e)},r.onerror=e=>a(e),r.readAsDataURL(e)}))(o);break;case"json":i=await s.json();break;default:i=await s.text()}const l={};return s.headers.forEach((e,t)=>{l[t]=e}),{data:i,headers:l,status:s.status,url:s.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}Kc("CapacitorHttp",{web:()=>new tl});class al{static isNativeApp(){return Gc.isNativePlatform()}static isWeb(){return!Gc.isNativePlatform()}static getPlatform(){return Gc.getPlatform()}static isAndroid(){return"android"===Gc.getPlatform()}static isIOS(){return"ios"===Gc.getPlatform()}static getPlatformInfo(){return{isNative:this.isNativeApp(),isWeb:this.isWeb(),isAndroid:this.isAndroid(),isIOS:this.isIOS(),platform:this.getPlatform()}}static logPlatformInfo(){return this.getPlatformInfo()}}const rl=()=>al.isNativeApp(),sl=({children:e})=>{const t=rl();return r.useEffect(()=>{},[t]),t?$.jsx($.Fragment,{children:e}):$.jsx(o,{to:"/dashboard",replace:!0})},nl=({children:t})=>{const a=i(),r=n(),s=rl();return e.useEffect(()=>{if(s){r.pathname.startsWith("/mobile")||a("/mobile/dashboard",{replace:!0})}},[s,r.pathname,a]),$.jsx($.Fragment,{children:t})},il=()=>{const e=rl()?"/mobile/dashboard":"/dashboard";return $.jsx(o,{to:e,replace:!0})},ol=e.createContext(void 0),cl=({children:t})=>{const[a,r]=e.useState([]),[s,n]=e.useState(!0),[i,o]=e.useState(null),c=async()=>{try{n(!0),o(null);const e=await ps();r(e)}catch(e){o(e.message||"Failed to fetch suppliers"),m.error("Failed to load suppliers")}finally{n(!1)}},l=async e=>{try{return await l(e)}catch(t){return a.filter(t=>t.country===e)}};e.useEffect(()=>{c()},[]);const d={suppliers:a,loading:s,error:i,refreshSuppliers:c,searchSuppliersByName:async e=>{try{return e.trim().length<2?a:await vs(e)}catch(t){return a.filter(t=>{var a;return t.name.toLowerCase().includes(e.toLowerCase())||(null==(a=t.contact_person)?void 0:a.toLowerCase().includes(e.toLowerCase()))})}},getSuppliersByCountry:l,getSupplierById:e=>a.find(t=>t.id===e),getSupplierByName:e=>a.find(t=>t.name.toLowerCase()===e.toLowerCase())};return $.jsx(ol.Provider,{value:d,children:t})},ll=e.createContext(void 0),dl=()=>{const t=e.useContext(ll);if(!t)throw new Error("useWhatsApp must be used within a WhatsAppProvider");return t},ul=({children:t})=>{const[a,r]=e.useState([]),[s,n]=e.useState(!1),[i,o]=e.useState(null);let c;try{c=bn()}catch(p){c={isAuthenticated:!1,currentUser:null,loading:!0}}const{isAuthenticated:l,currentUser:d,loading:u}=c;e.useEffect(()=>{!u&&l&&d&&m()},[u,l,d]);const m=async()=>{try{if(n(!0),o(null),u)return;if(!l||!d)return o("Please log in to access WhatsApp features"),void r([]);if(!$a)throw new Error("Database connection not available. Please check your internet connection and try again.");const{data:e,error:t}=await $a.from("whatsapp_instances_comprehensive").select("*").eq("user_id",d.id).order("created_at",{ascending:!1});if(t)throw new Error(`Database error: ${t.message}. Please try again or contact support.`);r(e||[])}catch(e){o(e.message),r([])}finally{n(!1)}};e.useEffect(()=>{l&&d?m():(r([]),o(null))},[l,null==d?void 0:d.id]);const h={instances:a,loading:s,error:i,fetchInstances:m,updateInstance:async(e,t,a=!1)=>{try{if(o(null),!l||!d)throw new Error("Please log in to update WhatsApp instances");const{error:s}=await $a.from("whatsapp_instances_comprehensive").update({...t,updated_at:(new Date).toISOString()}).eq("instance_id",e).eq("user_id",d.id);if(s)throw new Error(`Failed to update instance: ${s.message}`);r(a=>a.map(a=>a.instance_id===e?{...a,...t,updated_at:(new Date).toISOString()}:a)),a||await m()}catch(s){throw o(s.message),s}},addInstance:async e=>{try{if(o(null),!l||!d)throw new Error("Please log in to create WhatsApp instances");const{data:t,error:a}=await $a.from("whatsapp_instances_comprehensive").insert({...e,user_id:d.id}).select().single();if(a)throw new Error(`Failed to create instance: ${a.message}`);r(e=>[t,...e])}catch(t){throw o(t.message),t}},deleteInstance:async e=>{try{if(o(null),!l||!d)throw new Error("Please log in to delete WhatsApp instances");const{error:t}=await $a.from("whatsapp_instances_comprehensive").delete().eq("instance_id",e).eq("user_id",d.id);if(t)throw new Error(`Failed to delete instance: ${t.message}`);r(t=>t.filter(t=>t.instance_id!==e))}catch(t){throw o(t.message),t}},clearError:()=>{o(null)},isAuthenticated:l};return $.jsx(ll.Provider,{value:h,children:t})},ml={handoverReminderHours:24,checkIntervalMinutes:30};const hl=new class{constructor(e={}){this.intervalId=null,this.isRunning=!1,this.lastCheckTime=0,this.CHECK_COOLDOWN=3e5,this.config={...ml,...e}}start(){this.isRunning||this.intervalId||(this.isRunning=!0,this.intervalId=setInterval(()=>{this.checkOverdueHandovers()},60*this.config.checkIntervalMinutes*1e3),this.checkOverdueHandovers())}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,this.isRunning=!1)}async checkOverdueHandovers(){const e=Date.now();if(!(e-this.lastCheckTime<this.CHECK_COOLDOWN)){this.lastCheckTime=e;try{const e=new Date;e.setHours(e.getHours()-this.config.handoverReminderHours);const{data:t,error:a}=await $a.from("devices").select("id, serial_number, brand, model, status, updated_at, customer_id").eq("status","repair-complete").lt("updated_at",e.toISOString());if(a)return;if(t&&t.length>0){const e=[...new Set(t.map(e=>e.customer_id).filter(Boolean))];let a={};if(e.length>0){const{data:t}=await $a.from("customers").select("id, name, phone, email").in("id",e);t&&(a=Object.fromEntries(t.map(e=>[e.id,e])))}const r=t.map(e=>({...e,customers:a[e.customer_id]}));await this.sendHandoverReminders(r)}}catch(iu){}}}async sendHandoverReminders(e){try{const t=await this.getCustomerCareEmails();if(0===t.length)return;e.map(e=>{var t;return`${e.brand} ${e.model} (${e.serial_number}) - Customer: ${(null==(t=e.customers)?void 0:t.name)||"Unknown"}`}).join("\n");const a=`\n        <h2>Overdue Device Handovers</h2>\n        <p>The following devices have been marked as "repair-complete" for more than ${this.config.handoverReminderHours} hours and require customer handover:</p>\n        <ul>\n          ${e.map(e=>{var t;return`<li><strong>${e.brand} ${e.model}</strong> (${e.serial_number})<br>\n             Customer: ${(null==(t=e.customers)?void 0:t.name)||"Unknown"}<br>\n             Status since: ${new Date(e.updated_at).toLocaleString()}</li>`}).join("")}\n        </ul>\n        <p>Please contact customers to arrange pickup or delivery.</p>\n      `;await Zi.sendEmail({to:t.join(","),subject:`Overdue Device Handovers - ${e.length} devices`,content:a})}catch(iu){}}async getCustomerCareEmails(){try{const{data:e,error:t}=await $a.from("users").select("email").eq("role","customer-care");return t?[]:(null==e?void 0:e.map(e=>e.email))||[]}catch(iu){return[]}}async manualCheck(){await this.checkOverdueHandovers()}},pl="pending-actions";async function gl(){return Fn("clean-app-offline-sync",1,{upgrade(e){e.objectStoreNames.contains(pl)||e.createObjectStore(pl,{keyPath:"id",autoIncrement:!0})}})}async function _l(e){const t=await gl();await t.add(pl,{...e,timestamp:Date.now()})}const fl=[{text:"Loading data..."},{text:"Fetching inventory..."},{text:"Syncing products..."},{text:"Updating categories..."},{text:"Loading customers..."},{text:"Preparing analytics..."},{text:"Checking stock levels..."},{text:"Connecting to database..."},{text:"Optimizing performance..."},{text:"Almost ready..."}],yl=()=>{const[t,a]=e.useState(!1),[r,s]=e.useState(!1),[n,i]=e.useState(0),{products:o,categories:c,suppliers:l,isLoading:d}=vn(),u=e.useContext(oo),m=(null==u?void 0:u.customers)||[],{currentMessage:h}=((t={})=>{const{messages:a=fl,interval:r=2e3,enabled:s=!0}=t,[n,i]=e.useState(0),[o,c]=e.useState(a[0]);return e.useEffect(()=>{if(!s||a.length<=1)return;const e=setInterval(()=>{i(e=>{const t=(e+1)%a.length;return c(a[t]),t})},r);return()=>clearInterval(e)},[a,r,s]),{currentMessage:o,currentIndex:n,totalMessages:a.length,reset:()=>{i(0),c(a[0])}}})({enabled:t,interval:2500}),[p,g]=e.useState({inventory:!1,customers:!1,devices:!1,settings:!1});return e.useEffect(()=>{d?(a(!0),s(!1),i(0)):((null==o?void 0:o.length)>0||(null==c?void 0:c.length)>0||(null==l?void 0:l.length)>0||(null==m?void 0:m.length)>0)&&(a(!1),s(!0),i(100),setTimeout(()=>{s(!1)},3e3))},[d,null==o?void 0:o.length,null==c?void 0:c.length,null==l?void 0:l.length,null==m?void 0:m.length]),e.useEffect(()=>{if(t){const e=6,t=[(null==o?void 0:o.length)>0,(null==c?void 0:c.length)>0,(null==l?void 0:l.length)>0,(null==m?void 0:m.length)>0,p.devices,p.settings].filter(Boolean).length;i(t/e*100)}},[t,null==o?void 0:o.length,null==c?void 0:c.length,null==l?void 0:l.length,null==m?void 0:m.length,p]),t||r?$.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:$.jsx("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-3 max-w-xs",children:$.jsx("div",{className:"flex items-center space-x-3",children:t?$.jsxs($.Fragment,{children:[$.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-gray-300 border-t-gray-700"}),$.jsxs("div",{className:"flex-1",children:[$.jsx("p",{className:"text-sm text-gray-700",children:h.text}),$.jsx("div",{className:"w-full bg-gray-100 rounded-full h-1 mt-2",children:$.jsx("div",{className:"bg-gray-700 h-1 rounded-full transition-all duration-300",style:{width:`${n}%`}})})]})]}):$.jsxs($.Fragment,{children:[$.jsx(S,{className:"h-4 w-4 text-gray-700"}),$.jsxs("div",{children:[$.jsx("p",{className:"text-sm text-gray-700",children:"Data loaded"}),$.jsxs("p",{className:"text-xs text-gray-500",children:[(null==o?void 0:o.length)||0," products  ",(null==m?void 0:m.length)||0," customers"]})]})]})})})}):null},vl=({children:t})=>(e.useEffect(()=>{(async()=>{})()},[]),$.jsx($.Fragment,{children:t})),wl=(t=[],a={})=>{const{enabled:r=!0,enableInInputs:s=!1}=a,n=e.useRef(t);e.useEffect(()=>{n.current=t},[t]);const i=e.useCallback(e=>{if(!r)return;const t=e.target;if(("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)&&!s){const t=["Escape","s","z","y"];if(!e.key||!t.includes(e.key.toLowerCase())||!e.metaKey&&!e.ctrlKey&&"Escape"!==e.key)return}if(n.current&&Array.isArray(n.current)&&e.key)for(const a of n.current){if(!a.key)continue;const t=e.key.toLowerCase()===a.key.toLowerCase(),r=!a.ctrl||e.ctrlKey,s=!a.alt||e.altKey,n=!a.shift||e.shiftKey,i=!a.meta||e.metaKey;if(t&&r&&s&&n&&i){!1!==a.preventDefault&&e.preventDefault(),a.action(e);break}}},[r,s]);return e.useEffect(()=>{if(r)return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[r,i]),{shortcuts:n.current}},bl=t=>e.lazy(()=>t().catch(e=>({default:()=>$.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center max-w-md mx-auto p-6",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Component Loading Error"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"There was an error loading this component. Please refresh the page."}),$.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})})}))),Sl=e.lazy(()=>s(()=>import("./LoginPage-5f85f36f.js"),["assets/LoginPage-5f85f36f.js","assets/vendor-a2ff445a.js","assets/PageErrorWrapper-024e3cfe.js","assets/PageErrorBoundary-d0d559c5.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/useErrorHandler-ea2ee44d.js","assets/ErrorState-0516fc54.js","assets/ModernLoadingOverlay-8a052a4d.js","assets/CircularProgress-471d8e37.js","assets/supabase-7e851d02.js"])),xl=bl(()=>s(()=>import("./ConditionalDashboard-cd34b236.js"),["assets/ConditionalDashboard-cd34b236.js","assets/supabase-7e851d02.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"])),kl=e.lazy(()=>s(()=>import("./NewDevicePage-076ba85e.js"),["assets/NewDevicePage-076ba85e.js","assets/vendor-a2ff445a.js","assets/toastUtils-fdf4803f.js","assets/ui-551a39a6.js","assets/Modal-ccfa5014.js","assets/useBodyScrollLock-0216d39f.js","assets/search-674d386b.js","assets/AddCustomerModal-a69277f6.js","assets/CustomerForm-05944812.js","assets/phoneUtils-1ba19aca.js","assets/useSuccessModal-e8b7d685.js","assets/SuccessModalIcons-20b743c5.js","assets/productCalculations-9e8647a1.js","assets/qr-a0592e4b.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),El=bl(()=>s(()=>import("./DevicesPage-30ca344f.js"),["assets/DevicesPage-30ca344f.js","assets/vendor-a2ff445a.js","assets/SearchBar-2b6f451f.js","assets/ui-551a39a6.js","assets/GlassSelect-3b56e5f5.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/toastUtils-fdf4803f.js","assets/supabase-7e851d02.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/GlassInput-ba5c3c0d.js","assets/PaymentsPopupModal-70ab4c91.js","assets/CustomerDetailModal-9e075bf1.js","assets/appointments-4d8aac45.js","assets/Modal-ccfa5014.js","assets/CustomerForm-05944812.js","assets/returns-0428af68.js","assets/whatsappService-37f3bd6b.js","assets/AppointmentModal-4524caae.js","assets/format-0f0b2647.js","assets/index-0096d614.js","assets/pdf-33d2fdad.js","assets/CBMCalculatorModal-f5dbe117.js"])),Il=e.lazy(()=>s(()=>import("./CustomersPage-55413a20.js"),["assets/CustomersPage-55413a20.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/BackButton-e41d1482.js","assets/useBodyScrollLock-0216d39f.js","assets/phoneUtils-1ba19aca.js","assets/CustomerDetailModal-9e075bf1.js","assets/appointments-4d8aac45.js","assets/Modal-ccfa5014.js","assets/CustomerForm-05944812.js","assets/returns-0428af68.js","assets/whatsappService-37f3bd6b.js","assets/AppointmentModal-4524caae.js","assets/useSuccessModal-e8b7d685.js","assets/SuccessModalIcons-20b743c5.js","assets/format-0f0b2647.js","assets/index-0096d614.js","assets/pdf-33d2fdad.js","assets/supabase-7e851d02.js","assets/customerApi-3e6f5bd3.js","assets/search-674d386b.js","assets/AddCustomerModal-a69277f6.js","assets/financialService-1702c0e7.js"])),Al=e.lazy(()=>s(()=>import("./CustomerDataUpdatePage-c99028c7.js"),["assets/CustomerDataUpdatePage-c99028c7.js","assets/vendor-a2ff445a.js","assets/Modal-ccfa5014.js","assets/useBodyScrollLock-0216d39f.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Pl=bl(()=>s(()=>import("./AppLayout-314e01bf.js"),["assets/AppLayout-314e01bf.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/useBusinessInfo-13b9c3ff.js","assets/AddCustomerModal-a69277f6.js","assets/ui-551a39a6.js","assets/CustomerForm-05944812.js","assets/phoneUtils-1ba19aca.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/reminderApi-01c80b0e.js","assets/Modal-ccfa5014.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/SearchResults-b4708312.js","assets/supabase-7e851d02.js"])),Cl=e.lazy(()=>s(()=>import("./AdminSettingsPage-5126006b.js"),["assets/AdminSettingsPage-5126006b.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/attendanceSettingsApi-f32cc1d2.js","assets/supabase-7e851d02.js","assets/ui-551a39a6.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/userSettingsApi-39de17fd.js"])),Tl=e.lazy(()=>s(()=>import("./IntegrationsTestPage-efee6e7d.js"),["assets/IntegrationsTestPage-efee6e7d.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/whatsappService-37f3bd6b.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),jl=e.lazy(()=>s(()=>import("./UserManagementPage-88884941.js"),["assets/UserManagementPage-88884941.js","assets/vendor-a2ff445a.js","assets/SearchBar-2b6f451f.js","assets/ui-551a39a6.js","assets/GlassSelect-3b56e5f5.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/GlassInput-ba5c3c0d.js","assets/useBodyScrollLock-0216d39f.js","assets/employeeService-806781a0.js","assets/supabase-7e851d02.js"])),Dl=e.lazy(()=>s(()=>import("./UnifiedSupplierManagementPage-16508ddb.js"),["assets/UnifiedSupplierManagementPage-16508ddb.js","assets/vendor-a2ff445a.js","assets/SearchBar-2b6f451f.js","assets/ui-551a39a6.js","assets/GlassSelect-3b56e5f5.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/PageErrorBoundary-d0d559c5.js","assets/supabase-7e851d02.js"])),Rl=e.lazy(()=>s(()=>import("./SMSControlCenterPage-b6904d22.js"),["assets/SMSControlCenterPage-b6904d22.js","assets/supabase-7e851d02.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js"])),Ll=e.lazy(()=>s(()=>import("./EnhancedPaymentManagementPage-33f05309.js"),["assets/EnhancedPaymentManagementPage-33f05309.js","assets/vendor-a2ff445a.js","assets/PageErrorBoundary-d0d559c5.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/useErrorHandler-ea2ee44d.js","assets/GlassBadge-18f019e2.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/Modal-ccfa5014.js","assets/useBodyScrollLock-0216d39f.js","assets/paymentTrackingService-7b6db13e.js","assets/supabase-7e851d02.js","assets/financialService-1702c0e7.js","assets/PaymentsPopupModal-70ab4c91.js","assets/GlassSelect-3b56e5f5.js","assets/GlassInput-ba5c3c0d.js","assets/ExpenseManagement-035bea7d.js","assets/useSuccessModal-e8b7d685.js","assets/format-0f0b2647.js"])),Ol=e.lazy(()=>s(()=>import("./ExpensesPage-c1f1aa4c.js"),["assets/ExpensesPage-c1f1aa4c.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/ExpenseManagement-035bea7d.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/Modal-ccfa5014.js","assets/useBodyScrollLock-0216d39f.js","assets/useSuccessModal-e8b7d685.js","assets/supabase-7e851d02.js"])),ql=e.lazy(()=>s(()=>import("./EmployeeManagementPage-295a35d8.js"),["assets/EmployeeManagementPage-295a35d8.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/BackButton-e41d1482.js","assets/ui-551a39a6.js","assets/GlassSelect-3b56e5f5.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/employeeService-806781a0.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/supabase-7e851d02.js"]));e.lazy(()=>s(()=>import("./EmployeeAttendancePage-91cb8cbe.js"),["assets/EmployeeAttendancePage-91cb8cbe.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/officeConfig-b4b33ec9.js","assets/attendanceSettingsApi-f32cc1d2.js","assets/employeeService-806781a0.js","assets/supabase-7e851d02.js"])),e.lazy(()=>s(()=>import("./AttendanceManagementPage-df2af682.js"),["assets/AttendanceManagementPage-df2af682.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/index-0096d614.js","assets/pdf-33d2fdad.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"]));const Nl=e.lazy(()=>s(()=>import("./MyAttendancePage-36366eda.js"),["assets/MyAttendancePage-36366eda.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/officeConfig-b4b33ec9.js","assets/attendanceSettingsApi-f32cc1d2.js","assets/employeeService-806781a0.js","assets/supabase-7e851d02.js"])),Ml=e.lazy(()=>s(()=>import("./UnifiedAppointmentPage-6d444a7c.js"),["assets/UnifiedAppointmentPage-6d444a7c.js","assets/vendor-a2ff445a.js","assets/SearchBar-2b6f451f.js","assets/ui-551a39a6.js","assets/GlassSelect-3b56e5f5.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/PageErrorBoundary-d0d559c5.js","assets/AppointmentModal-4524caae.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/appointments-4d8aac45.js","assets/supabase-7e851d02.js"])),Ul=e.lazy(()=>s(()=>import("./RemindersPage-bd00f085.js"),["assets/RemindersPage-bd00f085.js","assets/vendor-a2ff445a.js","assets/reminderApi-01c80b0e.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"]));e.lazy(()=>s(()=>import("./GlobalSearchPage-d6b769d4.js"),["assets/GlobalSearchPage-d6b769d4.js","assets/vendor-a2ff445a.js","assets/SearchResults-b4708312.js","assets/ui-551a39a6.js","assets/phoneUtils-1ba19aca.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"]));const Bl=e.lazy(()=>s(()=>import("./ProductAdGeneratorPage-d7ccc403.js").then(e=>e.P),["assets/ProductAdGeneratorPage-d7ccc403.js","assets/vendor-a2ff445a.js","assets/pdf-33d2fdad.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"])),$l=e.lazy(()=>s(()=>import("./SpecialOrdersPage-1ff5f075.js"),["assets/SpecialOrdersPage-1ff5f075.js","assets/vendor-a2ff445a.js","assets/whatsappService-37f3bd6b.js","assets/ui-551a39a6.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Fl=e.lazy(()=>s(()=>import("./InstallmentsPage-6718cbf0.js"),["assets/InstallmentsPage-6718cbf0.js","assets/vendor-a2ff445a.js","assets/installmentService-e14bbda4.js","assets/whatsappService-37f3bd6b.js","assets/ui-551a39a6.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),zl=e.lazy(()=>s(()=>import("./CategoryManagementPage-223daa79.js"),["assets/CategoryManagementPage-223daa79.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Vl=e.lazy(()=>s(()=>import("./StoreLocationManagementPage-01a2a39e.js"),["assets/StoreLocationManagementPage-01a2a39e.js","assets/vendor-a2ff445a.js","assets/Modal-ccfa5014.js","assets/useBodyScrollLock-0216d39f.js","assets/storeLocationApi-de3f7bfa.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Wl=e.lazy(()=>s(()=>import("./DatabaseSetupPage-290ff50a.js"),["assets/DatabaseSetupPage-290ff50a.js","assets/ui-551a39a6.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Hl=e.lazy(()=>s(()=>import("./BackupManagementPage-ee8f33de.js"),["assets/BackupManagementPage-ee8f33de.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Ql=e.lazy(()=>s(()=>import("./ExcelImportPage-007437d4.js"),["assets/ExcelImportPage-007437d4.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/phoneUtils-1ba19aca.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Gl=e.lazy(()=>s(()=>import("./ExcelTemplateDownloadPage-6fe5cc48.js"),["assets/ExcelTemplateDownloadPage-6fe5cc48.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Kl=e.lazy(()=>s(()=>import("./ProductExportPage-540c3005.js"),["assets/ProductExportPage-540c3005.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Yl=e.lazy(()=>s(()=>import("./LoginPage-8aed4bdf.js"),["assets/LoginPage-8aed4bdf.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Jl=e.lazy(()=>s(()=>import("./SignupPage-a0547f5e.js"),["assets/SignupPage-a0547f5e.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Xl=e.lazy(()=>s(()=>import("./DashboardPage-46eb6e87.js"),["assets/DashboardPage-46eb6e87.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),Zl=e.lazy(()=>s(()=>import("./ProductsPage-1faf2bec.js"),["assets/ProductsPage-1faf2bec.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),ed=e.lazy(()=>s(()=>import("./ProductDetailPage-056f1b6f.js"),["assets/ProductDetailPage-056f1b6f.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),td=e.lazy(()=>s(()=>import("./ProfilePage-090c662a.js"),["assets/ProfilePage-090c662a.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),ad=e.lazy(()=>s(()=>import("./OrdersPage-4ce4b3e2.js"),["assets/OrdersPage-4ce4b3e2.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),rd=e.lazy(()=>s(()=>import("./LoyaltyPage-d8d3df95.js"),["assets/LoyaltyPage-d8d3df95.js","assets/vendor-a2ff445a.js","assets/customerPortalService-ebbdd244.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),sd=e.lazy(()=>s(()=>import("./TestImageUpload-e14819cd.js"),["assets/TestImageUpload-e14819cd.js","assets/vendor-a2ff445a.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js"])),nd=e.lazy(()=>s(()=>import("./BackgroundRemovalPage-0d28d7d3.js"),["assets/BackgroundRemovalPage-0d28d7d3.js","assets/vendor-a2ff445a.js","assets/index-7d29ff6f.js","assets/charts-66cc82bb.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),id=e.lazy(()=>s(()=>import("./MobileLayout-9fe19a2e.js"),["assets/MobileLayout-9fe19a2e.js","assets/vendor-a2ff445a.js","assets/mobileOfflineCache-7b8975c6.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),od=e.lazy(()=>s(()=>import("./MobileDashboard-ea516061.js"),["assets/MobileDashboard-ea516061.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/useMobileBranch-1aee679b.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),cd=e.lazy(()=>s(()=>import("./MobilePOS-416da642.js"),["assets/MobilePOS-416da642.js","assets/vendor-a2ff445a.js","assets/ShareReceiptModal-4bab199d.js","assets/supabase-7e851d02.js","assets/ui-551a39a6.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/format-0f0b2647.js","assets/MobileAddCustomerModal-ed043a13.js","assets/phoneUtils-1ba19aca.js","assets/MobileSheetContent-ad1cebdf.js","assets/useMobileBranch-1aee679b.js","assets/supabase-460661f2.js","assets/routing-a2f0f6d2.js"])),ld=e.lazy(()=>s(()=>import("./MobileInventory-1d3df30a.js"),["assets/MobileInventory-1d3df30a.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/useMobileBranch-1aee679b.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),dd=e.lazy(()=>s(()=>import("./MobileAddProduct-1b33fa8b.js"),["assets/MobileAddProduct-1b33fa8b.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),ud=e.lazy(()=>s(()=>import("./MobileClients-8a6d1858.js"),["assets/MobileClients-8a6d1858.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/MobileAddCustomerModal-ed043a13.js","assets/phoneUtils-1ba19aca.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/MobileSheetContent-ad1cebdf.js","assets/useMobileBranch-1aee679b.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),md=e.lazy(()=>s(()=>import("./MobileMore-fafa69d9.js"),["assets/MobileMore-fafa69d9.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/mobileOfflineCache-7b8975c6.js","assets/supabase-460661f2.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),hd=e.lazy(()=>s(()=>import("./MobileAnalytics-c109126f.js"),["assets/MobileAnalytics-c109126f.js","assets/vendor-a2ff445a.js","assets/dashboardService-33c47c64.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js"])),pd=e.lazy(()=>s(()=>import("./MobileProductDetail-69bfadad.js"),["assets/MobileProductDetail-69bfadad.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/robustImageService-2422a1f9.js","assets/format-0f0b2647.js","assets/variantUtils-422e46bb.js","assets/specificationUtils-8355804c.js","assets/useMobileBranch-1aee679b.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),gd=e.lazy(()=>s(()=>import("./MobileClientDetail-a3f811aa.js"),["assets/MobileClientDetail-a3f811aa.js","assets/vendor-a2ff445a.js","assets/supabase-460661f2.js","assets/ui-551a39a6.js","assets/appointments-4d8aac45.js","assets/returns-0428af68.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),_d=e.lazy(()=>s(()=>import("./MobileSheetDemo-03dfaeef.js"),["assets/MobileSheetDemo-03dfaeef.js","assets/vendor-a2ff445a.js","assets/MobileSheetContent-ad1cebdf.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),fd=e.lazy(()=>s(()=>import("./LATSDashboardPage-f1a087d0.js"),["assets/LATSDashboardPage-f1a087d0.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/PageErrorBoundary-d0d559c5.js","assets/useErrorHandler-ea2ee44d.js","assets/ErrorState-0516fc54.js","assets/supabase-7e851d02.js"])),yd=e.lazy(()=>s(()=>import("./PurchaseOrdersPage-681f2200.js"),["assets/PurchaseOrdersPage-681f2200.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/useDialog-ddaadb89.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/CBMCalculatorModal-f5dbe117.js","assets/SuppliersTab-a9a4cdaf.js","assets/SearchBar-2b6f451f.js","assets/SupplierForm-e7ec71ff.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/SupplierDetailsModal-8b57c375.js","assets/supabase-7e851d02.js"])),vd=e.lazy(()=>s(()=>import("./POcreate-a8bd6f71.js"),["assets/POcreate-a8bd6f71.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/useDialog-ddaadb89.js","assets/usePOSClickSounds-710a2a1b.js","assets/VariantProductCard-5f79965a.js","assets/supabase-7e851d02.js","assets/robustImageService-2422a1f9.js","assets/format-0f0b2647.js","assets/productUtils-6e390a72.js","assets/routing-a2f0f6d2.js","assets/AddSupplierModal-247b2b34.js","assets/purchaseOrderUtils-e0e1d78b.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/useBodyScrollLock-0216d39f.js","assets/SupplierDetailsModal-8b57c375.js","assets/SupplierForm-e7ec71ff.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/skuUtils-6fbbef44.js","assets/usePurchaseOrderHistory-baa7ee96.js","assets/CategoryInput-bba1731d.js","assets/useSuccessModal-e8b7d685.js","assets/SuccessModalIcons-20b743c5.js","assets/draftService-0e50dcac.js"])),wd=e.lazy(()=>s(()=>import("./PurchaseOrderDetailPage-57eaed5b.js"),["assets/PurchaseOrderDetailPage-57eaed5b.js","assets/supabase-7e851d02.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/PaymentsPopupModal-70ab4c91.js","assets/useBodyScrollLock-0216d39f.js","assets/storeShelfApi-d8b142f6.js","assets/SetPricingModal-f25ea152.js"])),bd=e.lazy(()=>s(()=>import("./TestSetPricingModal-2850cade.js"),["assets/TestSetPricingModal-2850cade.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/SetPricingModal-f25ea152.js","assets/supabase-7e851d02.js"])),Sd=e.lazy(()=>s(()=>import("./InventorySparePartsPage-8eb7bcc8.js"),["assets/InventorySparePartsPage-8eb7bcc8.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/CategoryInput-bba1731d.js","assets/PriceInput-e1556d5b.js","assets/specificationCategories-9f98df80.js","assets/storeLocationApi-de3f7bfa.js","assets/storeShelfApi-d8b142f6.js","assets/format-0f0b2647.js","assets/purchaseOrderUtils-e0e1d78b.js","assets/SafeImage-bfaf74c6.js","assets/routing-a2f0f6d2.js"])),xd=e.lazy(()=>s(()=>import("./StockTransferPage-776d6e0e.js"),["assets/StockTransferPage-776d6e0e.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/PageHeader-9450e930.js","assets/supabase-7e851d02.js"])),kd=e.lazy(()=>s(()=>import("./TradeInManagementPage-a76d314c.js"),["assets/TradeInManagementPage-a76d314c.js","assets/vendor-a2ff445a.js","assets/tradeInApi-966791f7.js","assets/format-0f0b2647.js","assets/useBodyScrollLock-0216d39f.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Ed=e.lazy(()=>s(()=>import("./TradeInTestPage-cdaeea49.js"),["assets/TradeInTestPage-cdaeea49.js","assets/vendor-a2ff445a.js","assets/TradeInCalculator-fb3e1cc9.js","assets/tradeInApi-966791f7.js","assets/format-0f0b2647.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js","assets/TradeInContractModal-dd90079f.js","assets/charts-66cc82bb.js","assets/toPropertyKey-7f87613e.js","assets/pdf-33d2fdad.js","assets/useBodyScrollLock-0216d39f.js"])),Id=e.lazy(()=>s(()=>import("./SalesReportsPage-6e66ac41.js"),["assets/SalesReportsPage-6e66ac41.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/rbac-bc517d81.js","assets/useBusinessInfo-13b9c3ff.js","assets/routing-a2f0f6d2.js","assets/charts-66cc82bb.js","assets/supabase-7e851d02.js"])),Ad=e.lazy(()=>s(()=>import("./CustomerLoyaltyPage-9c88207a.js"),["assets/CustomerLoyaltyPage-9c88207a.js","assets/vendor-a2ff445a.js","assets/PriceInput-e1556d5b.js","assets/ui-551a39a6.js","assets/PageHeader-9450e930.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Pd=e.lazy(()=>s(()=>import("./ShippedItemsPage-9161b8a4.js"),["assets/ShippedItemsPage-9161b8a4.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/draftService-0e50dcac.js","assets/purchaseOrderUtils-e0e1d78b.js","assets/supabase-7e851d02.js"])),Cd=e.lazy(()=>s(()=>import("./SuppliersManagementPage-92ae1e5e.js"),["assets/SuppliersManagementPage-92ae1e5e.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/AddSupplierModal-247b2b34.js","assets/purchaseOrderUtils-e0e1d78b.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/useBodyScrollLock-0216d39f.js","assets/useSuccessModal-e8b7d685.js","assets/supabase-7e851d02.js"])),Td=e.lazy(()=>s(()=>import("./UnifiedInventoryPage-9cc62549.js"),["assets/UnifiedInventoryPage-9cc62549.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/PageErrorBoundary-d0d559c5.js","assets/useErrorHandler-ea2ee44d.js","assets/ErrorState-0516fc54.js","assets/ProductModal-44d6d29a.js","assets/robustImageService-2422a1f9.js","assets/format-0f0b2647.js","assets/CircularProgress-471d8e37.js","assets/specificationUtils-8355804c.js","assets/productUtils-6e390a72.js","assets/variantUtils-422e46bb.js","assets/usePurchaseOrderHistory-baa7ee96.js","assets/productCalculations-9e8647a1.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/GlassBadge-18f019e2.js","assets/PriceInput-e1556d5b.js","assets/useBodyScrollLock-0216d39f.js","assets/storeShelfApi-d8b142f6.js","assets/CategoryFormModal-788e39ee.js","assets/supabase-7e851d02.js","assets/SupplierForm-e7ec71ff.js","assets/useSuccessModal-e8b7d685.js","assets/SuccessModalIcons-20b743c5.js","assets/CategoryInput-bba1731d.js","assets/PricingAndStockForm-1324ba4c.js","assets/SearchBar-2b6f451f.js","assets/ModernLoadingOverlay-8a052a4d.js","assets/VariantProductCard-5f79965a.js","assets/useBluetoothPrinter-08dc31b9.js","assets/qr-a0592e4b.js","assets/useDialog-ddaadb89.js"])),jd=e.lazy(()=>s(()=>import("./AddProductPage-9eb14369.js"),["assets/AddProductPage-9eb14369.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/specificationCategories-9f98df80.js","assets/skuUtils-6fbbef44.js","assets/ProductInformationForm-61fc6c83.js","assets/CategoryInput-bba1731d.js","assets/specificationUtils-8355804c.js","assets/ProductModal-44d6d29a.js","assets/robustImageService-2422a1f9.js","assets/format-0f0b2647.js","assets/CircularProgress-471d8e37.js","assets/productUtils-6e390a72.js","assets/variantUtils-422e46bb.js","assets/usePurchaseOrderHistory-baa7ee96.js","assets/productCalculations-9e8647a1.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/GlassBadge-18f019e2.js","assets/PriceInput-e1556d5b.js","assets/useBodyScrollLock-0216d39f.js","assets/storeShelfApi-d8b142f6.js","assets/useSuccessModal-e8b7d685.js","assets/supabase-7e851d02.js"])),Dd=e.lazy(()=>s(()=>import("./EditProductPage-7781c330.js"),["assets/EditProductPage-7781c330.js","assets/vendor-a2ff445a.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/specificationCategories-9f98df80.js","assets/skuUtils-6fbbef44.js","assets/productUtils-6e390a72.js","assets/ProductInformationForm-61fc6c83.js","assets/CategoryInput-bba1731d.js","assets/specificationUtils-8355804c.js","assets/PricingAndStockForm-1324ba4c.js","assets/PriceInput-e1556d5b.js","assets/format-0f0b2647.js","assets/ProductModal-44d6d29a.js","assets/robustImageService-2422a1f9.js","assets/CircularProgress-471d8e37.js","assets/variantUtils-422e46bb.js","assets/usePurchaseOrderHistory-baa7ee96.js","assets/productCalculations-9e8647a1.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/GlassBadge-18f019e2.js","assets/useBodyScrollLock-0216d39f.js","assets/storeShelfApi-d8b142f6.js","assets/useSuccessModal-e8b7d685.js","assets/supabase-7e851d02.js"])),Rd=e.lazy(()=>s(()=>import("./BulkImportPage-a7dc90c6.js"),["assets/BulkImportPage-a7dc90c6.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/index-7d29ff6f.js","assets/charts-66cc82bb.js","assets/supabase-7e851d02.js"])),Ld=bl(()=>s(()=>import("./POSPageOptimized-2fe67e41.js").then(e=>e.P),["assets/POSPageOptimized-2fe67e41.js","assets/supabase-7e851d02.js","assets/vendor-a2ff445a.js","assets/rbac-bc517d81.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/usePOSClickSounds-710a2a1b.js","assets/VariantProductCard-5f79965a.js","assets/robustImageService-2422a1f9.js","assets/format-0f0b2647.js","assets/productUtils-6e390a72.js","assets/useBodyScrollLock-0216d39f.js","assets/GlassBadge-18f019e2.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/SafeImage-bfaf74c6.js","assets/specificationUtils-8355804c.js","assets/PriceInput-e1556d5b.js","assets/CategoryInput-bba1731d.js","assets/AddCustomerModal-a69277f6.js","assets/CustomerForm-05944812.js","assets/phoneUtils-1ba19aca.js","assets/useSuccessModal-e8b7d685.js","assets/SuccessModalIcons-20b743c5.js","assets/search-674d386b.js","assets/ShareReceiptModal-4bab199d.js","assets/CustomerDetailModal-9e075bf1.js","assets/appointments-4d8aac45.js","assets/Modal-ccfa5014.js","assets/returns-0428af68.js","assets/whatsappService-37f3bd6b.js","assets/AppointmentModal-4524caae.js","assets/index-0096d614.js","assets/pdf-33d2fdad.js","assets/GlassInput-ba5c3c0d.js","assets/installmentService-e14bbda4.js","assets/TradeInContractModal-dd90079f.js","assets/toPropertyKey-7f87613e.js","assets/tradeInApi-966791f7.js","assets/paymentTrackingService-7b6db13e.js","assets/PaymentsPopupModal-70ab4c91.js","assets/draftService-0e50dcac.js","assets/POSPageOptimized-8d488751.css"])),Od=e.lazy(()=>s(()=>import("./InventoryManagementPage-d77a41a3.js"),["assets/InventoryManagementPage-d77a41a3.js","assets/vendor-a2ff445a.js","assets/routing-a2f0f6d2.js","assets/PageErrorBoundary-d0d559c5.js","assets/ui-551a39a6.js","assets/PageHeader-9450e930.js","assets/SearchBar-2b6f451f.js","assets/CategoryFormModal-788e39ee.js","assets/forms-fd94c8fb.js","assets/zod-4c7d126c.js","assets/GlassInput-ba5c3c0d.js","assets/utils-fb833cf6.js","assets/charts-66cc82bb.js","assets/GlassSelect-3b56e5f5.js","assets/GlassBadge-18f019e2.js","assets/useBodyScrollLock-0216d39f.js","assets/SuppliersTab-a9a4cdaf.js","assets/SupplierForm-e7ec71ff.js","assets/SupplierDetailsModal-8b57c375.js","assets/StorageRoomManagementPage-8c3f1fee.js","assets/storeShelfApi-d8b142f6.js","assets/storeLocationApi-de3f7bfa.js","assets/BackButton-e41d1482.js","assets/supabase-7e851d02.js"])),qd=e.lazy(()=>s(()=>import("./StorageRoomManagementPage-8c3f1fee.js"),["assets/StorageRoomManagementPage-8c3f1fee.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/storeShelfApi-d8b142f6.js","assets/storeLocationApi-de3f7bfa.js","assets/BackButton-e41d1482.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Nd=e.lazy(()=>s(()=>import("./StorageRoomDetailPage-d6a6ba88.js"),["assets/StorageRoomDetailPage-d6a6ba88.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/storeLocationApi-de3f7bfa.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),Md=e.lazy(()=>s(()=>import("./WhatsAppConnectionManager-52b7de9d.js"),["assets/WhatsAppConnectionManager-52b7de9d.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/StatusSettingsSection-7ad006b2.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Ud=e.lazy(()=>s(()=>import("./WhatsAppChatPage-5028f775.js"),["assets/WhatsAppChatPage-5028f775.js","assets/vendor-a2ff445a.js","assets/toastUtils-fdf4803f.js","assets/ui-551a39a6.js","assets/StatusSettingsSection-7ad006b2.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Bd=e.lazy(()=>s(()=>import("./BluetoothPrinterPage-5ecd0ca6.js"),["assets/BluetoothPrinterPage-5ecd0ca6.js","assets/vendor-a2ff445a.js","assets/useBluetoothPrinter-08dc31b9.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js","assets/supabase-7e851d02.js"])),$d=e.lazy(()=>s(()=>import("./DashboardPage-7782bd4c.js"),["assets/DashboardPage-7782bd4c.js","assets/vendor-a2ff445a.js","assets/PageErrorWrapper-024e3cfe.js","assets/PageErrorBoundary-d0d559c5.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/useErrorHandler-ea2ee44d.js","assets/ErrorState-0516fc54.js","assets/userSettingsApi-39de17fd.js","assets/roleBasedWidgets-3988ddf5.js","assets/dashboardService-33c47c64.js","assets/reminderApi-01c80b0e.js","assets/RemindersPage-bd00f085.js","assets/BackButton-e41d1482.js","assets/supabase-7e851d02.js","assets/charts-66cc82bb.js","assets/AppointmentModal-4524caae.js","assets/useSuccessModal-e8b7d685.js","assets/useBodyScrollLock-0216d39f.js","assets/SuccessModalIcons-20b743c5.js","assets/appointments-4d8aac45.js"])),Fd=e.lazy(()=>s(()=>import("./BulkSMSPage-b1edf7b9.js"),["assets/BulkSMSPage-b1edf7b9.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/format-0f0b2647.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),zd=e.lazy(()=>s(()=>import("./SMSLogsPage-343ac3b9.js"),["assets/SMSLogsPage-343ac3b9.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Vd=e.lazy(()=>s(()=>import("./SMSSettingsPage-72db2797.js"),["assets/SMSSettingsPage-72db2797.js","assets/supabase-7e851d02.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/routing-a2f0f6d2.js"])),Wd=e.lazy(()=>s(()=>import("./IntegrationSettingsPage-cab4bfa8.js"),["assets/IntegrationSettingsPage-cab4bfa8.js","assets/vendor-a2ff445a.js","assets/ui-551a39a6.js","assets/supabase-7e851d02.js","assets/routing-a2f0f6d2.js"])),Hd=e.lazy(()=>s(()=>import("./UserSettingsPage-e4196970.js"),["assets/UserSettingsPage-e4196970.js","assets/vendor-a2ff445a.js","assets/PageErrorWrapper-024e3cfe.js","assets/PageErrorBoundary-d0d559c5.js","assets/routing-a2f0f6d2.js","assets/ui-551a39a6.js","assets/useErrorHandler-ea2ee44d.js","assets/ErrorState-0516fc54.js","assets/userSettingsApi-39de17fd.js","assets/roleBasedWidgets-3988ddf5.js","assets/supabase-7e851d02.js"])),Qd=({error:e,retry:t})=>{const a=e.message.includes("Cannot convert object to primitive value");return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center max-w-md mx-auto p-6",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:a?"Component Loading Error":"Failed to load page"}),$.jsx("p",{className:"text-gray-600 mb-4",children:a?"There was an error initializing this component. This is usually a temporary issue that can be resolved by refreshing the page.":"There was an error loading this page. This might be a temporary issue."}),a&&$.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800",children:[" ",$.jsx("strong",{children:"Tip:"})," This error often occurs during development. Try refreshing the page or clearing your browser cache."]}),$.jsxs("div",{className:"flex gap-3 justify-center",children:[$.jsx("button",{onClick:t,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Try Again"}),$.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors",children:"Refresh Page"})]})]})})},Gd=()=>{const{isVisible:t,jobs:a,cancelJob:r}=(()=>{const t=e.useContext(Wo);if(!t)throw new Error("useLoading must be used within a LoadingProvider");return t})();return $.jsx(qc,{isVisible:t,jobs:a,onCancel:r})},Kd=({children:t})=>{const[a,r]=e.useState(!1);e.useEffect(()=>{r(!1)},[]);let s=!1,n=!0;try{const e=bn();s=e.isAuthenticated,n=e.loading}catch(iu){return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),$.jsx("p",{className:"text-gray-600",children:"Loading application..."})]})})}if(a)return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Authentication Error"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with authentication. Please refresh the page."}),$.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})});if(n)return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),$.jsx("p",{className:"text-gray-600",children:"Loading..."})]})});try{return s?$.jsx($.Fragment,{children:t}):(localStorage.setItem("postLoginRedirect",window.location.pathname),$.jsx(o,{to:"/login"}))}catch(iu){return r(!0),null}},Yd=({children:t,allowedRoles:a,requiredPermissions:r})=>{var s;const n=Array.isArray(a)?a.map(e=>String(e)):[],[i,c]=e.useState(!1);let l;e.useEffect(()=>{c(!1)},[]);try{l=bn()}catch(iu){return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Authentication Error"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with authentication. Please refresh the page."}),$.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})})}const{isAuthenticated:d,loading:u,currentUser:m}=l;if(i)return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Error"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with role verification. Please refresh the page."}),$.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})});if(u)return $.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),$.jsx("p",{className:"text-gray-600",children:"Loading..."})]})});try{if(!d)return localStorage.setItem("postLoginRedirect",window.location.pathname),$.jsx(o,{to:"/login"});const e=(null==m?void 0:m.role)?String(m.role):null;let a=!0;r&&r.length>0&&(a=!!(null==(s=m.permissions)?void 0:s.includes("all"))||r.some(e=>{var t;return null==(t=m.permissions)?void 0:t.includes(e)}));const i=e&&n.includes(e);return m&&(i||a)?$.jsx($.Fragment,{children:t}):$.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:$.jsxs("div",{className:"text-center",children:[$.jsx("div",{className:"text-red-600 mb-4",children:$.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:$.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),$.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Denied"}),$.jsx("p",{className:"text-gray-600 mb-4",children:"You don't have permission to access this page."}),$.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:[!i&&"Required role: "+n.join(", "),r&&r.length>0&&" or permission: "+r.join(", ")]}),$.jsx("button",{onClick:()=>window.history.back(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Go Back"})]})})}catch(iu){return c(!0),null}},Jd=({isOnline:t,isSyncing:a})=>{let r,s;try{r=co()}catch(iu){}try{s=ro()}catch(iu){}return wl(),e.useEffect(()=>{(async()=>{var e;try{const{data:t,error:a}=await $a.from("settings").select("*").limit(1);return a&&!(null==(e=a.message)?void 0:e.includes("does not exist"))?{success:!1,error:a}:{success:!0,data:t}}catch(iu){return{success:!1,error:iu}}})().catch(console.error)},[]),e.useEffect(()=>{t&&async function(){try{if(!(null==r?void 0:r.addCustomer)||!(null==s?void 0:s.assignToTechnician)||!(null==s?void 0:s.updateDeviceStatus))return;const a=await async function(){return(await gl()).getAll(pl)}();for(const n of a)try{if("submitData"===n.type)try{await fetch("/api/endpoint",{method:"POST",body:JSON.stringify(n.payload)})}catch(e){continue}else if("createCustomerFromSearch"===n.type)await r.addCustomer(n.payload);else if("adjustPoints"===n.type){const{operation:e,pointsToAdjust:t,reason:a,customerId:s}=n.payload,i="add"===e?Math.abs(t):-Math.abs(t);if(null==r?void 0:r.updateCustomer){const n=r.customers.find(e=>e.id===s);if(n){const o=(n.points||0)+i;await r.updateCustomer(s,{points:o}),r.addNote&&await r.addNote(s,`${"add"===e?"Added":"Subtracted"} ${Math.abs(t)} points - ${a}`)}}}else if("assignTechnician"===n.type){const{deviceId:e,selectedTechId:t}=n.payload;await s.assignToTechnician(e,t,"")}else if("markDeviceFailed"===n.type){const{deviceId:e,remark:t}=n.payload;await s.updateDeviceStatus(e,"failed",t||"")}}catch(t){}a.length>0&&await async function(){const e=(await gl()).transaction(pl,"readwrite");await e.store.clear(),await e.done}()}catch(iu){}}()},[t,r,s]),$.jsxs($.Fragment,{children:[!t&&$.jsx("div",{style:{background:"#f87171",color:"white",padding:"8px",textAlign:"center"},children:"You are offline. Changes will be saved and synced when you are back online."}),t&&a&&$.jsx("div",{style:{background:"#fbbf24",color:"black",padding:"8px",textAlign:"center"},children:"Syncing your offline changes..."}),$.jsxs(l,{children:[$.jsx(d,{path:"/login",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Sl,{})})}),$.jsxs(d,{path:"/",element:$.jsx(Kd,{children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Pl,{})})}),children:[$.jsx(d,{index:!0,element:$.jsx(o,{to:"/dashboard",replace:!0})}),$.jsx(d,{path:"/dashboard",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(xl,{})})}),$.jsx(d,{path:"/dashboard/admin",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx($d,{})})})}),$.jsx(d,{path:"/ad-generator",element:$.jsx(Bc,{fallback:Qd,children:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Bl,{})})})})}),$.jsx(d,{path:"/devices",element:$.jsx(Bc,{fallback:Qd,children:$.jsx(Yd,{allowedRoles:["admin","customer-care","technician"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(El,{})})})})}),$.jsx(d,{path:"/devices/new",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(kl,{})})})}),$.jsx(d,{path:"/category-management",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(zl,{})})})}),$.jsx(d,{path:"/supplier-management",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Dl,{})})})}),$.jsx(d,{path:"/store-locations",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Vl,{})})})}),$.jsx(d,{path:"/database-setup",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Wl,{})})})}),$.jsx(d,{path:"/backup-management",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Hl,{})})})}),$.jsx(d,{path:"/customers/import",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ql,{})})})}),$.jsx(d,{path:"/excel-import",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ql,{})})})}),$.jsx(d,{path:"/excel-templates",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Gl,{})})})}),$.jsx(d,{path:"/product-export",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Kl,{})})})}),$.jsx(d,{path:"/customers",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(Bc,{fallback:Qd,children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Il,{})})})})}),$.jsx(d,{path:"/customers/update",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Al,{})})})}),$.jsx(d,{path:"/settings",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Hd,{})})}),$.jsx(d,{path:"/sms",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Rl,{})})})}),$.jsx(d,{path:"/sms/bulk",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Fd,{})})})}),$.jsx(d,{path:"/sms/logs",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(zd,{})})})}),$.jsx(d,{path:"/sms/settings",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Vd,{})})})}),$.jsx(d,{path:"/admin-settings",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Cl,{})})})}),$.jsx(d,{path:"/integration-settings",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Wd,{})})})}),$.jsx(d,{path:"/integrations-test",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Tl,{})})})}),$.jsx(d,{path:"/users",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(jl,{})})})}),$.jsx(d,{path:"/payments",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ll,{})})})}),$.jsx(d,{path:"/expenses",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ol,{})})})}),$.jsx(d,{path:"/appointments",element:$.jsx(Yd,{allowedRoles:["admin","customer-care","technician"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ml,{})})})}),$.jsx(d,{path:"/reminders",element:$.jsx(Yd,{allowedRoles:["admin","customer-care","technician"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ul,{})})})}),$.jsx(d,{path:"/special-orders",element:$.jsx(Yd,{allowedRoles:["admin","sales","manager","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx($l,{})})})}),$.jsx(d,{path:"/installments",element:$.jsx(Yd,{allowedRoles:["admin","sales","manager","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Fl,{})})})}),$.jsx(d,{path:"/employees",element:$.jsx(Yd,{allowedRoles:["admin","manager"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(ql,{})})})}),$.jsx(d,{path:"/my-attendance",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Nl,{})})}),$.jsx(d,{path:"/employees/attendance",element:$.jsx(o,{to:"/employees?tab=attendance",replace:!0})}),$.jsx(d,{path:"/employees/attendance-management",element:$.jsx(o,{to:"/employees?tab=attendance-setup",replace:!0})}),$.jsx(d,{path:"/attendance",element:$.jsx(o,{to:"/employees?tab=attendance",replace:!0})}),$.jsx(d,{path:"/lats",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(fd,{})})})}),$.jsx(d,{path:"/pos",element:$.jsx(Bc,{fallback:Qd,children:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ld,{})})})})}),$.jsx(d,{path:"/lats/unified-inventory",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx($c,{children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Td,{})})})})}),$.jsx(d,{path:"/lats/inventory-management",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Od,{})})})}),$.jsx(d,{path:"/lats/storage-rooms",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(qd,{})})})}),$.jsx(d,{path:"/lats/storage-rooms/:id",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Nd,{})})})}),$.jsx(d,{path:"/lats/inventory",element:$.jsx(o,{to:"/lats/unified-inventory",replace:!0})}),$.jsx(d,{path:"/lats/products",element:$.jsx(o,{to:"/lats/unified-inventory",replace:!0})}),$.jsx(d,{path:"/lats/add-product",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(jd,{})})})}),$.jsx(d,{path:"/lats/bulk-import",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Rd,{})})})}),$.jsx(d,{path:"/lats/products/:productId/edit",element:$.jsx(zc,{enableImageUrlValidation:!0,enableUrlLogging:!1,children:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Dd,{})})})})}),$.jsx(d,{path:"/lats/sales-reports",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Id,{})})})}),$.jsx(d,{path:"/lats/loyalty",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ad,{})})})}),$.jsx(d,{path:"/lats/purchase-orders",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(yd,{})})})}),$.jsx(d,{path:"/lats/purchase-order/create",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(vd,{})})})}),$.jsx(d,{path:"/lats/purchase-orders/:id",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(wd,{})})})}),$.jsx(d,{path:"/lats/purchase-orders/:id/edit",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(wd,{editMode:!0})})})}),$.jsx(d,{path:"/test/set-pricing-modal",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(bd,{})})})}),$.jsx(d,{path:"/lats/purchase-orders/shipped-items",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Pd,{})})})}),$.jsx(d,{path:"/lats/purchase-orders/suppliers",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Cd,{})})})}),$.jsx(d,{path:"/lats/stock-transfers",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(xd,{})})})}),$.jsx(d,{path:"/lats/spare-parts",element:$.jsx(zc,{enableImageUrlValidation:!0,enableUrlLogging:!1,children:$.jsx(Yd,{allowedRoles:["admin","technician"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Sd,{})})})})}),$.jsx(d,{path:"/lats/trade-in/management",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(kd,{})})})}),$.jsx(d,{path:"/lats/trade-in/create",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ed,{})})})}),$.jsx(d,{path:"/lats/whatsapp-chat",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Ud,{})})})}),$.jsx(d,{path:"/lats/whatsapp-connection-manager",element:$.jsx(Yd,{allowedRoles:["admin"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Md,{})})})}),$.jsx(d,{path:"/bluetooth-printer",element:$.jsx(Yd,{allowedRoles:["admin","customer-care"],children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Bd,{})})})})]}),$.jsx(d,{path:"/customer-portal/login",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Yl,{})})}),$.jsx(d,{path:"/customer-portal/signup",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Jl,{})})}),$.jsx(d,{path:"/customer-portal/dashboard",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Xl,{})})}),$.jsx(d,{path:"/customer-portal/products",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(Zl,{})})}),$.jsx(d,{path:"/customer-portal/products/:id",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(ed,{})})}),$.jsx(d,{path:"/customer-portal/profile",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(td,{})})}),$.jsx(d,{path:"/customer-portal/orders",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(ad,{})})}),$.jsx(d,{path:"/customer-portal/loyalty",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(rd,{})})}),$.jsxs(d,{path:"/mobile",element:$.jsx(sl,{children:$.jsx(Kd,{children:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(id,{})})})}),children:[$.jsx(d,{index:!0,element:$.jsx(o,{to:"/mobile/dashboard",replace:!0})}),$.jsx(d,{path:"dashboard",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(od,{})})}),$.jsx(d,{path:"pos",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(cd,{})})}),$.jsx(d,{path:"inventory",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(ld,{})})}),$.jsx(d,{path:"inventory/add",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(dd,{})})}),$.jsx(d,{path:"inventory/:productId",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(pd,{})})}),$.jsx(d,{path:"clients",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(ud,{})})}),$.jsx(d,{path:"clients/:clientId",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(gd,{})})}),$.jsx(d,{path:"more",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(md,{})})}),$.jsx(d,{path:"analytics",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(hd,{})})}),$.jsx(d,{path:"sheet-demo",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(_d,{})})})]}),$.jsx(d,{path:"/test-image-upload",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(sd,{})})}),$.jsx(d,{path:"/background-removal",element:$.jsx(e.Suspense,{fallback:$.jsx(Nc,{}),children:$.jsx(nd,{})})}),$.jsx(d,{path:"*",element:$.jsx(il,{})})]})]})};function Xd(){["clean-app-cache","clean-app-offline-sync","user-goals","offline-cache","pending-actions"].forEach(e=>{const t=indexedDB.deleteDatabase(e);t.onsuccess=()=>{},t.onerror=()=>{}})}function Zd(){try{Xd(),localStorage.clear(),sessionStorage.clear()}catch(iu){}}function eu(){const[t,a]=e.useState(navigator.onLine),[r,s]=e.useState(!1);return e.useEffect(()=>{const e=sessionStorage.getItem(`scroll-pos-${window.location.pathname}`);e&&window.scrollTo(0,parseInt(e,10));const t=()=>{sessionStorage.setItem(`scroll-pos-${window.location.pathname}`,String(window.scrollY))};return window.addEventListener("beforeunload",t),window.addEventListener("popstate",t),()=>{window.removeEventListener("beforeunload",t),window.removeEventListener("popstate",t),t()}},[]),e.useEffect(()=>(hl.start(),()=>{hl.stop()}),[]),e.useEffect(()=>{ti()},[]),e.useEffect(()=>{const e=e=>{const t=document.documentElement;switch(e){case"tiny":t.style.fontSize="11px";break;case"extra-small":t.style.fontSize="12px";break;case"small":t.style.fontSize="14px";break;case"medium":t.style.fontSize="16px";break;case"large":t.style.fontSize="18px"}},t=localStorage.getItem("fontSize");e(t||"medium")},[]),e.useEffect(()=>{const e=e=>{e.reason&&e.reason.message&&e.reason.message.includes("Cannot convert object to primitive value")&&e.preventDefault()};return window.addEventListener("unhandledrejection",e),()=>{window.removeEventListener("unhandledrejection",e)}},[]),e.useEffect(()=>{"undefined"!=typeof window&&(window.clearAllDatabases=Zd,window.clearAllIndexedDB=Xd)},[]),e.useEffect(()=>{function e(){a(!0)}function t(){a(!1)}return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[]),$.jsxs(Bc,{children:[$.jsx(c,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:$.jsx(zo,{children:$.jsx(xn,{children:$.jsx(Pc,{children:$.jsx(En,{children:$.jsx(Pn,{children:$.jsx(Ec,{children:$.jsx(so,{children:$.jsx(lo,{children:$.jsx(go,{children:$.jsx($o,{children:$.jsx(Sc,{children:$.jsx(Ho,{children:$.jsx(fc,{children:$.jsx(cl,{children:$.jsx(ul,{children:$.jsx(vl,{children:$.jsxs(nl,{children:[$.jsx(Jd,{isOnline:t,isSyncing:r}),$.jsx(Gd,{}),$.jsx(yl,{}),$.jsx(jc,{})]})})})})})})})})})})})})})})})})})}),$.jsx(j,{position:"top-right",toastOptions:{duration:4e3,style:{background:"#363636",color:"#fff"},success:{duration:3e3,iconTheme:{primary:"#10B981",secondary:"#fff"}},error:{duration:5e3,iconTheme:{primary:"#EF4444",secondary:"#fff"}}}})]})}const tu={log:console.log,info:console.info,warn:console.warn,debug:console.debug},au=[/AudioContext.*not allowed to start/i,/AudioContext.*user gesture/i,/POST.*neon\.tech.*400/i,/WebSocket connection.*neon\.tech.*failed/i,/network connection was lost/i,/^Auth state changed:/,/PaymentMethodsContext.*Starting/i,/PaymentMethodsContext.*Loaded/i,/Payment methods refreshed/i,/FinanceAccountService.*Fetching/i,/FinanceAccountService.*Supabase/i,/FinanceAccountService.*Query result/i,/FinanceAccountService.*Fetched/i,/FinanceAccountService.*First method/i,/Using deduplicated.*query/i,//,/FETCHING SALES/i,/Current Branch:/,/Branch Name:/,/APPLYING BRANCH FILTER/i,/Filter: branch_id/,/SALES RETURNED:/i,/SAMPLE SALES/i,/SALE-.*TZS/,/Loaded.*POS sales/i,/Active session found/i,/^\[Analytics\]/,/^ \[.*\]/,/^ \[.*\]/,/^ \[SimpleBranchSelector\]/,/^ Loading branches/,/^ \[EnhancedInventoryTab\]/,/^ Suppliers/,/^ \[LiveInventoryService\]/,/^ \[formatCurrency\]/,/^ \[PurchaseOrdersPage\]/,/^ System view mode/,/^ Device Detection/,/^ \[POS\]/,/^ Session started/,/^ Starting supplier/,/^ Using cached/,/^ Branches loaded/,/^ Products loaded/],ru=/^[\u{1F300}-\u{1F9FF}]/u,su=[/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/];function nu(e,...t){let a="";t.length>0&&(a=t.map(e=>"string"==typeof e?e:"number"==typeof e?String(e):"object"==typeof e?JSON.stringify(e):String(e)).join(" ")),function(e,t){if("undefined"!=typeof localStorage&&"true"===localStorage.getItem("DEBUG_MODE"))return!1;for(const a of au)if(a.test(e))return!0;if(ru.test(e))return!0;if(t)for(const a of su)if(a.test(e))return!0;return!1}(a,!0)||tu[e](...t)}!function(){if("undefined"==typeof window)return;console.log=(...e)=>nu("log",...e),console.info=(...e)=>nu("info",...e),console.warn=(...e)=>nu("warn",...e),console.debug=(...e)=>nu("debug",...e);const e=console.error;console.error=(...t)=>{const a=t.join(" ");a.includes("neon.tech")&&(a.includes("400")||a.includes("Bad Request"))||a.includes("WebSocket")&&a.includes("neon.tech")||a.includes("network connection was lost")||e(...t)}}(),tu.log(" Console filter initialized - debug logs will be suppressed"),"undefined"!=typeof window&&(window.addEventListener("error",e=>{if(e.message&&(e.message.includes("neon.tech")||e.message.includes("400")||e.message.includes("Bad Request")||e.message.includes("WebSocket")&&e.message.includes("neon.tech")||e.message.includes("network connection was lost")))return e.preventDefault(),!1},!0),window.addEventListener("unhandledrejection",e=>{if(e.reason&&"object"==typeof e.reason){const t=JSON.stringify(e.reason);if(t.includes("neon.tech")&&(t.includes("400")||t.includes("WebSocket")))return e.preventDefault(),!1}if("string"==typeof e.reason&&(e.reason.includes("neon.tech")||e.reason.includes("network connection was lost")))return e.preventDefault(),!1}));F.createRoot(document.getElementById("root")).render($.jsx(r.StrictMode,{children:$.jsx(eu,{})})),"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{}).catch(e=>{})}):navigator;export{Ti as $,Vi as A,Wi as B,tc as C,Va as D,So as E,Io as F,Mc as G,yo as H,bo as I,wo as J,Rc as K,Oc as L,Bi as M,bc as N,Zs as O,us as P,ds as Q,ms as R,Bc as S,di as T,mi as U,Xi as V,pi as W,ui as X,hi as Y,Hi as Z,Pi as _,co as a,Ri as a0,wl as a1,Fn as a2,Is as a3,Es as a4,ls as a5,rl as a6,Cn as a7,qo as a8,No as a9,Fa as aA,ss as aB,hc as aC,mc as aD,cs as aE,ac as aF,sc as aG,nc as aH,ic as aI,oc as aJ,Ya as aK,hs as aL,dl as aM,rc as aN,za as aO,Wa as aP,Ja as aQ,ws as aR,yn as aS,Gi as aT,Yi as aU,Oo as aV,vc as aW,Mo as aa,Uo as ab,gs as ac,vs as ad,ys as ae,fs as af,_s as ag,Os as ah,Js as ai,_c as aj,xs as ak,As as al,Ss as am,an,Ns as ao,un as ap,mn as aq,Ra as ar,ks as as,rn as at,or as au,Br as av,zr as aw,Wr as ax,pc as ay,is as az,ro as b,vn as c,Uc as d,_l as e,gn as f,Ni as g,pn as h,Ai as i,$ as j,_n as k,ni as l,ji as m,Di as n,Ci as o,Ki as p,Vo as q,fn as r,$a as s,yc as t,bn as u,In as v,Ac as w,Qi as x,Mi as y,zi as z};
