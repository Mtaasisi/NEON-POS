import{j as e,d as t,G as s,s as n}from"./index-222cfb29.js";import{r as a}from"./vendor-a2ff445a.js";import{u as i,X as r,A as o,U as l,f as c,n as d}from"./ui-551a39a6.js";import{u as m,S as u}from"./useSuccessModal-e8b7d685.js";import{S as p}from"./SuccessModalIcons-20b743c5.js";import{f as x}from"./appointments-4d8aac45.js";import{u as h}from"./useBodyScrollLock-0216d39f.js";const g=({isOpen:g,onClose:b,customer:f,appointment:v,onSave:j,mode:y})=>{const[N,w]=a.useState({customer_id:(null==f?void 0:f.id)||"",service_type:"",appointment_date:"",appointment_time:"",notes:"",duration_minutes:60,priority:"medium",location:"",technician_id:""}),[_,S]=a.useState(!1),[C,k]=a.useState(null),[D,T]=a.useState(null),[A,P]=a.useState([]),[$,E]=a.useState([]),[M,I]=a.useState(""),U=m();a.useEffect(()=>{g&&(async()=>{try{const{data:e}=await n.from("users").select("id, full_name, name").in("role",["tech","technician","admin","manager"]).order("full_name");P((null==e?void 0:e.map(e=>({id:e.id,name:e.full_name||e.name||"Unknown"})))||[]);const{data:t}=await n.from("customers").select("id, name, phone").limit(50).order("name");E(t||[])}catch(e){}})()},[g]),a.useEffect(()=>{const e=setTimeout(async()=>{if(M&&!(M.length<2))try{const{data:e}=await n.from("customers").select("id, name, phone").or(`name.ilike.%${M}%,phone.ilike.%${M}%`).limit(20).order("name");e&&E(e)}catch(e){}},300);return()=>clearTimeout(e)},[M]),a.useEffect(()=>{g&&("edit"===y&&v?w({customer_id:v.customer_id,service_type:v.service_type,appointment_date:v.appointment_date,appointment_time:v.appointment_time,notes:v.notes||"",duration_minutes:v.duration_minutes,priority:v.priority,location:v.location||"",technician_id:v.technician_id||""}):"create"===y&&f&&w({customer_id:f.id,service_type:"",appointment_date:"",appointment_time:"",notes:"",duration_minutes:60,priority:"medium",location:"",technician_id:""}),k(null))},[g,y,v,f]);a.useEffect(()=>{N.appointment_date&&N.appointment_time&&(async()=>{if(N.appointment_date&&N.appointment_time)try{const e=await x(),t=new Date(`${N.appointment_date}T${N.appointment_time}`),s=new Date(t.getTime()+6e4*(N.duration_minutes||60)),n=e.filter(e=>{if("edit"===y&&v&&e.id===v.id)return!1;const n=new Date(`${e.appointment_date}T${e.appointment_time}`),a=new Date(n.getTime()+6e4*(e.duration_minutes||60));return t<a&&s>n});n.length>0?T(`âš ï¸ Warning: ${n.length} overlapping appointment(s) found at this time.`):T(null)}catch(e){}})()},[N.appointment_date,N.appointment_time,N.duration_minutes]);return h(g),g?e.jsxs("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:[e.jsxs(t,{className:"w-full max-w-2xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-white/20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center",children:e.jsx(i,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"create"===y?"New Appointment":"Edit Appointment"}),e.jsx("p",{className:"text-sm text-gray-600",children:"create"===y?"Schedule a new customer appointment":"Update appointment details"})]})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",type:"button",children:e.jsx(r,{className:"w-5 h-5 text-gray-500"})})]}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),S(!0),k(null);try{if(!(N.customer_id&&N.service_type&&N.appointment_date&&N.appointment_time))throw new Error("Please fill in all required fields");if(await j(N),"create"===y){const e=new Date(N.appointment_date).toLocaleDateString();U.show(`Appointment for ${(null==f?void 0:f.name)||"customer"} has been scheduled on ${e} at ${N.appointment_time}!`,{title:"Appointment Booked! ðŸ“…",icon:p.appointmentBooked,autoCloseDelay:3e3})}else U.show("Appointment has been updated successfully!",{title:"Appointment Updated! âœ…",icon:p.appointmentBooked,autoCloseDelay:3e3});b()}catch(t){const e=t instanceof Error?t.message:"Failed to save appointment";k(e),d.error(e)}finally{S(!1)}},className:"p-6 space-y-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:[C&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("span",{className:"text-sm text-red-700",children:C})}),D&&e.jsxs("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-2",children:[e.jsx(o,{className:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-yellow-700",children:D})]}),f?e.jsxs("div",{className:"p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx(l,{className:"w-4 h-4 text-white"})}),e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Customer Information"})]}),e.jsxs("div",{className:"text-sm text-gray-900 ml-10",children:[e.jsx("p",{className:"font-semibold text-base",children:f.name}),e.jsx("p",{className:"text-gray-600 mt-1",children:f.phone}),f.email&&e.jsx("p",{className:"text-gray-600",children:f.email})]})]}):e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Customer ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(l,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 z-10"}),e.jsx("input",{type:"text",value:M,onChange:e=>I(e.target.value),placeholder:"Type name or phone to search...",className:"w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",autoComplete:"off"})]}),M&&$.length>0&&e.jsx("div",{className:"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-lg",children:$.map(t=>e.jsxs("button",{type:"button",onClick:()=>{w(e=>({...e,customer_id:t.id})),I(`${t.name} - ${t.phone}`)},className:"w-full px-4 py-3 text-left hover:bg-blue-50 border-b border-gray-100 last:border-b-0 transition-colors",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:t.name}),e.jsxs("div",{className:"text-xs text-gray-600 flex items-center gap-1 mt-0.5",children:[e.jsx(l,{className:"w-3 h-3"}),t.phone]})]},t.id))}),M&&0===$.length&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"No customers found. Try a different search."}),!N.customer_id&&M&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:"Please select a customer from the list"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Service Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:N.service_type,onChange:e=>w(t=>({...t,service_type:e.target.value})),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",required:!0,children:[e.jsx("option",{value:"",children:"-- Select Service Type --"}),e.jsxs("optgroup",{label:"ðŸ“‹ Consultations & Meetings",children:[e.jsx("option",{value:"Consultation",children:"Consultation"}),e.jsx("option",{value:"Product Demonstration",children:"Product Demonstration"}),e.jsx("option",{value:"Business Meeting",children:"Business Meeting"}),e.jsx("option",{value:"Follow-up Appointment",children:"Follow-up Appointment"})]}),e.jsxs("optgroup",{label:"ðŸšš Sales & Service",children:[e.jsx("option",{value:"Product Delivery",children:"Product Delivery"}),e.jsx("option",{value:"Product Installation",children:"Product Installation"}),e.jsx("option",{value:"Product Pickup",children:"Product Pickup"}),e.jsx("option",{value:"Service Maintenance",children:"Service Maintenance"})]}),e.jsxs("optgroup",{label:"ðŸ”§ Technical Services",children:[e.jsx("option",{value:"Device Repair",children:"Device Repair"}),e.jsx("option",{value:"Device Diagnosis",children:"Device Diagnosis"}),e.jsx("option",{value:"Software Installation",children:"Software Installation"}),e.jsx("option",{value:"Hardware Upgrade",children:"Hardware Upgrade"}),e.jsx("option",{value:"Data Recovery",children:"Data Recovery"}),e.jsx("option",{value:"Virus Removal",children:"Virus Removal"}),e.jsx("option",{value:"Network Setup",children:"Network Setup"}),e.jsx("option",{value:"System Configuration",children:"System Configuration"})]}),e.jsxs("optgroup",{label:"ðŸ“š Training & Support",children:[e.jsx("option",{value:"Training Session",children:"Training Session"}),e.jsx("option",{value:"Customer Support",children:"Customer Support"}),e.jsx("option",{value:"Technical Support",children:"Technical Support"})]}),e.jsxs("optgroup",{label:"ðŸ“¦ Other Services",children:[e.jsx("option",{value:"General Service",children:"General Service"}),e.jsx("option",{value:"Custom Service",children:"Custom Service (Specify in notes)"})]})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Choose the type of service for this appointment"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Appointment Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(i,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none z-10"}),e.jsx("input",{type:"date",value:N.appointment_date,onChange:e=>w(t=>({...t,appointment_date:e.target.value})),min:(new Date).toISOString().split("T")[0],className:"w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Appointment Time ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(c,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none z-10"}),e.jsx("input",{type:"time",value:N.appointment_time,onChange:e=>w(t=>({...t,appointment_time:e.target.value})),className:"w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",required:!0})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Duration (minutes)"}),e.jsx("input",{type:"number",value:N.duration_minutes,onChange:e=>w(t=>({...t,duration_minutes:parseInt(e.target.value)||60})),min:"15",step:"15",placeholder:"60",className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Duration in 15-minute increments"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Priority Level"}),e.jsxs("select",{value:N.priority,onChange:e=>w(t=>({...t,priority:e.target.value})),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",children:[e.jsx("option",{value:"low",children:"ðŸŸ¢ Low Priority"}),e.jsx("option",{value:"medium",children:"ðŸŸ¡ Medium Priority"}),e.jsx("option",{value:"high",children:"ðŸŸ  High Priority"}),e.jsx("option",{value:"urgent",children:"ðŸ”´ Urgent"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Assign Technician"}),e.jsxs("select",{value:N.technician_id,onChange:e=>w(t=>({...t,technician_id:e.target.value})),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",children:[e.jsx("option",{value:"",children:"-- No Assignment --"}),A.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Optional - can assign later"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Service Location"}),e.jsx("input",{type:"text",value:N.location,onChange:e=>w(t=>({...t,location:e.target.value})),placeholder:"Shop, Customer's Home, Office...",className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Additional Notes"}),e.jsx("textarea",{value:N.notes,onChange:e=>w(t=>({...t,notes:e.target.value})),rows:3,placeholder:"Add any special instructions or notes for this appointment...",className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsx(s,{type:"button",variant:"secondary",onClick:b,disabled:_,className:"min-w-[100px]",children:"Cancel"}),e.jsx(s,{type:"submit",variant:"primary",disabled:_,loading:_,onClick:e=>{const t=document.querySelector("form");if(t){const e=new Event("submit",{bubbles:!0,cancelable:!0});t.dispatchEvent(e)}},className:"min-w-[100px]",children:_?"Saving...":"create"===y?"Create Appointment":"Update Appointment"})]})]}),e.jsx(u,{...U.props})]}):null};export{g as A};
