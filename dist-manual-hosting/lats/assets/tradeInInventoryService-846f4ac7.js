import{s as e}from"./index-222cfb29.js";import"./vendor-a2ff445a.js";import"./supabase-7e851d02.js";import"./routing-a2f0f6d2.js";import"./ui-551a39a6.js";const t=async()=>{try{const t=localStorage.getItem("current_branch_id"),{data:a}=await e.from("lats_categories").select("id").eq("name","Trade-In Items").maybeSingle();if(a)return a.id;const{data:i,error:r}=await e.from("lats_categories").insert({name:"Trade-In Items",description:"Devices acquired through trade-in transactions",branch_id:t,is_active:!0}).select("id").single();if(!r&&i)return i.id;const{data:n}=await e.from("lats_categories").select("id").limit(1).single();if(n)return n.id;throw new Error("No categories available in database")}catch(t){try{const{data:t}=await e.from("lats_categories").select("id").limit(1).single();if(t)return t.id}catch(a){}throw new Error("Failed to get or create category for trade-in")}},a=async t=>{var a,i,r,n,s,d,o,c,_,l,u;const{transaction:m,categoryId:v,locationId:p,needsRepair:f=!1,repairNotes:y,resalePrice:g}=t;try{const{data:t}=await e.auth.getUser(),p=localStorage.getItem("current_branch_id")||m.branch_id;let y=null;if(null==(a=null==t?void 0:t.user)?void 0:a.id){const{data:a}=await e.from("profiles").select("role").eq("id",t.user.id).single();y=null==a?void 0:a.role}const q="admin"===y;if(!q&&"completed"!==m.status&&"approved"!==m.status)throw new Error(`Only completed or approved trade-in transactions can be added to inventory. Current status: ${m.status}. Please complete the transaction first in Trade-In Management.`);if(q&&m.status,m.device_imei){const{data:t}=await e.from("lats_product_variants").select("id, product_id, variant_attributes").filter("variant_attributes->imei","eq",m.device_imei).maybeSingle();if(t)throw new Error(`Device with IMEI ${m.device_imei} already exists in inventory. Cannot add duplicate devices.`)}const b=`${m.device_name} - ${m.device_model} (Trade-In)`,I=`TI-${Date.now()}-${m.device_imei||"NOIMEI"}`,$=(null==(i=m.customer)?void 0:i.name)||`${(null==(r=m.customer)?void 0:r.first_name)||""} ${(null==(n=m.customer)?void 0:n.last_name)||""}`.trim()||"Trade-In Customer";let S=null;try{const{data:t}=await e.from("lats_suppliers").select("id").eq("name",`Trade-In: ${$}`).maybeSingle();if(t)S=t.id;else{const{data:t}=await e.from("lats_suppliers").insert({name:`Trade-In: ${$}`,contact_person:$,phone:(null==(s=m.customer)?void 0:s.phone)||(null==(d=m.customer)?void 0:d.mobile),email:null==(o=m.customer)?void 0:o.email,is_active:!0,is_trade_in_customer:!0}).select("id").single();S=null==t?void 0:t.id}}catch(w){}const{data:k}=await e.from("lats_products").select("id, name, stock_quantity").eq("name",b).eq("branch_id",p).maybeSingle();let E;if(k)E=k,await e.from("lats_products").update({stock_quantity:(k.stock_quantity||0)+1,updated_at:(new Date).toISOString()}).eq("id",k.id);else{const{data:t,error:a}=await e.from("lats_products").insert({name:b,description:`Trade-in devices - ${m.device_name} ${m.device_model}`,sku:`TI-${m.device_name}-${m.device_model}`.replace(/\s+/g,"-"),category_id:v,branch_id:p,supplier_id:S,cost_price:m.final_trade_in_value,selling_price:g||1.2*m.final_trade_in_value,stock_quantity:1,min_stock_level:0,is_active:!f,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}).select().single();if(a)throw a;E=t}let T=null;if(m.device_imei){const{data:t}=await e.from("lats_product_variants").select("id, variant_name, is_parent, variant_type").eq("product_id",E.id).or("is_parent.eq.true,variant_type.eq.parent").is("parent_variant_id",null).limit(1);t&&t.length>0&&(T=t[0].id)}const D={product_id:E.id,variant_name:m.device_imei?`IMEI: ${m.device_imei}`:`Unit ${Date.now()}`,sku:I,cost_price:m.final_trade_in_value,selling_price:g||1.2*m.final_trade_in_value,quantity:1,is_active:!f,variant_attributes:{imei:m.device_imei,serial_number:m.device_serial_number,condition:m.condition_rating,trade_in_transaction:m.id,transaction_number:m.transaction_number,original_owner:m.customer_id,customer_name:$,customer_phone:(null==(c=m.customer)?void 0:c.phone)||(null==(_=m.customer)?void 0:_.mobile),damage_items:m.damage_items,source:"trade-in"},branch_id:p};T&&m.device_imei&&(D.parent_variant_id=T,D.variant_type="imei_child",D.is_parent=!1);const{data:F,error:O}=await e.from("lats_product_variants").insert(D).select().single();if(O)throw O;const R={new_product_id:E.id,new_variant_id:F.id,needs_repair:f,repair_status:f?"pending":"completed",ready_for_resale:!f,resale_price:g||1.2*m.final_trade_in_value};"approved"!==m.status&&"pending"!==m.status||(R.status="completed",R.completed_at=(new Date).toISOString());const{error:j}=await e.from("lats_trade_in_transactions").update(R).eq("id",m.id);try{await e.from("lats_stock_movements").insert({product_id:E.id,variant_id:F.id,branch_id:p,movement_type:"trade_in",quantity:1,reference_type:"trade_in_transaction",reference_id:m.id,notes:`Trade-in from customer: ${(null==(l=m.customer)?void 0:l.name)||"Unknown"}`,created_by:null==(u=null==t?void 0:t.user)?void 0:u.id})}catch(h){}return{success:!0,data:{product:E,variant:F}}}catch(q){return{success:!1,error:q instanceof Error?q.message:"Failed to add device to inventory"}}},i=async(t,a,i,r)=>{try{const n={repair_status:a};if(void 0!==i&&(n.repair_cost=i),"completed"===a){n.ready_for_resale=!0;const{data:a}=await e.from("lats_trade_in_transactions").select("inventory_item_id, resale_price, final_trade_in_value").eq("id",t).single();if(null==a?void 0:a.inventory_item_id){await e.from("lats_inventory_items").update({status:"available",notes:`Repair completed. ${r||""}`}).eq("id",a.inventory_item_id);const{data:t}=await e.from("lats_inventory_items").select("product_id, variant_id").eq("id",a.inventory_item_id).single();if(t&&(await e.from("lats_products").update({is_active:!0}).eq("id",t.product_id),await e.from("lats_product_variants").update({is_active:!0}).eq("id",t.variant_id)),i&&a.final_trade_in_value){const r=1.3*(a.final_trade_in_value+i);n.resale_price=r,t&&(await e.from("lats_products").update({selling_price:r}).eq("id",t.product_id),await e.from("lats_product_variants").update({selling_price:r}).eq("id",t.variant_id))}}}const{data:s,error:d}=await e.from("lats_trade_in_transactions").update(n).eq("id",t).select().single();if(d)throw d;return{success:!0,data:s}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Failed to update repair status"}}},r=async(t,a)=>{try{const{error:i}=await e.from("lats_trade_in_transactions").update({ready_for_resale:!0,resale_price:a}).eq("id",t);if(i)throw i;const{data:r}=await e.from("lats_trade_in_transactions").select("inventory_item_id").eq("id",t).single();if(null==r?void 0:r.inventory_item_id){const{data:t}=await e.from("lats_inventory_items").select("product_id, variant_id").eq("id",r.inventory_item_id).single();t&&(await e.from("lats_products").update({selling_price:a,is_active:!0}).eq("id",t.product_id),await e.from("lats_product_variants").update({selling_price:a,is_active:!0}).eq("id",t.variant_id),await e.from("lats_inventory_items").update({status:"available"}).eq("id",r.inventory_item_id))}return{success:!0}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Failed to mark device ready for resale"}}},n=async t=>{try{let a=e.from("lats_trade_in_transactions").select("\n        *,\n        customer:lats_customers(id, name, phone),\n        inventory_item:lats_inventory_items(\n          *,\n          product:lats_products(id, name, sku, selling_price),\n          variant:lats_product_variants(id, variant_name, selling_price)\n        )\n      ").not("inventory_item_id","is",null).order("created_at",{ascending:!1});void 0!==(null==t?void 0:t.needsRepair)&&(a=a.eq("needs_repair",t.needsRepair)),void 0!==(null==t?void 0:t.readyForResale)&&(a=a.eq("ready_for_resale",t.readyForResale)),(null==t?void 0:t.branchId)&&(a=a.eq("branch_id",t.branchId));const{data:i,error:r}=await a;if(r)throw r;return{success:!0,data:i}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch devices"}}};export{a as addTradeInDeviceToInventory,t as getOrCreateTradeInCategory,n as getTradeInDevicesInInventory,r as markDeviceReadyForResale,i as updateTradeInRepairStatus};
