import{ar as e,s as t,as as a,u as r,j as s,d as n,G as i}from"./index-222cfb29.js";import{r as l,R as d}from"./vendor-a2ff445a.js";import{c}from"./routing-a2f0f6d2.js";import{z as o,R as u,Q as m,y as x,x as h,a7 as v,cx as p,q as f,az as b,X as g,Y as y,d as _,f as j,h as N,ay as w,e as q}from"./ui-551a39a6.js";import{P as k}from"./PageHeader-9450e930.js";import"./supabase-7e851d02.js";async function C(e){const{data:a,error:r}=await t.from("store_locations").select("id, is_active").eq("id",e).single();if(r||!a)throw new Error(`Branch not found: ${e}`);if(!a.is_active)throw new Error("Branch is not active");return!0}const $=async(t,a)=>{try{let r;r=t&&a&&"all"!==a?await(e`
        SELECT 
          bt.*,
          json_build_object(
            'id', fb.id, 
            'name', fb.name, 
            'code', fb.code, 
            'city', fb.city, 
            'is_active', fb.is_active
          ) as from_branch,
          json_build_object(
            'id', tb.id, 
            'name', tb.name, 
            'code', tb.code, 
            'city', tb.city, 
            'is_active', tb.is_active
          ) as to_branch,
          json_build_object(
            'id', pv.id,
            'variant_name', pv.variant_name,
            'sku', pv.sku,
            'quantity', pv.quantity,
            'reserved_quantity', pv.reserved_quantity,
            'product_id', pv.product_id,
            'product', json_build_object(
              'id', p.id,
              'name', p.name,
              'sku', p.sku
            )
          ) as variant
        FROM branch_transfers bt
        LEFT JOIN store_locations fb ON bt.from_branch_id = fb.id
        LEFT JOIN store_locations tb ON bt.to_branch_id = tb.id
        LEFT JOIN lats_product_variants pv ON bt.entity_id = pv.id
        LEFT JOIN lats_products p ON pv.product_id = p.id
        WHERE bt.transfer_type = 'stock'
        AND (bt.from_branch_id = ${t} OR bt.to_branch_id = ${t})
        AND bt.status = ${a}
        ORDER BY bt.created_at DESC
      `):t?await(e`
        SELECT 
          bt.*,
          json_build_object(
            'id', fb.id, 
            'name', fb.name, 
            'code', fb.code, 
            'city', fb.city, 
            'is_active', fb.is_active
          ) as from_branch,
          json_build_object(
            'id', tb.id, 
            'name', tb.name, 
            'code', tb.code, 
            'city', tb.city, 
            'is_active', tb.is_active
          ) as to_branch,
          json_build_object(
            'id', pv.id,
            'variant_name', pv.variant_name,
            'sku', pv.sku,
            'quantity', pv.quantity,
            'reserved_quantity', pv.reserved_quantity,
            'product_id', pv.product_id,
            'product', json_build_object(
              'id', p.id,
              'name', p.name,
              'sku', p.sku
            )
          ) as variant
        FROM branch_transfers bt
        LEFT JOIN store_locations fb ON bt.from_branch_id = fb.id
        LEFT JOIN store_locations tb ON bt.to_branch_id = tb.id
        LEFT JOIN lats_product_variants pv ON bt.entity_id = pv.id
        LEFT JOIN lats_products p ON pv.product_id = p.id
        WHERE bt.transfer_type = 'stock'
        AND (bt.from_branch_id = ${t} OR bt.to_branch_id = ${t})
        ORDER BY bt.created_at DESC
      `):await(e`
        SELECT 
          bt.*,
          json_build_object(
            'id', fb.id, 
            'name', fb.name, 
            'code', fb.code, 
            'city', fb.city, 
            'is_active', fb.is_active
          ) as from_branch,
          json_build_object(
            'id', tb.id, 
            'name', tb.name, 
            'code', tb.code, 
            'city', tb.city, 
            'is_active', tb.is_active
          ) as to_branch,
          json_build_object(
            'id', pv.id,
            'variant_name', pv.variant_name,
            'sku', pv.sku,
            'quantity', pv.quantity,
            'reserved_quantity', pv.reserved_quantity,
            'product_id', pv.product_id,
            'product', json_build_object(
              'id', p.id,
              'name', p.name,
              'sku', p.sku
            )
          ) as variant
        FROM branch_transfers bt
        LEFT JOIN store_locations fb ON bt.from_branch_id = fb.id
        LEFT JOIN store_locations tb ON bt.to_branch_id = tb.id
        LEFT JOIN lats_product_variants pv ON bt.entity_id = pv.id
        LEFT JOIN lats_products p ON pv.product_id = p.id
        WHERE bt.transfer_type = 'stock'
        ORDER BY bt.created_at DESC
      `);const s=Array.isArray(r)?r:(null==r?void 0:r.rows)||[];return s&&s.length,s||[]}catch(r){return[]}},S=async(e,r)=>{var s;try{if(await C(e.from_branch_id),await C(e.to_branch_id),e.from_branch_id===e.to_branch_id)throw new Error("Cannot transfer to the same branch");const n=await async function(e,a,r){const{data:s,error:n}=await t.rpc("check_duplicate_transfer",{p_from_branch_id:e,p_to_branch_id:a,p_entity_id:r});return!n&&!0===s}(e.from_branch_id,e.to_branch_id,e.entity_id);if(n)throw new Error("A pending transfer for this product between these branches already exists");const{data:i,error:l}=await t.from("lats_product_variants").select("quantity, reserved_quantity, branch_id, variant_name, sku, is_parent, variant_type").eq("id",e.entity_id).single();if(l)throw new Error("Product variant not found");let d=i.quantity,c=i.reserved_quantity||0;if(i.is_parent||"parent"===i.variant_type){const{data:a}=await t.from("lats_product_variants").select("quantity, reserved_quantity").eq("parent_variant_id",e.entity_id).eq("is_active",!0);a&&a.length>0&&(d=a.reduce((e,t)=>e+(t.quantity||0),0),c=a.reduce((e,t)=>e+(t.reserved_quantity||0),0))}const o=d-c;if(o<e.quantity)throw new Error(`Insufficient available stock. Total: ${d}, Reserved: ${c}, Available: ${o}, Requested: ${e.quantity}`);if(i.branch_id!==e.from_branch_id)throw new Error("Product variant does not belong to the source branch");const{error:u}=await t.rpc("reserve_variant_stock",{p_variant_id:e.entity_id,p_quantity:e.quantity});if(u)throw new Error(`Failed to reserve stock: ${u.message}`);const{data:m,error:x}=await t.from("branch_transfers").insert({from_branch_id:e.from_branch_id,to_branch_id:e.to_branch_id,transfer_type:"stock",entity_type:e.entity_type,entity_id:e.entity_id,quantity:e.quantity,status:"pending",requested_by:r,notes:e.notes,requested_at:(new Date).toISOString(),metadata:{}}).select("*").single();if(x)throw await t.rpc("release_variant_stock",{p_variant_id:e.entity_id,p_quantity:e.quantity}),x;const[h,v,p]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",m.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",m.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",m.entity_id).single()]);let f=null;if(null==(s=p.data)?void 0:s.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",p.data.product_id).single();f=e}const b={...m,from_branch:h.data,to_branch:v.data,variant:p.data?{...p.data,product:f}:null};return a.emit("lats:stock.updated",{variantId:e.entity_id,action:"transfer_created",quantity:e.quantity,reserved:!0}),b}catch(n){throw n}},T=async(e,a)=>{var r;try{const{data:s,error:n}=await t.from("branch_transfers").select("requested_by, status").eq("id",e).single();if(n||!s)throw new Error("Transfer not found");if("pending"!==s.status)throw new Error(`Cannot approve transfer with status: ${s.status}`);const{data:i,error:l}=await t.from("branch_transfers").update({status:"approved",approved_by:a,approved_at:(new Date).toISOString()}).eq("id",e).select("*").single();if(l)throw l;const[d,c,o]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",i.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",i.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",i.entity_id).single()]);let u=null;if(null==(r=o.data)?void 0:r.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",o.data.product_id).single();u=e}return{...i,from_branch:d.data,to_branch:c.data,variant:o.data?{...o.data,product:u}:null}}catch(s){throw s}},E=async(e,r,s)=>{var n;try{const{data:i,error:l}=await t.from("branch_transfers").select("entity_id, quantity, status").eq("id",e).single();if(l||!i)throw new Error("Transfer not found");if("pending"!==i.status)throw new Error(`Cannot reject transfer with status: ${i.status}`);await t.rpc("release_variant_stock",{p_variant_id:i.entity_id,p_quantity:i.quantity});const{data:d,error:c}=await t.from("branch_transfers").update({status:"rejected",approved_by:r,approved_at:(new Date).toISOString(),rejection_reason:s||null}).eq("id",e).select("*").single();if(c)throw c;const[o,u,m]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",d.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",d.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",d.entity_id).single()]);let x=null;if(null==(n=m.data)?void 0:n.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",m.data.product_id).single();x=e}const h={...d,from_branch:o.data,to_branch:u.data,variant:m.data?{...m.data,product:x}:null};return a.emit("lats:stock.updated",{variantId:i.entity_id,action:"transfer_rejected",quantity:i.quantity,released:!0}),h}catch(i){throw i}},I=async e=>{var a;try{const{data:r,error:s}=await t.from("branch_transfers").select("status").eq("id",e).single();if(s||!r)throw new Error("Transfer not found");if("approved"!==r.status)throw new Error(`Transfer must be approved before marking as in transit. Current status: ${r.status}`);const{data:n,error:i}=await t.from("branch_transfers").update({status:"in_transit"}).eq("id",e).select("*").single();if(i)throw i;const[l,d,c]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",n.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",n.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",n.entity_id).single()]);let o=null;if(null==(a=c.data)?void 0:a.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",c.data.product_id).single();o=e}return{...n,from_branch:l.data,to_branch:d.data,variant:c.data?{...c.data,product:o}:null}}catch(r){throw r}},A=async(e,r)=>{var s;try{const{data:n,error:i}=await t.from("branch_transfers").select("status").eq("id",e).single();if(i)throw new Error("Failed to verify transfer status");if("completed"===n.status)throw new Error("This transfer has already been completed");if("in_transit"!==n.status)throw new Error(`Transfer must be marked as "in_transit" (shipped) before it can be completed. Current status: ${n.status}. Please ask the sender to mark it as shipped first.`);const{data:l,error:d}=await t.rpc("complete_stock_transfer_transaction",{p_transfer_id:e,p_completed_by:r||null});if(d)throw new Error(`Transfer completion failed: ${d.message}`);a.emit("lats:stock.updated",{action:"transfer_completed",transferId:e,sourceVariantId:l.source_variant_id,destinationVariantId:l.destination_variant_id,quantity:l.quantity_transferred});const{data:c,error:o}=await t.from("branch_transfers").select("*").eq("id",e).single();if(o)throw o;const[u,m,x]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",c.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",c.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",c.entity_id).single()]);let h=null;if(null==(s=x.data)?void 0:s.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",x.data.product_id).single();h=e}const v={...c,from_branch:u.data,to_branch:m.data,variant:x.data?{...x.data,product:h}:null};if(!v){const{data:r,error:s}=await t.from("branch_transfers").select("*").eq("id",e).single();if(s||!r)throw new Error("Transfer completed but could not retrieve details");return a.emit("lats:stock.updated",{variantId:r.entity_id,transferId:e,action:"transfer_completed",fromBranchId:r.from_branch_id,toBranchId:r.to_branch_id,quantity:r.quantity}),r}return a.emit("lats:stock.updated",{variantId:v.entity_id,transferId:e,action:"transfer_completed",fromBranchId:v.from_branch_id,toBranchId:v.to_branch_id,quantity:v.quantity}),v}catch(n){throw n}},F=async(e,r)=>{var s;try{const{data:n,error:i}=await t.from("branch_transfers").select("entity_id, quantity, status").eq("id",e).single();if(i||!n)throw new Error("Transfer not found");"pending"!==n.status&&"approved"!==n.status||await t.rpc("release_variant_stock",{p_variant_id:n.entity_id,p_quantity:n.quantity});const{data:l,error:d}=await t.from("branch_transfers").update({status:"cancelled",rejection_reason:r||null}).eq("id",e).select("*").single();if(d)throw d;const[c,o,u]=await Promise.all([t.from("store_locations").select("id, name, code, city, is_active").eq("id",l.from_branch_id).single(),t.from("store_locations").select("id, name, code, city, is_active").eq("id",l.to_branch_id).single(),t.from("lats_product_variants").select("id, name, variant_name, sku, quantity, reserved_quantity, product_id").eq("id",l.entity_id).single()]);let m=null;if(null==(s=u.data)?void 0:s.product_id){const{data:e}=await t.from("lats_products").select("id, name, sku").eq("id",u.data.product_id).single();m=e}const x={...l,from_branch:c.data,to_branch:o.data,variant:u.data?{...u.data,product:m}:null};return a.emit("lats:stock.updated",{variantId:n.entity_id,action:"transfer_cancelled",quantity:n.quantity,released:!0}),x}catch(n){throw n}},R=()=>{const{currentUser:t}=r(),[a,d]=c(),[v,p]=l.useState([]),[f,b]=l.useState(!0),[g,y]=l.useState(""),[_,j]=l.useState("all"),[N,w]=l.useState("all"),[q,C]=l.useState(!1),[S,T]=l.useState(null),[E,I]=l.useState(null),A=localStorage.getItem("current_branch_id")||"";l.useEffect(()=>{"true"===a.get("autoOpen")&&(C(!0),d({}))},[a,d]),l.useEffect(()=>{F(),R()},[A,_,N]);const F=async()=>{try{b(!0);const e=await $(A,"all"===_?void 0:_);p(e)}catch(e){o.error("Failed to load transfers")}finally{b(!1)}},R=async()=>{if(A)try{const t=await(async t=>{try{const a=await(e`
      SELECT status, quantity
      FROM branch_transfers
      WHERE transfer_type = 'stock'
      AND (from_branch_id = ${t} OR to_branch_id = ${t})
    `),r=Array.isArray(a)?a:(null==a?void 0:a.rows)||[];return r&&r.length,{total:(null==r?void 0:r.length)||0,pending:(null==r?void 0:r.filter(e=>"pending"===e.status).length)||0,approved:(null==r?void 0:r.filter(e=>"approved"===e.status).length)||0,in_transit:(null==r?void 0:r.filter(e=>"in_transit"===e.status).length)||0,completed:(null==r?void 0:r.filter(e=>"completed"===e.status).length)||0,rejected:(null==r?void 0:r.filter(e=>"rejected"===e.status).length)||0,cancelled:(null==r?void 0:r.filter(e=>"cancelled"===e.status).length)||0,total_items:(null==r?void 0:r.reduce((e,t)=>e+(t.quantity||0),0))||0}}catch(a){return{total:0,pending:0,approved:0,in_transit:0,completed:0,rejected:0,cancelled:0,total_items:0}}})(A);I(t)}catch(t){}},D=(v||[]).filter(e=>{var t,a,r,s,n,i,l,d;if("sent"===N&&e.from_branch_id!==A)return!1;if("received"===N&&e.to_branch_id!==A)return!1;if(g){const c=g.toLowerCase();return(null==(a=null==(t=e.from_branch)?void 0:t.name)?void 0:a.toLowerCase().includes(c))||(null==(s=null==(r=e.to_branch)?void 0:r.name)?void 0:s.toLowerCase().includes(c))||(null==(i=null==(n=e.variant)?void 0:n.variant_name)?void 0:i.toLowerCase().includes(c))||(null==(d=null==(l=e.variant)?void 0:l.sku)?void 0:d.toLowerCase().includes(c))}return!0});return s.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[s.jsx(k,{title:"Stock Transfer Management",subtitle:"Manage inventory transfers between branches",actions:[{label:"Refresh",onClick:F,variant:"secondary",icon:s.jsx(u,{size:18}),disabled:f},{label:"New Transfer",onClick:()=>C(!0),variant:"primary",icon:s.jsx(m,{size:18})}]}),E&&s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4",children:[s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-900",children:E.total}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Total"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:E.pending}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Pending"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-green-600",children:E.approved}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Approved"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:E.in_transit}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"In Transit"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-green-700",children:E.completed}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Completed"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-red-600",children:E.rejected}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Rejected"})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-2xl font-bold text-gray-600",children:E.cancelled}),s.jsx("div",{className:"text-xs text-gray-600 mt-1",children:"Cancelled"})]})})]}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx(x,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),s.jsx("input",{type:"text",placeholder:"Search by branch, product, or SKU...",value:g,onChange:e=>y(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),s.jsxs("select",{value:_,onChange:e=>j(e.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[s.jsx("option",{value:"all",children:"All Statuses"}),s.jsx("option",{value:"pending",children:"Pending"}),s.jsx("option",{value:"approved",children:"Approved"}),s.jsx("option",{value:"in_transit",children:"In Transit"}),s.jsx("option",{value:"completed",children:"Completed"}),s.jsx("option",{value:"rejected",children:"Rejected"}),s.jsx("option",{value:"cancelled",children:"Cancelled"})]}),s.jsxs("select",{value:N,onChange:e=>w(e.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[s.jsx("option",{value:"all",children:"All Transfers"}),s.jsx("option",{value:"sent",children:"Sent Only"}),s.jsx("option",{value:"received",children:"Received Only"})]})]})}),s.jsx(n,{className:"overflow-hidden",children:f?s.jsxs("div",{className:"p-8 text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),s.jsx("p",{className:"mt-4 text-gray-600",children:"Loading transfers..."})]}):0===D.length?s.jsxs("div",{className:"p-8 text-center",children:[s.jsx(h,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No transfers found"}),s.jsx("p",{className:"text-gray-600 mb-6",children:g||"all"!==_||"all"!==N?"Try adjusting your filters":"Create your first stock transfer to get started"}),!g&&"all"===_&&"all"===N&&s.jsx(i,{onClick:()=>C(!0),icon:s.jsx(m,{size:18}),className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white",children:"Create Transfer"})]}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Direction"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Product"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Quantity"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:D.map(e=>s.jsx(O,{transfer:e,currentBranchId:A,currentUserId:(null==t?void 0:t.id)||"",onView:()=>T(e),onUpdate:F},e.id))})]})})}),q&&s.jsx(P,{currentBranchId:A,currentUserId:(null==t?void 0:t.id)||"",onClose:()=>C(!1),onSuccess:()=>{C(!1),F(),R()}}),S&&s.jsx(L,{transfer:S,currentBranchId:A,currentUserId:(null==t?void 0:t.id)||"",onClose:()=>T(null),onUpdate:()=>{F(),R()}})]})},O=({transfer:e,currentBranchId:t,currentUserId:a,onView:r,onUpdate:n})=>{var i,d,c,u,m,x,h,w,q,k,C,$,S;const R=e.from_branch_id===t,[O,P]=l.useState(!1);null==(d=null==(i=e.notes)?void 0:i.match(/\[BATCH:(.*?)\]/))||d[1];const L=null==(c=e.notes)?void 0:c.match(/\[BATCH:.*?\]\s*(\d+)\s*products/),D=L?parseInt(L[1]):0,B=D>1;return s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsx("td",{className:"px-6 py-4",children:s.jsx("div",{className:"flex items-center gap-2",children:R?s.jsxs(s.Fragment,{children:[s.jsx(v,{className:"w-4 h-4 text-orange-500"}),s.jsxs("div",{className:"text-sm",children:[s.jsxs("div",{className:"font-medium text-gray-900",children:["To: ",null==(u=e.to_branch)?void 0:u.name]}),s.jsx("div",{className:"text-gray-500",children:null==(m=e.to_branch)?void 0:m.city})]})]}):s.jsxs(s.Fragment,{children:[s.jsx(p,{className:"w-4 h-4 text-green-500"}),s.jsxs("div",{className:"text-sm",children:[s.jsxs("div",{className:"font-medium text-gray-900",children:["From: ",null==(x=e.from_branch)?void 0:x.name]}),s.jsx("div",{className:"text-gray-500",children:null==(h=e.from_branch)?void 0:h.city})]})]})})}),s.jsx("td",{className:"px-6 py-4",children:s.jsxs("div",{className:"text-sm",children:[s.jsxs("div",{className:"font-medium text-gray-900",children:[(null==(q=null==(w=e.variant)?void 0:w.product)?void 0:q.name)||"N/A",B&&s.jsxs("span",{className:"ml-1 text-xs font-normal text-blue-600",children:["and ",D-1," more"]})]}),s.jsx("div",{className:"text-gray-500",children:B?s.jsxs("span",{className:"text-blue-600 font-medium",children:["Batch Transfer â€¢ ",D," products"]}):s.jsxs(s.Fragment,{children:[(null==(k=e.variant)?void 0:k.name)&&"Default Variant"!==e.variant.name&&s.jsxs("span",{children:[e.variant.name," â€¢ "]}),!(null==(C=e.variant)?void 0:C.name)&&(null==($=e.variant)?void 0:$.variant_name)&&"Default Variant"!==e.variant.variant_name&&s.jsxs("span",{children:[e.variant.variant_name," â€¢ "]}),"SKU: ",(null==(S=e.variant)?void 0:S.sku)||"N/A"]})})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsx("div",{className:"text-sm font-semibold text-gray-900",children:B?s.jsxs(s.Fragment,{children:[e.quantity,s.jsx("span",{className:"ml-1 text-xs font-normal text-gray-500",children:"(batch)"})]}):`${e.quantity} units`})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-semibold border "+("pending"===e.status?"bg-yellow-100 text-yellow-800 border-yellow-200":"approved"===e.status?"bg-green-100 text-green-800 border-green-200":"in_transit"===e.status?"bg-blue-100 text-blue-800 border-blue-200":"completed"===e.status?"bg-green-100 text-green-800 border-green-200":"rejected"===e.status?"bg-red-100 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"),children:e.status.charAt(0).toUpperCase()+e.status.slice(1).replace("_"," ")})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.created_at).toLocaleDateString()}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:r,className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"View Details",children:s.jsx(f,{className:"w-4 h-4"})}),!R&&"pending"===e.status&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:async()=>{var t,r;const s=`Approve transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} to ${null==(r=e.to_branch)?void 0:r.name}? Stock will remain reserved until completion.`;if(confirm(s)){P(!0);try{await T(e.id,a),o.success(`âœ… Transfer approved! ${e.quantity} units reserved for shipping.`),n()}catch(i){o.error(i.message||"Failed to approve transfer")}finally{P(!1)}}},disabled:O,className:"px-3 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-1.5",title:"Approve this transfer request - stock will remain reserved",children:O?s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Processing..."]}):s.jsxs(s.Fragment,{children:[s.jsx(b,{className:"w-4 h-4"}),"Approve"]})}),s.jsx("button",{onClick:async()=>{var t,r;const s=`Reject transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} from ${null==(r=e.from_branch)?void 0:r.name}? Reserved stock will be released and made available again.`;if(!confirm(s))return;const i=prompt("Reason for rejection (optional):");if(null!==i){P(!0);try{await E(e.id,a,i),o.success(`âŒ Transfer rejected. ${e.quantity} units released back to available stock.`),n()}catch(l){o.error(l.message||"Failed to reject transfer")}finally{P(!1)}}},disabled:O,className:"px-3 py-1.5 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-1.5",title:"Reject this transfer - reserved stock will be released",children:O?s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Processing..."]}):s.jsxs(s.Fragment,{children:[s.jsx(g,{className:"w-4 h-4"}),"Reject"]})})]}),R&&"approved"===e.status&&s.jsx("button",{onClick:async()=>{var t,a,r;const s=`Mark ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} as shipped to ${null==(a=e.to_branch)?void 0:a.name}? The receiving branch will be notified.`;if(confirm(s)){P(!0);try{await I(e.id),o.success(`ðŸšš Shipment dispatched! ${null==(r=e.to_branch)?void 0:r.name} will be notified.`),n()}catch(i){o.error(i.message||"Failed to update transfer")}finally{P(!1)}}},disabled:O,className:"px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-1.5",title:"Mark as shipped - notify receiving branch",children:O?s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Shipping..."]}):s.jsxs(s.Fragment,{children:[s.jsx(y,{className:"w-4 h-4"}),"Ship"]})}),!R&&"in_transit"===e.status&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg border border-blue-200 flex items-center gap-1.5",children:[s.jsx(y,{className:"w-4 h-4"}),"In Transit"]}),s.jsx("button",{onClick:async()=>{var t,a,r,s;if("completed"===e.status)return o.error("This transfer has already been completed"),void n();if("in_transit"!==e.status&&"approved"!==e.status)return o.error(`Cannot complete transfer with status: ${e.status}`),void n();const i=`Confirm receipt of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} from ${null==(a=e.from_branch)?void 0:a.name}? This will move inventory from ${null==(r=e.from_branch)?void 0:r.name} to your branch.`;if(confirm(i)){P(!0);try{await A(e.id),o.success(`âœ… Transfer completed! ${e.quantity} units added to your inventory from ${null==(s=e.from_branch)?void 0:s.name}.`),n()}catch(l){o.error(l.message||"Failed to complete transfer"),n()}finally{P(!1)}}},disabled:O,className:"px-3 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-1.5",title:"Click when items arrive",children:O?s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Receiving..."]}):s.jsxs(s.Fragment,{children:[s.jsx(_,{className:"w-4 h-4"}),"Receive"]})})]}),!R&&"approved"===e.status&&s.jsxs("div",{className:"px-3 py-1.5 text-sm font-medium text-amber-700 bg-amber-100 rounded-lg border border-amber-200 flex items-center gap-1.5",children:[s.jsx(j,{className:"w-4 h-4"}),"Not Shipped Yet"]}),("pending"===e.status||"approved"===e.status)&&R&&s.jsx("button",{onClick:async()=>{var t,a;const r=`Cancel transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} to ${null==(a=e.to_branch)?void 0:a.name}? Reserved stock will be released and made available again.`;if(!confirm(r))return;const s=prompt("Reason for cancellation (optional):");if(null!==s){P(!0);try{await F(e.id,s),o.success(`âŒ Transfer cancelled. ${e.quantity} units released back to available stock.`),n()}catch(i){o.error(i.message||"Failed to cancel transfer")}finally{P(!1)}}},disabled:O,className:"px-3 py-1.5 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-1.5",title:"Cancel this transfer and release reserved stock",children:O?s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Cancelling..."]}):s.jsxs(s.Fragment,{children:[s.jsx(N,{className:"w-4 h-4"}),"Cancel"]})})]})})]})},P=({currentBranchId:e,currentUserId:a,onClose:r,onSuccess:n})=>{const[i,c]=l.useState([]),[u,v]=l.useState([]),[p,f]=l.useState([]),[b,y]=l.useState({to_branch_id:"",notes:""}),[_,j]=l.useState(null),[N,w]=l.useState(!1),[q,k]=l.useState(!0),[C,$]=l.useState(""),[T,E]=l.useState([]),I=d.useRef(null),[A,F]=l.useState({entity_id:"",quantity:1});l.useEffect(()=>{R(),O()},[e]),l.useEffect(()=>{if(q||0===u.length)return;const e=localStorage.getItem("stock_transfer_quick_add");if(e){try{const t=JSON.parse(e);if(localStorage.removeItem("stock_transfer_quick_add"),t.variants&&t.variants.length>0){const e=t.variants.filter(e=>(e.quantity||0)>0);if(e.length>0){const a=e.map(e=>({variant:e,quantity:1}));f(a),o.success(`âœ… ${t.productName} ready to transfer!`,{duration:3e3})}else o.error("Product has no stock available for transfer")}}catch(a){}return}const t=sessionStorage.getItem("preselectedTransferProduct");if(t)try{const e=JSON.parse(t);if(sessionStorage.removeItem("preselectedTransferProduct"),e.variants&&e.variants.length>0){const t=e.variants.map(e=>({variant:e,quantity:1}));f(t),o.success(`Added ${e.productName} to transfer`,{duration:3e3,icon:"âœ…"})}}catch(a){}else setTimeout(()=>{var e;return null==(e=I.current)?void 0:e.focus()},100)},[q,u]),l.useEffect(()=>{const e=e=>{var t,a;"Escape"===e.key&&(_?j(null):r()),(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),null==(t=I.current)||t.focus(),null==(a=I.current)||a.select())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[r,_]);const R=async()=>{try{const{data:a,error:r}=await t.from("store_locations").select("id, name, code, city, is_main").eq("is_active",!0).neq("id",e);if(r)throw r;c(a||[])}catch(a){o.error("Failed to load branches")}},O=async()=>{try{k(!0);const{data:a,error:r}=await t.from("lats_product_variants").select("\n          id,\n          product_id,\n          name,\n          variant_name,\n          sku,\n          quantity,\n          selling_price,\n          branch_id,\n          product:lats_products!product_id(name)\n        ").eq("branch_id",e).gt("quantity",0).order("name");if(r)throw r;v(a||[]),a&&a.length>0&&o.success(`${a.length} products available`)}catch(a){o.error("Failed to load products")}finally{k(!1)}},P=e=>{f(p.filter(t=>t.variant.id!==e)),o.success("Product removed")},L=(e,t)=>{const a=p.find(t=>t.variant.id===e);a&&(t<1?P(e):t>a.variant.quantity?o.error(`Only ${a.variant.quantity} units available`):f(p.map(a=>a.variant.id===e?{...a,quantity:t}:a)))},D=e=>{var t;p.some(t=>t.variant.id===e.id)?o.error("Product already added"):e.quantity<=0?o.error("Product out of stock"):(f([...p,{variant:e,quantity:1}]),E([...T,e.id]),setTimeout(()=>{E(t=>t.filter(t=>t!==e.id))},1e3),o.success(`${(null==(t=e.product)?void 0:t.name)||e.variant_name} added!`,{icon:"âœ…",duration:2e3}))},B=d.useMemo(()=>{const e=new Map;return u.forEach(t=>{var a;const r=t.product_id,s=(null==(a=t.product)?void 0:a.name)||"Unknown Product";e.has(r)||e.set(r,{product:{id:r,name:s},variants:[]}),e.get(r).variants.push(t)}),Array.from(e.values())},[u]).filter(e=>{var t;if(e.variants.every(e=>p.some(t=>t.variant.id===e.id)))return!1;if(!C)return!0;const a=C.toLowerCase();return(null==(t=e.product.name)?void 0:t.toLowerCase().includes(a))||e.variants.some(e=>{var t,r;return(null==(t=e.variant_name)?void 0:t.toLowerCase().includes(a))||(null==(r=e.sku)?void 0:r.toLowerCase().includes(a))})});return u.find(e=>e.id===A.entity_id),s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:r}),s.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4 z-50 pointer-events-none",children:s.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto pointer-events-auto",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:s.jsx(h,{className:"w-5 h-5 text-blue-600"})}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Create Stock Transfer"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Transfer products to another branch"})]})]}),s.jsx("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 transition-colors",children:s.jsx(g,{className:"w-6 h-6"})})]}),s.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),b.to_branch_id)if(0!==p.length){w(!0);try{const t=`[BATCH:${`BATCH-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}] ${p.length} products | ${b.notes||""}`.trim(),r=p.map((r,s)=>{const n={from_branch_id:e,to_branch_id:b.to_branch_id,entity_type:"variant",entity_id:r.variant.id,quantity:r.quantity,notes:t};return S(n,a)});await Promise.all(r);o.success(`âœ… Transfer created with ${p.length} products!`,{duration:3e3,icon:"ðŸ“¦"}),n()}catch(r){o.error(r.message||"Failed to create transfer")}finally{w(!1)}}else o.error("Please add at least one product to transfer");else o.error("Please select a destination branch")},className:"space-y-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Destination Branch"}),s.jsxs("select",{value:b.to_branch_id,onChange:e=>y({...b,to_branch_id:e.target.value}),className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-gray-900",required:!0,children:[s.jsx("option",{value:"",children:"Select destination branch..."}),i.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.code,") - ",e.city]},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search Products"}),s.jsxs("div",{className:"relative",children:[s.jsx(x,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),s.jsx("input",{ref:I,type:"text",placeholder:"Type product name or scan barcode...",value:C,onChange:e=>$(e.target.value),className:"w-full pl-10 pr-10 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-gray-900"}),C&&s.jsx("button",{type:"button",onClick:()=>$(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:s.jsx(g,{className:"w-4 h-4"})})]})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Available Products",!q&&B.length>0&&s.jsxs("span",{className:"ml-2 text-xs text-gray-500",children:["(",B.length,")"]})]}),s.jsx("div",{className:"border-2 border-gray-200 rounded-lg h-96 overflow-y-auto bg-gray-50 p-3",children:q?s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"}),s.jsx("p",{className:"text-sm text-gray-600",children:"Loading..."})]})}):0===B.length?s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsxs("div",{className:"text-center",children:[s.jsx(h,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),s.jsx("p",{className:"text-sm text-gray-600",children:p.length>0?"All products added":C?"No products found":"No products available"})]})}):s.jsx("div",{className:"space-y-2",children:B.map(e=>{const t=e.variants.filter(e=>!p.some(t=>t.variant.id===e.id));if(0===t.length)return null;const a=t.length>1,r=t.reduce((e,t)=>e+t.quantity,0),n=1===t.length?t[0]:null;return s.jsx("div",{className:"bg-white border border-gray-300 rounded-lg p-3 hover:border-blue-500 transition-colors",children:s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"font-medium text-sm text-gray-900 truncate",children:e.product.name}),s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[a?`${t.length} variants`:t[0].sku," â€¢ ",r," in stock"]})]}),!a&&n?s.jsxs("button",{type:"button",onClick:()=>D(n),className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-1",children:[s.jsx(m,{className:"w-3 h-3"}),"Add"]}):s.jsx("button",{type:"button",onClick:()=>j(e),className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors",children:"Select"})]})},e.product.id)})})})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Selected Products (",p.length,")"]}),p.length>0&&s.jsx("button",{type:"button",onClick:()=>{0!==p.length&&confirm(`Remove all ${p.length} products from transfer?`)&&(f([]),o.success("All products removed"))},className:"text-xs text-red-600 hover:text-red-700 font-medium",children:"Clear All"})]}),s.jsx("div",{className:"border-2 border-gray-200 rounded-lg h-96 overflow-y-auto bg-gray-50 p-3",children:p.length>0?s.jsx("div",{className:"space-y-2",children:p.map(e=>{var t;return s.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"font-medium text-sm text-gray-900 truncate",children:(null==(t=e.variant.product)?void 0:t.name)||e.variant.variant_name}),s.jsx("p",{className:"text-xs text-gray-500",children:e.variant.sku})]}),s.jsx("button",{type:"button",onClick:()=>P(e.variant.id),className:"text-gray-400 hover:text-red-600 transition-colors",children:s.jsx(g,{className:"w-4 h-4"})})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>L(e.variant.id,Math.max(1,e.quantity-1)),className:"w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-bold transition-colors",children:"âˆ’"}),s.jsx("input",{type:"number",min:"1",max:e.variant.quantity,value:e.quantity,onChange:t=>L(e.variant.id,parseInt(t.target.value)||1),className:"flex-1 px-2 py-1 text-center border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 font-semibold"}),s.jsx("button",{type:"button",onClick:()=>L(e.variant.id,Math.min(e.variant.quantity,e.quantity+1)),disabled:e.quantity>=e.variant.quantity,className:"w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-700 disabled:bg-gray-200 disabled:text-gray-400 text-white rounded-lg font-bold transition-colors",children:"+"})]}),s.jsxs("p",{className:"text-xs text-gray-500 text-right mt-1",children:["Max: ",e.variant.quantity]})]},e.variant.id)})}):s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsxs("div",{className:"text-center",children:[s.jsx(h,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),s.jsx("p",{className:"text-sm text-gray-600",children:"No products selected"})]})})})]})]}),_&&_.variants.filter(e=>!p.some(t=>t.variant.id===e.id)).length>0&&s.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg",children:[s.jsxs("div",{className:"flex items-center justify-between mb-3",children:[s.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[s.jsx("span",{className:"font-bold",children:_.product.name})," - Select Variant"]}),s.jsx("button",{type:"button",onClick:()=>j(null),className:"text-xs text-gray-600 hover:text-gray-900 font-medium",children:"Cancel"})]}),s.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:_.variants.filter(e=>!p.some(t=>t.variant.id===e.id)).map(e=>s.jsx("button",{type:"button",onClick:()=>{D(e),j(null)},className:"w-full text-left px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors",children:s.jsxs("div",{className:"flex justify-between items-center gap-3",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium text-sm text-gray-900 mb-1",children:e.variant_name}),s.jsxs("p",{className:"text-xs text-gray-500",children:["SKU: ",e.sku]})]}),s.jsxs("div",{className:"text-right",children:[s.jsxs("p",{className:"text-sm font-semibold text-gray-900",children:[e.quantity," in stock"]}),s.jsxs("p",{className:"text-xs text-gray-500",children:["TSh ",Number(e.selling_price||0).toLocaleString()]})]})]})},e.id))}),s.jsx("p",{className:"text-xs text-gray-500 mt-3 text-center",children:"Click any variant to add it to your transfer"})]}),p.length>0&&s.jsx("div",{className:"bg-blue-50 rounded-lg p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Total Products"}),s.jsx("p",{className:"text-4xl font-bold text-blue-600",children:p.length})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Total Units"}),s.jsx("p",{className:"text-3xl font-bold text-green-600",children:p.reduce((e,t)=>e+t.quantity,0)})]})]})}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes (Optional)"}),s.jsx("textarea",{value:b.notes,onChange:e=>y({...b,notes:e.target.value}),rows:3,className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors resize-none text-gray-900",placeholder:"Add any notes about this transfer..."})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{type:"button",onClick:r,disabled:N,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:N||!b.to_branch_id||0===p.length,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:N?"Creating...":"Create Transfer"})]})]})]})})})]})},L=({transfer:e,currentBranchId:t,currentUserId:a,onClose:r,onUpdate:d})=>{var c,u,m,x,v,p,k,C,S,R,O;const[P,L]=l.useState(!1),[D,B]=l.useState([]),[U,z]=l.useState(!1),[M,J]=l.useState([]),H=e.from_branch_id===t,V=null==(u=null==(c=e.notes)?void 0:c.match(/\[BATCH:(.*?)\]/))?void 0:u[1];l.useEffect(()=>{(async()=>{if(V)try{z(!0);const a=(await $(t,"all")).filter(e=>{var t;return null==(t=e.notes)?void 0:t.includes(`[BATCH:${V}]`)});B(a.length>0?a:[e]),J(a.map(e=>e.id))}catch(a){B([e])}finally{z(!1)}else B([e])})()},[V,e,t]);const K=e=>{J(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},Y=D.length>1;return s.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:s.jsxs(n,{className:"max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center",children:s.jsx(f,{className:"w-5 h-5 text-white"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Transfer Details"}),s.jsxs("p",{className:"text-xs text-gray-500 mt-0.5 font-mono",children:[e.id.slice(0,24),"..."]})]})]}),s.jsx("button",{type:"button",onClick:r,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors",children:s.jsx(g,{className:"w-5 h-5"})})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[Y&&s.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center",children:s.jsx(h,{className:"w-5 h-5 text-white"})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-semibold text-gray-900",children:"Batch Transfer"}),s.jsxs("div",{className:"text-sm text-gray-600",children:[D.length," products in this transfer"]})]}),s.jsxs("div",{className:"text-right",children:[s.jsx("div",{className:"text-xs text-gray-600",children:"Total Units"}),s.jsx("div",{className:"text-lg font-bold text-blue-900",children:D.reduce((e,t)=>e+t.quantity,0)})]})]})}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"From Branch"}),s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[s.jsx(w,{className:"w-5 h-5 text-gray-600"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-gray-900",children:null==(m=e.from_branch)?void 0:m.name}),s.jsx("div",{className:"text-sm text-gray-600",children:null==(x=e.from_branch)?void 0:x.city})]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"To Branch"}),s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg",children:[s.jsx(w,{className:"w-5 h-5 text-gray-600"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-gray-900",children:null==(v=e.to_branch)?void 0:v.name}),s.jsx("div",{className:"text-sm text-gray-600",children:null==(p=e.to_branch)?void 0:p.city})]})]})]})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:[Y?"Products in Transfer":"Product",Y&&s.jsx("span",{className:"ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full",children:D.length})]}),Y&&!H&&("pending"===e.status||"in_transit"===e.status)&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{type:"button",onClick:()=>J(D.map(e=>e.id)),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Select All"}),s.jsx("span",{className:"text-gray-300",children:"|"}),s.jsx("button",{type:"button",onClick:()=>J([]),className:"text-xs text-gray-600 hover:text-gray-700 font-medium",children:"Deselect All"})]})]}),U?s.jsxs("div",{className:"p-8 text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),s.jsx("p",{className:"text-sm text-gray-600",children:"Loading items..."})]}):Y?s.jsxs(s.Fragment,{children:[!H&&("pending"===e.status||"in_transit"===e.status)&&s.jsx("div",{className:"mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(q,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),s.jsxs("div",{className:"text-xs text-blue-900",children:[s.jsx("span",{className:"font-medium",children:"pending"===e.status?"Select products to approve:":"Select products to receive:"})," ","Check items below to process them individually, or select all for batch processing."]})]})}),s.jsx("div",{className:"border border-gray-200 rounded-lg bg-white max-h-80 overflow-y-auto",children:D.map((t,a)=>{var r,n,i,l,d,c;return s.jsxs("div",{className:"group flex items-center gap-3 p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors "+(H||"pending"!==e.status&&"in_transit"!==e.status?"":"cursor-pointer"),onClick:()=>{H||"pending"!==e.status&&"in_transit"!==e.status||K(t.id)},children:[!H&&("pending"===e.status||"in_transit"===e.status)&&s.jsx("input",{type:"checkbox",checked:M.includes(t.id),onChange:()=>K(t.id),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("div",{className:"flex-1 min-w-0",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-xs font-bold text-gray-400",children:[a+1,"."]}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-medium text-sm text-gray-900 truncate",children:(null==(n=null==(r=t.variant)?void 0:r.product)?void 0:n.name)||"N/A"}),s.jsxs("div",{className:"text-xs text-gray-500 truncate",children:[(null==(i=t.variant)?void 0:i.name)&&"Default Variant"!==t.variant.name&&s.jsxs("span",{children:[t.variant.name," â€¢ "]}),!(null==(l=t.variant)?void 0:l.name)&&(null==(d=t.variant)?void 0:d.variant_name)&&"Default Variant"!==t.variant.variant_name&&s.jsxs("span",{children:[t.variant.variant_name," â€¢ "]}),"SKU: ",(null==(c=t.variant)?void 0:c.sku)||"N/A"]})]})]})}),s.jsxs("div",{className:"text-right",children:[s.jsxs("div",{className:"text-sm font-semibold text-blue-900",children:[t.quantity," units"]}),s.jsx("div",{className:"text-xs px-2 py-0.5 rounded-full font-medium "+("completed"===t.status?"bg-green-100 text-green-700":"in_transit"===t.status?"bg-blue-100 text-blue-700":"approved"===t.status?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"),children:"completed"===t.status?"âœ“ Received":"in_transit"===t.status?"In Transit":"approved"===t.status?"Approved":"Pending"})]})]},t.id)})})]}):s.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[s.jsx("div",{className:"font-medium text-gray-900 mb-1",children:(null==(C=null==(k=e.variant)?void 0:k.product)?void 0:C.name)||(null==(S=e.variant)?void 0:S.variant_name)||"N/A"}),s.jsxs("div",{className:"text-sm text-gray-600",children:[(null==(R=e.variant)?void 0:R.variant_name)&&"Default Variant"!==e.variant.variant_name&&s.jsxs("span",{children:[e.variant.variant_name," â€¢ "]}),"SKU: ",(null==(O=e.variant)?void 0:O.sku)||"N/A"]}),s.jsxs("div",{className:"text-lg font-bold text-blue-600 mt-2",children:["Quantity: ",e.quantity," units"]})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Requested"}),s.jsx("div",{className:"text-sm text-gray-900",children:e.requested_at?new Date(e.requested_at).toLocaleString():"N/A"})]}),e.approved_at&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"rejected"===e.status?"Rejected":"Approved"}),s.jsx("div",{className:"text-sm text-gray-900",children:new Date(e.approved_at).toLocaleString()})]}),e.completed_at&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Completed"}),s.jsx("div",{className:"text-sm text-gray-900",children:new Date(e.completed_at).toLocaleString()})]})]}),e.notes&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes"}),s.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-sm text-gray-900",children:e.notes})]})]}),s.jsx("div",{className:"border-t border-gray-100 p-6 bg-gray-50",children:s.jsxs("div",{className:"flex gap-3",children:[s.jsx(i,{onClick:r,variant:"secondary",className:"flex-1",disabled:P,children:"Close"}),!H&&"pending"===e.status&&s.jsxs(s.Fragment,{children:[Y&&M.length<D.length&&s.jsx("div",{className:"flex-1 text-center",children:s.jsxs("div",{className:"text-xs text-gray-600 mb-1",children:[M.length," of ",D.length," selected"]})}),s.jsx(i,{onClick:async()=>{var t,s;const n=Y?M.length:1,i=Y?`Approve ${n} of ${D.length} transfer requests? Stock will remain reserved until completion.`:`Approve transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} to ${null==(s=e.to_branch)?void 0:s.name}? Stock will remain reserved until completion.`;if(confirm(i)){L(!0);try{const t=Y?D.filter(e=>M.includes(e.id)):[e];await Promise.all(t.map(e=>T(e.id,a))),o.success(`âœ… ${n} ${1===n?"product":"products"} approved`),d(),r()}catch(l){o.error(l.message||"Failed to approve transfer")}finally{L(!1)}}},disabled:P||Y&&0===M.length,className:"flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white",icon:s.jsx(b,{size:18}),children:P?"Processing...":Y?`Approve ${M.length===D.length?"All":M.length} Product${1!==M.length?"s":""}`:"Approve"}),s.jsx(i,{onClick:async()=>{var t,s;const n=`Reject transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} from ${null==(s=e.from_branch)?void 0:s.name}? Reserved stock will be released and made available again.`;if(!confirm(n))return;const i=prompt("Reason for rejection (optional):");if(null!==i){L(!0);try{await E(e.id,a,i),o.success(`âŒ Transfer rejected. ${e.quantity} units released back to available stock.`),d(),r()}catch(l){o.error(l.message||"Failed to reject transfer")}finally{L(!1)}}},disabled:P,className:"bg-gradient-to-r from-red-500 to-red-600 text-white",icon:s.jsx(g,{size:18}),children:P?"Processing...":"Reject"})]}),H&&"approved"===e.status&&s.jsx(i,{onClick:async()=>{var t,a,s;const n=`Mark ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} as shipped to ${null==(a=e.to_branch)?void 0:a.name}? The receiving branch will be notified.`;if(confirm(n)){L(!0);try{await I(e.id),o.success(`ðŸšš Shipment dispatched! ${null==(s=e.to_branch)?void 0:s.name} will be notified.`),d(),r()}catch(i){o.error(i.message||"Failed to update transfer")}finally{L(!1)}}},disabled:P,className:"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white",icon:s.jsx(y,{size:18}),children:P?"Processing...":"Mark In Transit"}),!H&&"in_transit"===e.status&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex-1 px-4 py-3 text-sm font-medium text-blue-700 bg-blue-50 rounded-lg border border-blue-200 flex items-center justify-center gap-2",children:[s.jsx(y,{size:18}),"In Transit"]}),Y&&M.length<D.length&&s.jsx("div",{className:"flex-1 text-center",children:s.jsxs("div",{className:"text-xs text-gray-600 mb-1",children:[M.length," of ",D.length," selected"]})}),s.jsx(i,{onClick:async()=>{var t,a,s;if("completed"===e.status)return o.error("This transfer has already been completed"),d(),void r();if("in_transit"!==e.status&&"approved"!==e.status)return o.error(`Cannot complete transfer with status: ${e.status}`),d(),void r();const n=Y?M.length:1,i=Y?`Receive ${n} of ${D.length} products from ${null==(t=e.from_branch)?void 0:t.name}? This will move inventory to your branch.`:`Confirm receipt of ${e.quantity} units of ${null==(a=e.variant)?void 0:a.variant_name} from ${null==(s=e.from_branch)?void 0:s.name}? This will move inventory to your branch.`;if(confirm(i)){L(!0);try{const t=(Y?D.filter(e=>M.includes(e.id)&&"completed"!==e.status):[e]).filter(e=>"in_transit"===e.status||"approved"===e.status);if(0===t.length)return o.error("All selected transfers are already completed"),d(),void r();await Promise.all(t.map(e=>A(e.id))),o.success(`âœ… ${t.length} ${1===t.length?"product":"products"} received!`,{icon:"ðŸ“¦",duration:3e3}),d(),r()}catch(l){o.error(l.message||"Failed to complete transfer"),d()}finally{L(!1)}}},disabled:P||Y&&0===M.length,className:"flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white",icon:s.jsx(_,{size:18}),children:P?"Processing...":Y?`Receive ${M.length===D.length?"All":M.length}`:"Receive"})]}),!H&&"approved"===e.status&&s.jsxs("div",{className:"flex-1 px-4 py-3 text-sm font-medium text-amber-700 bg-amber-50 rounded-lg border border-amber-200 flex items-center justify-center gap-2",children:[s.jsx(j,{size:18}),"Not Shipped Yet"]}),("pending"===e.status||"approved"===e.status)&&H&&s.jsx(i,{onClick:async()=>{var t,a;const s=`Cancel transfer of ${e.quantity} units of ${null==(t=e.variant)?void 0:t.variant_name} to ${null==(a=e.to_branch)?void 0:a.name}? Reserved stock will be released and made available again.`;if(!confirm(s))return;const n=prompt("Reason for cancellation (optional):");if(null!==n){L(!0);try{await F(e.id,n),o.success(`âŒ Transfer cancelled. ${e.quantity} units released back to available stock.`),d(),r()}catch(i){o.error(i.message||"Failed to cancel transfer")}finally{L(!1)}}},disabled:P,className:"flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white",icon:s.jsx(N,{size:18}),children:P?"Processing...":"Cancel Transfer"})]})})]})})};export{R as default};
