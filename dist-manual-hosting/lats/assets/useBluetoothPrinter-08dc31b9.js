import{r as e}from"./vendor-a2ff445a.js";const t=new class{constructor(){this.device=null,this.server=null,this.service=null,this.characteristic=null,this.isConnected=!1,this.settings={paperWidth:80,printCopies:1,autoConnect:!1,connectionTimeout:1e4,labelHeight:25,dpi:203,defaultPrintType:"receipt"}}async initialize(){try{return!!navigator.bluetooth&&(this.loadSettings(),!0)}catch(e){return!1}}async requestDevice(){try{const e=await navigator.bluetooth.requestDevice({filters:[{services:["000018f0-0000-1000-8000-00805f9b34fb"]},{namePrefix:"Printer"},{namePrefix:"Thermal"},{namePrefix:"Receipt"},{namePrefix:"POS"},{namePrefix:"ESC"},{namePrefix:"Star"},{namePrefix:"Citizen"},{namePrefix:"Epson"},{namePrefix:"Zebra"}],optionalServices:["000018f0-0000-1000-8000-00805f9b34fb","000018f1-0000-1000-8000-00805f9b34fb","000018f2-0000-1000-8000-00805f9b34fb"]});this.device=e,e.addEventListener("gattserverdisconnected",()=>{this.handleDisconnection()});const t=e.name||"";let i="thermal",n=80,r=25,s=203;return t.toLowerCase().includes("xp-p301a")||t.toLowerCase().includes("xprinter")?(i="receipt",n=80,r=25,s=203):t.toLowerCase().includes("label")||t.toLowerCase().includes("zebra")?(i="label",n=50,r=25,s=203):(t.toLowerCase().includes("receipt")||t.toLowerCase().includes("thermal"))&&(i="receipt",n=80),[{id:e.id,name:e.name||"Unknown Printer",address:e.id,connected:!1,type:i,paperWidth:n,labelHeight:r,dpi:s,supportedCommands:"label"===i?["text","barcode","qr","image"]:t.toLowerCase().includes("xp-p301a")?["text","barcode","qr","cut","feed","label"]:["text","cut","feed"]}]}catch(e){throw e}}async connect(e){var t;try{if(!this.device&&e){const t=await navigator.bluetooth.getDevices();if(this.device=t.find(t=>t.id===e)||null,!this.device)throw new Error("Device not found. Please pair the printer first.")}if(!this.device)throw new Error("No device selected");if(this.server=await(null==(t=this.device.gatt)?void 0:t.connect()),!this.server)throw new Error("Failed to connect to GATT server");if(this.service=await this.server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb"),!this.service)throw new Error("Printer service not found");if(this.characteristic=await this.service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"),!this.characteristic)throw new Error("Printer characteristic not found");return this.isConnected=!0,this.saveConnectedDevice(),!0}catch(i){throw this.isConnected=!1,i}}async disconnect(){try{this.server&&this.server.connected&&await this.server.disconnect(),this.device=null,this.server=null,this.service=null,this.characteristic=null,this.isConnected=!1}catch(e){}}async print(e){try{if(!this.isConnected||!this.characteristic)throw new Error("Printer not connected");const{content:t,commands:i=[],copies:n=1,paperWidth:r=this.settings.paperWidth,labelHeight:s=this.settings.labelHeight,dpi:a=this.settings.dpi,printType:c=this.settings.defaultPrintType}=e;let o="";"label"===c?o+=this.generateLabelCommands(t,r,s,a):(o+="@",o+=t,o+="\n\n\n\n\n");const l=(new TextEncoder).encode(o);for(let e=0;e<n;e++)await this.characteristic.writeValue(l),n>1&&e<n-1&&await new Promise(e=>setTimeout(e,500));return!0}catch(t){throw t}}generateLabelCommands(e,t,i,n){const r=e=>Math.round(e*n/25.4),s=r(t),a=r(i);let c="";return c+="@",c+="iM@",c+=`iA${String.fromCharCode(255&s)}${String.fromCharCode(s>>8&255)}`,c+=`iQ${String.fromCharCode(255&a)}${String.fromCharCode(a>>8&255)}`,c+="ia",c+="i!\0",c+=e,c+="iM\0",c+="iM",c}async printReceipt(e){try{const{paperWidth:t=this.settings.paperWidth}=this.settings,i=Math.floor(t/8);let n="";return n+="a",n+=e.header+"\n",n+="=".repeat(i)+"\n",n+="a\0",e.items.forEach(e=>{const t=`${e.name}\n`,i=`  ${e.quantity} x ${this.formatMoney(e.price)} = ${this.formatMoney(e.total)}\n`;n+=t+i}),n+="\n"+"=".repeat(i)+"\n",n+=`Subtotal: ${this.formatMoney(e.subtotal)}\n`,e.tax>0&&(n+=`Tax: ${this.formatMoney(e.tax)}\n`),e.discount>0&&(n+=`Discount: -${this.formatMoney(e.discount)}\n`),n+=`TOTAL: ${this.formatMoney(e.total)}\n`,n+="=".repeat(i)+"\n",n+=`Payment: ${e.paymentMethod}\n`,n+=`Cashier: ${e.cashier}\n`,n+=`Date: ${(new Date).toLocaleString()}\n`,n+="\na",n+=e.footer+"\n",await this.print({content:n,copies:this.settings.printCopies})}catch(t){throw t}}async printLabel(e){try{const{paperWidth:t=this.settings.paperWidth,labelHeight:i=this.settings.labelHeight}=this.settings;let n="";if(e.title&&(n+="i!",n+=e.title+"\n"),e.barcode&&(n+="b",n+=e.barcode,n+="b\0",n+="\n"),e.qrCode&&(n+="q",n+=e.qrCode,n+="q\0",n+="\n"),e.text&&(n+="i!\0",n+=e.text+"\n"),e.price&&(n+="i!",n+=`Price: ${e.price}\n`),e.sku&&(n+=`SKU: ${e.sku}\n`),e.size||e.color){const t=[];e.size&&t.push(`Size: ${e.size}`),e.color&&t.push(`Color: ${e.color}`),n+=t.join(" | ")+"\n"}return e.customFields&&e.customFields.forEach(e=>{n+=`${e.label}: ${e.value}\n`}),await this.print({content:n,copies:this.settings.printCopies,printType:"label",paperWidth:t,labelHeight:i})}catch(t){throw t}}isPrinterConnected(){var e;return this.isConnected&&!0===(null==(e=this.server)?void 0:e.connected)}getConnectedDevice(){return this.device&&this.isConnected?{id:this.device.id,name:this.device.name||"Unknown Printer",address:this.device.id,connected:this.isConnected,type:"thermal",paperWidth:this.settings.paperWidth,supportedCommands:["text","cut","feed"]}:null}updateSettings(e){this.settings={...this.settings,...e},this.saveSettings()}getSettings(){return{...this.settings}}handleDisconnection(){this.isConnected=!1,this.server=null,this.service=null,this.characteristic=null,this.settings.autoConnect&&this.device&&setTimeout(()=>{this.connect().catch(e=>{})},2e3)}saveSettings(){try{localStorage.setItem("bluetoothPrinterSettings",JSON.stringify(this.settings))}catch(e){}}loadSettings(){try{const e=localStorage.getItem("bluetoothPrinterSettings");e&&(this.settings={...this.settings,...JSON.parse(e)})}catch(e){}}saveConnectedDevice(){try{this.device&&localStorage.setItem("connectedPrinterDevice",this.device.id)}catch(e){}}formatMoney(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e)}},i=()=>{const[i,n]=e.useState(!1),[r,s]=e.useState(!1),[a,c]=e.useState(!1),[o,l]=e.useState(!1),[h,d]=e.useState(null),[u,p]=e.useState([]),[f,g]=e.useState({paperWidth:80,printCopies:1,autoConnect:!1,connectionTimeout:1e4,labelHeight:25,dpi:203,defaultPrintType:"receipt"}),[m,v]=e.useState(null),C=e.useCallback(async()=>{try{v(null);const e=await t.initialize();if(n(e),e){const e=t.getSettings();g(e);const i=t.getConnectedDevice();i&&(d(i),s(!0))}return e}catch(e){const t=e instanceof Error?e.message:"Failed to initialize Bluetooth printer service";return t.includes("not supported")||v(t),!1}},[]),b=e.useCallback(async()=>{try{v(null),c(!0);const e=await t.requestDevice();p(e),1===e.length&&await y(e[0].id)}catch(e){const t=e instanceof Error?e.message:"Failed to request Bluetooth device";v(t)}finally{c(!1)}},[]),y=e.useCallback(async e=>{try{v(null),c(!0);const i=await t.connect(e);if(i){const e=t.getConnectedDevice();d(e),s(!0)}return i}catch(i){const e=i instanceof Error?i.message:"Failed to connect to printer";return v(e),!1}finally{c(!1)}},[]),w=e.useCallback(async()=>{try{v(null),await t.disconnect(),d(null),s(!1)}catch(e){const t=e instanceof Error?e.message:"Failed to disconnect from printer";v(t)}},[]),S=e.useCallback(async e=>{try{v(null),l(!0);return await t.print(e)}catch(i){const e=i instanceof Error?i.message:"Failed to print";return v(e),!1}finally{l(!1)}},[]),P=e.useCallback(async e=>{try{v(null),l(!0);return await t.printReceipt(e)}catch(i){const e=i instanceof Error?i.message:"Failed to print receipt";return v(e),!1}finally{l(!1)}},[]),x=e.useCallback(async e=>{try{v(null),l(!0);return await t.printLabel(e)}catch(i){const e=i instanceof Error?i.message:"Failed to print label";return v(e),!1}finally{l(!1)}},[]),E=e.useCallback(e=>{try{t.updateSettings(e);const i=t.getSettings();g(i)}catch(i){const e=i instanceof Error?i.message:"Failed to update settings";v(e)}},[]),D=e.useCallback(()=>{v(null)},[]);return e.useEffect(()=>{C()},[C]),e.useEffect(()=>{const e=setInterval(()=>{const e=t.isPrinterConnected();if(s(e),!e&&h)d(null);else if(e&&!h){const e=t.getConnectedDevice();d(e)}},2e3);return()=>clearInterval(e)},[h]),{isInitialized:i,isConnected:r,isConnecting:a,isPrinting:o,connectedDevice:h,availableDevices:u,settings:f,error:m,initialize:C,requestDevice:b,connect:y,disconnect:w,print:S,printReceipt:P,printLabel:x,updateSettings:E,clearError:D}};export{i as u};
