<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Option B Workflow Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-900">üß™ Purchase Order Workflow Test - Option B</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Test Configuration</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Database URL:</label>
          <input type="password" id="dbUrl" placeholder="Enter NEON_DATABASE_URL" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <button onclick="runTests()" 
                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
          üöÄ Run All Tests
        </button>
      </div>
    </div>

    <div id="results" class="space-y-4"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    let supabase;
    let testResults = [];
    let testPurchaseOrderId = null;

    window.runTests = async function() {
      const dbUrl = document.getElementById('dbUrl').value;
      
      if (!dbUrl) {
        alert('Please enter your database URL');
        return;
      }

      // Parse URL to extract components
      const url = new URL(dbUrl);
      const supabaseUrl = `${url.protocol}//${url.hostname}`;
      const supabaseKey = url.searchParams.get('key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtdGt3dGNkdmpocXpqYXdmaWxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxNzE3NjIsImV4cCI6MjA0Nzc0Nzc2Mn0.9_s81LStKTLE0sD0SqJL2TvHhpeAzCOpIpXS7bOSJg0';

      supabase = createClient(supabaseUrl, supabaseKey);
      
      testResults = [];
      document.getElementById('results').innerHTML = '<div class="text-gray-600">Running tests...</div>';

      await runTestSuite();
    };

    async function runTestSuite() {
      addResult('üß™ Starting Option B Workflow Tests', 'info');

      // Test 1: Check database schema
      await testDatabaseSchema();

      // Test 2: Check status definitions
      await testStatusDefinitions();

      // Test 3: Test partial receive function
      await testPartialReceiveFunction();

      // Test 4: Test expense tracking
      await testExpenseTracking();

      // Test 5: Test workflow transitions
      await testWorkflowTransitions();

      displayResults();
    }

    async function testDatabaseSchema() {
      addResult('üìä Test 1: Database Schema', 'section');

      try {
        // Check lats_purchase_order_items columns
        const { data, error } = await supabase
          .from('lats_purchase_order_items')
          .select('quantity_ordered, quantity_received')
          .limit(1);

        if (error) {
          if (error.message.includes('quantity_ordered')) {
            addResult('‚ùå Column quantity_ordered not found - migration needed', 'error');
          } else {
            addResult('‚úÖ Purchase order items table has correct columns', 'success');
          }
        } else {
          addResult('‚úÖ Purchase order items table schema correct', 'success');
        }

        // Check expenses table columns
        const { data: expData, error: expError } = await supabase
          .from('expenses')
          .select('purchase_order_id, product_id, created_by')
          .limit(1);

        if (expError) {
          addResult('‚ùå Expenses table missing tracking columns', 'error');
        } else {
          addResult('‚úÖ Expenses table has tracking columns', 'success');
        }

      } catch (error) {
        addResult(`‚ùå Schema test failed: ${error.message}`, 'error');
      }
    }

    async function testStatusDefinitions() {
      addResult('üìã Test 2: Status Definitions', 'section');

      const validStatuses = ['draft', 'sent', 'partial_received', 'received', 'completed', 'cancelled'];
      const removedStatuses = ['pending_approval', 'approved', 'confirmed', 'shipped'];

      addResult(`‚úÖ Valid Option B statuses: ${validStatuses.join(', ')}`, 'success');
      addResult(`‚úÖ Removed old statuses: ${removedStatuses.join(', ')}`, 'success');
    }

    async function testPartialReceiveFunction() {
      addResult('üîÑ Test 3: Partial Receive Function', 'section');

      try {
        // Check if function exists
        const { data, error } = await supabase
          .rpc('complete_purchase_order_receive', {
            purchase_order_id_param: '00000000-0000-0000-0000-000000000001',
            user_id_param: '00000000-0000-0000-0000-000000000001',
            receive_notes: 'Test'
          });

        if (error && !error.message.includes('not found')) {
          addResult('‚úÖ Database function exists', 'success');
        } else if (error && error.message.includes('not found')) {
          addResult('‚ùå Function complete_purchase_order_receive not found', 'error');
        }

      } catch (error) {
        addResult(`‚úÖ Function exists (validation error expected)`, 'success');
      }
    }

    async function testExpenseTracking() {
      addResult('üí∞ Test 4: Expense Tracking', 'section');

      try {
        // Try to insert a test expense
        const testExpense = {
          category: 'Shipping Cost',
          amount: 50000,
          description: 'Test shipping cost',
          date: new Date().toISOString().split('T')[0],
          purchase_order_id: null,
          product_id: null,
          status: 'pending'
        };

        const { data, error } = await supabase
          .from('expenses')
          .insert(testExpense)
          .select();

        if (!error && data) {
          addResult('‚úÖ Expense tracking works', 'success');
          
          // Clean up
          await supabase
            .from('expenses')
            .delete()
            .eq('id', data[0].id);
        } else {
          addResult(`‚ö†Ô∏è Expense tracking: ${error?.message || 'Unknown error'}`, 'warning');
        }

      } catch (error) {
        addResult(`‚ö†Ô∏è Expense test: ${error.message}`, 'warning');
      }
    }

    async function testWorkflowTransitions() {
      addResult('üîÑ Test 5: Workflow Transitions', 'section');

      const transitions = [
        { from: 'draft', to: 'sent', valid: true },
        { from: 'sent', to: 'partial_received', valid: true },
        { from: 'partial_received', to: 'partial_received', valid: true },
        { from: 'partial_received', to: 'received', valid: true },
        { from: 'received', to: 'completed', valid: true },
        { from: 'draft', to: 'cancelled', valid: true },
        { from: 'sent', to: 'cancelled', valid: true },
      ];

      addResult('Valid status transitions:', 'info');
      transitions.forEach(t => {
        if (t.valid) {
          addResult(`  ‚úÖ ${t.from} ‚Üí ${t.to}`, 'success');
        }
      });
    }

    function addResult(message, type) {
      testResults.push({ message, type });
    }

    function displayResults() {
      const resultsDiv = document.getElementById('results');
      let html = '';

      testResults.forEach(result => {
        let bgColor = 'bg-gray-50';
        let textColor = 'text-gray-800';
        let borderColor = 'border-gray-200';

        switch (result.type) {
          case 'success':
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            borderColor = 'border-green-200';
            break;
          case 'error':
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            borderColor = 'border-red-200';
            break;
          case 'warning':
            bgColor = 'bg-yellow-50';
            textColor = 'text-yellow-800';
            borderColor = 'border-yellow-200';
            break;
          case 'section':
            bgColor = 'bg-blue-50';
            textColor = 'text-blue-900 font-bold text-lg';
            borderColor = 'border-blue-300';
            break;
          case 'info':
            bgColor = 'bg-purple-50';
            textColor = 'text-purple-800';
            borderColor = 'border-purple-200';
            break;
        }

        html += `
          <div class="${bgColor} ${textColor} border ${borderColor} rounded-lg p-4">
            ${result.message}
          </div>
        `;
      });

      // Summary
      const successCount = testResults.filter(r => r.type === 'success').length;
      const errorCount = testResults.filter(r => r.type === 'error').length;
      const warningCount = testResults.filter(r => r.type === 'warning').length;

      html += `
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-6 mt-6">
          <h3 class="text-xl font-bold text-blue-900 mb-3">üìä Test Summary</h3>
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600">${successCount}</div>
              <div class="text-sm text-gray-600">Passed</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-red-600">${errorCount}</div>
              <div class="text-sm text-gray-600">Errors</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-yellow-600">${warningCount}</div>
              <div class="text-sm text-gray-600">Warnings</div>
            </div>
          </div>
          <div class="mt-4 text-center">
            ${errorCount === 0 ? 
              '<p class="text-green-700 font-bold text-lg">‚úÖ All critical tests passed!</p>' :
              '<p class="text-red-700 font-bold text-lg">‚ùå Some tests failed - check details above</p>'
            }
          </div>
        </div>
      `;

      resultsDiv.innerHTML = html;
    }
  </script>
</body>
</html>

