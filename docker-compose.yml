version: '3.8'

services:
  postgres:
    image: postgres:17
    container_name: neon-pos-local-db
    environment:
      POSTGRES_USER: neondb_owner
      POSTGRES_PASSWORD: local_password
      POSTGRES_DB: neondb
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neondb_owner -d neondb"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  postgrest:
    image: postgrest/postgrest:latest
    ports:
      - "3000:3000"
    environment:
      # Neon Database Connection
      PGRST_DB_URI: "postgresql://neondb_owner:npg_vABqUKk73tEW@ep-damp-fire-adtxvumr-pooler.c-2.us-east-1.aws.neon.tech:5432/neondb?sslmode=require"
      
      # Database Schema
      PGRST_DB_SCHEMAS: "public"
      PGRST_DB_ANON_ROLE: "neondb_owner"
      
      # JWT Secret - Secure random string generated
      # Generate one with: openssl rand -base64 32
      PGRST_JWT_SECRET: "8PG+blJpq9fIXhiTR12QDvGr7W2fOH0lPOqblKTotDY="
      
      # Server Configuration
      PGRST_OPENAPI_SERVER_PROXY_URI: "http://localhost:3000"
      
      # Optional: Enable OpenAPI documentation
      PGRST_OPENAPI_MODE: "follow-privileges"
      
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: Swagger UI for API documentation
  swagger:
    image: swaggerapi/swagger-ui:latest
    ports:
      - "8080:8080"
    environment:
      API_URL: "http://localhost:3000/"
    depends_on:
      - postgrest

volumes:
  postgres_data:

