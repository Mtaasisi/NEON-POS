name: Neon Database Backup to Google Drive

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python and dependencies
        run: |
          sudo apt-get install -y python3 python3-pip
          pip3 install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Create backup script
        run: |
          cat > upload_to_gdrive.py << 'EOF'
          import os
          import json
          from datetime import datetime
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          from googleapiclient.errors import HttpError

          # Get secrets from environment
          service_account_json = os.environ.get('GDRIVE_SERVICE_ACCOUNT')
          folder_id = os.environ.get('GDRIVE_FOLDER_ID')
          sql_file = os.environ.get('SQL_FILE')

          if not service_account_json or not folder_id or not sql_file:
              raise ValueError("Missing required environment variables")

          # Parse service account JSON
          service_account_info = json.loads(service_account_json)

          # Authenticate and create Drive service
          credentials = service_account.Credentials.from_service_account_info(
              service_account_info,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )
          service = build('drive', 'v3', credentials=credentials)

          # Upload file
          file_metadata = {
              'name': os.path.basename(sql_file),
              'parents': [folder_id]
          }

          media = MediaFileUpload(sql_file, mimetype='text/plain', resumable=True)

          try:
              file = service.files().create(
                  body=file_metadata,
                  media_body=media,
                  fields='id'
              ).execute()
              print(f"File uploaded successfully. File ID: {file.get('id')}")
          except HttpError as error:
              print(f"An error occurred: {error}")
              raise
          EOF

      - name: Create timestamped backup
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          BACKUP_FILE="neon_backup_${TIMESTAMP}.sql"
          
          echo "Creating database backup: $BACKUP_FILE"
          pg_dump "$NEON_DB_URL" > "$BACKUP_FILE"
          
          # Check if backup was successful
          if [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "Error: Backup file is empty or missing"
            exit 1
          fi
          
          # Get file size
          FILE_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "Backup created successfully: $BACKUP_FILE (Size: $FILE_SIZE)"
          
          # Set output for next step
          echo "SQL_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Upload to Google Drive
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SQL_FILE: ${{ env.SQL_FILE }}
        run: |
          python3 upload_to_gdrive.py

      - name: Cleanup
        if: always()
        run: |
          rm -f neon_backup_*.sql upload_to_gdrive.py

