name: Automatic Neon Database Backup

on:
  schedule:
    # Run daily at 02:00 UTC (you can change this)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull PostgreSQL 17 Docker image
        run: |
          docker pull postgres:17-alpine
          echo "âœ… PostgreSQL 17 Docker image ready"
          echo "PostgreSQL client version:"
          docker run --rm postgres:17-alpine pg_dump --version

      - name: Create full database backup
        env:
          DATABASE_URL: ${{ secrets.NEON_DB_URL }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          BACKUP_FILE="neon-backup-full-${TIMESTAMP}.sql"
          
          echo "ðŸ“¥ Creating full database backup..."
          echo "ðŸ• Timestamp: $TIMESTAMP"
          
          # Parse connection string and convert pooler to direct endpoint
          DB_URL="$DATABASE_URL"
          if [[ "$DB_URL" == *"-pooler"* ]]; then
            DB_URL="${DB_URL//-pooler/}"
            echo "ðŸ”„ Converted pooler endpoint to direct endpoint"
          fi
          
          # Create full backup (schema + data) using Docker with PostgreSQL 17
          echo "â³ Running pg_dump with PostgreSQL 17 (this may take a few minutes)..."
          
          # Parse connection string to extract components
          # Format: postgresql://user:password@host:port/database?params
          DB_USER=$(echo "$DB_URL" | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
          DB_PASS=$(echo "$DB_URL" | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')
          DB_HOST=$(echo "$DB_URL" | sed -n 's/.*@\([^/]*\)\/.*/\1/p' | sed 's/:.*//')
          DB_PORT=$(echo "$DB_URL" | sed -n 's/.*@[^:]*:\([0-9]*\)\/.*/\1/p' || echo "5432")
          DB_NAME=$(echo "$DB_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          
          echo "Connecting to: $DB_HOST:$DB_PORT/$DB_NAME"
          
          # Run pg_dump via Docker with PostgreSQL 17
          # Pass connection string directly - Docker handles URL encoding
          docker run --rm \
            -e PGPASSWORD="$DB_PASS" \
            postgres:17-alpine \
            pg_dump "$DB_URL" \
            --no-owner \
            --no-privileges \
            --clean \
            --if-exists \
            --verbose \
            > "$BACKUP_FILE" 2>pg_dump_errors.log || {
            echo "âŒ pg_dump failed. Error log:"
            cat pg_dump_errors.log
            exit 1
          }
          
          # Verify backup was created successfully
          if [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "âŒ Error: Backup file is empty or missing"
            exit 1
          fi
          
          # Get file size
          FILE_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "âœ… Backup created: $BACKUP_FILE"
          echo "ðŸ“Š Size: $FILE_SIZE"
          
          # Compress backup to save space
          echo "ðŸ“¦ Compressing backup..."
          gzip "$BACKUP_FILE"
          BACKUP_FILE="${BACKUP_FILE}.gz"
          COMPRESSED_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "âœ… Compressed: $BACKUP_FILE"
          echo "ðŸ“Š Compressed size: $COMPRESSED_SIZE"
          
          # Set outputs for next step
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV
          echo "BACKUP_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "BACKUP_SIZE=$COMPRESSED_SIZE" >> $GITHUB_ENV

      - name: Upload Backup as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: neon-database-backup-${{ env.BACKUP_TIMESTAMP }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 90
          if-no-files-found: error
          compression-level: 0  # Already compressed with gzip

      - name: Cleanup local files
        if: always()
        run: |
          rm -f neon-backup-*.sql*

      - name: Summary
        run: |
          echo "âœ… Backup completed successfully!"
          echo "ðŸ“¦ Backup file: ${{ env.BACKUP_FILE }}"
          echo "ðŸ“Š Size: ${{ env.BACKUP_SIZE }}"
          echo "ðŸ“… Timestamp: ${{ env.BACKUP_TIMESTAMP }}"
          echo ""
          echo "ðŸ”— Download backup from:"
          echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ’¡ How to restore:"
          echo "   1. Go to Actions tab â†’ Find this workflow run"
          echo "   2. Download the artifact: neon-database-backup-${{ env.BACKUP_TIMESTAMP }}"
          echo "   3. Extract: gunzip neon-backup-full-*.sql.gz"
          echo "   4. Restore: psql \"\$DATABASE_URL\" -f neon-backup-full-*.sql"

