import{u as Lt,b as Et,y as Qe,a as Rt,a4 as $e,a5 as pe,X as zt,j as e,s as Se}from"./index-61458a34.js";import{r,b as Pe}from"./vendor-36d2c7c1.js";import{n as F,X as ke,aE as Ae,a3 as ze,N as Xe,Y as Ke,R as Ot,v as Vt,y as Le,d as de,ax as Ye,ay as Bt,e as Oe,U as Ee,q as _e,af as Ge,r as Ne,A as Ce,aA as Zt,m as et,bN as Re,a6 as Ut,b as Je,a0 as tt,a as Wt,M as Ht,f as Xt,l as Yt,al as Jt,$ as Qt,P as Kt}from"./ui-28e30067.js";import{u as st,S as Gt}from"./useSuccessModal-081786c4.js";import{L as Ve}from"./LoadingSpinner-251d9268.js";import{u as es}from"./useBodyScrollLock-341c8b9f.js";import{C as ts}from"./CustomerTooltip-6a958832.js";const gs=({isOpen:s,onClose:O})=>{const{currentUser:$}=Lt(),{customers:c}=Et(),{currentBranch:h}=Qe(),{startLoading:X,completeLoading:v,failLoading:i}=Rt(),te=st(),C=r.useRef(null),[T,N]=r.useState("installments"),[f,re]=r.useState([]),[ce,se]=r.useState(null),[u,M]=r.useState(!0),[Z,Y]=r.useState([]),[p,ae]=r.useState(""),[t,g]=r.useState("all"),[w,D]=r.useState(""),[A,xe]=r.useState(""),[E,U]=r.useState("created_at"),[I,Q]=r.useState("desc"),[y,R]=r.useState(new Set),[J,n]=r.useState(!1),[o,m]=r.useState(!1),[P,le]=r.useState(!1),[oe,d]=r.useState(!1);r.useState(!1);const[z,G]=r.useState(!1),[K,he]=r.useState(!1),[me,W]=r.useState(!1),[q,l]=r.useState(null),[H,V]=r.useState(null),[L,ee]=r.useState(6),ie=r.useRef(null);r.useRef({});const ne=r.useRef(null),ye=r.useRef(null),[De,at]=r.useState(!1);es(s),r.useEffect(()=>{if(s&&ne.current){const a=ne.current.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');a&&a.focus()}},[s]),r.useEffect(()=>{const a=_=>{ye.current&&!ye.current.contains(_.target)&&at(!1)};return De&&document.addEventListener("mousedown",a),()=>{document.removeEventListener("mousedown",a)}},[De]),r.useEffect(()=>{const a=_=>{var Ie,Te;const S=_.target,k=(Ie=ie.current)==null?void 0:Ie.contains(S),ge=(Te=ye.current)==null?void 0:Te.contains(S),qe=S.tagName==="INPUT"&&S.type==="checkbox";J&&!k&&!ge&&!qe&&(n(!1),R(new Set),m(!1))};return J&&document.addEventListener("mousedown",a),()=>{document.removeEventListener("mousedown",a)}},[J]);const ve=r.useCallback(async(a=!1)=>{if(!(h!=null&&h.id)){M(!1);return}try{M(!0),a&&(console.log("ðŸ”„ [InstallmentManagementModal] Force refresh - clearing cache"),$e.clearInstallments(h.id));const _=a?null:$e.getInstallments(h.id);let S=[];_&&_.length>0?(console.log(`âš¡ [InstallmentManagementModal] Using ${_.length} cached installment plans - instant load!`),S=_,pe.getAllInstallmentPlans(h.id).then(x=>{if(console.log(`âœ… [InstallmentManagementModal] Background refresh completed (${x.length} plans)`),$e.saveInstallments(x,h.id),s){let b=x;p&&(b=b.filter(j=>{var B,je,we;return((je=(B=j.customer)==null?void 0:B.name)==null?void 0:je.toLowerCase().includes(p.toLowerCase()))||((we=j.plan_number)==null?void 0:we.toLowerCase().includes(p.toLowerCase()))})),t!=="all"&&(b=b.filter(j=>j.status===t)),w&&(b=b.filter(j=>new Date(j.created_at)>=new Date(w))),A&&(b=b.filter(j=>new Date(j.created_at)<=new Date(A))),b.sort((j,B)=>{let je,we;switch(E){case"plan_number":je=j.plan_number||"",we=B.plan_number||"";break;case"total_amount":je=j.total_amount||0,we=B.total_amount||0;break;case"next_payment_date":je=j.next_payment_date?new Date(j.next_payment_date).getTime():0,we=B.next_payment_date?new Date(B.next_payment_date).getTime():0;break;default:je=j.created_at?new Date(j.created_at).getTime():0,we=B.created_at?new Date(B.created_at).getTime():0}return I==="asc"?je>we?1:-1:je<we?1:-1}),re(b);const be=b.reduce((j,B)=>j+(parseFloat(B.balance_due)||0),0),fe=b.reduce((j,B)=>j+(parseFloat(B.total_paid)||0),0),Pt=b.reduce((j,B)=>j+(parseFloat(B.total_amount)||0),0),kt=b.length,Dt=b.filter(j=>j.status==="active").length,Ct=b.filter(j=>j.status==="completed").length,It=b.filter(j=>j.status==="defaulted").length,Tt=b.filter(j=>j.status==="cancelled").length,Mt=b.filter(j=>!j.next_payment_date||j.status!=="active"?!1:new Date(j.next_payment_date)<new Date).length,Fe=new Date,Ft=new Date(Fe.getTime()+7*24*60*60*1e3),$t=new Date(Fe.getTime()+30*24*60*60*1e3),At=b.filter(j=>{if(!j.next_payment_date||j.status!=="active")return!1;const B=new Date(j.next_payment_date);return B>=Fe&&B<=Ft}).length,qt=b.filter(j=>{if(!j.next_payment_date||j.status!=="active")return!1;const B=new Date(j.next_payment_date);return B>=Fe&&B<=$t}).length;se({total:kt,active:Dt,completed:Ct,defaulted:It,cancelled:Tt,total_value:Pt,total_paid:fe,total_balance_due:be,overdue_count:Mt,due_this_week:At,due_this_month:qt})}}).catch(x=>{console.warn("âš ï¸ [InstallmentManagementModal] Background refresh failed (non-critical):",x)})):(console.log("ðŸ“¡ [InstallmentManagementModal] No cache found, loading from database..."),S=await pe.getAllInstallmentPlans(h.id),$e.saveInstallments(S,h.id));let k=S;p&&(k=k.filter(x=>{var b,be,fe;return((be=(b=x.customer)==null?void 0:b.name)==null?void 0:be.toLowerCase().includes(p.toLowerCase()))||((fe=x.plan_number)==null?void 0:fe.toLowerCase().includes(p.toLowerCase()))})),t!=="all"&&(k=k.filter(x=>x.status===t)),w&&(k=k.filter(x=>new Date(x.created_at)>=new Date(w))),A&&(k=k.filter(x=>new Date(x.created_at)<=new Date(A))),k.sort((x,b)=>{let be,fe;switch(E){case"plan_number":be=x.plan_number||"",fe=b.plan_number||"";break;case"total_amount":be=x.total_amount||0,fe=b.total_amount||0;break;case"next_payment_date":be=x.next_payment_date?new Date(x.next_payment_date).getTime():0,fe=b.next_payment_date?new Date(b.next_payment_date).getTime():0;break;default:be=x.created_at?new Date(x.created_at).getTime():0,fe=b.created_at?new Date(b.created_at).getTime():0}return I==="asc"?be>fe?1:-1:be<fe?1:-1}),re(k);const ge=k.reduce((x,b)=>x+(parseFloat(b.balance_due)||0),0),qe=k.reduce((x,b)=>x+(parseFloat(b.total_paid)||0),0),Ie=k.reduce((x,b)=>x+(parseFloat(b.total_amount)||0),0),Te=k.length,ft=k.filter(x=>x.status==="active").length,pt=k.filter(x=>x.status==="completed").length,yt=k.filter(x=>x.status==="defaulted").length,jt=k.filter(x=>x.status==="cancelled").length,wt=k.filter(x=>!x.next_payment_date||x.status!=="active"?!1:new Date(x.next_payment_date)<new Date).length,Me=new Date,Nt=new Date(Me.getTime()+7*24*60*60*1e3),vt=new Date(Me.getTime()+30*24*60*60*1e3),_t=k.filter(x=>{if(!x.next_payment_date||x.status!=="active")return!1;const b=new Date(x.next_payment_date);return b>=Me&&b<=Nt}).length,St=k.filter(x=>{if(!x.next_payment_date||x.status!=="active")return!1;const b=new Date(x.next_payment_date);return b>=Me&&b<=vt}).length;se({total:Te,active:ft,completed:pt,defaulted:yt,cancelled:jt,total_value:Ie,total_paid:qe,total_balance_due:ge,overdue_count:wt,due_this_week:_t,due_this_month:St})}catch(_){console.error("Error fetching installment plans:",_),F.error("Failed to load installment plans")}finally{M(!1)}},[h==null?void 0:h.id,p,t,w,A,E,I]),Be=r.useCallback(async()=>{if(h!=null&&h.id)try{const a=await zt.getPOSPaymentMethods();Y(a||[])}catch(a){console.error("Error fetching payment accounts:",a)}},[h==null?void 0:h.id]);r.useEffect(()=>{s&&(ve(),Be())},[s,ve,Be]);const nt=a=>{l(a),G(!0)},lt=a=>{l(a),he(!0)},rt=a=>{l(a),d(!0)},ot=a=>{l(a),G(!0)},it=a=>{l(a),W(!0)},dt=async a=>{const _=X("Sending reminder...");C.current=_;try{const S=await pe.sendPaymentReminder(a,($==null?void 0:$.id)||"");S.success?(F.success("Payment reminder sent successfully"),v(_)):i(_,S.error||"Failed to send reminder")}catch(S){i(_,S.message||"Failed to send payment reminder")}},ct=async()=>{if(y.size===0||!confirm(`Delete ${y.size} installment plan(s)? This action cannot be undone.`))return;const a=X("Deleting plans...");C.current=a;try{const _=await Promise.allSettled(Array.from(y).map(ge=>pe.cancelPlan(ge))),S=_.filter(ge=>ge.status==="fulfilled"&&ge.value.success).length,k=_.length-S;S>0&&F.success(`Successfully cancelled ${S} plan(s)`),k>0&&F.error(`Failed to cancel ${k} plan(s)`),R(new Set),n(!1),m(!1),ve(),v(a)}catch(_){i(a,_.message||"Failed to delete plans")}},Ze=a=>isNaN(a)||a===null||a===void 0?"TZS 0":new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(a),mt=a=>{if(!a)return"N/A";try{return new Date(a).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return"Invalid Date"}},Ue=a=>{switch(a){case"active":return"text-green-600 bg-green-100";case"completed":return"text-blue-600 bg-blue-100";case"defaulted":return"text-red-600 bg-red-100";case"cancelled":return"text-gray-600 bg-gray-100";default:return"text-gray-600 bg-gray-100"}},We=a=>{switch(a){case"active":return e.jsx(de,{className:"w-4 h-4"});case"completed":return e.jsx(tt,{className:"w-4 h-4"});case"defaulted":return e.jsx(Ce,{className:"w-4 h-4"});case"cancelled":return e.jsx(Xt,{className:"w-4 h-4"});default:return e.jsx(Le,{className:"w-4 h-4"})}},ut=a=>a.status==="active"&&new Date(a.next_payment_date)<new Date,xt=async a=>{if(!confirm("Are you sure you want to cancel this installment plan?"))return;const _=X("Cancelling plan...");C.current=_;try{const S=await pe.cancelPlan(a);S.success?(F.success("Installment plan cancelled successfully"),ve(),v(_)):i(_,S.error||"Failed to cancel plan")}catch(S){i(_,S.message||"Failed to cancel installment plan")}},ue=r.useMemo(()=>f.filter(a=>{var S,k,ge;return!p||((k=(S=a.customer)==null?void 0:S.name)==null?void 0:k.toLowerCase().includes(p.toLowerCase()))||((ge=a.plan_number)==null?void 0:ge.toLowerCase().includes(p.toLowerCase()))}),[f,p]),ht=r.useMemo(()=>ue.reduce((a,_)=>a+(_.balance_due||0),0),[ue]),gt=ue.length,bt=ue.filter(a=>a.status==="active").length,He=ue.filter(a=>a.next_payment_date?new Date(a.next_payment_date)<new Date:!1).length;return!s||typeof document>"u"||!document.body?null:Pe.createPortal(e.jsx(e.Fragment,{children:e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[999999]",style:{top:0,left:0,right:0,bottom:0,overflow:"hidden",overscrollBehavior:"none",position:"fixed",zIndex:999999},role:"dialog","aria-modal":"true","aria-labelledby":"installment-management-modal-title",onClick:a=>{a.target===a.currentTarget&&(console.log("ðŸ”µ [InstallmentManagementModal] Backdrop clicked, closing modal"),O())},children:e.jsxs("div",{ref:ne,className:"bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] flex flex-col overflow-hidden relative z-[999999]",style:{zIndex:999999},onClick:a=>a.stopPropagation(),children:[e.jsx("button",{onClick:O,className:"absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50","aria-label":"Close modal",children:e.jsx(ke,{className:"w-6 h-6"})}),e.jsx("div",{className:"p-8 pr-20 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(Ae,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{id:"installment-management-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:"Installment Plans Management"}),e.jsx("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",e.jsx("span",{className:"font-semibold text-gray-900",children:ue.slice(0,L).length})," of ",e.jsx("span",{className:"font-semibold text-gray-900",children:ue.length})," filtered plans",y.size>0&&e.jsxs("span",{className:"ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-700",children:[y.size," selected"]})]})})]})]})}),e.jsx("div",{className:"p-6 pb-0 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-4",children:[e.jsx("div",{className:`p-3 rounded-xl cursor-pointer transition-all duration-200 hover:scale-105 ${t==="all"?"text-purple-600 bg-purple-100 shadow-lg scale-105 ring-2 ring-offset-2 ring-purple-400":"bg-white hover:bg-purple-50 border-2 border-gray-200 hover:border-purple-300 shadow-sm hover:shadow-md"}`,onClick:()=>g("all"),title:"Click to show all plans",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx(ze,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium capitalize",children:"All"})]}),e.jsx("div",{className:"flex items-baseline gap-1",children:e.jsx("span",{className:"text-2xl font-bold",children:gt})})]})}),["active","completed","defaulted","cancelled"].map(a=>{const _=ue.filter(k=>k.status===a).length,S=f.filter(k=>k.status===a).length;return e.jsx("div",{className:`p-3 rounded-xl cursor-pointer transition-all duration-200 hover:scale-105 ${t===a?Ue(a)+" shadow-lg scale-105 ring-2 ring-offset-2 ring-purple-400":"bg-white hover:bg-purple-50 border-2 border-gray-200 hover:border-purple-300 shadow-sm hover:shadow-md"}`,onClick:()=>g(t===a?"all":a),title:`Click to filter by ${a}`,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[We(a),e.jsx("span",{className:"text-xs font-medium capitalize",children:a})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("span",{className:"text-2xl font-bold",children:_}),_!==S&&e.jsxs("span",{className:"text-xs text-gray-500",children:["/ ",S]})]})]})},a)})]})}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200 bg-white",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between",children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsxs("button",{onClick:()=>le(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium",children:[e.jsx(Xe,{size:18}),"New Plan"]}),J&&e.jsxs("button",{onClick:ct,className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium",children:[e.jsx(Ke,{size:18}),"Delete Selected (",y.size,")"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsxs("button",{onClick:async()=>{const a=F.loading("Refreshing installment plans...");try{await ve(!0),F.success("Installment plans refreshed!",{id:a})}catch{F.error("Failed to refresh plans",{id:a})}},disabled:u,className:"flex items-center gap-2 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed",title:"Refresh installment plans",children:[e.jsx(Ot,{className:`w-4 h-4 ${u?"animate-spin":""}`}),"Refresh"]}),e.jsxs("div",{className:"relative",children:[e.jsx(Vt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search plans...",value:p,onChange:a=>ae(a.target.value),className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64"})]}),e.jsxs("select",{value:t,onChange:a=>g(a.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"defaulted",children:"Defaulted"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsx("button",{onClick:()=>n(!J),className:`px-3 py-2 rounded-lg font-medium transition-colors ${J?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:J?"Cancel Selection":"Select Multiple"})]})]})}),e.jsx("div",{className:"px-6 pt-4 border-b border-gray-200 bg-white",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>N("installments"),className:`px-4 py-2 font-medium transition-colors ${T==="installments"?"text-blue-600 border-b-2 border-blue-600":"text-gray-600 hover:text-gray-900"}`,children:"Installments"}),e.jsx("button",{onClick:()=>N("future"),className:`px-4 py-2 font-medium transition-colors ${T==="future"?"text-blue-600 border-b-2 border-blue-600":"text-gray-600 hover:text-gray-900"}`,children:"Future"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4",ref:ie,children:T==="installments"?e.jsx(e.Fragment,{children:u?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(Ve,{}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading installment plans..."})]}):ue.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ae,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No installment plans found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:p?"Try adjusting your search criteria":"Create your first installment plan to get started"}),e.jsxs("button",{onClick:()=>le(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium inline-flex items-center gap-2",children:[e.jsx(Xe,{size:18}),"Create Installment Plan"]})]}):e.jsxs("div",{className:"space-y-3",children:[ue.slice(0,L).map(a=>e.jsx(os,{plan:a,isSelected:y.has(a.id),isSelectionMode:J,onToggleSelect:()=>{R(_=>{const S=new Set(_);return S.has(a.id)?S.delete(a.id):S.add(a.id),S})},isExpanded:H===a.id,onToggleExpanded:()=>V(H===a.id?null:a.id),formatCurrency:Ze,formatDate:mt,getStatusColor:Ue,getStatusIcon:We,isOverdue:ut,handleViewPlan:nt,handleRecordPayment:rt,handleEditPlan:lt,handleSendReminder:dt,handleViewSchedule:ot,handleViewPaymentHistory:it,handleCancelPlan:xt},a.id)),ue.length>L&&e.jsx("div",{className:"text-center py-4",children:e.jsx("button",{onClick:()=>ee(a=>a+6),className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium",children:"Load More Plans"})})]})}):e.jsx("div",{className:"flex flex-col items-center justify-center py-16",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(Le,{className:"w-10 h-10 text-purple-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-3",children:"Coming Soon"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"This section is reserved for future features and enhancements to the installment management system."}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 border border-gray-200",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Potential Features:"}),e.jsxs("ul",{className:"text-sm text-gray-600 space-y-2 text-left",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Advanced analytics and reporting"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Bulk operations and batch processing"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Automated payment reminders"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Export and print capabilities"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Custom payment schedules"})]})]})]})]})})})]}),e.jsx("div",{className:"border-t border-gray-200 bg-white flex-shrink-0",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-8 text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:ue.length})," plans"]}),e.jsxs("span",{className:"text-gray-600",children:[e.jsx("span",{className:"font-semibold text-green-600",children:bt})," active"]}),e.jsxs("span",{className:"text-gray-600",children:[e.jsx("span",{className:"font-semibold text-orange-600",children:Ze(ht)})," outstanding"]}),He>0&&e.jsxs("span",{className:"text-gray-600",children:[e.jsx("span",{className:"font-semibold text-red-600",children:He})," overdue"]})]}),e.jsx("button",{onClick:O,className:"px-5 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors text-sm",children:"Close"})]})})}),P&&e.jsx(ss,{isOpen:P,onClose:()=>le(!1),onSuccess:()=>{le(!1),ve()},customers:c,paymentAccounts:Z,currentUser:$}),oe&&q&&e.jsx(as,{isOpen:oe,onClose:()=>d(!1),onSuccess:()=>{d(!1),ve(!0)},plan:q,paymentAccounts:Z,currentUser:$}),z&&q&&e.jsx(ns,{isOpen:z,onClose:()=>G(!1),plan:q}),K&&q&&e.jsx(ls,{isOpen:K,onClose:()=>he(!1),onSuccess:()=>{he(!1),ve(!0)},plan:q,paymentAccounts:Z,currentUser:$}),me&&q&&e.jsx(rs,{isOpen:me,onClose:()=>W(!1),plan:q}),e.jsx(Gt,{...te.props})]})})}),document.body)},ss=({isOpen:s,onClose:O,onSuccess:$,customers:c,paymentAccounts:h,currentUser:X})=>{const{currentBranch:v}=Qe(),i=st(),[te,C]=r.useState([]),[T,N]=r.useState(!1),[f,re]=r.useState(1),[ce,se]=r.useState(!1),[u,M]=r.useState(0),[Z,Y]=r.useState([]),[p,ae]=r.useState(new Date().toISOString().split("T")[0]),[t,g]=r.useState({customer_id:"",sale_id:"",total_amount:0,down_payment:0,number_of_installments:3,payment_frequency:"monthly",start_date:new Date().toISOString().split("T")[0],late_fee_amount:0,notes:"",payment_method:"cash",account_id:""}),[w,D]=r.useState(!1),A=n=>{const o=typeof n=="string"?parseFloat(n):n;return o%1===0?o.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):o.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};r.useEffect(()=>{if(s){document.body.style.overflow="hidden";const n=new Date().toISOString().split("T")[0];ae(n);const o=t.payment_frequency||"monthly",m=I(n,o);g(P=>({...P,start_date:m}))}else document.body.style.overflow="",re(1),M(0),se(!1),Y([]),ae(new Date().toISOString().split("T")[0]);return()=>{document.body.style.overflow=""}},[s]),r.useEffect(()=>{(async()=>{if(!s||!(v!=null&&v.id)){C([]);return}N(!0);try{const{data:o,error:m}=await Se.from("lats_sales").select(`
            id,
            sale_number,
            customer_id,
            total_amount,
            payment_status,
            created_at,
            customers (name, phone)
          `).eq("branch_id",v.id).in("payment_status",["unpaid","partial"]).order("created_at",{ascending:!1}).limit(50);m?(console.error("Error fetching sales:",m),F.error("Failed to load sales"),C([])):C(o||[])}catch(o){console.error("Error fetching sales:",o),F.error("Failed to load sales"),C([])}finally{N(!1)}})()},[s,v==null?void 0:v.id]);const xe=n=>{const o=te.find(m=>m.id===n);g(o?m=>({...m,sale_id:n,customer_id:o.customer_id,total_amount:o.total_amount,notes:`Linked to sale ${o.sale_number}`}):m=>({...m,sale_id:"",total_amount:0,notes:""}))},E=(t.total_amount||0)-(t.down_payment||0)-(u||0),U=E/(t.number_of_installments||1),I=r.useCallback((n,o)=>{const m=new Date(n),P=new Date(m);switch(o){case"weekly":P.setDate(m.getDate()+7);break;case"bi_weekly":P.setDate(m.getDate()+14);break;case"monthly":P.setMonth(m.getMonth()+1);break;default:P.setMonth(m.getMonth()+1)}return P.toISOString().split("T")[0]},[]),Q=r.useCallback((n,o,m)=>{const P=[],le=new Date(n);for(let oe=0;oe<o;oe++){const d=new Date(le);m==="monthly"?d.setMonth(le.getMonth()+oe):m==="weekly"?d.setDate(le.getDate()+oe*7):m==="bi_weekly"&&d.setDate(le.getDate()+oe*14),P.push(d.toISOString().split("T")[0])}return P},[]);r.useEffect(()=>{if(p&&t.payment_frequency){const n=I(p,t.payment_frequency);g(o=>({...o,start_date:n}))}},[p,t.payment_frequency,I]),r.useEffect(()=>{if(s&&!ce&&t.number_of_installments&&t.start_date&&t.payment_frequency){const n=Q(t.start_date,t.number_of_installments,t.payment_frequency);Y(n)}},[s,t.number_of_installments,t.start_date,t.payment_frequency,ce,Q]);const y=()=>{if(f===1){if(!t.customer_id||!t.total_amount||t.number_of_installments<1){F.error("Please fill in all required fields");return}re(2)}else if(f===2){if(!t.start_date){F.error("Please set the next payment date");return}if(ce&&Z.some(n=>!n)){F.error("Please fill in all installment dates");return}re(3)}},R=()=>{f>1&&re(f-1)},J=async n=>{var le,oe,d,z,G,K,he,me,W,q;if(n.preventDefault(),!t.customer_id||!t.account_id){F.error("Please fill in all required fields");return}const o=U*(t.number_of_installments||1),m=(t.down_payment||0)+(u||0)+o,P=Math.abs(m-(t.total_amount||0));if(P>.01){console.error("âŒ [InstallmentManagementModal] Payment balance mismatch:",{totalAmount:t.total_amount,downPayment:t.down_payment,firstPayment:u,totalInstallments:o,totalPayments:m,difference:P}),F.error(`Payment amounts don't balance!

Total Amount: ${A(t.total_amount||0)} TZS
Down Payment: ${A(t.down_payment||0)} TZS
First Payment: ${A(u||0)} TZS
Installments Total: ${A(o)} TZS
Total Payments: ${A(m)} TZS

Difference: ${A(P)} TZS

Please adjust the amounts so they equal the total amount.`);return}D(!0);try{const l=await pe.createInstallmentPlan(t,X==null?void 0:X.id,v==null?void 0:v.id);l.success?(u>0&&l.plan,$(),i.show("Installment plan has been created successfully!",{title:"Plan Created",actionButtons:[{label:"View Plans",onClick:()=>{},variant:"primary"}]}),re(1),M(0),se(!1),Y([])):F.error(l.error||"Failed to create installment plan")}catch(l){console.error("âŒ [InstallmentManagementModal] Error creating installment plan:",l),console.error("âŒ [InstallmentManagementModal] Error Details:",{message:l==null?void 0:l.message,code:l==null?void 0:l.code,status:l==null?void 0:l.status,name:l==null?void 0:l.name,formData:t});let H="An error occurred while creating the installment plan.",V="Error";(le=l==null?void 0:l.message)!=null&&le.includes("Failed to fetch")||(oe=l==null?void 0:l.message)!=null&&oe.includes("NetworkError")||(d=l==null?void 0:l.message)!=null&&d.includes("timeout")||(l==null?void 0:l.code)==="NETWORK_ERROR"?(V="Network Error",H="Unable to connect to the server. Please check your internet connection and try again."):(l==null?void 0:l.code)==="23505"||(z=l==null?void 0:l.message)!=null&&z.includes("duplicate")||(G=l==null?void 0:l.message)!=null&&G.includes("unique")?(V="Duplicate Entry",H="An installment plan with these details already exists. Please check and try again."):(l==null?void 0:l.code)==="23502"||(K=l==null?void 0:l.message)!=null&&K.includes("null value")||(he=l==null?void 0:l.message)!=null&&he.includes("required")?(V="Validation Error",H="Some required information is missing. Please check all fields and try again."):(l==null?void 0:l.code)==="42501"||(me=l==null?void 0:l.message)!=null&&me.includes("permission")||(W=l==null?void 0:l.message)!=null&&W.includes("unauthorized")?(V="Permission Denied",H="You do not have permission to create installment plans. Please contact your administrator."):(q=l==null?void 0:l.message)!=null&&q.includes("Payment amounts don't balance")?(V="Payment Balance Error",H=l.message):l!=null&&l.message&&(H=l.message),F.error(`${V}: ${H}`,{duration:6e3})}finally{D(!1)}};return s?Pe.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[1000000]",style:{top:0,left:0,right:0,bottom:0,zIndex:1e6},role:"dialog","aria-modal":"true","aria-labelledby":"installment-modal-title",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:O,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(ke,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(Ae,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"installment-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:"Create Installment Plan"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Set up payment plan for customer"})]})]})}),e.jsxs("form",{onSubmit:J,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsx("div",{className:"px-6 pt-4 pb-2 border-b border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:`flex items-center gap-2 ${f>=1?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold ${f>=1?"bg-blue-600 text-white":"bg-gray-200 text-gray-500"}`,children:f>1?e.jsx(Ye,{className:"w-5 h-5"}):"1"}),e.jsx("span",{className:"text-sm font-medium",children:"Basic Info"})]}),e.jsx("div",{className:`w-12 h-0.5 ${f>=2?"bg-blue-600":"bg-gray-300"}`}),e.jsxs("div",{className:`flex items-center gap-2 ${f>=2?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold ${f>=2?"bg-blue-600 text-white":"bg-gray-200 text-gray-500"}`,children:f>2?e.jsx(Ye,{className:"w-5 h-5"}):"2"}),e.jsx("span",{className:"text-sm font-medium",children:"Payment Dates"})]}),e.jsx("div",{className:`w-12 h-0.5 ${f>=3?"bg-blue-600":"bg-gray-300"}`}),e.jsxs("div",{className:`flex items-center gap-2 ${f>=3?"text-blue-600":"text-gray-400"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold ${f>=3?"bg-blue-600 text-white":"bg-gray-200 text-gray-500"}`,children:"3"}),e.jsx("span",{className:"text-sm font-medium",children:"Payment Details"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-6 space-y-6",children:[f===1&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-50 p-5 rounded-xl border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Bt,{className:"w-5 h-5 text-blue-600"}),e.jsx("label",{className:"block text-sm font-bold text-blue-900",children:"Link to Existing Sale (Optional)"})]}),T?e.jsxs("div",{className:"w-full px-4 py-3 border-2 border-blue-300 rounded-xl bg-white flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Loading sales..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:t.sale_id,onChange:n=>xe(n.target.value),className:"w-full px-4 py-3 border-2 border-blue-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-white font-medium",children:[e.jsx("option",{value:"",children:"-- Create New Installment (No Sale Link) --"}),te.length>0?te.map(n=>{var o;return e.jsxs("option",{value:n.id,children:[n.sale_number," - ",((o=n.customers)==null?void 0:o.name)||"Unknown Customer"," - ",A(n.total_amount)," TZS (",n.payment_status,")"]},n.id)}):e.jsx("option",{value:"",disabled:!0,children:"No unpaid or partial sales found"})]}),te.length===0&&!T&&e.jsxs("p",{className:"text-xs text-orange-600 mt-2 flex items-center gap-1",children:[e.jsx(Oe,{className:"w-3 h-3"}),"No unpaid or partial sales available to link"]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Customer ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:t.customer_id,onChange:n=>g(o=>({...o,customer_id:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,disabled:!!t.sale_id,children:[e.jsx("option",{value:"",children:"Select Customer"}),c.map(n=>e.jsxs("option",{value:n.id,children:[n.name," - ",n.phone]},n.id))]})]}),t.sale_id&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),"Auto-selected from linked sale"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Total Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:A(t.total_amount||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),m=parseFloat(o)||0;g(P=>({...P,total_amount:m}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white disabled:bg-gray-100 disabled:cursor-not-allowed",required:!0,disabled:!!t.sale_id})]}),t.sale_id&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx(de,{className:"w-3 h-3"}),"Auto-populated from linked sale"]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Down Payment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:A(t.down_payment||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),m=parseFloat(o)||0;g(P=>({...P,down_payment:m}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white",required:!0})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["First Payment ",e.jsx("span",{className:"text-gray-500",children:"(Optional)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:A(u||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),m=parseFloat(o)||0;M(m)},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white",placeholder:"0"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Additional payment after down payment"})]}),e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border-2 border-blue-200 shadow-sm",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Ge,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-0.5",children:"Amount to Finance"}),e.jsxs("p",{className:"text-lg font-bold text-blue-900",children:[A(E)," TZS"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Ne,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-0.5",children:"Per Installment"}),e.jsxs("p",{className:"text-lg font-bold text-emerald-900",children:[A(U)," TZS"]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Number of Installments ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",value:t.number_of_installments,onChange:n=>g(o=>({...o,number_of_installments:parseInt(n.target.value)||1})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white",min:"1",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Frequency ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:t.payment_frequency,onChange:n=>{const o=n.target.value;if(g(m=>({...m,payment_frequency:o})),p){const m=I(p,o);g(P=>({...P,start_date:m}))}},className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"bi_weekly",children:"Bi-Weekly"}),e.jsx("option",{value:"monthly",children:"Monthly"})]})]})]})]}),f===2&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Plan Start Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"date",value:p,onChange:n=>{if(ae(n.target.value),t.payment_frequency){const o=I(n.target.value,t.payment_frequency);g(m=>({...m,start_date:o}))}},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"When the installment plan starts"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Next Payment Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"date",value:t.start_date,onChange:n=>g(o=>({...o,start_date:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[t.payment_frequency==="weekly"&&"Calculated: 1 week from start date",t.payment_frequency==="bi_weekly"&&"Calculated: 2 weeks from start date",t.payment_frequency==="monthly"&&"Calculated: 1 month from start date"]})]})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-xl border-2 border-yellow-200",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("input",{type:"checkbox",id:"useCustomDates",checked:ce,onChange:n=>{const o=n.target.checked;if(se(o),!o&&t.start_date&&t.number_of_installments&&t.payment_frequency){const m=Q(t.start_date,t.number_of_installments,t.payment_frequency);Y(m)}},className:"w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"useCustomDates",className:"text-sm font-medium text-gray-700 cursor-pointer",children:"Use custom dates for each installment"})]}),e.jsx("p",{className:"text-xs text-gray-600 ml-8",children:"Enable this to set individual dates for each payment instead of using the frequency-based schedule"})]}),t.number_of_installments>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Installment Payment Dates"}),e.jsx("div",{className:"max-h-96 overflow-y-auto space-y-3 pr-2",children:Array.from({length:t.number_of_installments},(n,o)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-200",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-bold text-blue-700",children:o+1})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:["Installment ",o+1," Due Date"]}),e.jsx("input",{type:"date",value:Z[o]||"",onChange:m=>{const P=[...Z];P[o]=m.target.value,Y(P)},disabled:!ce,className:"w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("span",{className:"text-sm font-bold text-gray-700",children:[A(U)," TZS"]})})]},o))})]})]}),f===3&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Late Fee Amount"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-orange-400"}),e.jsx("input",{type:"text",value:A(t.late_fee_amount||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),m=parseFloat(o)||0;g(P=>({...P,late_fee_amount:m}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 text-gray-900 font-medium bg-white"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:t.payment_method,onChange:n=>g(o=>({...o,payment_method:n.target.value})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"card",children:"Card"})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Zt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:t.account_id,onChange:n=>g(o=>({...o,account_id:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),h.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Notes"}),e.jsxs("div",{className:"relative",children:[e.jsx(ze,{className:"absolute left-4 top-4 w-5 h-5 text-gray-400"}),e.jsx("textarea",{value:t.notes,onChange:n=>g(o=>({...o,notes:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white resize-none",placeholder:"Plan details...",rows:3})]})]})]})]}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:f===1?O:R,className:"flex-1 px-6 py-3.5 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all shadow-sm",children:f===1?"Cancel":"Previous"}),f<3?e.jsx("button",{type:"button",onClick:y,className:"flex-1 px-6 py-3.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl text-lg",children:"Next"}):e.jsx("button",{type:"submit",disabled:w||!t.customer_id||!t.account_id,className:"flex-1 px-6 py-3.5 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl text-lg",children:w?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Creating..."]}):"Create Installment Plan"})]})})]})]})}),document.body):null},as=({isOpen:s,onClose:O,onSuccess:$,plan:c,paymentAccounts:h,currentUser:X})=>{var se;const v=u=>isNaN(u)||u===null||u===void 0?"TZS 0":new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(u),i=()=>{const u=Number(c.installment_amount||0),M=Number(c.balance_due||0),Z=Math.min(u,M);return M>0?Number(Z.toFixed(2)):0},te=i(),[C,T]=r.useState({installment_plan_id:c.id,customer_id:c.customer_id,amount:te,payment_method:"cash",account_id:"",reference_number:"",notes:""}),[N,f]=r.useState(!1);r.useEffect(()=>{if(s){const u=i();T({installment_plan_id:c.id,customer_id:c.customer_id,amount:u,account_id:"",reference_number:"",notes:""})}},[s,c.id,c.customer_id,c.installment_amount,c.balance_due]);const re=async u=>{u.preventDefault();const M=Number(c.installments_paid||0),Z=Number(c.number_of_installments||0),Y=M<Z,p=Number(c.balance_due||0);if(c.status==="cancelled"){F.error("This installment plan has been cancelled. Payments cannot be recorded.");return}const ae=!Y&&p<=0;if(c.status==="completed"&&ae){F.error("This installment plan is already completed. All payments have been received.");return}const t=Number(C.amount||0);if(t<=0){F.error("Payment amount must be greater than zero.");return}if(!Y&&t>p&&p>0){F.error(`Payment amount (${v(t)}) cannot exceed the remaining balance (${v(p)}).`);return}if(!C.account_id){F.error("Please select a payment account");return}const g=h.find(D=>D.id===C.account_id),w=(g==null?void 0:g.type)||"cash";f(!0);try{const D=await pe.recordPayment({...C,payment_method:w},X==null?void 0:X.id);D.success?(F.success("Payment recorded successfully!"),D.planCompleted?setTimeout(()=>{$()},500):$()):F.error(D.error||"Failed to record payment")}catch(D){console.error("Payment recording error:",D),F.error(D.message||"An error occurred while recording the payment")}finally{f(!1)}};if(!s)return null;const ce=u=>{const M=typeof u=="string"?parseFloat(u):u;return isNaN(M)||M===null||M===void 0?"0":M%1===0?M.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):M.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};return Pe.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[1000000]",style:{top:0,left:0,right:0,bottom:0,zIndex:1e6},role:"dialog","aria-modal":"true","aria-labelledby":"record-payment-modal-title",onClick:u=>{u.target===u.currentTarget&&O()},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:O,className:"absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50","aria-label":"Close modal",children:e.jsx(ke,{className:"w-6 h-6"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(_e,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"record-payment-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:"Record Payment"}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:c.plan_number})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:e.jsxs("div",{className:"py-4",children:[e.jsx("div",{className:"bg-white rounded-xl p-6 mb-4 border border-gray-200 shadow-sm",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Customer:"}),e.jsx("span",{className:"text-base font-bold text-gray-900",children:((se=c.customer)==null?void 0:se.name)||"N/A"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Installments Paid:"}),e.jsxs("span",{className:"text-base font-bold text-gray-900",children:[c.installments_paid||0," / ",c.number_of_installments]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Remaining Balance:"}),e.jsx("span",{className:"text-lg font-bold text-red-600",children:v(c.balance_due||0)})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Calculated Installment Amount:"}),e.jsxs("span",{className:"text-lg font-bold text-blue-600",children:[ce(c.installment_amount||0)," TZS"]})]}),c.balance_due&&c.balance_due>0&&c.balance_due<(c.installment_amount||0)&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Oe,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-yellow-800",children:"Final Payment"}),e.jsxs("p",{className:"text-xs text-yellow-700 mt-1",children:["This is the last payment. Amount set to remaining balance: ",e.jsx("strong",{children:v(c.balance_due)})]})]})]})})]})}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:ce(C.amount||0),onChange:u=>{const M=u.target.value.replace(/,/g,""),Z=parseFloat(M)||0,Y=Number(c.balance_due||0),p=Math.min(Z,Y);T(ae=>({...ae,amount:p}))},className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-xl font-bold bg-white",placeholder:"Enter payment amount",min:"0",max:c.balance_due||0,step:"0.01",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:h.length===0?e.jsx("div",{className:"col-span-2 p-4 text-center text-sm text-gray-500 border-2 border-gray-200 rounded-xl bg-gray-50",children:"No payment accounts available"}):h.map((u,M)=>{const Z=C.account_id===u.id,Y=[{selected:"bg-blue-600 border-blue-700 text-white",unselected:"bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100"},{selected:"bg-green-600 border-green-700 text-white",unselected:"bg-green-50 border-green-200 text-green-700 hover:bg-green-100"},{selected:"bg-purple-600 border-purple-700 text-white",unselected:"bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100"},{selected:"bg-orange-600 border-orange-700 text-white",unselected:"bg-orange-50 border-orange-200 text-orange-700 hover:bg-orange-100"},{selected:"bg-indigo-600 border-indigo-700 text-white",unselected:"bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100"},{selected:"bg-pink-600 border-pink-700 text-white",unselected:"bg-pink-50 border-pink-200 text-pink-700 hover:bg-pink-100"}],p=Y[M%Y.length];return e.jsxs("button",{type:"button",onClick:()=>T(ae=>({...ae,account_id:u.id})),className:`px-4 py-4 rounded-xl font-bold text-sm transition-all border-2 shadow-sm ${Z?`${p.selected} shadow-lg scale-105 ring-2 ring-offset-2 ring-offset-white`:`${p.unselected} hover:shadow-md`}`,children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[Z&&e.jsx(de,{className:"w-5 h-5"}),e.jsx("span",{className:"font-semibold",children:u.name})]}),u.account_type&&e.jsx("div",{className:`mt-1 text-xs font-medium ${Z?"text-white/80":"opacity-70"}`,children:u.account_type})]},u.id)})}),!C.account_id&&h.length>0&&e.jsx("p",{className:"mt-2 text-xs text-red-600 font-medium",children:"Please select a payment account"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Reference Number"}),e.jsx("input",{type:"text",value:C.reference_number||"",onChange:u=>T(M=>({...M,reference_number:u.target.value})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 font-medium bg-white",placeholder:"Transaction reference"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Notes"}),e.jsx("textarea",{value:C.notes||"",onChange:u=>T(M=>({...M,notes:u.target.value})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 font-medium bg-white resize-none",placeholder:"Payment notes...",rows:3})]})]})]})}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsx("form",{onSubmit:re,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:O,className:"flex-1 px-6 py-3.5 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all shadow-sm",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:N,className:"flex-1 px-6 py-3.5 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl text-lg",children:N?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Recording..."]}):"Record Payment"})]})})})]})}),document.body)},ns=({isOpen:s,onClose:O,plan:$})=>{var p,ae;const[c,h]=r.useState([]),[X,v]=r.useState(!0),[i,te]=r.useState($),[C,T]=r.useState([]),[N,f]=r.useState(null),[re,ce]=r.useState(null);if(r.useEffect(()=>{(async()=>{if(!s||!$.id)return;v(!0);const g=await pe.getInstallmentPlanById($.id);if(g){if(te(g),h(g.payments||[]),g.sale_id){const{data:w}=await Se.from("lats_sale_items").select("*").eq("sale_id",g.sale_id);if(w&&w.length>0){const D=[...new Set(w.map(y=>y.product_id).filter(Boolean))],A=[...new Set(w.map(y=>y.variant_id).filter(Boolean))],[xe,E]=await Promise.all([D.length>0?Se.from("lats_products").select("id, name, sku").in("id",D):{data:[]},A.length>0?Se.from("lats_product_variants").select("id, name, variant_name, sku").in("id",A):{data:[]}]),U=new Map((xe.data||[]).map(y=>[y.id,y])),I=new Map((E.data||[]).map(y=>[y.id,{...y,name:y.name||y.variant_name||"Unnamed"}]));if(D.length>0){const{data:y}=await Se.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",D).order("is_primary",{ascending:!1});y&&y.forEach(R=>{const J=U.get(R.product_id);if(J){J.images||(J.images=[]);const n={id:R.id,url:R.thumbnail_url||R.image_url,thumbnailUrl:R.thumbnail_url,isPrimary:R.is_primary||!1};R.is_primary?J.images.unshift(n):J.images.push(n)}})}const Q=w.map(y=>({...y,lats_products:U.get(y.product_id),lats_product_variants:I.get(y.variant_id)}));T(Q)}}if(g.branch_id){const{data:w}=await Se.from("store_locations").select("id, name, address").eq("id",g.branch_id).single();w&&f(w)}if(g.created_by){const{data:w}=await Se.from("users").select("id, full_name, email").eq("id",g.created_by).single();w&&ce(w)}}v(!1)})()},[s,$.id,$.updated_at]),!s)return null;const se=t=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(t),u=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),Y=[...(()=>{const t=[],g=i.down_payment>0?new Date(i.start_date):new Date(i.start_date),D=((E,U,I)=>{const Q=E-U,y=U>0?I-1:I;if(y<=0)return[];const R=[],J=Q/y;let n=0;for(let m=0;m<y-1;m++){const P=Math.round(J*100)/100;R.push(P),n+=P}const o=Math.round((Q-n)*100)/100;return R.push(o),R})(i.total_amount,i.down_payment||0,i.number_of_installments);if(i.down_payment>0){const E=c.find(R=>(R.installment_number===1||R.installment_number===0)&&Math.abs(Number(R.amount)-i.down_payment)<.01),U=(i.total_paid||0)>=i.down_payment,I=E&&E.status==="paid"||U,Q=new Date(g),y=!I&&new Date>Q;t.push({installmentNumber:1,dueDate:Q.toISOString(),amount:i.down_payment,status:I?"paid":y?"overdue":"pending",payment:E,daysOverdue:y?Math.floor((new Date().getTime()-Q.getTime())/(1e3*60*60*24)):0})}const A=i.down_payment>0?i.number_of_installments-1:i.number_of_installments,xe=i.down_payment>0?new Date(i.next_payment_date||i.start_date):new Date(i.start_date);for(let E=0;E<A;E++){const U=new Date(xe);i.payment_frequency==="weekly"?U.setDate(xe.getDate()+E*7):i.payment_frequency==="monthly"?U.setMonth(xe.getMonth()+E):(i.payment_frequency==="bi_weekly"||i.payment_frequency==="bi-weekly")&&U.setDate(xe.getDate()+E*14);const I=i.down_payment>0?E+2:E+1,Q=c.find(n=>n.installment_number===I),y=Q&&Q.status==="paid",R=!y&&new Date>U,J=D[E]||i.installment_amount;t.push({installmentNumber:I,dueDate:U.toISOString(),amount:J,status:y?"paid":R?"overdue":"pending",payment:Q,daysOverdue:R?Math.floor((new Date().getTime()-U.getTime())/(1e3*60*60*24)):0})}return t})()].sort((t,g)=>t.status==="paid"&&g.status!=="paid"?1:t.status!=="paid"&&g.status==="paid"?-1:t.installmentNumber-g.installmentNumber);return Pe.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[1000000]",style:{top:0,left:0,right:0,bottom:0,zIndex:1e6},role:"dialog","aria-modal":"true","aria-labelledby":"view-plan-modal-title",onClick:t=>{t.target===t.currentTarget&&O()},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:O,className:"absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50","aria-label":"Close modal",children:e.jsx(ke,{className:"w-6 h-6"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(ze,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"view-plan-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:i.plan_number}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Installment Plan Details"})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:X?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(Ve,{}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading plan details..."})]}):e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsx("div",{className:"bg-white rounded-xl p-6 mb-4 border border-gray-200 shadow-sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Customer:"}),e.jsx("span",{className:"text-base font-bold text-gray-900",children:((p=i.customer)==null?void 0:p.name)||"N/A"})]}),((ae=i.customer)==null?void 0:ae.phone)&&e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Phone:"}),e.jsx("span",{className:"text-base font-bold text-gray-900",children:i.customer.phone})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:`font-bold uppercase px-3 py-1.5 rounded-lg text-xs ${i.status==="active"?"bg-green-100 text-green-700":i.status==="completed"?"bg-gray-100 text-gray-700":i.status==="defaulted"?"bg-red-100 text-red-700":"bg-orange-100 text-orange-700"}`,children:i.status})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Created:"}),e.jsx("span",{className:"text-base font-bold text-gray-900",children:u(i.created_at)})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-200 shadow-sm",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5 text-green-600"}),"Financial Summary"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl border border-gray-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Total Amount"}),e.jsx("p",{className:"text-xl font-bold text-gray-900",children:se(i.total_amount)})]}),e.jsxs("div",{className:"p-4 bg-blue-50 rounded-xl border border-blue-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Down Payment"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:se(i.down_payment)})]}),e.jsxs("div",{className:"p-4 bg-green-50 rounded-xl border border-green-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Total Paid"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:se(i.total_paid||0)})]}),e.jsxs("div",{className:"p-4 bg-red-50 rounded-xl border border-red-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Balance Due"}),e.jsx("p",{className:"text-xl font-bold text-red-600",children:se(i.balance_due)})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-purple-600"}),"Installment Schedule"]}),e.jsx("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-purple-50 border border-purple-200 rounded-lg",children:e.jsxs("span",{className:"text-xs font-semibold text-purple-700",children:[c.filter(t=>t.status==="paid"&&t.installment_number>0).length," / ",i.number_of_installments," Paid"]})})]}),e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto pr-1",children:Y.map((t,g)=>{const w=t.status==="paid",D=t.status==="overdue";return t.status,e.jsxs("div",{className:`group relative p-5 rounded-2xl border-2 transition-all duration-200 ${w?"bg-white border-green-300 shadow-md hover:shadow-lg":D?"bg-white border-red-300 shadow-md hover:shadow-lg":"bg-white border-gray-200 hover:border-gray-300 hover:shadow-sm"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsxs("div",{className:`relative flex-shrink-0 w-14 h-14 rounded-full flex items-center justify-center font-bold text-lg shadow-lg ${w?"bg-gradient-to-br from-green-500 to-green-600 text-white":D?"bg-gradient-to-br from-red-500 to-red-600 text-white":"bg-gradient-to-br from-gray-400 to-gray-500 text-white"}`,children:[t.installmentNumber,w&&e.jsx("div",{className:"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center border-2 border-white",children:e.jsx(de,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ne,{className:`w-4 h-4 flex-shrink-0 ${w?"text-green-600":D?"text-red-600":"text-gray-500"}`}),e.jsx("div",{className:"text-base font-bold text-gray-900",children:u(t.dueDate)})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-bold uppercase ${w?"bg-green-100 text-green-800 border border-green-200":D?"bg-red-100 text-red-800 border border-red-200":"bg-gray-100 text-gray-700 border border-gray-200"}`,children:[w&&e.jsx(de,{className:"w-3.5 h-3.5"}),D&&e.jsx(Ce,{className:"w-3.5 h-3.5"}),t.status]}),D&&t.daysOverdue&&e.jsxs("span",{className:"text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200",children:[t.daysOverdue," days late"]}),w&&t.payment&&e.jsxs("span",{className:"text-xs font-medium text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200",children:["Paid on ",u(t.payment.payment_date)]})]}),w&&t.payment&&t.payment.reference_number&&e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Ref:"})," ",t.payment.reference_number]})]})]}),e.jsxs("div",{className:"flex-shrink-0 text-right ml-4",children:[e.jsx("div",{className:`text-2xl font-bold mb-1 ${w?"text-green-700":D?"text-red-700":"text-gray-900"}`,children:se(t.amount)}),w&&e.jsxs("div",{className:"flex items-center justify-end gap-1 text-xs text-green-600 font-medium",children:[e.jsx(de,{className:"w-3 h-3"}),e.jsx("span",{children:"Completed"})]})]})]}),g<Y.length-1&&e.jsx("div",{className:`absolute left-7 top-full w-0.5 h-3 ${w?"bg-green-300":D?"bg-red-300":"bg-gray-300"}`})]},t.installmentNumber)})})]})]})}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsx("button",{type:"button",onClick:O,className:"w-full px-6 py-3.5 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition-all shadow-lg hover:shadow-xl text-lg",children:"Close"})})]})}),document.body)},ls=({isOpen:s,onClose:O,onSuccess:$,plan:c})=>{const[h,X]=r.useState({late_fee_amount:c.late_fee_amount,notes:c.notes||"",status:c.status}),[v,i]=r.useState(!1),te=async C=>{C.preventDefault(),i(!0);try{const T=await pe.updateInstallmentPlan(c.id,h);if(T.success){F.success("Installment plan updated successfully!");const N=h.status!==c.status,f=h.status==="completed";N&&f?setTimeout(()=>{$()},500):$()}else F.error(T.error||"Failed to update installment plan")}catch(T){F.error(T.message||"An error occurred")}finally{i(!1)}};return s?Pe.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000000] p-4",style:{zIndex:1e6},children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(et,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Installment Plan"}),e.jsx("p",{className:"text-sm text-gray-600",children:c.plan_number})]})]}),e.jsx("button",{onClick:O,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ke,{size:20})})]}),e.jsxs("form",{onSubmit:te,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{value:h.status,onChange:C=>X(T=>({...T,status:C.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"defaulted",children:"Defaulted"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Late Fee Amount"}),e.jsx("input",{type:"number",value:h.late_fee_amount,onChange:C=>X(T=>({...T,late_fee_amount:parseFloat(C.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:h.notes,onChange:C=>X(T=>({...T,notes:C.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Plan notes...",rows:3})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:O,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:v,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Updating...":"Update Plan"})]})]})]})}),document.body):null},rs=({isOpen:s,onClose:O,plan:$})=>{var T;const[c,h]=r.useState([]),[X,v]=r.useState(!0);if(r.useEffect(()=>{(async()=>{if(!s||!$.id)return;v(!0);const f=await pe.getInstallmentPlanById($.id);f!=null&&f.payments&&h(f.payments),v(!1)})()},[s,$.id]),!s)return null;const i=N=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(N),te=N=>new Date(N).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),C=c.reduce((N,f)=>N+Number(f.amount||0),0);return Pe.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[1000000]",style:{top:0,left:0,right:0,bottom:0,zIndex:1e6},role:"dialog","aria-modal":"true","aria-labelledby":"payment-history-modal-title",onClick:N=>{N.target===N.currentTarget&&O()},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:O,className:"absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50","aria-label":"Close modal",children:e.jsx(ke,{className:"w-6 h-6"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(Re,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"payment-history-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:"Payment History"}),e.jsxs("p",{className:"text-sm text-gray-600 font-medium",children:[$.plan_number," - ",(T=$.customer)==null?void 0:T.name]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:X?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(Ve,{}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading payment history..."})]}):e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-200 shadow-sm",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5 text-green-600"}),"Payment Summary"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-xl border border-gray-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Total Payments"}),e.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.length})]}),e.jsxs("div",{className:"p-4 bg-green-50 rounded-xl border border-green-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Total Paid"}),e.jsx("p",{className:"text-xl font-bold text-green-600",children:i(C)})]}),e.jsxs("div",{className:"p-4 bg-red-50 rounded-xl border border-red-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-1",children:"Balance Due"}),e.jsx("p",{className:"text-xl font-bold text-red-600",children:i($.balance_due||0)})]})]})]}),c.length===0?e.jsxs("div",{className:"text-center py-12 bg-white rounded-xl border border-gray-200",children:[e.jsx(Re,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No payments recorded yet"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Payment history will appear here"})]}):e.jsx("div",{className:"space-y-3",children:c.map((N,f)=>e.jsxs("div",{className:"relative p-4 rounded-xl border-2 bg-gradient-to-r from-green-50 to-green-100/50 border-green-300 shadow-sm",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center font-bold text-base shadow-sm bg-green-500 text-white",children:N.installment_number===0?"DP":`#${N.installment_number}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(Ne,{className:"w-4 h-4 flex-shrink-0 text-green-600"}),e.jsx("div",{className:"text-sm font-bold text-gray-900",children:N.installment_number===0?"Down Payment":`Installment Payment ${N.installment_number}`})]}),e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:te(N.payment_date)}),e.jsxs("div",{className:"space-y-1 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:"text-gray-600",children:"Method:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:N.payment_method})]}),N.reference_number&&e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:"text-gray-600",children:"Reference:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:N.reference_number})]}),N.notes&&e.jsxs("div",{className:"text-xs mt-2 p-2 bg-white rounded-lg border border-gray-200",children:[e.jsx("span",{className:"text-gray-600",children:"Notes: "}),e.jsx("span",{className:"text-gray-700",children:N.notes})]})]})]})]}),e.jsxs("div",{className:"flex-shrink-0 text-right",children:[e.jsx("div",{className:"text-lg font-bold text-green-700",children:i(N.amount)}),e.jsx("span",{className:`inline-block mt-2 px-2.5 py-1 rounded-lg text-xs font-bold uppercase ${N.status==="paid"?"bg-green-200 text-green-800":N.status==="late"?"bg-red-200 text-red-800":"bg-gray-200 text-gray-700"}`,children:N.status})]})]}),f<c.length-1&&e.jsx("div",{className:"absolute left-6 top-full w-0.5 h-2 bg-green-300",style:{transform:"translateY(-2px)"}})]},N.id||f))})]})}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>window.print(),className:"flex-1 px-6 py-3.5 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all shadow-sm flex items-center justify-center gap-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),"Print"]}),e.jsx("button",{type:"button",onClick:O,className:"flex-1 px-6 py-3.5 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700 transition-all shadow-lg hover:shadow-xl text-lg",children:"Close"})]})})]})}),document.body)},os=({plan:s,isSelected:O,isSelectionMode:$,onToggleSelect:c,isExpanded:h,onToggleExpanded:X,formatCurrency:v,formatDate:i,getStatusColor:te,getStatusIcon:C,isOverdue:T,handleViewPlan:N,handleRecordPayment:f,handleEditPlan:re,handleSendReminder:ce,handleViewSchedule:se,handleViewPaymentHistory:u,handleCancelPlan:M})=>{var le,oe;const[Z,Y]=r.useState(!0),[p,ae]=r.useState([]),[t,g]=r.useState(!1),[w,D]=r.useState(!1),A=r.useRef(null);r.useEffect(()=>{!h&&w&&D(!1)},[h,w]),r.useEffect(()=>{h&&(Y(!0),(async()=>{g(!0);try{const z=await pe.getInstallmentPlanById(s.id);z!=null&&z.payments&&ae(z.payments)}catch(z){console.error("Error loading payments:",z)}finally{g(!1)}})())},[h,s.id]);const xe=T(s),E=s.status==="completed",U=s.status==="active"&&xe,I=(s.total_paid||0)/s.total_amount*100,Q=r.useMemo(()=>!p||p.length===0?0:new Set(p.filter(z=>z.status==="paid"&&z.installment_number>0).map(z=>z.installment_number)).size,[p]),y=p.length>0?Q:s.installments_paid,n=[...(()=>{const d=[],G=((W,q,l)=>{const H=W-q,V=q>0?l-1:l;if(V<=0)return[];const L=[],ee=H/V;let ie=0;for(let ye=0;ye<V-1;ye++){const De=Math.round(ee*100)/100;L.push(De),ie+=De}const ne=Math.round((H-ie)*100)/100;return L.push(ne),L})(s.total_amount,s.down_payment||0,s.number_of_installments),K=new Date(s.start_date);if(s.down_payment>0){const W=p.filter(ee=>(ee.installment_number===1||ee.installment_number===0)&&Math.abs(Number(ee.amount)-s.down_payment)<.01),q=W.length>0?W.sort((ee,ie)=>new Date(ie.payment_date||ie.created_at||0).getTime()-new Date(ee.payment_date||ee.created_at||0).getTime())[0]:null,l=(s.total_paid||0)>=s.down_payment,H=q&&q.status==="paid"||l,V=new Date(K),L=!H&&new Date>V&&s.status==="active";d.push({installmentNumber:1,dueDate:V.toISOString(),amount:s.down_payment,status:H?"paid":L?"overdue":"pending",payment:q,daysOverdue:L?Math.floor((new Date().getTime()-V.getTime())/(1e3*60*60*24)):0})}const he=s.down_payment>0?s.number_of_installments-1:s.number_of_installments,me=s.down_payment>0?new Date(s.next_payment_date||s.start_date):new Date(s.start_date);for(let W=0;W<he;W++){const q=new Date(me);s.payment_frequency==="weekly"?q.setDate(me.getDate()+W*7):s.payment_frequency==="monthly"?q.setMonth(me.getMonth()+W):(s.payment_frequency==="bi_weekly"||s.payment_frequency==="bi-weekly")&&q.setDate(me.getDate()+W*14);const l=s.down_payment>0?W+2:W+1,H=p.filter(ne=>ne.installment_number===l),V=H.length>0?H.sort((ne,ye)=>new Date(ye.payment_date||ye.created_at||0).getTime()-new Date(ne.payment_date||ne.created_at||0).getTime())[0]:null,L=V&&V.status==="paid",ee=!L&&new Date>q&&s.status==="active",ie=G[W]||s.installment_amount;d.push({installmentNumber:l,dueDate:q.toISOString(),amount:ie,status:L?"paid":ee?"overdue":"pending",payment:V,daysOverdue:ee?Math.floor((new Date().getTime()-q.getTime())/(1e3*60*60*24)):0})}return d})()].sort((d,z)=>d.status==="paid"&&z.status!=="paid"?1:d.status!=="paid"&&z.status==="paid"?-1:d.installmentNumber-z.installmentNumber),o=3,m=n.length>o,P=Z&&m?n.slice(0,o):n;return e.jsxs("div",{className:`border-2 rounded-2xl bg-white shadow-sm transition-all duration-300 ${h?"border-purple-500 shadow-xl":E?"border-green-200 hover:border-green-300 hover:shadow-md":U?"border-red-300 hover:border-red-400 hover:shadow-md":"border-gray-200 hover:border-purple-400 hover:shadow-md"} ${O?"ring-2 ring-offset-2 ring-purple-400":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between p-6 cursor-pointer",onClick:X,children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[$&&e.jsx("input",{type:"checkbox",checked:O,onChange:d=>{d.stopPropagation(),c()},onClick:d=>d.stopPropagation(),className:"mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500 cursor-pointer flex-shrink-0",title:"Select this plan"}),e.jsx("div",{className:`w-7 h-7 rounded-lg flex items-center justify-center transition-all flex-shrink-0 ${h?"bg-purple-500 text-white":"bg-gray-200 hover:bg-gray-300 text-gray-600"}`,children:e.jsx(Je,{className:`w-5 h-5 transition-transform duration-200 ${h?"rotate-180":""}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 truncate",children:s.plan_number}),E?e.jsxs("span",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-bold bg-green-500 text-white shadow-sm flex-shrink-0",children:[e.jsx(tt,{className:"w-5 h-5"}),"Complete"]}):U?e.jsxs("span",{className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-bold bg-red-500 text-white shadow-sm animate-pulse flex-shrink-0",children:[e.jsx(Ce,{className:"w-5 h-5"}),"Overdue"]}):e.jsxs("span",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-lg text-base font-bold ${te(s.status)} flex items-center gap-2 flex-shrink-0`,children:[C(s.status),e.jsx("span",{children:s.status.toUpperCase()})]})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{ref:A,onClick:d=>{d.stopPropagation(),D(!w)},className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-50 text-blue-700 border border-blue-200 flex-shrink-0 cursor-pointer hover:bg-blue-100 transition-colors",children:[e.jsx(Ee,{className:"w-5 h-5"}),e.jsx("span",{className:"text-base font-semibold truncate max-w-[140px]",children:((le=s.customer)==null?void 0:le.name)||"Unknown Customer"})]}),s.customer&&e.jsx(ts,{customer:s.customer,plan:s,anchorRef:A,isOpen:w,onClose:()=>D(!1),formatCurrency:v,formatDate:i}),e.jsxs("div",{className:"inline-flex items-center gap-3 px-4 py-2 rounded-lg bg-gray-50 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"text-base font-semibold text-purple-700",children:y}),e.jsxs("span",{className:"text-sm text-purple-600 font-medium",children:["/ ",s.number_of_installments]})]}),e.jsx("div",{className:"w-px h-5 bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-gray-600"}),e.jsx("span",{className:"text-base font-medium text-gray-600",children:s.next_payment_date?i(s.next_payment_date):"Completed"})]})]})]})]})]}),e.jsx("div",{className:"ml-4 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(_e,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-500 font-medium uppercase tracking-wide",children:"Total Amount"})]}),e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-4xl font-bold text-gray-900 leading-tight",children:v(s.total_amount)})})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-5 py-3 rounded-xl text-base font-bold shadow-sm ${I>=100?"bg-green-500 text-white":I>0?"bg-yellow-500 text-white":"bg-red-500 text-white"}`,children:[I>=100?e.jsx(de,{className:"w-5 h-5"}):I>0?e.jsx(Le,{className:"w-5 h-5"}):e.jsx(Oe,{className:"w-5 h-5"}),I>=100?"Paid":I>0?"Partial":"Unpaid"]})})]})})]}),h&&e.jsx("div",{className:"mt-5 pt-5 border-t-2 border-gray-200 relative",children:e.jsx("div",{className:"absolute top-0 left-0 right-0 flex items-center justify-center -mt-3",children:e.jsx("span",{className:"bg-white px-5 py-1.5 text-xs text-gray-500 font-semibold uppercase tracking-wider rounded-full border border-gray-200 shadow-sm",children:"Plan Details"})})}),h&&e.jsxs("div",{className:"px-6 pb-6 pt-2",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 flex items-center gap-2 mb-3",children:[e.jsx(Ge,{className:"w-5 h-5 text-green-600"}),"Payment Progress"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-3",children:[e.jsxs("div",{className:"bg-green-50 p-4 rounded-xl border border-green-200",children:[e.jsx("div",{className:"text-xs text-green-600 font-medium mb-1",children:"Total Paid"}),e.jsx("div",{className:"text-2xl font-bold text-green-700",children:v(s.total_paid||0)})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-xl border border-red-200",children:[e.jsx("div",{className:"text-xs text-red-600 font-medium mb-1",children:"Balance Due"}),e.jsx("div",{className:"text-2xl font-bold text-red-700",children:v(s.balance_due||0)})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-200",children:[e.jsx("div",{className:"text-xs text-blue-600 font-medium mb-1",children:"Progress"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-700",children:[I.toFixed(0),"%"]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner",children:e.jsx("div",{className:`h-3 rounded-full transition-all duration-500 ${I>=100?"bg-gradient-to-r from-green-500 to-emerald-500":I>0?"bg-gradient-to-r from-orange-400 to-orange-500":"bg-gray-300"}`,style:{width:`${Math.min(I,100)}%`}})})]}),e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-200 shadow-sm mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-purple-600"}),"Installment Schedule"]}),e.jsx("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-purple-50 border border-purple-200 rounded-lg",children:e.jsxs("span",{className:"text-xs font-semibold text-purple-700",children:[y," / ",s.number_of_installments," Paid"]})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto pr-1 items-start",children:P.map((d,z)=>{const G=d.status==="paid",K=d.status==="overdue";return d.status,e.jsxs("div",{className:`group relative p-5 rounded-2xl border-2 transition-all duration-200 flex flex-col ${G?"bg-white border-green-300 shadow-md hover:shadow-lg":K?"bg-white border-red-300 shadow-md hover:shadow-lg":"bg-white border-gray-200 hover:border-gray-300 hover:shadow-sm"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsx("div",{className:`relative flex-shrink-0 w-14 h-14 rounded-full flex items-center justify-center font-bold text-lg shadow-lg ${G?"bg-gradient-to-br from-green-500 to-green-600 text-white":K?"bg-gradient-to-br from-red-500 to-red-600 text-white":"bg-gradient-to-br from-gray-400 to-gray-500 text-white"}`,children:d.installmentNumber}),e.jsx("div",{className:"flex-shrink-0 text-right",children:e.jsx("div",{className:`text-xl font-bold ${G?"text-green-700":K?"text-red-700":"text-gray-900"}`,children:v(d.amount)})})]}),e.jsxs("div",{className:"flex-1 flex flex-col justify-end",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx(Ne,{className:`w-4 h-4 flex-shrink-0 ${G?"text-green-600":K?"text-red-600":"text-gray-500"}`}),e.jsx("div",{className:"text-base font-bold text-gray-900",children:i(d.dueDate)}),e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-bold uppercase ${G?"bg-green-100 text-green-800 border border-green-200":K?"bg-red-100 text-red-800 border border-red-200":"bg-gray-100 text-gray-700 border border-gray-200"}`,children:[G&&e.jsx(de,{className:"w-3.5 h-3.5"}),K&&e.jsx(Ce,{className:"w-3.5 h-3.5"}),d.status]})]}),K&&d.daysOverdue&&e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:e.jsxs("span",{className:"text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200",children:[d.daysOverdue," days late"]})})]})]},d.installmentNumber)})}),m&&e.jsx("button",{type:"button",onClick:d=>{d.stopPropagation(),Y(!Z)},className:"mt-3 w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold text-purple-700 hover:text-purple-800 bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 hover:border-purple-300 rounded-xl transition-all",children:Z?e.jsxs(e.Fragment,{children:[e.jsx(Je,{className:"w-4 h-4"}),"View More Installments"]}):e.jsxs(e.Fragment,{children:[e.jsx(Wt,{className:"w-4 h-4"}),"View Less"]})})]}),((oe=s.customer)==null?void 0:oe.email)&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"text-base font-bold text-gray-900 flex items-center gap-2 mb-3",children:[e.jsx(Ee,{className:"w-5 h-5 text-blue-600"}),"Customer Information"]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:e.jsxs("button",{onClick:d=>{d.stopPropagation(),window.location.href=`mailto:${s.customer.email}`},className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 rounded-lg transition-all text-sm font-medium",title:"Send email",children:[e.jsx(Ht,{className:"w-4 h-4"}),"Email"]})})]}),e.jsx("div",{className:"mt-5 pt-5 border-t-2 border-gray-200",children:(()=>{var H,V;const d=[];d.push({type:"view",label:"View Details",icon:e.jsx(Yt,{className:"w-4 h-4"}),color:"bg-blue-600 hover:bg-blue-700",onClick:()=>N(s)});const z=p.length>0?Q:Number(s.installments_paid||0),G=Number(s.number_of_installments||0),K=z<G,he=Number(s.balance_due||0),me=K||he>0,W=!K&&he<=0&&s.status==="completed";me&&!W&&d.push({type:"pay",label:"Record Payment",icon:e.jsx(_e,{className:"w-4 h-4"}),color:"bg-green-600 hover:bg-green-700",onClick:()=>f(s)}),(s.status==="active"||s.status==="completed"&&!W)&&(s.status==="active"&&(d.push({type:"edit",label:"Edit Plan",icon:e.jsx(et,{className:"w-4 h-4"}),color:"bg-purple-600 hover:bg-purple-700",onClick:()=>re(s)}),d.push({type:"cancel",label:"Cancel Plan",icon:e.jsx(Ke,{className:"w-4 h-4"}),color:"bg-red-600 hover:bg-red-700",onClick:()=>M(s.id)})),K&&((H=s.customer)!=null&&H.phone)&&d.push({type:"remind",label:"Send Reminder",icon:e.jsx(Jt,{className:"w-4 h-4"}),color:"bg-orange-600 hover:bg-orange-700",onClick:()=>ce(s.id)})),d.push({type:"history",label:"Payment History",icon:e.jsx(Re,{className:"w-4 h-4"}),color:"bg-gray-600 hover:bg-gray-700",onClick:()=>u(s)}),(V=s.customer)!=null&&V.phone&&(d.push({type:"whatsapp",label:"WhatsApp",icon:e.jsx(Qt,{className:"w-4 h-4"}),color:"bg-green-600 hover:bg-green-700",onClick:()=>{window.open(`https://wa.me/${s.customer.phone.replace(/\D/g,"")}`,"_blank")}}),d.push({type:"call",label:"Call",icon:e.jsx(Kt,{className:"w-4 h-4"}),color:"bg-blue-600 hover:bg-blue-700",onClick:()=>{window.location.href=`tel:${s.customer.phone}`}}));const q=d.slice(0,4),l=d.slice(4);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-3",children:q.map((L,ee)=>e.jsxs("button",{onClick:ie=>{ie.stopPropagation();try{L.onClick()}catch(ne){F.error(`Failed to execute ${L.label}: ${ne instanceof Error?ne.message:"Unknown error"}`)}},className:`flex items-center justify-center gap-2 px-4 py-3 text-white rounded-xl transition-all hover:scale-105 hover:shadow-lg font-semibold text-sm ${L.color}`,children:[L.icon,L.label]},`${L.type}-${ee}`))}),l.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:l.map((L,ee)=>e.jsxs("button",{onClick:ie=>{ie.stopPropagation();try{L.onClick()}catch(ne){F.error(`Failed to execute ${L.label}: ${ne instanceof Error?ne.message:"Unknown error"}`)}},className:`flex items-center justify-center gap-2 px-4 py-2.5 text-white rounded-xl transition-all hover:scale-105 hover:shadow-lg font-medium text-sm ${L.color}`,children:[L.icon,L.label]},`${L.type}-${ee+4}`))})]})})()})]})]})};export{gs as I};
