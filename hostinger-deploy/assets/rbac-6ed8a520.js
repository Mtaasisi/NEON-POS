import{j as e,s as M,aQ as O}from"./index-61458a34.js";import{r as h,b as J}from"./vendor-36d2c7c1.js";import{h as U,Y as ee,n as v,bz as B,X as se,A as re,d as $,aj as te,l as ae,c0 as oe,aE as ie,S as ne,q as ce}from"./ui-28e30067.js";const le=({onKeyPress:f,onBackspace:s,onClear:t,disabled:r=!1})=>{const o=[["1","2","3"],["4","5","6"],["7","8","9"],["Clear","0","Backspace"]],n=c=>{r||(c==="Backspace"?s():c==="Clear"?t():f(c))};return e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"grid grid-cols-3 gap-4 max-w-md mx-auto",children:o.map((c,m)=>c.map((l,j)=>e.jsx("button",{onClick:()=>n(l),disabled:r,className:`aspect-square flex items-center justify-center rounded-lg font-semibold text-2xl transition-all duration-200 min-h-[64px] min-w-[64px] ${l==="Backspace"||l==="Clear"?"bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400":"bg-white text-gray-900 hover:bg-gray-100 active:bg-gray-200 border border-gray-300"} ${r?"opacity-50 cursor-not-allowed":"cursor-pointer"} shadow-sm hover:shadow-md active:shadow-inner`,children:l==="Backspace"?e.jsx(U,{className:"w-6 h-6"}):l==="Clear"?e.jsx(ee,{className:"w-6 h-6"}):l},`${m}-${j}`)))})})},ye=({isOpen:f,onClose:s,onComplete:t,currentUser:r,expectedPasscode:o="1234"})=>{const[n,c]=h.useState("summary"),[m,l]=h.useState([]),[j,F]=h.useState(0),[R,Z]=h.useState(0),[x,_]=h.useState(!1),[N,S]=h.useState(""),[C,H]=h.useState(!1),[pe,K]=h.useState(!1);h.useEffect(()=>{f&&q()},[f]);const q=async()=>{try{_(!0);const a=new Date().toISOString().split("T")[0],i=new Date(a+"T00:00:00.000Z").toISOString(),u=new Date(a+"T23:59:59.999Z").toISOString(),{data:P,error:E}=await M.from("lats_sales").select("*").gte("created_at",i).lte("created_at",u);if(E){console.error("Error loading sales:",E),v.error("Failed to load daily sales");return}const p=new Map;let T=0,I=0;P==null||P.forEach(d=>{var w;if(d.payment_method){const b=parseFloat(d.total_amount)||0;if(isNaN(b)||!isFinite(b)){console.warn("Invalid sale amount in DailyClosingModal:",d.total_amount);return}if(d.payment_method.type==="multiple"&&((w=d.payment_method.details)!=null&&w.payments))d.payment_method.details.payments.forEach(g=>{const y=g.method||"Unknown",k=parseFloat(g.amount)||0;if(isNaN(k)||!isFinite(k)){console.warn("Invalid payment amount in multiple payment:",g.amount);return}if(p.has(y)){const L=p.get(y);p.set(y,{total:L.total+k,count:L.count+1})}else p.set(y,{total:k,count:1})});else{const g=d.payment_method.name||d.payment_method.type||"Unknown";if(p.has(g)){const y=p.get(g);p.set(g,{total:y.total+b,count:y.count+1})}else p.set(g,{total:b,count:1})}T+=b,I++}});const G=Array.from(p.entries()).map(([d,w])=>({method:d,total:w.total,count:w.count,confirmed:!1}));l(G),F(T),Z(I)}catch(a){console.error("Error in loadDailySummary:",a),v.error("Failed to load daily summary")}finally{_(!1)}},z=a=>{l(i=>i.map(u=>u.method===a?{...u,confirmed:!u.confirmed}:u))},V=()=>{l(a=>a.map(i=>({...i,confirmed:!0}))),K(!0),c("passcode")},Q=a=>{N.length<4&&S(i=>i+a)},W=()=>{S(a=>a.slice(0,-1))},X=()=>{S("")},Y=async()=>{try{if(_(!0),N!==o){v.error("Invalid passcode");return}const i={date:new Date().toISOString().split("T")[0],total_sales:j,total_transactions:R,closed_at:new Date().toISOString(),closed_by:(r==null?void 0:r.name)||(r==null?void 0:r.email)||"Unknown",closed_by_user_id:r==null?void 0:r.id,sales_data:{payment_summaries:m,confirmed_by:(r==null?void 0:r.name)||(r==null?void 0:r.email)}},{error:u}=await M.from("daily_sales_closures").upsert(i,{onConflict:"date",ignoreDuplicates:!1});if(u){console.error("Error closing daily sales:",u),v.error("Failed to close daily sales");return}v.success("Daily sales closed successfully! ðŸŽ‰"),t(),s()}catch(a){console.error("Error in handleCloseDay:",a),v.error("Failed to close daily sales")}finally{_(!1)}},A=a=>{const i=a.toLowerCase();return i.includes("cash")?e.jsx(oe,{className:"w-5 h-5"}):i.includes("card")||i.includes("credit")?e.jsx(ie,{className:"w-5 h-5"}):i.includes("mobile")||i.includes("mpesa")||i.includes("tigo")?e.jsx(ne,{className:"w-5 h-5"}):e.jsx(ce,{className:"w-5 h-5"})},D=a=>{const i=a.toLowerCase();return i.includes("cash")?"text-green-600 bg-green-100":i.includes("card")||i.includes("credit")?"text-blue-600 bg-blue-100":i.includes("mobile")||i.includes("mpesa")||i.includes("tigo")?"text-purple-600 bg-purple-100":"text-gray-600 bg-gray-100"};return f?J.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",style:{zIndex:99999},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center",children:e.jsx(B,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Daily Sales Closing"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[n==="summary"&&"Review daily sales summary",n==="confirm"&&"Confirm payment totals",n==="passcode"&&"Enter passcode to close"]})]})]}),e.jsx("button",{onClick:s,className:"w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors",children:e.jsx(se,{className:"w-4 h-4 text-gray-500"})})]}),e.jsxs("div",{className:"p-6",children:[x&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})}),!x&&n==="summary"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Daily Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Sales"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[j.toLocaleString()," TZS"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Transactions"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:R})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"Payment Methods"}),e.jsx("div",{className:"space-y-3",children:m.map((a,i)=>e.jsxs("div",{className:"flex items-center justify-between p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${D(a.method)}`,children:A(a.method)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:a.method}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.count," transactions"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-gray-900",children:[a.total.toLocaleString()," TZS"]})})]},i))})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:s,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Cancel"}),e.jsx("button",{onClick:()=>c("confirm"),className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium",children:"Continue to Confirmation"})]})]}),!x&&n==="confirm"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(re,{className:"w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-orange-800 font-medium",children:"Confirm each payment method"}),e.jsx("p",{className:"text-sm text-orange-700 mt-1",children:"Please verify the totals for each payment method before closing the day."})]})]})}),e.jsx("div",{className:"space-y-3",children:m.map((a,i)=>e.jsx("div",{className:`p-4 border rounded-lg transition-colors ${a.confirmed?"border-green-200 bg-green-50":"border-gray-200 bg-white"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${D(a.method)}`,children:A(a.method)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:a.method}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.count," transactions"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-semibold text-gray-900",children:[a.total.toLocaleString()," TZS"]})}),e.jsx("button",{onClick:()=>z(a.method),className:`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${a.confirmed?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400 hover:bg-gray-200"}`,children:e.jsx($,{className:"w-5 h-5"})})]})]})},i))}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>c("summary"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Back to Summary"}),e.jsx("button",{onClick:V,disabled:!m.every(a=>a.confirmed),className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:"All Confirmed - Continue"})]})]}),!x&&n==="passcode"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx($,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-800 font-medium",children:"All payments confirmed"}),e.jsx("p",{className:"text-sm text-green-700 mt-1",children:"Enter passcode to complete daily closing."})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Enter Passcode"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:C?"text":"password",value:N,onChange:a=>S(a.target.value),placeholder:"Enter 4-digit passcode",className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-center text-lg tracking-widest",maxLength:4,readOnly:!0}),e.jsx("button",{type:"button",onClick:()=>H(!C),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:C?e.jsx(te,{className:"w-5 h-5"}):e.jsx(ae,{className:"w-5 h-5"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Use the passcode configured in POS Settings"})]}),e.jsx("div",{children:e.jsx(le,{onKeyPress:Q,onBackspace:W,onClear:X,disabled:x})})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>c("confirm"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Back to Confirmation"}),e.jsxs("button",{onClick:Y,disabled:N.length!==4||x,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),x?"Closing...":"Close Day"]})]})]})]})]})}),document.body):null},de=[{resource:"inventory",action:"view",roles:["admin","customer-care","technician","store-keeper"]},{resource:"inventory",action:"create",roles:["admin"]},{resource:"inventory",action:"edit",roles:["admin"]},{resource:"inventory",action:"delete",roles:["admin"]},{resource:"inventory",action:"manage",roles:["admin"]},{resource:"categories",action:"view",roles:["admin","customer-care","technician","store-keeper"]},{resource:"categories",action:"create",roles:["admin"]},{resource:"categories",action:"edit",roles:["admin"]},{resource:"categories",action:"delete",roles:["admin"]},{resource:"brands",action:"view",roles:["admin","customer-care","technician","store-keeper"]},{resource:"brands",action:"create",roles:["admin"]},{resource:"brands",action:"edit",roles:["admin"]},{resource:"brands",action:"delete",roles:["admin"]},{resource:"suppliers",action:"view",roles:["admin"]},{resource:"suppliers",action:"create",roles:["admin"]},{resource:"suppliers",action:"edit",roles:["admin"]},{resource:"suppliers",action:"delete",roles:["admin"]},{resource:"products",action:"view",roles:["admin","technician","store-keeper"]},{resource:"products",action:"create",roles:["admin"]},{resource:"products",action:"edit",roles:["admin"]},{resource:"products",action:"delete",roles:["admin"]},{resource:"stock",action:"view",roles:["admin","technician","store-keeper"]},{resource:"stock",action:"adjust",roles:["admin","technician","store-keeper"]},{resource:"stock",action:"history",roles:["admin","store-keeper"]},{resource:"purchase-orders",action:"view",roles:["admin","store-keeper"]},{resource:"purchase-orders",action:"create",roles:["admin"]},{resource:"purchase-orders",action:"edit",roles:["admin","store-keeper"]},{resource:"purchase-orders",action:"delete",roles:["admin"]},{resource:"purchase-orders",action:"receive",roles:["admin","store-keeper"]},{resource:"spare-parts",action:"view",roles:["admin","technician"]},{resource:"spare-parts",action:"create",roles:["admin"]},{resource:"spare-parts",action:"edit",roles:["admin"]},{resource:"spare-parts",action:"delete",roles:["admin"]},{resource:"spare-parts",action:"use",roles:["admin","technician"]},{resource:"pos",action:"view",roles:["admin","customer-care"]},{resource:"pos",action:"sell",roles:["admin","customer-care"]},{resource:"pos",action:"refund",roles:["admin"]},{resource:"pos",action:"void",roles:["admin"]},{resource:"pos-inventory",action:"view",roles:["admin","customer-care"]},{resource:"pos-inventory",action:"search",roles:["admin","customer-care"]},{resource:"pos-inventory",action:"add-to-cart",roles:["admin","customer-care"]},{resource:"sales",action:"view",roles:["admin","customer-care"]},{resource:"sales",action:"create",roles:["admin","customer-care"]},{resource:"sales",action:"edit",roles:["admin"]},{resource:"sales",action:"delete",roles:["admin"]},{resource:"sales",action:"refund",roles:["admin"]},{resource:"reports",action:"view",roles:["admin","customer-care","store-keeper"]},{resource:"reports",action:"export",roles:["admin","customer-care","store-keeper"]},{resource:"reports",action:"daily-close",roles:["admin","customer-care"]},{resource:"analytics",action:"view",roles:["admin"]},{resource:"analytics",action:"export",roles:["admin"]},{resource:"settings",action:"view",roles:["admin"]},{resource:"settings",action:"edit",roles:["admin"]},{resource:"system",action:"admin",roles:["admin"]},{resource:"system",action:"debug",roles:["admin"]}],me=[{path:"/lats/inventory/management",roles:["admin"]},{path:"/lats/inventory/new",roles:["admin"]},{path:"/lats/inventory/products",roles:["admin","technician","store-keeper"]},{path:"/lats/inventory/products/:id/edit",roles:["admin"]},{path:"/lats/inventory/purchase-orders",roles:["admin","store-keeper"]},{path:"/lats/inventory/purchase-orders/new",roles:["admin"]},{path:"/lats/add-product",roles:["admin"]},{path:"/lats/spare-parts",roles:["admin","technician"]},{path:"/lats/pos-inventory",roles:["admin","customer-care"]},{path:"/lats/pos",roles:["admin","customer-care"]}];class ue{constructor(){this.permissions=de,this.routePermissions=me}can(s,t,r){const o=this.permissions.find(n=>n.resource===t&&n.action===r);return o?o.roles.includes(s):!1}canUser(s,t,r){var c;if(!s)return!1;const n=(c={inventory:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products",manage:"edit_settings"},products:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},pos:{view:"access_pos",sell:"process_sales",refund:"process_refunds",void:"process_refunds"},"pos-inventory":{view:"view_inventory",search:"view_inventory","add-to-cart":"access_pos"},sales:{view:"view_reports",create:"process_sales",edit:"process_sales",delete:"process_sales",refund:"process_refunds"},reports:{view:"view_reports",export:"view_reports","daily-close":"daily_close"},settings:{view:"view_settings",edit:"edit_settings"},"purchase-orders":{view:"view_purchase_orders",create:"create_purchase_orders",edit:"edit_purchase_orders",delete:"delete_purchase_orders",receive:"edit_purchase_orders"},"spare-parts":{view:"view_spare_parts",create:"create_spare_parts",edit:"edit_spare_parts",delete:"delete_spare_parts",use:"view_spare_parts"},categories:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},suppliers:{view:"view_inventory",create:"add_products",edit:"edit_products",delete:"delete_products"},stock:{view:"view_inventory",adjust:"adjust_stock",history:"view_stock_history"},analytics:{view:"view_financial_reports",export:"view_financial_reports"}}[t])==null?void 0:c[r];return n&&O(s,n)?!0:this.can(s.role,t,r)}canAccessRoute(s,t){const r=this.routePermissions.find(o=>o.exact?o.path===t:t.startsWith(o.path));return r?r.roles.includes(s):!0}canUserAccessRoute(s,t){if(!s)return!1;const r={"/lats/pos":"access_pos","/lats/inventory/management":"edit_settings","/lats/inventory/new":"add_products","/lats/inventory/products":"view_inventory","/lats/inventory/products/:id/edit":"edit_products","/lats/inventory/purchase-orders":"view_purchase_orders","/lats/inventory/purchase-orders/new":"create_purchase_orders","/lats/add-product":"add_products","/lats/spare-parts":"view_spare_parts","/lats/pos-inventory":"view_inventory"};for(const[o,n]of Object.entries(r)){const c=o.replace(/:\w+/g,"[^/]+");if(new RegExp(`^${c}$`).test(t)&&O(s,n))return!0}return this.canAccessRoute(s.role,t)}hasPermission(s,t,r){const n=this.getRoleHierarchy()[s]||[];return this.permissions.some(c=>c.resource===t&&c.action===r&&c.roles.some(m=>n.includes(m)))}hasUserPermission(s,t,r){return this.canUser(s,t,r)}getRolePermissions(s){return this.permissions.filter(t=>t.roles.includes(s))}getAccessibleRoutes(s){return this.routePermissions.filter(t=>t.roles.includes(s)).map(t=>t.path)}addPermission(s){this.permissions.push(s)}removePermission(s,t){this.permissions=this.permissions.filter(r=>!(r.resource===s&&r.action===t))}addRoutePermission(s){this.routePermissions.push(s)}removeRoutePermission(s){this.routePermissions=this.routePermissions.filter(t=>t.path!==s)}getAvailableRoles(){return["admin","customer-care","technician","viewer","store-keeper"]}getRoleHierarchy(){return{admin:["admin","customer-care","technician","viewer","store-keeper"],"customer-care":["customer-care","viewer"],technician:["technician","viewer"],"store-keeper":["store-keeper","viewer"],viewer:["viewer"]}}hasRoleAccess(s,t){var o;return((o=this.getRoleHierarchy()[s])==null?void 0:o.includes(t))||!1}getAllRolePermissions(s){const r=this.getRoleHierarchy()[s]||[];return this.permissions.filter(o=>o.roles.some(n=>r.includes(n)))}validatePermission(s){return!!(s.resource&&s.action&&s.roles&&s.roles.length>0&&s.roles.every(t=>this.getAvailableRoles().includes(t)))}validateRoutePermission(s){return!!(s.path&&s.roles&&s.roles.length>0&&s.roles.every(t=>this.getAvailableRoles().includes(t)))}getPermissionSummary(s){const t=this.getAllRolePermissions(s),r={};return t.forEach(o=>{r[o.resource]||(r[o.resource]=[]),r[o.resource].push(o.action)}),r}canMultiple(s,t,r){return r.every(o=>this.can(s,t,o))}getAccessibleResources(s){const t=this.getAllRolePermissions(s);return[...new Set(t.map(r=>r.resource))]}getAccessibleActions(s,t){return this.getAllRolePermissions(s).filter(o=>o.resource===t).map(o=>o.action)}}const fe=new ue;export{ye as D,le as V,fe as r};
