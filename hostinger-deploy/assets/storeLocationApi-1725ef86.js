import{s as o}from"./index-61458a34.js";class n{constructor(){this.tableName="lats_store_locations"}async getAll(e){let t=o.from(this.tableName).select("*").order("priority_order",{ascending:!0}).order("name",{ascending:!0});e&&(e.search&&(t=t.or(`name.ilike.%${e.search}%,code.ilike.%${e.search}%,city.ilike.%${e.search}%`)),e.city&&(t=t.eq("city",e.city)),e.region&&(t=t.eq("region",e.region)),e.is_active!==void 0&&(t=t.eq("is_active",e.is_active)),e.is_main_branch!==void 0&&(t=t.eq("is_main_branch",e.is_main_branch)),e.has_repair_service!==void 0&&(t=t.eq("has_repair_service",e.has_repair_service)),e.has_sales_service!==void 0&&(t=t.eq("has_sales_service",e.has_sales_service)),e.has_delivery_service!==void 0&&(t=t.eq("has_delivery_service",e.has_delivery_service)));const{data:a,error:i}=await t;if(i)throw new Error(`Failed to fetch store locations: ${i.message}`);return a||[]}async getById(e){const{data:t,error:a}=await o.from(this.tableName).select("*").eq("id",e).single();if(a){if(a.code==="PGRST116")return null;throw new Error(`Failed to fetch store location: ${a.message}`)}return t}async getByCode(e){const{data:t,error:a}=await o.from(this.tableName).select("*").eq("code",e).single();if(a){if(a.code==="PGRST116")return null;throw new Error(`Failed to fetch store location: ${a.message}`)}return t}async create(e){if(await this.getByCode(e.code))throw new Error(`Store location with code '${e.code}' already exists`);e.is_main_branch&&await o.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0);const{data:a,error:i}=await o.from(this.tableName).insert([e]).select().single();if(i)throw new Error(`Failed to create store location: ${i.message}`);return a}async update(e,t){if(t.code){const r=await this.getByCode(t.code);if(r&&r.id!==e)throw new Error(`Store location with code '${t.code}' already exists`)}t.is_main_branch&&await o.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0).neq("id",e);const{data:a,error:i}=await o.from(this.tableName).update(t).eq("id",e).select().single();if(i)throw new Error(`Failed to update store location: ${i.message}`);return a}async delete(e){const t=await this.getById(e);if(t!=null&&t.is_main_branch&&(await this.getAll({is_main_branch:!0})).length<=1)throw new Error("Cannot delete the only main branch. Please set another location as main branch first.");const{error:a}=await o.from(this.tableName).delete().eq("id",e);if(a)throw new Error(`Failed to delete store location: ${a.message}`)}async getStats(){const{data:e,error:t}=await o.from(this.tableName).select("is_active, is_main_branch, current_staff_count, monthly_target, store_size_sqm");if(t)throw new Error(`Failed to fetch store location stats: ${t.message}`);const a=e||[];return{total_locations:a.length,active_locations:a.filter(r=>r.is_active).length,main_branches:a.filter(r=>r.is_main_branch).length,total_staff:a.reduce((r,s)=>r+(s.current_staff_count||0),0),total_monthly_target:a.reduce((r,s)=>r+(s.monthly_target||0),0),average_store_size:a.length>0?a.reduce((r,s)=>r+(s.store_size_sqm||0),0)/a.length:0}}async getCities(){const{data:e,error:t}=await o.from(this.tableName).select("city").not("city","is",null);if(t)throw new Error(`Failed to fetch cities: ${t.message}`);return[...new Set((e==null?void 0:e.map(i=>i.city))||[])].sort()}async getRegions(){const{data:e,error:t}=await o.from(this.tableName).select("region").not("region","is",null);if(t)throw new Error(`Failed to fetch regions: ${t.message}`);return[...new Set((e==null?void 0:e.map(i=>i.region))||[])].sort()}async toggleActive(e){const t=await this.getById(e);if(!t)throw new Error("Store location not found");return this.update(e,{is_active:!t.is_active})}async setMainBranch(e){return await o.from(this.tableName).update({is_main_branch:!1}).eq("is_main_branch",!0),this.update(e,{is_main_branch:!0})}}const l=new n;export{l as s};
