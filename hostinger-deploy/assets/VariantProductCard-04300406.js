import{_ as ae}from"./supabase-cf010ec4.js";import{j as e,M as Ee,s as ie,aE as Me}from"./index-61458a34.js";import{r as y,R as _e,b as De}from"./vendor-36d2c7c1.js";import{R as Re}from"./robustImageService-f15af7ef.js";import{u as we,aP as Te,X as Be,v as Ve,e as Se,n as Pe,l as Fe,m as Ue,Y as We}from"./ui-28e30067.js";import{format as Ie}from"./format-aff4c6a2.js";import{u as Qe}from"./useBodyScrollLock-341c8b9f.js";import{a as Oe}from"./routing-eb8c310c.js";const $e=({images:t=[],productName:a,productId:l,size:m="md",className:w="",showFallback:S=!0})=>{const[q,E]=y.useState(!1),[f,j]=y.useState(!0),[N,P]=y.useState([]),[R,C]=y.useState(!1);y.useEffect(()=>{(async()=>{if(!(t&&t.length>0)&&l)try{C(!0);const V=await Re.getProductImages(l);P(V)}catch(V){console.error("Failed to load product images:",V),P([])}finally{C(!1)}})()},[l,t]);const v=(()=>N.length>0?N.map(I=>I.thumbnailUrl&&I.thumbnailUrl!==I.url&&I.thumbnailUrl.trim()!==""?I.thumbnailUrl:I.url):t&&t.length>0?t.map(I=>typeof I=="string"?I:I.thumbnailUrl||I.url||I):[])(),U=R||f,$={sm:"w-10 h-10",md:"w-12 h-12",lg:"w-16 h-16",xl:"w-20 h-20"},D=w.includes("w-full")||w.includes("h-full"),Z={sm:"w-5 h-5",md:"w-6 h-6",lg:"w-8 h-8",xl:"w-10 h-10"},G=I=>{E(!0),j(!1)},J=()=>{j(!1)};if(!v.length||q)return S?e.jsx("div",{className:`${D?"":$[m]} bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center ${w}`,children:e.jsx(we,{className:`${D?"w-8 h-8":Z[m]} text-gray-400`})}):null;const ge=v[0]&&(v[0].includes(".png")||v[0].includes("image/png"));return e.jsxs("div",{className:`${D?"":$[m]} relative rounded-lg overflow-hidden ${w}`,children:[U&&e.jsx("div",{className:"absolute inset-0 bg-gray-200 animate-pulse flex items-center justify-center",children:e.jsx(Te,{className:`${D?"w-8 h-8":Z[m]} text-gray-400`})}),ge&&e.jsx("div",{className:"absolute inset-0 bg-white"}),e.jsx("img",{src:v[0],alt:a,className:`w-full h-full object-cover ${ge?"relative z-10":""}`,onError:G,onLoad:J,style:{display:U?"none":"block"}})]})},ot=(t,a)=>{const l={product:t,variants:a,exportedAt:new Date().toISOString(),version:"1.0"};return JSON.stringify(l,null,2)},He=t=>!t.variants||t.variants.length===0?null:t.variants[0],ze=t=>t.variants&&t.variants.length>1,qe=t=>!t.variants||t.variants.length===0?t.stockQuantity??t.totalQuantity??0:t.variants.reduce((a,l)=>{const m=l.stockQuantity??l.quantity??0;return a+m},0),Ke=t=>{var m;return qe(t)<=0?"out-of-stock":((m=t.variants)==null?void 0:m.some(w=>(w.stockQuantity??w.quantity??0)<=5))?"low":"normal"},Ge=t=>{var f,j,N;const a=[],l=[],m=[];(f=t.name)!=null&&f.trim()||a.push("Product name"),(j=t.sku)!=null&&j.trim()||a.push("SKU"),!t.categoryId&&!t.category&&a.push("Category"),!t.supplierId&&!t.supplier&&a.push("Supplier"),!t.variants||t.variants.length===0?a.push("Product variants"):t.variants.forEach((P,R)=>{var C;(C=P.sku)!=null&&C.trim()||l.push(`Variant ${R+1} missing SKU`),(!P.sellingPrice||P.sellingPrice<=0)&&l.push(`Variant ${R+1} missing or invalid selling price`),(P.quantity===void 0||P.quantity===null)&&l.push(`Variant ${R+1} missing stock quantity`)}),(!t.images||t.images.length===0)&&(l.push("No product images"),m.push("Add product images for better customer experience")),(((N=t.variants)==null?void 0:N.reduce((P,R)=>P+(R.quantity||0),0))||0)===0&&(l.push("No stock available"),m.push("Add stock quantities to make products available for sale")),a.includes("Category")&&m.push("Assign a category to help with product organization and filtering"),a.includes("Supplier")&&m.push("Add supplier information for purchase order management"),a.includes("Product variants")&&m.push("Create product variants with different sizes, colors, or specifications");const S=8,q=S-a.length-l.length*.5,E=Math.max(0,Math.round(q/S*100));return{isValid:a.length===0,missingFields:a,warnings:l,recommendations:m,completenessScore:E}},lt=t=>{if(!t||t.length===0)return{totalProducts:0,validProducts:0,invalidProducts:0,averageCompleteness:0,commonMissingFields:{},recommendations:[]};const a=t.map(Ge),l=a.filter(f=>f.isValid).length,m=t.length-l,w=Math.round(a.reduce((f,j)=>f+j.completenessScore,0)/t.length),S={};a.forEach(f=>{f.missingFields.forEach(j=>{S[j]=(S[j]||0)+1})});const q=[];return Object.entries(S).sort(([,f],[,j])=>j-f).slice(0,3).forEach(([f,j])=>{const N=Math.round(j/t.length*100);if(N>30)switch(f){case"Category":q.push(`Add categories to ${j} products (${N}%) to improve organization`);break;case"Supplier":q.push(`Add supplier information to ${j} products (${N}%) for purchase management`);break;case"Product variants":q.push(`Create variants for ${j} products (${N}%) to enable different options`);break;case"SKU":q.push(`Add SKU codes to ${j} products (${N}%) for better tracking`);break;default:q.push(`Complete ${f} for ${j} products (${N}%)`)}}),{totalProducts:t.length,validProducts:l,invalidProducts:m,averageCompleteness:w,commonMissingFields:S,recommendations:q}};class ne{constructor(){this.stockCache={},this.cacheTimestamp=0,this.CACHE_DURATION=6e4}static getInstance(){return ne.instance||(ne.instance=new ne),ne.instance}isValidUUID(a){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)}async getStockLevels(a){try{const l=Date.now(),m={},w=[];if(a.forEach(v=>{this.stockCache[v]&&l-this.cacheTimestamp<this.CACHE_DURATION?m[v]=this.stockCache[v]:w.push(v)}),w.length===0)return m;const S=w.filter(v=>this.isValidUUID(v)),q=w.filter(v=>!this.isValidUUID(v)),E={};if(q.forEach(v=>{E[v]=[]}),S.length===0)return{...m,...E};const f=Ee();let j=null;if(f)try{const{data:v}=await ie.from("store_locations").select("data_isolation_mode, share_inventory").eq("id",f).single();j=v}catch{console.warn("âš ï¸ [RealTimeStockService] Could not fetch branch settings")}let N=ie.from("lats_product_variants").select("id, product_id, sku, name, variant_name, quantity, branch_id, is_shared").in("product_id",S).is("parent_variant_id",null).eq("is_active",!0);f&&j?j.data_isolation_mode==="isolated"?(N=N.eq("branch_id",f),console.log(`ðŸ”’ [RealTimeStockService] ISOLATED MODE - Variants: Only showing from branch ${f}`)):j.data_isolation_mode==="shared"?console.log("ðŸ“Š [RealTimeStockService] SHARED MODE - Variants: Showing all variants"):j.data_isolation_mode==="hybrid"&&(j.share_inventory?(N=N.or(`branch_id.eq.${f},is_shared.eq.true,branch_id.is.null`),console.log(`âš–ï¸ [RealTimeStockService] HYBRID MODE - Variants are SHARED - Showing branch ${f} + shared variants`)):(N=N.eq("branch_id",f),console.log(`âš–ï¸ [RealTimeStockService] HYBRID MODE - Variants are NOT SHARED - Only showing branch ${f}`))):f&&(N=N.or(`branch_id.eq.${f},branch_id.is.null`));const{data:P,error:R}=await N;if(R)throw console.error("âŒ [RealTimeStockService] Error fetching stock levels:",R),R;const C={};return P==null||P.forEach(v=>{const U=v.product_id;C[U]||(C[U]=[]),C[U].push({productId:U,variantId:v.id,quantity:v.quantity||0,sku:v.sku||"",name:v.variant_name||v.name||""})}),S.forEach(v=>{C[v]||(C[v]=[])}),Object.assign(this.stockCache,C),this.cacheTimestamp=l,Object.entries(C).forEach(([v,U])=>{const $=U.reduce((D,Z)=>D+Z.quantity,0)}),{...m,...C,...E}}catch(l){console.error("ðŸ’¥ [RealTimeStockService] Exception fetching stock levels:",l);const m={};return a.forEach(w=>{m[w]=[]}),m}}async getProductStock(a){return(await this.getStockLevels([a]))[a]||[]}async getStockBySKU(a){try{const l=Ee();let m=ie.from("lats_product_variants").select("id, product_id, sku, name, variant_name, quantity, branch_id, is_shared").eq("sku",a);l&&(m=m.or(`branch_id.eq.${l},is_shared.eq.true`));const{data:w,error:S}=await m.single();return S||!w?null:{productId:w.product_id,variantId:w.id,quantity:w.quantity||0,sku:w.sku||"",name:w.variant_name||w.name||""}}catch(l){return console.error("ðŸ’¥ [RealTimeStockService] Exception fetching stock by SKU:",l),null}}clearCache(){this.stockCache={},this.cacheTimestamp=0}async getTotalStock(a){return(await this.getProductStock(a)).reduce((m,w)=>m+w.quantity,0)}}const Ye={formatCurrency:t=>`$${t.toFixed(2)}`,formatDate:t=>t.toLocaleDateString(),formatTime:t=>t.toLocaleTimeString(),showProductImages:!0,showStockLevels:!0,showPrices:!0,showBarcodes:!0,productsPerPage:20,productsPerRow:4,autoCompleteSearch:!0,confirmDelete:!0,showConfirmations:!0,enableSoundEffects:!0,enableAnimations:!0,settings:null,loading:!1,error:null,refreshSettings:async()=>{},applyTheme:t=>{},applyLanguage:t=>{},applyCurrency:t=>{},applyTimezone:t=>{}},Ze=()=>{const t=y.useContext(Me)||Ye;return{formatCurrency:t.formatCurrency,formatDate:t.formatDate,formatTime:t.formatTime,showProductImages:t.showProductImages,showStockLevels:t.showStockLevels,showPrices:t.showPrices,showBarcodes:t.showBarcodes,autoCompleteSearch:t.autoCompleteSearch,confirmDelete:t.confirmDelete,showConfirmations:t.showConfirmations,enableSoundEffects:t.enableSoundEffects,enableAnimations:t.enableAnimations,productsPerPage:t.productsPerPage,settings:t.settings,loading:t.loading,error:t.error,refreshSettings:t.refreshSettings,getProductImageClass:()=>t.showProductImages?"product-image":"hidden-by-setting",getPriceClass:()=>t.showPrices?"price price-display":"hidden-by-setting",getBarcodeClass:()=>t.showBarcodes?"barcode barcode-display":"hidden-by-setting",getAnimationClass:()=>t.enableAnimations?"animate-enabled":"animate-disabled",getSoundClass:()=>t.enableSoundEffects?"sound-enabled":"sound-disabled",isDarkMode:()=>t.settings?t.settings.theme==="dark"?!0:t.settings.theme==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:!1:!1,isSwahili:()=>{var a;return((a=t.settings)==null?void 0:a.language)==="sw"},isFrench:()=>{var a;return((a=t.settings)==null?void 0:a.language)==="fr"},isEnglish:()=>{var a;return((a=t.settings)==null?void 0:a.language)==="en"},getCurrencySymbol:()=>{var l;const a=((l=t.settings)==null?void 0:l.currency)||"TZS";switch(a){case"TZS":return"TSh";case"USD":return"$";case"EUR":return"â‚¬";case"GBP":return"Â£";default:return a}},getStockLevelClass:(a,l=5,m=10)=>t.showStockLevels?a<=l?"stock-level stock-level-low":a<=m?"stock-level stock-level-medium":"stock-level stock-level-high":"hidden-by-setting",shouldShowConfirmation:a=>t.showConfirmations?(a==="delete"&&t.confirmDelete,!0):!1,getSearchConfig:()=>{var a;return{autoComplete:t.autoCompleteSearch,maxResults:((a=t.settings)==null?void 0:a.max_search_results)||50,debounceTime:300}},getCacheConfig:()=>{var a,l,m;return{enabled:((a=t.settings)==null?void 0:a.enable_caching)||!0,duration:((l=t.settings)==null?void 0:l.cache_duration)||300,lazyLoading:((m=t.settings)==null?void 0:m.enable_lazy_loading)||!0}}}},Je=({isOpen:t,onClose:a,product:l,onSelectVariant:m,isPurchaseOrderMode:w=!1})=>{var T,pe;const[S,q]=y.useState(new Set),[E,f]=y.useState({}),[j,N]=y.useState(new Set),[P,R]=y.useState({}),[C,v]=y.useState({}),[U,$]=y.useState({}),[D,Z]=y.useState(""),[G,J]=y.useState(0),[ge,I]=y.useState({}),[V,oe]=y.useState(new Set),[je,le]=y.useState(new Set),[Le,ee]=y.useState(new Set),fe=_e.useRef(!1),te=_e.useRef(!1),p=y.useMemo(()=>l?{...l,variants:l.variants||l.product_variants||[]}:null,[l]);if(Qe(t),y.useEffect(()=>{if(t){const s=document.documentElement.style.overflow;return document.documentElement.style.overflow="hidden",()=>{document.documentElement.style.overflow=s}}},[t]),!t||!p||!p.variants)return t&&p&&console.error("âŒ Modal opened with invalid product data (no variants):",p),null;y.useEffect(()=>{if(!t)q(new Set),f({}),N(new Set),R({}),v({}),$({}),Z(""),J(0),I({}),oe(new Set),le(new Set),fe.current=!1,te.current=!1;else{J(0);const s=async()=>{var r;const i=p;if(((r=i==null?void 0:i.variants)==null?void 0:r.length)===1){const n=i.variants[0],o=n.is_parent||n.variant_type==="parent";let c=o;if(!c)try{const{childVariantsCacheService:g}=await ae(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);if(g.isCacheValid()&&(c=g.hasChildren(n.id),c&&console.log(`ðŸ” Modal: Single variant has children (from cache): ${c}`)),!c){const{count:u}=await ie.from("lats_product_variants").select("id",{count:"exact",head:!0}).eq("parent_variant_id",n.id).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0);c=(u||0)>0,console.log(`ðŸ” Modal: Single variant has children: ${c}`)}}catch(g){console.error("Error checking for children in modal:",g)}if(c||o){console.log("âœ… Modal: Auto-expanding single parent variant to show child variants");const g=new Set([n.id]);q(g),xe(n.id)}}};setTimeout(()=>{s()},100)}},[t,p]);const ce=y.useCallback(async()=>{const s=p;if(s!=null&&s.variants){if(te.current){console.log("â³ Child variants preload already in progress, skipping...");return}try{te.current=!0,console.log("âš¡ Loading child variants from global cache...");const{childVariantsCacheService:i}=await ae(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),r=i.getCacheStats();if(console.log("ðŸ“Š Cache stats:",r),!i.isCacheValid()){fe.current,await Ne();return}const n=s.variants.map(g=>g.id),o={},c={};for(const g of n){const u=i.getChildVariants(g)||[];u.length>0&&(o[g]=u,c[g]=u.length)}f(o),v(c),console.log("âœ… Loaded from GLOBAL CACHE + legacy items:",{totalChildren:Object.values(o).flat().length,parentsWithChildren:Object.keys(o).length,counts:c})}catch(i){console.error("Error loading from cache:",i),await Ne()}finally{te.current=!1}}},[p]),Ne=async()=>{const s=p;if(!(s!=null&&s.variants))return;const i=s.variants.map(x=>x.id);if(i.length===0)return;console.log("ðŸ”„ Fallback: Querying child variants directly...");const{loadAvailableChildIMEIs:r}=await ae(()=>import("./variantHelpers-318d278a.js"),["assets/variantHelpers-318d278a.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),n=i.map(x=>r(x)),c=(await Promise.all(n)).flat();if(!c||c.length===0){console.log("â„¹ï¸ No child variants found");return}const g={},u={};c.forEach(x=>{var X,ue,me;const L=x.parent_variant_id;if(!L||!i.includes(L)){console.warn("Child item has invalid parent association:",{childId:x.id,parentId:L,variantIds:i});return}const _=s.variants.find(h=>h.id===L),k=(_==null?void 0:_.sellingPrice)??(_==null?void 0:_.selling_price)??(_==null?void 0:_.price)??0,d=((X=x.variant_attributes)==null?void 0:X.imei)||x.imei||((ue=x.variant_attributes)==null?void 0:ue.serial_number)||x.serial_number||x.sku||"N/A",b=d,B=((me=x.variant_attributes)==null?void 0:me.condition)||x.condition||"New",W=x.selling_price||x.sellingPrice||x.price,O=W&&W>0?W:k,z={id:x.id,name:x.variant_name||x.name||`IMEI: ${d}`,sku:x.sku||d,quantity:x.quantity||0,sellingPrice:O,price:O,imei:d,serialNumber:b,condition:B,variant_attributes:x.variant_attributes,is_imei_child:!0,is_legacy:x.is_legacy||!1,variant_type:x.variant_type||"imei_child",parent_variant_id:L,...x};g[L]||(g[L]=[]),g[L].push(z),u[L]=(u[L]||0)+1}),f(g),v(u)};y.useEffect(()=>{var s;if(t&&(p!=null&&p.variants)&&!te.current){const i=p.id,r=((s=p.variants)==null?void 0:s.length)||0;i&&r>0&&ce()}},[t,p==null?void 0:p.id,(T=p==null?void 0:p.variants)==null?void 0:T.length,ce]),y.useEffect(()=>{if(!t||!(p!=null&&p.variants)||!D.trim()){ee(new Set);return}const s=async()=>{const r=D.toLowerCase().trim(),n=p.variants.map(o=>o.id);if(n.length===0){ee(new Set);return}try{const{data:o,error:c}=await ie.from("lats_product_variants").select("parent_variant_id, variant_attributes, sku").in("parent_variant_id",n).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0);if(c){console.error("Error searching child variants:",c),ee(new Set);return}const g=p.id,{data:u,error:x}=await ie.from("inventory_items").select("product_id, serial_number, imei").eq("product_id",g).eq("status","available").not("serial_number","is",null),L=new Set;o&&o.forEach(_=>{var B,W,O,z;const k=(((B=_.variant_attributes)==null?void 0:B.imei)||((W=_.variant_attributes)==null?void 0:W.IMEI)||"").toLowerCase(),d=(((O=_.variant_attributes)==null?void 0:O.serial_number)||((z=_.variant_attributes)==null?void 0:z.serialNumber)||"").toLowerCase(),b=(_.sku||"").toLowerCase();(k&&(k.includes(r)||k.endsWith(r))||d&&(d.includes(r)||d.endsWith(r))||b&&(b.includes(r)||b.endsWith(r)))&&L.add(_.parent_variant_id)}),u&&!x&&u.some(k=>{const d=(k.imei||"").toLowerCase(),b=(k.serial_number||"").toLowerCase();return d&&(d.includes(r)||d.endsWith(r))||b&&(b.includes(r)||b.endsWith(r))})&&n.forEach(k=>L.add(k)),ee(L)}catch(o){console.error("Error in searchChildVariants:",o),ee(new Set)}},i=setTimeout(()=>{s()},300);return()=>clearTimeout(i)},[D,t,p]),y.useEffect(()=>{var i,r;const s=p;if(t&&s&&!w){console.log("ðŸŽ¯ Modal opened for product:",s.name),console.log("ðŸ“¦ Total variants:",(i=s.variants)==null?void 0:i.length);const n=((r=s.variants)==null?void 0:r.filter(o=>{const c=o.quantity??o.stockQuantity??o.stock_quantity??0,g=o.is_active!==!1&&o.isActive!==!1;return c>0&&g}))||[];console.log("âœ… Available variants after filter:",n.length)}},[t,p,w]),y.useEffect(()=>{if(!t)return;const s=i=>{var o;const r=p,n=((o=r==null?void 0:r.variants)==null?void 0:o.filter(c=>{const g=c.quantity??c.stockQuantity??c.stock_quantity??0,u=c.is_active!==!1&&c.isActive!==!1;return g>0&&u}))||[];switch(i.key){case"Escape":a();break;case"ArrowDown":i.preventDefault(),J(c=>Math.min(c+1,n.length-1));break;case"ArrowUp":i.preventDefault(),J(c=>Math.max(c-1,0));break;case"Enter":if(i.preventDefault(),n[G]){const c=n[G];de(c)?be(c.id):Q(c)}break}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[t,G,p,a]);const de=s=>{const i=s.is_parent===!0||s.variant_type==="parent"||s.variantType==="parent",r=(C[s.id]||0)>0,n=i||r;return r&&console.log(`âœ… Variant "${s.name||s.variant_name}" has ${C[s.id]} children`),n},xe=async s=>{var i;if(E[s]){console.log(`âš¡ Using preloaded children for parent: ${s} (${E[s].length} children)`);return}try{const{childVariantsCacheService:r}=await ae(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),n=r.getChildVariants(s);if(n&&n.length>0){console.log(`âš¡ Using cached children for parent: ${s} (${n.length} children)`),f(o=>({...o,[s]:n}));return}}catch(r){console.warn("Error checking cache service:",r)}N(r=>new Set(r).add(s));try{const r=(i=p==null?void 0:p.variants)==null?void 0:i.find(g=>g.id===s),n=(r==null?void 0:r.sellingPrice)??(r==null?void 0:r.selling_price)??(r==null?void 0:r.price)??0,{loadAvailableChildIMEIs:o}=await ae(()=>import("./variantHelpers-318d278a.js"),["assets/variantHelpers-318d278a.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),c=await o(s);if(c&&c.length>0){const g=c.map(u=>{var b,B,W,O,z,X;const x=((b=u.variant_attributes)==null?void 0:b.imei)||((B=u.variant_attributes)==null?void 0:B.IMEI)||u.imei||((W=u.variant_attributes)==null?void 0:W.serial_number)||((O=u.variant_attributes)==null?void 0:O.serialNumber)||((z=u.variant_attributes)==null?void 0:z.serial)||u.serial_number||u.sku||"N/A",L=x,_=((X=u.variant_attributes)==null?void 0:X.condition)||u.condition||"New",k=u.selling_price||u.sellingPrice||u.price,d=k&&k>0?k:n;return{id:u.id,name:u.variant_name||u.name||`IMEI: ${x}`,sku:u.sku||x,quantity:u.quantity||0,sellingPrice:d,price:d,imei:x,serialNumber:L,condition:_,variant_attributes:u.variant_attributes,is_imei_child:!0,is_legacy:u.is_legacy||!1,variant_type:u.variant_type||"imei_child",parent_variant_id:s,...u}});f(u=>({...u,[s]:g}))}else f(g=>({...g,[s]:[]}))}catch(r){console.error("âŒ Error loading child variants:",r),Pe.error("Failed to load device variants"),f(n=>({...n,[s]:[]}))}finally{N(r=>{const n=new Set(r);return n.delete(s),n})}},be=async s=>{const i=new Set(S);i.has(s)?i.delete(s):(i.add(s),E[s]||await xe(s)),q(i)},Q=s=>{P[s.id];const i=de(s),r=C[s.id]||0,n=E[s.id];if(i&&(r>0||n&&n.length>0)){Pe.error("âš ï¸ Please select a specific device (IMEI) from the list below",{duration:4e3,icon:"ðŸ“±"}),S.has(s.id)||be(s.id);return}const c=new Set(V);c.has(s.id)?(c.delete(s.id),console.log("âŒ Deselected variant:",s.imei||s.name||s.id)):(c.add(s.id),console.log("âœ… Selected variant:",s.imei||s.name||s.id)),oe(c)},ve=(s,i)=>{var n;const r=((n=U[i])==null?void 0:n.toLowerCase())||"";return r?s.filter(o=>{const c=(o.imei||o.serialNumber||o.sku||"").toLowerCase(),g=(o.condition||"").toLowerCase();return c.includes(r)||c.endsWith(r)||g.includes(r)||g.endsWith(r)}):s},A=p;let H=((pe=A==null?void 0:A.variants)==null?void 0:pe.filter(s=>{const i=s.quantity??s.stockQuantity??s.stock_quantity??0,r=s.is_active!==!1&&s.isActive!==!1;return i>0&&r}))||[];if(D.trim()){const s=D.toLowerCase().trim();H=H.filter(i=>{const r=(i.name||i.variant_name||"").toLowerCase(),n=(i.sku||"").toLowerCase(),o=r.includes(s)||r.endsWith(s)||n.includes(s)||n.endsWith(s),g=(E[i.id]||[]).some(x=>{const L=(x.imei||x.serialNumber||x.sku||"").toLowerCase();return L.includes(s)||L.endsWith(s)}),u=Le.has(i.id);return o||g||u})}H.length===0&&(A!=null&&A.variants)&&A.variants.length>0&&(w?H=A.variants.filter(s=>s.is_active!==!1&&s.isActive!==!1):console.log("â„¹ï¸ No variants with stock available for POS - product is out of stock"));const se=H.filter(s=>de(s)?(E[s.id]||[]).some(r=>V.has(r.id)):!1).length;return De.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[99999] transition-opacity duration-300",style:{overflow:"hidden",overscrollBehavior:"none"},onClick:a,role:"dialog","aria-modal":"true","aria-labelledby":"variant-modal-title"}),e.jsx("div",{className:"fixed inset-0 z-[99999] flex items-center justify-center p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden relative pointer-events-auto",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{onClick:a,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(Be,{className:"w-5 h-5"})}),e.jsxs("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center mb-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(we,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{className:"flex-1",children:[(A==null?void 0:A.name)&&e.jsx("h3",{className:"text-3xl font-extrabold text-gray-900 mb-1",children:A.name}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("p",{id:"variant-modal-title",className:"text-sm text-gray-500 font-medium",children:"Select Multiple Variants"}),se>0&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),e.jsxs("span",{className:"text-sm font-bold text-green-700",children:[se," Complete"]})]})]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none",children:e.jsx(Ve,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search variants...",value:D,onChange:s=>Z(s.target.value),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-gray-900 placeholder-gray-400"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:e.jsx("div",{className:"space-y-4 py-4",children:H.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-2xl shadow-sm",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-md",children:e.jsx(Se,{className:"w-10 h-10 text-gray-400"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-3",children:"No Variants Available"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"This product has no available variants in stock."})]}):e.jsx(e.Fragment,{children:H.map((s,i)=>{const r=de(s),n=S.has(s.id),o=E[s.id]||[],c=j.has(s.id);P[s.id];const g=E[s.id]!==void 0,u=C[s.id]||0;if(ve(o,s.id),H.length===1&&r&&(g&&o.length>0||r))return e.jsx(_e.Fragment,{children:c?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Loading devices..."})]}):!g&&r?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Loading child variants..."})]}):o.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Se,{className:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:"No specific devices available"}),e.jsx("p",{className:"text-gray-500 text-sm mb-4",children:C[s.id]>0?"All devices are currently out of stock":"This variant has no individual devices tracked. You can add the parent variant directly."}),C[s.id]===0&&e.jsx("button",{onClick:()=>Q(s),className:"mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Add Parent Variant to Cart"})]}):e.jsx("div",{className:"space-y-3",children:o.map(d=>{const b=V.has(d.id);return d.quantity,e.jsxs("div",{className:`group relative border-2 rounded-2xl bg-white transition-all duration-300 cursor-pointer overflow-hidden ${b?"border-green-500 ring-4 ring-green-100":"border-gray-200 hover:border-blue-400 hover:-translate-y-0.5"}`,onClick:()=>Q(d),children:[b&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-green-500 to-emerald-600"}),e.jsxs("div",{className:"flex items-center justify-between p-5",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300 ${b?"bg-gradient-to-br from-green-500 to-emerald-600 scale-110":"bg-gradient-to-br from-gray-100 to-gray-200 group-hover:from-blue-50 group-hover:to-indigo-50"}`,children:b?e.jsx("svg",{className:"w-6 h-6 text-white animate-[scale-in_0.3s_ease-out]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}):e.jsx(we,{className:`w-6 h-6 transition-colors ${b?"text-white":"text-gray-400 group-hover:text-blue-500"}`})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-900 truncate",children:d.imei||d.serialNumber}),d.condition&&d.condition.toLowerCase()!=="new"&&e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200",children:d.condition})]})})]}),e.jsx("div",{className:"flex flex-col items-end gap-2 ml-4",children:e.jsx("button",{onClick:B=>{B.stopPropagation(),Q(d)},className:`px-6 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 ${b?"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white":"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white"}`,children:b?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"Selected"]}):"Select"})})]}),!b&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/0 via-blue-500/0 to-blue-500/0 group-hover:from-blue-500/5 group-hover:via-blue-500/10 group-hover:to-blue-500/5 transition-all duration-300 pointer-events-none rounded-2xl"})]},d.id)})})},s.id);const _=!r||u===0&&(!o||o.length===0),k=_&&V.has(s.id);return e.jsxs("div",{className:`border-2 rounded-2xl bg-white shadow-sm transition-all duration-300 relative overflow-hidden ${k?"border-green-500 ring-4 ring-green-100":n?"border-blue-500 shadow-xl":"border-gray-200 hover:border-gray-300 hover:shadow-md"}`,children:[k&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-green-500 to-emerald-600"}),e.jsxs("div",{className:"flex items-start justify-between p-6 cursor-pointer group",onClick:()=>{r&&(u>0||o&&o.length>0)?be(s.id):Q(s)},children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-6 h-6 rounded-lg flex items-center justify-center transition-colors ${k?"bg-gradient-to-br from-green-500 to-emerald-600 scale-110":n?"bg-blue-500":"bg-gray-200"}`,children:k?e.jsx("svg",{className:"w-4 h-4 text-white animate-[scale-in_0.3s_ease-out]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}):e.jsx("svg",{className:`w-4 h-4 text-white transition-transform duration-200 ${n?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:s.name||s.variant_name||"Unnamed Variant"}),(()=>{const d=s.quantity??s.stockQuantity??s.stock_quantity??0,b=d>0&&d<=5;return d===0?e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200",children:"Out of Stock"}):b?e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200 animate-pulse",children:"Low Stock"}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200",children:"In Stock"})})()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm font-semibold text-gray-600 flex items-center gap-1.5",children:[e.jsx("span",{className:`inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold ${(()=>{const d=s.quantity??s.stockQuantity??s.stock_quantity??0,b=d>0&&d<=5;return d===0?"bg-red-500 text-white":b?"bg-orange-500 text-white":"bg-emerald-500 text-white"})()}`,children:s.quantity??s.stockQuantity??s.stock_quantity??0}),e.jsx("span",{className:"text-gray-500",children:"units available"})]}),r&&u>0&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200",children:[u," devices"]})]})]})]})}),e.jsx("div",{className:"flex flex-col items-end gap-2 ml-4",children:_&&e.jsx("button",{onClick:d=>{d.stopPropagation(),Q(s)},className:`px-6 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 ${k?"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white":"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white"}`,children:k?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"Selected"]}):"Select"})})]}),!k&&!n&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/0 via-blue-500/0 to-blue-500/0 group-hover:from-blue-500/5 group-hover:via-blue-500/10 group-hover:to-blue-500/5 transition-all duration-300 pointer-events-none rounded-2xl"}),r&&n&&e.jsx("div",{className:"bg-white p-6 border-t-2 border-gray-200 rounded-b-2xl",children:c?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-700 font-medium text-lg",children:"Loading devices..."})]}):o.length===0?e.jsxs("div",{className:"text-center py-12 bg-white/60 backdrop-blur-sm rounded-2xl border border-white/50",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-red-100 to-orange-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(Se,{className:"w-10 h-10 text-orange-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"No Devices Available"}),e.jsx("p",{className:"text-gray-600 text-base mb-4 px-4",children:C[s.id]>0?"All devices are currently out of stock":"This variant has no individual devices tracked"}),C[s.id]===0&&e.jsx("button",{onClick:()=>Q(s),className:"mt-4 px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-semibold transition-all transform hover:scale-105",children:"Add Variant"})]}):e.jsx("div",{className:"space-y-3",children:o.map(d=>{const b=V.has(d.id);return d.quantity,e.jsxs("div",{className:`group relative border-2 rounded-2xl bg-white transition-all duration-300 cursor-pointer overflow-hidden ${b?"border-green-500 ring-4 ring-green-100":"border-gray-200 hover:border-blue-400 hover:-translate-y-0.5"}`,onClick:()=>Q(d),children:[b&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-green-500 to-emerald-600"}),e.jsxs("div",{className:"flex items-center justify-between p-5",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300 ${b?"bg-gradient-to-br from-green-500 to-emerald-600 scale-110":"bg-gradient-to-br from-gray-100 to-gray-200 group-hover:from-blue-50 group-hover:to-indigo-50"}`,children:b?e.jsx("svg",{className:"w-6 h-6 text-white animate-[scale-in_0.3s_ease-out]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}):e.jsx(we,{className:`w-6 h-6 transition-colors ${b?"text-white":"text-gray-400 group-hover:text-blue-500"}`})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[e.jsx("h4",{className:"text-xl font-bold text-gray-900 truncate",children:d.imei||d.serialNumber}),d.condition&&d.condition.toLowerCase()!=="new"&&e.jsx("span",{className:"inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200",children:d.condition})]})})]}),e.jsx("div",{className:"flex flex-col items-end gap-2 ml-4",children:e.jsx("button",{onClick:B=>{B.stopPropagation(),Q(d)},className:`px-6 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 ${b?"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white":"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white"}`,children:b?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"Selected"]}):"Select"})})]}),!b&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-500/0 via-blue-500/0 to-blue-500/0 group-hover:from-blue-500/5 group-hover:via-blue-500/10 group-hover:to-blue-500/5 transition-all duration-300 pointer-events-none rounded-2xl"})]},d.id)})})})]},s.id)})})})}),e.jsxs("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex gap-4 flex-shrink-0",children:[e.jsx("button",{onClick:()=>{oe(new Set),le(new Set)},className:"px-8 py-3 border-2 border-gray-300 text-gray-700 hover:bg-gray-100 rounded-xl transition-colors font-semibold",children:"Clear All"}),e.jsxs("button",{onClick:()=>{if(V.size>0){let s=0;const i=[];Object.values(E).forEach(r=>{i.push(...r)}),V.forEach(r=>{let n=i.find(o=>o.id===r);if(n||(n=H.find(o=>o.id===r)),n){const o=P[n.id]||1;m(A,n,o),s++}}),s>0&&Pe.success(`Added ${s} variant(s) to cart`),a()}},disabled:V.size===0,className:"flex-1 px-8 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center gap-2",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"w-5 h-5",children:[e.jsx("path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"}),e.jsx("path",{d:"m9 12 2 2 4-4"})]}),e.jsxs("span",{children:["Confirm Selection (",V.size,")"]})]})]})]})})]}),document.body)},ct=({product:t,onAddToCart:a,onViewDetails:l,onView:m,onEdit:w,onDelete:S,variant:q="default",showStockInfo:E=!0,showCategory:f=!0,showActions:j=!1,isSelected:N=!1,onSelect:P,showCheckbox:R=!1,className:C="",primaryColor:v="blue",actionText:U="Add to Cart",allowOutOfStockSelection:$=!1,realTimeStockData:D,currencyCode:Z="TZS",currencySymbol:G="TSh",disableVariantModal:J=!1})=>{var b,B,W,O,z,X,ue,me;const[ge,I]=y.useState(!1),[V,oe]=y.useState(new Map),[je,le]=y.useState(!1),[Le,ee]=y.useState(null),fe=Ze(),{showProductImages:te,showStockLevels:p,showPrices:ce,showBarcodes:Ne}=fe;Oe();const[de,xe]=y.useState(null),[be,Q]=y.useState(!1);y.useState(!1);const[ve,A]=y.useState(!1);y.useEffect(()=>{I(!1)},[]),y.useEffect(()=>{if(!D&&t!=null&&t.id){const h=setTimeout(()=>{i()},100);return()=>clearTimeout(h)}},[t==null?void 0:t.id,D]);const se=(()=>{switch(v){case"orange":return{hoverBorder:"hover:border-orange-300",textColor:"text-orange-600",iconColor:"text-orange-600",priceColor:"text-orange-900",errorColor:"text-orange-600"};case"green":return{hoverBorder:"hover:border-green-300",textColor:"text-green-600",iconColor:"text-green-600",priceColor:"text-green-900",errorColor:"text-green-600"};case"purple":return{hoverBorder:"hover:border-purple-300",textColor:"text-purple-600",iconColor:"text-purple-600",priceColor:"text-purple-900",errorColor:"text-purple-600"};default:return{hoverBorder:"hover:border-blue-300",textColor:"text-blue-600",iconColor:"text-blue-600",priceColor:"text-blue-900",errorColor:"text-blue-600"}}})();if(!t)return console.error("VariantProductCard: Product is null or undefined"),e.jsx("div",{className:"p-4 border border-red-200 bg-red-50 rounded-lg",children:e.jsx("p",{className:"text-red-600 text-sm",children:"Product data is missing"})});let T,pe;try{T=He(t),pe=Ke(t)}catch(h){return console.error("Error getting product data:",h),I(!0),e.jsxs("div",{className:"p-4 border border-red-200 bg-red-50 rounded-lg",children:[e.jsx("p",{className:"text-red-600 text-sm",children:"Error loading product data"}),e.jsx("button",{onClick:()=>I(!1),className:"mt-2 text-blue-600 text-xs hover:underline",children:"Try again"})]})}const s=()=>{if(!t.variants||t.variants.length===0)return"No variants";const h=t.variants.map(M=>Number(M.sellingPrice)||0).filter(M=>M>0).sort((M,F)=>M-F);return h.length===0?"No price set":h[0].toLocaleString()},i=async()=>{if(!(!(t!=null&&t.id)||D))try{le(!0);const M=await ne.getInstance().getStockLevels([t.id]),F=new Map;Object.entries(M).forEach(([K,Y])=>{const ye=Y.reduce((he,re)=>he+re.quantity,0);F.set(K,ye)}),oe(F),ee(new Date)}catch(h){console.error("âŒ Error fetching real-time stock:",h)}finally{le(!1)}},r=()=>qe(t),n=async()=>{var K;if(j&&m){m(t);return}if(!t.variants||t.variants.length===0){console.warn("âš ï¸ Cannot add product to cart: No variants available",t);return}const h=((K=t.variants)==null?void 0:K.every(Y=>(Y.quantity??0)<=0))??!0;if(!$&&h)return;const M=t.variants&&t.variants.length>1,F=t.variants&&t.variants.length===1;if(J&&l){l(t);return}if(M){A(!0);return}if(F){const Y=t.variants[0],ye=Y.is_parent||Y.variant_type==="parent";let he=!1;try{const{supabase:re}=await ae(()=>import("./index-61458a34.js").then(Ae=>Ae.b6),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),{count:ke}=await re.from("lats_product_variants").select("id",{count:"exact",head:!0}).eq("parent_variant_id",Y.id).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0),{count:Ce}=await re.from("inventory_items").select("id",{count:"exact",head:!0}).eq("product_id",t.id).eq("variant_id",Y.id).not("serial_number","is",null).eq("status","available");he=(ke||0)+(Ce||0)>0,console.log(`ðŸ” Checking variant ${Y.id} for children: ${he?`HAS ${(ke||0)+(Ce||0)} CHILDREN`:"NO CHILDREN"} (IMEI: ${ke||0}, Legacy: ${Ce||0})`)}catch(re){if(console.error("Error checking for children:",re),ye){console.log("âš ï¸ Error checking children, but variant is marked as parent - opening modal"),A(!0);return}}if(he){console.log("âœ… Opening variant modal - variant has children"),A(!0);return}else ye&&console.log("â„¹ï¸ Variant marked as parent but has no children - treating as regular variant")}if(l){l(t);return}if(T&&(T.quantity??0)>0)a&&a(t,T,1);else if(!$)return},o=(h,M,F)=>{if(l){xe(M),l(h,M);return}a&&a(h,M,F)};ze(t);const g=(()=>!t.images||t.images.length===0?[]:t.images.map((M,F)=>({id:`temp-${t.id}-${F}`,url:M,thumbnailUrl:M,fileName:`product-image-${F+1}`,fileSize:0,isPrimary:F===0,uploadedAt:new Date().toISOString()})))();if(q==="compact"){const h=!t.variants||t.variants.length===0,M=((b=t.variants)==null?void 0:b.every(K=>(K.quantity??0)<=0))??!0,F=h&&!$||!$&&M;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200 flex flex-col h-full ${C} ${F?"opacity-50 cursor-not-allowed":`cursor-pointer ${se.hoverBorder} hover:shadow-lg active:scale-98`} ${h&&!$?"border-gray-300 bg-gray-50":""}`,onClick:n,title:h&&!$?"This product has no variants and cannot be added to cart. Please add variants in the inventory management.":"",children:[e.jsx("div",{className:"w-full mb-3 cursor-pointer hover:opacity-90 transition-opacity",onClick:K=>{K.stopPropagation()},children:e.jsx($e,{images:g.map(K=>K.url),productName:t.name,size:"md",className:"w-full h-32 sm:h-36 md:h-40 object-cover rounded-lg"})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("h3",{className:`font-semibold text-sm sm:text-base mb-2 truncate ${h&&!$?"text-gray-500":"text-gray-900"}`,title:t.name,children:t.name}),e.jsx("p",{className:"text-xs text-gray-500 font-mono mb-2 truncate",children:(T==null?void 0:T.sku)||"N/A"}),f&&(t.categoryName||((B=t.category)==null?void 0:B.name))&&e.jsx("div",{className:"mb-2",children:e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs bg-purple-50 text-purple-700 border border-purple-200 font-medium truncate max-w-full",children:["ðŸ“¦ ",t.categoryName||((W=t.category)==null?void 0:W.name)]})}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"mt-auto pt-2 border-t border-gray-100",children:ce&&e.jsxs("div",{className:`font-bold text-lg truncate ${h&&!$?"text-gray-500":se.priceColor}`,title:`${G} ${s()}`,children:[G," ",s()]})})]})]})})}const u=!t.variants||t.variants.length===0,x=((O=t.variants)==null?void 0:O.every(h=>(h.quantity??0)<=0))??!0,L=u&&!$||!$&&x,_=(T==null?void 0:T.costPrice)||0,k=(T==null?void 0:T.sellingPrice)||0,d=k>0?((k-_)/k*100).toFixed(1):"0";return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`pos-product-card relative bg-white border-2 rounded-xl transition-all duration-300 overflow-hidden ${C} ${L?"opacity-50 cursor-not-allowed":`cursor-pointer ${se.hoverBorder} hover:shadow-lg active:scale-98`} ${u&&!$?"border-gray-300 bg-gray-50":"border-gray-200"} ${N?"ring-4 ring-blue-400 border-blue-500":""}`,onClick:h=>{h.target.closest(".action-button")||(R&&P?P(t.id):n())},title:u&&!$?"This product has no variants and cannot be added to cart. Please add variants in the inventory management.":"",children:[R&&e.jsx("div",{className:"absolute top-3 left-3 z-30 action-button",onClick:h=>h.stopPropagation(),children:e.jsx("input",{type:"checkbox",checked:N,onChange:h=>{h.stopPropagation(),P&&P(t.id)},className:"w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-2 cursor-pointer"})}),p&&E&&e.jsxs("div",{className:`absolute top-1 right-1 sm:top-2 sm:right-2 p-1.5 sm:p-2 rounded-full border-2 border-white shadow-lg flex items-center justify-center z-20 w-8 h-8 sm:w-10 sm:h-10 transition-all duration-300 ${r()<=0||r()<=5?"bg-gradient-to-r from-red-500 to-red-600":r()<=10?"bg-gradient-to-r from-orange-500 to-orange-600":"bg-gradient-to-r from-green-500 to-emerald-500"}`,children:[e.jsx("span",{className:"text-xs sm:text-sm font-bold text-white",children:je?"...":r()>=1e3?`${(r()/1e3).toFixed(1)}K`:r()}),je&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 border-2 border-white border-t-transparent rounded-full animate-spin"})})]}),e.jsxs("div",{className:"p-3 sm:p-4 md:p-6 cursor-pointer flex flex-col h-full",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 md:gap-4 flex-1 min-w-0",children:[te&&e.jsxs("div",{className:`relative w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-xl flex items-center justify-center text-lg font-bold ${se.iconColor} cursor-pointer hover:opacity-90 transition-opacity`,onClick:h=>{h.stopPropagation(),Q(!0)},children:[e.jsx($e,{images:g.map(h=>h.url),productName:t.name,size:"lg",className:"w-full h-full rounded-xl"}),t.variants&&t.variants.length>1&&e.jsx("div",{className:"absolute -top-1 -right-1 sm:-top-2 sm:-right-2 w-5 h-5 sm:w-6 sm:h-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center",children:e.jsx("span",{className:"text-[10px] sm:text-xs font-bold text-white",children:t.variants.length})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-800 truncate text-sm sm:text-base md:text-lg lg:text-xl leading-tight",title:t.name,children:t.name}),e.jsxs("div",{className:"text-lg sm:text-xl md:text-2xl text-gray-700 mt-0.5 sm:mt-1 font-bold",children:[G," ",s()]})]})]})}),j?e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 space-y-3",children:[ce&&e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Cost"}),e.jsx("span",{className:"text-gray-900 font-semibold",children:Ie.currency(_)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Selling"}),e.jsx("span",{className:"text-green-700 font-semibold",children:Ie.currency(k)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-gray-500 font-medium",children:"Margin"}),e.jsxs("span",{className:`font-semibold ${parseFloat(d)<10?"text-red-600":parseFloat(d)<30?"text-orange-600":"text-green-600"}`,children:[d,"%"]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(t.shelfCode||t.shelfName||t.storeLocationName||t.storageRoomName)&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-blue-50 text-blue-700 border border-blue-200 text-xs",children:["ðŸ“ ",t.shelfCode||t.shelfName||t.storeLocationName||t.storageRoomName]}),f&&(t.categoryName||((z=t.category)==null?void 0:z.name))&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-purple-50 text-purple-700 border border-purple-200 text-xs font-medium",children:["ðŸ“¦ ",t.categoryName||((X=t.category)==null?void 0:X.name)]}),t.supplierName&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-green-50 text-green-700 border border-green-200 text-xs",children:["ðŸ¢ ",t.supplierName]}),t.isFeatured&&e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-yellow-50 text-yellow-700 border border-yellow-200 text-xs font-medium",children:"â­ Featured"})]}),t.variants&&t.variants.length>1&&e.jsx("div",{className:"flex items-center justify-between text-xs bg-gradient-to-r from-indigo-50 to-purple-50 px-3 py-2 rounded-lg",children:e.jsxs("span",{className:"text-gray-600",children:[e.jsx("span",{className:"font-semibold text-indigo-700",children:t.variants.length})," variants available"]})})]}):e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"flex items-center gap-4",children:(t.shelfCode||t.shelfName||t.storeLocationName||t.storageRoomName)&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-blue-50 text-blue-700 border border-blue-200 text-xs",children:["ðŸ“¦ ",t.shelfCode||t.shelfName||t.storeLocationName||t.storageRoomName||"Shelf Info"]})})}),e.jsx("div",{className:"flex items-center gap-2",children:f&&(t.categoryName||((ue=t.category)==null?void 0:ue.name))&&e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md bg-purple-50 text-purple-700 border border-purple-200 text-xs font-medium",children:["ðŸ“¦ ",t.categoryName||((me=t.category)==null?void 0:me.name)]})})]})}),e.jsx("div",{className:"flex-1"}),j?e.jsxs("div",{className:"mt-auto pt-4 border-t border-gray-200 space-y-2 action-button",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[m&&e.jsxs("button",{onClick:h=>{h.stopPropagation(),m(t)},className:"flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 rounded-lg transition-colors",children:[e.jsx(Fe,{className:"w-3.5 h-3.5"}),"View"]}),w&&e.jsxs("button",{onClick:h=>{h.stopPropagation(),w(t)},className:"flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 rounded-lg transition-colors",children:[e.jsx(Ue,{className:"w-3.5 h-3.5"}),"Edit"]}),S&&e.jsxs("button",{onClick:h=>{h.stopPropagation(),S(t)},className:"flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 rounded-lg transition-colors",children:[e.jsx(We,{className:"w-3.5 h-3.5"}),"Delete"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs px-2",children:[e.jsx("span",{className:"text-gray-500",children:"Status:"}),e.jsx("span",{className:`font-medium ${t.isActive?"text-green-600":"text-gray-400"}`,children:t.isActive?"â— Active":"â—‹ Inactive"})]})]}):null]})]}),ve&&e.jsx(Je,{isOpen:ve,onClose:()=>A(!1),product:t,onSelectVariant:o,isPurchaseOrderMode:$})]})};export{$e as P,ne as R,ct as V,He as a,Ke as b,Je as c,ot as e,qe as g,ze as i,Ze as u,lt as v};
