import{_ as d}from"./supabase-cf010ec4.js";import{a1 as c,s as p,d as u,Z as m}from"./index-61458a34.js";import{smartCache as S,fetchProducts as y,fetchCustomers as f,fetchCategories as P,fetchSuppliers as v,fetchBranches as _,fetchPaymentAccounts as w}from"./enhancedCacheManager-afe341e0.js";import{loadParentVariants as C}from"./variantHelpers-318d278a.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";class E{constructor(){this.isPreloading=!1,this.preloadPromise=null}async preloadAllData(r=!1){if(this.isPreloading&&this.preloadPromise)return console.log("ðŸ“¦ Preload already in progress, returning existing promise"),this.preloadPromise;const e=Date.now(),t=c.getState(),a=await S.getCacheStats();Object.values(a).some(o=>o.itemCount>0);const s=Object.values(a).some(o=>o.isFresh);if(!r&&s&&t.isLoaded)return console.log("âœ… [Preload] Using valid cache, skipping preload"),Object.values(a).some(i=>i.isStale)&&(console.log("ðŸ”„ [Preload] Cache is stale, triggering background refresh"),this.refreshInBackground()),{success:!0,loaded:["cache"],failed:[],errors:{},duration:0,fromCache:!0};this.isPreloading=!0,t.setPreloading(!0),t.clearAllErrors(),console.log("ðŸš€ [Preload] Starting data preload with smart cache..."),this.preloadPromise=this.executePreloadWithSmartCache(r);const l=await this.preloadPromise;this.isPreloading=!1,this.preloadPromise=null,t.setPreloading(!1),t.markAsLoaded();const h=Date.now()-e;return console.log(`âœ… [Preload] Completed in ${h}ms`),console.log(`   Loaded: ${l.loaded.join(", ")}`),l.failed.length>0&&console.log(`   Failed: ${l.failed.join(", ")}`),{...l,duration:h}}async executePreloadWithSmartCache(r=!1){const e=[],t=[],a={},s=c.getState(),l=localStorage.getItem("current_branch_id")||void 0,h=[{name:"products",fn:async()=>{const o=await y(l,r);if(s.setProducts(o),o&&o.length>0)try{const{productCacheService:i}=await d(()=>import("./index-61458a34.js").then(n=>n.bi),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);i.saveProducts(o),console.log(`âœ… [Preload] Cached ${o.length} products in productCacheService`)}catch(i){console.warn("âš ï¸ [Preload] Could not populate productCacheService:",i)}if(o&&o.length>0)try{console.log("ðŸš€ [Preload] Starting child variants preload...");const{childVariantsCacheService:i}=await d(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);await i.preloadAllChildVariants(o),console.log("âœ… [Preload] Child variants preloaded successfully")}catch(i){console.warn("âš ï¸ [Preload] Child variants preload failed (non-critical):",i)}return o}},{name:"customers",fn:async()=>{const o=await f(l,r);if(s.setCustomers(o),o&&o.length>0)try{const{customerCacheService:i}=await d(()=>import("./customerCacheService-9b459c09.js"),[]);i.saveCustomers(o),console.log(`âœ… [Preload] Cached ${o.length} customers in customerCacheService`)}catch(i){console.warn("âš ï¸ [Preload] Could not populate customerCacheService:",i)}return o}},{name:"categories",fn:async()=>{const o=await P(r);return s.setCategories(o),o}},{name:"suppliers",fn:async()=>{const o=await v(r);return s.setSuppliers(o),o}},{name:"branches",fn:async()=>{const o=await _(r);return s.setBranches(o),o}},{name:"payment_accounts",fn:async()=>{s.setPaymentAccounts([]);const o=localStorage.getItem("current_branch_id"),i=`payment-methods-${o||"all"}`;m(i);const n=await w(r);return console.log(`ðŸ“¦ [Preload] Loaded ${n.length} payment accounts for branch ${o||"none"}`),s.setPaymentAccounts(n),n}},{name:"parent_variants",fn:async()=>{const o=await this.preloadParentVariants();return s.setParentVariants(o),o}},{name:"employees",fn:async()=>{const o=await this.preloadEmployees();return s.setEmployees(o),o}},{name:"payment_methods",fn:async()=>{const o=await this.preloadPaymentMethods();return s.setPaymentMethods(o),o}},{name:"attendance_records",fn:async()=>{const o=await this.preloadAttendanceRecords();return s.setAttendanceRecords(o),o}},{name:"settings",fn:async()=>{const o=await this.preloadSettings();return s.setSettings(o),o}},{name:"admin_settings",fn:async()=>{const o=await this.preloadAdminSettings();return s.setAdminSettings(o),o}},{name:"purchase_orders",fn:async()=>{const o=await this.preloadPurchaseOrders();return s.setPurchaseOrders(o),o}},{name:"stock_movements",fn:async()=>{const o=await this.preloadStockMovements();return s.setStockMovements(o),o}},{name:"sales",fn:async()=>{const o=await this.preloadSales();return s.setSales(o),o}}];return await Promise.allSettled(h.map(async o=>{try{console.log(`ðŸ“¥ [Preload] Loading ${o.name}...`),await o.fn(),e.push(o.name),console.log(`âœ… [Preload] Loaded ${o.name}`)}catch(i){t.push(o.name),a[o.name]=i.message,console.error(`âŒ [Preload] Failed to load ${o.name}:`,i.message)}})),{success:t.length===0,loaded:e,failed:t,errors:a,fromCache:!r}}async refreshInBackground(){console.log("ðŸ”„ [Preload] Starting background refresh (non-blocking)..."),setTimeout(async()=>{try{await this.executePreloadWithSmartCache(!0),console.log("âœ… [Preload] Background refresh completed")}catch(r){console.error("âŒ [Preload] Background refresh failed:",r)}},0)}async executePreload(){const r=[],e=[],t={},a=[{name:"customers",fn:()=>this.preloadCustomers(),priority:1},{name:"products",fn:()=>this.preloadProducts(),priority:1},{name:"categories",fn:()=>this.preloadCategories(),priority:1},{name:"suppliers",fn:()=>this.preloadSuppliers(),priority:2},{name:"branches",fn:()=>this.preloadBranches(),priority:2},{name:"settings",fn:()=>this.preloadSettings(),priority:2},{name:"users",fn:()=>this.preloadUsers(),priority:3},{name:"devices",fn:()=>this.preloadDevices(),priority:3}],s=a.length;let l=0;const h=a.filter(n=>n.priority===1);await Promise.allSettled(h.map(async n=>{try{await n.fn(),r.push(n.name),console.log(`âœ… Loaded ${n.name}`)}catch(g){e.push(n.name),t[n.name]=g.message,console.error(`âŒ Failed to load ${n.name}:`,g.message)}finally{l++,this.updateProgress(l,s,n.name)}}));const o=a.filter(n=>n.priority===2);await Promise.allSettled(o.map(async n=>{try{await n.fn(),r.push(n.name),console.log(`âœ… Loaded ${n.name}`)}catch(g){e.push(n.name),t[n.name]=g.message,console.error(`âŒ Failed to load ${n.name}:`,g.message)}finally{l++,this.updateProgress(l,s,n.name)}}));const i=a.filter(n=>n.priority===3);return await Promise.allSettled(i.map(async n=>{try{await n.fn(),r.push(n.name),console.log(`âœ… Loaded ${n.name}`)}catch(g){e.push(n.name),t[n.name]=g.message,console.error(`âŒ Failed to load ${n.name}:`,g.message)}finally{l++,this.updateProgress(l,s,n.name)}})),{success:e.length===0,loaded:r,failed:e,errors:t}}updateProgress(r,e,t){const a=Math.round(r/e*100);c.getState().setPreloadProgress(a,`Loading ${t}...`)}async preloadCustomers(){const r=c.getState();if(r.isCacheValid("customers")&&r.customers&&r.customers.length>0){console.log("ðŸ“¦ Using cached customers");return}try{const{data:e,error:t}=await p.from("customers").select("*").order("name",{ascending:!0}).limit(1e3);if(t)throw t;if(r.setCustomers(e||[]),e&&e.length>0)try{const{customerCacheService:a}=await d(()=>import("./customerCacheService-9b459c09.js"),[]);a.saveCustomers(e)}catch(a){console.warn("âš ï¸ Could not populate customerCacheService:",a)}}catch(e){throw console.error("âŒ Error preloading customers:",e),r.setError("customers",e.message),e}}async preloadProducts(){const r=c.getState();if(r.isCacheValid("products")&&r.products&&r.products.length>0){console.log("ðŸ“¦ Using cached products");const e=r.products;if(e&&e.length>0)try{const{productCacheService:t}=await d(()=>import("./index-61458a34.js").then(a=>a.bi),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);t.saveProducts(e),console.log(`âœ… [Preload] Cached ${e.length} products in productCacheService`)}catch(t){console.warn("âš ï¸ [Preload] Could not populate productCacheService:",t)}if(e&&e.length>0)try{console.log("ðŸš€ [Preload] Starting child variants preload for cached products...");const{childVariantsCacheService:t}=await d(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);await t.preloadAllChildVariants(e),console.log("âœ… [Preload] Child variants preloaded for cached products")}catch(t){console.warn("âš ï¸ [Preload] Child variants preload failed (non-critical):",t)}return}try{const e=u.getState();await e.loadProducts({page:1,limit:500});const t=e.products;if(r.setProducts(t),console.log(`âœ… Preloaded ${t.length} products`),t&&t.length>0)try{const{productCacheService:a}=await d(()=>import("./index-61458a34.js").then(s=>s.bi),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);a.saveProducts(t),console.log(`âœ… [Preload] Cached ${t.length} products in productCacheService`)}catch(a){console.warn("âš ï¸ [Preload] Could not populate productCacheService:",a)}if(t&&t.length>0)try{console.log("ðŸš€ [Preload] Starting child variants preload...");const{childVariantsCacheService:a}=await d(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);await a.preloadAllChildVariants(t),console.log("âœ… [Preload] Child variants preloaded successfully")}catch(a){console.warn("âš ï¸ [Preload] Child variants preload failed (non-critical):",a)}}catch(e){throw console.error("âŒ Error preloading products:",e),r.setError("products",e.message),e}}async preloadCategories(){const r=c.getState();if(r.isCacheValid("categories")&&r.categories&&r.categories.length>0){console.log("ðŸ“¦ Using cached categories");return}try{const e=u.getState();await e.loadCategories();const t=e.categories;r.setCategories(t),console.log(`âœ… Preloaded ${t.length} categories`)}catch(e){throw console.error("âŒ Error preloading categories:",e),r.setError("categories",e.message),e}}async preloadSuppliers(){const r=c.getState();if(r.isCacheValid("suppliers")&&r.suppliers&&r.suppliers.length>0){console.log("ðŸ“¦ Using cached suppliers");return}try{const e=u.getState();await e.loadSuppliers();const t=e.suppliers;r.setSuppliers(t),console.log(`âœ… Preloaded ${t.length} suppliers`)}catch(e){throw console.error("âŒ Error preloading suppliers:",e),r.setError("suppliers",e.message),e}}async preloadBranches(){const r=c.getState();if(r.isCacheValid("branches")&&r.branches&&r.branches.length>0){console.log("ðŸ“¦ Using cached branches");return}try{const{data:e,error:t}=await p.from("lats_branches").select("*").order("name",{ascending:!0});if(t)throw t;r.setBranches(e||[]),console.log(`âœ… Preloaded ${(e==null?void 0:e.length)||0} branches`)}catch(e){console.error("âŒ Error preloading branches:",e),r.setError("branches",e.message)}}async preloadSettings(){const r=c.getState();if(r.isCacheValid("settings")&&r.settings){console.log("ðŸ“¦ Using cached settings");return}try{const{POSSettingsAPI:e}=await d(()=>import("./index-61458a34.js").then(a=>a.b8),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=await e.loadAllSettings();r.setSettings(t)}catch(e){console.error("âŒ Error preloading settings:",e),r.setError("settings",e.message)}}async preloadAdminSettings(){const r=c.getState();if(r.isCacheValid("adminSettings")&&r.adminSettings&&r.adminSettings.length>0){console.log("ðŸ“¦ Using cached admin settings");return}try{const{getAdminSettings:e}=await d(()=>import("./adminSettingsApi-e3f0908e.js"),["assets/adminSettingsApi-e3f0908e.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=await e();r.setAdminSettings(t),console.log(`âœ… Preloaded ${t.length} admin settings`)}catch(e){console.error("âŒ Error preloading admin settings:",e),r.setError("adminSettings",e.message)}}async preloadPurchaseOrders(){const r=c.getState();if(r.isCacheValid("purchaseOrders")&&r.purchaseOrders&&r.purchaseOrders.length>0){console.log("ðŸ“¦ Using cached purchase orders");return}try{const{useInventoryStore:e}=await d(()=>import("./index-61458a34.js").then(s=>s.bk),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=e.getState();await t.loadPurchaseOrders();const a=t.purchaseOrders||[];r.setPurchaseOrders(a),console.log(`âœ… Preloaded ${a.length} purchase orders`)}catch(e){console.error("âŒ Error preloading purchase orders:",e),r.setError("purchaseOrders",e.message)}}async preloadStockMovements(){const r=c.getState();if(r.isCacheValid("stockMovements")&&r.stockMovements&&r.stockMovements.length>0){console.log("ðŸ“¦ Using cached stock movements");return}try{const{useInventoryStore:e}=await d(()=>import("./index-61458a34.js").then(s=>s.bk),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=e.getState();await t.loadStockMovements();const a=t.stockMovements||[];r.setStockMovements(a),console.log(`âœ… Preloaded ${a.length} stock movements`)}catch(e){console.error("âŒ Error preloading stock movements:",e),r.setError("stockMovements",e.message)}}async preloadSales(){const r=c.getState();if(r.isCacheValid("sales")&&r.sales&&r.sales.length>0){console.log("ðŸ“¦ Using cached sales");return}try{const{useInventoryStore:e}=await d(()=>import("./index-61458a34.js").then(s=>s.bk),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=e.getState();await t.loadSales();const a=t.sales||[];r.setSales(a),console.log(`âœ… Preloaded ${a.length} sales records`)}catch(e){console.error("âŒ Error preloading sales:",e),r.setError("sales",e.message)}}async preloadUsers(){const r=c.getState();if(r.isCacheValid("users")&&r.users&&r.users.length>0){console.log("ðŸ“¦ Using cached users");return}try{const{data:e,error:t}=await p.from("users").select("*").eq("is_active",!0).order("full_name",{ascending:!0});if(t)throw t;r.setUsers(e||[]),console.log(`âœ… Preloaded ${(e==null?void 0:e.length)||0} users`)}catch(e){console.error("âŒ Error preloading users:",e),r.setError("users",e.message)}}async preloadDevices(){const r=c.getState();if(r.isCacheValid("devices")&&r.devices&&r.devices.length>0){console.log("ðŸ“¦ Using cached devices");return}try{const{data:e,error:t}=await p.from("devices").select("*").order("created_at",{ascending:!1}).limit(100);if(t)throw t;r.setDevices(e||[]),console.log(`âœ… Preloaded ${(e==null?void 0:e.length)||0} devices`)}catch(e){console.error("âŒ Error preloading devices:",e),r.setError("devices",e.message)}}async preloadParentVariants(){const r=c.getState();if(r.isCacheValid("parentVariants")&&r.parentVariants&&r.parentVariants.length>0){console.log("ðŸ“¦ Using cached parent variants");return}try{const e=r.products;if(!e||e.length===0){console.log("âš ï¸ No products available, skipping parent variants preload");return}const t=[];for(const a of e.slice(0,50))try{const s=await C(a.id);if(s&&s.length>0){const l=s.map(h=>({...h,product_id:a.id}));t.push(...l)}}catch(s){console.warn(`âš ï¸ Failed to load variants for product ${a.id}:`,s)}r.setParentVariants(t),console.log(`âœ… Preloaded ${t.length} parent variants`)}catch(e){console.error("âŒ Error preloading parent variants:",e),r.setError("parentVariants",e.message)}}async preloadEmployees(){const r=c.getState();if(r.isCacheValid("employees")&&r.employees&&r.employees.length>0){console.log("ðŸ“¦ Using cached employees");return}try{const{data:e,error:t}=await p.from("employees").select("*").eq("is_active",!0).order("full_name",{ascending:!0});if(t)throw t;r.setEmployees(e||[]),console.log(`âœ… Preloaded ${(e==null?void 0:e.length)||0} employees`)}catch(e){console.error("âŒ Error preloading employees:",e),r.setError("employees",e.message)}}async preloadPaymentMethods(){const r=c.getState();if(r.isCacheValid("paymentMethods")&&r.paymentMethods&&r.paymentMethods.length>0){console.log("ðŸ“¦ Using cached payment methods");return}try{const{data:e,error:t}=await p.from("payment_methods").select("*").eq("is_active",!0).order("name",{ascending:!0});if(t)throw t;r.setPaymentMethods(e||[]),console.log(`âœ… Preloaded ${(e==null?void 0:e.length)||0} payment methods`)}catch(e){console.error("âŒ Error preloading payment methods:",e),r.setError("paymentMethods",e.message)}}async preloadAttendanceRecords(){const r=c.getState();if(r.isCacheValid("attendanceRecords")&&r.attendanceRecords&&r.attendanceRecords.length>0){console.log("ðŸ“¦ Using cached attendance records");return}try{const e=new Date;e.setDate(e.getDate()-30);const{data:t,error:a}=await p.from("attendance_records").select("*").gte("attendance_date",e.toISOString().split("T")[0]).order("attendance_date",{ascending:!1}).limit(1e3);if(a)throw a;r.setAttendanceRecords(t||[]),console.log(`âœ… Preloaded ${(t==null?void 0:t.length)||0} attendance records`)}catch(e){console.error("âŒ Error preloading attendance records:",e),r.setError("attendanceRecords",e.message)}}async refreshData(r){console.log(`ðŸ”„ Refreshing ${r}...`);const e={customers:()=>this.preloadCustomers(),products:()=>this.preloadProducts(),categories:()=>this.preloadCategories(),suppliers:()=>this.preloadSuppliers(),branches:()=>this.preloadBranches(),settings:()=>this.preloadSettings(),admin_settings:()=>this.preloadAdminSettings(),purchase_orders:()=>this.preloadPurchaseOrders(),stock_movements:()=>this.preloadStockMovements(),sales:()=>this.preloadSales(),users:()=>this.preloadUsers(),devices:()=>this.preloadDevices(),parent_variants:()=>this.preloadParentVariants(),employees:()=>this.preloadEmployees(),payment_methods:()=>this.preloadPaymentMethods(),attendance_records:()=>this.preloadAttendanceRecords()};c.getState().invalidateCache(r);const a=e[r];if(a)try{await a()}catch(s){throw console.error(`âŒ Failed to refresh ${r}:`,s),s}else console.warn(`âš ï¸ No refresh function for ${r}`)}checkAllCacheValid(){const r=c.getState();return["customers","products","categories","suppliers"].every(t=>r.isCacheValid(t))}clearAll(){c.getState().clearAllData(),this.isPreloading=!1,this.preloadPromise=null,console.log("ðŸ§¹ Cleared all preloaded data")}getSummary(){return c.getState().getPreloadSummary()}}const L=new E;export{L as dataPreloadService};
