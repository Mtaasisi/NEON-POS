import{s as h,j as e}from"./index-61458a34.js";import{r as d}from"./vendor-36d2c7c1.js";import{R as H,af as U,b_ as V,e as A,q as J,p as K,u as G,y as X,an as Z,O as f,av as ee,z as O}from"./ui-28e30067.js";import{u as se,a as I}from"./useMobileBranch-d96f1509.js";import{u as te,a as ae}from"./useResponsiveSize-eee1874a.js";import{a as re}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";const ue=()=>{const j=re(),{currentBranch:l,loading:C,isDataShared:D}=se();te(),ae();const[a,q]=d.useState({todaySales:0,todayOrders:0,lowStock:0,totalRevenue:0,totalCustomers:0,totalProducts:0,yesterdaySales:0,yesterdayOrders:0}),[y,L]=d.useState([]),[v,z]=d.useState(!0),[P,le]=d.useState(!1);d.useState(0);const[u,ie]=d.useState(0);d.useRef(null);const B=[{label:"New Sale",path:"/mobile/pos",icon:f},{label:"Reports",path:"/mobile/analytics",icon:ee}],N=s=>{if(s===0||s===null||s===void 0||isNaN(s)||!isFinite(s)||s>1e15||s<-1e15)return"0";const t=Math.abs(s);return t>=1e9?(s/1e9).toFixed(1).replace(/\.0$/,"")+"B":t>=1e6?(s/1e6).toFixed(1).replace(/\.0$/,"")+"M":t>=1e3?(s/1e3).toFixed(1).replace(/\.0$/,"")+"K":s.toFixed(0)},w=s=>{if(!s)return 0;let t=s;return typeof t=="string"&&(t=parseFloat(t.replace(/[^0-9.-]/g,""))),isNaN(t)||!isFinite(t)||t>1e15?0:(t>1e8&&(t=t/100),Math.max(0,t))},Q=s=>{const t=new Date(s),o=new Date().getTime()-t.getTime(),c=Math.floor(o/6e4),x=Math.floor(o/36e5),m=Math.floor(o/864e5);return c<1?"Just now":c<60?`${c} min ago`:x<24?`${x} hour${x>1?"s":""} ago`:`${m} day${m>1?"s":""} ago`},k=async(s=!0)=>{if(!C)try{console.log("ðŸ” [MobileDashboard] Fetching dashboard data for branch:",l==null?void 0:l.name);const t=new Date;t.setHours(0,0,0,0);const i=new Date(t);i.setDate(i.getDate()-1);let o=h.from("lats_sales").select("*").gte("created_at",t.toISOString()),c=h.from("lats_customers").select("id, total_spent"),x=h.from("lats_products").select("id, stock_quantity, min_stock_level").eq("is_active",!0),m=h.from("lats_sales").select("*").order("created_at",{ascending:!1}).limit(10);if(l){o=o.eq("branch_id",l.id),m=m.eq("branch_id",l.id);const r=D("customers");r||(c=I(c,l.id,l.data_isolation_mode,r));const n=D("products");n||(x=I(x,l.id,l.data_isolation_mode,n))}const{data:_,error:Y}=await o,{data:g}=await c,{data:p}=await x,{data:$}=await m;let M=0,F=0;_&&!Y&&(F=_.length,M=_.reduce((r,n)=>{const b=w(n.total_amount||0);return r+b},0));let W=0;g&&(W=g.reduce((r,n)=>{const b=w(n.total_spent);return r+b},0));let E=0;p&&(E=p.filter(r=>{const n=r.stock_quantity||0,b=r.min_stock_level||10;return n<=b}).length);const T=[];$&&$.slice(0,5).forEach(r=>{const n=w(r.total_amount||0);T.push({id:r.id,title:"New sale completed",amount:"TSh "+N(n),time:Q(r.created_at),icon:f,type:"sale"})}),q({todaySales:M,todayOrders:F,lowStock:E,totalRevenue:W,totalCustomers:(g==null?void 0:g.length)||0,totalProducts:(p==null?void 0:p.length)||0,yesterdaySales:0,yesterdayOrders:0}),L(T),console.log("âœ… Dashboard data loaded successfully"),s&&O.success("Dashboard updated")}catch(t){console.error("âŒ Error fetching dashboard data:",t),O.error("Failed to load dashboard data")}};d.useEffect(()=>{const s=async()=>{z(!0),await k(!1),z(!1)};s();const t=()=>{console.log("ðŸ”„ [MobileDashboard] Branch changed, reloading dashboard..."),s()};return window.addEventListener("branchChanged",t),()=>{window.removeEventListener("branchChanged",t)}},[l,C]),d.useEffect(()=>{const s=h.channel("sales-changes").on("postgres_changes",{event:"*",schema:"public",table:"lats_sales"},()=>k(!1)).subscribe(),t=h.channel("products-changes").on("postgres_changes",{event:"*",schema:"public",table:"lats_products"},()=>k(!1)).subscribe();return()=>{s.unsubscribe(),t.unsubscribe()}},[]);const R=(s,t)=>{if(t===0)return{value:s>0?"+100%":"0%",trend:"up"};const i=(s-t)/t*100;return{value:`${i>=0?"+":""}${i.toFixed(0)}%`,trend:i>=0?"up":"down"}},S=R(a.todaySales,a.yesterdaySales);return R(a.todayOrders,a.yesterdayOrders),e.jsx("div",{className:"flex flex-col h-full bg-white overflow-hidden",children:e.jsxs("div",{className:"flex-1 overflow-y-auto pb-20",children:[e.jsx("div",{className:"px-4 pt-3 pb-2",children:e.jsx("h1",{className:"text-[32px] font-bold text-black tracking-tight",children:"Home"})}),v&&e.jsxs("div",{className:"px-4 animate-pulse space-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"bg-white rounded-2xl p-4 border border-gray-100",children:[e.jsx("div",{className:"h-4 w-16 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-8 w-20 bg-gray-200 rounded mb-1"}),e.jsx("div",{className:"h-3 w-12 bg-gray-200 rounded"})]},s))}),e.jsxs("div",{className:"bg-white rounded-2xl p-4 border border-gray-100",children:[e.jsx("div",{className:"h-5 w-32 bg-gray-200 rounded mb-4"}),e.jsx("div",{className:"h-48 bg-gray-200 rounded"})]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"w-14 h-14 bg-gray-200 rounded-2xl"}),e.jsx("div",{className:"h-3 w-12 bg-gray-200 rounded"})]},s))})]}),u>0&&!v&&e.jsxs("div",{className:"flex items-center justify-center py-2 transition-all",style:{transform:`translateY(${Math.min(u,80)}px)`,opacity:Math.min(u/80,1)},children:[e.jsx(H,{size:20,className:`text-blue-500 ${P||u>80?"animate-spin":""}`,strokeWidth:2.5}),e.jsx("span",{className:"ml-2 text-[14px] text-blue-500 font-medium",children:u>80?"Release to refresh":"Pull to refresh"})]}),!v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-4 py-3 bg-gradient-to-br from-blue-50 to-indigo-50 border-y border-blue-100",children:[e.jsx("div",{className:"text-[13px] text-blue-600 mb-2 uppercase tracking-wide font-semibold",children:"TODAY'S SUMMARY"}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsxs("span",{className:"text-[28px] font-bold text-gray-900",children:["TSh ",N(a.todaySales)]}),e.jsxs("span",{className:`text-[15px] font-medium flex items-center gap-1 ${S.trend==="up"?"text-green-600":"text-red-600"}`,children:[S.trend==="up"?e.jsx(U,{size:14,strokeWidth:3}):e.jsx(V,{size:14,strokeWidth:3}),S.value]})]}),e.jsxs("div",{className:"text-[15px] text-gray-700 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:[a.todayOrders," orders"]}),a.lowStock>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Â·"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(A,{size:14,className:"text-orange-500"}),a.lowStock," items low stock"]})]})]})]}),e.jsx("div",{className:"px-4 py-3 border-b border-gray-200",children:e.jsx("div",{className:"flex gap-2",children:B.map((s,t)=>{const i=s.icon;return e.jsxs("button",{onClick:()=>j(s.path),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-[13px] font-medium shadow-sm",children:[e.jsx(i,{size:18,strokeWidth:2.5}),e.jsx("span",{children:s.label})]},t)})})}),e.jsxs("div",{className:"px-4 py-4 border-b border-gray-200",children:[e.jsx("div",{className:"text-[13px] text-gray-500 mb-3 uppercase tracking-wide font-semibold",children:"OVERVIEW"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",style:{display:"grid",gridTemplateColumns:"1fr 1fr"},children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl border border-purple-200 shadow-sm",children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center flex-shrink-0",children:e.jsx(J,{size:22,className:"text-purple-600",strokeWidth:2.5})}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"text-[11px] text-purple-700 uppercase font-semibold mb-0.5",children:"Revenue"}),e.jsxs("div",{className:"text-[18px] font-bold text-purple-900 truncate",children:["TSh ",N(a.totalRevenue)]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl border border-green-200 shadow-sm",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center flex-shrink-0",children:e.jsx(K,{size:22,className:"text-green-600",strokeWidth:2.5})}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"text-[11px] text-green-700 uppercase font-semibold mb-0.5",children:"Customers"}),e.jsx("div",{className:"text-[18px] font-bold text-green-900",children:a.totalCustomers})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200 shadow-sm",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0",children:e.jsx(G,{size:22,className:"text-blue-600",strokeWidth:2.5})}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"text-[11px] text-blue-700 uppercase font-semibold mb-0.5",children:"Products"}),e.jsx("div",{className:"text-[18px] font-bold text-blue-900",children:a.totalProducts})]})]}),e.jsxs("div",{className:`flex items-center gap-3 p-4 bg-gradient-to-br rounded-2xl border shadow-sm ${a.lowStock>0?"from-orange-50 to-orange-100 border-orange-200":"from-gray-50 to-gray-100 border-gray-200"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 ${a.lowStock>0?"bg-orange-100":"bg-gray-100"}`,children:e.jsx(A,{size:22,className:a.lowStock>0?"text-orange-600":"text-gray-600",strokeWidth:2.5})}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:`text-[11px] uppercase font-semibold mb-0.5 ${a.lowStock>0?"text-orange-700":"text-gray-700"}`,children:"Low Stock"}),e.jsx("div",{className:`text-[18px] font-bold ${a.lowStock>0?"text-orange-900":"text-gray-900"}`,children:a.lowStock})]})]})]})]}),e.jsxs("div",{className:"pb-4",children:[e.jsx("div",{className:"px-4 pt-4 pb-2",children:e.jsx("div",{className:"text-[13px] text-gray-500 uppercase tracking-wide font-semibold",children:"RECENT ACTIVITY"})}),y.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-b border-gray-200",children:y.map((s,t)=>{const i=s.icon,o=t===y.length-1;return e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between border-b border-gray-200 hover:bg-gray-50 active:bg-gray-100 transition-colors",style:{borderBottomWidth:o?"0":"0.5px"},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(i,{size:18,className:"text-blue-500",strokeWidth:2})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[16px] text-gray-900 truncate",children:s.title}),e.jsxs("div",{className:"text-[13px] text-gray-500 flex items-center gap-1",children:[e.jsx(X,{size:11}),s.time]})]})]}),e.jsx("div",{className:"text-[15px] font-semibold text-blue-500 flex-shrink-0 ml-2",children:s.amount})]},s.id)})}),e.jsxs("button",{onClick:()=>j("/mobile/analytics"),className:"w-full px-4 py-4 flex items-center justify-center gap-2 text-blue-500 hover:bg-gray-50 active:bg-gray-100 transition-colors",children:[e.jsx("span",{className:"text-[16px] font-medium",children:"View All Activity"}),e.jsx(Z,{size:18,strokeWidth:2})]})]}):e.jsxs("div",{className:"text-center py-16 px-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(f,{size:40,className:"text-gray-400",strokeWidth:1.5})}),e.jsx("p",{className:"text-gray-900 text-[17px] font-semibold mb-2",children:"No recent activity"}),e.jsx("p",{className:"text-[15px] text-gray-500 mb-6 max-w-sm mx-auto",children:"Start making sales to see recent activity here"}),e.jsxs("button",{onClick:()=>j("/mobile/pos"),className:"inline-flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm",children:[e.jsx(f,{size:20,strokeWidth:2.5}),"New Sale"]})]})]})]})]})})};export{ue as default};
