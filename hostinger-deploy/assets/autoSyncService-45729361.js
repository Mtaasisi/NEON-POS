import{fullDatabaseDownloadService as o}from"./fullDatabaseDownloadService-81aa0524.js";import{d as l}from"./index-61458a34.js";import"./supabase-cf010ec4.js";import"./customerCacheService-9b459c09.js";import"./childVariantsCacheService-9368f4c7.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";class y{constructor(){this.syncInterval=30*60*1e3,this.syncTimer=null,this.isSyncing=!1,this.lastSyncTime=null,this.lastSyncSuccess=!1,this.error=null,this.listeners=new Set,this.initialize()}initialize(){const t=localStorage.getItem("auto_sync_interval");t&&(this.syncInterval=parseInt(t,10)),window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),navigator.onLine&&this.startAutoSync(),console.log("ðŸ”§ [AutoSync] Service initialized",{syncInterval:this.syncInterval/1e3/60+" minutes",isOnline:navigator.onLine})}handleOnline(){console.log("ðŸŒ [AutoSync] Network online - starting auto sync"),this.startAutoSync(),this.syncNow()}handleOffline(){console.log("ðŸ“´ [AutoSync] Network offline - pausing auto sync"),this.stopAutoSync()}startAutoSync(){if(!this.syncTimer){if(!navigator.onLine){console.warn("âš ï¸ [AutoSync] Cannot start - offline");return}console.log(`ðŸ”„ [AutoSync] Starting automatic sync (every ${this.syncInterval/1e3/60} minutes)`),this.syncTimer=setInterval(()=>{this.syncNow()},this.syncInterval),setTimeout(()=>{this.syncNow()},5e3)}}stopAutoSync(){this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null,console.log("â¸ï¸ [AutoSync] Stopped automatic sync"))}async syncNow(){if(this.isSyncing)return console.log("â³ [AutoSync] Sync already in progress, skipping..."),{success:!1,error:"Sync already in progress"};if(!navigator.onLine)return console.warn("âš ï¸ [AutoSync] Cannot sync - offline"),this.error="Offline",this.notifyListeners(),{success:!1,error:"Offline"};if(!o.isDownloaded())return console.log("â„¹ï¸ [AutoSync] No database downloaded, skipping sync"),{success:!1,error:"No database downloaded"};this.isSyncing=!0,this.error=null,this.notifyListeners();const e=Date.now();console.log("ðŸ”„ [AutoSync] Starting background sync...");try{console.log("ðŸ“¦ [AutoSync] Syncing products...");const s=await o.downloadFullDatabase(i=>{}),n=Date.now()-e;if(s.success){this.lastSyncTime=Date.now(),this.lastSyncSuccess=!0,this.error=null;const i=l.getState();(i.products.length===0||s.data.products>0)&&(console.log("ðŸ”„ [AutoSync] Refreshing inventory store..."),await i.loadProducts({page:1,limit:200},!0));const r=Object.values(s.data).reduce((c,a)=>c+a,0);return console.log(`âœ… [AutoSync] Sync completed successfully in ${(n/1e3).toFixed(1)}s`,{totalItems:r,products:s.data.products,variants:s.data.variants,customers:s.data.customers}),this.notifyListeners(),{success:!0}}else throw new Error(s.error||"Sync failed")}catch(s){const n=s instanceof Error?s.message:"Unknown error";return this.error=n,this.lastSyncSuccess=!1,console.error("âŒ [AutoSync] Sync failed:",n),this.notifyListeners(),{success:!1,error:n}}finally{this.isSyncing=!1}}getStatus(){return{isSyncing:this.isSyncing,lastSyncTime:this.lastSyncTime,lastSyncSuccess:this.lastSyncSuccess,nextSyncTime:this.syncTimer?Date.now()+this.syncInterval:null,syncInterval:this.syncInterval,error:this.error}}setSyncInterval(t){this.syncInterval=t*60*1e3,localStorage.setItem("auto_sync_interval",this.syncInterval.toString()),this.stopAutoSync(),navigator.onLine&&this.startAutoSync(),console.log(`âš™ï¸ [AutoSync] Sync interval set to ${t} minutes`)}subscribe(t){return this.listeners.add(t),t(this.getStatus()),()=>{this.listeners.delete(t)}}notifyListeners(){const t=this.getStatus();this.listeners.forEach(e=>e(t))}isEnabled(){return this.syncTimer!==null}}const w=new y;export{w as autoSyncService};
