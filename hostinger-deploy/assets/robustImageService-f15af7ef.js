import{s as u}from"./index-61458a34.js";class f{static log(e,...t){}static throttledLog(e,t,s=1e3,...n){}static sessionLog(e,t,...s){}static initLog(e,t,...s){}static verboseLog(e,...t){this.isVerboseLogging&&console.log(e,...t)}static setVerboseLogging(e){this.isVerboseLogging=e,e?localStorage.setItem("verbose_logging","true"):localStorage.removeItem("verbose_logging")}static getLogCounts(){return{...this.logCounts}}static clearLogCounts(){this.logCounts={},this.lastLogTime={},this.sessionLogged={}}static debugWhatsAppService(){}static resetSessionLogging(){this.sessionLogged={},console.log("üîÑ Session logging reset")}}f.isVerboseLogging=!1;f.logCounts={};f.lastLogTime={};f.sessionLogged={};class p{static async uploadImage(e,t,s,n=!1){var o,l;try{const a=this.validateFile(e);if(!a.valid)return{success:!1,error:a.error};let r=null;try{const{data:{user:h},error:_}=await u.auth.getUser();if(h&&!_)r=h.id,console.log("‚úÖ Using Supabase user:",r);else{const y=localStorage.getItem("user");if(y){const b=JSON.parse(y);r=b.id&&b.id!=="system"?b.id:null,console.log("‚úÖ Using localStorage user:",r)}else console.log("‚úÖ Using null for system user (no auth)")}}catch{console.log("‚ö†Ô∏è Auth check failed, using null for system user")}if((await this.getProductImages(t)).length>=this.MAX_FILES_PER_PRODUCT)return{success:!1,error:`Maximum ${this.MAX_FILES_PER_PRODUCT} images allowed per product`};const m=this.generateFileName(e,t);let c,g;try{await this.checkBucketAccess();const h=await this.uploadToStorage(e,m);if(c=h.url,g=h.thumbnailUrl,!c||c.trim()===""||!g||g.trim()==="")throw console.log("‚ÑπÔ∏è Using base64 image storage (Neon Database mode)"),new Error("Storage returned empty URLs - falling back to base64");console.log("‚úÖ Uploaded to Supabase Storage:",{imageUrl:c==null?void 0:c.substring(0,100),thumbnailUrl:g==null?void 0:g.substring(0,100)})}catch{console.log("‚ÑπÔ∏è Using base64 storage for Neon Database"),c=await this.compressImage(e),g=await this.createThumbnail(e,200),console.log("‚úÖ Base64 images created:",{imageSize:Math.round((c==null?void 0:c.length)/1024)+"KB",thumbnailSize:Math.round((g==null?void 0:g.length)/1024)+"KB"})}if(!c||c.trim()==="")throw new Error("Image URL is empty - upload may have failed");(!g||g.trim()==="")&&(console.warn("‚ö†Ô∏è Thumbnail URL is empty, using main image URL"),g=c),console.log("üíæ Saving image record to database:",{productId:t,imageUrlPreview:c==null?void 0:c.substring(0,50),thumbnailUrlPreview:g==null?void 0:g.substring(0,50),fileName:e.name,fileSize:e.size,isPrimary:n});const d=await this.saveImageRecord({productId:t,imageUrl:c,thumbnailUrl:g,fileName:e.name,fileSize:e.size,isPrimary:n,userId:r,mimeType:e.type});return console.log("‚úÖ Image record saved:",{id:d.id,url:(o=d.url)==null?void 0:o.substring(0,50),thumbnailUrl:(l=d.thumbnailUrl)==null?void 0:l.substring(0,50)}),this.clearProductCache(t),{success:!0,image:d}}catch(a){return console.error("Upload failed:",a),{success:!1,error:a instanceof Error?a.message:"Upload failed"}}}static async getProductImages(e){var t;try{if(!e||typeof e!="string")return console.warn("Invalid productId provided to getProductImages:",e),[];if(e.startsWith("temp-product-")||e.startsWith("test-product-")||e.startsWith("temp-sparepart-")){const r=this.tempImageStorage.get(e)||[];return console.log("üìù Retrieved temporary images for product:",e,"count:",r.length),r}const s=`product_${e}`,n=this.imageCache.get(s);if(n&&Date.now()-n.timestamp<this.CACHE_DURATION)return f.throttledLog(`cached_images_${e}`,"üì¶ Using cached images for product:",3e3,e),n.data;let o=null,l=null;try{const r=await u.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1});o=r.data,l=r.error}catch{console.warn("product_images table not accessible, trying lats_products.images column");const i=await u.from("lats_products").select("images").eq("id",e).single();(t=i.data)!=null&&t.images&&Array.isArray(i.data.images)?(o=i.data.images.map((m,c)=>({id:`fallback-${c}`,image_url:m,thumbnail_url:m,file_name:`image-${c+1}`,file_size:0,is_primary:c===0,created_at:new Date().toISOString(),mime_type:"image/jpeg",width:null,height:null})),l=null):l=i.error}if(l)return console.error("Failed to get product images:",l),[];const a=o.map(r=>({id:r.id,url:r.image_url,thumbnailUrl:r.thumbnail_url,fileName:r.file_name,fileSize:r.file_size,isPrimary:r.is_primary,uploadedAt:r.created_at,mimeType:r.mime_type,width:r.width,height:r.height})).filter(r=>this.isValidImageUrl(r.url)||this.isValidImageUrl(r.thumbnailUrl));return console.log("‚úÖ Retrieved images from database:",{count:a.length,images:a.map(r=>{var i,m;return{id:r.id,url:(i=r.url)==null?void 0:i.substring(0,50),thumbnailUrl:(m=r.thumbnailUrl)==null?void 0:m.substring(0,50)}})}),this.imageCache.set(s,{data:a,timestamp:Date.now()}),a}catch(s){return console.error("Failed to get product images:",s),[]}}static async deleteImage(e,t){try{if(e.startsWith("temp-")){if(console.log("üìù Deleting temporary image:",e),t&&(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-"))){const i=(this.tempImageStorage.get(t)||[]).filter(m=>m.id!==e);this.tempImageStorage.set(t,i),console.log("üìù Removed temporary image from storage")}return{success:!0}}const{data:{user:s},error:n}=await neonClient.auth.getUser();if(n||!s)return console.error("‚ùå Authentication failed for delete:",n),{success:!1,error:"User not authenticated"};const{data:o,error:l}=await u.from("product_images").select("*").eq("id",e).single();if(l)return console.error("‚ùå Failed to fetch image for deletion:",l),{success:!1,error:"Image not found"};if(!o)return console.error("‚ùå Image not found:",e),{success:!1,error:"Image not found"};const{error:a}=await u.from("product_images").delete().eq("id",e);if(a)return console.error("‚ùå Failed to delete image from database:",a),{success:!1,error:"Failed to delete image from database"};if(o.image_url&&!o.image_url.startsWith("data:")&&!o.image_url.startsWith("blob:"))try{await this.deleteFromStorage(o.image_url),console.log("‚úÖ Deleted image from storage")}catch(r){console.warn("‚ö†Ô∏è Failed to delete from storage (non-critical):",r)}return this.clearProductCache(o.product_id),console.log("‚úÖ Image deleted successfully:",e),{success:!0}}catch(s){return console.error("‚ùå Delete failed:",s),{success:!1,error:s instanceof Error?s.message:"Delete failed"}}}static async setPrimaryImage(e,t){try{if(t.startsWith("temp-product-")||t.startsWith("test-product-")||e.startsWith("temp-"))return{success:!0};await u.from("product_images").update({is_primary:!1}).eq("product_id",t);const{error:s}=await u.from("product_images").update({is_primary:!0}).eq("id",e);if(s)throw s;return this.clearProductCache(t),{success:!0}}catch(s){return console.error("Set primary failed:",s),{success:!1,error:s instanceof Error?s.message:"Set primary failed"}}}static async getImageStats(){try{const{data:e,error:t}=await u.from("product_images").select("file_size, is_primary");if(t)throw t;const s=e.length,n=e.reduce((a,r)=>a+(r.file_size||0),0),o=s>0?n/s:0,l=e.filter(a=>a.is_primary).length;return{totalImages:s,totalSize:n,averageSize:o,primaryImages:l}}catch(e){return console.error("Failed to get image stats:",e),{totalImages:0,totalSize:0,averageSize:0,primaryImages:0}}}static async bulkUploadImages(e,t,s){const n=[],o=[],l=e.map(async(a,r)=>{try{const i=await this.uploadImage(a,t,s,r===0);i.success&&i.image?n.push(i.image):o.push(`${a.name}: ${i.error}`)}catch{o.push(`${a.name}: Upload failed`)}});return await Promise.all(l),{success:n.length>0,images:n,errors:o}}static validateFile(e){return e?this.ALLOWED_TYPES.includes(e.type)?e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size is ${this.MAX_FILE_SIZE/1024/1024}MB`}:{valid:!0}:{valid:!1,error:"Invalid file type. Only JPG, PNG, and WebP are allowed"}:{valid:!1,error:"No file provided"}}static isValidImageUrl(e){if(!e||typeof e!="string"||e.trim()==="")return!1;const t=e.trim();return t.startsWith("data:image/")||t.startsWith("blob:")?!0:t.startsWith("{")||t.startsWith("[")?(console.warn("‚ö†Ô∏è Filtering out JSON string as image URL:",t.substring(0,100)),!1):t.startsWith("/")&&!t.match(/\.(jpg|jpeg|png|webp|gif|svg)(\?.*)?$/i)?(console.warn("‚ö†Ô∏è Filtering out navigation path as image URL:",t),!1):t.startsWith("http://")||t.startsWith("https://")?!0:(console.warn("‚ö†Ô∏è Filtering out invalid image URL:",t.substring(0,100)),!1)}static generateFileName(e,t){var a;const s=Date.now(),n=crypto.randomUUID().replace(/-/g,"").substring(0,8),o=((a=e.name.split(".").pop())==null?void 0:a.toLowerCase())||"jpg";return`${t.replace(/[^a-zA-Z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}_${s}_${n}.${o}`}static async compressImage(e){return new Promise((t,s)=>{const n=document.createElement("canvas"),o=n.getContext("2d"),l=new Image;l.onload=()=>{let{width:r,height:i}=l;r>i&&r>1200?(i=i*1200/r,r=1200):i>1200&&(r=r*1200/i,i=1200),n.width=r,n.height=i,o==null||o.drawImage(l,0,0,r,i);const m=n.toDataURL("image/jpeg",.8);t(m)},l.onerror=s,l.src=URL.createObjectURL(e)})}static async createThumbnail(e,t){return new Promise((s,n)=>{const o=document.createElement("canvas"),l=o.getContext("2d"),a=new Image;a.onload=()=>{o.width=t,o.height=t;const r=a.width/a.height;let i=t,m=t;r>1?m=t/r:i=t*r;const c=(t-i)/2,g=(t-m)/2;l==null||l.drawImage(a,c,g,i,m);const d=o.toDataURL("image/jpeg",.7);s(d)},a.onerror=n,a.src=URL.createObjectURL(e)})}static async uploadToStorage(e,t){console.log("üîç Uploading to storage:",{fileName:t,fileSize:e.size,fileType:e.type,fileLastModified:e.lastModified});const{data:{user:s},error:n}=await u.auth.getUser();n||!s?console.warn("‚ö†Ô∏è No authentication, attempting upload with RLS policies"):console.log("‚úÖ User authenticated:",s.id);const{data:o,error:l}=await u.storage.from("product-images").upload(t,e);if(l)throw console.error("‚ùå Storage upload failed:",{error:l.message,statusCode:l.statusCode,fileName:t,fileSize:e.size,fileType:e.type}),l;console.log("‚úÖ Main image uploaded successfully:",o);const a=u.storage.from("product-images").getPublicUrl(t).data.publicUrl;console.log("üñºÔ∏è Creating and uploading thumbnail...");const r=await this.createThumbnail(e,200),i=await this.dataUrlToBlob(r),m=`thumb_${t}`;console.log("üîç Uploading thumbnail:",{thumbnailFileName:m,thumbnailBlobSize:i.size,thumbnailBlobType:i.type});const{data:c,error:g}=await u.storage.from("product-images").upload(m,i);g?(console.error("‚ùå Thumbnail upload failed:",{error:g.message,statusCode:g.statusCode,thumbnailFileName:m,thumbnailBlobSize:i.size}),console.warn("‚ö†Ô∏è Continuing without thumbnail")):console.log("‚úÖ Thumbnail uploaded successfully:",c);const d=u.storage.from("product-images").getPublicUrl(m).data.publicUrl;return{url:a,thumbnailUrl:d}}static async dataUrlToBlob(e){return(await fetch(e)).blob()}static async checkBucketAccess(){try{console.log("üîç Checking bucket access...");const{data:e,error:t}=await u.storage.from("product-images").list("",{limit:1});if(t)throw console.error("‚ùå Bucket access check failed:",{error:t.message,statusCode:t.statusCode}),t.message.includes("not found")||t.statusCode===404?new Error("product-images bucket does not exist. Please create it in Supabase dashboard."):t.message.includes("permission")||t.statusCode===403?new Error("Permission denied. User may not have access to product-images bucket."):new Error(`Bucket access failed: ${t.message}`);console.log("‚úÖ Bucket access confirmed")}catch(e){throw console.error("‚ùå Bucket check failed:",e),e}}static async saveImageRecord(e){var o,l,a;if(e.productId.startsWith("temp-product-")||e.productId.startsWith("test-product-")||e.productId.startsWith("temp-sparepart-")){console.log("üìù Creating temporary image record for product:",e.productId);const r={id:`temp-${Date.now()}-${crypto.randomUUID().replace(/-/g,"").substring(0,8)}`,url:e.imageUrl,thumbnailUrl:e.thumbnailUrl&&e.thumbnailUrl!==e.imageUrl?e.thumbnailUrl:e.imageUrl,fileName:e.fileName,fileSize:e.fileSize,isPrimary:e.isPrimary,uploadedAt:new Date().toISOString(),mimeType:e.mimeType},i=this.tempImageStorage.get(e.productId)||[];return this.tempImageStorage.set(e.productId,[...i,r]),r}const{data:t}=await u.from("product_images").select("id, image_url").eq("product_id",e.productId).eq("image_url",e.imageUrl).single();if(t){console.log("‚ö†Ô∏è Image record already exists, returning existing record");const{data:r}=await u.from("product_images").select("*").eq("id",t.id).single();return{id:r.id,url:r.image_url,thumbnailUrl:r.thumbnail_url,fileName:r.file_name,fileSize:r.file_size,isPrimary:r.is_primary,uploadedAt:r.created_at,mimeType:r.mime_type}}console.log("üìù Inserting into database:",{product_id:e.productId,image_url_preview:(o=e.imageUrl)==null?void 0:o.substring(0,50),thumbnail_url_preview:(l=e.thumbnailUrl)==null?void 0:l.substring(0,50),file_name:e.fileName,uploaded_by:e.userId});const{data:s,error:n}=await u.from("product_images").insert({product_id:e.productId,image_url:e.imageUrl,thumbnail_url:e.thumbnailUrl,file_name:e.fileName,file_size:e.fileSize,is_primary:e.isPrimary,uploaded_by:e.userId,mime_type:e.mimeType}).select().single();if(console.log("üìä Database insert result:",{success:!n,hasData:!!s,id:s==null?void 0:s.id,image_url_from_db:(a=s==null?void 0:s.image_url)==null?void 0:a.substring(0,50)}),n)throw console.error("‚ùå Database insert error:",n),n;if(!s)throw console.error("‚ùå Database insert returned null data"),new Error("Failed to save image record: No data returned from database");return{id:s.id,url:s.image_url,thumbnailUrl:s.thumbnail_url,fileName:s.file_name,fileSize:s.file_size,isPrimary:s.is_primary,uploadedAt:s.created_at,mimeType:s.mime_type}}static async deleteFromStorage(e){try{const t=e.split("/").pop();t&&await u.storage.from("product-images").remove([t,`thumb_${t}`])}catch(t){console.warn("Failed to delete from storage:",t)}}static clearProductCache(e){const t=`product_${e}`;this.imageCache.delete(t)}static clearAllCache(){this.imageCache.clear()}static getCacheStats(){return{size:this.imageCache.size,entries:this.imageCache.size}}}p.MAX_FILE_SIZE=5*1024*1024;p.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp"];p.MAX_FILES_PER_PRODUCT=5;p.CACHE_DURATION=5*60*1e3;p.imageCache=new Map;p.tempImageStorage=new Map;export{p as R};
