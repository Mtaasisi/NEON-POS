import{s as c}from"./index-61458a34.js";import{g as k}from"./inventorySettingsApi-fd100cf3.js";import{smartNotificationService as w}from"./smartNotificationService-2a2d3be1.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";import"./whatsappService-09f99080.js";import"./notificationSettingsService-1df2b297.js";import"./format-aff4c6a2.js";import"./formatPhoneForInvoice-e7084c6d.js";class _{constructor(){this.lastNotificationTime=new Map,this.NOTIFICATION_COOLDOWN=60*60*1e3}async checkLowStock(e){try{const{data:t,error:i}=await c.from("lats_product_variants").select(`
          id,
          product_id,
          quantity,
          min_quantity,
          name,
          products:product_id (
            id,
            name
          )
        `).eq("id",e).single();if(i||!t)return null;const o=Number(t.quantity)||0,n=Number(t.min_quantity)||0,r=t.products||{};return o===0?{productId:t.product_id,variantId:t.id,productName:r.name||"Unknown Product",variantName:t.name,currentStock:o,minStock:n,alertLevel:"out-of-stock"}:n>0&&o<=n*.25?{productId:t.product_id,variantId:t.id,productName:r.name||"Unknown Product",variantName:t.name,currentStock:o,minStock:n,alertLevel:"critical"}:n>0&&o<=n?{productId:t.product_id,variantId:t.id,productName:r.name||"Unknown Product",variantName:t.name,currentStock:o,minStock:n,alertLevel:"low"}:null}catch(t){return console.error("Error checking low stock:",t),null}}async getNotificationRecipients(){try{const{data:e}=await c.from("admin_settings").select("setting_value").eq("category","whatsapp_automation").eq("setting_key","notification_phones").single();if(e!=null&&e.setting_value)try{const n=JSON.parse(e.setting_value);if(Array.isArray(n)&&n.length>0)return n.map(r=>({phone:r}))}catch(n){console.warn("Error parsing automation phone numbers:",n)}const{data:t}=await c.from("admin_settings").select("setting_value").eq("category","inventory").eq("setting_key","low_stock_notification_phones").single();if(t!=null&&t.setting_value)try{const n=JSON.parse(t.setting_value);if(Array.isArray(n)&&n.length>0)return n.map(r=>typeof r=="string"?{phone:r}:{phone:r.phone,name:r.name})}catch(n){console.warn("Error parsing inventory phone numbers:",n)}const{data:i}=await c.from("business_info").select("phone, whatsapp").single(),o=[];if(i!=null&&i.phone&&o.push({phone:i.phone,name:"Business"}),i!=null&&i.whatsapp&&i.whatsapp!==i.phone&&o.push({phone:i.whatsapp,name:"Business WhatsApp"}),o.length===0){const{data:n}=await c.from("users").select("phone").eq("role","admin").limit(3);n&&n.forEach(r=>{r.phone&&o.push({phone:r.phone,name:"Admin"})})}return o}catch(e){return console.error("Error getting notification recipients:",e),[]}}formatMessage(e){const t=e.variantName?` (${e.variantName})`:"";let o=`${e.alertLevel==="out-of-stock"?"ðŸ”´":e.alertLevel==="critical"?"ðŸŸ ":"ðŸŸ¡"} *Low Stock Alert*

`;return o+=`*Product:* ${e.productName}${t}
`,o+=`*Current Stock:* ${e.currentStock}
`,o+=`*Minimum Stock:* ${e.minStock}
`,e.alertLevel==="out-of-stock"?o+=`
âš ï¸ *OUT OF STOCK* - Immediate restocking required!`:e.alertLevel==="critical"?o+=`
âš ï¸ *CRITICAL* - Stock is very low!`:o+=`
âš ï¸ *LOW STOCK* - Consider restocking soon.`,o}shouldSendNotification(e){const t=this.lastNotificationTime.get(e);return t?Date.now()-t>=this.NOTIFICATION_COOLDOWN:!0}async sendLowStockNotification(e){try{const{data:t}=await c.from("admin_settings").select("setting_key, setting_value").eq("category","whatsapp_automation").in("setting_key",["inventory_low_stock_notifications","inventory_out_of_stock_notifications"]),i=new Map((t||[]).map(s=>[s.setting_key,s.setting_value==="true"])),o=i.get("inventory_low_stock_notifications")??!1,n=i.get("inventory_out_of_stock_notifications")??!1,r=await k();if(!(i.size>0?o||n:r.whatsapp_notifications))return console.log("ðŸ“± WhatsApp notifications disabled"),{success:!1,error:"WhatsApp notifications disabled"};if(!this.shouldSendNotification(e))return console.log(`ðŸ“± Notification cooldown active for variant ${e}`),{success:!1,error:"Cooldown active"};const a=await this.checkLowStock(e);if(!a)return{success:!1,error:"Item not low on stock"};const p=i.size>0,m=p?n:r.out_of_stock_alerts,h=p?o:r.low_stock_alerts;if(a.alertLevel==="out-of-stock"&&!m)return{success:!1,error:"Out of stock alerts disabled"};if((a.alertLevel==="low"||a.alertLevel==="critical")&&!h)return{success:!1,error:"Low stock alerts disabled"};const d=await this.getNotificationRecipients();if(d.length===0)return console.warn("âš ï¸ No notification recipients found"),{success:!1,error:"No recipients configured"};const g=this.formatMessage(a);let u=0;const f=[];for(const s of d)try{const l=await w.sendNotification(s.phone,g,{priority:a.alertLevel==="out-of-stock"?"high":"normal"});l.success?(u++,console.log(`âœ… Low stock notification sent to ${s.phone} via ${l.method}`)):f.push(`${s.phone}: ${l.error}`)}catch(l){f.push(`${s.phone}: ${l.message}`)}return u>0&&this.lastNotificationTime.set(e,Date.now()),u===0?{success:!1,error:`Failed to send to all recipients: ${f.join(", ")}`}:{success:!0,sent:u}}catch(t){return console.error("Error sending low stock notification:",t),{success:!1,error:t.message}}}async checkAndNotifyLowStock(e){const t={checked:e.length,notified:0,errors:[]};for(const i of e)try{const o=await this.sendLowStockNotification(i);o.success&&o.sent?t.notified++:o.error&&t.errors.push(`Variant ${i}: ${o.error}`)}catch(o){t.errors.push(`Variant ${i}: ${o.message}`)}return t}clearCooldown(e){this.lastNotificationTime.delete(e)}}const E=new _;export{E as inventoryNotificationService};
