import{s as k,j as e,e as S,G as g}from"./index-61458a34.js";import{r as o}from"./vendor-36d2c7c1.js";import{z as p,R as h,a8 as V,S as D,o as F,aE as K,M as Y,aj as u,l as b,aQ as C,I as $,G as H,A as z,d as X,f as J}from"./ui-28e30067.js";import{G as Z}from"./GlassTabs-05c8a392.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./utils-95f4031a.js";import"./charts-d592fbd1.js";const ce=()=>{var _,E;const[R,I]=o.useState(!0),[T,A]=o.useState(!1),[m,M]=o.useState(null),[i,G]=o.useState({}),[f,W]=o.useState("sms"),[s,l]=o.useState({sms:{enabled:!1,provider:"mshastra",apiKey:"",senderId:"LATS POS",webhookUrl:""},whatsapp:{enabled:!1,provider:"greenapi",instanceId:"",apiToken:"",apiUrl:"https://7105.api.greenapi.com",webhookUrl:""},mpesa:{enabled:!1,businessShortcode:"",consumerKey:"",consumerSecret:"",passkey:"",callbackUrl:"",environment:"sandbox"},tigopesa:{enabled:!1,merchantCode:"",merchantPin:"",apiUrl:"https://api.tigo.co.tz",callbackUrl:""},airtelmoney:{enabled:!1,merchantCode:"",apiKey:"",apiUrl:"https://api.airtel.co.tz",callbackUrl:""},email:{enabled:!1,provider:"smtp",host:"",port:587,username:"",password:"",fromEmail:"",fromName:"LATS CHANCE"}}),[d,j]=o.useState({});o.useEffect(()=>{P()},[]);const P=async()=>{I(!0);try{const{data:a,error:t}=await k.from("integration_settings").select("*");if(t)throw t;if(a&&a.length>0){const r={...s};a.forEach(n=>{const y=n.integration_type,c=n.config||{};switch(y){case"sms":r.sms={enabled:n.is_enabled,provider:n.provider||"mshastra",...c};break;case"whatsapp":r.whatsapp={enabled:n.is_enabled,provider:n.provider||"greenapi",...c};break;case"mpesa":r.mpesa={enabled:n.is_enabled,...c};break;case"tigopesa":r.tigopesa={enabled:n.is_enabled,...c};break;case"airtelmoney":r.airtelmoney={enabled:n.is_enabled,...c};break;case"email":r.email={enabled:n.is_enabled,provider:n.provider||"smtp",...c};break}j(N=>({...N,[y]:{status:n.status==="active"?"connected":"disconnected",message:n.last_test_result,lastChecked:n.last_test_date?new Date(n.last_test_date):void 0}}))}),l(r)}}catch(a){console.error("Error loading integration settings:",a),p.error("Failed to load integration settings")}finally{I(!1)}},L=async()=>{A(!0);try{const a=[{type:"sms",data:s.sms,provider:s.sms.provider},{type:"whatsapp",data:s.whatsapp,provider:s.whatsapp.provider},{type:"mpesa",data:s.mpesa,provider:"vodacom"},{type:"tigopesa",data:s.tigopesa,provider:"tigo"},{type:"airtelmoney",data:s.airtelmoney,provider:"airtel"},{type:"email",data:s.email,provider:s.email.provider}];for(const t of a){const{type:r,data:n,provider:y}=t,{enabled:c,...N}=n,{error:U}=await k.from("integration_settings").upsert({integration_type:r,is_enabled:c,provider:y,config:N,status:c?"active":"inactive",updated_at:new Date().toISOString()},{onConflict:"integration_type"});if(U)throw U}p.success("Integration settings saved successfully!")}catch(a){console.error("Error saving integration settings:",a),p.error("Failed to save integration settings")}finally{A(!1)}},v=async a=>{M(a);try{let t={success:!1,message:""};switch(a){case"sms":t=await O();break;case"whatsapp":t=await q();break;case"mpesa":t=await B();break;case"email":t=await Q();break}j(r=>({...r,[a]:{status:t.success?"connected":"error",message:t.message,lastChecked:new Date}})),await k.from("integration_settings").update({status:t.success?"active":"error",last_test_date:new Date().toISOString(),last_test_result:t.message}).eq("integration_type",a),t.success?p.success(`${a.toUpperCase()} connection successful!`):p.error(`${a.toUpperCase()} connection failed: ${t.message}`)}catch(t){p.error(`Test failed: ${t.message}`),j(r=>({...r,[a]:{status:"error",message:t.message,lastChecked:new Date}}))}finally{M(null)}},O=async()=>s.sms.apiKey?{success:!0,message:"SMS credentials verified. Ready to send messages."}:{success:!1,message:"API key is required"},q=async()=>{if(!s.whatsapp.instanceId||!s.whatsapp.apiToken)return{success:!1,message:"Instance ID and API token are required"};try{const a=`${s.whatsapp.apiUrl}/waInstance${s.whatsapp.instanceId}/getStateInstance/${s.whatsapp.apiToken}`,r=await(await fetch(a)).json();return r.stateInstance==="authorized"?{success:!0,message:`Connected to WhatsApp. Phone: ${r.phoneNumber||"N/A"}`}:{success:!1,message:`Status: ${r.stateInstance}. Scan QR code to authorize.`}}catch(a){return{success:!1,message:a.message}}},B=async()=>!s.mpesa.consumerKey||!s.mpesa.consumerSecret?{success:!1,message:"Consumer key and secret are required"}:{success:!0,message:"M-Pesa credentials verified. Ready to accept payments."},Q=async()=>{if(s.email.provider==="smtp"){if(!s.email.host||!s.email.username||!s.email.password)return{success:!1,message:"SMTP credentials incomplete"}}else if(!s.email.apiKey)return{success:!1,message:"API key is required"};return{success:!0,message:"Email configuration valid. Ready to send emails."}},x=a=>{G(t=>({...t,[a]:!t[a]}))},w=a=>{const t=d[a];return t?{connected:e.jsxs("span",{className:"flex items-center gap-2 text-sm text-green-600",children:[e.jsx(X,{className:"w-4 h-4"}),"Connected"]}),disconnected:e.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(J,{className:"w-4 h-4"}),"Disconnected"]}),error:e.jsxs("span",{className:"flex items-center gap-2 text-sm text-red-600",children:[e.jsx(z,{className:"w-4 h-4"}),"Error"]}),unknown:e.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx($,{className:"w-4 h-4"}),"Unknown"]})}[t.status]:e.jsxs("span",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(z,{className:"w-4 h-4"}),"Not Configured"]})};return R?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(h,{className:"w-8 h-8 animate-spin text-blue-600"})}):e.jsxs("div",{className:"max-w-6xl mx-auto p-6 space-y-6",children:[e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 p-8",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg flex-shrink-0",children:e.jsx(V,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:"Integration Settings"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure SMS, WhatsApp, Mobile Money, and Email integrations"})]})]})}),e.jsx(Z,{tabs:[{id:"sms",label:"SMS",icon:e.jsx(D,{className:"w-5 h-5"}),badge:s.sms.enabled?"✓":void 0},{id:"whatsapp",label:"WhatsApp",icon:e.jsx(F,{className:"w-5 h-5"}),badge:s.whatsapp.enabled?"✓":void 0},{id:"mobile-money",label:"Mobile Money",icon:e.jsx(K,{className:"w-5 h-5"}),badge:s.mpesa.enabled||s.tigopesa.enabled||s.airtelmoney.enabled?"✓":void 0},{id:"email",label:"Email",icon:e.jsx(Y,{className:"w-5 h-5"}),badge:s.email.enabled?"✓":void 0}],activeTab:f,onTabChange:a=>W(a),variant:"modern",size:"md"}),f==="sms"&&e.jsxs(S,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[e.jsx(D,{className:"w-6 h-6 text-blue-600"}),"SMS Integration"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Configure SMS provider for sending receipts and notifications"})]}),w("sms")]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"sms-enabled",checked:s.sms.enabled,onChange:a=>l({...s,sms:{...s.sms,enabled:a.target.checked}}),className:"w-5 h-5 text-blue-600 rounded"}),e.jsx("label",{htmlFor:"sms-enabled",className:"font-medium",children:"Enable SMS Integration"})]}),s.sms.enabled&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SMS Provider"}),e.jsxs("select",{value:s.sms.provider,onChange:a=>l({...s,sms:{...s.sms,provider:a.target.value}}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"mshastra",children:"MShastra (Tanzania)"}),e.jsx("option",{value:"africastalking",children:"Africa's Talking"}),e.jsx("option",{value:"twilio",children:"Twilio"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"API Key *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i["sms-api-key"]?"text":"password",value:s.sms.apiKey,onChange:a=>l({...s,sms:{...s.sms,apiKey:a.target.value}}),placeholder:"Enter your SMS API key",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",onClick:()=>x("sms-api-key"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700",children:i["sms-api-key"]?e.jsx(u,{className:"w-5 h-5"}):e.jsx(b,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sender ID"}),e.jsx("input",{type:"text",value:s.sms.senderId,onChange:a=>l({...s,sms:{...s.sms,senderId:a.target.value}}),placeholder:"e.g., LATS POS",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsx(g,{onClick:()=>v("sms"),disabled:m==="sms",className:"w-full",children:m==="sms"?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"w-5 h-5"}),"Test SMS Connection"]})}),((_=d.sms)==null?void 0:_.message)&&e.jsx("div",{className:`p-3 rounded-lg text-sm ${d.sms.status==="connected"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:d.sms.message})]})]}),f==="whatsapp"&&e.jsxs(S,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[e.jsx(F,{className:"w-6 h-6 text-green-600"}),"WhatsApp Integration"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Send receipts and messages via WhatsApp"})]}),w("whatsapp")]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"whatsapp-enabled",checked:s.whatsapp.enabled,onChange:a=>l({...s,whatsapp:{...s.whatsapp,enabled:a.target.checked}}),className:"w-5 h-5 text-green-600 rounded"}),e.jsx("label",{htmlFor:"whatsapp-enabled",className:"font-medium",children:"Enable WhatsApp Integration"})]}),s.whatsapp.enabled&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Instance ID *"}),e.jsx("input",{type:"text",value:s.whatsapp.instanceId,onChange:a=>l({...s,whatsapp:{...s.whatsapp,instanceId:a.target.value}}),placeholder:"Your Green API Instance ID",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"API Token *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i["whatsapp-token"]?"text":"password",value:s.whatsapp.apiToken,onChange:a=>l({...s,whatsapp:{...s.whatsapp,apiToken:a.target.value}}),placeholder:"Your Green API Token",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"}),e.jsx("button",{type:"button",onClick:()=>x("whatsapp-token"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700",children:i["whatsapp-token"]?e.jsx(u,{className:"w-5 h-5"}):e.jsx(b,{className:"w-5 h-5"})})]})]}),e.jsx(g,{onClick:()=>v("whatsapp"),disabled:m==="whatsapp",className:"w-full bg-green-600 hover:bg-green-700",children:m==="whatsapp"?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"w-5 h-5"}),"Test WhatsApp Connection"]})}),((E=d.whatsapp)==null?void 0:E.message)&&e.jsx("div",{className:`p-3 rounded-lg text-sm ${d.whatsapp.status==="connected"?"bg-green-50 text-green-800":"bg-yellow-50 text-yellow-800"}`,children:d.whatsapp.message})]})]}),f==="mobile-money"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(S,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center gap-3",children:[e.jsx(K,{className:"w-6 h-6 text-red-600"}),"M-Pesa Integration"]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Accept M-Pesa payments from customers"})]}),w("mpesa")]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"mpesa-enabled",checked:s.mpesa.enabled,onChange:a=>l({...s,mpesa:{...s.mpesa,enabled:a.target.checked}}),className:"w-5 h-5 text-red-600 rounded"}),e.jsx("label",{htmlFor:"mpesa-enabled",className:"font-medium",children:"Enable M-Pesa Payments"})]}),s.mpesa.enabled&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Environment"}),e.jsxs("select",{value:s.mpesa.environment,onChange:a=>l({...s,mpesa:{...s.mpesa,environment:a.target.value}}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500",children:[e.jsx("option",{value:"sandbox",children:"Sandbox (Testing)"}),e.jsx("option",{value:"production",children:"Production (Live)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Business Shortcode *"}),e.jsx("input",{type:"text",value:s.mpesa.businessShortcode,onChange:a=>l({...s,mpesa:{...s.mpesa,businessShortcode:a.target.value}}),placeholder:"e.g., 174379",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Consumer Key *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i["mpesa-key"]?"text":"password",value:s.mpesa.consumerKey,onChange:a=>l({...s,mpesa:{...s.mpesa,consumerKey:a.target.value}}),placeholder:"Consumer Key from Daraja",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),e.jsx("button",{type:"button",onClick:()=>x("mpesa-key"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:i["mpesa-key"]?e.jsx(u,{className:"w-5 h-5"}):e.jsx(b,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Consumer Secret *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i["mpesa-secret"]?"text":"password",value:s.mpesa.consumerSecret,onChange:a=>l({...s,mpesa:{...s.mpesa,consumerSecret:a.target.value}}),placeholder:"Consumer Secret from Daraja",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),e.jsx("button",{type:"button",onClick:()=>x("mpesa-secret"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:i["mpesa-secret"]?e.jsx(u,{className:"w-5 h-5"}):e.jsx(b,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Passkey *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i["mpesa-passkey"]?"text":"password",value:s.mpesa.passkey,onChange:a=>l({...s,mpesa:{...s.mpesa,passkey:a.target.value}}),placeholder:"Lipa Na M-Pesa Online Passkey",className:"w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"}),e.jsx("button",{type:"button",onClick:()=>x("mpesa-passkey"),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500",children:i["mpesa-passkey"]?e.jsx(u,{className:"w-5 h-5"}):e.jsx(b,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Callback URL"}),e.jsx("input",{type:"url",value:s.mpesa.callbackUrl,onChange:a=>l({...s,mpesa:{...s.mpesa,callbackUrl:a.target.value}}),placeholder:"https://yourdomain.com/api/mpesa/callback",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"})]}),e.jsx(g,{onClick:()=>v("mpesa"),disabled:m==="mpesa",className:"w-full bg-red-600 hover:bg-red-700",children:m==="mpesa"?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-5 h-5 animate-spin"}),"Testing Connection..."]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"w-5 h-5"}),"Test M-Pesa Connection"]})})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx($,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-900",children:[e.jsx("p",{className:"font-medium mb-1",children:"Need M-Pesa Credentials?"}),e.jsxs("p",{children:["Visit ",e.jsx("a",{href:"https://developer.mpesa.vm.co.tz",target:"_blank",rel:"noopener noreferrer",className:"underline",children:"developer.mpesa.vm.co.tz"})," to register your business and get API credentials."]})]})]})})]}),e.jsxs("div",{className:"flex gap-4 justify-end sticky bottom-4",children:[e.jsxs(g,{onClick:P,variant:"secondary",children:[e.jsx(h,{className:"w-5 h-5"}),"Reset Changes"]}),e.jsx(g,{onClick:L,disabled:T,className:"bg-blue-600 hover:bg-blue-700 text-white",children:T?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"w-5 h-5 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-5 h-5"}),"Save All Settings"]})})]})]})};export{ce as default};
