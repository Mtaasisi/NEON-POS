import{s as i,aj as h}from"./index-61458a34.js";import{customerCacheService as C}from"./customerCacheService-9b459c09.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";class l{constructor(){this.productCache=new Map,this.variantCache=new Map,this.customerCache=new Map,this.stockCache=new Map,this.CACHE_DURATION=5*60*1e3,this.STOCK_CACHE_DURATION=30*1e3,this.pendingStockChecks=new Map,this.pendingProductFetches=new Map}async checkStockFast(t){const s=this.stockCache.get(t);if(s&&Date.now()<s.expiresAt)return s.data;if(this.pendingStockChecks.has(t)){const e=await this.pendingStockChecks.get(t);return(e==null?void 0:e.quantity)||0}const a=(async()=>{try{const{data:e,error:r}=await i.from("lats_product_variants").select("quantity").eq("id",t).single();if(r||!e)return 0;const c=e.quantity||0;return this.stockCache.set(t,{data:c,timestamp:Date.now(),expiresAt:Date.now()+this.STOCK_CACHE_DURATION}),c}catch(e){return console.error("Stock check error:",e),0}finally{this.pendingStockChecks.delete(t)}})();return this.pendingStockChecks.set(t,a),await a}async getProductFast(t){const s=this.productCache.get(t);if(s&&Date.now()<s.expiresAt)return s.data;if(this.pendingProductFetches.has(t))return await this.pendingProductFetches.get(t);const a=(async()=>{try{const r=h.getProducts().find(n=>n.id===t);if(r)return this.productCache.set(t,{data:r,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),r;const{data:c,error:o}=await i.from("lats_products").select("*").eq("id",t).single();return o||!c?null:(this.productCache.set(t,{data:c,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),c)}catch(e){return console.error("Product fetch error:",e),null}finally{this.pendingProductFetches.delete(t)}})();return this.pendingProductFetches.set(t,a),await a}async getVariantFast(t){const s=this.variantCache.get(t);if(s&&Date.now()<s.expiresAt)return s.data;try{const{data:a,error:e}=await i.from("lats_product_variants").select("*").eq("id",t).single();return e||!a?null:(this.variantCache.set(t,{data:a,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),a)}catch(a){return console.error("Variant fetch error:",a),null}}async getCustomerFast(t){const s=this.customerCache.get(t);if(s&&Date.now()<s.expiresAt)return s.data;try{const e=C.getCustomers().find(o=>o.id===t);if(e)return this.customerCache.set(t,{data:e,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),e;const{data:r,error:c}=await i.from("customers").select("*").eq("id",t).single();return c||!r?null:(this.customerCache.set(t,{data:r,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),r)}catch(a){return console.error("Customer fetch error:",a),null}}async batchCheckStock(t){const s=new Map,a=[];for(const e of t){const r=this.stockCache.get(e);r&&Date.now()<r.expiresAt?s.set(e,r.data):a.push(e)}if(a.length>0)try{const{data:e,error:r}=await i.from("lats_product_variants").select("id, quantity").in("id",a);if(!r&&e)for(const c of e){const o=c.quantity||0;s.set(c.id,o),this.stockCache.set(c.id,{data:o,timestamp:Date.now(),expiresAt:Date.now()+this.STOCK_CACHE_DURATION})}}catch(e){console.error("Batch stock check error:",e)}return s}invalidateVariantCache(t){this.variantCache.delete(t),this.stockCache.delete(t)}invalidateStockCache(t){for(const s of t)this.stockCache.delete(s),this.variantCache.delete(s)}invalidateProductCache(t){this.productCache.delete(t)}invalidateCustomerCache(t){this.customerCache.delete(t)}clearAllCaches(){this.productCache.clear(),this.variantCache.clear(),this.customerCache.clear(),this.stockCache.clear(),this.pendingStockChecks.clear(),this.pendingProductFetches.clear()}async preloadWorkflowData(t,s){const a=[];t&&t.length>0&&a.push(i.from("lats_products").select("*").in("id",t).then(({data:e,error:r})=>{!r&&e&&e.forEach(c=>{this.productCache.set(c.id,{data:c,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION})})})),s&&s.length>0&&a.push(i.from("lats_product_variants").select("*").in("id",s).then(({data:e,error:r})=>{!r&&e&&e.forEach(c=>{this.variantCache.set(c.id,{data:c,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION}),this.stockCache.set(c.id,{data:c.quantity||0,timestamp:Date.now(),expiresAt:Date.now()+this.STOCK_CACHE_DURATION})})})),await Promise.allSettled(a)}getCacheStats(){return{products:this.productCache.size,variants:this.variantCache.size,customers:this.customerCache.size,stock:this.stockCache.size,pendingRequests:this.pendingStockChecks.size+this.pendingProductFetches.size}}}const k=new l;export{k as workflowOptimizationService};
