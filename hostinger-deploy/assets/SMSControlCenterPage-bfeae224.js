import{_ as W}from"./supabase-cf010ec4.js";import{a as q,s as z,j as e}from"./index-61458a34.js";import{r}from"./vendor-36d2c7c1.js";import{n as m,p as F,X as Y,v as Z,a9 as J,ax as X,P as K,$ as Q}from"./ui-28e30067.js";import"./routing-eb8c310c.js";const ee=o=>{const c=o.length,p=/[^\x00-\x7F]/.test(o),b=p?70:160,j=Math.ceil(c/b);return{charCount:c,smsUnits:j,charsPerSMS:b,encoding:p?"Unicode":"GSM-7"}},D=o=>{const c=typeof o=="string"?parseFloat(o):o;return c%1===0?c.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):c.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},se=({isOpen:o,onClose:c})=>{const{startLoading:p,completeLoading:b,failLoading:j}=q(),[u,I]=r.useState([]),[n,x]=r.useState(new Set),[V,k]=r.useState(!0),[_,M]=r.useState(!1),[g,N]=r.useState(""),[v,U]=r.useState(""),[a,w]=r.useState({loyaltyLevel:"all",colorTag:"all",city:"all",minSpent:"",maxSpent:"",minPoints:"",activeOnly:!0,hasDevices:"all",lastVisit:"all"}),[P]=r.useState(()=>{const s=localStorage.getItem("sms_price_per_unit");return s?parseFloat(s):50}),[S,$]=r.useState(!1),[C,T]=r.useState(!1),A={"win-back":{title:"Win-Back",message:"Hi [Name], we noticed it's been a while since your last visit! We'd love to see you again. Get 20% off your next repair. Reply VISIT to book."},"vip-exclusive":{title:"VIP Offer",message:"Dear [Name], as one of our valued VIP customers, you're invited to an exclusive 30% off on all services this month. Thank you for your continued trust!"},"loyalty-reward":{title:"Loyalty Points",message:"Hi [Name]! You have [Points] loyalty points ready to use. That's [Amount] TZS in savings! Visit us today to redeem them."},"high-spender":{title:"Thank You",message:"Thank you for being one of our top customers, [Name]! As appreciation, enjoy free diagnostics on your next device. We value your business!"}};r.useEffect(()=>(o?(document.body.style.overflow="hidden",B()):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[o]);const B=async()=>{const s=p("Loading customers...");try{k(!0);const{data:t,error:i}=await z.from("customers").select("id, name, phone, email, city, total_spent, loyalty_level, color_tag, last_visit, is_active, points").order("name");if(i)throw i;I(t||[]),b(s)}catch(t){console.error("Error fetching customers:",t),j(s,"Failed to load customers"),m.error("Failed to load customers")}finally{k(!1)}},E=r.useMemo(()=>Array.from(new Set(u.map(s=>s.city).filter(Boolean))),[u]),d=r.useMemo(()=>u.filter(t=>{var i;if(v){const l=v.toLowerCase();if(!t.name.toLowerCase().includes(l)&&!t.phone.toLowerCase().includes(l)&&!((i=t.email)!=null&&i.toLowerCase().includes(l)))return!1}if(a.loyaltyLevel!=="all"&&t.loyalty_level!==a.loyaltyLevel||a.colorTag!=="all"&&t.color_tag!==a.colorTag||a.city!=="all"&&t.city!==a.city||a.minSpent&&(t.total_spent||0)<parseFloat(a.minSpent)||a.maxSpent&&(t.total_spent||0)>parseFloat(a.maxSpent)||a.minPoints&&(t.points||0)<parseFloat(a.minPoints)||a.activeOnly&&!t.is_active)return!1;if(a.lastVisit!=="all"&&t.last_visit){const l=new Date(t.last_visit),y=Math.floor((new Date().getTime()-l.getTime())/(1e3*60*60*24));switch(a.lastVisit){case"7days":if(y>7)return!1;break;case"30days":if(y>30)return!1;break;case"90days":if(y>90)return!1;break;case"6months":if(y>180)return!1;break;case"1year":if(y>365)return!1;break}}return!0}),[u,v,a]),L=r.useMemo(()=>{const s=[],t=d.filter(l=>l.loyalty_level==="platinum"||l.color_tag==="vip");t.length>0&&s.push({type:"vip",text:`${t.length} VIP customers`,action:()=>{const l=new Set(t.map(f=>f.id));x(l),m.success(`Selected ${t.length} VIP customers`)}});const i=d.filter(l=>l.last_visit?Math.floor((Date.now()-new Date(l.last_visit).getTime())/(1e3*60*60*24))>90:!1);return i.length>0&&s.push({type:"inactive",text:`${i.length} inactive (90+ days)`,action:()=>{const l=new Set(i.map(f=>f.id));x(l),m.success(`Selected ${i.length} inactive customers`)}}),s},[d]),O=s=>{const t=new Set(n);t.has(s)?t.delete(s):t.add(s),x(t)},R=()=>{n.size===d.length?x(new Set):x(new Set(d.map(s=>s.id)))},h=ee(g),G=n.size*h.smsUnits*P,H=async()=>{if(n.size===0){m.error("Please select at least one customer");return}if(!g.trim()){m.error("Please enter a message");return}try{M(!0);const t=u.filter(l=>n.has(l.id)).map(l=>({recipient_phone:l.phone,message:g,status:"pending",created_at:new Date().toISOString(),sent_at:new Date().toISOString()})),{error:i}=await z.from("sms_logs").insert(t);if(i)throw i;m.success(`Successfully queued ${n.size} SMS messages!`),N(""),x(new Set),c()}catch(s){console.error("Error sending bulk SMS:",s),m.error("Failed to send SMS messages")}finally{M(!1)}};return o?e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[99999]",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 border-b border-gray-100 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center",children:e.jsx(F,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Bulk SMS"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-0.5",children:[n.size," selected â€¢ ",d.length," available"]})]})]}),e.jsx("button",{onClick:c,className:"w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Y,{className:"w-5 h-5"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[L.length>0&&e.jsx("div",{className:"flex gap-2",children:L.map((s,t)=>e.jsx("button",{onClick:s.action,className:"px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors",children:s.text},t))}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Search customers...",value:v,onChange:s=>U(s.target.value),className:"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]}),e.jsxs("button",{onClick:()=>$(!S),className:`px-4 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${S?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(J,{className:"w-4 h-4"}),"Filters"]})]}),S&&e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1.5",children:"Loyalty"}),e.jsxs("select",{value:a.loyaltyLevel,onChange:s=>w({...a,loyaltyLevel:s.target.value}),className:"w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"platinum",children:"Platinum"}),e.jsx("option",{value:"gold",children:"Gold"}),e.jsx("option",{value:"silver",children:"Silver"}),e.jsx("option",{value:"bronze",children:"Bronze"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1.5",children:"City"}),e.jsxs("select",{value:a.city,onChange:s=>w({...a,city:s.target.value}),className:"w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Cities"}),E.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:a.activeOnly,onChange:s=>w({...a,activeOnly:s.target.checked}),className:"w-4 h-4 text-blue-600 rounded"}),e.jsx("label",{className:"text-sm text-gray-700",children:"Active customers only"})]})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[d.length," customers"]}),e.jsx("button",{onClick:R,className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:n.size===d.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto",children:V?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"})}):d.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500 text-sm",children:"No customers found"}):e.jsx("div",{className:"divide-y divide-gray-100",children:d.map(s=>{const t=n.has(s.id);return e.jsx("div",{onClick:()=>O(s.id),className:`px-4 py-3 cursor-pointer transition-colors ${t?"bg-blue-50":"hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 transition-colors ${t?"bg-blue-600 border-blue-600":"border-gray-300"}`,children:t&&e.jsx(X,{className:"w-3 h-3 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-1 mt-0.5",children:[e.jsx(K,{className:"w-3 h-3"}),s.phone]})]}),s.loyalty_level&&e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${s.loyalty_level==="platinum"?"bg-purple-100 text-purple-700":s.loyalty_level==="gold"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}`,children:s.loyalty_level})]})},s.id)})})})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-sm",children:"Message"}),e.jsxs("button",{onClick:()=>T(!C),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:[C?"Hide":"Show"," Templates"]})]}),C&&e.jsx("div",{className:"space-y-2",children:Object.entries(A).map(([s,t])=>e.jsx("button",{onClick:()=>{N(t.message),T(!1)},className:"w-full text-left p-2.5 text-xs bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors",children:e.jsx("div",{className:"font-medium text-gray-900",children:t.title})},s))}),e.jsx("textarea",{value:g,onChange:s=>N(s.target.value),placeholder:"Type your message...",className:"w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm resize-none",rows:6}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-gray-600",children:"Characters"}),e.jsx("span",{className:"font-semibold text-gray-900",children:h.charCount})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-gray-600",children:"Units"}),e.jsx("span",{className:"font-semibold text-gray-900",children:h.smsUnits})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-gray-600",children:"Encoding"}),e.jsx("span",{className:"font-semibold text-gray-900",children:h.encoding})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-gray-600",children:"Price/Unit"}),e.jsx("span",{className:"font-semibold text-gray-900",children:D(P)})]})]}),e.jsxs("div",{className:"pt-3 border-t border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Recipients"}),e.jsx("span",{className:"font-semibold text-gray-900",children:n.size})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total Units"}),e.jsx("span",{className:"font-semibold text-gray-900",children:n.size*h.smsUnits})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total Cost"}),e.jsxs("span",{className:"text-lg font-bold text-green-600",children:[D(G)," TZS"]})]})]})]})})]})}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-100 flex-shrink-0",children:e.jsx("button",{onClick:H,disabled:_||n.size===0||!g.trim(),className:"w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:_?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):`Send to ${n.size} Customer${n.size!==1?"s":""}`})})]})}):null},te=r.lazy(()=>W(()=>import("./SMSLogsPage-112f3a23.js"),["assets/SMSLogsPage-112f3a23.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"])),ae=()=>e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}),ce=()=>{const[o,c]=r.useState(!1);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-6",children:e.jsxs("div",{className:"flex items-center justify-between py-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"SMS Control Center"})]}),e.jsxs("button",{onClick:()=>c(!0),className:"flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all font-semibold shadow-lg hover:shadow-xl",children:[e.jsx(F,{size:20}),"Send Bulk SMS"]})]})})}),e.jsx("div",{className:"pt-0",children:e.jsx(r.Suspense,{fallback:e.jsx(ae,{}),children:e.jsx(te,{})})}),e.jsx(se,{isOpen:o,onClose:()=>c(!1)})]})};export{ce as default};
