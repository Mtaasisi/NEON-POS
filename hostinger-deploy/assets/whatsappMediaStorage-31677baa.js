var y=Object.defineProperty;var w=(c,e,o)=>e in c?y(c,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):c[e]=o;var m=(c,e,o)=>(w(c,typeof e!="symbol"?e+"":e,o),o);import{_ as I}from"./supabase-cf010ec4.js";class f{static isDevelopment(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}static validateFile(e){return e?this.ALLOWED_TYPES.includes(e.type)?e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size: ${this.MAX_FILE_SIZE/(1024*1024)}MB`}:{valid:!0}:{valid:!1,error:"Invalid file type. Allowed: images, videos, PDF, Excel files"}:{valid:!1,error:"No file provided"}}static generateSafeFileName(e){var s;const o=Date.now(),d=Math.random().toString(36).substring(2,15),r=((s=e.split(".").pop())==null?void 0:s.toLowerCase())||"jpg",g=e.split(".")[0].replace(/[^a-zA-Z0-9]/g,"-").toLowerCase().substring(0,20);return`whatsapp-${o}-${g}-${d}.${r}`}static async fileToBase64(e){return new Promise((o,d)=>{const r=new FileReader;r.onload=()=>o(r.result),r.onerror=g=>d(g),r.readAsDataURL(e)})}static async uploadMedia(e){var o,d,r,g;try{console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`),console.log("â•‘    ğŸ“¤ WHATSAPP MEDIA UPLOAD - CLIENT         â•‘"),console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ğŸ“ [FILE] Details:"),console.log("   â€¢ Name:",e.name),console.log("   â€¢ Type:",e.type),console.log("   â€¢ Size:",e.size,"bytes",`(${(e.size/1024/1024).toFixed(2)}MB)`),console.log("   â€¢ Last Modified:",new Date(e.lastModified).toISOString()),console.log(`
ğŸ” [VALIDATION] Checking file...`);const s=this.validateFile(e);if(!s.valid)return console.error("âŒ [VALIDATION FAILED]",s.error),{success:!1,error:s.error};console.log("âœ… [VALIDATION] File is valid");const D=this.generateSafeFileName(e.name);console.log("ğŸ“ [FILENAME] Generated safe name:",D),console.log(`
ğŸš€ [UPLOAD] Preparing to upload via proxy...`);const h=new FormData;h.append("file",e),console.log("ğŸ“¦ [FORMDATA] Created FormData with file");let u="";try{console.log("ğŸ”‘ [AUTH] Fetching WhatsApp API key from integrations...");const{getIntegration:t}=await I(()=>import("./index-61458a34.js").then(i=>i.b9),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),l=await t("WHATSAPP_WASENDER");u=((o=l==null?void 0:l.credentials)==null?void 0:o.api_key)||((d=l==null?void 0:l.credentials)==null?void 0:d.bearer_token)||"",u?console.log("âœ… [AUTH] API key found:",u.substring(0,10)+"..."):console.warn("âš ï¸ [AUTH] No API key found in integration settings")}catch(t){console.warn("âš ï¸ [AUTH] Could not get WhatsApp API key from integrations:",t)}const L="/api/whatsapp/upload-media";console.log(`
ğŸ“¡ [REQUEST] Sending to server proxy:`),console.log("   URL:",L),console.log("   Method: POST");const A={};u&&(A.Authorization=`Bearer ${u}`),console.log("   Headers:",JSON.stringify(A,null,2)),console.log("   Body: FormData with file");const S=Date.now(),a=await fetch(L,{method:"POST",headers:A,body:h}),U=Date.now()-S;if(console.log(`
ğŸ“¡ [RESPONSE] Received (${U}ms):`),console.log("   Status:",a.status,a.statusText),console.log("   Headers:",JSON.stringify(Object.fromEntries(a.headers.entries()),null,2)),!a.ok){const t=await a.text();console.error(`
âŒ [ERROR] Upload failed with status:`,a.status),console.error("   Error response:",t);let l;try{l=JSON.parse(t),console.error("   Parsed error:",JSON.stringify(l,null,2))}catch{console.error("   (Could not parse as JSON)")}if(this.isDevelopment()){console.log(`
âš ï¸ [FALLBACK] Trying base64 for development mode...`);try{const i=await this.fileToBase64(e);return console.log("âœ… [SUCCESS] Using base64 data URL as fallback"),console.log("   Data URL length:",i.length),console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!0,url:i}}catch(i){console.error("âŒ [FALLBACK FAILED] Base64 conversion also failed:",i)}}return console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!1,error:`Upload failed: ${a.status} ${a.statusText}. Please configure WhatsApp WasenderAPI in Admin Settings â†’ Integrations.`}}const E=await a.text();console.log("ğŸ“¥ [RESPONSE] Body:",E.substring(0,500));const n=JSON.parse(E);console.log("ğŸ“‹ [PARSED] Result:",JSON.stringify(n,null,2));const p=n.publicUrl||n.url||((r=n.data)==null?void 0:r.url)||n.mediaUrl||((g=n.data)==null?void 0:g.mediaUrl);if(!p){if(console.error(`
âŒ [ERROR] No media URL in response`),console.error("   Full response:",n),this.isDevelopment()){console.log(`
âš ï¸ [FALLBACK] Trying base64 for development mode...`);try{const t=await this.fileToBase64(e);return console.log("âœ… [SUCCESS] Using base64 data URL as fallback"),console.log("   Data URL length:",t.length),console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!0,url:t}}catch(t){console.error("âŒ [FALLBACK FAILED] Base64 conversion also failed:",t)}}return console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!1,error:n.error||n.message||"No media URL returned from server"}}return console.log(`
âœ… [SUCCESS] Media uploaded successfully!`),console.log("   Media URL:",p),console.log("   URL type:",p.startsWith("http")?"HTTP URL":p.startsWith("data:")?"Base64 Data URL":"Unknown"),console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!0,url:p}}catch(s){return console.error(`
âŒ [EXCEPTION] Upload error:`,s),console.error("   Error message:",s.message),console.error("   Stack trace:",s.stack),console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),{success:!1,error:s.message||"Upload failed"}}}static async deleteMedia(e){try{return this.isDevelopment()&&e.startsWith("data:")?(console.log("ğŸ—‘ï¸ Development mode: base64 data, nothing to delete"),{success:!0}):(console.log("ğŸ—‘ï¸ Deleting media from server:",e),console.log("âš ï¸ Media deletion not implemented for WasenderAPI uploads"),console.log("   Files are temporary and will be cleaned up by the API provider"),{success:!0})}catch(o){return console.error("âŒ Delete error:",o),{success:!1,error:o.message||"Delete failed"}}}static getMediaType(e){return e.startsWith("image/")?"image":e.startsWith("video/")?"video":"document"}}m(f,"MAX_FILE_SIZE",16*1024*1024),m(f,"ALLOWED_TYPES",["image/jpeg","image/jpg","image/png","image/webp","image/gif","video/mp4","video/3gpp","application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]),m(f,"BASE_UPLOAD_PATH","/public/uploads/whatsapp-media"),m(f,"BASE_URL_PATH","/uploads/whatsapp-media");const T=f;export{f as WhatsAppMediaStorageService,T as whatsappMediaStorage};
