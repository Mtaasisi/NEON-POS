import{aw as F,u as V,y as q,s as B,j as e}from"./index-61458a34.js";import{r as i}from"./vendor-36d2c7c1.js";import{z as r,p as _,s as R,an as P,bA as H,W as T,R as U,b2 as G,ax as K,af as Y,a3 as J,u as Q,a8 as X,aE as Z,al as ee,bs as se,aK as te,O as ae,av as ne}from"./ui-28e30067.js";import{m as c}from"./mobileOfflineCache-ee6f7212.js";import{a as ie}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";class le{constructor(){this.isOnline=navigator.onLine,this.isSyncing=!1,this.syncInterval=null,this.branchId=null,this.init()}init(){window.addEventListener("online",()=>{console.log("ðŸ“¶ [DataSync] Device is online"),this.isOnline=!0,this.handleOnline()}),window.addEventListener("offline",()=>{console.log("ðŸ“µ [DataSync] Device is offline"),this.isOnline=!1,this.handleOffline()}),window.addEventListener("branchChanged",a=>{const{branchId:t}=a.detail;console.log("ðŸª [DataSync] Branch changed to:",t),this.setBranchId(t),this.isOnline&&(console.log("ðŸ”„ [DataSync] Syncing data for new branch..."),this.syncNow(!1))}),this.isOnline&&this.performInitialSync(),this.setupPeriodicSync()}setBranchId(a){console.log("ðŸª [DataSync] Branch ID set to:",a),this.branchId=a}async performInitialSync(){console.log("ðŸ”„ [DataSync] Performing initial sync...");try{const a=await c.isCacheValid("products"),t=await c.isCacheValid("customers");if(!a||!t)console.log("âš ï¸ [DataSync] Cache is invalid or empty, syncing now..."),await this.syncNow();else{console.log("âœ… [DataSync] Cache is valid, skipping initial sync");const o=await c.getCacheStats();console.log("ðŸ“Š [DataSync] Cache stats:",o)}}catch(a){console.error("âŒ [DataSync] Error during initial sync:",a)}}async handleOnline(){r.success("Back online! Syncing data...",{duration:2e3}),await this.syncPendingSales(),await this.syncNow()}handleOffline(){r("You're offline. Changes will be saved locally.",{icon:"ðŸ“µ",duration:3e3})}setupPeriodicSync(){this.syncInterval&&clearInterval(this.syncInterval),this.syncInterval=setInterval(()=>{this.isOnline&&!this.isSyncing&&(console.log("â° [DataSync] Periodic sync triggered"),this.syncNow(!1))},30*60*1e3)}async syncNow(a=!0){if(this.isSyncing)return console.log("â³ [DataSync] Sync already in progress, skipping..."),!1;if(!this.isOnline)return a&&r.error("Cannot sync while offline"),!1;this.isSyncing=!0,a&&r.loading("Syncing data...",{id:"sync-toast"});try{console.log("ðŸ”„ [DataSync] Starting data sync...");const t=await c.syncAll(this.branchId||void 0);return t.success?(console.log(`âœ… [DataSync] Sync complete. Synced: ${t.synced.join(", ")}`),a&&r.success("Data synced successfully!",{id:"sync-toast"}),window.dispatchEvent(new CustomEvent("dataSynced",{detail:{synced:t.synced}})),!0):(console.warn(`âš ï¸ [DataSync] Sync completed with errors: ${t.errors.join(", ")}`),a&&r.error("Some data failed to sync",{id:"sync-toast"}),!1)}catch(t){return console.error("âŒ [DataSync] Sync failed:",t),a&&r.error("Sync failed",{id:"sync-toast"}),!1}finally{this.isSyncing=!1}}async syncPendingSales(){try{const a=await c.getPendingSales();if(a.length===0){console.log("âœ… [DataSync] No pending sales to sync");return}console.log(`ðŸ”„ [DataSync] Syncing ${a.length} pending sales...`);let t=0,o=0;for(const p of a)try{await c.markSaleSynced(p.id),t++}catch(f){console.error(`âŒ [DataSync] Failed to sync sale ${p.id}:`,f),o++}t>0&&r.success(`Synced ${t} offline sales`),o>0&&r.error(`Failed to sync ${o} sales`)}catch(a){console.error("âŒ [DataSync] Error syncing pending sales:",a)}}async forceSyncNow(){return this.syncNow(!0)}getSyncStatus(){return{isOnline:this.isOnline,isSyncing:this.isSyncing}}async getCacheStats(){return await c.getCacheStats()}async clearCache(){try{await c.clearAll(),r.success("Cache cleared successfully"),console.log("âœ… [DataSync] Cache cleared")}catch(a){console.error("âŒ [DataSync] Error clearing cache:",a),r.error("Failed to clear cache")}}cleanup(){this.syncInterval&&clearInterval(this.syncInterval)}}const ce=new le,re=()=>{const[j,a]=i.useState(navigator.onLine),[t,o]=i.useState(!1),[p,f]=i.useState([]),[I,h]=i.useState([]),[N,D]=i.useState([]),[m,u]=i.useState([]),[w,k]=i.useState([]),[L,S]=i.useState([]),[A,x]=i.useState(!0),[C,b]=i.useState(!0),g=i.useCallback(async()=>{try{console.log("ðŸ“¦ [useMobileOffline] Loading cached data...");const[n,l,d,v,y,E]=await Promise.all([c.getProducts(),c.getCustomers(),c.getSales(),c.getBranches(),c.getCategories(),c.getPaymentAccounts()]);f(n),h(l),D(d),u(v),k(y),S(E),console.log("âœ… [useMobileOffline] Cached data loaded:",{products:n.length,customers:l.length,sales:d.length,branches:v.length,categories:y.length,paymentAccounts:E.length})}catch(n){console.error("âŒ [useMobileOffline] Error loading cached data:",n)}finally{x(!1),b(!1)}},[]);i.useEffect(()=>{F()&&g()},[g]),i.useEffect(()=>{const n=()=>{console.log("ðŸ“¶ [useMobileOffline] Device is online"),a(!0)},l=()=>{console.log("ðŸ“µ [useMobileOffline] Device is offline"),a(!1)},d=()=>{console.log("ðŸ”„ [useMobileOffline] Data synced, reloading cached data..."),g()};return window.addEventListener("online",n),window.addEventListener("offline",l),window.addEventListener("dataSynced",d),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",l),window.removeEventListener("dataSynced",d)}},[g]);const z=i.useCallback(async()=>{o(!0);try{const n=await ce.forceSyncNow();return n&&await g(),n}finally{o(!1)}},[g]),M=i.useCallback(async()=>await c.getCacheStats(),[]),W=i.useCallback(async()=>{await c.clearAll(),f([]),h([]),D([]),u([]),k([]),S([])},[]),$=i.useCallback(async n=>await c.savePendingSale(n),[]),O=i.useCallback(async()=>{x(!0);try{const n=await c.getProducts();f(n)}finally{x(!1)}},[]),s=i.useCallback(async()=>{b(!0);try{const n=await c.getCustomers();h(n)}finally{b(!1)}},[]);return{isOnline:j,isSyncing:t,isNativeApp:F(),products:p,customers:I,sales:N,branches:m,categories:w,paymentAccounts:L,productsLoading:A,customersLoading:C,syncNow:z,getCacheStats:M,clearCache:W,savePendingSale:$,refreshProducts:O,refreshCustomers:s}},me=()=>{var O;const j=ie(),{currentUser:a}=V(),{currentBranch:t,availableBranches:o,switchBranch:p,loading:f}=q(),[I,h]=i.useState(!1),[N,D]=i.useState(!1),{isOnline:m,isSyncing:u,isNativeApp:w,syncNow:k,getCacheStats:L}=re(),[S,A]=i.useState(null),[x,C]=i.useState({sales:0,clients:0,products:0,loading:!0});i.useEffect(()=>{t&&z()},[t]),i.useEffect(()=>{w&&b()},[w]);const b=async()=>{try{const s=await L();A(s)}catch(s){console.error("Error loading cache stats:",s)}},g=async()=>{try{await k()?(await b(),r.success("Data synced successfully!")):r.error("Sync failed. Please try again.")}catch(s){console.error("Error syncing:",s),r.error("Sync error occurred")}},z=async()=>{if(t)try{C(E=>({...E,loading:!0}));const{count:s,error:n}=await B.from("lats_sales").select("*",{count:"exact",head:!0}).eq("branch_id",t.id);if(n)throw n;const{count:l,error:d}=await B.from("lats_customers").select("*",{count:"exact",head:!0}).eq("branch_id",t.id);if(d)throw d;const{count:v,error:y}=await B.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",t.id);if(y)throw y;C({sales:s||0,clients:l||0,products:v||0,loading:!1})}catch(s){console.error("Error fetching stats:",s),r.error("Failed to load statistics"),C(n=>({...n,loading:!1}))}},M=[{section:"MAIN",items:[{icon:Y,label:"Analytics",path:"/mobile/analytics"},{icon:J,label:"Invoices",path:"/mobile/invoices"},{icon:_,label:"Employees",path:"/mobile/employees"},{icon:Q,label:"Suppliers",path:"/mobile/suppliers"}]},{section:"SETTINGS",items:[{icon:X,label:"General Settings",path:"/mobile/settings"},{icon:Z,label:"Payment Methods",path:"/mobile/payments"},{icon:ee,label:"Notifications",path:"/mobile/notifications"}]},{section:"SUPPORT",items:[{icon:se,label:"Help & Support",path:"/mobile/help"},{icon:te,label:"Logout",path:"/logout",isDestructive:!0}]}],W=[{icon:ae,label:"New Sale",path:"/mobile/pos"},{icon:ne,label:"Reports",path:"/mobile/analytics"}],$=async s=>{try{await p(s),h(!1)}catch(n){console.error("Failed to switch branch:",n),r.error("Failed to switch branch")}};return e.jsxs("div",{className:"flex flex-col h-full bg-[#f2f2f7]",children:[e.jsx("div",{className:"bg-white px-4 pt-3 pb-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-[34px] font-bold text-black tracking-tight",style:{letterSpacing:"-0.5px"},children:"More"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto pb-20",children:[e.jsx("div",{className:"mx-4 mt-4 bg-white rounded-2xl overflow-hidden shadow-sm",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md",children:e.jsx(_,{size:32,className:"text-white",strokeWidth:2})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-[20px] font-semibold text-gray-900",children:((O=a==null?void 0:a.email)==null?void 0:O.split("@")[0])||"Admin User"}),e.jsx("p",{className:"text-[15px] text-gray-500",children:(a==null?void 0:a.email)||"admin@latsepos.com"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[e.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:x.loading?"...":x.sales}),e.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Sales"})]}),e.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[e.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:x.loading?"...":x.clients}),e.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Clients"})]}),e.jsxs("div",{className:"bg-[#f2f2f7] rounded-xl p-3 text-center",children:[e.jsx("div",{className:"text-[20px] font-bold text-gray-900",children:x.loading?"...":x.products}),e.jsx("div",{className:"text-[11px] text-gray-500 mt-0.5",children:"Products"})]})]})]})}),!f&&o.length>0&&e.jsxs("div",{className:"mx-4 mt-4",children:[e.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:"CURRENT BRANCH"}),e.jsx("button",{onClick:()=>h(!0),className:"w-full bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md active:scale-[0.98] transition-all",children:e.jsxs("div",{className:"px-4 py-3.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-sm",children:e.jsx(R,{size:20,className:"text-white",strokeWidth:2.5})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[16px] font-semibold text-gray-900",children:(t==null?void 0:t.name)||"Select Branch"}),e.jsx("div",{className:"text-[13px] text-gray-500",children:(t==null?void 0:t.city)||"No branch selected"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[o.length>1&&e.jsxs("span",{className:"text-[11px] font-semibold text-blue-500 bg-blue-50 px-2 py-1 rounded-full",children:[o.length," available"]}),e.jsx(P,{size:18,className:"text-gray-400",strokeWidth:2.5})]})]})})]}),w&&e.jsxs("div",{className:"mx-4 mt-4",children:[e.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:"OFFLINE MODE"}),e.jsxs("div",{className:"bg-white rounded-2xl overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[m?e.jsx("div",{className:"w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center",children:e.jsx(H,{size:20,className:"text-green-600",strokeWidth:2.5})}):e.jsx("div",{className:"w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center",children:e.jsx(T,{size:20,className:"text-orange-600",strokeWidth:2.5})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[15px] font-semibold text-gray-900",children:m?"Online":"Offline"}),e.jsx("div",{className:"text-[12px] text-gray-500",children:m?"Connected to server":"Working offline"})]})]}),m&&e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"})]}),e.jsxs("button",{onClick:g,disabled:u||!m,className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center",children:e.jsx(U,{size:20,className:`text-blue-600 ${u?"animate-spin":""}`,strokeWidth:2.5})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[15px] font-medium text-gray-900",children:u?"Syncing...":"Sync Data"}),e.jsx("div",{className:"text-[12px] text-gray-500",children:u?"Please wait":"Update offline data"})]})]}),e.jsx(P,{size:18,className:"text-gray-400",strokeWidth:2.5})]}),e.jsxs("button",{onClick:()=>D(!N),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center",children:e.jsx(G,{size:20,className:"text-purple-600",strokeWidth:2.5})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[15px] font-medium text-gray-900",children:"Cache Statistics"}),e.jsx("div",{className:"text-[12px] text-gray-500",children:"View offline data status"})]})]}),e.jsx(P,{size:18,className:`text-gray-400 transition-transform ${N?"rotate-90":""}`,strokeWidth:2.5})]}),N&&S&&e.jsx("div",{className:"px-4 py-3 bg-gray-50 border-t border-gray-100",children:e.jsx("div",{className:"space-y-2",children:Object.entries(S).map(([s,n])=>s==="pending_sales"?e.jsxs("div",{className:"flex justify-between text-[13px]",children:[e.jsx("span",{className:"text-gray-600 capitalize",children:s.replace("_"," ")}),e.jsx("span",{className:"font-semibold text-orange-600",children:n.count})]},s):e.jsxs("div",{className:"flex justify-between text-[13px]",children:[e.jsx("span",{className:"text-gray-600 capitalize",children:s.replace("_"," ")}),e.jsx("span",{className:"font-semibold text-gray-900",children:n.count||0})]},s))})})]})]}),e.jsx("div",{className:"px-4 mt-4",children:e.jsx("div",{className:"flex gap-2",children:W.map((s,n)=>{const l=s.icon;return e.jsxs("button",{onClick:()=>j(s.path),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors text-[13px] font-medium shadow-sm",children:[e.jsx(l,{size:18,strokeWidth:2.5}),e.jsx("span",{children:s.label})]},n)})})}),M.map((s,n)=>e.jsxs("div",{className:"px-4 mt-6",children:[e.jsx("h3",{className:"text-[13px] font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1",children:s.section}),e.jsx("div",{className:"bg-white rounded-2xl overflow-hidden shadow-sm",children:s.items.map((l,d)=>{const v=l.icon,y=d===s.items.length-1;return e.jsxs("button",{onClick:()=>j(l.path),className:`w-full px-4 py-3.5 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors ${y?"":"border-b border-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center ${l.isDestructive?"bg-red-50":"bg-blue-50"}`,children:e.jsx(v,{size:18,className:l.isDestructive?"text-red-500":"text-blue-500",strokeWidth:2.5})}),e.jsx("span",{className:`text-[16px] ${l.isDestructive?"text-red-500":"text-gray-900"} font-normal`,children:l.label}),l.badge&&e.jsx("span",{className:`text-[10px] font-bold text-white ${l.badgeColor||"bg-blue-500"} px-2 py-0.5 rounded-full`,children:l.badge})]}),e.jsx(P,{size:18,className:"text-gray-400",strokeWidth:2.5})]},d)})})]},n)),e.jsxs("div",{className:"px-4 py-8 text-center",children:[e.jsx("p",{className:"text-[13px] text-gray-400 font-medium",children:"LATS POS Mobile"}),e.jsx("p",{className:"text-[13px] text-gray-400 mt-1",children:"Version 1.0.0"})]})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-end",onClick:()=>h(!1),children:e.jsxs("div",{className:"w-full bg-white rounded-t-3xl max-h-[70vh] flex flex-col animate-slide-up",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"flex justify-center pt-2 pb-1",children:e.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),e.jsx("div",{className:"px-4 py-3 border-b border-gray-200",children:e.jsx("h2",{className:"text-[20px] font-semibold text-gray-900 text-center",children:"Select Branch"})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:o.map((s,n)=>{const l=(t==null?void 0:t.id)===s.id,d=n===o.length-1;return e.jsxs("button",{onClick:()=>$(s.id),className:`w-full px-4 py-4 flex items-center justify-between hover:bg-gray-50 active:bg-gray-100 transition-colors ${d?"":"border-b border-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-xl flex items-center justify-center ${l?"bg-gradient-to-br from-green-500 to-emerald-600":"bg-gray-100"}`,children:e.jsx(R,{size:20,className:l?"text-white":"text-gray-500",strokeWidth:2.5})}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[16px] font-semibold ${l?"text-gray-900":"text-gray-700"}`,children:s.name}),s.is_main&&e.jsx("span",{className:"text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full",children:"MAIN"})]}),e.jsxs("div",{className:"text-[13px] text-gray-500 flex items-center gap-2",children:[e.jsx("span",{children:s.city}),s.code&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"â€¢"}),e.jsx("span",{className:"text-[12px] font-mono",children:s.code})]})]})]})]}),l&&e.jsx("div",{className:"w-6 h-6 bg-green-500 rounded-full flex items-center justify-center",children:e.jsx(K,{size:14,className:"text-white",strokeWidth:3})})]},s.id)})}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsx("button",{onClick:()=>h(!1),className:"w-full py-3 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 rounded-xl text-[16px] font-semibold text-gray-900 transition-colors",children:"Cancel"})})]})})]})};export{me as default};
