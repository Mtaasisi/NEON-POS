import{a as q,j as t,e as J,G as N,s as T}from"./index-61458a34.js";import{r as i}from"./vendor-36d2c7c1.js";import{M as W}from"./Modal-a5e4c1ba.js";import{n as p}from"./ui-28e30067.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./useBodyScrollLock-341c8b9f.js";const ee=()=>{const{startLoading:b,completeLoading:y,failLoading:v}=q(),[a,c]=i.useState([]),[g,o]=i.useState(!1),[w,h]=i.useState(null),[I,x]=i.useState(!1),[m,R]=i.useState(""),[j,F]=i.useState(""),[S,V]=i.useState("name"),L=i.useRef(null),P=async()=>{const e=b("Loading customers...");o(!0);try{const{data:s,error:n}=await T.from("customers").select("*").order("name").limit(5e4);if(n)throw n;c(s||[]),y(e),p.success(`Loaded ${(s==null?void 0:s.length)||0} customers`)}catch(s){console.error("Error loading customers:",s),v(e,"Failed to load customers"),p.error("Failed to load customers")}finally{o(!1)}},U=e=>{var l;const s=(l=e.target.files)==null?void 0:l[0];if(!s)return;const n=new FileReader;n.onload=d=>{var r;try{const f=((r=d.target)==null?void 0:r.result).split(`
`),O=f[0].split(",").map(u=>u.trim().replace(/"/g,"")),C=[];for(let u=1;u<f.length;u++)if(f[u].trim()){const A=f[u].split(",").map(_=>_.trim().replace(/"/g,"")),E={};O.forEach((_,G)=>{E[_.toLowerCase().replace(/\s+/g,"_")]=A[G]||""}),C.push(E)}c(C),p.success(`Imported ${C.length} customers from CSV`)}catch(k){console.error("Error parsing CSV:",k),p.error("Failed to parse CSV file")}},n.readAsText(s)},B=async e=>{try{const{error:s}=await T.from("lats_customers").update({name:e.name,email:e.email,phone:e.phone,gender:e.gender,city:e.city,whatsapp:e.whatsapp,referral_source:e.referral_source,birth_month:e.birth_month,birth_day:e.birth_day,total_returns:e.total_returns,location_description:e.location_description,national_id:e.national_id,points:e.points,total_spent:e.total_spent,loyalty_level:e.loyalty_level,color_tag:e.color_tag,customer_tag:e.customer_tag,notes:e.notes,is_active:e.is_active,updated_at:new Date().toISOString()}).eq("id",e.id);if(s)throw s;c(n=>n.map(l=>l.id===e.id?e:l)),x(!1),h(null),p.success("Customer updated successfully")}catch(s){console.error("Error updating customer:",s),p.error("Failed to update customer")}},M=()=>{const s=[["ID","Name","Email","Phone","Gender","City","WhatsApp","Referral Source","Birth Month","Birth Day","Total Returns","Initial Notes","Location Description","National ID","Points","Total Spent","Loyalty Level","Color Tag","Customer Tag","Notes","Is Active"].join(","),...a.map(r=>[r.id,`"${(r.name||"").replace(/"/g,'""')}"`,`"${(r.email||"").replace(/"/g,'""')}"`,`"${(r.phone||"").replace(/"/g,'""')}"`,`"${(r.gender||"").replace(/"/g,'""')}"`,`"${(r.city||"").replace(/"/g,'""')}"`,`"${(r.whatsapp||"").replace(/"/g,'""')}"`,`"${(r.referral_source||"").replace(/"/g,'""')}"`,`"${(r.birth_month||"").replace(/"/g,'""')}"`,`"${(r.birth_day||"").replace(/"/g,'""')}"`,r.total_returns||0,`"${(r.location_description||"").replace(/"/g,'""')}"`,`"${(r.national_id||"").replace(/"/g,'""')}"`,r.points||0,r.total_spent||0,`"${(r.loyalty_level||"").replace(/"/g,'""')}"`,`"${(r.color_tag||"").replace(/"/g,'""')}"`,`"${(r.customer_tag||"").replace(/"/g,'""')}"`,`"${(r.notes||"").replace(/"/g,'""')}"`,r.is_active?"Yes":"No"].join(","))].join(`
`),n=new Blob([s],{type:"text/csv"}),l=window.URL.createObjectURL(n),d=document.createElement("a");d.href=l,d.download=`customer_data_updated_${new Date().toISOString().split("T")[0]}.csv`,d.click(),window.URL.revokeObjectURL(l),p.success("CSV exported successfully")},$=a.filter(e=>{var s,n,l,d;return((s=e.name)==null?void 0:s.toLowerCase().includes(m.toLowerCase()))||((n=e.email)==null?void 0:n.toLowerCase().includes(m.toLowerCase()))||((l=e.phone)==null?void 0:l.includes(m))||((d=e.whatsapp)==null?void 0:d.includes(m))}).filter(e=>!j||e.customer_tag===j).sort((e,s)=>{switch(S){case"points":return(s.points||0)-(e.points||0);case"total_spent":return(s.total_spent||0)-(e.total_spent||0);default:return(e.name||"").localeCompare(s.name||"")}});return t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6",children:t.jsxs("div",{className:"max-w-7xl mx-auto",children:[t.jsxs("div",{className:"mb-8",children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:"Customer Data Update"}),t.jsx("p",{className:"text-gray-600",children:"Update customer information, import/export data, and manage customer records"})]}),t.jsxs(J,{className:"mb-6",children:[t.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[t.jsx(N,{onClick:P,disabled:g,children:g?"Loading...":"Load Customers"}),t.jsx("input",{ref:L,type:"file",accept:".csv",onChange:U,className:"hidden"}),t.jsx(N,{onClick:()=>{var e;return(e=L.current)==null?void 0:e.click()},variant:"secondary",children:"Import CSV"}),t.jsx(N,{onClick:M,variant:"secondary",disabled:a.length===0,children:"Export CSV"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[t.jsx("input",{type:"text",placeholder:"Search customers...",value:m,onChange:e=>R(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),t.jsxs("select",{value:j,onChange:e=>F(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"",children:"All Tags"}),t.jsx("option",{value:"vip",children:"VIP"}),t.jsx("option",{value:"regular",children:"Regular"}),t.jsx("option",{value:"new",children:"New"})]}),t.jsxs("select",{value:S,onChange:e=>V(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"name",children:"Sort by Name"}),t.jsx("option",{value:"points",children:"Sort by Points"}),t.jsx("option",{value:"total_spent",children:"Sort by Total Spent"})]})]}),t.jsx("div",{className:"space-y-4",children:$.map(e=>t.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 cursor-pointer",onClick:()=>{h(e),x(!0)},children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-900",children:e.name}),t.jsx("p",{className:"text-blue-600 font-medium",children:e.phone}),t.jsx("p",{className:"text-sm text-gray-500",children:e.city})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Points: ",e.points||0]}),t.jsxs("div",{className:"text-sm text-gray-500",children:["Spent: $",e.total_spent||0]}),e.customer_tag&&t.jsx("span",{className:"inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded",children:e.customer_tag})]})]})},e.id))}),$.length===0&&t.jsx("div",{className:"text-center py-8 text-gray-500",children:'No customers found. Click "Load Customers" to load data from the database.'})]}),w&&t.jsx(W,{isOpen:I,onClose:()=>{x(!1),h(null)},title:"Edit Customer",children:t.jsx(Y,{customer:w,onSave:B,onCancel:()=>{x(!1),h(null)}})})]})})},Y=({customer:b,onSave:y,onCancel:v})=>{const[a,c]=i.useState(b),g=o=>{o.preventDefault(),y(a)};return t.jsxs("form",{onSubmit:g,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),t.jsx("input",{type:"text",value:a.name||"",onChange:o=>c({...a,name:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),t.jsx("input",{type:"email",value:a.email||"",onChange:o=>c({...a,email:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone"}),t.jsx("input",{type:"tel",value:a.phone||"",onChange:o=>c({...a,phone:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"City"}),t.jsx("input",{type:"text",value:a.city||"",onChange:o=>c({...a,city:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),t.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[t.jsx("button",{type:"button",onClick:v,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"}),t.jsx("button",{type:"submit",className:"px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",children:"Save Changes"})]})]})};export{ee as default};
