import{_ as Ce}from"./supabase-cf010ec4.js";import{X as E,s as B,u as Ye,Y as Qe,j as e}from"./index-61458a34.js";import{r as u,b as Xe}from"./vendor-36d2c7c1.js";import{n as x,X as _e,bz as Fe,d as ae,bP as Ie,b as ne,e as Ee,g as He,aE as ge,q as Oe}from"./ui-28e30067.js";import{D as he,S as $,a as se}from"./currencyUtils-59109a41.js";import{u as Ge}from"./useBodyScrollLock-341c8b9f.js";const Je=()=>{const[_,l]=u.useState([]),[o,v]=u.useState(!0);u.useEffect(()=>{M()},[]);const M=async()=>{v(!0);try{const c=await E.getPaymentMethods();l(c)}catch(c){console.error("Error loading payment accounts:",c)}finally{v(!1)}};return{paymentAccounts:_,loading:o,getPOSPaymentAccounts:async()=>{try{return await E.getPOSPaymentMethods()}catch(c){return console.error("Error loading POS payment accounts:",c),[]}},getFinancePaymentAccounts:async()=>{try{return await E.getFinancePaymentMethods()}catch(c){return console.error("Error loading finance payment accounts:",c),[]}},getPaymentAccountById:async c=>{try{return await E.getFinanceAccountById(c)}catch(p){return console.error("Error loading payment account by ID:",p),null}},getPaymentAccountsByType:async c=>{try{return await E.getFinanceAccountsByType(c)}catch(p){return console.error("Error loading payment accounts by type:",p),[]}},createPaymentAccount:async c=>{try{const p=await E.createFinanceAccount(c);return p&&l(y=>[...y,p]),p}catch(p){return console.error("Error creating payment account:",p),null}},updatePaymentAccount:async(c,p)=>{try{const y=await E.updateFinanceAccount(c,p);return y&&l(U=>U.map(H=>H.id===c?y:H)),y}catch(y){return console.error("Error updating payment account:",y),null}},deletePaymentAccount:async c=>{try{const p=await E.deleteFinanceAccount(c);return p&&l(y=>y.filter(U=>U.id!==c)),p}catch(p){return console.error("Error deleting payment account:",p),!1}},refreshPaymentAccounts:()=>{M()}}};class Ke{async updateDeviceRepairPrice(l){try{console.log("üí∞ DevicePriceService: Updating device repair price...",l);const{data:o,error:v}=await B.from("devices").select("repair_price").eq("id",l.deviceId).single();if(v)throw console.error("‚ùå Error fetching current device price:",v),new Error("Failed to fetch current device price");const M=(o==null?void 0:o.repair_price)||0,{error:Z}=await B.from("devices").update({repair_price:l.repairPrice,updated_at:new Date().toISOString()}).eq("id",l.deviceId);if(Z)throw console.error("‚ùå Error updating device repair price:",Z),new Error("Failed to update device repair price");return await this.recordPriceChange({deviceId:l.deviceId,oldPrice:M,newPrice:l.repairPrice,reason:l.reason||"Price adjustment",updatedBy:l.updatedBy}),console.log("‚úÖ Device repair price updated successfully"),!0}catch(o){throw console.error("‚ùå DevicePriceService: Error updating device repair price:",o),o}}async recordPriceChange(l){try{const{error:o}=await B.from("device_price_history").insert({device_id:l.deviceId,old_price:l.oldPrice,new_price:l.newPrice,reason:l.reason,updated_by:l.updatedBy,updated_at:new Date().toISOString()});o&&console.error("‚ö†Ô∏è Error recording price change history:",o)}catch(o){console.error("‚ö†Ô∏è Error recording price change history:",o)}}async getDevicePriceHistory(l){try{const{data:o,error:v}=await B.from("device_price_history").select("*").eq("device_id",l).order("updated_at",{ascending:!1});if(v)throw console.error("‚ùå Error fetching device price history:",v),v;return o||[]}catch(o){return console.error("‚ùå DevicePriceService: Error fetching device price history:",o),[]}}async getDeviceRepairPrice(l){try{const{data:o,error:v}=await B.from("devices").select("repair_price").eq("id",l).single();return v?(console.error("‚ùå Error fetching device repair price:",v),0):(o==null?void 0:o.repair_price)||0}catch(o){return console.error("‚ùå DevicePriceService: Error fetching device repair price:",o),0}}}const We=new Ke,lr=({isOpen:_,onClose:l,amount:o,customerId:v,customerName:M,description:Z,onPaymentComplete:oe,deviceId:X,allowPriceEdit:xe=!1,paymentType:w="cash_in",currency:d,exchangeRate:m})=>{var De;const{currentUser:k}=Ye(),{paymentMethods:c,loading:p}=Qe(),{paymentAccounts:y,refreshPaymentAccounts:U}=Je(),[H,fe]=u.useState([]),[Me,ie]=u.useState(!1),[er,pe]=u.useState(!1),[rr,O]=u.useState(null);u.useState(!1),Ge(_),u.useEffect(()=>{(async()=>{if(!_||!v||w!=="cash_out"){O(null);return}try{const{data:t,error:a}=await B.from("lats_suppliers").select("wechat_qr_code, alipay_qr_code, bank_account_details, wechat, country").eq("id",v).single();if(a){console.error("Error fetching supplier payment info:",a);return}t&&t.country==="China"&&(t.wechat_qr_code||t.alipay_qr_code||t.bank_account_details)?O(t):O(null)}catch(t){console.error("Error loading supplier payment info:",t),O(null)}})()},[_,v,w]),u.useEffect(()=>{(!c||c.length===0)&&!p&&(ie(!0),Ce(()=>import("./index-61458a34.js").then(r=>r.bc),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]).then(({financeAccountService:r})=>{r.getPaymentMethods().then(t=>{fe(t),ie(!1)}).catch(t=>{console.error("‚ùå Failed to load payment methods:",t),x.error("Failed to load payment methods. Please refresh the page."),fe([]),ie(!1)})}))},[c,p,_]);const T=c&&c.length>0?c:H,be=p||Me,[g,G]=u.useState(""),[P,ce]=u.useState(he),[J,C]=u.useState(!1),[S,ke]=u.useState(!1),[A,q]=u.useState([]),[b,F]=u.useState(""),[Te,K]=u.useState(!1),[ye,le]=u.useState(""),[ve,je]=u.useState(""),[Le,W]=u.useState(!1),[$e,Ne]=u.useState(!1),[tr,V]=u.useState(""),[z,I]=u.useState(null),[h,R]=u.useState({}),[de,me]=u.useState(null);u.useEffect(()=>{_&&(G(""),ce(he),C(!1),ke(!1),q([]),F(""),W(!1),K(!1),le(""),je(""),V(""),R({}),me(null),(()=>(!y||y.length===0,!0))()?(console.log("üí≥ Payment modal opened - Refreshing account balances..."),(async()=>{pe(!0);try{U?(await U(),console.log("‚úÖ Account balances refreshed successfully")):(console.log("‚ö†Ô∏è Using fallback balance refresh"),Ce(()=>import("./index-61458a34.js").then(a=>a.bc),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]).then(({financeAccountService:a})=>{a.getPaymentMethods().then(s=>{console.log("‚úÖ Balances loaded via fallback:",s.map(n=>({name:n.name,balance:n.balance,currency:n.currency})))})}))}catch(a){console.error("‚ùå Failed to refresh balances:",a)}finally{pe(!1)}})()):console.log("üí≥ Payment modal opened - Using cached balances"))},[_]);const Se=(r,t,a)=>!t||t==="TZS"||!a||a===1?null:Math.round(r*a),D=Se(b?Number(b):o,d,m),we=d&&d!=="TZS"&&m&&m>1,ee=S?A.reduce((r,t)=>t.currency==="TZS"||!d||!m?r+t.amount:t.currency===d&&m?r+Math.round(t.amount*m):r+t.amount,0):A.reduce((r,t)=>r+t.amount,0),re=b?Number(b):ee,Ze=D||o,Ue=S?ee:g&&h[g]&&h[g]>0?h[g]:0,N=Ze-Ue,L=D?"TZS":d||"TZS",Pe=r=>{const t=y.find(s=>s.payment_method_id===r);if(t)return{id:t.id,name:t.name||t.account_name,payment_method_id:r};const a=c.find(s=>s.id===r);return a?{id:a.id,name:a.name,payment_method_id:r}:null},Be=(r,t)=>{const a=c.find(j=>j.id===r),s=Pe(r);if(!a){x.error("Payment method not found");return}if(!s||!s.id){x.error("No payment account found for this method. Please set up a finance account first.");return}let n;if(t!==void 0&&t>0)n=t;else if(b&&b.trim()!==""){const j=parseFloat(b);if(isNaN(j)){x.error("Please enter a valid number for amount");return}n=j}else P.code==="TZS"||!d||!m?n=N:P.code===d?n=N/m:n=N;if(isNaN(n)||n<=0){x.error("Please enter a valid amount greater than 0");return}if((P.code==="TZS"||!d||!m?n:P.code===d?Math.round(n*m):n)>N){x.error(`Amount (${n.toLocaleString()} ${P.code}) exceeds remaining balance (${N.toLocaleString()} ${L})`);return}console.log("‚ûï Adding payment entry:",{method:a.name,amount:n,currency:P.code,accountId:s.id});const f={id:crypto.randomUUID(),method:a.name,methodId:a.id,amount:n,currency:P.code,account:s.name,accountId:s.id,reference:"",notes:""};q(j=>[...j,f]),F("")},qe=r=>{q(t=>t.filter((a,s)=>s!==r))},ue=(r,t,a)=>{q(s=>s.map((n,i)=>i===r?{...n,[t]:a}:n))},Ve=(r,t)=>{const a=parseFloat(t.replace(/,/g,""))||0;R(s=>({...s,[r]:a}))},ze=async()=>{if($e||J){console.log("‚ö†Ô∏è Payment already processing, ignoring duplicate request");return}if(S){if(A.length===0){x.error("Please add at least one payment");return}if(N<0){x.error("Payment amount exceeds required amount");return}if(w==="cash_out")for(const r of A){const t=y.find(a=>a.id===r.accountId);if(t){let a=r.amount;const s=r.currency||d||"TZS",n=t.currency||"TZS";if(s!==n&&(s===d&&n==="TZS"&&m?a=Math.round(r.amount*m):s==="TZS"&&n===d&&m&&(a=r.amount/m)),t.balance<a){x.error(`Insufficient balance in ${t.name}. Available: ${t.balance.toLocaleString()} ${n}, Required: ${a.toLocaleString()} ${n}`);return}}}}else{if(!g){x.error("Please select a payment method");return}if(w==="cash_out"){const r=y.find(s=>s.payment_method_id===g),t=h[g],a=t&&t>0?d&&d!=="TZS"&&m?Math.round(t*m):t:D||o;if(r&&r.balance<a){x.error(`Insufficient balance in ${r.name}. Available: ${r.balance.toLocaleString()} ${r.currency||"TZS"}, Required: ${a.toLocaleString()}`);return}}}C(!0),Ne(!0),V("Validating payment details...");try{const r=t=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t);if(S){for(const a of A){if(!a.accountId){x.error(`Missing account ID for payment method: ${a.method}. Please remove and re-add this payment.`),C(!1);return}if(!r(a.methodId)){x.error(`Invalid payment method ID: ${a.method}. Please refresh and try again.`),C(!1);return}if(!r(a.accountId)){x.error(`Invalid account ID for: ${a.method}. Please refresh and try again.`),C(!1);return}}V("Processing multiple payments..."),console.log("üí∞ Multiple payments data:",A.map(a=>({method:a.method,methodId:a.methodId,accountId:a.accountId,amount:a.amount})));const t=A.map(a=>{const s=typeof a.amount=="number"?a.amount:parseFloat(String(a.amount));if(isNaN(s)||s<=0)throw new Error(`Invalid amount for payment method ${a.method}: ${a.amount}`);const n=a.currency||d||"TZS";let i=s;return n!=="TZS"&&d&&m&&n===d?i=Math.round(s*m):n==="TZS"&&(i=s),{amount:i,currency:"TZS",originalCurrency:n,originalAmount:s,paymentMethod:a.method,paymentMethodId:a.methodId,paymentAccountId:a.accountId,customerId:v,customerName:M,description:Z,timestamp:new Date().toISOString()}});console.log("üì§ Sending payment data:",t),await oe(t,ee)}else{const t=c.find(Y=>Y.id===g),a=Pe(g);if(!t){x.error("Payment method not found"),C(!1);return}if(!a||!a.id){x.error("No payment account found for this method. Please set up a finance account first."),C(!1);return}if(!r(t.id)){x.error("Invalid payment method ID. Please refresh and try again."),C(!1);return}if(!r(a.id)){x.error("Invalid account ID. Please refresh and try again."),C(!1);return}const s=h[g];let n;if(s&&s>0?n=s:n=D||(typeof o=="number"?o:parseFloat(String(o))),isNaN(n)||n<=0){x.error(`Invalid payment amount: ${n}. Please refresh and try again.`),C(!1);return}V("Processing payment..."),console.log("üí≥ Single payment data:",{method:t.name,methodId:t.id,account:a.name,accountId:a.id,amount:n,originalAmount:o,originalCurrency:d,convertedToTZS:!!D});const i=d&&d!=="TZS"&&m?s&&s>0?Math.round(s/m):o:n,f=[{amount:n,currency:"TZS",originalCurrency:d||"TZS",originalAmount:i,paymentMethod:t.name,paymentMethodId:t.id,paymentAccountId:a.id,customerId:v,customerName:M,description:Z,timestamp:new Date().toISOString()}];console.log("üì§ Sending single payment:",f[0]),await oe(f,n)}l()}catch(r){console.error("Payment failed:",r),x.error("Payment failed. Please try again."),V("")}finally{C(!1),Ne(!1)}};if(!_)return null;const te=S?A.length:g&&h[g]&&h[g]>0?1:0,Ae=S?ee:g?h[g]&&h[g]>0?h[g]:D||o:0;return Xe.createPortal(e.jsx("div",{className:"fixed inset-0 z-[99999] flex items-center justify-center bg-black/60 p-4",onClick:r=>{r.target===r.currentTarget&&l()},role:"dialog","aria-modal":"true","aria-labelledby":"payment-modal-title",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:l,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(_e,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:`w-16 h-16 rounded-full flex items-center justify-center shadow-lg ${w==="cash_out"?"bg-red-600":"bg-green-600"}`,children:e.jsx(Fe,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"payment-modal-title",className:"text-2xl font-bold text-gray-900 mb-3",children:w==="cash_out"?"Make Payment":"Complete Your Payment"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg ${te>0?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:[e.jsx(ae,{className:`w-4 h-4 ${te>0?"text-green-600":"text-gray-400"}`}),e.jsxs("span",{className:`text-sm font-bold ${te>0?"text-green-700":"text-gray-600"}`,children:[te," Done"]})]})})]})]})}),e.jsx("div",{className:"p-6 pb-0 flex-shrink-0",children:e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Total Amount"}),e.jsxs("p",{className:"text-6xl font-bold text-gray-900",children:[(D||o).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",L]}),we&&D&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Original: ",d," ",o.toLocaleString()," ‚Ä¢ Exchange Rate: ",m==null?void 0:m.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx("button",{onClick:()=>W(!0),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit amount",children:e.jsx(Ie,{className:"w-4 h-4 text-gray-600"})})]}),Le?e.jsx("div",{className:"mb-4 p-4 bg-gray-50 border border-gray-300 rounded-lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount"}),e.jsx("div",{className:"mb-3",children:e.jsx("select",{value:P.code,onChange:r=>{const t=$.find(a=>a.code===r.target.value);t&&ce(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 cursor-pointer mb-2",children:$.map(r=>e.jsx("option",{value:r.code,children:r.code},r.code))})}),e.jsx("div",{className:"bg-gray-50 border-2 border-gray-200 rounded-lg p-4 focus-within:border-orange-500 transition-colors",children:e.jsx("input",{type:"text",value:b?Number(b).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):"",onChange:r=>{const t=r.target.value.replace(/,/g,"");(t===""||!isNaN(Number(t))&&Number(t)>=0)&&F(t)},onClick:r=>{b&&Number(b)>0&&(F(""),r.currentTarget.value="")},className:"w-full text-center text-3xl font-bold text-gray-900 bg-transparent border-none outline-none",placeholder:"0",autoFocus:!0})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>W(!1),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Save"}),e.jsx("button",{onClick:()=>{F(""),W(!1)},className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors",children:"Cancel"})]})]})}):null]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:[!S&&Ae===0&&!be&&T.length>0&&e.jsxs("div",{className:"py-4 border-b border-gray-200 mb-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:["Quick Pay - Full Amount: ",e.jsxs("span",{className:"font-bold text-green-600",children:[(D||o).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",L]})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:T.slice(0,3).map((r,t)=>{const a=["bg-green-600 hover:bg-green-700","bg-purple-600 hover:bg-purple-700","bg-blue-600 hover:bg-blue-700"],n=[Oe,ge,ge][t]||ge,i=["Cash","Mobile","Card"];return e.jsxs("button",{onClick:()=>{G(r.id),I(r.id),me(r.id);const f=D||o;R(j=>({...j,[r.id]:f}))},disabled:w==="cash_out"&&(()=>{const f=y.find(Y=>Y.payment_method_id===r.id),j=D||o;return f&&f.balance<j})(),className:`px-4 py-3 ${a[t]} disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2`,children:[e.jsx(n,{className:"w-5 h-5"}),"Pay ",i[t]||r.name.split(" ")[0]]},r.id)})})]}),Ae>0&&e.jsx("div",{className:"py-3 mb-4 border-b border-gray-200",children:e.jsxs("button",{onClick:()=>{S?q([]):(G(""),R({}),me(null)),I(null)},className:"w-full px-6 py-3 bg-gradient-to-r from-orange-50 to-amber-50 hover:from-orange-100 hover:to-amber-100 border-2 border-orange-200 hover:border-orange-300 text-orange-700 rounded-xl font-semibold transition-all duration-200 text-sm flex items-center justify-center gap-2 shadow-sm hover:shadow-md group",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-orange-100 group-hover:bg-orange-200 flex items-center justify-center transition-colors",children:e.jsx(_e,{className:"w-4 h-4 text-orange-600"})}),e.jsxs("span",{className:"font-bold",children:["Clear Payment & Switch to ",S?"Single":"Split"," Mode"]}),e.jsx(ne,{className:"w-4 h-4 text-orange-600 group-hover:translate-y-0.5 transition-transform"})]})}),e.jsx("div",{className:"py-4",children:be?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading payment methods..."})]}):T.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"w-12 h-12 text-orange-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"No payment methods available"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Please contact administrator to set up payment methods"})]}):S?e.jsxs("div",{className:"space-y-4",children:[A.map((r,t)=>{T.find(i=>i.id===r.methodId);const a=$.find(i=>i.code===r.currency)||he,s=z===r.id,n=y.find(i=>i.id===r.accountId);return e.jsxs("div",{className:"border-2 rounded-2xl bg-white shadow-sm border-green-200 hover:border-green-300 transition-all duration-300 hover:shadow-md",children:[e.jsxs("div",{className:"flex items-start justify-between p-6 cursor-pointer",onClick:()=>I(s?null:r.id),children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-6 h-6 rounded-lg flex items-center justify-center bg-gray-200",children:e.jsx(ne,{className:`w-4 h-4 text-gray-600 transition-transform duration-200 ${s?"rotate-180":""}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:r.method}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold shadow-sm bg-green-500 text-white",children:[e.jsx(ae,{className:"w-3 h-3"}),"Done"]})]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[r.account," ‚Ä¢ ",r.currency]})]})]})}),e.jsx("div",{className:"px-4 py-2 rounded-xl text-base font-bold shadow-sm border bg-green-100 text-green-700 border-green-200",children:se(r.amount,a)})]}),s&&e.jsx("div",{className:"px-6 pb-6 border-t border-gray-100",children:e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Edit ",r.method," Amount"]}),e.jsx("div",{className:"mb-3",children:e.jsx("select",{value:r.currency,onChange:i=>{const f=$.find(j=>j.code===i.target.value);f&&ue(t,"currency",f.code)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 cursor-pointer mb-2",children:$.map(i=>e.jsx("option",{value:i.code,children:i.code},i.code))})}),e.jsx("div",{className:"bg-gray-50 border-2 border-gray-200 rounded-lg p-4 focus-within:border-orange-500 transition-colors",children:e.jsx("input",{type:"text",value:r.amount>0?r.amount.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):"",onChange:i=>{const f=i.target.value.replace(/,/g,"");(f===""||!isNaN(Number(f))&&Number(f)>=0)&&ue(t,"amount",f===""?0:parseFloat(f))},onClick:i=>{r.amount>0&&(ue(t,"amount",0),i.currentTarget.value="")},placeholder:"0",className:"w-full text-center text-3xl font-bold text-gray-900 bg-transparent border-none outline-none"})})]}),n&&e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Balance:"}),e.jsxs("p",{className:"font-bold text-gray-900",children:[n.balance.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",n.currency||"TZS"]})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-600",children:["Amount to ",w==="cash_out"?"Pay":"Receive",":"]}),e.jsxs("p",{className:"font-bold text-gray-900",children:[r.amount.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",r.currency]})]}),e.jsxs("div",{className:"col-span-2 pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-gray-600",children:"Balance After Payment:"}),e.jsxs("p",{className:`font-bold ${Math.max(0,n.balance-r.amount)>=0?"text-gray-900":"text-red-600"}`,children:[Math.max(0,n.balance-r.amount).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",n.currency||"TZS"]})]})]})}),e.jsx("button",{onClick:i=>{i.stopPropagation(),qe(t),I(null)},className:"w-full px-4 py-2 bg-red-50 hover:bg-red-100 border border-red-200 text-red-700 rounded-lg font-medium transition-colors",children:"Remove This Payment"})]})})]},r.id)}),N>0&&e.jsxs("div",{className:"border-2 rounded-2xl bg-white shadow-sm border-orange-300 hover:border-orange-400 transition-all duration-300 hover:shadow-md cursor-pointer",onClick:()=>I(z==="add"?null:"add"),children:[e.jsxs("div",{className:"flex items-start justify-between p-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-6 h-6 rounded-lg flex items-center justify-center bg-gray-200",children:e.jsx(ne,{className:`w-4 h-4 text-gray-600 transition-transform duration-200 ${z==="add"?"rotate-180":""}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:"Add Payment Method"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Select another payment method"})]})]})}),e.jsx("div",{className:"px-4 py-2 rounded-xl text-base font-bold shadow-sm border bg-red-100 text-red-700 border-red-200",children:"Amount Required"})]}),z==="add"&&e.jsx("div",{className:"px-6 pb-6 border-t border-gray-100",children:e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount"}),e.jsx("div",{className:"mb-3",children:e.jsx("select",{value:P.code,onChange:r=>{const t=$.find(a=>a.code===r.target.value);t&&ce(t)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 cursor-pointer mb-2",children:$.map(r=>e.jsx("option",{value:r.code,children:r.code},r.code))})}),e.jsx("div",{className:"bg-gray-50 border-2 border-gray-200 rounded-lg p-4 focus-within:border-orange-500 transition-colors",children:e.jsx("input",{type:"text",value:b?Number(b).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):"",onChange:r=>{const t=r.target.value.replace(/,/g,"");(t===""||!isNaN(Number(t))&&Number(t)>=0)&&F(t)},onClick:r=>{b&&Number(b)>0&&(F(""),r.currentTarget.value="")},placeholder:"0",className:"w-full text-center text-3xl font-bold text-gray-900 bg-transparent border-none outline-none"})}),we&&b&&Number(b)>0&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["‚âà ",(De=Se(Number(b),P.code,m))==null?void 0:De.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," TZS"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Method"}),e.jsxs("select",{onChange:r=>{if(r.target.value){const t=b?Number(b):void 0;Be(r.target.value,t),r.target.value="",F(""),I(null)}},className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 bg-white",children:[e.jsx("option",{value:"",children:"Choose method"}),T.map(r=>{const t=y.find(a=>a.payment_method_id===r.id);return e.jsxs("option",{value:r.id,children:[r.name," ",t?`(Balance: ${t.balance.toLocaleString()} ${t.currency||"TZS"})`:""]},r.id)})]})]})]}),N>0&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx("span",{className:"font-semibold",children:"Remaining:"})," ",N.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",L]})})]})})]})]}):e.jsx("div",{className:de?"grid grid-cols-1 gap-4":"grid grid-cols-1 md:grid-cols-2 gap-4",children:(de?T.filter(r=>r.id===de):T).map(r=>{const t=z===r.id,a=y.find(Q=>Q.payment_method_id===r.id),s=h[r.id],n=D||o,i=s&&s>0?s:n,f=w==="cash_out"&&a&&a.balance<i,j=g===r.id,Y=j?"border-green-200 hover:border-green-300":t?"border-blue-500":"border-orange-300 hover:border-orange-400";return e.jsxs("div",{className:`border-2 rounded-2xl bg-white shadow-sm transition-all duration-300 ${Y} hover:shadow-md`,children:[e.jsxs("div",{onClick:()=>{t?I(null):(I(r.id),f||G(r.id))},className:"flex items-start justify-between p-6 cursor-pointer",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-6 h-6 rounded-lg flex items-center justify-center transition-colors bg-gray-200",children:e.jsx(ne,{className:`w-4 h-4 text-gray-600 transition-transform duration-200 ${t?"rotate-180":""}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:r.name}),(j||h[r.id]&&h[r.id]>0)&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold shadow-sm bg-green-500 text-white",children:[e.jsx(ae,{className:"w-3 h-3"}),"Done"]})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:a?e.jsxs(e.Fragment,{children:["Balance: ",a.balance.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",a.currency||"TZS",f&&e.jsx("span",{className:"text-red-600 ml-2",children:"‚Ä¢ Insufficient"})]}):"Select this payment method"})]})]})}),e.jsx("div",{className:"flex flex-col items-end gap-2",children:e.jsx("div",{className:`px-4 py-2 rounded-xl text-base font-bold shadow-sm border ${j||h[r.id]&&h[r.id]>0?"bg-green-100 text-green-700 border-green-200":"bg-red-100 text-red-700 border-red-200"}`,children:j||h[r.id]&&h[r.id]>0?`${i.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})} ${L}`:"Amount Required"})})]}),t&&e.jsx("div",{className:"px-6 pb-6 border-t border-gray-100",children:e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Enter ",r.name," Amount (in TZS)"]}),e.jsx("div",{className:"bg-gray-50 border-2 border-gray-200 rounded-lg p-4 focus-within:border-orange-500 transition-colors",children:e.jsx("input",{type:"text",value:h[r.id]>0?h[r.id].toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):"",onChange:Q=>Ve(r.id,Q.target.value),onClick:Q=>{h[r.id]>0&&(R(Re=>({...Re,[r.id]:0})),Q.currentTarget.value="")},placeholder:"0",className:"w-full text-center text-3xl font-bold text-gray-900 bg-transparent border-none outline-none"})}),h[r.id]>0&&d&&d!=="TZS"&&m&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["‚âà ",(h[r.id]/m).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",d]})]}),a&&e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Balance:"}),e.jsxs("p",{className:"font-bold text-gray-900",children:[a.balance.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",a.currency||"TZS"]})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-gray-600",children:["Amount to ",w==="cash_out"?"Pay":"Receive",":"]}),e.jsxs("p",{className:"font-bold text-gray-900",children:[i.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",L]})]}),e.jsxs("div",{className:"col-span-2 pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-gray-600",children:"Balance After Payment:"}),e.jsxs("p",{className:`font-bold ${Math.max(0,a.balance-i)>=0?"text-gray-900":"text-red-600"}`,children:[Math.max(0,a.balance-i).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",a.currency||"TZS"]})]})]})})]})})]},r.id)})})})]}),xe&&X&&re>o&&e.jsxs("div",{className:"px-6 mt-6 p-5 bg-white rounded-lg shadow-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ie,{className:"w-5 h-5 text-gray-700"}),e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Customer Paid More"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Original Price:"}),e.jsx("p",{className:"font-semibold text-gray-900",children:se(o,P)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),e.jsx("p",{className:"font-semibold text-gray-900",children:se(re,P)})]})]})}),Te?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"New Repair Price"}),e.jsx("input",{type:"number",value:ye,onChange:r=>le(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter new price"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for Price Change"}),e.jsx("textarea",{value:ve,onChange:r=>je(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,placeholder:"e.g., Customer paid more, additional services provided..."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{if(!(!X||!(k!=null&&k.id)))try{await We.updateDeviceRepairPrice({deviceId:X,repairPrice:parseFloat(ye),updatedBy:k==null?void 0:k.id,reason:ve||"Price adjusted to match customer payment"}),x.success("Device price updated successfully"),K(!1)}catch(r){console.error("Error updating device price:",r),x.error("Failed to update device price")}},className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Update Price"}),e.jsx("button",{onClick:()=>K(!1),className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors",children:"Cancel"})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["Customer paid ",e.jsx("span",{className:"font-semibold",children:se(re-o,P)})," more than the original price."]}),e.jsx("button",{onClick:()=>{le(re.toString()),K(!0)},className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors",children:"Update Price to Match Payment"})]})]})]}),e.jsxs("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:[N>0&&e.jsxs("div",{className:"mb-3 p-3 bg-orange-50 border border-orange-200 rounded-lg flex items-center gap-2",children:[e.jsx(Ee,{className:"w-5 h-5 text-orange-600 flex-shrink-0"}),e.jsxs("span",{className:"text-sm font-semibold text-orange-700",children:[w==="cash_out"?"Amount to pay":"Amount remaining",": ",N.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})," ",L]})]}),e.jsx("button",{onClick:ze,disabled:J||N>0&&!S&&!g||N>0&&S&&A.length===0,className:`w-full px-6 py-3.5 rounded-xl font-semibold transition-all shadow-lg hover:shadow-xl text-lg flex items-center justify-center gap-2 ${!J&&(S?A.length>0:g)&&N<=0?"bg-green-600 text-white hover:bg-green-700":"bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"}`,children:J?e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-5 h-5 animate-spin"}),"Processing..."]}):!(S?A.length>0:g)||N>0?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-5 h-5"}),!g&&!S?"Select Payment Method First":N>0?"Complete All Payments First":"Set Payment Amount"]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-5 h-5"}),w==="cash_out"?"Make Payment":"Complete Payment"]})})]})]})}),document.body)};export{lr as P};
