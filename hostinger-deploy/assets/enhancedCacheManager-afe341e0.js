import{ap as p,U as o,s as d}from"./index-61458a34.js";import{z as h}from"./ui-28e30067.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";const C="pos-smart-cache",y=2,f={products:{expiry:4*60*60*1e3,staleTime:1*60*60*1e3},customers:{expiry:2*60*60*1e3,staleTime:30*60*1e3},sales:{expiry:24*60*60*1e3,staleTime:2*60*60*1e3},branches:{expiry:24*60*60*1e3,staleTime:12*60*60*1e3},categories:{expiry:48*60*60*1e3,staleTime:24*60*60*1e3},suppliers:{expiry:24*60*60*1e3,staleTime:12*60*60*1e3},payment_accounts:{expiry:24*60*60*1e3,staleTime:12*60*60*1e3},settings:{expiry:48*60*60*1e3,staleTime:24*60*60*1e3}};class S{constructor(){this.db=null,this.isOnline=navigator.onLine,this.refreshInProgress=new Set,this.listeners=new Map,this.init(),this.setupNetworkListeners()}async init(){return this.db?this.db:(this.db=await p(C,y,{upgrade(e,t,r,a){if(console.log("ðŸ“¦ [SmartCache] Upgrading database from",t,"to",r),!e.objectStoreNames.contains("products")){const c=e.createObjectStore("products",{keyPath:"id"});c.createIndex("category","category"),c.createIndex("is_active","is_active"),c.createIndex("branch_id","branch_id")}if(!e.objectStoreNames.contains("customers")){const c=e.createObjectStore("customers",{keyPath:"id"});c.createIndex("branch_id","branch_id"),c.createIndex("created_at","created_at")}if(!e.objectStoreNames.contains("sales")){const c=e.createObjectStore("sales",{keyPath:"id"});c.createIndex("created_at","created_at"),c.createIndex("branch_id","branch_id")}if(e.objectStoreNames.contains("branches")||e.createObjectStore("branches",{keyPath:"id"}),e.objectStoreNames.contains("categories")||e.createObjectStore("categories",{keyPath:"id"}),e.objectStoreNames.contains("suppliers")||e.createObjectStore("suppliers",{keyPath:"id"}),e.objectStoreNames.contains("payment_accounts")||e.createObjectStore("payment_accounts",{keyPath:"id"}),e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"key"}),!e.objectStoreNames.contains("pending_sync")){const c=e.createObjectStore("pending_sync",{keyPath:"id",autoIncrement:!0});c.createIndex("synced","synced"),c.createIndex("type","type")}e.objectStoreNames.contains("cache_metadata")||e.createObjectStore("cache_metadata",{keyPath:"store"})}}),console.log("âœ… [SmartCache] Database initialized"),this.db)}setupNetworkListeners(){window.addEventListener("online",()=>{console.log("ðŸ“¶ [SmartCache] Device is online"),this.isOnline=!0,this.syncPendingOperations()}),window.addEventListener("offline",()=>{console.log("ðŸ“µ [SmartCache] Device is offline"),this.isOnline=!1}),window.addEventListener("branchChanged",e=>{const{branchId:t}=e.detail;console.log("ðŸª [SmartCache] Branch changed, clearing branch-specific cache...",t),this.invalidateCache("products"),this.invalidateCache("customers"),this.invalidateCache("sales"),h("Branch changed - refreshing data...",{icon:"ðŸ”„",duration:2e3})})}async smartFetch(e,t,r={}){const{forceRefresh:a=!1,showLoadingToast:c=!1,branchId:s}=r;try{const i=await this.getCacheStatus(e);if(!a&&i.exists&&i.isFresh){console.log(`âœ… [SmartCache] Using fresh cache for ${e}`);const u=await this.getFromCache(e);return i.isStale&&(console.log(`ðŸ”„ [SmartCache] Cache is stale, refreshing in background for ${e}`),this.refreshInBackground(e,t,s)),u}if(c&&h.loading(`Loading ${e}...`,{id:`fetch-${e}`}),console.log(`ðŸŒ [SmartCache] Fetching ${e} from server...`),!this.isOnline)return console.warn(`ðŸ“µ [SmartCache] Offline - using expired cache for ${e}`),c&&(h.dismiss(`fetch-${e}`),h.error("You are offline. Showing cached data.",{duration:3e3})),await this.getFromCache(e);const l=await t();return await this.saveToCache(e,l),c&&h.success(`${e} loaded successfully!`,{id:`fetch-${e}`}),console.log(`âœ… [SmartCache] Fetched and cached ${l.length} items for ${e}`),this.notifyListeners(e,l),l}catch(i){console.error(`âŒ [SmartCache] Error fetching ${e}:`,i),await o.logCacheError("enhancedCacheManager","smartFetch",i,"fetch",{storeName:e,forceRefresh:a,branchId:s,isOnline:this.isOnline}),c&&h.error(`Failed to load ${e}`,{id:`fetch-${e}`});const l=await this.getFromCache(e);if(l.length>0)return console.log(`âš ï¸ [SmartCache] Returning cached data as fallback for ${e}`),h("Using cached data",{icon:"ðŸ’¾",duration:2e3}),l;throw i}}async refreshInBackground(e,t,r){if(this.refreshInProgress.has(e)){console.log(`â³ [SmartCache] Background refresh already in progress for ${e}`);return}this.refreshInProgress.add(e);try{console.log(`ðŸ”„ [SmartCache] Starting background refresh for ${e}`);const a=await t();await this.saveToCache(e,a),console.log(`âœ… [SmartCache] Background refresh complete for ${e}`),this.notifyListeners(e,a)}catch(a){console.error(`âŒ [SmartCache] Background refresh failed for ${e}:`,a),await o.logCacheError("enhancedCacheManager","refreshInBackground",a,"background_refresh",{storeName:e,branchId:r,isOnline:this.isOnline})}finally{this.refreshInProgress.delete(e)}}async getCacheStatus(e){try{const r=await(await this.init()).get("cache_metadata",e);if(!r)return{exists:!1,isFresh:!1,isStale:!1,isExpired:!0,age:0};const c=Date.now()-new Date(r.lastSynced).getTime(),s=f[e],i=c>s.expiry,l=c>s.staleTime&&!i;return{exists:!0,isFresh:c<=s.staleTime,isStale:l,isExpired:i,age:c}}catch(t){return console.error(`âŒ [SmartCache] Error checking cache status for ${e}:`,t),await o.logCacheError("enhancedCacheManager","getCacheStatus",t,"read",{storeName:e}),{exists:!1,isFresh:!1,isStale:!1,isExpired:!0,age:0}}}async getFromCache(e){try{return(await(await this.init()).getAll(e)).map(a=>{const{_cachedAt:c,...s}=a;return s})}catch(t){return console.error(`âŒ [SmartCache] Error getting from cache for ${e}:`,t),await o.logCacheError("enhancedCacheManager","getFromCache",t,"read",{storeName:e}),[]}}async saveToCache(e,t){try{const a=(await this.init()).transaction([e,"cache_metadata"],"readwrite");await a.objectStore(e).clear();const c=new Date().toISOString();for(const i of t)await a.objectStore(e).put({...i,_cachedAt:c});const s=f[e];await a.objectStore("cache_metadata").put({store:e,lastSynced:c,itemCount:t.length,version:y,expiresAt:Date.now()+s.expiry}),await a.done}catch(r){throw console.error(`âŒ [SmartCache] Error saving to cache for ${e}:`,r),await o.logCacheError("enhancedCacheManager","saveToCache",r,"save",{storeName:e,itemCount:t.length}),r}}subscribe(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var r;(r=this.listeners.get(e))==null||r.delete(t)}}notifyListeners(e,t){const r=this.listeners.get(e);r&&r.forEach(a=>a(t))}async queueForSync(e,t,r){try{await(await this.init()).add("pending_sync",{type:e,action:t,data:r,timestamp:new Date().toISOString(),synced:!1}),console.log(`ðŸ“ [SmartCache] Queued ${t} operation for ${e}`)}catch(a){console.error("âŒ [SmartCache] Error queuing operation:",a),await o.logCacheError("enhancedCacheManager","queueForSync",a,"queue",{type:e,action:t})}}async syncPendingOperations(){try{const e=await this.init(),r=(await e.getAll("pending_sync")).filter(a=>a.synced===!1);if(r.length===0){console.log("âœ… [SmartCache] No pending operations to sync");return}console.log(`ðŸ”„ [SmartCache] Syncing ${r.length} pending operations...`);for(const a of r)try{await e.put("pending_sync",{...a,synced:!0}),console.log(`âœ… [SmartCache] Synced operation ${a.id}`)}catch(c){console.error(`âŒ [SmartCache] Failed to sync operation ${a.id}:`,c),await o.logCacheError("enhancedCacheManager","syncPendingOperations",c,"sync",{operationId:a.id,operationType:a.type,operationAction:a.action})}h.success(`Synced ${r.length} offline changes`)}catch(e){console.error("âŒ [SmartCache] Error syncing pending operations:",e),await o.logCacheError("enhancedCacheManager","syncPendingOperations",e,"sync",{pendingOperationsCount:(pendingOps==null?void 0:pendingOps.length)||0})}}async getCacheStats(){try{const e=await this.init(),t={};for(const r of Object.keys(f)){const a=await e.get("cache_metadata",r),c=await e.count(r),s=await this.getCacheStatus(r);t[r]={itemCount:c,lastSynced:(a==null?void 0:a.lastSynced)||null,...s}}return t}catch(e){return console.error("âŒ [SmartCache] Error getting cache stats:",e),await o.logCacheError("enhancedCacheManager","getCacheStats",e,"read",{}),{}}}async clearAllCache(){try{const e=await this.init(),t=Object.keys(f);for(const r of t)await e.clear(r);await e.clear("cache_metadata"),console.log("âœ… [SmartCache] All cache cleared"),h.success("Cache cleared successfully")}catch(e){console.error("âŒ [SmartCache] Error clearing cache:",e),await o.logCacheError("enhancedCacheManager","clearAllCache",e,"delete",{}),h.error("Failed to clear cache")}}async invalidateCache(e){try{await(await this.init()).delete("cache_metadata",e),console.log(`âœ… [SmartCache] Invalidated cache for ${e}`)}catch(t){console.error(`âŒ [SmartCache] Error invalidating cache for ${e}:`,t),await o.logCacheError("enhancedCacheManager","invalidateCache",t,"delete",{storeName:e})}}}const g=new S,E=(n,e=!1)=>g.smartFetch("products",async()=>{let t=d.from("lats_products").select("*").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1e3);n&&(t=t.eq("branch_id",n));const{data:r,error:a}=await t;if(a)throw a;return r||[]},{forceRefresh:e,branchId:n}),x=(n,e=!1)=>g.smartFetch("customers",async()=>{let t=d.from("lats_customers").select("*").order("created_at",{ascending:!1}).limit(500);n&&(t=t.eq("branch_id",n));const{data:r,error:a}=await t;if(a)throw a;return r||[]},{forceRefresh:e,branchId:n}),$=(n=!1)=>g.smartFetch("categories",async()=>{const{data:e,error:t}=await d.from("lats_categories").select("*").eq("is_active",!0);if(t)throw t;return e||[]},{forceRefresh:n}),v=(n=!1)=>g.smartFetch("suppliers",async()=>{const{data:e,error:t}=await d.from("lats_suppliers").select("*").eq("is_active",!0);if(t)throw t;return e||[]},{forceRefresh:n}),j=(n=!1)=>g.smartFetch("branches",async()=>{const{data:e,error:t}=await d.from("lats_branches").select("*").eq("is_active",!0);if(t)throw t;return e||[]},{forceRefresh:n}),k=(n=!1)=>g.smartFetch("payment_accounts",async()=>{const{data:e,error:t}=await d.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0);if(t)throw t;return e||[]},{forceRefresh:n});export{j as fetchBranches,$ as fetchCategories,x as fetchCustomers,k as fetchPaymentAccounts,E as fetchProducts,v as fetchSuppliers,g as smartCache};
