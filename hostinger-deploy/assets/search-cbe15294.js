import{s as _}from"./index-61458a34.js";function v(h){if(!h)return"new";const t=h.trim().toLowerCase();return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[t]||"new"}const w=new Map,P=5*60*1e3;async function Q(h,t=1,a=50){try{let r=null,c=null;try{const{data:s,error:i}=await _.rpc("search_customers_fn",{search_query:h,page_number:t,page_size:a});r=s,c=i}catch(s){console.warn("⚠️ RPC function not available, using fallback search"),c=s}if(c||!r){const s=(t-1)*a,i=localStorage.getItem("current_branch_id"),o=h.toLowerCase(),e=_.from("customers").select("id").or(`name.ilike.%${o}%,phone.ilike.%${o}%,email.ilike.%${o}%`),{data:l}=await e,b=(l==null?void 0:l.length)||0,d=_.from("customers").select("id, name, phone, email, branch_id, created_by_branch_name").or(`name.ilike.%${o}%,phone.ilike.%${o}%,email.ilike.%${o}%`).order("created_at",{ascending:!1}).range(s,s+a-1),{data:u,error:m}=await d;if(m)throw console.error("❌ Error in fallback search:",m),m;r=(u==null?void 0:u.map(y=>({...y,total_count:b||0})))||[]}const n=r&&r.length>0?r[0].total_count:0,f=(r==null?void 0:r.map(s=>s.id))||[];if(f.length===0)return{customers:[],total:0,page:t,pageSize:a,totalPages:0,hasNextPage:!1,hasPreviousPage:!1};const{data:p,error:g}=await _.from("customers").select(`
        id,
        name,
        phone,
        email,
        whatsapp,
        gender,
        city,
        country,
        color_tag,
        loyalty_level,
        points,
        total_spent,
        last_visit,
        is_active,
        referral_source,
        birth_month,
        birth_day,
        birthday,
        initial_notes,
        notes,
        customer_tag,
        location_description,
        national_id,
        joined_date,
        created_at,
        updated_at,
        branch_id,
        is_shared,
        created_by_branch_id,
        created_by_branch_name,
        profile_image,
        whatsapp_opt_out,
        referred_by,
        created_by,
        last_purchase_date,
        total_purchases,
        total_calls,
        total_call_duration_minutes,
        incoming_calls,
        outgoing_calls,
        missed_calls,
        avg_call_duration_minutes,
        first_call_date,
        last_call_date,
        call_loyalty_level,
        total_returns
      `).in("id",f);if(g)throw console.error("❌ Error fetching customer details:",g),g;if(p){let s={};try{const e=[...new Set(p.map(l=>l.branch_id).filter(Boolean))];if(e.length>0){const b=await _.from("store_locations").select("id, name").in("id",e);b.data&&(s=b.data.reduce((d,u)=>(d[u.id]=u.name,d),{}))}}catch(e){console.warn("⚠️ Could not fetch branch names:",e)}const i=p.map(e=>({id:e.id,name:e.name,phone:e.phone,email:e.email,gender:e.gender||"other",city:e.city||"",colorTag:v(e.color_tag||"new"),loyaltyLevel:e.loyalty_level||"interested",points:e.points||0,totalSpent:e.total_spent||0,lastVisit:e.last_visit||e.created_at,isActive:e.is_active!==!1,referralSource:e.referral_source,birthMonth:e.birth_month,birthDay:e.birth_day,totalReturns:0,profileImage:null,branchName:s[e.branch_id]||e.created_by_branch_name||"Unknown Branch",whatsapp:e.phone,whatsappOptOut:!1,initialNotes:e.initial_notes,locationDescription:e.location_description,nationalId:e.national_id,notes:e.notes?typeof e.notes=="string"?(()=>{try{return JSON.parse(e.notes)}catch{return[]}})():e.notes:[],referrals:[],customerTag:e.customer_tag,joinedDate:e.joined_date||e.created_at,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]})),o=Math.ceil((n||0)/a);return{customers:i,total:n||0,page:t,pageSize:a,totalPages:o,hasNextPage:t<o,hasPreviousPage:t>1}}return{customers:[],total:0,page:t,pageSize:a,totalPages:0}}catch(r){throw console.error("❌ Error searching customers:",r),r}}async function C(h,t=1,a=50){try{const r=`search_${h}_${t}_${a}`,c=w.get(r);if(c&&Date.now()-c.timestamp<P)return c.data;let n=null,f=null;try{const s=await _.rpc("search_customers_fn",{search_query:h,page_number:t,page_size:a});n=s.data,f=s.error}catch(s){console.warn("⚠️ RPC function not available, using fallback"),f=s}if(f||!n){const s=(t-1)*a,i=h.toLowerCase(),o=localStorage.getItem("current_branch_id");let e=_.from("customers").select("id").or(`name.ilike.%${i}%,phone.ilike.%${i}%,email.ilike.%${i}%`);o&&(e=e.eq("branch_id",o));const{data:l}=await e,b=(l==null?void 0:l.length)||0;let d=_.from("customers").select("id,name,phone,email,gender,city,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared").or(`name.ilike.%${i}%,phone.ilike.%${i}%,email.ilike.%${i}%`).order("created_at",{ascending:!1}).range(s,s+a-1);o&&(d=d.eq("branch_id",o));const{data:u,error:m}=await d;if(m)throw console.error("❌ Error in fallback fast search:",m),m;n=(u==null?void 0:u.map(y=>({...y,total_count:b||0})))||[]}const p=n&&n.length>0?n[0].total_count:0;if(n){const s=n.map(e=>({...e,colorTag:v(e.color_tag||"new")})),i=Math.ceil((p||0)/a),o={customers:s,total:p||0,page:t,pageSize:a,totalPages:i,hasNextPage:t<i,hasPreviousPage:t>1};return w.set(r,{data:o,timestamp:Date.now()}),o}return{customers:[],total:0,page:t,pageSize:a,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}}catch(r){throw console.error("❌ Error in fast search:",r),r}}class k{constructor(){this.searchQueue=[],this.isProcessing=!1,this.results=new Map,this.activeJobs=new Map}async search(t){return new Promise((a,r)=>{this.searchQueue.push({query:t,resolve:a,reject:r}),this.processQueue()})}async processQueue(){if(!(this.isProcessing||this.searchQueue.length===0)){for(this.isProcessing=!0;this.searchQueue.length>0;){const{query:t,resolve:a,reject:r}=this.searchQueue.shift(),c=`search_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.activeJobs.set(c,{query:t,resolve:a,reject:r});try{if(this.results.has(t)){a(this.results.get(t)),this.activeJobs.delete(c);continue}const n=await C(t,1,100);this.results.set(t,n.customers),a(n.customers),this.activeJobs.delete(c)}catch(n){r(n),this.activeJobs.delete(c)}}this.isProcessing=!1}}cancelSearchJob(t){const a=this.activeJobs.get(t);return a?(a.resolve({cancelled:!0,customers:[],totalCount:0,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}),this.activeJobs.delete(t),!0):!1}clearResults(){this.results.clear();for(const[t,a]of this.activeJobs)a.reject(new Error("Search manager cleared"));this.activeJobs.clear()}}const $=new k;function D(){return $}export{Q as a,D as g,C as s};
