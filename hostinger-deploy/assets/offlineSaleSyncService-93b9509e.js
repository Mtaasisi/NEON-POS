import{s as f}from"./saleProcessingService-f5a8fb75.js";import{U as c}from"./index-61458a34.js";import"./supabase-cf010ec4.js";import"./ui-28e30067.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";class S{constructor(){this.STORAGE_KEY="pos_offline_sales",this.MAX_SYNC_ATTEMPTS=3,this.SYNC_INTERVAL=3e4,this.MAX_OFFLINE_SALES=100,this.CLEANUP_AGE_MS=7*24*60*60*1e3,this.CLEANUP_INTERVAL=5*60*1e3,this.syncInterval=null,this.lastCleanupTime=0,this.isCleaningUp=!1,this.onlineHandler=null}async saveSaleLocally(n){try{const s={id:`offline_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,saleData:n,timestamp:Date.now(),synced:!1,syncAttempts:0},e=this.getOfflineSales();return e.push(s),this.saveOfflineSales(e),navigator.onLine&&this.syncSale(s.id).catch(t=>{console.warn("‚ö†Ô∏è [OfflineSaleSync] Immediate sync failed, will retry:",t)}),{success:!0,saleId:s.id}}catch(s){return console.error("‚ùå [OfflineSaleSync] Failed to save sale locally:",s),await c.logCacheError("offlineSaleSyncService","saveSaleLocally",s,"save",{saleDataKeys:Object.keys(n),timestamp:Date.now(),isOnline:navigator.onLine}),{success:!1,saleId:"",error:s instanceof Error?s.message:"Unknown error"}}}async syncSale(n){const e=this.getOfflineSales().find(t=>t.id===n);if(!e)return{success:!1,error:"Sale not found"};if(e.synced)return{success:!0};if(e.syncAttempts>=this.MAX_SYNC_ATTEMPTS)return{success:!1,error:"Max sync attempts reached"};try{const t=await f.processSale(e.saleData,{forceOnline:!0});if(t.success)return this.removeOfflineSale(n),console.log("‚úÖ [OfflineSaleSync] Sale synced successfully and removed from local storage:",n),{success:!0};throw new Error(t.error||"Sale processing failed")}catch(t){e.syncAttempts++;const l=t instanceof Error?t.message:"Unknown error";e.error=l,this.updateOfflineSale(e);const i=l.includes("Insufficient stock")||l.includes("stock")||l.includes("Stock");return i&&e.syncAttempts>1||(e.syncAttempts===1?i?console.log(`‚ÑπÔ∏è [OfflineSaleSync] Sync attempt ${e.syncAttempts} failed (stock issue): ${l}
   This can happen when stock changes between offline sale and sync. Will retry up to ${this.MAX_SYNC_ATTEMPTS} times.`):console.warn(`‚ö†Ô∏è [OfflineSaleSync] Sync attempt ${e.syncAttempts} failed:`,l):console.warn(`‚ö†Ô∏è [OfflineSaleSync] Sync attempt ${e.syncAttempts} failed:`,l)),e.syncAttempts>=this.MAX_SYNC_ATTEMPTS&&!e.errorLogged&&(e.errorLogged=!0,this.updateOfflineSale(e),await c.logCacheError("offlineSaleSyncService","syncSale",new Error(l),"sync",{saleId:n,syncAttempts:e.syncAttempts,maxAttempts:this.MAX_SYNC_ATTEMPTS,isStockError:i,saleTimestamp:e.timestamp,isOnline:navigator.onLine}),i||console.error(`‚ùå [OfflineSaleSync] Sale ${n.substring(0,20)}... failed after ${this.MAX_SYNC_ATTEMPTS} attempts:`,l)),{success:!1,error:l}}}async syncAllPendingSales(){if(!navigator.onLine)return console.log("‚ÑπÔ∏è [OfflineSaleSync] Offline, skipping sync"),{synced:0,failed:0};this.cleanupOldSyncedSales();const n=this.getOfflineSales(),s=n.filter(a=>!a.synced&&a.syncAttempts<this.MAX_SYNC_ATTEMPTS),e=n.filter(a=>!a.synced&&a.syncAttempts>=this.MAX_SYNC_ATTEMPTS),t=e.filter(a=>a.error&&(a.error.includes("Insufficient stock")||a.error.includes("stock"))).length;if(s.length===0&&e.length===0)return{synced:0,failed:0};s.length>0&&console.log(`üîÑ [OfflineSaleSync] Syncing ${s.length} pending sale(s)...`);let l=0,i=0,r=0;for(const a of s){const o=await this.syncSale(a.id);o.success?l++:(i++,o.error&&(o.error.includes("Insufficient stock")||o.error.includes("stock"))&&r++)}if(s.length>0||e.length>0&&t===e.length)if(l>0&&i===0&&e.length===0)console.log(`‚úÖ [OfflineSaleSync] All ${l} sale(s) synced successfully`);else if(l>0){const a=r>0?` (${r} stock-related)`:"",o=e.length>0?`, ${e.length} already at max attempts`:"";console.log(`‚úÖ [OfflineSaleSync] Sync complete: ${l} synced, ${i} failed${a}${o}`)}else if(i>0)if(r===i){const a=e.length>0?` (${e.length} already at max attempts)`:"";console.log(`‚ÑπÔ∏è [OfflineSaleSync] ${i} sale(s) failed to sync (all stock-related)${a}. Stock changed between offline sale and sync.`)}else console.log(`‚ÑπÔ∏è [OfflineSaleSync] ${i} sale(s) failed to sync. Will retry automatically.`);else e.length>0&&t===e.length&&console.log(`‚ÑπÔ∏è [OfflineSaleSync] ${e.length} sale(s) already at max sync attempts (stock-related). Stock changed between offline sale and sync.`);return{synced:l,failed:i}}async cleanupOldSyncedSales(){if(this.isCleaningUp)return;const n=Date.now();if(!(n-this.lastCleanupTime<this.CLEANUP_INTERVAL))try{this.isCleaningUp=!0;const s=this.getOfflineSales(),e=this.cleanupOldSales(s);if(e.length<s.length){const t=s.length-e.length,l=this.limitSalesCount(e);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(l)),this.lastCleanupTime=n,console.log(`üßπ [OfflineSaleSync] Cleaned up ${t} old synced sales`)}else this.lastCleanupTime=n}catch(s){console.warn("‚ö†Ô∏è [OfflineSaleSync] Cleanup error:",s),await c.logCacheError("offlineSaleSyncService","cleanupOldSyncedSales",s,"delete",{salesCount:this.getOfflineSales().length,lastCleanupTime:this.lastCleanupTime})}finally{this.isCleaningUp=!1}}startAutoSync(){this.syncInterval||(this.cleanupOldSyncedSales(),this.onlineHandler=()=>{console.log("üì∂ [OfflineSaleSync] Device came online, syncing pending sales..."),setTimeout(()=>{this.syncAllPendingSales().catch(n=>{console.warn("‚ö†Ô∏è [OfflineSaleSync] Online sync error:",n)})},1e3)},window.addEventListener("online",this.onlineHandler),this.syncInterval=setInterval(()=>{navigator.onLine&&(this.cleanupOldSyncedSales(),setTimeout(()=>{this.syncAllPendingSales().catch(n=>{console.warn("‚ö†Ô∏è [OfflineSaleSync] Auto sync error:",n)})},100))},this.SYNC_INTERVAL),console.log("‚úÖ [OfflineSaleSync] Auto sync started"))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),console.log("‚úÖ [OfflineSaleSync] Auto sync stopped")}getOfflineSales(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):[]}catch{return[]}}getPendingSalesCount(){return this.getOfflineSales().filter(n=>!n.synced).length}saveOfflineSales(n){if(!this.isCleaningUp)try{const s=Date.now(),e=s-this.lastCleanupTime>this.CLEANUP_INTERVAL;let t=n;e&&(t=this.cleanupOldSales(n),this.lastCleanupTime=s),t=this.limitSalesCount(t);const l=JSON.stringify(t),i=5*1024*1024;if(l.length>i){console.warn("‚ö†Ô∏è [OfflineSaleSync] Data size approaching limit, cleaning up more aggressively...");const r=this.aggressiveCleanup(t),a=JSON.stringify(r);if(a.length>i){const o=this.emergencyCleanup(r);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(o)),console.warn("‚ö†Ô∏è [OfflineSaleSync] Emergency cleanup performed - kept only most recent unsynced sales");return}localStorage.setItem(this.STORAGE_KEY,a);return}localStorage.setItem(this.STORAGE_KEY,l)}catch(s){if(s instanceof DOMException&&s.name==="QuotaExceededError"){console.error("‚ùå [OfflineSaleSync] QuotaExceededError - performing emergency cleanup..."),this.isCleaningUp=!0;try{const e=this.emergencyCleanup(n);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),console.warn("‚ö†Ô∏è [OfflineSaleSync] Emergency cleanup completed - some old sales may have been removed")}catch(e){console.error("‚ùå [OfflineSaleSync] Emergency cleanup also failed:",e);const t=n.filter(l=>!l.synced);try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.warn("‚ö†Ô∏è [OfflineSaleSync] Removed all synced sales to free space")}catch(l){console.error("‚ùå [OfflineSaleSync] Failed to save even after cleanup:",l)}}finally{this.isCleaningUp=!1}}else console.error("‚ùå [OfflineSaleSync] Failed to save offline sales:",s),c.logCacheError("offlineSaleSyncService","saveOfflineSales",s,"save",{salesCount:n.length,isCleaningUp:this.isCleaningUp}).catch(e=>console.error("Failed to log error:",e))}}cleanupOldSales(n){const s=Date.now();return n.filter(e=>e.synced?s-e.timestamp<this.CLEANUP_AGE_MS:!0)}limitSalesCount(n){if(n.length<=this.MAX_OFFLINE_SALES)return n;const s=[...n].sort((r,a)=>a.timestamp-r.timestamp),e=s.filter(r=>!r.synced),t=s.filter(r=>r.synced),l=Math.min(this.MAX_OFFLINE_SALES,s.length),i=Math.max(0,l-e.length);return[...e,...t.slice(0,i)]}aggressiveCleanup(n){const s=Date.now()-864e5,e=n.filter(t=>t.synced?t.timestamp>s:!0);if(e.length>50){const t=[...e].sort((r,a)=>a.timestamp-r.timestamp),l=t.filter(r=>!r.synced),i=t.filter(r=>r.synced);return[...l,...i.slice(0,Math.max(0,50-l.length))]}return e}emergencyCleanup(n){return n.filter(t=>!t.synced).sort((t,l)=>l.timestamp-t.timestamp).slice(0,50)}updateOfflineSale(n){const s=this.getOfflineSales(),e=s.findIndex(t=>t.id===n.id);e!==-1&&(s[e]=n,this.saveOfflineSales(s))}removeOfflineSale(n){const e=this.getOfflineSales().filter(t=>t.id!==n);this.saveOfflineSales(e)}clearAllOfflineSales(){localStorage.removeItem(this.STORAGE_KEY),console.log("‚úÖ [OfflineSaleSync] All offline sales cleared")}}const O=new S;export{O as offlineSaleSyncService};
