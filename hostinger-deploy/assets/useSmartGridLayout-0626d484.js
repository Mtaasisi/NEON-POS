import{r as b}from"./vendor-36d2c7c1.js";import{s as A,u as Q}from"./index-61458a34.js";import{z as L}from"./ui-28e30067.js";const _=async e=>{var l,i;let t=0;const r=3;for(;t<r;)try{const{data:u,error:o}=await A.from("user_settings").select("id").limit(1);if(o){if(console.log("âš ï¸ User settings table not accessible:",o.message),o.code==="42P01")return console.log("ðŸ“‹ User settings table not found, please run the database setup script"),console.log("ðŸ“‹ You can run: create-user-settings-final.sql in your Supabase SQL editor"),null;if(o.code==="42710")console.log("âš ï¸ Trigger conflict detected, this is expected and can be ignored");else return o.code==="42601"?(console.log("âš ï¸ SQL syntax error detected, please run the final setup script"),console.log("ðŸ“‹ You can run: create-user-settings-final.sql in your Supabase SQL editor"),null):o.code==="42P10"?(console.log("âš ï¸ Constraint error detected - duplicate user_id found"),console.log("ðŸ“‹ You can run: fix-user-settings-existing.sql to fix existing data"),null):o.code==="23505"?(console.log("âš ï¸ Unique constraint violation - duplicate user_id found"),console.log("ðŸ“‹ You can run: fix-user-settings-existing.sql to fix existing data"),null):(console.log("ðŸ”’ User settings table access blocked by RLS or permissions"),console.log("ðŸ“‹ Error details:",o.message),null)}const{data:a,error:d}=await A.from("user_settings").select("*").eq("user_id",e).single();if(d){if((d.code==="406"||(l=d.message)!=null&&l.includes("406"))&&(console.log(`âš ï¸ 406 error on attempt ${t+1}, retrying...`),t++,t<r)){await new Promise(n=>setTimeout(n,1e3*t));continue}if(d.code==="PGRST116")return console.log("ðŸ“ No user settings found for user, will create defaults"),null;throw d}return(a==null?void 0:a.settings)||null}catch(u){if(t>=r-1)return console.error("Error loading user settings:",u),(i=u.message)!=null&&i.includes("406")||console.log("User settings not available, using defaults"),null;t++,await new Promise(o=>setTimeout(o,1e3*t))}return null},ee=async(e,t,r)=>{var u,o;let l=0;const i=3;for(;l<i;)try{const{error:a}=await A.from("user_settings").upsert({user_id:e,settings:t,updated_at:new Date().toISOString()});if(a){if((a.code==="406"||(u=a.message)!=null&&u.includes("406"))&&(console.log(`âš ï¸ 406 error on save attempt ${l+1}, retrying...`),l++,l<i)){await new Promise(d=>setTimeout(d,1e3*l));continue}if(a.code==="42P01")return console.log("ðŸ“‹ User settings table not found, please run the database setup script"),console.log("ðŸ“‹ You can run: create-user-settings-simple.sql in your Supabase SQL editor"),!1;if(a.code==="42710"){console.log("âš ï¸ Trigger conflict detected, this is expected and can be ignored");continue}throw a}return r&&L.success(`${r} settings saved successfully`),!0}catch(a){if(l>=i-1)return console.error("Error saving user settings:",a),(o=a.message)!=null&&o.includes("406")?console.log("Settings saved locally (sync will retry)"):L.error("Failed to save settings"),!1;l++,await new Promise(d=>setTimeout(d,1e3*l))}return!1},I={revenueTrendChart:!0,deviceStatusChart:!0,appointmentsTrendChart:!0,stockLevelChart:!0,performanceMetricsChart:!0,customerActivityChart:!0,salesFunnelChart:!0,purchaseOrderChart:!0,paymentMethodsChart:!0,salesByCategoryChart:!0,profitMarginChart:!0,appointmentWidget:!0,employeeWidget:!0,notificationWidget:!0,financialWidget:!0,analyticsWidget:!0,serviceWidget:!0,reminderWidget:!0,customerInsightsWidget:!0,systemHealthWidget:!0,inventoryWidget:!0,activityFeedWidget:!0,purchaseOrderWidget:!0,chatWidget:!0,salesWidget:!0,topProductsWidget:!0,expensesWidget:!0,staffPerformanceWidget:!0,tradeInWidget:!0,installmentsWidget:!0,loyaltyWidget:!0,smsWidget:!0,sparePartsWidget:!0,storageRoomsWidget:!0,stockTransfersWidget:!0,specialOrdersWidget:!0,backupWidget:!0,repairWidget:!0,aiInsightsWidget:!0,predictiveAnalyticsWidget:!0,alertSystemWidget:!0},T={revenueTrendChart:!1,deviceStatusChart:!0,appointmentsTrendChart:!0,stockLevelChart:!0,performanceMetricsChart:!0,customerActivityChart:!1,salesFunnelChart:!1,purchaseOrderChart:!1,paymentMethodsChart:!1,salesByCategoryChart:!1,profitMarginChart:!1,appointmentWidget:!0,employeeWidget:!1,notificationWidget:!0,financialWidget:!1,analyticsWidget:!0,serviceWidget:!0,reminderWidget:!0,customerInsightsWidget:!1,systemHealthWidget:!0,inventoryWidget:!0,activityFeedWidget:!0,purchaseOrderWidget:!1,chatWidget:!0,salesWidget:!1,topProductsWidget:!1,expensesWidget:!1,staffPerformanceWidget:!1,tradeInWidget:!0,installmentsWidget:!1,loyaltyWidget:!1,smsWidget:!1,sparePartsWidget:!0,storageRoomsWidget:!0,stockTransfersWidget:!0,specialOrdersWidget:!1,backupWidget:!1,repairWidget:!0,aiInsightsWidget:!1,predictiveAnalyticsWidget:!1,alertSystemWidget:!0},O={revenueTrendChart:!1,deviceStatusChart:!0,appointmentsTrendChart:!0,stockLevelChart:!1,performanceMetricsChart:!0,customerActivityChart:!0,salesFunnelChart:!1,purchaseOrderChart:!1,paymentMethodsChart:!0,salesByCategoryChart:!1,profitMarginChart:!1,appointmentWidget:!0,employeeWidget:!1,notificationWidget:!0,financialWidget:!1,analyticsWidget:!0,serviceWidget:!0,reminderWidget:!0,customerInsightsWidget:!0,systemHealthWidget:!1,inventoryWidget:!1,activityFeedWidget:!0,purchaseOrderWidget:!1,chatWidget:!0,salesWidget:!0,topProductsWidget:!0,expensesWidget:!1,staffPerformanceWidget:!1},E={devices:!0,addDevice:!0,customers:!0,inventory:!0,appointments:!0,purchaseOrders:!0,payments:!0,adGenerator:!0,pos:!0,reports:!0,employees:!0,whatsapp:!0,settings:!0,search:!0,loyalty:!0,backup:!0,sms:!0,bulkSms:!0,smsLogs:!0,smsSettings:!0,excelImport:!0,excelTemplates:!0,productExport:!0,customerImport:!0,userManagement:!0,databaseSetup:!0,integrationSettings:!0,integrationsTest:!0,aiTraining:!0,bluetoothPrinter:!0,categoryManagement:!0,supplierManagement:!0,storeLocations:!0,reminders:!0,mobile:!0,myAttendance:!0},P={devices:!0,addDevice:!0,customers:!0,inventory:!0,appointments:!0,purchaseOrders:!1,payments:!1,adGenerator:!1,pos:!1,reports:!0,employees:!1,whatsapp:!0,settings:!1,search:!0,loyalty:!1,backup:!1,sms:!0,bulkSms:!1,smsLogs:!0,smsSettings:!1,excelImport:!1,excelTemplates:!1,productExport:!1,customerImport:!1,userManagement:!1,databaseSetup:!1,integrationSettings:!1,integrationsTest:!1,aiTraining:!1,bluetoothPrinter:!0,categoryManagement:!1,supplierManagement:!1,storeLocations:!1,reminders:!0,mobile:!0,myAttendance:!0},z={revenueTrendChart:!1,deviceStatusChart:!1,appointmentsTrendChart:!1,stockLevelChart:!0,performanceMetricsChart:!1,customerActivityChart:!1,salesFunnelChart:!1,purchaseOrderChart:!0,paymentMethodsChart:!1,salesByCategoryChart:!1,profitMarginChart:!1,appointmentWidget:!1,employeeWidget:!1,notificationWidget:!0,financialWidget:!1,analyticsWidget:!1,serviceWidget:!1,reminderWidget:!1,customerInsightsWidget:!1,systemHealthWidget:!1,inventoryWidget:!0,activityFeedWidget:!0,purchaseOrderWidget:!0,chatWidget:!1,salesWidget:!1,topProductsWidget:!0,expensesWidget:!1,staffPerformanceWidget:!1,tradeInWidget:!1,installmentsWidget:!1,loyaltyWidget:!1,smsWidget:!1,sparePartsWidget:!0,storageRoomsWidget:!0,stockTransfersWidget:!0,specialOrdersWidget:!1,backupWidget:!1,repairWidget:!1,aiInsightsWidget:!1,predictiveAnalyticsWidget:!1,alertSystemWidget:!0},G={devices:!1,addDevice:!1,customers:!1,inventory:!0,appointments:!1,purchaseOrders:!0,payments:!1,adGenerator:!1,pos:!1,reports:!0,employees:!1,whatsapp:!1,settings:!1,search:!0,loyalty:!1,backup:!1,sms:!1,bulkSms:!1,smsLogs:!1,smsSettings:!1,excelImport:!1,excelTemplates:!1,productExport:!0,customerImport:!1,userManagement:!1,databaseSetup:!1,integrationSettings:!1,integrationsTest:!1,aiTraining:!1,bluetoothPrinter:!1,categoryManagement:!1,supplierManagement:!1,storeLocations:!1,reminders:!1,mobile:!0,myAttendance:!0},$={devices:!0,addDevice:!0,customers:!0,inventory:!1,appointments:!0,purchaseOrders:!1,payments:!0,adGenerator:!1,pos:!0,reports:!0,employees:!1,whatsapp:!0,settings:!1,search:!0,loyalty:!0,backup:!1,sms:!0,bulkSms:!0,smsLogs:!0,smsSettings:!1,excelImport:!1,excelTemplates:!1,productExport:!1,customerImport:!0,userManagement:!1,databaseSetup:!1,integrationSettings:!1,integrationsTest:!1,aiTraining:!1,bluetoothPrinter:!0,categoryManagement:!1,supplierManagement:!1,storeLocations:!1,reminders:!0,mobile:!0,myAttendance:!0},B={admin:I,technician:T,"customer-care":O,manager:I,sales:O,"store-keeper":z,user:T},H={admin:E,technician:P,"customer-care":$,manager:E,sales:$,"store-keeper":G,user:P};function M(e){return B[e]||T}function R(e){return H[e]||P}function K(e,t){return M(t)[e]??!1}function Y(e,t){return R(t)[e]??!1}function te(e){switch(e){case"admin":return"Admin Dashboard";case"technician":return"Technician Dashboard";case"customer-care":return"Customer Care Dashboard";case"manager":return"Manager Dashboard";case"sales":return"Sales Dashboard";case"store-keeper":return"Store Keeper Dashboard";default:return"Dashboard"}}function se(e,t){const r=t?`Welcome back, ${t}`:"Welcome back";switch(e){case"admin":return`${r} - Full system access`;case"technician":return`${r} - Manage repairs`;case"customer-care":return`${r} - Manage customers and support`;case"manager":return`${r} - Oversee operations`;case"sales":return`${r} - Track sales and customers`;case"store-keeper":return`${r} - Manage inventory and stock`;default:return r}}const y={quickActions:{devices:!0,addDevice:!0,customers:!0,inventory:!0,appointments:!0,purchaseOrders:!0,payments:!1,adGenerator:!1,pos:!1,reports:!1,employees:!1,whatsapp:!1,settings:!1,search:!1,loyalty:!1,backup:!1,sms:!1,bulkSms:!1,smsLogs:!1,smsSettings:!1,excelImport:!1,excelTemplates:!1,productExport:!1,customerImport:!1,userManagement:!1,databaseSetup:!1,integrationSettings:!1,integrationsTest:!1,aiTraining:!1,bluetoothPrinter:!1,categoryManagement:!1,supplierManagement:!1,storeLocations:!1,reminders:!1,mobile:!1,myAttendance:!1},widgets:{revenueTrendChart:!0,deviceStatusChart:!0,appointmentsTrendChart:!0,stockLevelChart:!0,performanceMetricsChart:!0,customerActivityChart:!0,salesFunnelChart:!0,purchaseOrderChart:!0,appointmentWidget:!0,employeeWidget:!0,notificationWidget:!0,financialWidget:!0,analyticsWidget:!0,serviceWidget:!0,reminderWidget:!0,customerInsightsWidget:!0,systemHealthWidget:!0,inventoryWidget:!0,activityFeedWidget:!0,purchaseOrderWidget:!0,chatWidget:!0,salesWidget:!0,topProductsWidget:!0,expensesWidget:!0,staffPerformanceWidget:!0,paymentMethodsChart:!0,salesByCategoryChart:!0,profitMarginChart:!0,tradeInWidget:!0,installmentsWidget:!0,loyaltyWidget:!0,smsWidget:!0,sparePartsWidget:!0,storageRoomsWidget:!0,stockTransfersWidget:!0,specialOrdersWidget:!0,backupWidget:!0,repairWidget:!0,aiInsightsWidget:!0,predictiveAnalyticsWidget:!0,alertSystemWidget:!0},widgetSizes:{predictiveAnalyticsWidget:"medium",revenueTrendChart:"medium"},widgetRowSpans:{},autoArrange:!1};function j(){const{currentUser:e}=Q(),[t,r]=b.useState(y),[l,i]=b.useState(!0),[u,o]=b.useState(0),a=async()=>{if(!(e!=null&&e.id)){i(!1);return}try{i(!0);const s=await _(e.id),c=M(e.role),W=R(e.role),S={quickActions:{...y.quickActions,...W},widgets:{...y.widgets,...c}};if(s!=null&&s.dashboard){const q={quickActions:Object.keys(S.quickActions).reduce((C,k)=>{const p=k;return C[p]=S.quickActions[p]&&(s.dashboard.quickActions[p]??!0),C},{}),widgets:Object.keys(S.widgets).reduce((C,k)=>{const p=k;return C[p]=S.widgets[p]&&(s.dashboard.widgets[p]??!0),C},{}),widgetSizes:s.dashboard.widgetSizes||{},widgetRowSpans:s.dashboard.widgetRowSpans||{},autoArrange:s.dashboard.autoArrange??!1};r(q)}else r(S)}catch(s){if(console.error("Error loading dashboard settings:",s),e!=null&&e.role){const c=M(e.role),W=R(e.role);r({quickActions:{...y.quickActions,...W},widgets:{...y.widgets,...c}})}else r(y)}finally{i(!1)}};b.useEffect(()=>{a()},[e==null?void 0:e.id,u]),b.useEffect(()=>{const s=()=>{console.log("Dashboard settings changed, reloading..."),o(c=>c+1)};return window.addEventListener("dashboardSettingsChanged",s),()=>{window.removeEventListener("dashboardSettingsChanged",s)}},[]);const d=s=>!(e!=null&&e.role)||!Y(s,e.role)?!1:t.quickActions[s],n=s=>!(e!=null&&e.role)||!K(s,e.role)?!1:t.widgets[s],g=()=>Object.entries(t.quickActions).filter(([s,c])=>c).map(([s])=>s),f=()=>Object.entries(t.widgets).filter(([s,c])=>c).map(([s])=>s),m=()=>{a()},h=s=>{var c,W;return s==="predictiveAnalyticsWidget"||s==="revenueTrendChart"?((c=t.widgetSizes)==null?void 0:c[s])||"medium":((W=t.widgetSizes)==null?void 0:W[s])||"small"},v=s=>{switch(h(s)){case"small":return 1;case"medium":return 2;case"large":return 3;default:return 2}},w=s=>{var c;return((c=t.widgetRowSpans)==null?void 0:c[s])||"single"};return{dashboardSettings:t,loading:l,isQuickActionEnabled:d,isWidgetEnabled:n,getEnabledQuickActions:g,getEnabledWidgets:f,refreshSettings:m,getWidgetSize:h,getWidgetColumnSpan:v,getWidgetRowSpan:w,getWidgetRowSpanClass:s=>w(s)==="double"?"md:row-span-2":"",getAutoArrange:()=>t.autoArrange??!1}}function F(e,t=3){const r=e.filter(i=>i.enabled);if(r.length===0)return{gridTemplateColumns:`repeat(${t}, 1fr)`,widgets:[]};const l=r.reduce((i,u)=>i+u.columnSpan,0);if(l===t)return{gridTemplateColumns:`repeat(${t}, 1fr)`,widgets:r.map(i=>({key:i.key,gridColumn:`span ${i.columnSpan}`}))};if(l<t){const i=t-l;return N(r,t,i)}if(l>t){const i=[];let u=[],o=0;const a=[...r].sort((n,g)=>n.priority!==void 0&&g.priority!==void 0?g.priority-n.priority:n.columnSpan-g.columnSpan);for(const n of a)o+n.columnSpan<=t?(u.push(n),o+=n.columnSpan):(u.length>0&&i.push([...u]),u=[n],o=n.columnSpan);u.length>0&&i.push(u);const d=i[0]||[];return{gridTemplateColumns:`repeat(${t}, 1fr)`,widgets:d.map(n=>({key:n.key,gridColumn:`span ${n.columnSpan}`}))}}return{gridTemplateColumns:`repeat(${t}, 1fr)`,widgets:r.map(i=>({key:i.key,gridColumn:`span ${i.columnSpan}`}))}}function N(e,t,r){const l={gridTemplateColumns:`repeat(${t}, 1fr)`,widgets:[]};if(e.length===1)return l.widgets.push({key:e[0].key,gridColumn:`span ${t}`,expanded:e[0].columnSpan<t}),l;for(let i=0;i<e.length;i++){const u=e[i];if(i===e.length-1&&r>0){const a=u.columnSpan+r;l.widgets.push({key:u.key,gridColumn:`span ${a}`,expanded:!0})}else l.widgets.push({key:u.key,gridColumn:`span ${u.columnSpan}`,expanded:!1})}return l}function D(e){return{appointmentWidget:10,notificationWidget:9,salesWidget:8,financialWidget:7,customerInsightsWidget:6,employeeWidget:5,serviceWidget:4,inventoryWidget:3,systemHealthWidget:2,reminderWidget:1,chatWidget:1,activityFeedWidget:1,revenueTrendChart:5,deviceStatusChart:4,appointmentsTrendChart:4,purchaseOrderChart:3,paymentMethodsChart:3,salesByCategoryChart:3,profitMarginChart:3,performanceMetricsChart:4,customerActivityChart:4,salesFunnelChart:3,analyticsWidget:2,topProductsWidget:2,expensesWidget:2,purchaseOrderWidget:2,staffPerformanceWidget:1}[e]||0}function J(e,t="lg"){const r={sm:1,md:2,lg:3,xl:4}[t];return F(e,r)}function re(){const{isWidgetEnabled:e,getWidgetColumnSpan:t,getAutoArrange:r}=j();return{createSmartLayout:(o,a=3)=>{const d=o.map(n=>({key:n,enabled:e(n),columnSpan:t(n),priority:D(n)}));return F(d,a)},createResponsiveLayout:(o,a="lg")=>{const d=o.map(n=>({key:n,enabled:e(n),columnSpan:t(n),priority:D(n)}));return J(d,a)},autoArrangeWidgets:o=>{const a=o.filter(g=>e(g)),d=r();if(a.length===0)return{gridTemplateColumns:"repeat(3, 1fr)",widgets:[]};const n=a.reduce((g,f)=>g+t(f),0);if(d&&n<3){const g=3-n,f=[];if(a.length===1)f.push({key:a[0],gridColumn:"span 3",expanded:t(a[0])<3});else for(let m=0;m<a.length;m++){const h=a[m],v=t(h);if(m===a.length-1&&g>0){const x=v+g;f.push({key:h,gridColumn:`span ${x}`,expanded:!0})}else f.push({key:h,gridColumn:`span ${v}`,expanded:!1})}return{gridTemplateColumns:"repeat(3, 1fr)",widgets:f}}return{gridTemplateColumns:"repeat(3, 1fr)",widgets:a.map(g=>({key:g,gridColumn:`span ${t(g)}`,expanded:!1}))}}}}export{R as a,j as b,te as c,se as d,M as g,_ as l,ee as s,re as u};
