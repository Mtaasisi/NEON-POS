import{j as e,G as N,s as j}from"./index-61458a34.js";import{r as x}from"./vendor-36d2c7c1.js";import{h as V,aw as ae,D as le,b$ as W,N as M,v as ne,n as h,c as oe,Y as ce,an as de,b as ie}from"./ui-28e30067.js";import{s as me}from"./storeLocationApi-1725ef86.js";import{d as xe,a as he}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";const H="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),p=d=>Math.max(1,H.indexOf((d||"A").toUpperCase())+1),ue=d=>H[(d-1)%26]||String(d),$=(d,b,t)=>`${d}${(b||"A").toUpperCase()}${t}`,m=(d,b)=>{if(d.row_number&&d.column_number)return{rowLetter:ue(d.row_number),col:d.column_number};const t=d.code||"",_=(b||"").toUpperCase(),f=t.toUpperCase().startsWith(_)?t.slice(_.length):t,C=f.slice(0,1)||"A",c=Number(f.slice(1))||d.column_number||1;return{rowLetter:C,col:c}},pe=(d,b)=>{if(!b.length)return h.error("Hakuna data ya ku-export");const t=Object.keys(b[0]),_=y=>{if(y==null)return"";const g=String(y);return g.includes(",")||g.includes('"')||g.includes(`
`)?`"${g.replace(/"/g,'""')}"`:g},f=[t.join(","),...b.map(y=>t.map(g=>_(y[g])).join(","))].join(`
`),C=new Blob([f],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(C),v=document.createElement("a");v.href=c,v.setAttribute("download",d),document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(c),h.success("CSV imetengenezwa")},fe=()=>{const{id:d}=xe(),b=he(),[t,_]=x.useState(null),[f,C]=x.useState(null),[c,v]=x.useState([]),[y,g]=x.useState(!0),[A,Y]=x.useState(""),[R,q]=x.useState(""),[U,X]=x.useState(!1),[u,z]=x.useState({row_letter:"A",column_number:1}),[L,E]=x.useState([]),[T,B]=x.useState(!1),[I,G]=x.useState(new Set);x.useEffect(()=>{(async()=>{if(!d){h.error("Missing room id");return}g(!0);try{if(!j)throw new Error("Database connection not available");const{data:r,error:a}=await j.from("lats_store_rooms").select("*").eq("id",d).single();if(a)throw a;_(r);try{const o=await me.getById(r.store_location_id);C(o||null)}catch{if(j){const{data:o}=await j.from("lats_store_locations").select("*").eq("id",r.store_location_id).maybeSingle();C(o||null)}}const{data:l,error:n}=await j.from("lats_store_shelves").select("*").eq("storage_room_id",d).order("priority_order",{ascending:!0}).order("row_number",{ascending:!0}).order("column_number",{ascending:!0});if(n)throw n;v(l||[])}catch(r){console.error(r),h.error("Failed to load room details")}finally{g(!1)}})()},[d]);const D=x.useMemo(()=>{const s=new Set;return c.forEach(r=>{const{rowLetter:a}=m(r,t==null?void 0:t.code);s.add(a)}),Array.from(s).sort((r,a)=>p(r)-p(a))},[c,t==null?void 0:t.code]),F=x.useMemo(()=>{let s=c;if(R&&(s=s.filter(r=>m(r,t==null?void 0:t.code).rowLetter===R)),A.trim()){const r=A.trim().toLowerCase();s=s.filter(a=>a.code.toLowerCase().includes(r)||(a.name||"").toLowerCase().includes(r))}return[...s].sort((r,a)=>{const l=m(r,t==null?void 0:t.code),n=m(a,t==null?void 0:t.code);return l.rowLetter===n.rowLetter?(l.col||0)-(n.col||0):p(l.rowLetter)-p(n.rowLetter)})},[c,R,A,t==null?void 0:t.code]),S=x.useMemo(()=>{if(!t)return[];const s=[],r=new Set;return c.forEach(a=>{if(r.has(a.id))return;const{rowLetter:l,col:n}=m(a,t.code);p(l);const o=c.filter(i=>m(i,t.code).rowLetter===l);if(o.length>0){const i=Math.max(...o.map(k=>m(k,t.code).col||0)),w=Math.min(...o.map(k=>m(k,t.code).col||0)),O=o.length>0?1:0,te=i-w+1,re=1,P=`${l}-${w}-${i}`;s.push({id:P,rows:O,columns:te,quantity:re,shelves:o,collapsed:I.has(P),startRow:l,endRow:l,startCol:w,endCol:i}),o.forEach(k=>r.add(k.id))}}),s.sort((a,l)=>p(a.startRow)-p(l.startRow))},[c,t,I]),J=s=>{G(r=>{const a=new Set(r);return a.has(s)?a.delete(s):a.add(s),a})},K=async()=>{if(!t||!f)return;if(!u.row_letter||!u.column_number)return h.error("Weka row letter na column number");const s=$(t.code,u.row_letter,u.column_number);if(c.some(n=>n.code===s))return h.error("Shelf hii tayari ipo");const r={store_location_id:t.store_location_id,storage_room_id:t.id,name:`Shelf ${u.row_letter}${u.column_number}`,code:s,shelf_type:"standard",row_number:p(u.row_letter),column_number:u.column_number,floor_level:t.floor_level||1,is_active:!0,is_accessible:!0,requires_ladder:!1,is_refrigerated:!1,priority_order:(p(u.row_letter)-1)*100+u.column_number};if(!j)throw new Error("Database connection not available");const{data:a,error:l}=await j.from("lats_store_shelves").insert(r).select("*").single();if(l){console.error(l),h.error("Imeshindikana kuongeza shelf");return}v(n=>[...n,a]),X(!1),h.success("Shelf imeongezwa")},Q=async s=>{if(!confirm(`Futa shelf ${s.code}?`))return;if(!j)throw new Error("Database connection not available");const{error:r}=await j.from("lats_store_shelves").delete().eq("id",s.id);if(r)return console.error(r),h.error("Imeshindikana kufuta shelf");v(a=>a.filter(l=>l.id!==s.id)),h.success("Imefutwa")},Z=async()=>{if(!t)return;if(!L.length)return h.error("Ongeza angalau row moja");const s=new Set(c.map(n=>n.code)),r=[];if(L.forEach(n=>{const o=(n.row_letter||"A").toUpperCase();for(let i=1;i<=Math.max(1,n.columns||1);i++){const w=$(t.code,o,i);s.has(w)||r.push({store_location_id:t.store_location_id,storage_room_id:t.id,name:`Shelf ${o}${i}`,code:w,shelf_type:"standard",row_number:p(o),column_number:i,floor_level:t.floor_level||1,is_active:!0,is_accessible:!0,requires_ladder:!1,is_refrigerated:!1,priority_order:(p(o)-1)*100+i})}}),!r.length)return h("Hakuna shelf mpya za kuunda (zipo tayari)",{icon:"ℹ️"});if(!j)throw new Error("Database connection not available");const{data:a,error:l}=await j.from("lats_store_shelves").insert(r).select("*");if(l)return console.error(l),h.error("Imeshindikana kutengeneza shelves");v(n=>[...n,...a]),B(!1),h.success(`Shelves ${r.length} zimeundwa`)},ee=x.useMemo(()=>{const s=new Map;return c.forEach(r=>{const{rowLetter:a}=m(r,t==null?void 0:t.code);s.set(a,(s.get(a)||0)+1)}),Array.from(s.entries()).sort((r,a)=>p(r[0])-p(a[0])).map(([r,a])=>({row:r,count:a}))},[c,t==null?void 0:t.code]),se=s=>{let r=0;return c.forEach(a=>{const l=m(a,t==null?void 0:t.code);l.rowLetter===s&&(r=Math.max(r,l.col||0))}),r};return y?e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"animate-pulse text-gray-500",children:"Loading room details..."})}):t?e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(N,{onClick:()=>b(-1),variant:"secondary",children:[e.jsx(V,{className:"w-4 h-4 mr-2"})," Back"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-6 h-6 text-blue-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xl font-semibold text-gray-900",children:[t.name," ",e.jsx("span",{className:"text-gray-400",children:"•"})," ",t.code]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(f==null?void 0:f.name)||"—"," "," · "," Floor ",t.floor_level||1," "," · ",c.length," shelves"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{onClick:()=>pe(`shelves_${t.code}.csv`,c.map(s=>({id:s.id,shelf_code:s.code,shelf_name:s.name,row:m(s,t.code).rowLetter,column:m(s,t.code).col,floor_level:s.floor_level??"",type:s.shelf_type??"",is_active:s.is_active?"yes":"no"}))),variant:"secondary",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Export CSV"]}),e.jsxs(N,{onClick:()=>B(s=>!s),variant:"secondary",children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),T?"Close Generator":"Generate Layout"]}),e.jsxs(N,{onClick:()=>X(s=>!s),className:"bg-blue-600 text-white",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),U?"Close Add":"Add Shelf"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Store Location"}),e.jsx("div",{className:"text-sm font-medium",children:(f==null?void 0:f.name)||"—"})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Floor Level"}),e.jsx("div",{className:"text-sm font-medium",children:t.floor_level||1})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Total Shelves"}),e.jsx("div",{className:"text-sm font-medium",children:c.length})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Shelf Groups"}),e.jsxs("div",{className:"text-sm font-medium",children:[S.length,e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",S.filter(s=>!s.collapsed).length," expanded)"]})]})]}),e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Total Positions"}),e.jsx("div",{className:"text-sm font-medium",children:S.reduce((s,r)=>s+r.rows*r.columns*r.quantity,0)})]})]}),T&&e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"Shelf Layout Generator"}),e.jsxs(N,{onClick:()=>E(s=>[...s,{row_letter:"A",columns:1}]),variant:"secondary",children:[e.jsx(M,{className:"w-4 h-4 mr-2"})," Add Row"]})]}),L.length?e.jsxs("div",{className:"space-y-2",children:[L.map((s,r)=>e.jsxs("div",{className:"p-3 rounded-lg border bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Row ",s.row_letter," • ",s.columns," columns"]}),e.jsx("button",{onClick:()=>E(a=>a.filter((l,n)=>n!==r)),className:"text-xs text-red-600 hover:underline",children:"Remove"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Row Letter"}),e.jsx("input",{value:s.row_letter,maxLength:1,onChange:a=>{const l=a.target.value.toUpperCase().slice(0,1)||"A";E(n=>n.map((o,i)=>i===r?{...o,row_letter:l}:o))},className:"w-16 px-2 py-1 text-sm border rounded"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Columns"}),e.jsx("input",{type:"number",min:1,max:100,value:s.columns,onChange:a=>{const l=Math.max(1,Math.min(100,Number(a.target.value)||1));E(n=>n.map((o,i)=>i===r?{...o,columns:l}:o))},className:"w-24 px-2 py-1 text-sm border rounded"})]})]})]},r)),e.jsx("div",{children:e.jsxs(N,{onClick:Z,className:"bg-purple-600 text-white",children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),"Generate Shelves"]})})]}):e.jsx("div",{className:"p-3 rounded-lg border text-sm text-gray-500 text-center",children:'No rows yet. Click "Add Row".'})]}),U&&e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-3",children:"Add Shelf"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Row Letter"}),e.jsx("input",{value:u.row_letter,maxLength:1,onChange:s=>z(r=>({...r,row_letter:s.target.value.toUpperCase().slice(0,1)||"A"})),className:"w-full px-3 py-2 border rounded-lg",placeholder:"A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Column Number"}),e.jsx("input",{type:"number",min:1,value:u.column_number,onChange:s=>z(r=>({...r,column_number:Math.max(1,parseInt(s.target.value)||1)})),className:"w-full px-3 py-2 border rounded-lg",placeholder:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Auto Code"}),e.jsx("input",{disabled:!0,className:"w-full px-3 py-2 border rounded-lg bg-gray-50",value:$(t.code,u.row_letter||"A",u.column_number||1)})]})]}),e.jsx("div",{className:"mt-3",children:e.jsxs(N,{onClick:K,className:"bg-green-600 text-white",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Save Shelf"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("div",{className:"relative w-full md:w-80",children:[e.jsx(ne,{className:"w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{value:A,onChange:s=>Y(s.target.value),placeholder:"Search code or name…",className:"w-full pl-9 pr-3 py-2 border rounded-lg"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto",children:[e.jsx("button",{onClick:()=>q(""),className:`px-3 py-1 rounded-lg border text-sm ${R?"bg-white":"bg-gray-900 text-white border-gray-900"}`,children:"All Rows"}),D.map(s=>{var r;return e.jsxs("button",{onClick:()=>q(s),className:`px-3 py-1 rounded-lg border text-sm ${R===s?"bg-blue-600 text-white border-blue-600":"bg-white"}`,children:["Row ",s," ",e.jsxs("span",{className:"ml-1 text-gray-500",children:["(",((r=ee.find(a=>a.row===s))==null?void 0:r.count)||0,")"]})]},s)})]})]}),e.jsxs("div",{className:"rounded-xl border overflow-hidden bg-white",children:[e.jsx("div",{className:"px-4 py-3 border-b text-sm font-medium text-gray-700",children:"Shelves"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-left",children:[e.jsx("th",{className:"px-4 py-2",children:"Code"}),e.jsx("th",{className:"px-4 py-2",children:"Name"}),e.jsx("th",{className:"px-4 py-2",children:"Row"}),e.jsx("th",{className:"px-4 py-2",children:"Column"}),e.jsx("th",{className:"px-4 py-2",children:"Type"}),e.jsx("th",{className:"px-4 py-2",children:"Active"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Actions"})]})}),e.jsx("tbody",{children:F.length?F.map(s=>{const{rowLetter:r,col:a}=m(s,t.code);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-2 font-mono",children:s.code}),e.jsx("td",{className:"px-4 py-2",children:s.name}),e.jsx("td",{className:"px-4 py-2",children:r}),e.jsx("td",{className:"px-4 py-2",children:a}),e.jsx("td",{className:"px-4 py-2",children:s.shelf_type||"—"}),e.jsx("td",{className:"px-4 py-2",children:s.is_active?"Yes":"No"}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(s.code),h.success("Code copied")},className:"p-2 rounded-lg border hover:bg-gray-50",title:"Copy code",children:e.jsx(oe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Q(s),className:"p-2 rounded-lg border hover:bg-red-50 text-red-600 border-red-200",title:"Delete",children:e.jsx(ce,{className:"w-4 h-4"})})]})})]},s.id)}):e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-gray-500",colSpan:7,children:"No shelves match your filter."})})})]})})]}),S.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Shelf Groups"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:()=>G(new Set),variant:"secondary",size:"sm",className:"text-xs",children:"Expand All"}),e.jsx(N,{onClick:()=>G(new Set(S.map(s=>s.id))),variant:"secondary",size:"sm",className:"text-xs",children:"Collapse All"})]})]}),e.jsx("div",{className:"grid gap-4",children:S.map(s=>e.jsxs("div",{className:"p-4 rounded-xl border bg-white shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>J(s.id),className:"p-1 hover:bg-gray-100 rounded transition-colors",children:s.collapsed?e.jsx(de,{className:"w-4 h-4 text-gray-500"}):e.jsx(ie,{className:"w-4 h-4 text-gray-500"})}),e.jsxs("div",{className:"font-medium",children:["Row ",s.startRow,": ",s.columns," columns × ",s.quantity," quantity",e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(",(t==null?void 0:t.code)||"XX",s.startRow,s.startCol," - ",(t==null?void 0:t.code)||"XX",s.endRow,s.endCol,")"]})]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.shelves.length," shelves"]})]}),s.collapsed&&e.jsxs("div",{className:"text-xs text-gray-500 bg-gray-50 p-2 rounded flex items-center justify-between border-l-4 border-blue-200",children:[e.jsxs("span",{children:["Positions: ",(t==null?void 0:t.code)||"XX",s.startRow,s.startCol," to ",(t==null?void 0:t.code)||"XX",s.endRow,s.endCol]}),e.jsx("span",{className:"text-blue-500 font-medium",children:"Click to expand"})]}),!s.collapsed&&e.jsxs("div",{className:"space-y-3",children:[s.rows<=6&&s.columns<=8&&e.jsx("div",{className:"inline-block border rounded p-2 bg-gray-50",children:Array.from({length:s.rows},(r,a)=>e.jsx("div",{className:"flex gap-1 mb-1",children:Array.from({length:s.columns},(l,n)=>{const o=s.startCol+n,i=s.shelves.find(w=>m(w,t==null?void 0:t.code).col===o);return e.jsxs("div",{className:`w-8 h-6 border text-xs flex items-center justify-center ${i?"bg-blue-50 border-blue-200 text-blue-700":"bg-white text-gray-400"}`,children:[(t==null?void 0:t.code)||"XX",s.startRow,o,s.quantity>1&&e.jsxs("span",{className:"text-[10px] text-blue-500",children:["×",s.quantity]})]},n)})},a))}),e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("div",{className:"font-medium mb-2",children:"Shelf Details:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:s.shelves.map(r=>e.jsxs("div",{className:"p-2 bg-gray-50 rounded border text-center",children:[e.jsx("div",{className:"font-mono text-xs",children:r.code}),e.jsx("div",{className:"text-[10px] text-gray-500",children:r.code})]},r.id))})]})]})]},s.id))})]}),D.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Row Preview"}),e.jsx("div",{className:"grid gap-4",children:D.map(s=>{const r=se(s),a=c.filter(l=>m(l,t.code).rowLetter===s).sort((l,n)=>(m(l,t.code).col||0)-(m(n,t.code).col||0));return e.jsxs("div",{className:"p-3 rounded-xl border bg-white",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"font-medium",children:["Row ",s," (",a.length," / ",r,")"]})}),e.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:`repeat(${Math.max(1,r)}, minmax(0, 1fr))`},children:Array.from({length:r}).map((l,n)=>{const o=a.find(w=>(m(w,t.code).col||0)===n+1),i=o?o.code:$(t.code,s,n+1);return e.jsx("div",{className:`h-12 rounded-lg border flex items-center justify-center text-xs font-mono ${o?"bg-blue-50 border-blue-200 text-blue-700":"bg-gray-50 text-gray-400"}`,title:o?"Existing shelf":"Empty slot",children:i},n)})})]},s)})})]})]}):e.jsxs("div",{className:"p-6",children:[e.jsxs(N,{onClick:()=>b(-1),variant:"secondary",children:[e.jsx(V,{className:"w-4 h-4 mr-2"})," Back"]}),e.jsx("div",{className:"mt-4 text-red-600",children:"Room not found."})]})},ye=fe;export{ye as default};
