import{u as M,j as e,s as o}from"./index-61458a34.js";import{r as y}from"./vendor-36d2c7c1.js";import{aL as N,az as Z,X as W,aF as H,e as F,r as z,y as Q,G as X,n as l}from"./ui-28e30067.js";import{G as $}from"./GlassInput-0475021a.js";const V=({accounts:p,defaultSourceAccount:j,onClose:b,onSuccess:w})=>{const{currentUser:v}=M(),[r,f]=y.useState({sourceAccountId:(j==null?void 0:j.id)||"",destinationAccountId:"",amount:"",description:"",reference:""}),[h,_]=y.useState(!1),[i,B]=y.useState(!1),[a,m]=y.useState({frequency:"monthly",startDate:new Date().toISOString().split("T")[0],endDate:"",autoExecute:!0,notificationEnabled:!0,notificationDaysBefore:1}),s=p.find(t=>t.id===r.sourceAccountId),n=p.find(t=>t.id===r.destinationAccountId),R=p.filter(t=>t.id!==r.sourceAccountId),O=p.filter(t=>t.id!==r.destinationAccountId),P=async t=>{if(t.preventDefault(),!r.sourceAccountId){l.error("Please select a source account");return}if(!r.destinationAccountId){l.error("Please select a destination account");return}if(r.sourceAccountId===r.destinationAccountId){l.error("Source and destination accounts must be different");return}const c=parseFloat(r.amount);if(!r.amount||isNaN(c)||c<=0){l.error("Please enter a valid amount");return}if(!i&&(!s||c>(s.balance||0))){l.error("Insufficient balance in source account");return}if(!r.description||r.description.trim()===""){l.error("Please enter a description");return}if(i){if(!a.startDate){l.error("Please select a start date");return}if(a.endDate&&a.endDate<a.startDate){l.error("End date must be after start date");return}}_(!0);try{i?await G(c):await L(c)}catch(x){console.error("Error processing transfer:",x),l.error(x.message||"Failed to process transfer")}finally{_(!1)}},L=async t=>{const{data:c,error:x}=await o.from("finance_accounts").select("balance, name, currency").eq("id",r.sourceAccountId).single();if(x)throw x;const{data:u,error:D}=await o.from("finance_accounts").select("balance, name, currency").eq("id",r.destinationAccountId).single();if(D)throw D;const g=Number(c.balance)||0,S=Number(u.balance)||0;if(t>g){l.error("Insufficient balance in source account");return}const I=g-t,E=S+t,A=r.reference||`TRF-${Date.now().toString(36).toUpperCase()}`,{error:k}=await o.from("finance_accounts").update({balance:I,updated_at:new Date().toISOString()}).eq("id",r.sourceAccountId);if(k)throw k;const{error:T}=await o.from("finance_accounts").update({balance:E,updated_at:new Date().toISOString()}).eq("id",r.destinationAccountId);if(T)throw await o.from("finance_accounts").update({balance:g}).eq("id",r.sourceAccountId),T;const{error:q}=await o.from("account_transactions").insert({account_id:r.sourceAccountId,transaction_type:"transfer_out",amount:t,balance_before:g,balance_after:I,description:`Transfer to ${u.name}: ${r.description}`,reference_number:A,metadata:{transfer:!0,transfer_type:"outgoing",destination_account_id:r.destinationAccountId,destination_account_name:u.name,destination_currency:u.currency},created_at:new Date().toISOString()});q&&console.warn("Failed to create source transaction:",q);const{error:C}=await o.from("account_transactions").insert({account_id:r.destinationAccountId,transaction_type:"transfer_in",amount:t,balance_before:S,balance_after:E,description:`Transfer from ${c.name}: ${r.description}`,reference_number:A,metadata:{transfer:!0,transfer_type:"incoming",source_account_id:r.sourceAccountId,source_account_name:c.name,source_currency:c.currency},created_at:new Date().toISOString()});C&&console.warn("Failed to create destination transaction:",C),l.success(`Successfully transferred ${new Intl.NumberFormat("en-TZ",{style:"currency",currency:c.currency||"TZS"}).format(t)}`),w(),b()},G=async t=>{new Date(a.startDate);const c=a.startDate,{data:x,error:u}=await o.from("scheduled_transfers").insert({source_account_id:r.sourceAccountId,destination_account_id:r.destinationAccountId,amount:t,description:r.description,reference_prefix:r.reference||"SCHED-TRF",frequency:a.frequency,start_date:a.startDate,end_date:a.endDate||null,next_execution_date:c,auto_execute:a.autoExecute,notification_enabled:a.notificationEnabled,notification_days_before:a.notificationDaysBefore,is_active:!0,execution_count:0,created_by:v==null?void 0:v.id,metadata:{source_account_name:s==null?void 0:s.name,destination_account_name:n==null?void 0:n.name,currency:s==null?void 0:s.currency}}).select().single();if(u)throw u;l.success(`Scheduled ${a.frequency} transfer created successfully! First execution: ${a.startDate}`),w(),b()},d=(t,c="TZS")=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:c,minimumFractionDigits:0,maximumFractionDigits:0}).format(t);return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-t-2xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[i?e.jsx(N,{size:24}):e.jsx(Z,{size:24}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:i?"Schedule Recurring Transfer":"Transfer Between Accounts"}),e.jsx("p",{className:"text-purple-100 text-sm",children:i?"Set up automatic recurring transfers":"Move money from one account to another"})]})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-white/20 rounded-lg transition-all",disabled:h,children:e.jsx(W,{size:20})})]})}),e.jsxs("form",{onSubmit:P,className:"p-6 space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["From Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:r.sourceAccountId,onChange:t=>f({...r,sourceAccountId:t.target.value}),required:!0,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white",children:[e.jsx("option",{value:"",children:"Select source account"}),O.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",d(t.balance||0,t.currency),")"]},t.id))]}),s&&e.jsxs("div",{className:"mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Available Balance"}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:d(s.balance||0,s.currency)})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["To Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:r.destinationAccountId,onChange:t=>f({...r,destinationAccountId:t.target.value}),required:!0,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white",children:[e.jsx("option",{value:"",children:"Select destination account"}),R.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",d(t.balance||0,t.currency),")"]},t.id))]}),n&&e.jsxs("div",{className:"mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Current Balance"}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:d(n.balance||0,n.currency)})]})]})]}),s&&n&&e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.currency})]}),e.jsx(H,{className:"text-purple-600 mx-4",size:24}),e.jsxs("div",{className:"flex-1 text-right",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:n.name}),e.jsx("div",{className:"text-xs text-gray-500",children:n.currency})]})]}),s.currency!==n.currency&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-amber-700 text-sm bg-amber-50 p-2 rounded-lg",children:[e.jsx(F,{size:16}),e.jsxs("span",{children:["Currency mismatch: ",s.currency," → ",n.currency]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Transfer Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx($,{type:"number",value:r.amount,onChange:t=>f({...r,amount:t.target.value}),placeholder:"0.00",step:"0.01",min:"0",required:!0}),r.amount&&s&&parseFloat(r.amount)>(s.balance||0)&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-red-600 text-sm",children:[e.jsx(F,{size:16}),e.jsx("span",{children:"Insufficient balance in source account"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Description ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:r.description,onChange:t=>f({...r,description:t.target.value}),placeholder:"Reason for transfer...",required:!0,rows:2,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number (Optional)"}),e.jsx($,{value:r.reference,onChange:t=>f({...r,reference:t.target.value}),placeholder:"Auto-generated if blank"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"text-purple-600",size:20}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:"Schedule Recurring Transfer"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Set up automatic recurring transfers"})]})]}),e.jsx("button",{type:"button",onClick:()=>B(!i),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${i?"bg-purple-600":"bg-gray-200"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${i?"translate-x-6":"translate-x-1"}`})})]}),i&&e.jsxs("div",{className:"space-y-4 bg-purple-50 rounded-xl p-4 border border-purple-200",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Frequency ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:a.frequency,onChange:t=>m({...a,frequency:t.target.value}),required:i,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white",children:[e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"biweekly",children:"Bi-weekly (Every 2 weeks)"}),e.jsx("option",{value:"monthly",children:"Monthly"}),e.jsx("option",{value:"quarterly",children:"Quarterly (Every 3 months)"}),e.jsx("option",{value:"yearly",children:"Yearly"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Start Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),e.jsx("input",{type:"date",value:a.startDate,onChange:t=>m({...a,startDate:t.target.value}),min:new Date().toISOString().split("T")[0],required:i,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"End Date (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),e.jsx("input",{type:"date",value:a.endDate,onChange:t=>m({...a,endDate:t.target.value}),min:a.startDate,className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white"})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Leave empty for indefinite"})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:"Auto-Execute"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Automatically process transfers on schedule"})]}),e.jsx("button",{type:"button",onClick:()=>m({...a,autoExecute:!a.autoExecute}),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${a.autoExecute?"bg-green-600":"bg-gray-200"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${a.autoExecute?"translate-x-6":"translate-x-1"}`})})]}),e.jsx("div",{className:"flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:"Notifications"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Get notified before transfers"})]}),e.jsx("button",{type:"button",onClick:()=>m({...a,notificationEnabled:!a.notificationEnabled}),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${a.notificationEnabled?"bg-blue-600":"bg-gray-200"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${a.notificationEnabled?"translate-x-6":"translate-x-1"}`})})]}),a.notificationEnabled&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Days before transfer:"}),e.jsx("input",{type:"number",min:"0",max:"30",value:a.notificationDaysBefore,onChange:t=>m({...a,notificationDaysBefore:parseInt(t.target.value)||1}),className:"w-24 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/30 focus:border-purple-500 bg-white"})]})]})}),e.jsxs("div",{className:"bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-4 border border-purple-200",children:[e.jsxs("div",{className:"text-sm font-medium text-purple-900 mb-2 flex items-center gap-2",children:[e.jsx(Q,{size:16}),"Schedule Summary"]}),e.jsxs("div",{className:"space-y-1 text-sm text-purple-800",children:[e.jsxs("div",{children:["• Transfer will occur ",e.jsx("span",{className:"font-bold",children:a.frequency})]}),e.jsxs("div",{children:["• Starting from ",e.jsx("span",{className:"font-bold",children:new Date(a.startDate).toLocaleDateString()})]}),a.endDate&&e.jsxs("div",{children:["• Ending on ",e.jsx("span",{className:"font-bold",children:new Date(a.endDate).toLocaleDateString()})]}),!a.endDate&&e.jsx("div",{children:"• No end date (will continue indefinitely)"}),a.autoExecute?e.jsx("div",{className:"text-green-700",children:"✓ Will execute automatically"}):e.jsx("div",{className:"text-amber-700",children:"⚠ Requires manual approval"})]})]})]})]}),r.amount&&s&&n&&parseFloat(r.amount)>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-blue-900 mb-2",children:"Transfer Summary"}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-blue-700",children:"Amount to transfer:"}),e.jsx("span",{className:"font-bold text-blue-900",children:d(parseFloat(r.amount),s.currency)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-blue-700",children:[s.name," new balance:"]}),e.jsx("span",{className:"font-bold text-blue-900",children:d(Math.max(0,(s.balance||0)-parseFloat(r.amount)),s.currency)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-blue-700",children:[n.name," new balance:"]}),e.jsx("span",{className:"font-bold text-blue-900",children:d((n.balance||0)+parseFloat(r.amount),n.currency)})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:b,disabled:h,className:"flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium disabled:opacity-50",children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:h,className:"flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:opacity-90 transition-all font-medium flex items-center justify-center gap-2 disabled:opacity-50",children:[i?e.jsx(N,{size:16}):e.jsx(X,{size:16}),h?"Processing...":i?"Create Schedule":"Transfer Now"]})]})]})]})})};export{V as T};
