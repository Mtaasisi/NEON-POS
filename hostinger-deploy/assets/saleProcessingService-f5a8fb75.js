import{_ as E}from"./supabase-cf010ec4.js";import{s as _,aq as oe,ar as ae,as as se}from"./index-61458a34.js";import{n as ne}from"./ui-28e30067.js";const ie=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,F=X=>typeof X=="string"&&ie.test(X),Z=class V{async ensureAuthentication(){try{const{data:{user:e},error:r}=await _.auth.getUser();if(e&&!r)return V.authWarningLogged||console.log("‚úÖ User authenticated via Supabase Auth:",e.email),{success:!0,user:e};const n=localStorage.getItem("user");if(n)try{const o=JSON.parse(n);return V.authWarningLogged||console.log("‚úÖ User authenticated via localStorage:",o.email),{success:!0,user:{email:o.email,id:o.id||"system",user_metadata:{name:o.name||o.email}}}}catch{V.authWarningLogged||console.warn("‚ö†Ô∏è Could not parse stored user")}return V.authWarningLogged||(console.debug("‚ÑπÔ∏è No authentication found, using system user (this is normal for offline sync operations)"),V.authWarningLogged=!0),{success:!0,user:{email:"system@neon.direct",id:"system",user_metadata:{name:"System User"}}}}catch(e){return V.authWarningLogged||(console.debug("‚ÑπÔ∏è Authentication check error, using system user fallback:",e),V.authWarningLogged=!0),{success:!0,user:{email:"system@neon.direct",id:"system",user_metadata:{name:"System User"}}}}}async checkStockAvailability(e,r){try{if(!F(e))return{available:!1,availableStock:0,error:"Invalid variant ID format"};const{workflowOptimizationService:n}=await E(()=>import("./workflowOptimizationService-863010fe.js"),["assets/workflowOptimizationService-863010fe.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/customerCacheService-9b459c09.js"]);let o=await n.getVariantFast(e);if(!o){const{data:m,error:v}=await _.from("lats_product_variants").select("id, quantity, is_parent, variant_type, parent_variant_id, is_active").eq("id",e).maybeSingle();o=m||null}const{data:d,error:s}=await _.from("inventory_items").select("id, status, product_id, variant_id").eq("id",e).maybeSingle();if(!o&&!d)return{available:!1,availableStock:0,error:"Variant not found"};if(d&&!o)return d.status!=="available"?{available:!1,availableStock:0,error:`Item is not available for sale (status: ${d.status})`}:r>1?{available:!1,availableStock:1,error:"Serial number devices can only be sold one at a time"}:{available:!0,availableStock:1};if(!o)return{available:!1,availableStock:0,error:"Variant not found"};if(o.is_active===!1)return{available:!1,availableStock:0,error:"Variant is not active"};let i=o.quantity||0;if(o.is_parent||o.variant_type==="parent"){const{data:m}=await _.from("lats_product_variants").select("quantity").eq("parent_variant_id",e).eq("is_active",!0),v=(m==null?void 0:m.reduce((h,w)=>h+(w.quantity||0),0))||0;v>0?i=v:i=o.quantity||0}return i<r?{available:!1,availableStock:i,error:`Insufficient stock. Available: ${i}, Requested: ${r}`}:{available:!0,availableStock:i}}catch(n){return console.error("‚ùå Error checking stock availability:",n),{available:!1,availableStock:0,error:n instanceof Error?n.message:"Failed to check stock availability"}}}async checkStockAvailabilityBatch(e){const r=new Map;try{if(e.length===0)return r;const{workflowOptimizationService:n}=await E(()=>import("./workflowOptimizationService-863010fe.js"),["assets/workflowOptimizationService-863010fe.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/customerCacheService-9b459c09.js"]),o=e.filter(t=>F(t.variantId)),d=o.map(t=>t.variantId),s=await n.batchCheckStock(d);if(d.length===0)return e.forEach(t=>{F(t.variantId)||r.set(t.variantId,{available:!1,availableStock:0,error:"Invalid variant ID format"})}),r;const[i,m]=await Promise.all([_.from("lats_product_variants").select("id, quantity, is_parent, variant_type, parent_variant_id, is_active").in("id",d),_.from("inventory_items").select("id, status, product_id, variant_id").in("id",d)]),v=i.data||[],h=m.data||[],w=new Map(v.map(t=>[t.id,t])),y=new Map(h.map(t=>[t.id,t])),a=v.filter(t=>t.is_parent||t.variant_type==="parent").map(t=>t.id);let l=new Map;if(a.length>0){const{data:t}=await _.from("lats_product_variants").select("parent_variant_id, quantity").in("parent_variant_id",a).eq("is_active",!0);t==null||t.forEach(c=>{const u=c.parent_variant_id,g=l.get(u)||0;l.set(u,g+(c.quantity||0))})}for(const t of o){const c=w.get(t.variantId),u=y.get(t.variantId),g=s.get(t.variantId);if(u&&!c){if(u.status!=="available"){r.set(t.variantId,{available:!1,availableStock:0,error:`Item is not available for sale (status: ${u.status})`});continue}if(t.quantity>1){r.set(t.variantId,{available:!1,availableStock:1,error:"Serial number devices can only be sold one at a time"});continue}r.set(t.variantId,{available:!0,availableStock:1});continue}if(!c){r.set(t.variantId,{available:!1,availableStock:0,error:"Variant not found"});continue}if(c.is_active===!1){r.set(t.variantId,{available:!1,availableStock:0,error:"Variant is not active"});continue}let b=g!==void 0?g:c.quantity||0;if(c.is_parent||c.variant_type==="parent"){const S=l.get(t.variantId)||0;S>0?b=S:b=g!==void 0?g:c.quantity||0}if(b<t.quantity){r.set(t.variantId,{available:!1,availableStock:b,error:`Insufficient stock. Available: ${b}, Requested: ${t.quantity}`});continue}r.set(t.variantId,{available:!0,availableStock:b})}return e.forEach(t=>{!F(t.variantId)&&!r.has(t.variantId)&&r.set(t.variantId,{available:!1,availableStock:0,error:"Invalid variant ID format"})}),r}catch(n){return console.error("‚ùå Error in batch stock check:",n),e.forEach(o=>{r.set(o.variantId,{available:!1,availableStock:0,error:n instanceof Error?n.message:"Failed to check stock availability"})}),r}}async processSale(e,r){var n;try{console.log("üîÑ Processing sale...",{itemCount:e.items.length,total:e.total}),console.log("üîç Sale data received:",JSON.stringify(e,null,2));const{fullDatabaseDownloadService:o}=await E(()=>import("./fullDatabaseDownloadService-81aa0524.js"),["assets/fullDatabaseDownloadService-81aa0524.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/customerCacheService-9b459c09.js","assets/childVariantsCacheService-9368f4c7.js"]);if(o.isDownloaded()&&!(r!=null&&r.forceOnline))return console.log("üíæ [SaleProcessing] Offline-first mode enabled - saving locally first"),await this.processSaleOfflineFirst(e);console.log("üåê [SaleProcessing] Online mode - processing directly"),console.log("üîê Checking authentication before processing sale...");const s=await this.ensureAuthentication();if(!s.success)return console.error("‚ùå Authentication failed:",s.error),{success:!1,error:s.error||"Authentication required. Please log in to process sales."};console.log("‚úÖ User authenticated:",(n=s.user)==null?void 0:n.email);const i=!0;e.customerId||console.warn("‚ö†Ô∏è No customer selected - processing as walk-in customer");const{stockValidation:m,itemsWithCosts:v}=await this.validateStockAndCalculateCosts(e.items);if(!m.success)return{success:!1,error:m.error};const h=await this.saveSaleToDatabase({...e,items:v});if(!h.success)return{success:!1,error:h.error};const[w,y,f,a]=await Promise.allSettled([this.updateInventory(e.items,h.saleId),this.generateReceipt(h.sale),this.updateCustomerStats(e),this.linkSerialNumbers(h.saleId,e.items,e.customerId)]);return w.status==="rejected"?console.warn("‚ö†Ô∏è Sale saved but inventory update failed:",w.reason):w.value.success||console.warn("‚ö†Ô∏è Sale saved but inventory update failed:",w.value.error),y.status==="rejected"?console.warn("‚ö†Ô∏è Receipt generation failed:",y.reason):y.value.success||console.warn("‚ö†Ô∏è Receipt generation failed:",y.value.error),f.status==="rejected"?console.warn("‚ö†Ô∏è Customer stats update failed:",f.reason):f.value.success||console.warn("‚ö†Ô∏è Customer stats update failed:",f.value.error),a.status==="rejected"?console.warn("‚ö†Ô∏è Serial numbers linking failed:",a.reason):a.value.success||console.warn("‚ö†Ô∏è Serial numbers linking failed:",a.value.error),setTimeout(()=>{this.sendNotifications(h.sale).catch(l=>{console.warn("‚ö†Ô∏è Notification sending failed:",l)})},200),console.log("‚úÖ Sale processed successfully:",h.saleId),ne.success("Sale completed successfully!"),console.log("üîµ [DEBUG] SaleProcessing: Scheduling sale completion event in 50ms"),setTimeout(()=>{console.log("üîµ [DEBUG] SaleProcessing: Emitting sale.completed event now"),oe(h.sale),console.log("üîµ [DEBUG] SaleProcessing: Sale completion event emitted")},50),{success:!0,saleId:h.saleId,sale:h.sale}}catch(o){return console.error("‚ùå Error processing sale:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error occurred"}}}async validateStockAndCalculateCosts(e){try{const r=e.map(t=>t.variantId);if(r.length===0)return{stockValidation:{success:!0},itemsWithCosts:[]};const{workflowOptimizationService:n}=await E(()=>import("./workflowOptimizationService-863010fe.js"),["assets/workflowOptimizationService-863010fe.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/customerCacheService-9b459c09.js"]);await n.preloadWorkflowData(void 0,r);let o=_.from("lats_product_variants").select("id, quantity, cost_price, is_parent, variant_type, parent_variant_id, is_active, branch_id, is_shared").in("id",r);const d=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null,{data:s,error:i}=await o,{data:m,error:v}=await _.from("inventory_items").select("id, cost_price, status, product_id, variant_id").in("id",r);if(i&&(console.error("‚ùå Error fetching variant data:",i),console.error("‚ùå Full error details:",{message:i.message,details:i.details,hint:i.hint,code:i.code}),console.error("‚ùå Variant IDs requested:",r),v))return{stockValidation:{success:!1,error:`Failed to check stock and costs: ${i.message}`},itemsWithCosts:e.map(t=>({...t,costPrice:0,profit:t.totalPrice}))};const h=new Map((s==null?void 0:s.map(t=>[t.id,t]))||[]),w=new Map((m==null?void 0:m.map(t=>[t.id,t]))||[]),f=((s==null?void 0:s.filter(t=>t.is_parent||t.variant_type==="parent"))||[]).map(t=>t.id),a=new Map;if(f.length>0){const{data:t}=await _.from("lats_product_variants").select("parent_variant_id, quantity").in("parent_variant_id",f).eq("is_active",!0);t==null||t.forEach(c=>{const u=c.parent_variant_id,g=a.get(u)||0;a.set(u,g+(c.quantity||0))})}const l=[];for(const t of e){if(!F(t.variantId))return console.error("‚ùå Invalid variant ID format:",{variantId:t.variantId,productName:t.productName,productId:t.productId}),{stockValidation:{success:!1,error:`Invalid variant ID format for "${t.productName}": ${t.variantId}. Please remove this item from cart and add it again.`},itemsWithCosts:[]};const c=h.get(t.variantId),u=w.get(t.variantId);if(!c&&!u){const{data:N,error:U}=await _.from("lats_product_variants").select("id, is_active, branch_id, is_shared, variant_type").eq("id",t.variantId).maybeSingle(),{data:A,error:M}=await _.from("inventory_items").select("id, status, product_id, variant_id").eq("id",t.variantId).maybeSingle();console.error("‚ùå Variant not found during sale processing:",{variantId:t.variantId,productName:t.productName,productId:t.productId,requestedVariantIds:r,foundVariants:(s==null?void 0:s.map(B=>B.id))||[],foundInventoryItems:(m==null?void 0:m.map(B=>B.id))||[],variantCheckResult:N?"Found but filtered":"Not found",inventoryCheckResult:A?`Found (status: ${A.status})`:"Not found",variantCheckError:U==null?void 0:U.message,inventoryCheckError:M==null?void 0:M.message,currentBranchId:d});let R=`Product variant not found for "${t.productName}" (Variant ID: ${t.variantId}). `;return N?(R+=`The variant exists but may be in a different branch (branch_id: ${N.branch_id}), inactive (is_active: ${N.is_active}), or filtered by access permissions. `,d&&N.branch_id&&N.branch_id!==d&&!N.is_shared&&(R+="This variant belongs to a different branch and is not shared. ")):A?A.status!=="available"?R+=`The inventory item exists but is not available (status: ${A.status}). `:R+="The inventory item exists but may be filtered by access permissions. ":U||M?R+=`Database error: ${(U==null?void 0:U.message)||(M==null?void 0:M.message)}. `:R+="The variant may have been deleted or does not exist. ",R+="Please remove this item from cart and add it again. If the variant was deleted, you may need to select a different variant or product.",{stockValidation:{success:!1,error:R},itemsWithCosts:[]}}if(u&&!c){if(u.status!=="available")return{stockValidation:{success:!1,error:`Serial number device for ${t.productName} is not available for sale (status: ${u.status}). Please select a different device.`},itemsWithCosts:[]};if(t.quantity>1)return{stockValidation:{success:!1,error:`Cannot sell ${t.quantity} units of serial number device ${t.productName}. Each serial number device is a single unit. Please adjust quantity to 1.`},itemsWithCosts:[]};const N=u.cost_price||0,U=N*t.quantity,A=t.totalPrice-U;l.push({...t,costPrice:N,profit:A,is_legacy:!0,is_imei_child:!1});continue}let g=c.quantity;if(c.is_parent||c.variant_type==="parent"){const N=a.get(t.variantId)||0;N>0?(console.warn("‚ö†Ô∏è Attempting to sell parent variant - stock calculated from children"),g=N):(console.log("‚ÑπÔ∏è Parent variant has no children - using parent stock directly"),g=c.quantity||0)}if(g<t.quantity)return{stockValidation:{success:!1,error:`Insufficient stock for ${t.productName} (${t.variantName}). Available: ${g}, Requested: ${t.quantity}`},itemsWithCosts:[]};const b=c.cost_price||0,S=b*t.quantity,P=t.totalPrice-S;l.push({...t,costPrice:b,profit:P,is_legacy:!1,is_imei_child:c.variant_type==="imei_child"})}return{stockValidation:{success:!0},itemsWithCosts:l}}catch(r){return console.error("‚ùå Error in combined validation and calculation:",r),console.error("‚ùå Exception details:",{message:r instanceof Error?r.message:"Unknown error",stack:r instanceof Error?r.stack:void 0,error:r}),{stockValidation:{success:!1,error:`Failed to validate stock and calculate costs: ${r instanceof Error?r.message:"Unknown error"}`},itemsWithCosts:e.map(n=>({...n,costPrice:0,profit:n.totalPrice}))}}}async validateStock(e){try{const r=e.map(s=>s.variantId);if(r.length===0)return{success:!0};const{data:n,error:o}=await _.from("lats_product_variants").select("id, quantity").in("id",r);if(o)return console.error("‚ùå Error checking stock for variants:",o),{success:!1,error:"Failed to check stock availability"};const d=new Map((n==null?void 0:n.map(s=>[s.id,s.quantity]))||[]);for(const s of e){if(!F(s.variantId))return console.error("‚ùå Invalid variant ID format in stock validation:",{variantId:s.variantId,productName:s.productName}),{success:!1,error:`Invalid variant ID format for "${s.productName}": ${s.variantId}. Please remove this item from cart and add it again.`};const i=d.get(s.variantId);if(i===void 0)return console.error("‚ùå Variant not found in stock validation:",{variantId:s.variantId,productName:s.productName,requestedVariantIds:r,foundVariants:(n==null?void 0:n.map(m=>m.id))||[]}),{success:!1,error:`Product variant not found for "${s.productName}" (Variant ID: ${s.variantId}). The variant may have been deleted or is invalid. Please remove this item from cart and add it again.`};if(i<s.quantity)return{success:!1,error:`Insufficient stock for ${s.productName} (${s.variantName}). Available: ${i}, Requested: ${s.quantity}`}}return{success:!0}}catch(r){return console.error("‚ùå Error validating stock:",r),{success:!1,error:"Failed to validate stock availability"}}}async calculateCostsAndProfits(e){try{const r=e.map(i=>i.variantId);if(r.length===0)return[];const{data:n,error:o}=await _.from("lats_product_variants").select("id, cost_price").in("id",r);if(o)return console.warn("‚ö†Ô∏è Could not get cost prices for variants:",o),e.map(i=>({...i,unitPrice:i.quantity>0?i.totalPrice/i.quantity:0,costPrice:0,profit:i.totalPrice}));const d=new Map((n==null?void 0:n.map(i=>[i.id,i.cost_price||0]))||[]);return e.map(i=>{const m=d.get(i.variantId)||0,v=m*i.quantity,h=i.totalPrice-v,w=i.quantity>0?i.totalPrice/i.quantity:0;return{...i,unitPrice:w,costPrice:m,profit:h}})}catch(r){return console.error("‚ùå Error calculating costs:",r),e.map(n=>({...n,unitPrice:n.quantity>0?n.totalPrice/n.quantity:0,costPrice:0,profit:n.totalPrice}))}}async saveSaleToDatabase(e){var r,n,o,d,s,i,m,v,h,w,y,f,a,l,t,c,u;try{{const p="postgresql://postgres:[@SMASIKA!)!)]@db.jxhzveborezjhsmzsgbc.supabase.co:5432/postgres";console.log("‚úÖ Production environment detected. Database URL configured.")}const b=this.generateSaleNumber();console.log("üîê Checking authentication before sale insert...");const S=await this.ensureAuthentication();if(!S.success)return console.error("‚ùå Authentication failed:",S.error),console.error("üö® PRODUCTION AUTH ERROR:"),console.error("   User authentication failed in production environment."),console.error("   This may indicate session expiration or authentication service issue."),{success:!1,error:S.error||"Authentication required. Please log in to process sales."};console.log("‚úÖ User authenticated:",(r=S.user)==null?void 0:r.email);const P=((n=S.user)==null?void 0:n.email)||"system",N=((d=(o=S.user)==null?void 0:o.user_metadata)==null?void 0:d.name)||((i=(s=S.user)==null?void 0:s.user_metadata)==null?void 0:i.full_name)||((v=(m=S.user)==null?void 0:m.email)==null?void 0:v.split("@")[0])||"System User",U={...e.paymentMethod,amount:e.total},A=typeof e.subtotal=="string"?parseFloat(e.subtotal):e.subtotal,M=typeof e.discount=="string"?parseFloat(e.discount):e.discount,R=typeof e.tax=="string"?parseFloat(e.tax):e.tax,B=1e9,J=0;if(e.total<J||e.total>B)return console.error("‚ùå Invalid sale amount:",e.total),{success:!1,error:`Invalid sale amount: ${e.total}. Must be between ${J} and ${B}`};if(!Number.isSafeInteger(Math.round(e.total*100)))return console.error("‚ùå Sale amount exceeds JavaScript safe integer:",e.total),{success:!1,error:`Sale amount is too large: ${e.total}`};if(A!==void 0&&(A<J||A>B))return console.error("‚ùå Invalid subtotal:",A),{success:!1,error:`Invalid subtotal: ${A}`};const x=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null;console.log("üè™ [saveSale] Assigning sale to branch:",x),x||(console.warn("‚ö†Ô∏è PRODUCTION WARNING: No branch_id found in localStorage. Sale will be created without branch assignment."),console.warn("   If your database requires branch_id, this may cause a foreign key constraint error."));const K=JSON.parse(JSON.stringify(U)),Q={sale_number:b,customer_id:e.customerId||null,total_amount:e.total,payment_method:K,payment_status:e.paymentStatus||"completed",sold_by:P,branch_id:x,...A!==void 0&&!isNaN(A)&&{subtotal:A},...M!==void 0&&!isNaN(M)&&{discount:M},...e.customerName&&{customer_name:e.customerName},...e.customerPhone&&{customer_phone:e.customerPhone},...e.customerEmail&&{customer_email:e.customerEmail},...R!==void 0&&!isNaN(R)&&{tax:R},...e.notes&&{notes:e.notes}};console.log("üîç Sale insert data:",JSON.stringify(Q,null,2));let T,Y;const{data:ee,error:j}=await _.from("lats_sales").insert([Q]).select().single();if(j){const $=j.code||"",I=j.message||"",C=j.details||"",W=j.hint||"";console.error("‚ùå Error creating sale with full data:",j),console.error("‚ùå Sale insert data that failed:",JSON.stringify(Q,null,2)),console.error("‚ùå Full error details:",{message:I,details:C,hint:W,code:$}),console.error("üîç PRODUCTION DIAGNOSTICS:"),console.error("   Environment:","production"),console.error("   Database URL configured:",!0),console.error("   User authenticated:",!!S.user),console.error("   User email:",(h=S.user)==null?void 0:h.email),console.error("   Branch ID:",x),console.error("   Customer ID:",e.customerId),($==="42501"||I.includes("permission denied")||I.includes("row-level security"))&&(console.error("üö® RLS POLICY ISSUE DETECTED:"),console.error("   The database Row Level Security (RLS) policy is blocking the insert."),console.error("   Solution: Check RLS policies on lats_sales table in production database."),console.error("   Run: SELECT * FROM pg_policies WHERE tablename = 'lats_sales';")),($==="23503"||I.includes("foreign key"))&&(console.error("üö® FOREIGN KEY CONSTRAINT ISSUE:"),console.error("   A referenced record (customer_id, branch_id, etc.) does not exist."),console.error("   Check if customer_id exists:",e.customerId||"(null - walk-in customer)"),console.error("   Check if branch_id exists:",x||"(null - no branch assigned)"),x||console.error("   üí° TIP: If branch_id is required, ensure a branch is selected before creating sales."),e.customerId||console.error("   üí° TIP: This is a walk-in customer (customer_id is null). Ensure your database allows null customer_id.")),($==="23505"||I.includes("unique constraint"))&&(console.error("üö® UNIQUE CONSTRAINT ISSUE:"),console.error("   Sale number already exists:",b),console.error("   This should not happen - sale number generation may have collision.")),(I.includes("connection")||I.includes("timeout")||I.includes("network"))&&(console.error("üö® DATABASE CONNECTION ISSUE:"),console.error("   Cannot connect to database in production."),console.error("   Check VITE_DATABASE_URL environment variable."),console.error("   Verify database is accessible from production server.")),console.log("üîÑ Trying with reduced field set...");const L={sale_number:b,customer_id:e.customerId||null,total_amount:e.total,payment_method:K,payment_status:e.paymentStatus||"completed",sold_by:P,branch_id:x,...A!==void 0&&!isNaN(A)&&{subtotal:A},...M!==void 0&&!isNaN(M)&&{discount:M},...R!==void 0&&!isNaN(R)&&{tax:R},...e.customerName&&{customer_name:e.customerName},...e.customerPhone&&{customer_phone:e.customerPhone},...e.customerEmail&&{customer_email:e.customerEmail}};console.log("üîç Reduced sale insert data:",JSON.stringify(L,null,2));const{data:D,error:k}=await _.from("lats_sales").insert([L]).select().single();if(k){console.error("‚ùå Fallback insert also failed:",k);let q=`Failed to create sale: ${I}`;return $==="42501"||I.includes("permission denied")||I.includes("row-level security")?q="Sale creation failed due to database permissions. Please contact your administrator to check Row Level Security policies.":$==="23503"||I.includes("foreign key")?q="Sale creation failed: Invalid customer or branch reference. Please refresh the page and try again.":I.includes("connection")||I.includes("timeout")?q="Sale creation failed: Database connection error. Please check your internet connection and try again.":q=`Sale creation failed: ${I}. Error code: ${$||"unknown"}`,{success:!1,error:q}}console.log("‚úÖ Fallback insert succeeded"),T=D,Y=null}else T=ee,Y=null;const H=e.items.map(p=>{F(p.productId)||console.error("‚ùå Invalid product_id UUID:",p.productId),F(p.variantId)||console.error("‚ùå Invalid variant_id UUID:",p.variantId),console.log("üîç Item pricing debug:",{productId:p.productId,variantId:p.variantId,unitPrice:p.unitPrice,totalPrice:p.totalPrice,costPrice:p.costPrice,profit:p.profit});const $=typeof p.unitPrice=="string"?parseFloat(p.unitPrice):p.unitPrice||0,I=typeof p.totalPrice=="string"?parseFloat(p.totalPrice):p.totalPrice||0,C=typeof p.costPrice=="string"?parseFloat(p.costPrice):p.costPrice||0,W=typeof p.profit=="string"?parseFloat(p.profit):p.profit||0;return{sale_id:T.id,product_id:p.productId,variant_id:p.variantId,product_name:p.productName,variant_name:p.variantName,sku:p.sku,quantity:p.quantity,unit_price:$,total_price:I,cost_price:C,profit:W}});console.log("üîç Inserting sale items:",H);const{error:z}=await _.from("lats_sale_items").insert(H);if(z){const $=z.code||"",I=z.message||"";console.error("‚ùå Error creating sale items:",z),console.error("‚ùå Full error details:",{message:I,details:z.details,hint:z.hint,code:$}),console.error("‚ùå Sale items data:",H),console.error("‚ùå Sale ID:",T.id),console.error("üö® PRODUCTION SALE ITEMS ERROR:"),($==="42501"||I.includes("permission denied")||I.includes("row-level security"))&&(console.error("   RLS policy blocking sale items insert."),console.error("   Check RLS policies on lats_sale_items table.")),($==="23503"||I.includes("foreign key"))&&(console.error("   Foreign key constraint violation."),console.error("   Verify sale_id, product_id, and variant_id exist."));let C=`Sale created but items failed: ${I}`;return $==="42501"&&(C="Sale was created but items could not be saved due to database permissions. Please contact your administrator."),{success:!1,error:C,saleId:T.id}}try{const p=(y=(w=e==null?void 0:e.paymentMethod)==null?void 0:w.details)==null?void 0:y.payments,$=Array.isArray(p)?p:[{method:(f=e==null?void 0:e.paymentMethod)==null?void 0:f.type,amount:((a=e==null?void 0:e.paymentMethod)==null?void 0:a.amount)??e.total,accountId:(t=(l=e==null?void 0:e.paymentMethod)==null?void 0:l.details)==null?void 0:t.accountId,reference:(u=(c=e==null?void 0:e.paymentMethod)==null?void 0:c.details)==null?void 0:u.reference,notes:e==null?void 0:e.notes,timestamp:e==null?void 0:e.soldAt}];console.log("üí≥ Processing payment mirroring for",$.length,"payment(s)");const I=$.filter(C=>(C==null?void 0:C.amount)&&C.amount>0);if(I.length===0)console.log("‚ÑπÔ∏è  No valid payments to process");else{const C=[...new Set(I.map(k=>k.accountId).filter(Boolean))],W=new Map;if(C.length>0){const{data:k}=await _.from("finance_accounts").select("id, balance, branch_id").in("id",C);k==null||k.forEach(q=>{W.set(q.id,q)})}const L=[],D=[];for(const k of I)if(console.log(`‚ÑπÔ∏è  Payment ${k.method} - ${k.amount} will be auto-synced by database triggers`),k.accountId&&W.has(k.accountId))try{const q=W.get(k.accountId),O=q.balance||0,G=ae(O,k.amount,k.amount>0?"payment":"expense");!G.isValid&&G.warning&&console.warn(`‚ö†Ô∏è ${G.warning}`);const re=G.newBalance;L.push({id:k.accountId,balance:re,updated_at:new Date().toISOString()}),D.push({account_id:k.accountId,transaction_type:"payment_received",amount:k.amount,reference_number:b,description:`POS sale payment (${k.method||"payment"})`,branch_id:q.branch_id,metadata:{sale_id:T.id,customer_id:e.customerId},created_at:new Date().toISOString()})}catch(q){console.warn("‚ö†Ô∏è finance_accounts error:",q instanceof Error?q.message:"Unknown error")}if(L.length>0){const k=L.map(O=>_.from("finance_accounts").update({balance:O.balance,updated_at:O.updated_at}).eq("id",O.id));(await Promise.allSettled(k)).forEach((O,G)=>{O.status==="fulfilled"&&O.value.error?console.warn(`‚ö†Ô∏è Failed updating finance account ${L[G].id}:`,O.value.error.message):O.status==="fulfilled"&&console.log(`‚úÖ Finance account ${L[G].id} balance updated`)})}if(D.length>0){const{error:k}=await _.from("account_transactions").insert(D);if(k){console.warn("‚ö†Ô∏è Batch account_transactions insert failed:",k.message);for(const q of D){const{error:O}=await _.from("account_transactions").insert(q);O&&console.warn("‚ö†Ô∏è account_transactions insert failed:",O.message)}}else console.log(`‚úÖ Batch recorded ${D.length} transactions`)}}console.log("‚úÖ Payment mirroring completed (triggers will handle payment_transactions sync)")}catch(p){const $=p instanceof Error?p.message:String(p),I=p instanceof Error?p.stack:void 0;console.error("‚ùå Payment mirroring failed:",{errorType:typeof p,errorName:p==null?void 0:p.name,message:$,details:p==null?void 0:p.details,hint:p==null?void 0:p.hint,code:p==null?void 0:p.code,stack:I}),console.log("‚ÑπÔ∏è  Sale completed successfully despite payment mirroring error (database triggers will sync payments)")}const te={...e,id:T.id,saleNumber:b,soldBy:P,createdAt:T.created_at};return console.log("‚úÖ Sale saved to database:",T.id),{success:!0,saleId:T.id,sale:te}}catch(g){return console.error("‚ùå Error saving sale to database:",g),console.error("‚ùå Error details:",{message:g instanceof Error?g.message:"Unknown error",stack:g instanceof Error?g.stack:void 0,fullError:g}),{success:!1,error:g instanceof Error?g.message:"Failed to save sale to database"}}}async updateCustomerStats(e){try{if(console.log("üìä Updating customer stats (auth optional)..."),!e.customerId)return console.log("‚ÑπÔ∏è No customer ID provided, skipping customer stats update"),{success:!0};console.log("üîÑ Updating customer stats for customer:",e.customerId);const r=Math.floor(e.total/1e3);try{const n={last_visit:new Date().toISOString(),updated_at:new Date().toISOString()},{data:o}=await _.from("lats_customers").select("*").eq("id",e.customerId).single();if(o){const{parseAmount:s}=await E(()=>import("./format-aff4c6a2.js"),[]);if("total_spent"in o){const i=s(o.total_spent),m=s(e.total),v=i+m;if(v>1e12)return console.error(`‚ùå New total ${v} exceeds maximum realistic amount`),{success:!1,error:"Customer total would exceed realistic limit"};n.total_spent=Math.max(0,v),console.log(`üí∞ Updating total_spent: ${i} + ${m} = ${v}`)}if("total_orders"in o){const i=s(o.total_orders);n.total_orders=i+1}if("points"in o){const i=s(o.points);n.points=i+r}}const{error:d}=await _.from("lats_customers").update(n).eq("id",e.customerId);if(d)return console.warn("‚ö†Ô∏è Could not update customer stats:",d.message),{success:!0}}catch(n){return console.warn("‚ö†Ô∏è Customer stats update skipped:",n),{success:!0}}return console.log("‚úÖ Customer stats updated successfully"),{success:!0}}catch(r){return console.error("‚ùå Error updating customer stats:",r),{success:!1,error:"Failed to update customer stats"}}}async updateInventory(e,r){const{workflowOptimizationService:n}=await E(()=>import("./workflowOptimizationService-863010fe.js"),["assets/workflowOptimizationService-863010fe.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/customerCacheService-9b459c09.js"]);try{let o="system";try{const{data:{user:a}}=await _.auth.getUser();o=(a==null?void 0:a.id)||"system"}catch{o="system"}const d=F(o)?o:null;!d&&o!=="system"&&console.warn("‚ö†Ô∏è Invalid user ID for stock movement logging, defaulting to null:",o);const s=e.map(a=>a.variantId);if(s.length===0)return console.log("‚ÑπÔ∏è No variants to restore stock for"),{success:!0};const{data:i,error:m}=await _.from("lats_product_variants").select("id, quantity, is_parent, variant_type").in("id",s);if(m)throw new Error(`Failed to fetch current stock: ${m.message}`);const v=new Map(i.map(a=>[a.id,a])),h=e.map(async a=>{const l=v.get(a.variantId);if(!l){const{data:u,error:g}=await _.from("inventory_items").select("id, status, variant_id, product_id, metadata").eq("id",a.variantId).single();if(u){const b={...u.metadata||{},sold_at:new Date().toISOString(),...r?{sale_id:r}:{}},{error:S}=await _.from("inventory_items").update({status:"sold",metadata:b,updated_at:new Date().toISOString()}).eq("id",a.variantId);if(S)throw console.error("Error updating legacy inventory item:",S),S;let P=null;if(u.variant_id){const{data:U}=await _.from("lats_product_variants").select("id").eq("id",u.variant_id).maybeSingle();P=U?u.variant_id:null}const{error:N}=await _.from("lats_stock_movements").insert({product_id:u.product_id||null,variant_id:P,movement_type:"sale",quantity:-a.quantity,reference_type:"pos_sale",reference_id:r||null,notes:`Sold ${a.quantity} units of legacy item ${a.productName}`,created_at:new Date().toISOString()});return N&&console.warn("Failed to create stock movement for legacy item:",N),{success:!0}}throw new Error(`Item ${a.variantId} not found in variants or inventory_items`)}const t=(l==null?void 0:l.quantity)||0,c=Math.max(0,t-a.quantity);if(l!=null&&l.is_parent||(l==null||l.variant_type),(l==null?void 0:l.variant_type)==="imei_child"||a.is_legacy||a.is_imei_child){const{markIMEIAsSold:u}=await E(()=>import("./imeiVariantService-4ce4b8b1.js"),["assets/imeiVariantService-4ce4b8b1.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);return u(a.variantId,r)}return Promise.resolve({data:null,error:null})}),w=e.filter(a=>v.get(a.variantId)!==void 0).map(a=>{const l=v.get(a.variantId),t=(l==null?void 0:l.quantity)||0,c=Math.max(0,t-a.quantity);return{product_id:a.productId,variant_id:a.variantId,type:"sale",movement_type:"out",quantity:a.quantity,previous_quantity:t,new_quantity:c,reason:"Sale",reference:`Sale ${a.sku}`,reference_id:r||null,notes:`Sold ${a.quantity} units of ${a.productName} (${a.variantName})`,created_by:d}}),y=await Promise.allSettled(h.map(a=>Promise.resolve(a)));for(let a=0;a<y.length;a++){const l=y[a];if(l.status==="rejected")return console.error("‚ùå Inventory update failed for item:",e[a],l.reason),{success:!1,error:`Failed to update inventory for ${e[a].productName}`};if(l.status==="fulfilled"&&l.value.error)return console.error("‚ùå Inventory update error for item:",e[a],l.value.error),{success:!1,error:`Failed to update inventory for ${e[a].productName}`}}let f=!1;try{const{error:a}=await _.from("lats_stock_movements").insert(w);if(a){console.warn("‚ö†Ô∏è Stock movements insert failed:",a.message),f=!1,console.log("üîÑ Stock movement insert failed, falling back to direct stock update...");const l=e.filter(c=>{const u=v.get(c.variantId);return u!==void 0&&(u==null?void 0:u.variant_type)!=="imei_child"&&!c.is_legacy&&!c.is_imei_child}).map(async c=>{const{data:u,error:g}=await _.from("lats_product_variants").select("quantity").eq("id",c.variantId).single();if(g)return console.error("‚ùå Failed to fetch current stock for variant:",c.variantId,g),{success:!1,error:g.message};const b=(u==null?void 0:u.quantity)||0,S=Math.max(0,b-c.quantity);console.log(`üì¶ [Sale] Fallback: Reducing stock for variant ${c.variantId}: ${b} ‚Üí ${S} (sold ${c.quantity})`);const{error:P}=await _.from("lats_product_variants").update({quantity:S,updated_at:new Date().toISOString()}).eq("id",c.variantId);return P?(console.error("‚ùå Failed to reduce stock for variant:",c.variantId,P),{success:!1,error:P.message}):{success:!0}}),t=await Promise.allSettled(l);for(let c=0;c<t.length;c++){const u=t[c];if(u.status==="rejected")return console.error("‚ùå Stock update failed:",u.reason),{success:!1,error:`Failed to reduce stock for ${e[c].productName}`};if(u.status==="fulfilled"&&u.value.error)return console.error("‚ùå Stock update error:",u.value.error),{success:!1,error:u.value.error}}console.log("‚úÖ Stock successfully reduced via fallback method")}else console.log("‚úÖ Stock movements logged successfully - stock reduced by database trigger"),f=!0}catch(a){console.warn("‚ö†Ô∏è Stock movements tracking not enabled (table not found):",a),f=!1,console.log("üîÑ Stock movements table not found, using direct stock update...");const l=e.filter(c=>{const u=v.get(c.variantId);return u!==void 0&&(u==null?void 0:u.variant_type)!=="imei_child"&&!c.is_legacy&&!c.is_imei_child}).map(async c=>{const{data:u,error:g}=await _.from("lats_product_variants").select("quantity").eq("id",c.variantId).single();if(g)return console.error("‚ùå Failed to fetch current stock for variant:",c.variantId,g),{success:!1,error:g.message};const b=(u==null?void 0:u.quantity)||0,S=Math.max(0,b-c.quantity);console.log(`üì¶ [Sale] Direct update: Reducing stock for variant ${c.variantId}: ${b} ‚Üí ${S} (sold ${c.quantity})`);const{error:P}=await _.from("lats_product_variants").update({quantity:S,updated_at:new Date().toISOString()}).eq("id",c.variantId);return P?(console.error("‚ùå Failed to reduce stock for variant:",c.variantId,P),{success:!1,error:P.message}):{success:!0}}),t=await Promise.allSettled(l);for(let c=0;c<t.length;c++){const u=t[c];if(u.status==="rejected")return console.error("‚ùå Stock update failed:",u.reason),{success:!1,error:`Failed to reduce stock for ${e[c].productName}`};if(u.status==="fulfilled"&&u.value.error)return console.error("‚ùå Stock update error:",u.value.error),{success:!1,error:u.value.error}}console.log("‚úÖ Stock successfully reduced via direct update")}return console.log("‚úÖ Inventory updated successfully"),setTimeout(async()=>{try{const{childVariantsCacheService:a}=await E(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);a.clearCache()}catch(a){console.warn("‚ö†Ô∏è Failed to clear child variants cache:",a)}try{s.length>0&&n.invalidateStockCache(s)}catch(a){console.warn("‚ö†Ô∏è Failed to invalidate workflow cache:",a)}try{if(s.length>0){const{inventoryNotificationService:a}=await E(()=>import("./inventoryNotificationService-ca932d9a.js"),["assets/inventoryNotificationService-ca932d9a.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/inventorySettingsApi-fd100cf3.js","assets/smartNotificationService-2a2d3be1.js","assets/whatsappService-09f99080.js","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),l=await a.checkAndNotifyLowStock(s);l.notified>0&&console.log(`üì± Sent ${l.notified} low stock WhatsApp notification(s)`)}}catch(a){console.warn("‚ö†Ô∏è Failed to check/send low stock notifications:",a)}try{if(e.length>0){const a=e[0];console.log("üîµ [DEBUG] SaleProcessing: Emitting stock update event:",{productId:a.productId,variantId:a.variantId,itemCount:e.length}),se(a.productId,a.variantId,e.length),console.log("üîµ [DEBUG] SaleProcessing: Stock update event emitted")}}catch(a){console.warn("‚ö†Ô∏è [DEBUG] SaleProcessing: Failed to emit stock update:",a)}},500),{success:!0}}catch(o){return console.error("‚ùå Error updating inventory:",o),console.error("‚ùå Inventory update error details:",{message:o instanceof Error?o.message:"Unknown error",error:o}),{success:!1,error:o instanceof Error?o.message:"Failed to update inventory"}}}async linkSerialNumbers(e,r,n){try{console.log("üîó Linking serial numbers to sale...");const o=[];for(const m of r)if(m.selectedSerialNumbers&&Array.isArray(m.selectedSerialNumbers)){const v=m.selectedSerialNumbers;for(const h of v)h.id&&o.push(h.id)}if(o.length===0)return console.log("‚ÑπÔ∏è No serial numbers to link"),{success:!0};console.log(`üì¶ Linking ${o.length} serial numbers to sale ${e}`);const d=o.map(m=>({sale_id:e,inventory_item_id:m,customer_id:n||null})),{error:s}=await _.from("sale_inventory_items").insert(d);if(s)return console.error("‚ùå Error linking serial numbers:",s),{success:!1,error:s.message};const{error:i}=await _.from("inventory_items").update({status:"sold"}).in("id",o);return i?(console.error("‚ùå Error updating serial number status:",i),{success:!1,error:i.message}):(console.log("‚úÖ Serial numbers linked successfully"),{success:!0})}catch(o){return console.error("‚ùå Error in linkSerialNumbers:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async generateReceipt(e){try{console.log("üßæ Generating receipt (auth optional)...");const{businessInfoService:r}=await E(()=>import("./index-61458a34.js").then(o=>o.b7),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),n=await r.getBusinessInfo();try{const{error:o}=await _.from("lats_receipts").insert([{sale_id:e.id,receipt_number:`RCP-${e.saleNumber}`,customer_name:e.customerName||"Walk-in Customer",customer_phone:e.customerPhone||null,total_amount:e.total,payment_method:e.paymentMethod.type,items_count:e.items.length,generated_by:e.soldBy,receipt_content:{sale:e,generated_at:new Date().toISOString(),business_info:{name:n.name,address:n.address,phone:n.phone,email:n.email,website:n.website,logo:n.logo}}}]);if(o)return console.warn("‚ö†Ô∏è Could not save receipt (table may not exist):",o.message),{success:!0}}catch(o){return console.warn("‚ö†Ô∏è Receipt table not available:",o),{success:!0}}return console.log("‚úÖ Receipt generated successfully"),{success:!0}}catch(r){return console.warn("‚ö†Ô∏è Error generating receipt:",r),console.warn("‚ö†Ô∏è Receipt generation error details:",{message:r instanceof Error?r.message:"Unknown error",error:r}),{success:!0}}}async sendNotifications(e){var r,n,o,d;console.log("üîç [DEBUG] Starting notification sending process..."),console.log("üîç [DEBUG] Sale:",{saleNumber:e.saleNumber,customerName:e.customerName,customerPhone:e.customerPhone,customerEmail:e.customerEmail,total:e.total});try{if(!e.customerPhone){console.warn("‚ö†Ô∏è [DEBUG] Notification skipped: Customer has no phone number");return}console.log(`‚úÖ [DEBUG] Customer has phone number: ${e.customerPhone}`);const{notificationSettingsService:s}=await E(()=>import("./notificationSettingsService-1df2b297.js"),["assets/notificationSettingsService-1df2b297.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),i=s.getSettings();if(console.log("üîç [DEBUG] Notification settings:",{whatsappEnabled:i.whatsappEnabled,whatsappAutoSend:i.whatsappAutoSend,smsEnabled:i.smsEnabled,smsAutoSend:i.smsAutoSend}),!(i.whatsappEnabled&&i.whatsappAutoSend||i.smsEnabled&&i.smsAutoSend)){console.warn("‚ö†Ô∏è [DEBUG] Notification skipped: Auto-send is disabled"),console.warn("üí° [DEBUG] Enable auto-send in POS Settings ‚Üí Notifications");return}console.log("‚úÖ [DEBUG] Auto-send is enabled, proceeding with notification...");const{smartNotificationService:v}=await E(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]);let h="inauzwa",w="",y="";try{const{businessInfoService:b}=await E(()=>import("./index-61458a34.js").then(P=>P.b7),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),S=await b.getBusinessInfo();h=S.name||"inauzwa",w=S.phone||"",y=S.logo||""}catch{console.warn("‚ö†Ô∏è Could not load business info for notification, using defaults")}const f=typeof e.paymentMethod=="object"&&e.paymentMethod.type==="installment";let a=e.total,l=0;if(f&&e.id)try{const{supabase:b}=await E(()=>import("./index-61458a34.js").then(N=>N.b6),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),{data:S,error:P}=await b.from("customer_installment_plans").select("total_paid, balance_due, down_payment").eq("sale_id",e.id).single();!P&&S&&(a=Number(S.total_paid||S.down_payment||0),l=Number(S.balance_due||0),console.log("üìä [Invoice] Installment sale detected:",{total:e.total,paid:a,balance:l}))}catch(b){console.warn("‚ö†Ô∏è Could not fetch installment plan details, using default values:",b)}let t;e.createdAt?t=new Date(e.createdAt):e.created_at?t=new Date(e.created_at):e.soldAt?t=new Date(e.soldAt):t=new Date;let c;isNaN(t.getTime())?(c=new Date().toLocaleDateString(),console.warn("‚ö†Ô∏è Invalid sale date, using current date")):c=t.toLocaleDateString();const u={invoice_no:e.saleNumber,business_name:h,business_phone:w,business_logo:y,customer_name:e.customerName||"Customer",customer_phone:e.customerPhone,customer_email:e.customerEmail,items:e.items.map(b=>({name:`${b.productName}${b.variantName?` (${b.variantName})`:""}`,quantity:b.quantity,price:b.totalPrice})),subtotal:e.subtotal,tax:e.tax,discount:e.discount,total:e.total,paid:a,balance:l,date:c,payment_method:typeof e.paymentMethod=="object"?e.paymentMethod.type:e.paymentMethod};console.log("üîç [DEBUG] Invoice data prepared:",{invoice_no:u.invoice_no,customer_phone:u.customer_phone,customer_name:u.customer_name,total:u.total,items_count:u.items.length}),console.log("üì± [DEBUG] Attempting to send invoice via smart notification service...");const g=await v.sendInvoice(u);if(console.log("üîç [DEBUG] Notification result:",{success:g.success,method:g.method,whatsappSuccess:(r=g.whatsappResult)==null?void 0:r.success,smsSuccess:(n=g.smsResult)==null?void 0:n.success,error:g.error}),g.success){const b=g.method==="whatsapp"?"WhatsApp":"SMS";console.log(`‚úÖ [DEBUG] ${b} notification sent successfully for sale: ${e.saleNumber}`),console.log(`üì± [DEBUG] Receipt sent via ${b} to ${e.customerPhone}`),g.method==="whatsapp"?console.log("‚úÖ [SUCCESS] Customer received WhatsApp receipt!"):console.log("üì± [INFO] Customer received SMS receipt (WhatsApp not available for this number)")}else console.error("‚ùå [DEBUG] Notification sending failed:",g.error),console.error("üîç [DEBUG] Detailed error info:",{whatsappError:(o=g.whatsappResult)==null?void 0:o.error,smsError:(d=g.smsResult)==null?void 0:d.error,method:g.method}),console.warn("üí° [DEBUG] Troubleshooting:"),console.warn("   1. Is auto-send enabled in POS Settings ‚Üí Notifications?"),console.warn("   2. Is WhatsApp configured in Admin Settings ‚Üí Integrations?"),console.warn("   3. Does customer have a valid phone number?"),console.warn("   4. Check browser console for more details")}catch(s){console.error("‚ùå Error sending notifications:",s)}}async sendWhatsAppNotification(e){try{const{notificationSettingsService:r}=await E(()=>import("./notificationSettingsService-1df2b297.js"),["assets/notificationSettingsService-1df2b297.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),n=r.getSettings();if(!n.whatsappEnabled||!n.whatsappAutoSend)return;let o="inauzwa",d="",s="";try{const{businessInfoService:a}=await E(()=>import("./index-61458a34.js").then(t=>t.b7),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),l=await a.getBusinessInfo();o=l.name||"inauzwa",d=l.phone||"",s=l.logo||""}catch{console.warn("‚ö†Ô∏è Could not load business info for WhatsApp, using defaults")}const i=typeof e.paymentMethod=="object"&&e.paymentMethod.type==="installment";let m=e.total,v=0;if(i&&e.id)try{const{supabase:a}=await E(()=>import("./index-61458a34.js").then(c=>c.b6),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),{data:l,error:t}=await a.from("customer_installment_plans").select("total_paid, balance_due, down_payment").eq("sale_id",e.id).single();!t&&l&&(m=Number(l.total_paid||l.down_payment||0),v=Number(l.balance_due||0),console.log("üìä [Invoice] Installment sale detected:",{total:e.total,paid:m,balance:v}))}catch(a){console.warn("‚ö†Ô∏è Could not fetch installment plan details, using default values:",a)}let h;e.createdAt?h=new Date(e.createdAt):e.created_at?h=new Date(e.created_at):e.soldAt?h=new Date(e.soldAt):h=new Date;let w;isNaN(h.getTime())?(w=new Date().toLocaleDateString(),console.warn("‚ö†Ô∏è Invalid sale date, using current date")):w=h.toLocaleDateString();const y={invoice_no:e.saleNumber,business_name:o,business_phone:d,business_logo:s,customer_name:e.customerName||"Customer",customer_phone:e.customerPhone,customer_email:e.customerEmail,items:e.items.map(a=>({name:`${a.productName}${a.variantName?` (${a.variantName})`:""}`,quantity:a.quantity,price:a.totalPrice})),subtotal:e.subtotal,tax:e.tax,discount:e.discount,total:e.total,paid:m,balance:v,date:w,payment_method:typeof e.paymentMethod=="object"?e.paymentMethod.type:e.paymentMethod},f=await r.sendWhatsAppInvoice(y);f.success?console.log("üì± WhatsApp notification sent successfully for sale:",e.saleNumber):f.error&&(f.error.includes("not configured")||f.error.includes("disabled in settings"))||console.warn("‚ö†Ô∏è WhatsApp notification failed:",f.error)}catch{console.log("‚ÑπÔ∏è  WhatsApp notification skipped - sale completed successfully")}}async sendSMSNotification(e){try{const r=await this.generateSMSMessage(e);try{const{smsService:n}=await E(()=>import("./index-61458a34.js").then(d=>d.ba),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),o=await n.sendSMS(e.customerPhone,r);o.success?console.log("üì± SMS notification sent successfully for sale:",e.saleNumber):!(o.error&&(o.error.includes("proxy server not running")||o.error.includes("connection refused")||o.error.includes("ERR_CONNECTION_REFUSED")||o.error.includes("ECONNREFUSED")||o.error.includes("Failed to fetch")))&&o.error}catch{console.log("‚ÑπÔ∏è  SMS service not configured - sale completed without notification")}}catch{console.log("‚ÑπÔ∏è  SMS notification skipped - sale completed successfully")}}async generateSMSMessage(e){const r=e.items.map(i=>`${i.productName} x${i.quantity}`).join(", "),n=e.discount>0?`
Discount: ${this.formatMoney(e.discount)}`:"";let o="inauzwa";try{const{businessInfoService:i}=await E(()=>import("./index-61458a34.js").then(v=>v.b7),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);o=(await i.getBusinessInfo()).name||"inauzwa"}catch{console.warn("‚ö†Ô∏è Could not load business info, using default")}let d="Thank you for your purchase!",s="Thank you for choosing us!";try{const{POSSettingsService:i}=await E(()=>import("./index-61458a34.js").then(v=>v.b8),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),m=await i.loadReceiptSettings();m!=null&&m.sms_header_message&&(d=m.sms_header_message),m!=null&&m.sms_footer_message&&(s=m.sms_footer_message)}catch{console.warn("‚ö†Ô∏è Could not load SMS message settings, using defaults")}return`${o.toUpperCase()}
${"‚ïê".repeat(o.length)}
${d}
Sale #${e.saleNumber}
Items: ${r}
Total: ${this.formatMoney(e.total)}${n}
Payment: ${e.paymentMethod.type.toUpperCase()}
${s}`}formatMoney(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"TZS",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}generateSaleNumber(){const e=Date.now().toString().slice(-8),r=Math.random().toString(36).substr(2,4).toUpperCase();return`SALE-${e}-${r}`}async getSaleById(e){try{const{data:r,error:n}=await _.from("lats_sales").select("*").eq("id",e).single();if(n)return console.error("‚ùå Error fetching sale:",n),null;const{data:o}=await _.from("lats_sale_items").select("*").eq("sale_id",e);if(o&&o.length>0){const d=[...new Set(o.map(y=>y.product_id).filter(Boolean))],s=[...new Set(o.map(y=>y.variant_id).filter(Boolean))],[i,m]=await Promise.all([d.length>0?_.from("lats_products").select("id, name").in("id",d):{data:[]},s.length>0?_.from("lats_product_variants").select("id, name, variant_name, sku").in("id",s):{data:[]}]),v=new Map((i.data||[]).map(y=>[y.id,y])),h=new Map((m.data||[]).map(y=>[y.id,{...y,name:y.variant_name||y.name}]));if(d.length>0){const{data:y}=await _.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",d).order("is_primary",{ascending:!1});y&&y.forEach(f=>{const a=v.get(f.product_id);if(a){a.images||(a.images=[]);const l={id:f.id,url:f.thumbnail_url||f.image_url,thumbnailUrl:f.thumbnail_url,isPrimary:f.is_primary||!1};f.is_primary?a.images.unshift(l):a.images.push(l)}})}const w=o.map(y=>({...y,lats_products:v.get(y.product_id),lats_product_variants:h.get(y.variant_id)}));return{...r,lats_sale_items:w}}return{...r,lats_sale_items:[]}}catch(r){return console.error("‚ùå Error fetching sale:",r),null}}async getRecentSales(e=10){try{const{data:r,error:n}=await _.from("lats_sales").select("*").order("created_at",{ascending:!1}).limit(e);if(n)return console.error("‚ùå Error fetching recent sales:",n),[];if(!r||r.length===0)return[];const o=r.map(s=>s.id),{data:d}=await _.from("lats_sale_items").select("*").in("sale_id",o);if(d&&d.length>0){const s=[...new Set(d.map(f=>f.product_id).filter(Boolean))],i=[...new Set(d.map(f=>f.variant_id).filter(Boolean))],[m,v]=await Promise.all([s.length>0?_.from("lats_products").select("id, name").in("id",s):{data:[]},i.length>0?_.from("lats_product_variants").select("id, name, variant_name, sku").in("id",i):{data:[]}]),h=new Map((m.data||[]).map(f=>[f.id,f])),w=new Map((v.data||[]).map(f=>[f.id,{...f,name:f.variant_name||f.name}]));if(s.length>0){const{data:f}=await _.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",s).order("is_primary",{ascending:!1});f&&f.forEach(a=>{const l=h.get(a.product_id);if(l){l.images||(l.images=[]);const t={id:a.id,url:a.thumbnail_url||a.image_url,thumbnailUrl:a.thumbnail_url,isPrimary:a.is_primary||!1};a.is_primary?l.images.unshift(t):l.images.push(t)}})}const y=new Map;return d.forEach(f=>{y.has(f.sale_id)||y.set(f.sale_id,[]),y.get(f.sale_id).push({...f,lats_products:h.get(f.product_id),lats_product_variants:w.get(f.variant_id)})}),r.map(f=>({...f,lats_sale_items:y.get(f.id)||[]}))}return r.map(s=>({...s,lats_sale_items:[]}))}catch(r){return console.error("‚ùå Error fetching recent sales:",r),[]}}async processSaleOfflineFirst(e){try{const{offlineSaleSyncService:r}=await E(()=>import("./offlineSaleSyncService-93b9509e.js"),["assets/offlineSaleSyncService-93b9509e.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),n=await this.validateStockFromCache(e.items);if(!n.success)return{success:!1,error:n.error};console.log("üíæ [SaleProcessing] Saving sale locally for instant response...");const o=await r.saveSaleLocally(e);if(!o.success)return{success:!1,error:o.error||"Failed to save sale locally"};const d=`TEMP-${Date.now()}`;return console.log("‚úÖ [SaleProcessing] Sale saved locally, will sync in background"),navigator.onLine&&r.syncSale(o.saleId).catch(s=>{console.warn("‚ö†Ô∏è [SaleProcessing] Background sync failed, will retry:",s)}),{success:!0,saleId:o.saleId,sale:{...e,id:o.saleId,saleNumber:d,createdAt:new Date().toISOString()}}}catch(r){return console.error("‚ùå [SaleProcessing] Offline-first processing error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async validateStockFromCache(e){try{const r=localStorage.getItem("pos_stock_levels_cache");if(!r)return console.warn("‚ö†Ô∏è [SaleProcessing] No stock cache found, allowing sale (will validate on sync)"),{success:!0};const{data:n}=JSON.parse(r),o=new Map(n.map(d=>[d.id,d.quantity]));for(const d of e){const s=o.get(d.variantId)||0;if(s<d.quantity)return{success:!1,error:`Insufficient stock for ${d.productName}. Available: ${s}, Requested: ${d.quantity}`}}return{success:!0}}catch(r){return console.warn("‚ö†Ô∏è [SaleProcessing] Stock cache validation error, allowing sale:",r),{success:!0}}}};Z.authWarningLogged=!1;let ce=Z;const me=new ce;export{me as s};
