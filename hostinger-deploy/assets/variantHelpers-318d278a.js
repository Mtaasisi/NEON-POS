import{_ as b}from"./supabase-cf010ec4.js";import{s as l}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";const w=r=>!r||r.length===0?[]:r.filter(t=>t.is_parent===!0||t.variant_type==="parent"||(!t.parent_variant_id||t.parent_variant_id===null)&&t.variant_type!=="imei_child"),g=r=>{var t;return r.variant_type==="imei_child"||r.parent_variant_id!=null&&((t=r.variant_attributes)==null?void 0:t.imei)!=null},E=r=>r.is_parent===!0||r.variant_type==="parent",q=r=>E(r)||r.variant_type==="standard"&&!g(r),v=async r=>{try{const{getCurrentBranchId:t}=await b(()=>import("./index-61458a34.js").then(o=>o.bb),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),e=t();let n=null;if(e)try{const{data:o}=await l.from("store_locations").select("data_isolation_mode, share_inventory").eq("id",e).single();n=o}catch{console.warn("⚠️ [loadParentVariants] Could not fetch branch settings")}let a=l.from("lats_product_variants").select("*").eq("product_id",r).eq("is_active",!0).or("variant_type.eq.parent,variant_type.eq.standard,variant_type.is.null").is("parent_variant_id",null).order("created_at",{ascending:!0});e&&n?n.data_isolation_mode==="isolated"?a=a.eq("branch_id",e):n.data_isolation_mode==="shared"||n.data_isolation_mode==="hybrid"&&(n.share_inventory?a=a.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`):a=a.eq("branch_id",e)):e&&(a=a.or(`branch_id.eq.${e},branch_id.is.null`));const{data:d,error:c}=await a;return c?(console.error("Error loading parent variants:",c),[]):d||[]}catch(t){return console.error("Error loading parent variants:",t),[]}},M=async r=>{try{const t=await v(r);return await Promise.all(t.map(async n=>{const{count:a,error:d}=await l.from("lats_product_variants").select("id",{count:"exact",head:!0}).eq("parent_variant_id",n.id).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0);return{...n,available_imeis:d?0:a||0}}))}catch(t){return console.error("Error loading variants with child count:",t),[]}},C=async r=>{try{const{data:t,error:e}=await l.from("lats_product_variants").select("product_id").eq("id",r).single();if(e||!t)return console.error("Error loading parent variant:",e),[];const n=t.product_id,{data:a,error:d}=await l.from("lats_product_variants").select("*").eq("parent_variant_id",r).eq("variant_type","imei_child").order("created_at",{ascending:!1});d&&console.error("Error loading IMEI children:",d);const{data:c,error:o}=await l.from("inventory_items").select("*").eq("product_id",n).not("serial_number","is",null).order("created_at",{ascending:!1}).limit(100);o&&console.error("Error loading inventory items:",o),console.log(`[loadChildIMEIs] Found ${(c==null?void 0:c.length)||0} inventory items for product ${n}`);const{data:p}=await l.from("lats_product_variants").select("selling_price").eq("id",r).single(),y=(p==null?void 0:p.selling_price)||0,h=(c||[]).filter(i=>i.variant_id===r).map(i=>{const u=i.serial_number||i.imei||"Unknown",_=i.selling_price,f=_&&_>0?_:y;return{id:i.id,name:u,selling_price:f,sellingPrice:f,price:f,variant_attributes:{serial_number:u,imei:u,mac_address:i.mac_address||"",condition:i.condition||"new",location:i.location||"",status:i.status||"available"},quantity:1,is_active:i.status==="available",created_at:i.created_at,is_legacy:!0,variant_type:"imei_child",parent_variant_id:r}});console.log(`[loadChildIMEIs] Converted ${h.length} inventory items for parent ${r} (filtered from ${c.length} total)`),h.length>0&&console.log("[loadChildIMEIs] Sample legacy items:",h.slice(0,3).map(i=>{var u,_;return{id:i.id,serial:(u=i.variant_attributes)==null?void 0:u.serial_number,imei:(_=i.variant_attributes)==null?void 0:_.imei,is_active:i.is_active,quantity:i.quantity,parent_variant_id:i.parent_variant_id}}));const s=[...a||[],...h];return console.log(`[loadChildIMEIs] Total children: ${s.length} (${(a==null?void 0:a.length)||0} IMEI + ${h.length} legacy)`),console.log("[loadChildIMEIs] IMEI children IDs:",(a||[]).map(i=>i.id).slice(0,3)),console.log("[loadChildIMEIs] Legacy items IDs:",h.map(i=>i.id).slice(0,3)),s.sort((i,u)=>{const _=new Date(i.created_at||0).getTime();return new Date(u.created_at||0).getTime()-_})}catch(t){return console.error("Error loading child IMEIs:",t),[]}},$=async r=>{try{const{data:t,error:e}=await l.from("lats_product_variants").select("product_id").eq("id",r).single();if(e||!t)return console.error("Error loading parent variant:",e),[];const n=t.product_id,{data:a,error:d}=await l.from("lats_product_variants").select("*").eq("parent_variant_id",r).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0).order("created_at",{ascending:!1});d&&console.error("Error loading IMEI children:",d);const{data:c,error:o}=await l.from("inventory_items").select("*").eq("product_id",n).not("serial_number","is",null).eq("status","available").order("created_at",{ascending:!1}).limit(100);o&&console.error("Error loading inventory items:",o);const p=(c||[]).map(s=>({id:s.id,name:s.serial_number||s.imei||"Unknown",variant_attributes:{serial_number:s.serial_number||"",imei:s.imei||"",mac_address:s.mac_address||"",condition:s.condition||"new",location:s.location||"",status:s.status||"available"},quantity:1,is_active:s.status==="available",created_at:s.created_at,is_legacy:!0,variant_type:"imei_child"}));return[...a||[],...p].sort((s,I)=>{const i=new Date(s.created_at||0).getTime();return new Date(I.created_at||0).getTime()-i})}catch(t){return console.error("Error loading available child IMEIs:",t),[]}},m=async r=>{try{const{getCurrentBranchId:t}=await b(()=>import("./index-61458a34.js").then(o=>o.bb),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),e=t();let n=null;if(e)try{const{data:o}=await l.from("store_locations").select("data_isolation_mode, share_inventory").eq("id",e).single();n=o}catch{console.warn("⚠️ [calculateParentStock] Could not fetch branch settings")}let a=l.from("lats_product_variants").select("quantity, branch_id").eq("parent_variant_id",r).eq("variant_type","imei_child").eq("is_active",!0);e&&n?n.data_isolation_mode==="isolated"||n.data_isolation_mode==="hybrid"&&!n.share_inventory?a=a.eq("branch_id",e):n.data_isolation_mode==="hybrid"&&n.share_inventory&&(a=a.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`)):e&&(a=a.or(`branch_id.eq.${e},branch_id.is.null`));const{data:d,error:c}=await a;return c?(console.error("Error calculating parent stock:",c),0):(d||[]).reduce((o,p)=>o+(p.quantity||0),0)}catch(t){return console.error("Error calculating parent stock:",t),0}},k=async r=>{try{const t=await m(r),{error:e}=await l.from("lats_product_variants").update({quantity:t,updated_at:new Date().toISOString()}).eq("id",r);return e?(console.error("Error updating parent stock:",e),!1):!0}catch(t){return console.error("Error updating parent stock:",t),!1}},P=async r=>{try{const t=await v(r);let e=0;for(const n of t)if(n.is_parent||n.variant_type==="parent"){const a=await m(n.id);e+=a}else e+=n.quantity||0;return e}catch(t){return console.error("Error calculating product stock:",t),0}},V=(r,t=!1)=>{const e=r.variant_name||r.name||"Unnamed Variant";if(t&&(r.is_parent||r.variant_type==="parent")){const n=r.available_imeis||0;if(n>0)return`${e} (${n} devices)`}return e},S=r=>{var t,e;return((t=r.variant_attributes)==null?void 0:t.imei)||((e=r.variant_attributes)==null?void 0:e.serial_number)||null},D=r=>r?r.length>8?`${r.substring(0,4)}...${r.substring(r.length-4)}`:r:"N/A",T=r=>r?g(r)?{valid:!1,message:"This is already an IMEI child variant"}:q(r)?{valid:!0}:{valid:!1,message:"This variant cannot track IMEIs"}:{valid:!1,message:"Variant not found"},B=r=>{if(!r||r.trim().length===0)return{valid:!1,message:"IMEI is required"};const t=r.trim();return/^\d{15}$/.test(t)?{valid:!0}:{valid:!1,message:"IMEI must be exactly 15 digits"}},A=async r=>{try{const{error:t}=await l.from("lats_product_variants").update({is_parent:!0,variant_type:"parent",updated_at:new Date().toISOString()}).eq("id",r);return t?(console.error("Error converting to parent:",t),!1):!0}catch(t){return console.error("Error converting to parent:",t),!1}},U={filterParentVariantsOnly:w,isIMEIChild:g,isParentVariant:E,canTrackIMEIs:q,loadParentVariants:v,loadVariantsWithChildCount:M,loadChildIMEIs:C,loadAvailableChildIMEIs:$,calculateParentStock:m,updateParentStock:k,calculateProductStock:P,getVariantDisplayName:V,getVariantIMEI:S,formatIMEIForDisplay:D,validateVariantForIMEI:T,validateIMEIFormat:B,convertToParent:A};export{m as calculateParentStock,P as calculateProductStock,q as canTrackIMEIs,A as convertToParent,U as default,w as filterParentVariantsOnly,D as formatIMEIForDisplay,V as getVariantDisplayName,S as getVariantIMEI,g as isIMEIChild,E as isParentVariant,$ as loadAvailableChildIMEIs,C as loadChildIMEIs,v as loadParentVariants,M as loadVariantsWithChildCount,k as updateParentStock,B as validateIMEIFormat,T as validateVariantForIMEI,U as variantHelpers};
