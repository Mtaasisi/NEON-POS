import{s}from"./index-61458a34.js";import{n as c}from"./ui-28e30067.js";const l=h=>Array.isArray(h)?h.map(l):h!==null&&h.constructor===Object?Object.keys(h).reduce((r,e)=>{const t=e.replace(/_([a-z])/g,(o,a)=>a.toUpperCase());return r[t]=l(h[e]),r},{}):h,m=h=>Array.isArray(h)?h.map(m):h!==null&&h.constructor===Object?Object.keys(h).reduce((r,e)=>{const t=e.replace(/[A-Z]/g,o=>`_${o.toLowerCase()}`);return r[t]=m(h[e]),r},{}):h;class f{async getAllEmployees(){var r;try{const{data:e,error:t}=await s.from("employees").select("*").order("created_at",{ascending:!1});if(t)throw t;if(!e||e.length===0)return[];const o=[...new Set(e.map(n=>n.branch_id).filter(Boolean))],a=o.length>0?await s.from("store_locations").select("id, name, code, is_main").in("id",o):{data:[],error:null},d=new Map(((r=a.data)==null?void 0:r.map(n=>[n.id,n]))||[]);return l(e.map(n=>({...n,branch:n.branch_id?d.get(n.branch_id):null})))}catch(e){throw console.error("Error fetching employees:",e),c.error("Failed to load employees"),e}}async getEmployeeById(r){try{const{data:e,error:t}=await s.from("employees").select("*").eq("id",r).single();if(t)throw t;if(!e)return null;let o=null;if(e.branch_id){const{data:a}=await s.from("store_locations").select("id, name, code, is_main").eq("id",e.branch_id).single();o=a}return l({...e,branch:o})}catch(e){throw console.error("Error fetching employee:",e),c.error("Failed to load employee details"),e}}async getEmployeeByUserId(r){try{const{data:e,error:t}=await s.from("employees").select("*").eq("user_id",r).maybeSingle();if(t)throw t;return e?l(e):null}catch(e){throw console.error("Error fetching employee by user ID:",e),e}}async getActiveEmployees(){var r;try{const{data:e,error:t}=await s.from("employees").select("*").eq("status","active").order("full_name",{ascending:!0});if(t)throw t;if(!e||e.length===0)return[];const o=[...new Set(e.map(n=>n.branch_id).filter(Boolean))],a=o.length>0?await s.from("store_locations").select("id, name, code, is_main").in("id",o):{data:[],error:null},d=new Map(((r=a.data)==null?void 0:r.map(n=>[n.id,n]))||[]);return l(e.map(n=>({...n,branch:n.branch_id?d.get(n.branch_id):null})))}catch(e){throw console.error("Error fetching active employees:",e),e}}cleanEmployeeData(r){const e={...r};return Array.isArray(e.skills)&&e.skills.length===0&&(e.skills=null),Array.isArray(e.assigned_branches)&&e.assigned_branches.length===0&&(e.assigned_branches=null),e}async createEmployee(r){try{const e=this.cleanEmployeeData(m(r)),{data:t,error:o}=await s.from("employees").insert([e]).select().single();if(o)throw o;return c.success("Employee created successfully"),l(t)}catch(e){throw console.error("Error creating employee:",e),c.error(e.message||"Failed to create employee"),e}}async updateEmployee(r,e){try{const t=this.cleanEmployeeData(m(e)),{data:o,error:a}=await s.from("employees").update(t).eq("id",r).select().single();if(a)throw a;return c.success("Employee updated successfully"),l(o)}catch(t){throw console.error("Error updating employee:",t),c.error(t.message||"Failed to update employee"),t}}async deleteEmployee(r){try{const{error:e}=await s.from("employees").delete().eq("id",r);if(e)throw e;c.success("Employee deleted successfully")}catch(e){throw console.error("Error deleting employee:",e),c.error(e.message||"Failed to delete employee"),e}}async searchEmployees(r){try{const{data:e,error:t}=await s.from("employees").select("*").or(`full_name.ilike.%${r}%,email.ilike.%${r}%,role.ilike.%${r}%`).order("full_name",{ascending:!0});if(t)throw t;return l(e||[])}catch(e){throw console.error("Error searching employees:",e),e}}async getEmployeesByDepartment(r){var e;try{const{data:t,error:o}=await s.from("employees").select("*").eq("role",r).order("full_name",{ascending:!0});if(o)throw o;if(!t||t.length===0)return[];const a=[...new Set(t.map(i=>i.branch_id).filter(Boolean))],d=a.length>0?await s.from("store_locations").select("id, name, code, is_main").in("id",a):{data:[],error:null},n=new Map(((e=d.data)==null?void 0:e.map(i=>[i.id,i]))||[]);return l(t.map(i=>({...i,branch:i.branch_id?n.get(i.branch_id):null})))}catch(t){throw console.error("Error fetching employees by department:",t),t}}async getEmployeesByBranch(r){try{const{data:e,error:t}=await s.from("employees").select("*").eq("branch_id",r).order("full_name",{ascending:!0});if(t)throw t;if(!e||e.length===0)return[];const{data:o}=await s.from("store_locations").select("id, name, code, is_main").eq("id",r).single();return l(e.map(a=>({...a,branch:o})))}catch(e){throw console.error("Error fetching employees by branch:",e),e}}async assignEmployeeToBranch(r,e){try{const{data:t,error:o}=await s.from("employees").update({branch_id:e}).eq("id",r).select("*").single();if(o)throw o;const{data:a}=await s.from("store_locations").select("id, name, code, is_main").eq("id",e).single();return c.success("Employee assigned to branch successfully"),l({...t,branch:a})}catch(t){throw console.error("Error assigning employee to branch:",t),c.error(t.message||"Failed to assign employee to branch"),t}}async removeEmployeeFromBranch(r){try{const{data:e,error:t}=await s.from("employees").update({branch_id:null}).eq("id",r).select("*").single();if(t)throw t;return c.success("Employee removed from branch"),l({...e,branch:null})}catch(e){throw console.error("Error removing employee from branch:",e),c.error(e.message||"Failed to remove employee from branch"),e}}async getAllAttendanceRecords(){try{const{data:r,error:e}=await s.from("attendance_records").select("*").order("attendance_date",{ascending:!1});if(e)throw e;return l(r||[])}catch(r){throw console.error("Error fetching attendance records:",r),c.error("Failed to load attendance records"),r}}async getAttendanceByEmployeeId(r,e){try{let t=s.from("attendance_records").select("*").eq("employee_id",r).order("attendance_date",{ascending:!1});e&&(t=t.limit(e));const{data:o,error:a}=await t;if(a)throw a;return l(o||[])}catch(t){throw console.error("Error fetching employee attendance:",t),t}}async getTodayAttendance(r){try{const e=new Date().toISOString().split("T")[0],{data:t,error:o}=await s.from("attendance_records").select("*").eq("employee_id",r).eq("attendance_date",e).maybeSingle();if(o)throw o;return t?l(t):null}catch(e){throw console.error("Error fetching today's attendance:",e),e}}async checkIn(r,e,t,o){try{const a=new Date().toISOString().split("T")[0],d=new Date().toISOString(),n=await this.getTodayAttendance(r);if(n&&n.checkInTime)throw c.error("Already checked in today"),new Error("Already checked in today");const i={employee_id:r,attendance_date:a,check_in_time:d,status:"present"};(e==null?void 0:e.lat)!==void 0&&(i.check_in_location_lat=e.lat),(e==null?void 0:e.lng)!==void 0&&(i.check_in_location_lng=e.lng),t!==void 0&&(i.check_in_network_ssid=t),o!==void 0&&(i.check_in_photo_url=o);const{data:y,error:u}=await s.from("attendance_records").upsert(i).select().single();if(u)throw u;return c.success("Checked in successfully"),l(y)}catch(a){throw console.error("Error checking in:",a),c.error(a.message||"Failed to check in"),a}}async checkOut(r,e,t,o){try{const a=new Date().toISOString(),d=await this.getTodayAttendance(r);if(!d||!d.checkInTime)throw c.error("Not checked in yet"),new Error("Not checked in yet");if(d.checkOutTime)throw c.error("Already checked out today"),new Error("Already checked out today");const n={check_out_time:a};(e==null?void 0:e.lat)!==void 0&&(n.check_out_location_lat=e.lat),(e==null?void 0:e.lng)!==void 0&&(n.check_out_location_lng=e.lng),t!==void 0&&(n.check_out_network_ssid=t),o!==void 0&&(n.check_out_photo_url=o);const{data:i,error:y}=await s.from("attendance_records").update(n).eq("id",d.id).select().single();if(y)throw y;return c.success("Checked out successfully"),l(i)}catch(a){throw console.error("Error checking out:",a),c.error(a.message||"Failed to check out"),a}}async markAttendance(r){try{const e=m(r),{data:t,error:o}=await s.from("attendance_records").upsert(e,{onConflict:"employee_id,attendance_date"}).select().single();if(o)throw o;return c.success("Attendance marked successfully"),l(t)}catch(e){throw console.error("Error marking attendance:",e),c.error(e.message||"Failed to mark attendance"),e}}async deleteAttendanceRecord(r){try{const{error:e}=await s.from("attendance_records").delete().eq("id",r);if(e)throw e;c.success("Attendance record deleted")}catch(e){throw console.error("Error deleting attendance:",e),c.error(e.message||"Failed to delete attendance"),e}}async getAttendanceByDateRange(r,e){try{const{data:t,error:o}=await s.from("attendance_records").select("*").gte("attendance_date",r).lte("attendance_date",e).order("attendance_date",{ascending:!1});if(o)throw o;return l(t||[])}catch(t){throw console.error("Error fetching attendance by date range:",t),t}}async getAllLeaveRequests(){try{const{data:r,error:e}=await s.from("leave_requests").select("*").order("created_at",{ascending:!1});if(e)throw e;return l(r||[])}catch(r){throw console.error("Error fetching leave requests:",r),c.error("Failed to load leave requests"),r}}async getLeaveRequestsByEmployeeId(r){try{const{data:e,error:t}=await s.from("leave_requests").select("*").eq("employee_id",r).order("created_at",{ascending:!1});if(t)throw t;return l(e||[])}catch(e){throw console.error("Error fetching employee leave requests:",e),e}}async createLeaveRequest(r){try{const e=m(r),{data:t,error:o}=await s.from("leave_requests").insert([e]).select().single();if(o)throw o;return c.success("Leave request submitted"),l(t)}catch(e){throw console.error("Error creating leave request:",e),c.error(e.message||"Failed to submit leave request"),e}}async updateLeaveRequestStatus(r,e,t){try{const{data:o,error:a}=await s.from("leave_requests").update({status:e,review_notes:t,reviewed_at:new Date().toISOString()}).eq("id",r).select().single();if(a)throw a;return c.success(`Leave request ${e}`),l(o)}catch(o){throw console.error("Error updating leave request:",o),c.error(o.message||"Failed to update leave request"),o}}async getEmployeeStats(){try{const{data:r,error:e}=await s.from("employees").select("status, performance_rating");if(e)throw e;const t=new Date().toISOString().split("T")[0],{data:o,error:a}=await s.from("attendance_records").select("status").eq("attendance_date",t);if(a)throw a;return{totalEmployees:(r==null?void 0:r.length)||0,activeEmployees:(r==null?void 0:r.filter(n=>n.status==="active").length)||0,onLeaveEmployees:(r==null?void 0:r.filter(n=>n.status==="on-leave").length)||0,inactiveEmployees:(r==null?void 0:r.filter(n=>n.status==="inactive").length)||0,averagePerformanceRating:r!=null&&r.length?r.reduce((n,i)=>n+(i.performance_rating||0),0)/r.length:0,averageAttendanceRate:0,presentToday:(o==null?void 0:o.filter(n=>n.status==="present").length)||0,absentToday:(o==null?void 0:o.filter(n=>n.status==="absent").length)||0,lateToday:(o==null?void 0:o.filter(n=>n.status==="late").length)||0}}catch(r){throw console.error("Error fetching employee stats:",r),r}}async getTodaysAttendanceSummary(){try{const{data:r,error:e}=await s.from("todays_attendance").select("*");if(e)throw e;return l(r||[])}catch(r){throw console.error("Error fetching today's attendance summary:",r),r}}async getEmployeeAttendanceSummary(){try{const{data:r,error:e}=await s.from("employee_attendance_summary").select("*");if(e)throw e;return l(r||[])}catch(r){throw console.error("Error fetching employee attendance summary:",r),r}}exportEmployeesToCSV(r){const e=["ID","First Name","Last Name","Email","Phone","Position","Department","Status","Hire Date","Salary","Performance Rating"],t=r.map(a=>[a.id,a.firstName,a.lastName,a.email,a.phone||"",a.position,a.department,a.status,a.hireDate,a.salary,a.performanceRating]);return[e.join(","),...t.map(a=>a.map(d=>`"${d}"`).join(","))].join(`
`)}exportAttendanceToCSV(r){const e=["ID","Employee ID","Date","Check In","Check Out","Total Hours","Overtime Hours","Status","Notes"],t=r.map(a=>[a.id,a.employeeId,a.attendanceDate,a.checkInTime||"",a.checkOutTime||"",a.totalHours,a.overtimeHours,a.status,a.notes||""]);return[e.join(","),...t.map(a=>a.map(d=>`"${d}"`).join(","))].join(`
`)}downloadCSV(r,e){const t=new Blob([r],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),a=URL.createObjectURL(t);o.setAttribute("href",a),o.setAttribute("download",e),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),c.success(`${e} downloaded successfully`)}}const w=new f;export{w as e};
