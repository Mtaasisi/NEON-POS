import{s as g,aF as te,j as e,u as re}from"./index-61458a34.js";import{r as _,R as se}from"./vendor-36d2c7c1.js";import{X as G,u as z,Z as ae,cM as ie,b0 as ne,J as ce,N as oe,e as J,s as X,n as B,c4 as le,d as H,af as de,f as ue}from"./ui-28e30067.js";class fe{static async deleteOrder(i){try{const{data:t,error:r}=await g.from("lats_purchase_orders").select("status").eq("id",i).single();if(r)return console.error("Error fetching order:",r),{success:!1,message:"Order not found"};if(!["draft","pending_approval","sent","cancelled"].includes(t.status))return{success:!1,message:`Cannot delete order with status '${t.status}'. Only draft, pending approval, sent, or cancelled orders can be deleted.`};const{error:o}=await g.from("lats_purchase_orders").delete().eq("id",i);if(o)throw o;return{success:!0,message:"Order deleted successfully"}}catch(t){return console.error("Error deleting order:",t),{success:!1,message:"Failed to delete order"}}}static async cancelOrder(i){try{const{error:t,data:r}=await g.from("lats_purchase_orders").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",i).in("status",["sent","confirmed","shipped"]).select("id, status");if(t)throw t;return!r||r.length===0?{success:!1,message:"Only sent, confirmed, or shipped orders can be cancelled."}:{success:!0,message:"Order cancelled successfully"}}catch(t){return console.error("Error cancelling order:",t),{success:!1,message:"Failed to cancel order"}}}static async duplicateOrder(i){try{const{data:t,error:r}=await g.from("lats_purchase_orders").select("*").eq("id",i).single();if(r)throw r;const a=Date.now(),o=`${t.po_number}-COPY-${a}`,f={...t,po_number:o,status:"sent",payment_status:"unpaid",total_paid:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};delete f.id;const{data:m,error:N}=await g.from("lats_purchase_orders").insert(f).select().single();if(N)throw N;const{data:x,error:I}=await g.from("lats_purchase_order_items").select("*").eq("purchase_order_id",i);if(I)throw I;if(x&&x.length>0){const j=x.map(S=>({...S,purchase_order_id:m.id,quantity_received:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{error:M}=await g.from("lats_purchase_order_items").insert(j.map(({id:S,...A})=>A));if(M)throw M}return console.log("âœ… Order duplicated successfully:",{originalOrderId:i,newOrderId:m.id,newOrderNumber:m.po_number,itemsDuplicated:(x==null?void 0:x.length)||0}),{success:!0,message:"Order duplicated successfully",data:m}}catch(t){return console.error("âŒ Error duplicating order:",t),console.error("Error details:",{orderId:i,errorMessage:t instanceof Error?t.message:"Unknown error",errorCode:t==null?void 0:t.code,errorDetails:t==null?void 0:t.details}),{success:!1,message:`Failed to duplicate order: ${t instanceof Error?t.message:"Unknown error"}`}}}static async updateItemQualityCheck(i,t,r){try{const{data:a,error:o}=await g.from("lats_purchase_order_items").select("purchase_order_id").eq("id",i).single();if(o||!a)throw new Error("Item not found");const{error:f}=await g.from("purchase_order_quality_checks").insert({purchase_order_id:a.purchase_order_id,item_id:i,passed:t==="passed",notes:r||null,checked_by:"system",timestamp:new Date().toISOString()});if(f)throw f;return{success:!0,message:"Quality check updated"}}catch(a){return console.error("Error updating quality check:",a),{success:!1,message:"Failed to update quality check"}}}static async completeQualityCheck(i){try{const{error:t}=await g.from("lats_purchase_orders").update({status:"received",updated_at:new Date().toISOString()}).eq("id",i);if(t)throw t;return{success:!0,message:"Quality check completed"}}catch(t){return console.error("Error completing quality check:",t),{success:!1,message:"Failed to complete quality check"}}}static async sendSMS(i,t,r){try{const{error:a}=await g.from("purchase_order_messages").insert({purchase_order_id:r,sender:"system",content:`SMS sent to ${i}: ${t}`,type:"system",timestamp:new Date().toISOString()});if(a)throw a;return console.log(`SMS to ${i}: ${t}`),{success:!0,message:"SMS sent successfully"}}catch(a){return console.error("Error sending SMS:",a),{success:!1,message:"Failed to send SMS"}}}static async addNote(i,t,r){try{const{data:a,error:o}=await g.from("purchase_order_messages").insert({purchase_order_id:i,sender:r,content:t,type:"user",timestamp:new Date().toISOString()}).select().single();if(o)throw o;return{success:!0,message:"Note added successfully",data:a}}catch(a){return console.error("Error adding note:",a),{success:!1,message:"Failed to add note"}}}static async getNotes(i){try{const{data:t,error:r}=await g.from("purchase_order_messages").select("*").eq("purchase_order_id",i).eq("type","user").order("timestamp",{ascending:!1});if(r)throw r;return{success:!0,message:"Notes retrieved",data:t||[]}}catch(t){return console.error("Error getting notes:",t),{success:!1,message:"Failed to get notes"}}}static async bulkUpdateStatus(i,t){try{const{error:r}=await g.from("lats_purchase_order_items").update({status:t,updated_at:new Date().toISOString()}).in("id",i);if(r)throw r;return{success:!0,message:`Updated ${i.length} items`}}catch(r){return console.error("Error bulk updating status:",r),{success:!1,message:"Failed to update items"}}}static async bulkAssignLocation(i,t){try{const{error:r}=await g.from("lats_purchase_order_items").update({location:t,updated_at:new Date().toISOString()}).in("id",i);if(r)throw r;return{success:!0,message:`Assigned ${i.length} items to ${t}`}}catch(r){return console.error("Error bulk assigning location:",r),{success:!1,message:"Failed to assign location"}}}static async createReturnOrder(i,t){try{const{data:r,error:a}=await g.from("purchase_order_returns").insert({purchase_order_id:i,reason:t.reason,return_type:t.returnType,notes:t.notes||null,status:"pending",created_at:new Date().toISOString()}).select().single();if(a)throw a;const o=t.items.map(m=>({return_order_id:r.id,item_id:m.itemId,quantity:m.quantity,created_at:new Date().toISOString()})),{error:f}=await g.from("purchase_order_return_items").insert(o);if(f)throw f;return{success:!0,message:"Return order created successfully",data:r}}catch(r){return console.error("Error creating return order:",r),{success:!1,message:"Failed to create return order"}}}static async logAction(i,t,r){try{const{data:{user:a},error:o}=await g.auth.getUser();if(o||!a){console.warn("No authenticated user found for audit logging:",o);return}const f=typeof r=="string"?r:JSON.stringify(r),{data:m,error:N}=await g.rpc("log_purchase_order_audit",{p_purchase_order_id:i,p_action:t,p_details:f,p_user_id:a.id});if(N){console.warn("Helper function failed, trying direct insert:",N);const{error:x}=await g.from("purchase_order_audit").insert({purchase_order_id:i,action:t,details:f,user_id:a.id,created_by:a.id,timestamp:new Date().toISOString()});x&&console.error("Direct insert also failed:",x)}else console.log("âœ… Audit logged successfully with ID:",m)}catch(a){console.error("Error logging action:",a)}}}const xe=({isOpen:k,onClose:i,purchaseOrder:t,onConfirm:r,isLoading:a=!1,mode:o="partial",initialReceivedItems:f})=>{const[m,N]=_.useState(new Map),[x,I]=_.useState(new Map),j=_.useRef(new Map),{open:M}=te();_.useEffect(()=>(k?document.body.style.overflow="hidden":(document.body.style.overflow="",j.current.forEach(l=>clearTimeout(l)),j.current.clear(),I(new Map)),()=>{document.body.style.overflow="",j.current.forEach(l=>clearTimeout(l)),j.current.clear()}),[k]),_.useEffect(()=>{if(k){if(f&&f.length>0){console.log("ðŸ“¦ Restoring saved serial number data");const d=new Map;f.forEach(c=>{d.set(c.id,{quantity:c.receivedQuantity,serialNumbers:c.serialNumbers||[]})}),N(d);return}const l=new Map;t.items.forEach(d=>{const c=d.quantity-(d.receivedQuantity||0),s=o==="full"?c:c>0?1:0,u=[];for(let h=0;h<s;h++)u.push(S(d));l.set(d.id,{quantity:s,serialNumbers:u})}),N(l)}},[k,t.items,o,f]);const S=l=>{const d=new Date().toISOString().split("T")[0],c=new Date;c.setMonth(c.getMonth()+12);const s=c.toISOString().split("T")[0];return{serial_number:"",imei:"",mac_address:"",barcode:"",location:"",warranty_start:d,warranty_end:s,warranty_months:12,cost_price:Number(l.costPrice||l.cost_price||l.unitCost||0),selling_price:void 0,notes:""}},A=async(l,d)=>{try{const c=await M();c&&n(l,d,"location",c.label)}catch(c){console.error("Error opening storage location picker:",c)}},F=_.useCallback(async(l,d,c,s)=>{const u=d||l;if(!u||!u.trim()){I(h=>{const q=new Map(h),b=q.get(c)||new Map;return b.delete(s),b.size===0?q.delete(c):q.set(c,b),q});return}try{const h=[];h.push(g.from("lats_product_variants").select("id, variant_attributes").eq("variant_type","imei_child").filter("variant_attributes->>'imei'","eq",u.trim()).limit(1)),h.push(g.from("lats_product_variants").select("id, variant_attributes").eq("variant_type","imei_child").filter("variant_attributes->>'serial_number'","eq",u.trim()).limit(1)),h.push(g.from("inventory_items").select("id, serial_number, imei").or(`serial_number.eq.${u.trim()},imei.eq.${u.trim()}`).limit(1));const b=(await Promise.all(h)).some(v=>v.error?(console.warn("Error checking duplicate:",v.error),!1):v.data&&v.data.length>0);I(v=>{const p=new Map(v),y=p.get(c)||new Map;return b?y.set(s,!0):y.delete(s),y.size===0?p.delete(c):p.set(c,y),p})}catch(h){console.error("Error checking duplicate:",h)}},[]),n=(l,d,c,s)=>{N(u=>{const h=new Map(u),q=h.get(l)||{quantity:0,serialNumbers:[]},b=[...q.serialNumbers],v=b[d];if(c==="imei"&&typeof s=="string")b[d]={...v,imei:s,serial_number:s};else if(c==="serial_number"&&typeof s=="string")b[d]={...v,imei:s,serial_number:s};else if(c==="warranty_months"&&typeof s=="number"&&v.warranty_start){const p=new Date(v.warranty_start),y=new Date(p);y.setMonth(y.getMonth()+s),b[d]={...v,warranty_months:s,warranty_end:y.toISOString().split("T")[0]}}else if(c==="warranty_start"&&typeof s=="string"){const p=v.warranty_months||12,y=new Date(s),D=new Date(y);D.setMonth(D.getMonth()+p),b[d]={...v,warranty_start:s,warranty_end:D.toISOString().split("T")[0]}}else if(c==="serial_number"&&typeof s=="string"){const p={...v,serial_number:s};b[d]=p;const y=`${l}-${d}`,D=j.current.get(y);D&&clearTimeout(D);const L=setTimeout(()=>{F(p.serial_number,p.imei,l,d),j.current.delete(y)},500);j.current.set(y,L)}else if(c==="imei"&&typeof s=="string"){const p={...v,imei:s};b[d]=p;const y=`${l}-${d}-imei`,D=j.current.get(y);D&&clearTimeout(D);const L=setTimeout(()=>{F(p.serial_number,p.imei,l,d),j.current.delete(y)},500);j.current.set(y,L)}else b[d]={...v,[c]:s};return h.set(l,{...q,serialNumbers:b}),h})},w=(l,d)=>{const c=t.items.find(h=>h.id===l);if(!c)return;const s=c.quantity-(c.receivedQuantity||0),u=Math.min(Math.max(0,d),s);N(h=>{const q=new Map(h),b=q.get(l)||{quantity:0,serialNumbers:[]},v=[];for(let p=0;p<u;p++){const y=b.serialNumbers[p];v.push(y||S(c))}return q.set(l,{quantity:u,serialNumbers:v}),q})},C=_.useMemo(()=>Array.from(m.entries()),[m]),Q=_.useMemo(()=>C.filter(([,l])=>l.quantity>0).length,[C]),E=_.useMemo(()=>t.items.every(l=>{const d=l.quantity-(l.receivedQuantity||0);if(d<=0)return!0;const c=m.get(l.id);return(c==null?void 0:c.quantity)===d}),[t.items,m]),$=_.useMemo(()=>t.items.every(l=>{if(l.quantity-(l.receivedQuantity||0)<=0)return!0;const c=m.get(l.id);return(c==null?void 0:c.quantity)===1}),[t.items,m]),T=l=>{if(o!=="partial")return;if(!t.items.some(c=>c.quantity-(c.receivedQuantity||0)>0)){B.error("No pending items available for this action");return}switch(N(c=>{const s=new Map(c);return t.items.forEach(u=>{const h=u.quantity-(u.receivedQuantity||0),q=s.get(u.id)||{quantity:0,serialNumbers:[]};if(h<=0){s.set(u.id,{quantity:0,serialNumbers:[]});return}let b=q.quantity;switch(l){case"fill_all":b=h;break;case"fill_one_each":b=Math.min(1,h);break;case"clear_all":b=0;break}const v=[];for(let p=0;p<b;p++){const y=q.serialNumbers[p];v.push(y||S(u))}s.set(u.id,{quantity:b,serialNumbers:v})}),s}),l){case"fill_all":B.success("All pending quantities selected");break;case"fill_one_each":B.success("Set quantity to 1 for each pending item");break;case"clear_all":B.success("Selections cleared");break}},P=(l,d)=>{var s;const c=((s=m.get(l))==null?void 0:s.quantity)||0;w(l,c+d)},R=async()=>{try{let l=!1;if(m.forEach((c,s)=>{c.serialNumbers.forEach((u,h)=>{const q=u.serial_number&&u.serial_number.trim()!=="",b=u.imei&&u.imei.trim()!=="";!q&&!b&&(l=!0)})}),l){B.error("Please fill in Serial Number OR IMEI (at least one required) for all items");return}const d=[];m.forEach((c,s)=>{c.quantity>0&&d.push({id:s,receivedQuantity:c.quantity,serialNumbers:c.serialNumbers.length>0?c.serialNumbers:void 0})}),await r(d),i()}catch(l){console.error("Error confirming receive:",l),B.error("Failed to process receive")}},O=()=>{let l=0;return m.forEach(d=>{l+=d.quantity}),l},K=()=>{let l=0;return m.forEach((d,c)=>{const s=t.items.find(u=>u.id===c);if(s){const u=Number(s.costPrice||s.cost_price||s.unitCost||0);l+=u*d.quantity}}),l},U=l=>{const d=t.currency||"USD",c=Math.round(l);if(d==="TSh"||d==="TZS")return`TSh ${c.toLocaleString("en-US")}`;try{return new Intl.NumberFormat("en-US",{style:"currency",currency:d,minimumFractionDigits:0,maximumFractionDigits:0}).format(c)}catch{return`${d} ${c.toLocaleString("en-US")}`}};return k?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed bg-black/50",onClick:i,style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:35}}),e.jsx("div",{className:"fixed flex items-center justify-center p-4",style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:50,pointerEvents:"none"},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col relative",onClick:l=>l.stopPropagation(),style:{pointerEvents:"auto"},children:[e.jsx("button",{onClick:i,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(G,{className:"w-5 h-5"})}),e.jsxs("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(z,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-3",children:o==="full"?"Add Serial Numbers":"Select Items & Add Serial Numbers"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg shadow-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsxs("span",{className:"text-gray-900 font-bold ml-1",children:[O()," items"]})]}),e.jsx("div",{className:"flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg shadow-sm",children:e.jsxs("span",{className:"text-gray-900 font-medium",children:[t.items.length," ",t.items.length===1?"product":"products"]})}),e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("span",{className:"text-green-700 font-medium",children:"Cost: "}),e.jsx("span",{className:"text-green-900 font-bold",children:U(K())})]})]})]})]}),o==="partial"&&e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 uppercase tracking-wide",children:"Quick Actions"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>T("fill_all"),disabled:E,className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-sm ${E?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:[e.jsx(ae,{className:"w-4 h-4"}),"Receive All Pending"]}),e.jsxs("button",{type:"button",onClick:()=>T("fill_one_each"),disabled:$,className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-sm ${$?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:[e.jsx(ie,{className:"w-4 h-4"}),"Receive 1 Each"]}),e.jsxs("button",{type:"button",onClick:()=>T("clear_all"),disabled:Q===0,className:`flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-sm ${Q===0?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-gray-900 text-white hover:bg-gray-800"}`,children:[e.jsx(ne,{className:"w-4 h-4"}),"Clear Selections"]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 border-t border-gray-100",children:e.jsx("div",{className:"space-y-4 py-4",children:t.items.map(l=>{var q,b,v;const d=m.get(l.id)||{quantity:0,serialNumbers:[]},c=l.quantity-(l.receivedQuantity||0);if(o==="full"&&d.quantity===0)return null;const s=((q=l.variant)==null?void 0:q.variant_name)||((b=l.variant)==null?void 0:b.name)||null,u=l.name||(((v=l.product)==null?void 0:v.name)||"")+(s?` - ${s}`:""),h=d.quantity>0;return e.jsxs("div",{className:`border-2 rounded-2xl bg-white shadow-sm transition-all duration-300 ${h?"border-green-200 hover:border-green-300 hover:shadow-md":"border-gray-200 hover:border-gray-300 hover:shadow-md"}`,children:[e.jsxs("div",{className:"flex items-start justify-between p-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:u}),h&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-green-500 text-white shadow-sm",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"Active"]})]}),s&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Variant: ",s]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Cost: ",e.jsx("span",{className:"font-semibold text-gray-900",children:U(Number(l.costPrice||l.cost_price||l.unitCost||0))})," â€¢ Available: ",c," units"]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[o==="partial"&&e.jsxs("div",{className:"ml-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1 text-right",children:"Receiving:"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>P(l.id,-1),disabled:d.quantity<=0,className:"w-12 h-12 flex items-center justify-center rounded-xl border-2 border-gray-200 text-gray-700 hover:bg-gray-100 transition disabled:opacity-40 disabled:cursor-not-allowed text-lg",children:e.jsx(ce,{className:"w-5 h-5"})}),e.jsx("input",{type:"number",min:"0",max:c,value:d.quantity,onChange:p=>w(l.id,parseInt(p.target.value,10)||0),className:"w-28 px-4 py-3 border-2 border-gray-300 rounded-2xl focus:outline-none focus:border-green-500 focus:ring-4 focus:ring-green-200/50 text-center font-bold text-xl [appearance:textfield] [-moz-appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),e.jsx("button",{type:"button",onClick:()=>P(l.id,1),disabled:d.quantity>=c,className:"w-12 h-12 flex items-center justify-center rounded-xl border-2 border-gray-200 text-gray-700 hover:bg-gray-100 transition disabled:opacity-40 disabled:cursor-not-allowed text-lg",children:e.jsx(oe,{className:"w-5 h-5"})})]})]}),o==="full"&&e.jsxs("div",{className:"px-4 py-2 bg-green-50 rounded-xl border border-green-200",children:[e.jsx("p",{className:"text-xs text-gray-600",children:"Receiving:"}),e.jsxs("p",{className:"text-lg font-bold text-green-700",children:[d.quantity," pcs"]})]})]})]}),d.quantity>0?e.jsx("div",{className:"px-6 pb-6",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-700 w-12",children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 min-w-[200px]",children:"Product Name"}),e.jsxs("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 min-w-[200px]",children:["IMEI / Serial Number ",e.jsx("span",{className:"text-gray-400 font-normal",children:"(Required)"})]}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 min-w-[180px]",children:"Location"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:d.serialNumbers.map((p,y)=>{var D,L,V,W;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-center font-medium text-gray-600",children:y+1}),e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:u}),e.jsxs("td",{className:"px-4 py-3",colSpan:2,children:[e.jsx("input",{type:"text",placeholder:"Enter IMEI or Serial Number (any value)",value:p.imei||p.serial_number||"",onChange:Z=>{const ee=Z.target.value;n(l.id,y,"imei",ee)},className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 font-mono ${(D=x.get(l.id))!=null&&D.get(y)?"border-red-500 bg-red-50 focus:ring-red-500":!((L=p.serial_number)!=null&&L.trim())&&!((V=p.imei)!=null&&V.trim())?"border-orange-300 bg-orange-50 focus:ring-blue-500":"border-gray-300 bg-white focus:ring-blue-500"}`,title:"Enter any IMEI or Serial Number - no format restrictions"}),(p.imei||p.serial_number)&&((W=x.get(l.id))==null?void 0:W.get(y))&&e.jsx("div",{className:"text-xs mt-1",children:e.jsxs("div",{className:"flex items-center gap-1 text-red-600 font-medium",children:[e.jsx(J,{className:"w-3 h-3"}),e.jsx("span",{children:"âš ï¸ Duplicate IMEI/Serial Number"})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Enter any IMEI or Serial Number - no format restrictions"})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("button",{type:"button",onClick:Z=>{Z.stopPropagation(),A(l.id,y)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg hover:border-blue-400 bg-white text-left flex items-center gap-2 transition-colors cursor-pointer",children:[e.jsx(X,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:p.location?"text-gray-900":"text-gray-400",children:p.location||"Select shelf"})]})})]},y)})})]})})}):o==="partial"?e.jsx("div",{className:"px-6 pb-6",children:e.jsxs("div",{className:"p-6 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-center",children:[e.jsx(z,{className:"w-10 h-10 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"Set quantity above to add serial numbers"})]})}):null]},l.id)})})}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-white",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{const l=Array.from(t.items).map(d=>{const c=m.get(d.id)||{quantity:0,serialNumbers:[]};return{id:d.id,receivedQuantity:c.quantity,serialNumbers:[]}});r(l)},disabled:a,className:"flex-1 px-6 py-3.5 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors disabled:opacity-50 text-lg",children:"Skip Serial Numbers â†’"}),e.jsx("button",{type:"button",onClick:R,disabled:a||O()===0,className:"flex-1 px-6 py-3.5 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl text-lg",children:a?"Processing...":`Continue (${O()} items)`})]})})]})})]}):null},ye=({isOpen:k,onClose:i,purchaseOrder:t,onReceiveFull:r,onReceivePartial:a})=>{var S,A,F;const[o,f]=_.useState("full"),[m,N]=_.useState(!1);if(se.useEffect(()=>(k?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[k]),!k)return null;const x=()=>{switch(m?sessionStorage.setItem("includeQualityCheck","true"):sessionStorage.removeItem("includeQualityCheck"),o){case"full":r();break;case"partial":a();break;default:B.error("Please select a receive type")}},I=((S=t==null?void 0:t.items)==null?void 0:S.reduce((n,w)=>n+(w.quantity||0),0))||0,j=((A=t==null?void 0:t.items)==null?void 0:A.reduce((n,w)=>n+(w.receivedQuantity||0),0))||0,M=I-j;return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden relative",children:[e.jsx("button",{onClick:i,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(G,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(z,{className:"w-8 h-8 text-white"})}),e.jsx("div",{children:e.jsx("h3",{className:"text-2xl font-bold text-gray-900",children:"Receive Purchase Order"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Order Number"}),e.jsx("p",{className:"font-bold text-gray-900 text-base",children:t==null?void 0:t.orderNumber})]}),e.jsxs("div",{className:"bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Supplier"}),e.jsx("p",{className:"font-bold text-gray-900 text-base",children:((F=t==null?void 0:t.supplier)==null?void 0:F.name)||"N/A"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 shadow-sm text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:I}),e.jsx("div",{className:"text-xs text-blue-700 font-medium mt-1",children:"Total Quantity"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border-2 border-green-200 shadow-sm text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:j}),e.jsx("div",{className:"text-xs text-green-700 font-medium mt-1",children:"Received"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-amber-50 p-4 rounded-xl border-2 border-orange-200 shadow-sm text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:M}),e.jsx("div",{className:"text-xs text-orange-700 font-medium mt-1",children:"Pending"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsx("button",{type:"button",onClick:()=>f("full"),className:`p-5 rounded-2xl transition-all duration-200 border-2 shadow-sm ${o==="full"?"bg-white shadow-xl border-green-500 ring-4 ring-green-200":"bg-white border-gray-200 hover:border-green-300 hover:shadow-md"}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`w-12 h-12 mx-auto rounded-xl flex items-center justify-center mb-3 ${o==="full"?"bg-green-500":"bg-green-50"}`,children:e.jsx(z,{className:`w-7 h-7 ${o==="full"?"text-white":"text-green-600"}`})}),e.jsx("div",{className:`font-bold text-base mb-1 ${o==="full"?"text-green-600":"text-gray-900"}`,children:"Full Receive"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["All ",M," units"]})]})}),e.jsx("button",{type:"button",onClick:()=>f("partial"),className:`p-5 rounded-2xl transition-all duration-200 border-2 shadow-sm ${o==="partial"?"bg-white shadow-xl border-orange-500 ring-4 ring-orange-200":"bg-white border-gray-200 hover:border-orange-300 hover:shadow-md"}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`w-12 h-12 mx-auto rounded-xl flex items-center justify-center mb-3 ${o==="partial"?"bg-orange-500":"bg-orange-50"}`,children:e.jsx(le,{className:`w-7 h-7 ${o==="partial"?"text-white":"text-orange-600"}`})}),e.jsx("div",{className:`font-bold text-base mb-1 ${o==="partial"?"text-orange-600":"text-gray-900"}`,children:"Partial Receive"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Select quantities"})]})})]}),e.jsx("button",{type:"button",onClick:()=>N(!m),className:`w-full p-5 rounded-2xl transition-all duration-200 border-2 shadow-sm ${m?"bg-white shadow-xl border-purple-500 ring-4 ring-purple-200":"bg-white border-gray-200 hover:border-purple-300 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-6 h-6 rounded-md border-2 flex items-center justify-center ${m?"bg-purple-500 border-purple-500":"bg-purple-50 border-purple-300"}`,children:m&&e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),e.jsx("div",{className:`flex-1 text-left font-semibold ${m?"text-purple-600":"text-gray-900"}`,children:"Include Quality Check"})]})})]}),e.jsx("div",{className:"p-6 pt-0",children:e.jsx("button",{onClick:x,className:"w-full px-6 py-3.5 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all font-semibold shadow-lg hover:shadow-xl text-lg",children:"Proceed to Receive"})})]})})};class Y{static async createQualityCheckFallback(i){try{console.log("ðŸ”„ Creating quality check using fallback method:",i);const{data:t,error:r}=await g.from("purchase_order_quality_checks").insert({purchase_order_id:i.purchaseOrderId,template_id:i.templateId,checked_by:i.checkedBy,status:"in_progress"}).select("id").single();if(r)throw r;if(!(t!=null&&t.id))throw new Error("Failed to create quality check record");const{data:a,error:o}=await g.from("quality_check_criteria").select("*").eq("template_id",i.templateId).order("sort_order");if(o)throw o;if(!a||a.length===0)throw new Error("No criteria found for template");const{data:f,error:m}=await g.from("lats_purchase_order_items").select("*").eq("purchase_order_id",i.purchaseOrderId);if(m)throw m;if(!f||f.length===0)throw new Error("No purchase order items found");const N=[];for(const x of a)for(const I of f)N.push({quality_check_id:t.id,purchase_order_item_id:I.id,criteria_id:x.id,criteria_name:x.name});if(N.length>0){const{error:x}=await g.from("purchase_order_quality_check_items").insert(N);if(x)throw x}return{success:!0,data:t.id,message:"Quality check created successfully (fallback method)"}}catch(t){return console.error("âŒ Error in fallback quality check creation:",t),{success:!1,message:t instanceof Error?t.message:"Failed to create quality check using fallback method"}}}static async getTemplates(){try{const{data:i,error:t}=await g.from("quality_check_templates").select("*").eq("is_active",!0).order("name");if(t)throw t;return{success:!0,data:i==null?void 0:i.map(r=>({id:r.id,name:r.name,description:r.description,category:r.category,isActive:r.is_active,createdAt:r.created_at,updatedAt:r.updated_at}))}}catch(i){return console.error("Error fetching templates:",i),{success:!1,message:i instanceof Error?i.message:"Failed to fetch templates"}}}static async getTemplateCriteria(i){try{const{data:t,error:r}=await g.from("quality_check_criteria").select("*").eq("template_id",i).order("sort_order");if(r)throw r;return{success:!0,data:(t==null?void 0:t.map(a=>({id:a.id,templateId:a.template_id,name:a.name,description:a.description,isRequired:a.is_required,sortOrder:a.sort_order,createdAt:a.created_at})))||[]}}catch(t){return console.error("Error fetching criteria:",t),{success:!1,message:t instanceof Error?t.message:"Failed to fetch criteria"}}}static async createQualityCheck(i){try{console.log("ðŸ”„ Creating quality check with params:",i);const{data:t,error:r}=await g.rpc("create_quality_check_from_template",{p_purchase_order_id:i.purchaseOrderId,p_template_id:i.templateId,p_checked_by:i.checkedBy});if(r)throw console.error("âŒ RPC error creating quality check:",r),r;console.log("âœ… Quality check created successfully (raw):",t);let a;if(Array.isArray(t)){const o=t[0];typeof o=="string"?a=o:typeof o=="object"&&o!==null?a=o.create_quality_check_from_template||o.id||String(o):a=String(o)}else if(typeof t=="object"&&t!==null){const o=t;a=o.create_quality_check_from_template||o.id||String(t)}else a=String(t);return console.log("âœ… Extracted quality check ID:",a),{success:!0,data:a,message:"Quality check created successfully"}}catch(t){console.error("âŒ Error creating quality check:",t);let r="Failed to create quality check";return t instanceof Error&&(t.message.includes("function")&&t.message.includes("does not exist")?r="Quality check system not properly configured. Please contact administrator.":t.message.includes("foreign key")?r="Invalid purchase order or template ID provided.":t.message.includes("permission")?r="You do not have permission to create quality checks.":r=`Error: ${t.message}`),r.includes("not properly configured")?(console.log("ðŸ”„ Attempting fallback method for quality check creation..."),await this.createQualityCheckFallback(i)):{success:!1,message:r}}}static async getQualityCheck(i){try{if(!i||i===""||i==="undefined")return console.error("Invalid quality check ID provided:",i),{success:!1,message:"Invalid quality check ID"};const{data:t,error:r}=await g.from("purchase_order_quality_checks").select("*").eq("id",i).single();if(r)throw r;let a=null;if(t.template_id){const{data:o}=await g.from("quality_check_templates").select("*").eq("id",t.template_id).single();a=o}return{success:!0,data:{id:t.id,purchaseOrderId:t.purchase_order_id,templateId:t.template_id,status:t.status,overallResult:t.overall_result,checkedBy:t.checked_by,checkedAt:t.checked_at,notes:t.notes,signature:t.signature,createdAt:t.created_at,updatedAt:t.updated_at,template:a?{id:a.id,name:a.name,description:a.description,category:a.category,isActive:a.is_active,createdAt:a.created_at,updatedAt:a.updated_at}:void 0}}}catch(t){return console.error("Error fetching quality check:",t),{success:!1,message:t instanceof Error?t.message:"Failed to fetch quality check"}}}static async getQualityChecksByPO(i){try{const{data:t,error:r}=await g.from("purchase_order_quality_checks").select("*").eq("purchase_order_id",i).order("created_at",{ascending:!1});if(r)throw r;if(t&&t.length>0){const a=t.map(o=>o.template_id).filter(Boolean);if(a.length>0){const{data:o}=await g.from("quality_check_templates").select("*").in("id",a),f=new Map((o==null?void 0:o.map(m=>[m.id,m]))||[]);t.forEach(m=>{m.template_id&&(m.template=f.get(m.template_id))})}}return{success:!0,data:t==null?void 0:t.map(a=>({id:a.id,purchaseOrderId:a.purchase_order_id,templateId:a.template_id,status:a.status,overallResult:a.overall_result,checkedBy:a.checked_by,checkedAt:a.checked_at,notes:a.notes,signature:a.signature,createdAt:a.created_at,updatedAt:a.updated_at,template:a.template?{id:a.template.id,name:a.template.name,description:a.template.description,category:a.template.category,isActive:a.template.is_active,createdAt:a.template.created_at,updatedAt:a.template.updated_at}:void 0}))}}catch(t){return console.error("Error fetching quality checks:",t),{success:!1,message:t instanceof Error?t.message:"Failed to fetch quality checks"}}}static async getQualityCheckItems(i){try{if(!i||i===""||i==="undefined")return console.error("Invalid quality check ID provided:",i),{success:!1,message:"Invalid quality check ID"};const t=typeof i=="string"?i.trim():String(i);console.log("ðŸ” Fetching quality check items for ID:",t);const{data:r,error:a}=await g.from("purchase_order_quality_check_items").select("*").eq("quality_check_id",t).order("created_at");if(a)throw a;if(!r||r.length===0)return console.warn("No quality check items found for ID:",i),{success:!0,data:[]};const o=n=>{if(!n)return null;if(typeof n=="string")return n;if(typeof n=="object"&&n.id)return String(n.id);try{return String(n)}catch{return null}},f=n=>n?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n):!1,m=[...new Set(r.map(n=>o(n.criteria_id)).filter(n=>n&&n!=="undefined"&&n!=="null"&&f(n)))],N=[...new Set(r.map(n=>o(n.purchase_order_item_id)).filter(n=>n&&n!=="undefined"&&n!=="null"&&f(n)))];console.log("ðŸ” Extracted IDs - Criteria:",m,"PO Items:",N);const x=new Map;if(m.length>0)try{const{data:n,error:w}=await g.from("quality_check_criteria").select("*").in("id",m);if(w)throw console.error("Error fetching criteria:",w),w;n==null||n.forEach(C=>x.set(C.id,C))}catch(n){throw console.error("âŒ Failed to fetch criteria:",n),n}const I=new Map;if(N.length>0)try{const{data:n,error:w}=await g.from("lats_purchase_order_items").select("id, product_id, variant_id, quantity, received_quantity").in("id",N);if(w)throw console.error("Error fetching purchase order items:",w),w;n==null||n.forEach(C=>I.set(C.id,C))}catch(n){throw console.error("âŒ Failed to fetch PO items:",n),n}const j=[...new Set(Array.from(I.values()).map(n=>o(n.product_id)).filter(n=>n&&n!=="undefined"&&n!=="null"))],M=[...new Set(Array.from(I.values()).map(n=>o(n.variant_id)).filter(n=>n&&n!=="undefined"&&n!=="null"))];console.log("ðŸ” Extracted product/variant IDs - Products:",j,"Variants:",M);const S=new Map;if(j.length>0)try{console.log("ðŸ”„ Fetching products with valid UUIDs:",j);const{data:n,error:w}=await g.from("lats_products").select("id, name, sku").in("id",j);w?console.error("âŒ Error fetching products:",w):(n==null||n.forEach(C=>S.set(C.id,C)),console.log(`âœ… Fetched ${(n==null?void 0:n.length)||0} products`))}catch(n){console.error("âŒ Failed to fetch products:",n)}else console.log("â„¹ï¸ No valid product IDs to fetch");const A=new Map;if(M.length>0)try{console.log("ðŸ”„ Fetching variants with valid UUIDs:",M);const{data:n,error:w}=await g.from("lats_product_variants").select("id, name, sku").in("id",M);w?console.error("âŒ Error fetching variants:",w):(n==null||n.forEach(C=>A.set(C.id,C)),console.log(`âœ… Fetched ${(n==null?void 0:n.length)||0} variants`))}catch(n){console.error("âŒ Failed to fetch variants:",n)}else console.log("â„¹ï¸ No valid variant IDs to fetch");return{success:!0,data:r.map(n=>{const w=o(n.criteria_id),C=o(n.purchase_order_item_id),Q=w?x.get(w):void 0,E=C?I.get(C):void 0,$=E?o(E.product_id):null,T=E?o(E.variant_id):null,P=$?S.get($):void 0,R=T?A.get(T):void 0;return{id:n.id,qualityCheckId:n.quality_check_id,purchaseOrderItemId:n.purchase_order_item_id,criteriaId:n.criteria_id,criteriaName:n.criteria_name,result:n.result,quantityChecked:n.quantity_checked,quantityPassed:n.quantity_passed,quantityFailed:n.quantity_failed,defectType:n.defect_type,defectDescription:n.defect_description,actionTaken:n.action_taken,notes:n.notes,images:n.images||[],createdAt:n.created_at,updatedAt:n.updated_at,criteria:Q?{id:Q.id,templateId:Q.template_id,name:Q.name,description:Q.description,isRequired:Q.is_required,sortOrder:Q.sort_order,createdAt:Q.created_at}:void 0,purchaseOrderItem:E?{id:E.id,productId:E.product_id,variantId:E.variant_id,quantityOrdered:E.quantity,quantityReceived:E.received_quantity,product:P?{name:P.name,sku:P.sku}:void 0,variant:R?{name:R.name,sku:R.sku}:void 0}:void 0}})}}catch(t){return console.error("Error fetching quality check items:",t),{success:!1,message:t instanceof Error?t.message:"Failed to fetch quality check items"}}}static async updateQualityCheckItem(i){try{const{error:t}=await g.from("purchase_order_quality_check_items").update({result:i.result,quantity_checked:i.quantityChecked,quantity_passed:i.quantityPassed,quantity_failed:i.quantityFailed,defect_type:i.defectType,defect_description:i.defectDescription,action_taken:i.actionTaken,notes:i.notes,images:i.images,updated_at:new Date().toISOString()}).eq("id",i.id);if(t)throw t;return{success:!0,message:"Quality check item updated successfully"}}catch(t){return console.error("Error updating quality check item:",t),{success:!1,message:t instanceof Error?t.message:"Failed to update quality check item"}}}static async completeQualityCheck(i){try{console.log("ðŸ”„ Completing quality check with params:",i);const{data:t,error:r}=await g.rpc("complete_quality_check",{p_quality_check_id:i.qualityCheckId,p_notes:i.notes,p_signature:i.signature});if(r)throw console.error("âŒ RPC error completing quality check:",r),r;return console.log("âœ… Quality check completed successfully:",t),{success:!0,message:"Quality check completed successfully"}}catch(t){console.error("âŒ Error completing quality check:",t);let r="Failed to complete quality check";return t instanceof Error&&(t.message.includes("function")&&t.message.includes("does not exist")?r="Quality check completion system not properly configured. Please contact administrator.":t.message.includes("not found")?r="Quality check not found. It may have been deleted or the ID is invalid.":t.message.includes("permission")?r="You do not have permission to complete this quality check.":t.message.includes("400")?r="Invalid data provided for quality check completion.":r=`Error: ${t.message}`),{success:!1,message:r}}}static async getQualityCheckSummary(i){try{const{data:t,error:r}=await g.rpc("get_quality_check_summary",{p_purchase_order_id:i});if(r)throw r;if(!t||t.length===0)return{success:!0,data:void 0,message:"No quality check found"};const a=t[0];return{success:!0,data:{qualityCheckId:a.quality_check_id,status:a.status,overallResult:a.overall_result,checkedBy:a.checked_by,checkedAt:a.checked_at,totalItems:a.total_items,passedItems:a.passed_items,failedItems:a.failed_items,pendingItems:a.pending_items}}}catch(t){return console.error("Error fetching quality check summary:",t),{success:!1,message:t instanceof Error?t.message:"Failed to fetch quality check summary"}}}static async receiveQualityCheckedItems(i,t){try{const{data:r,error:a}=await g.rpc("receive_quality_checked_items",{p_quality_check_id:i,p_purchase_order_id:t});if(a)throw a;return{success:!0,message:(r==null?void 0:r.message)||"Quality-checked items received to inventory successfully"}}catch(r){return console.error("Error receiving quality-checked items:",r),{success:!1,message:r instanceof Error?r.message:"Failed to receive items to inventory"}}}}const be=({purchaseOrderId:k,isOpen:i,onClose:t,onComplete:r})=>{const{currentUser:a}=re(),[o,f]=_.useState("template"),[m,N]=_.useState([]),[x,I]=_.useState(""),[j,M]=_.useState(""),[S,A]=_.useState([]),[F,n]=_.useState(0),[w,C]=_.useState(""),[Q,E]=_.useState(!1),[$,T]=_.useState(30),[P,R]=_.useState("");_.useEffect(()=>{i&&O()},[i]);const O=async()=>{console.log("ðŸ”„ Loading quality check templates...");try{const s=await Y.getTemplates();if(s.success&&s.data)console.log("âœ… Templates loaded:",s.data.length),N(s.data),s.data.length>0&&I(s.data[0].id);else{console.warn("âš ï¸ Failed to load templates:",s.message);const u={id:"fallback-general",name:"General Quality Check",description:"Basic quality check for all items",category:"general",isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};N([u]),I(u.id)}}catch(s){console.error("âŒ Exception loading templates:",s);const u={id:"fallback-general",name:"General Quality Check",description:"Basic quality check for all items",category:"general",isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};N([u]),I(u.id)}},K=async()=>{if(!x||!a){console.error("âŒ Missing required data for quality check:",{selectedTemplate:x,currentUser:a});return}console.log("ðŸ”„ Starting quality check...",{purchaseOrderId:k,selectedTemplate:x,userId:a.id}),E(!0);try{const s=await Y.createQualityCheck({purchaseOrderId:k,templateId:x,checkedBy:a.id});if(s.success&&s.data){console.log("âœ… Quality check created successfully:",s.data),M(s.data);const u=await Y.getQualityCheckItems(s.data);u.success&&u.data?(console.log("âœ… Quality check items loaded:",u.data.length),A(u.data),f("inspect")):(console.error("âŒ Failed to load quality check items:",u.message),f("inspect"))}else console.error("âŒ Failed to create quality check:",s.message),alert(`Failed to start quality check: ${s.message}`)}catch(s){console.error("âŒ Exception during quality check creation:",s),alert(`Error starting quality check: ${s instanceof Error?s.message:"Unknown error"}`)}finally{E(!1)}},U=async(s,u,h,q,b,v,p,y,D)=>{(await Y.updateQualityCheckItem({id:s,result:u,quantityChecked:h,quantityPassed:q,quantityFailed:b,defectType:v,defectDescription:p,actionTaken:y,notes:D})).success&&(A(V=>V.map(W=>W.id===s?{...W,result:u,quantityChecked:h,quantityPassed:q,quantityFailed:b,defectType:v,defectDescription:p,actionTaken:y,notes:D}:W)),F<S.length-1?n(V=>V+1):f("complete"))},l=async()=>{if(!j)return;if(E(!0),(await Y.completeQualityCheck({qualityCheckId:j,notes:w})).success){const u=S.filter(q=>q.result==="fail").length;let h="pass";u===S.length?h="fail":u>0&&(h="conditional"),h==="pass"?f("inventory"):(r(),t())}E(!1)},d=async()=>{if(!(!j||!a)){E(!0);try{const{data:s,error:u}=await g.rpc("add_quality_items_to_inventory_v2",{p_quality_check_id:j,p_purchase_order_id:k,p_user_id:a.id,p_profit_margin_percentage:$,p_default_location:P||null});if(u)throw u;const h=s;h&&h.success?(console.log("âœ… Items added to inventory:",h),r(),t()):(console.error("âŒ Failed to add to inventory:",h==null?void 0:h.message),alert((h==null?void 0:h.message)||"Failed to add items to inventory"))}catch(s){console.error("âŒ Error adding to inventory:",s),alert("Error adding items to inventory")}finally{E(!1)}}},c=S[F];return i?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-6 h-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Quality Check"}),e.jsxs("p",{className:"text-sm text-gray-500",children:[o==="template"&&"Select Template",o==="inspect"&&`Item ${F+1} of ${S.length}`,o==="complete"&&"Complete Check",o==="inventory"&&"Add to Inventory"]})]})]}),e.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-180px)]",children:[o==="template"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:"Choose Quality Check Template"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:m.map(s=>e.jsxs("button",{onClick:()=>I(s.id),className:`p-4 border rounded-lg text-left transition ${x===s.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("h4",{className:"font-medium",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.description}),e.jsx("span",{className:"inline-block mt-2 px-2 py-1 text-xs rounded-full bg-gray-100",children:s.category})]},s.id))})]}),o==="inspect"&&c&&e.jsx(me,{item:c,onSubmit:U,onSkip:()=>n(s=>s+1)}),o==="complete"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-green-600"}),e.jsx("p",{className:"font-medium text-green-800",children:"All items checked!"})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Items"}),e.jsx("p",{className:"text-2xl font-semibold",children:S.length})]}),e.jsxs("div",{className:"p-4 bg-green-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Passed"}),e.jsx("p",{className:"text-2xl font-semibold text-green-600",children:S.filter(s=>s.result==="pass").length})]}),e.jsxs("div",{className:"p-4 bg-red-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Failed"}),e.jsx("p",{className:"text-2xl font-semibold text-red-600",children:S.filter(s=>s.result==="fail").length})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Final Notes"}),e.jsx("textarea",{value:w,onChange:s=>C(s.target.value),className:"w-full px-3 py-2 border rounded-lg",rows:4,placeholder:"Add any final notes..."})]})]}),o==="inventory"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Quality Check Passed!"}),e.jsx("p",{className:"text-sm text-blue-600",children:"Set selling prices and add items to inventory"})]})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2 flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Profit Margin (%)"]}),e.jsx("input",{type:"number",value:$||"",onChange:s=>{const u=parseFloat(s.target.value);T(isNaN(u)?0:u)},className:"w-full px-3 py-2 border rounded-lg",placeholder:"30",min:"0",max:"100",step:"5"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Selling price will be calculated as: Cost Price Ã— (1 + ",$,"%)"]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2 flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),"Default Location (Optional)"]}),e.jsx("input",{type:"text",value:P,onChange:s=>R(s.target.value),className:"w-full px-3 py-2 border rounded-lg",placeholder:"e.g., Warehouse A, Shelf 3"})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Preview"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Items to add:"}),e.jsx("span",{className:"font-medium",children:S.filter(s=>s.result==="pass").length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Profit margin:"}),e.jsxs("span",{className:"font-medium",children:[$,"%"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Location:"}),e.jsx("span",{className:"font-medium",children:P||"Not specified"})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-6 border-t bg-gray-50",children:[e.jsx("button",{onClick:t,className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-3",children:[o==="template"&&e.jsx("button",{onClick:K,disabled:!x||Q,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:Q?"Starting...":"Start Check"}),o==="complete"&&e.jsx("button",{onClick:l,disabled:Q,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",children:Q?"Completing...":"Complete Check"}),o==="inventory"&&e.jsxs("button",{onClick:d,disabled:Q,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4"}),Q?"Adding to Inventory...":"Add to Inventory"]})]})]})]})}):null},me=({item:k,onSubmit:i,onSkip:t})=>{var E,$,T,P,R,O,K,U,l,d;const[r,a]=_.useState("pass"),[o,f]=_.useState(((E=k.purchaseOrderItem)==null?void 0:E.quantity)||0),[m,N]=_.useState((($=k.purchaseOrderItem)==null?void 0:$.quantity)||0),[x,I]=_.useState(0),[j,M]=_.useState(""),[S,A]=_.useState(""),[F,n]=_.useState("accept"),[w,C]=_.useState(""),Q=()=>{i(k.id,r,o,m,x,j||void 0,S||void 0,F,w||void 0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-medium mb-2",children:[(P=(T=k.purchaseOrderItem)==null?void 0:T.product)==null?void 0:P.name," - ",(O=(R=k.purchaseOrderItem)==null?void 0:R.variant)==null?void 0:O.name]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("span",{children:["SKU: ",(U=(K=k.purchaseOrderItem)==null?void 0:K.variant)==null?void 0:U.sku]}),e.jsxs("span",{children:["Qty: ",(l=k.purchaseOrderItem)==null?void 0:l.quantity]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900",children:k.criteriaName}),((d=k.criteria)==null?void 0:d.description)&&e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:k.criteria.description})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-3",children:"Check Result"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>{a("pass"),N(o),I(0)},className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${r==="pass"?"border-green-500 bg-green-50":"border-gray-200"}`,children:[e.jsx(H,{className:`w-6 h-6 ${r==="pass"?"text-green-600":"text-gray-400"}`}),e.jsx("span",{className:r==="pass"?"text-green-700":"text-gray-600",children:"Pass"})]}),e.jsxs("button",{onClick:()=>a("fail"),className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${r==="fail"?"border-red-500 bg-red-50":"border-gray-200"}`,children:[e.jsx(ue,{className:`w-6 h-6 ${r==="fail"?"text-red-600":"text-gray-400"}`}),e.jsx("span",{className:r==="fail"?"text-red-700":"text-gray-600",children:"Fail"})]}),e.jsxs("button",{onClick:()=>a("na"),className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${r==="na"?"border-gray-500 bg-gray-50":"border-gray-200"}`,children:[e.jsx(J,{className:`w-6 h-6 ${r==="na"?"text-gray-600":"text-gray-400"}`}),e.jsx("span",{className:r==="na"?"text-gray-700":"text-gray-600",children:"N/A"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Checked"}),e.jsx("input",{type:"number",value:o||"",onChange:c=>{const s=Number(c.target.value);f(isNaN(s)?0:s)},className:"w-full px-3 py-2 border rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Passed"}),e.jsx("input",{type:"number",value:m||"",onChange:c=>{const s=Number(c.target.value);N(isNaN(s)?0:s)},className:"w-full px-3 py-2 border rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Failed"}),e.jsx("input",{type:"number",value:x||"",onChange:c=>{const s=Number(c.target.value);I(isNaN(s)?0:s)},className:"w-full px-3 py-2 border rounded-lg"})]})]}),r==="fail"&&e.jsxs("div",{className:"space-y-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Defect Type"}),e.jsxs("select",{value:j,onChange:c=>M(c.target.value),className:"w-full px-3 py-2 border rounded-lg",children:[e.jsx("option",{value:"",children:"Select defect type"}),e.jsx("option",{value:"physical_damage",children:"Physical Damage"}),e.jsx("option",{value:"functional_issue",children:"Functional Issue"}),e.jsx("option",{value:"missing_parts",children:"Missing Parts"}),e.jsx("option",{value:"cosmetic_defect",children:"Cosmetic Defect"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Defect Description"}),e.jsx("textarea",{value:S,onChange:c=>A(c.target.value),className:"w-full px-3 py-2 border rounded-lg",rows:3,placeholder:"Describe the defect..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Action Taken"}),e.jsxs("select",{value:F,onChange:c=>n(c.target.value),className:"w-full px-3 py-2 border rounded-lg",children:[e.jsx("option",{value:"accept",children:"Accept"}),e.jsx("option",{value:"reject",children:"Reject"}),e.jsx("option",{value:"return",children:"Return to Supplier"}),e.jsx("option",{value:"replace",children:"Request Replacement"}),e.jsx("option",{value:"repair",children:"Send for Repair"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Notes"}),e.jsx("textarea",{value:w,onChange:c=>C(c.target.value),className:"w-full px-3 py-2 border rounded-lg",rows:3,placeholder:"Add any notes..."})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsx("button",{onClick:t,className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:"Skip"}),e.jsx("button",{onClick:Q,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Next"})]})]})};export{ye as C,fe as P,be as Q,xe as S,Y as a};
