import{a1 as S,s as $,j as t}from"./index-61458a34.js";import{r as c}from"./vendor-36d2c7c1.js";import{N as B,p as Y,af as le,q as ie,v as ce,cI as de,bw as ue,R as he,an as me,z as m}from"./ui-28e30067.js";import{M as pe}from"./MobileAddCustomerModal-ee9fad7d.js";import{u as xe,a as q}from"./useMobileBranch-d96f1509.js";import{dataPreloadService as fe}from"./dataPreloadService-9ec6c84e.js";import{a as ge}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";import"./phoneUtils-a8934478.js";import"./useSuccessModal-081786c4.js";import"./useBodyScrollLock-341c8b9f.js";import"./SuccessModalIcons-fe811e4d.js";import"./MobileSheetContent-25c73501.js";import"./enhancedCacheManager-afe341e0.js";import"./variantHelpers-318d278a.js";const Ae=()=>{const V=ge(),{currentBranch:i,loading:M,isDataShared:R}=xe(),j=S(e=>e.customers),Q=S(e=>e.isCacheValid("customers"));S(e=>e.isPreloading);const[p,H]=c.useState(""),[w,K]=c.useState("name"),[P,G]=c.useState("asc"),[x,f]=c.useState([]),[g,A]=c.useState(!0),[J,z]=c.useState(!1),[X,b]=c.useState(!1),[_,y]=c.useState({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0}),[T,E]=c.useState(0),[h,W]=c.useState(0),v=c.useRef(null),L=e=>{let s=e.total_spent||e.total_purchases||0,a=0;return typeof s=="string"&&(s=parseFloat(s.replace(/[^0-9.-]/g,""))),isNaN(s)||!isFinite(s)||s>1e15?a=0:s>1e8?a=s/100:a=s,a=Math.max(0,a),{id:e.id,name:e.name||`${e.first_name||""} ${e.last_name||""}`.trim()||"Unnamed Customer",phone:e.phone||e.mobile||e.whatsapp||"No phone",email:e.email,address:e.address||e.location_description||e.city,totalPurchases:a,lastPurchase:e.last_purchase_date?new Date(e.last_purchase_date).toLocaleDateString():void 0,avatar:void 0}},k=e=>{const s=new Date;s.setDate(s.getDate()-30);const a=e.filter(r=>{if(!r.lastPurchase)return!1;try{return new Date(r.lastPurchase)>=s}catch{return!1}}).length;let l=0;e.forEach(r=>{const n=r.totalPurchases||0;isFinite(n)&&!isNaN(n)&&n>=0?l+=n:console.warn(`âš ï¸ Skipping invalid purchase value for ${r.name}:`,n)}),l>1e15&&(console.error("âŒ Total revenue calculation resulted in unrealistic value:",l),console.log("ðŸ“Š Client purchase values:",e.map(r=>({name:r.name,purchases:r.totalPurchases}))),l=0);const d=e.length>0?l/e.length:0;return{totalClients:e.length,activeClients:a,totalRevenue:isFinite(l)?l:0,avgPurchase:isFinite(d)?d:0}},D=async(e=!0,s=!1)=>{var a,l;if(!M)try{if(console.log("ðŸ” [MobileClients] Loading customers for branch:",i==null?void 0:i.name),!s&&Q&&j.length>0){console.log(`ðŸ“¦ [MobileClients] Using cached data (${j.length} customers)`);let o=j;i&&(o=j.filter(O=>O.branch_id?O.branch_id===i.id:!0),console.log(`ðŸª [MobileClients] Filtered to ${o.length} customers for branch`));const u=o.map(L);f(u);const F=k(u);y(F),e&&m.success(`Loaded ${u.length} customers from cache`);return}console.log("ðŸ”„ [MobileClients] Fetching fresh data from database");let d=$.from("customers").select("*").order("name",{ascending:!0});if(i){const o=R("customers");console.log("ðŸª [MobileClients] Branch filter:",{branchId:i.id,mode:i.data_isolation_mode,isShared:o}),d=q(d,i.id,i.data_isolation_mode,o)}let{data:r,error:n}=await d;if(console.log("ðŸ“Š Customers query result:",{recordCount:(r==null?void 0:r.length)||0,hasError:!!n,error:n==null?void 0:n.message}),r&&r.length>0&&console.log("ðŸ” Raw database values (first 3 customers):",r.slice(0,3).map(o=>({name:o.name,total_spent:o.total_spent,total_purchases:o.total_purchases,type_spent:typeof o.total_spent,type_purchases:typeof o.total_purchases}))),!r||r.length===0){console.log("ðŸ”„ Trying lats_customers table...");let o=$.from("lats_customers").select("*").order("name",{ascending:!0});if(i){const F=R("customers");o=q(o,i.id,i.data_isolation_mode,F)}const u=await o;console.log("ðŸ“Š Lats_customers query result:",{recordCount:((a=u.data)==null?void 0:a.length)||0,hasError:!!u.error,error:(l=u.error)==null?void 0:l.message}),u.data&&u.data.length>0&&(r=u.data,n=u.error)}if(n)throw console.error("âŒ Database error:",n),n;if(!r||r.length===0){console.warn("âš ï¸ No customers found in database"),e&&m("No customers found. Add your first customer to get started!"),f([]),y({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0});return}const N=r.map(L);S.getState().setCustomers(r),console.log("ðŸ’¾ Updated global customer cache with fresh data"),console.log("âœ… Successfully loaded customers:",N.length),console.log("ðŸ’° Customer purchase values:",N.map(o=>({name:o.name,totalPurchases:o.totalPurchases,type:typeof o.totalPurchases,isFinite:isFinite(o.totalPurchases)}))),f(N);const I=k(N);console.log("ðŸ“Š Calculated Stats:",I),y(I),e&&m.success(`Loaded ${N.length} customers`)}catch(d){console.error("âŒ Error fetching customers:",d),m.error(`Failed to load customers: ${d.message}`),f([]),y({totalClients:0,activeClients:0,totalRevenue:0,avgPurchase:0})}};c.useEffect(()=>{const e=async()=>{A(!0),await D(),A(!1)};e();const s=()=>{console.log("ðŸ”„ [MobileClients] Branch changed, reloading customers..."),e()};return window.addEventListener("branchChanged",s),()=>{window.removeEventListener("branchChanged",s)}},[i,M]),c.useEffect(()=>{console.log("ðŸ“¡ Setting up real-time subscription for customers...");const e=$.channel("customers-changes").on("postgres_changes",{event:"*",schema:"public",table:"customers"},s=>{console.log("ðŸ”” Customer change detected:",s),D(!1)}).subscribe();return()=>{console.log("ðŸ”Œ Cleaning up real-time subscription"),e.unsubscribe()}},[]);const Z=e=>{v.current&&v.current.scrollTop===0&&E(e.touches[0].clientY)},ee=e=>{if(T>0&&v.current&&v.current.scrollTop===0){const a=e.touches[0].clientY-T;a>0&&a<120&&W(a)}},te=async()=>{if(h>80){z(!0),await D(!1,!0);try{await fe.refreshData("customers")}catch(e){console.error("âŒ Error refreshing customer cache:",e)}m.success("Refreshed!"),z(!1)}E(0),W(0)},se=e=>{const s=e.trim().split(" ");return s.length>=2?`${s[0][0]}${s[s.length-1][0]}`.toUpperCase():e.substring(0,2).toUpperCase()},ae=e=>!e||isNaN(e)||!isFinite(e)?"$0":e>1e12?"$"+U(e):new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),U=e=>{if(e===0||e===null||e===void 0||isNaN(e)||!isFinite(e))return"0";if(e>1e15||e<-1e15)return console.error("âš ï¸ Number too large for display:",e),"0";const s=Math.abs(e);return s>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":s>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":s>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toFixed(0)},C=x.filter(e=>{var s;return e.name.toLowerCase().includes(p.toLowerCase())||e.phone.includes(p)||((s=e.email)==null?void 0:s.toLowerCase().includes(p.toLowerCase()))}).sort((e,s)=>{let a=0;switch(w){case"name":a=e.name.localeCompare(s.name);break;case"purchases":a=(e.totalPurchases||0)-(s.totalPurchases||0);break;case"recent":const l=e.lastPurchase?new Date(e.lastPurchase).getTime():0,d=s.lastPurchase?new Date(s.lastPurchase).getTime():0;a=l-d;break}return P==="asc"?a:-a}),re=()=>{G(P==="asc"?"desc":"asc")},oe=()=>{const e=["name","purchases","recent"],a=(e.indexOf(w)+1)%e.length;K(e[a])},ne=()=>{switch(w){case"name":return"Sorted alphabetically";case"purchases":return"Sorted by purchases";case"recent":return"Sorted by recent activity";default:return"Sorted"}};return t.jsxs("div",{className:"flex flex-col h-full bg-white",children:[t.jsxs("div",{className:"px-4 pt-3 pb-2",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h1",{className:"text-[32px] font-bold text-black tracking-tight",children:"Clients"}),t.jsx("button",{onClick:()=>b(!0),className:"flex items-center justify-center text-blue-500 hover:text-blue-600 active:text-blue-700 transition-colors flex-shrink-0 p-1","aria-label":"Add client",children:t.jsx(B,{size:28,strokeWidth:2.5})})]}),!g&&x.length>0&&t.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[t.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 border border-blue-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(Y,{size:14,className:"text-blue-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-blue-700",children:"Total"})]}),t.jsx("div",{className:"text-[20px] font-bold text-blue-900",children:_.totalClients})]}),t.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 border border-green-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(le,{size:14,className:"text-green-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-green-700",children:"Active"})]}),t.jsx("div",{className:"text-[20px] font-bold text-green-900",children:_.activeClients})]}),t.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-3 border border-purple-200",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx(ie,{size:14,className:"text-purple-600",strokeWidth:2.5}),t.jsx("span",{className:"text-[11px] font-medium text-purple-700",children:"Revenue"})]}),t.jsxs("div",{className:"text-[20px] font-bold text-purple-900",children:["$",U(_.totalRevenue)]})]})]}),t.jsxs("div",{className:"relative mb-2",children:[t.jsx(ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16,strokeWidth:2}),t.jsx("input",{type:"text",placeholder:"Search by name, phone, or email",value:p,onChange:e=>H(e.target.value),className:"w-full pl-9 pr-4 py-2 bg-[#f2f2f7] border-0 rounded-lg focus:outline-none focus:ring-0 text-gray-900 placeholder-gray-400 text-[15px] font-light",style:{WebkitAppearance:"none"}})]}),t.jsxs("div",{className:"flex items-center justify-between py-2.5 px-0.5",children:[t.jsxs("button",{onClick:oe,className:"flex items-center gap-1.5 hover:opacity-70 transition-opacity",children:[t.jsx(de,{size:16,className:"text-blue-500",strokeWidth:2.5}),t.jsx("span",{className:"text-gray-900 font-normal text-[15px]",children:ne()})]}),t.jsx("button",{onClick:re,className:"p-0.5 hover:opacity-70 transition-opacity","aria-label":"Toggle sort order",children:t.jsx(ue,{size:16,strokeWidth:2.5,className:`text-blue-500 transition-transform ${P==="desc"?"rotate-180":""}`})})]}),!g&&p&&t.jsx("div",{className:"py-1 px-0.5",children:t.jsxs("span",{className:"text-[13px] text-gray-500",children:[C.length," of ",x.length," clients"]})})]}),g&&t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-3"}),t.jsx("p",{className:"text-gray-500 text-[15px]",children:"Loading clients..."})]})}),h>0&&!g&&t.jsxs("div",{className:"flex items-center justify-center py-2 transition-all",style:{transform:`translateY(${Math.min(h,80)}px)`,opacity:Math.min(h/80,1)},children:[t.jsx(he,{size:20,className:`text-blue-500 ${J||h>80?"animate-spin":""}`,strokeWidth:2.5}),t.jsx("span",{className:"ml-2 text-[14px] text-blue-500 font-medium",children:h>80?"Release to refresh":"Pull to refresh"})]}),!g&&t.jsxs("div",{ref:v,className:"flex-1 overflow-y-auto pb-20",onTouchStart:Z,onTouchMove:ee,onTouchEnd:te,children:[C.map((e,s)=>t.jsxs("div",{onClick:()=>V(`/mobile/clients/${e.id}`),className:"flex items-center gap-3 px-4 py-3 border-b border-[#e5e5ea] hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors",style:{borderBottomWidth:s===C.length-1?"0":"0.5px"},children:[t.jsx("div",{className:"flex-shrink-0 w-11 h-11 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-semibold text-[15px] shadow-sm",children:se(e.name)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-[16px] font-semibold text-gray-900 truncate",children:e.name}),e.lastPurchase&&t.jsx("span",{className:"flex-shrink-0 px-1.5 py-0.5 text-[10px] font-medium bg-green-100 text-green-700 rounded",children:"Active"})]}),t.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.jsx("span",{className:"text-[13px] text-gray-500 truncate",children:e.phone}),e.totalPurchases>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-gray-300",children:"â€¢"}),t.jsx("span",{className:"text-[13px] font-medium text-gray-700",children:ae(e.totalPurchases)})]})]})]}),t.jsx(me,{size:18,className:"text-gray-400 flex-shrink-0",strokeWidth:2})]},e.id)),C.length===0&&t.jsxs("div",{className:"text-center py-16 px-4",children:[t.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4",children:t.jsx(Y,{size:40,className:"text-gray-400",strokeWidth:1.5})}),t.jsx("p",{className:"text-gray-900 text-[17px] font-semibold mb-2",children:"No clients found"}),t.jsx("p",{className:"text-[15px] text-gray-500 mb-6 max-w-sm mx-auto",children:x.length===0?"Start building your customer base by adding your first client":"Try adjusting your search or filters"}),x.length===0&&t.jsxs("button",{onClick:()=>b(!0),className:"inline-flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm",children:[t.jsx(B,{size:20,strokeWidth:2.5}),"Add First Client"]})]})]}),t.jsx(pe,{isOpen:X,onClose:()=>b(!1),onCustomerCreated:e=>{const s={id:e.id,name:e.name,phone:e.phone,email:e.email||"",address:e.city||"",totalPurchases:e.totalSpent||0,lastPurchase:e.lastVisit,avatar:void 0};f(a=>{const l=[s,...a];return y(k(l)),l}),b(!1),m.success(`Customer "${e.name}" added successfully!`)},onAddAnother:()=>{b(!0)}})]})};export{Ae as default};
