import{a as B,s as L,j as e}from"./index-61458a34.js";import{r as n}from"./vendor-36d2c7c1.js";import{n as m,v as E,a9 as G,ax as W}from"./ui-28e30067.js";import{format as F}from"./format-aff4c6a2.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";const Z=y=>{const b=y.length,f=/[^\x00-\x7F]/.test(y),u=f?70:160,j=Math.ceil(b/u);return{charCount:b,smsUnits:j,charsPerSMS:u,encoding:f?"Unicode":"GSM-7"}},se=()=>{const{startLoading:y,completeLoading:b,failLoading:f}=B(),[u,j]=n.useState([]),[l,p]=n.useState(new Set),[D,C]=n.useState(!0),[k,T]=n.useState(!1),[g,N]=n.useState(""),[v,V]=n.useState(""),[a,h]=n.useState({loyaltyLevel:"all",colorTag:"all",city:"all",minSpent:"",maxSpent:"",minPoints:"",activeOnly:!0,hasDevices:"all",lastVisit:"all"}),[P,Y]=n.useState(()=>{const s=localStorage.getItem("sms_price_per_unit");return s?parseFloat(s):50}),[w,I]=n.useState(!1),[S,_]=n.useState(!1),z={"win-back":{title:"Win-Back Inactive Customers",message:"Hi [Name], we noticed it's been a while since your last visit! We'd love to see you again. Get 20% off your next repair. Reply VISIT to book.",description:"For customers who haven't visited in 90+ days"},"vip-exclusive":{title:"VIP Exclusive Offer",message:"Dear [Name], as one of our valued VIP customers, you're invited to an exclusive 30% off on all services this month. Thank you for your continued trust!",description:"For Platinum/VIP customers"},"loyalty-reward":{title:"Loyalty Points Reminder",message:"Hi [Name]! You have [Points] loyalty points ready to use. That's [Amount] TZS in savings! Visit us today to redeem them.",description:"For customers with high points balance"},"high-spender":{title:"Thank You - High Value",message:"Thank you for being one of our top customers, [Name]! As appreciation, enjoy free diagnostics on your next device. We value your business!",description:"For customers who spent over 500K TZS"},"new-service":{title:"New Service Announcement",message:"Hi [Name]! We've launched a new service that might interest you. [Service Name] - now available with special introductory pricing. Call us to learn more!",description:"General announcement for active customers"},"appointment-reminder":{title:"Appointment Follow-up",message:"Hi [Name], this is a friendly reminder about your appointment on [Date] at [Time]. Reply CONFIRM or call us. See you soon!",description:"For customers with upcoming appointments"},"device-ready":{title:"Device Repair Complete",message:"Good news [Name]! Your [Device] is ready for pickup. Our store is open 8AM-8PM daily. Thank you for your patience!",description:"For customers with completed repairs"},"feedback-request":{title:"Service Feedback",message:"Hi [Name], thank you for choosing us! How was your experience? Reply with a rating 1-5 or visit our store to share feedback. Your opinion matters!",description:"Post-service feedback request"},birthday:{title:"Birthday Special",message:"Happy Birthday [Name]! ðŸŽ‰ Celebrate with us - get 25% off any service this month. Wishing you a fantastic year ahead!",description:"For customers with birthdays this month"},"referral-incentive":{title:"Referral Program",message:"Hi [Name]! Refer a friend to us and you both get 15% off your next service. Share the love and save together!",description:"Encourage referrals from satisfied customers"}};n.useEffect(()=>{$()},[]);const $=async()=>{const s=y("Loading customers...");try{C(!0);const{data:t,error:o}=await L.from("customers").select("id, name, phone, email, city, total_spent, loyalty_level, color_tag, last_visit, is_active, points").order("name");if(o)throw o;j(t||[]),b(s)}catch(t){console.error("Error fetching customers:",t),f(s,"Failed to load customers"),m.error("Failed to load customers")}finally{C(!1)}},A=n.useMemo(()=>Array.from(new Set(u.map(s=>s.city).filter(Boolean))),[u]),d=n.useMemo(()=>u.filter(t=>{var o;if(v){const r=v.toLowerCase();if(!t.name.toLowerCase().includes(r)&&!t.phone.toLowerCase().includes(r)&&!((o=t.email)!=null&&o.toLowerCase().includes(r)))return!1}if(a.loyaltyLevel!=="all"&&t.loyalty_level!==a.loyaltyLevel||a.colorTag!=="all"&&t.color_tag!==a.colorTag||a.city!=="all"&&t.city!==a.city||a.minSpent&&(t.total_spent||0)<parseFloat(a.minSpent)||a.maxSpent&&(t.total_spent||0)>parseFloat(a.maxSpent)||a.minPoints&&(t.points||0)<parseFloat(a.minPoints)||a.activeOnly&&!t.is_active)return!1;if(a.lastVisit!=="all"&&t.last_visit){const r=new Date(t.last_visit),c=Math.floor((new Date().getTime()-r.getTime())/(1e3*60*60*24));switch(a.lastVisit){case"7days":if(c>7)return!1;break;case"30days":if(c>30)return!1;break;case"90days":if(c>90)return!1;break;case"6months":if(c>180)return!1;break;case"1year":if(c>365)return!1;break}}return!0}),[u,v,a]),M=n.useMemo(()=>{const s=[];d.length===0&&s.push({type:"warning",text:"No customers match your filters"});const t=d.filter(i=>i.loyalty_level==="platinum"||i.color_tag==="vip");t.length>0&&s.push({type:"vip",text:`${t.length} VIP customers found`,action:()=>{const i=new Set(t.map(c=>c.id));p(i),m.success(`Selected ${t.length} VIP customers`)}});const o=d.filter(i=>i.last_visit?Math.floor((Date.now()-new Date(i.last_visit).getTime())/(1e3*60*60*24))>90:!1);o.length>0&&s.push({type:"inactive",text:`${o.length} customers haven't visited in 90+ days`,action:()=>{const i=new Set(o.map(c=>c.id));p(i),m.success(`Selected ${o.length} inactive customers`)}});const r=d.filter(i=>(i.total_spent||0)>5e5);return r.length>0&&s.push({type:"highspender",text:`${r.length} customers have spent over 500,000 TZS`,action:()=>{const i=new Set(r.map(c=>c.id));p(i),m.success(`Selected ${r.length} high spenders`)}}),s},[d]),O=s=>{const t=new Set(l);t.has(s)?t.delete(s):t.add(s),p(t)},H=()=>{l.size===d.length?p(new Set):p(new Set(d.map(s=>s.id)))},x=Z(g),R=l.size*x.smsUnits*P,U=async()=>{if(l.size===0){m.error("Please select at least one customer");return}if(!g.trim()){m.error("Please enter a message");return}try{T(!0);const t=u.filter(r=>l.has(r.id)).map(r=>({recipient_phone:r.phone,message:g,status:"pending",created_at:new Date().toISOString(),sent_at:new Date().toISOString()})),{error:o}=await L.from("sms_logs").insert(t);if(o)throw o;m.success(`Successfully queued ${l.size} SMS messages!`),N(""),p(new Set)}catch(s){console.error("Error sending bulk SMS:",s),m.error("Failed to send SMS messages")}finally{T(!1)}};return D?e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Bulk SMS"}),e.jsx("p",{className:"text-gray-600",children:"Send SMS to multiple customers at once with smart filtering"})]}),M.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"ðŸ’¡ Smart Suggestions"}),e.jsx("div",{className:"space-y-2",children:M.map((s,t)=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg ${s.type==="warning"?"bg-yellow-50 border border-yellow-200":s.type==="vip"?"bg-purple-50 border border-purple-200":s.type==="inactive"?"bg-orange-50 border border-orange-200":"bg-green-50 border border-green-200"}`,children:[e.jsx("span",{className:"text-sm text-gray-700",children:s.text}),s.action&&e.jsx("button",{onClick:s.action,className:"px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm",children:"Select These"})]},t))})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name, phone, or email...",value:v,onChange:s=>V(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("button",{onClick:()=>I(!w),className:`px-4 py-2 rounded-lg flex items-center gap-2 ${w?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"}`,children:[e.jsx(G,{size:20}),"Filters"]})]}),w&&e.jsxs("div",{className:"border-t pt-4 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Loyalty Level"}),e.jsxs("select",{value:a.loyaltyLevel,onChange:s=>h({...a,loyaltyLevel:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"all",children:"All Levels"}),e.jsx("option",{value:"platinum",children:"Platinum"}),e.jsx("option",{value:"gold",children:"Gold"}),e.jsx("option",{value:"silver",children:"Silver"}),e.jsx("option",{value:"bronze",children:"Bronze"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Color Tag"}),e.jsxs("select",{value:a.colorTag,onChange:s=>h({...a,colorTag:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"all",children:"All Tags"}),e.jsx("option",{value:"vip",children:"VIP"}),e.jsx("option",{value:"new",children:"New"}),e.jsx("option",{value:"complainer",children:"Complainer"}),e.jsx("option",{value:"purchased",children:"Purchased"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"City"}),e.jsxs("select",{value:a.city,onChange:s=>h({...a,city:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"all",children:"All Cities"}),A.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Visit"}),e.jsxs("select",{value:a.lastVisit,onChange:s=>h({...a,lastVisit:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"all",children:"Any Time"}),e.jsx("option",{value:"7days",children:"Last 7 days"}),e.jsx("option",{value:"30days",children:"Last 30 days"}),e.jsx("option",{value:"90days",children:"Last 90 days"}),e.jsx("option",{value:"6months",children:"Last 6 months"}),e.jsx("option",{value:"1year",children:"Last year"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Min Spent (TZS)"}),e.jsx("input",{type:"number",value:a.minSpent,onChange:s=>h({...a,minSpent:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Min Points"}),e.jsx("input",{type:"number",value:a.minPoints,onChange:s=>h({...a,minPoints:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"0"})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:a.activeOnly,onChange:s=>h({...a,activeOnly:s.target.checked}),className:"w-4 h-4 text-blue-600 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Show active customers only"})]})}),e.jsx("div",{className:"col-span-2 flex gap-2",children:e.jsx("button",{onClick:()=>h({loyaltyLevel:"all",colorTag:"all",city:"all",minSpent:"",maxSpent:"",minPoints:"",activeOnly:!0,hasDevices:"all",lastVisit:"all"}),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300",children:"Clear Filters"})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Customers (",d.length,")"]}),e.jsx("button",{onClick:H,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:l.size===d.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:d.map(s=>e.jsx("div",{onClick:()=>O(s.id),className:`p-4 rounded-lg border-2 cursor-pointer transition-all ${l.has(s.id)?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-6 h-6 rounded flex items-center justify-center ${l.has(s.id)?"bg-blue-600":"bg-gray-200"}`,children:l.has(s.id)&&e.jsx(W,{size:16,className:"text-white"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-sm text-gray-600",children:s.phone})]})]}),e.jsxs("div",{className:"text-right",children:[s.loyalty_level&&e.jsx("span",{className:`inline-block px-2 py-1 rounded text-xs font-medium ${s.loyalty_level==="platinum"?"bg-purple-100 text-purple-800":s.loyalty_level==="gold"?"bg-yellow-100 text-yellow-800":s.loyalty_level==="silver"?"bg-gray-100 text-gray-800":"bg-orange-100 text-orange-800"}`,children:s.loyalty_level}),s.total_spent&&e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Spent: ",F.money(s.total_spent)]})]})]})},s.id))})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Compose Message"}),e.jsxs("button",{onClick:()=>_(!S),className:"text-sm text-blue-600 hover:text-blue-800 font-medium",children:[S?"Hide":"Show"," Templates"]})]}),S&&e.jsxs("div",{className:"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-3",children:"ðŸ“ Message Templates"}),e.jsx("div",{className:"space-y-2",children:Object.entries(z).map(([s,t])=>e.jsxs("button",{onClick:()=>{N(t.message),_(!1),m.success(`Template "${t.title}" loaded!`)},className:"w-full text-left p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all",children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:t.title}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:t.description})]},s))}),e.jsx("div",{className:"mt-3 text-xs text-gray-500",children:"ðŸ’¡ Tip: Use [Name], [Points], [Device], [Date], [Time], [Amount] as placeholders"})]}),e.jsx("textarea",{value:g,onChange:s=>N(s.target.value),placeholder:"Type your message here or use a template above...",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4",rows:6}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Characters:"}),e.jsx("span",{className:"font-medium text-gray-900",children:x.charCount})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"SMS Units (each):"}),e.jsx("span",{className:"font-medium text-gray-900",children:x.smsUnits})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Encoding:"}),e.jsx("span",{className:"font-medium text-gray-900",children:x.encoding})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Price per SMS:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[P," TZS"]})]})]})}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-3",children:"ðŸ“Š Summary"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Recipients:"}),e.jsx("span",{className:"font-bold text-gray-900",children:l.size})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total SMS Units:"}),e.jsx("span",{className:"font-bold text-gray-900",children:l.size*x.smsUnits})]}),e.jsxs("div",{className:"border-t border-green-300 pt-2 mt-2 flex justify-between",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total Cost:"}),e.jsx("span",{className:"text-lg font-bold text-green-700",children:F.money(R)})]})]})]}),e.jsx("button",{onClick:U,disabled:k||l.size===0||!g.trim(),className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium",children:k?"Sending...":`Send to ${l.size} Customer${l.size!==1?"s":""}`})]})})]})]})})};export{se as default};
