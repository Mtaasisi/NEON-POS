import{_ as x}from"./supabase-cf010ec4.js";import{s as d}from"./index-61458a34.js";class S{async fetchLoyaltyCustomersPaginated(e=1,t=50,r,a,n){try{console.log(`ğŸ” Fetching loyalty customers page ${e} with ${t} per page...`);const{getCurrentBranchId:o,isDataShared:u}=await x(()=>import("./index-61458a34.js").then(i=>i.bb),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);let l=d.from("customers").select("id",{count:"exact",head:!0});const c=o(),f=await u("customers");c&&!f&&(l=l.or(`branch_id.eq.${c},is_shared.eq.true`)),a&&a!=="all"&&(l=l.eq("loyalty_level",a)),n&&n!=="all"&&(l=l.eq("is_active",n==="active"));const{count:p,error:P}=await l;if(P)return console.error("Error getting customer count:",P),{customers:[],totalCount:0,currentPage:e,totalPages:0,hasNextPage:!1,hasPreviousPage:!1};console.log(`ğŸ“Š Total customers matching filters: ${p}`);const _=(e-1)*t,g=Math.ceil((p||0)/t);let s=d.from("customers").select("*").order("created_at",{ascending:!1}).range(_,_+t-1);c&&!f&&(s=s.or(`branch_id.eq.${c},is_shared.eq.true`)),a&&a!=="all"&&(s=s.eq("loyalty_level",a)),n&&n!=="all"&&(s=s.eq("is_active",n==="active"));const{data:y,error:C}=await s;if(C)return console.error("âŒ Error fetching loyalty customers:",{message:C.message||"Unknown error",details:C.details||"No details",hint:C.hint||"No hint",code:C.code||"No code"}),{customers:[],totalCount:p||0,currentPage:e,totalPages:g,hasNextPage:!1,hasPreviousPage:e>1};if(console.log(`ğŸ“Š Fetched ${(y==null?void 0:y.length)||0} customers for page ${e}`),!y||y.length===0)return{customers:[],totalCount:p||0,currentPage:e,totalPages:g,hasNextPage:!1,hasPreviousPage:e>1};const v=y.map(i=>({id:i.id,name:i.name||"Unknown Customer",phone:i.phone||"",email:i.email||"",points:i.points||0,tier:this.mapLoyaltyLevel(i.loyalty_level),totalSpent:i.total_spent||0,joinDate:i.joined_date||i.created_at,lastPurchase:i.last_purchase||i.last_visit||i.created_at,orders:i.total_orders||0,status:i.is_active?"active":"inactive",loyaltyLevel:i.loyalty_level||"interested",lastVisit:i.last_visit||i.created_at,isActive:i.is_active||!1,customerId:i.id}));let h=v;r&&(h=v.filter(i=>i.name.toLowerCase().includes(r.toLowerCase())||i.phone.includes(r)||i.email.toLowerCase().includes(r.toLowerCase())),console.log(`ğŸ” Found ${h.length} customers matching search query: "${r}"`));const w=e<g,q=e>1;return console.log(`âœ… Returning ${h.length} loyalty customers for page ${e} of ${g}`),{customers:h,totalCount:p||0,currentPage:e,totalPages:g,hasNextPage:w,hasPreviousPage:q}}catch(o){return console.error("âŒ Error fetching loyalty customers with pagination:",{message:(o==null?void 0:o.message)||(o==null?void 0:o.toString())||"Unknown error",stack:(o==null?void 0:o.stack)||"No stack trace",name:(o==null?void 0:o.name)||"Unknown error type",errorObject:o}),{customers:[],totalCount:0,currentPage:e,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}}}async fetchLoyaltyCustomers(e,t,r){try{console.log("ğŸ” Fetching all loyalty customers...");const{getCurrentBranchId:a,isDataShared:n}=await x(()=>import("./index-61458a34.js").then(s=>s.bb),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);let o=d.from("customers").select("id",{count:"exact",head:!0});const u=a(),l=await n("customers");u&&!l&&(o=o.or(`branch_id.eq.${u},is_shared.eq.true`));const{count:c,error:f}=await o;if(f)return console.error("Error getting customer count:",f),[];console.log(`ğŸ“Š Total customers in database: ${c}`);const p=[],P=1e3,_=Math.ceil((c||0)/P);for(let s=0;s<_;s++){const y=s*P,C=Math.min(y+P-1,(c||0)-1);console.log(`ğŸ“¦ Fetching batch ${s+1}/${_} (customers ${y+1}-${C+1})`);let v=d.from("customers").select(`
            id, name, email, phone, gender, city, birth_month, birth_day, total_returns, profile_image, created_at, updated_at, whatsapp, notes, is_active, loyalty_level, color_tag, referred_by, total_spent, points, last_visit, created_by, referral_source, initial_notes, referrals, customer_tag
          `).order("created_at",{ascending:!1}).range(y,C);u&&!l&&(v=v.or(`branch_id.eq.${u},is_shared.eq.true`)),t&&t!=="all"&&(v=v.eq("loyalty_level",t)),r&&r!=="all"&&(v=v.eq("is_active",r==="active"));const{data:h,error:w}=await v;if(w){console.error(`Error fetching batch ${s+1}:`,w);continue}if(h&&h.length>0){const q=h.map(m=>m.id),{data:i}=await d.from("customer_payments").select("customer_id, payment_date").in("customer_id",q).order("payment_date",{ascending:!1}),{data:$}=await d.from("devices").select("customer_id, created_at").in("customer_id",q),E=new Map;i==null||i.forEach(m=>{E.has(m.customer_id)||E.set(m.customer_id,[]),E.get(m.customer_id).push(m)});const b=new Map;$==null||$.forEach(m=>{b.has(m.customer_id)||b.set(m.customer_id,[]),b.get(m.customer_id).push(m)});const L=h.map(m=>({...m,customer_payments:E.get(m.id)||[],devices:b.get(m.id)||[]}));p.push(...L)}}if(console.log(`ğŸ“Š Fetched ${p.length} customers for loyalty program`),p.length===0)return[];const g=p.map(s=>{var i,$,E,b,L,m;const y=((i=s.customer_payments)==null?void 0:i.length)||0,C=(($=s.devices)==null?void 0:$.length)||0,v=y+C,h=(b=(E=s.customer_payments)==null?void 0:E[0])==null?void 0:b.payment_date,w=(m=(L=s.devices)==null?void 0:L[0])==null?void 0:m.created_at,q=h&&w?new Date(h)>new Date(w)?h:w:h||w||s.last_visit;return{id:s.id,name:s.name||"Unknown Customer",phone:s.phone||"",email:s.email||"",points:s.points||0,tier:this.mapLoyaltyLevel(s.loyalty_level),totalSpent:s.total_spent||0,joinDate:s.joined_date||s.created_at,lastPurchase:q||s.last_visit||s.created_at,orders:v,status:s.is_active?"active":"inactive",loyaltyLevel:s.loyalty_level||"interested",lastVisit:s.last_visit||s.created_at,isActive:s.is_active||!1,customerId:s.id}});if(e){const s=g.filter(y=>y.name.toLowerCase().includes(e.toLowerCase())||y.phone.includes(e)||y.email.toLowerCase().includes(e.toLowerCase()));return console.log(`ğŸ” Found ${s.length} customers matching search query: "${e}"`),s}return console.log(`âœ… Returning ${g.length} loyalty customers`),g}catch(a){return console.error("Error fetching loyalty customers:",a),[]}}async calculateLoyaltyMetrics(){try{const e=localStorage.getItem("current_branch_id");console.log("ğŸ¯ [LoyaltyMetrics] Configuration:"),console.log("   - Current Branch ID:",e||"âŒ NOT SET"),console.log("   - ğŸŒ CUSTOMERS: SHARED ACROSS ALL BRANCHES");const{count:t,error:r}=await d.from("customers").select("id",{count:"exact",head:!0});if(r)return console.error("Error getting customer count:",r),{totalCustomers:0,totalPoints:0,vipCustomers:0,activeCustomers:0,totalSpent:0,averagePoints:0};const{data:a,error:n}=await d.from("customers").select("points, loyalty_level, is_active, total_spent").limit(2e3);if(n)return console.error("Error fetching customers for metrics:",n),{totalCustomers:t||0,totalPoints:0,vipCustomers:0,activeCustomers:0,totalSpent:0,averagePoints:0};const{data:o,error:u}=await d.from("lats_sales").select("total_amount, status").eq("status","completed");u&&console.error("Error fetching sales for total revenue calculation:",u),console.log("ğŸ” Sales data for revenue calculation:",{salesCount:(o==null?void 0:o.length)||0,salesData:o==null?void 0:o.slice(0,5),salesError:u});const l=t||0,c=(a||[]).reduce((_,g)=>_+(g.points||0),0),f=(a||[]).filter(_=>_.loyalty_level==="vip").length,p=(a||[]).filter(_=>_.is_active).length,P=(o||[]).reduce((_,g)=>_+(parseFloat(g.total_amount)||0),0);return console.log("ğŸ’° Total loyalty sales revenue calculated:",P),console.log(`ğŸ“Š Calculated metrics: ${l} total customers, ${c} total points, ${f} VIP customers, ${p} active customers, ${P} total revenue`),{totalCustomers:l,totalPoints:c,vipCustomers:f,activeCustomers:p,totalSpent:P,averagePoints:l>0?Math.round(c/l):0}}catch(e){return console.error("Error calculating loyalty metrics:",e),{totalCustomers:0,totalPoints:0,vipCustomers:0,activeCustomers:0,totalSpent:0,averagePoints:0}}}getLoyaltyTiers(){return[{name:"Bronze",minPoints:0,maxPoints:999,discount:0,benefits:["Basic rewards","Email updates"]},{name:"Silver",minPoints:1e3,maxPoints:1999,discount:2,benefits:["2% discount","Priority support","Free delivery on orders over 50,000 TZS"]},{name:"Gold",minPoints:2e3,maxPoints:4999,discount:3,benefits:["3% discount","Free delivery","Birthday rewards","Exclusive offers"]},{name:"Platinum",minPoints:5e3,maxPoints:999999,discount:5,benefits:["5% discount","Exclusive offers","Personal account manager","VIP events"]}]}getAvailableRewards(){return[{id:"1",name:"Free Delivery",points:500,description:"Free delivery on next order",active:!0},{id:"2",name:"10% Off Next Purchase",points:1e3,description:"10% discount on next purchase",active:!0},{id:"3",name:"Free Product",points:2e3,description:"Free product up to TZS 10,000",active:!0},{id:"4",name:"VIP Event Access",points:5e3,description:"Access to exclusive VIP events",active:!0}]}async fetchPointHistory(e){try{let t=d.from("points_transactions").select("*").order("created_at",{ascending:!1});e&&(t=t.eq("customer_id",e));const{data:r,error:a}=await t;return a?(console.error("Error fetching point history:",a),[]):r?r.map(n=>{var o;return{customerId:n.customer_id,type:n.transaction_type,points:n.points_change,reason:n.reason,date:n.created_at,orderId:(o=n.metadata)==null?void 0:o.order_id,deviceId:n.device_id,createdBy:n.created_by}}):[]}catch(t){return console.error("Error fetching point history:",t),[]}}async updateCustomerPoints(e,t,r,a="adjusted",n){try{const{data:o,error:u}=await d.from("customers").select("points").eq("id",e).single();if(u)return console.error("Error fetching customer points:",u),!1;const l=(o==null?void 0:o.points)||0,c=Math.max(0,l+t),{error:f}=await d.from("customers").update({points:c}).eq("id",e);if(f)return console.error("Error updating customer points:",f),!1;const{error:p}=await d.from("points_transactions").insert({customer_id:e,points_change:t,transaction_type:a,reason:r,device_id:n,created_by:"system",metadata:{order_id:null}});return p&&console.error("Error creating point transaction:",p),!0}catch(o){return console.error("Error updating customer points:",o),!1}}async updateCustomerTier(e){try{const{data:t,error:r}=await d.from("customers").select("points, loyalty_level").eq("id",e).single();if(r)return console.error("Error fetching customer for tier update:",r),!1;const a=(t==null?void 0:t.points)||0,n=(t==null?void 0:t.loyalty_level)||"interested",o=this.calculateTierFromPoints(a);if(o!==n){const{error:u}=await d.from("customers").update({loyalty_level:o}).eq("id",e);if(u)return console.error("Error updating customer tier:",u),!1;await this.updateCustomerPoints(e,0,`Tier upgraded from ${n} to ${o}`,"adjusted")}return!0}catch(t){return console.error("Error updating customer tier:",t),!1}}mapLoyaltyLevel(e){switch(e==null?void 0:e.toLowerCase()){case"vip":return"vip";case"premium":return"premium";case"regular":return"regular";case"active":return"active";case"payment_customer":return"payment_customer";case"engaged":return"engaged";case"interested":default:return"interested"}}calculateTierFromPoints(e){return e>=1e3?"vip":e>=700?"premium":e>=400?"regular":e>=200?"active":e>=100?"payment_customer":e>=50?"engaged":"interested"}async getCustomers(){try{const{data:e,error:t}=await d.from("customers").select("*").limit(100);return t?(console.error("Error fetching customers:",t),[]):(e==null?void 0:e.map(r=>({id:r.id,name:r.name||"Unknown",phone:r.phone||"",email:r.email||"",points:r.points||0,tier:this.mapLoyaltyLevel(r.loyalty_level),totalSpent:r.total_spent||0,joinDate:r.created_at||"",lastPurchase:r.last_purchase||"",orders:r.orders||0,status:r.is_active?"active":"inactive",loyaltyLevel:r.loyalty_level||"bronze",lastVisit:r.last_visit||"",isActive:r.is_active||!1,customerId:r.id})))||[]}catch(e){return console.error("Error in getCustomers:",e),[]}}async getMetrics(){try{const{data:e,error:t}=await d.from("customers").select("points, total_spent, is_active, loyalty_level");if(t)return console.error("Error fetching metrics:",t),{totalCustomers:0,totalPoints:0,vipCustomers:0,activeCustomers:0,totalSpent:0,averagePoints:0};const r=(e==null?void 0:e.length)||0,a=(e==null?void 0:e.reduce((c,f)=>c+(f.points||0),0))||0,n=(e==null?void 0:e.filter(c=>c.loyalty_level==="vip"||c.loyalty_level==="premium").length)||0,o=(e==null?void 0:e.filter(c=>c.is_active).length)||0,u=(e==null?void 0:e.reduce((c,f)=>c+(f.total_spent||0),0))||0,l=r>0?a/r:0;return{totalCustomers:r,totalPoints:a,vipCustomers:n,activeCustomers:o,totalSpent:u,averagePoints:l}}catch(e){return console.error("Error in getMetrics:",e),{totalCustomers:0,totalPoints:0,vipCustomers:0,activeCustomers:0,totalSpent:0,averagePoints:0}}}async getTiers(){return[{name:"Bronze",minPoints:0,maxPoints:999,discount:5,benefits:["Basic rewards"]},{name:"Silver",minPoints:1e3,maxPoints:1999,discount:10,benefits:["Enhanced rewards","Priority support"]},{name:"Gold",minPoints:2e3,maxPoints:4999,discount:15,benefits:["Premium rewards","Exclusive offers"]},{name:"Platinum",minPoints:5e3,maxPoints:999999,discount:20,benefits:["VIP rewards","Personal concierge"]}]}async getRewards(){return[{id:"1",name:"10% Discount",pointsRequired:100,description:"Get 10% off your next purchase",active:!0,type:"discount"},{id:"2",name:"Free Shipping",pointsRequired:200,description:"Free shipping on your next order",active:!0,type:"discount"},{id:"3",name:"Free Product",pointsRequired:500,description:"Get a free product of your choice",active:!0,type:"free_item"},{id:"4",name:"VIP Treatment",pointsRequired:1e3,description:"Exclusive VIP treatment and priority service",active:!0,type:"cashback"}]}async getPointHistory(e){try{const{data:t,error:r}=await d.from("points_transactions").select("*").eq("customer_id",e).order("created_at",{ascending:!1}).limit(50);return r?(console.error("Error fetching point history:",r),[]):(t==null?void 0:t.map(a=>{var n;return{customerId:a.customer_id,type:a.transaction_type,amount:a.points_change,reason:a.reason,timestamp:new Date(a.created_at),orderId:(n=a.metadata)==null?void 0:n.order_id,deviceId:a.device_id,createdBy:a.created_by}}))||[]}catch(t){return console.error("Error in getPointHistory:",t),[]}}async addPoints(e,t,r){return this.updateCustomerPoints(e,t,r,"adjusted")}async redeemReward(e,t){try{const a=(await this.getRewards()).find(n=>n.id===t);return a?this.updateCustomerPoints(e,-a.pointsRequired,`Redeemed: ${a.name}`,"redeemed"):(console.error("Reward not found:",t),!1)}catch(r){return console.error("Error redeeming reward:",r),!1}}async getRedemptionHistory(e){try{const{data:t,error:r}=await d.from("points_transactions").select("*").eq("customer_id",e).eq("transaction_type","redeemed").order("created_at",{ascending:!1}).limit(20);return r?(console.error("Error fetching redemption history:",r),[]):(t==null?void 0:t.map(a=>({rewardName:a.reason,pointsUsed:Math.abs(a.points_change),redeemedAt:a.created_at})))||[]}catch(t){return console.error("Error in getRedemptionHistory:",t),[]}}}const D=new S;export{D as c};
