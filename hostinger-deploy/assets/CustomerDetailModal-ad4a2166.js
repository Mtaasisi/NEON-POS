import{_ as St}from"./supabase-cf010ec4.js";import{j as e,s as p,u as Ct,b as Dt,ab as kt,k as G,ac as nt,G as ge,ad as Mt,ae as Lt}from"./index-61458a34.js";import{r as d,b as At}from"./vendor-36d2c7c1.js";import{G as Pt}from"./GlassTabs-05c8a392.js";import{a as Et,c as $t}from"./appointments-0b344a33.js";import{ae as ue,X as ct,J as Tt,N as It,aq as Me,n as b,S as De,d as ke,$ as Z,o as J,P as fe,M as mt,r as xt,br as ht,q as qt,a as Rt,b as Wt,c8 as Ft,c9 as Ot,ca as Vt,af as gt,p as pe,k as ne,I as Bt,b7 as it,s as Ut,_ as zt,Z as Ht,as as Y,T as dt,aO as Gt,aE as Jt,m as Zt,a8 as Qt}from"./ui-28e30067.js";import Kt from"./whatsappService-09f99080.js";import{M as le}from"./Modal-a5e4c1ba.js";import{C as Xt}from"./CustomerForm-3440546b.js";import{f as Yt}from"./returns-8e3dd741.js";import{A as es}from"./AppointmentModal-91a07df7.js";import{format as Ce}from"./format-aff4c6a2.js";import{f as ts}from"./index-5a6a7dda.js";import{u as ss}from"./useBodyScrollLock-341c8b9f.js";const as=({isOpen:r,onClose:_,customerId:t,customerName:U,currentPoints:y,loyaltyLevel:O,onPointsUpdated:f})=>{const[j,M]=d.useState(0),[A,i]=d.useState(""),[$,u]=d.useState(!1);if(!r)return null;const z=async()=>{if(j===0){b.error("Please enter a valid points amount");return}u(!0);try{const x=y+j,{error:q}=await p.from("customers").update({points:x,updated_at:new Date().toISOString()}).eq("id",t);if(q)throw q;try{await p.from("customer_points_history").insert({customer_id:t,points_change:j,new_balance:x,reason:A||"Manual adjustment",created_at:new Date().toISOString()})}catch(S){console.warn("Could not log points history:",S)}b.success(`${j>0?"Added":"Deducted"} ${Math.abs(j)} points`),f(x),M(0),i(""),_()}catch(x){console.error("Error updating points:",x),b.error("Failed to update points: "+(x.message||"Unknown error"))}finally{u(!1)}};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm",onClick:_}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-md w-full",onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center",children:e.jsx(ue,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Manage Points"}),e.jsx("p",{className:"text-sm text-gray-600",children:U})]})]}),e.jsx("button",{onClick:_,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors",children:e.jsx(ct,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-700 font-medium",children:"Current Points"}),e.jsx("p",{className:"text-3xl font-bold text-purple-900",children:y})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-purple-700 font-medium",children:"Loyalty Level"}),e.jsx("p",{className:"text-lg font-semibold text-purple-900",children:O})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Points to Add/Deduct"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>M(x=>x-10),className:"p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors",children:e.jsx(Tt,{className:"w-4 h-4"})}),e.jsx("input",{type:"number",value:j,onChange:x=>M(parseInt(x.target.value)||0),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-center text-lg font-semibold",placeholder:"0"}),e.jsx("button",{type:"button",onClick:()=>M(x=>x+10),className:"p-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors",children:e.jsx(It,{className:"w-4 h-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["New balance: ",y+j," points"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>M(50),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+50"}),e.jsx("button",{type:"button",onClick:()=>M(100),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+100"}),e.jsx("button",{type:"button",onClick:()=>M(200),className:"px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors text-sm font-medium",children:"+200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason (Optional)"}),e.jsx("textarea",{value:A,onChange:x=>i(x.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"e.g., Loyalty reward, Compensation, Birthday bonus..."})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50",children:[e.jsx("button",{onClick:_,className:"px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors text-sm font-medium",disabled:$,children:"Cancel"}),e.jsx("button",{onClick:z,disabled:$||j===0,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white rounded-lg transition-colors text-sm font-medium",children:$?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"w-4 h-4"}),j>0?"Add":"Deduct"," Points"]})})]})]})]})},rs=({customerId:r,customerPhone:_})=>{const[t,U]=d.useState([]),[y,O]=d.useState(!0),[f,j]=d.useState("all");d.useEffect(()=>{M()},[r]);const M=async()=>{try{O(!0);const i=[],{data:$}=await p.from("devices").select("*").eq("customer_id",r).order("created_at",{ascending:!1});$==null||$.forEach(l=>{i.push({id:`device-${l.id}`,type:"device",title:`Device: ${l.brand} ${l.model}`,description:l.problem_description||l.issue_description||"No description",date:l.created_at,icon:De,color:"bg-blue-500",metadata:{status:l.status,id:l.id}}),l.status==="completed"&&l.actual_completion_date&&i.push({id:`device-completed-${l.id}`,type:"device",title:"Device Repair Completed",description:`${l.brand} ${l.model} - Repair finished`,date:l.actual_completion_date,icon:ke,color:"bg-green-500",metadata:{deviceId:l.id}})});const{data:u}=await p.from("sms_logs").select("*").eq("recipient_phone",_).order("created_at",{ascending:!1});u==null||u.forEach(l=>{i.push({id:`sms-${l.id}`,type:"sms",title:"SMS Sent",description:l.message.substring(0,100)+(l.message.length>100?"...":""),date:l.sent_at||l.created_at,icon:Z,color:"bg-purple-500",metadata:{status:l.status}})});const{data:z}=await p.from("customer_communications").select("*").eq("customer_id",r).order("sent_at",{ascending:!1});z==null||z.forEach(l=>{var be;const H=l.type==="whatsapp"?J:l.type==="call"?fe:l.type==="email"?mt:Z;i.push({id:`comm-${l.id}`,type:l.type,title:`${l.type.charAt(0).toUpperCase()+l.type.slice(1)} Communication`,description:((be=l.message)==null?void 0:be.substring(0,100))||"Communication sent",date:l.sent_at||l.created_at,icon:H,color:l.type==="whatsapp"?"bg-green-600":l.type==="call"?"bg-blue-600":"bg-gray-600",metadata:{status:l.status}})});const{data:x}=await p.from("appointments").select("*").eq("customer_id",r).order("created_at",{ascending:!1});x==null||x.forEach(l=>{i.push({id:`apt-${l.id}`,type:"appointment",title:`Appointment: ${l.service_type}`,description:`Scheduled for ${l.appointment_date} at ${l.appointment_time}`,date:l.created_at,icon:xt,color:"bg-orange-500",metadata:{status:l.status,date:l.appointment_date}})});const{data:q}=await p.from("lats_sales").select("*").eq("customer_id",r).order("created_at",{ascending:!1});q==null||q.forEach(l=>{i.push({id:`sale-${l.id}`,type:"purchase",title:"Purchase",description:`Bought items worth ${Ce.money(l.total_amount||0)}`,date:l.created_at,icon:ht,color:"bg-emerald-500",metadata:{amount:l.total_amount,paymentMethod:l.payment_method}})});const{data:S}=await p.from("customer_payments").select("*").eq("customer_id",r).order("created_at",{ascending:!1});S==null||S.forEach(l=>{i.push({id:`payment-${l.id}`,type:"payment",title:"Payment Received",description:`${Ce.money(l.amount||0)} via ${l.method}`,date:l.created_at,icon:qt,color:"bg-green-500",metadata:{amount:l.amount,method:l.method}})});const{data:ee}=await p.from("customer_points_history").select("*").eq("customer_id",r).order("created_at",{ascending:!1});ee==null||ee.forEach(l=>{i.push({id:`points-${l.id}`,type:"points",title:l.points_change>0?"Points Earned":"Points Redeemed",description:`${Math.abs(l.points_change)} points - ${l.reason}`,date:l.created_at,icon:l.points_change>0?ue:Me,color:l.points_change>0?"bg-yellow-500":"bg-indigo-500",metadata:{points:l.points_change}})}),i.sort((l,H)=>new Date(H.date).getTime()-new Date(l.date).getTime()),U(i)}catch(i){console.error("Error fetching customer journey:",i)}finally{O(!1)}},A=t.filter(i=>f==="all"?!0:f==="communication"?["sms","whatsapp","call","email"].includes(i.type):f==="transactions"?["purchase","payment","points"].includes(i.type):f==="service"?["device","appointment"].includes(i.type):!0);return y?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("button",{onClick:()=>j("all"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${f==="all"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["All (",t.length,")"]}),e.jsx("button",{onClick:()=>j("communication"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${f==="communication"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Communication"}),e.jsx("button",{onClick:()=>j("transactions"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${f==="transactions"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Transactions"}),e.jsx("button",{onClick:()=>j("service"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${f==="service"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Service"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-6 top-0 bottom-0 w-0.5 bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:A.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No events found for this filter"}):A.map((i,$)=>{const u=i.icon;return e.jsxs("div",{className:"relative flex items-start gap-4 pl-14",children:[e.jsx("div",{className:`absolute left-0 w-12 h-12 ${i.color} rounded-full flex items-center justify-center text-white shadow-lg z-10`,children:e.jsx(u,{size:20})}),e.jsxs("div",{className:"flex-1 bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:i.title}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:i.description})]}),e.jsx("div",{className:"text-xs text-gray-500 whitespace-nowrap ml-4",children:ts(new Date(i.date),"MMM dd, yyyy HH:mm")})]}),i.metadata&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[i.metadata.status&&e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${i.metadata.status==="completed"||i.metadata.status==="sent"||i.metadata.status==="delivered"?"bg-green-100 text-green-800":i.metadata.status==="pending"?"bg-yellow-100 text-yellow-800":i.metadata.status==="failed"||i.metadata.status==="cancelled"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:i.metadata.status}),i.metadata.amount&&e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800",children:Ce.money(i.metadata.amount)})]})]})]},i.id)})})]}),A.length>0&&e.jsxs("div",{className:"text-center text-sm text-gray-500 pt-4",children:["Showing ",A.length," of ",t.length," events"]})]})},ot=({customer:r})=>{const[_,t]=d.useState(!1),U=f=>{if(f<60)return`${Math.round(f)}m`;const j=Math.floor(f/60),M=Math.round(f%60);return`${j}h ${M}m`},y=f=>{switch(f){case"VIP":return"bg-gradient-to-r from-purple-500 to-pink-500 text-white";case"Gold":return"bg-gradient-to-r from-yellow-400 to-yellow-600 text-white";case"Silver":return"bg-gradient-to-r from-gray-400 to-gray-600 text-white";case"Bronze":return"bg-gradient-to-r from-orange-400 to-orange-600 text-white";case"Basic":return"bg-gradient-to-r from-blue-400 to-blue-600 text-white";case"New":return"bg-gradient-to-r from-green-400 to-green-600 text-white";default:return"bg-gray-200 text-gray-700"}},O=f=>{switch(f){case"VIP":return e.jsx(Me,{className:"w-4 h-4"});case"Gold":return e.jsx(ne,{className:"w-4 h-4"});case"Silver":return e.jsx(ne,{className:"w-4 h-4"});case"Bronze":return e.jsx(ne,{className:"w-4 h-4"});case"Basic":return e.jsx(pe,{className:"w-4 h-4"});case"New":return e.jsx(pe,{className:"w-4 h-4"});default:return e.jsx(pe,{className:"w-4 h-4"})}};return!r.totalCalls||r.totalCalls===0?null:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-6 h-6 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Call Analytics"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[r.callLoyaltyLevel&&e.jsxs("div",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${y(r.callLoyaltyLevel)}`,children:[O(r.callLoyaltyLevel),r.callLoyaltyLevel]}),e.jsx("button",{onClick:()=>t(!_),className:"p-1 hover:bg-gray-100 rounded-lg transition-colors",title:_?"Collapse":"Expand",children:_?e.jsx(Rt,{className:"w-5 h-5 text-gray-600"}):e.jsx(Wt,{className:"w-5 h-5 text-gray-600"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-blue-700 uppercase tracking-wide mb-1",children:"Total Calls"}),e.jsx("div",{className:"text-lg font-bold text-blue-900",children:r.totalCalls}),e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[r.incomingCalls||0," in â€¢ ",r.outgoingCalls||0," out"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-green-700 uppercase tracking-wide mb-1",children:"Duration"}),e.jsx("div",{className:"text-lg font-bold text-green-900",children:U(r.totalCallDurationMinutes||0)}),e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:["Avg: ",U(r.avgCallDurationMinutes||0)]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-purple-700 uppercase tracking-wide mb-1",children:"Call Span"}),e.jsxs("div",{className:"text-lg font-bold text-purple-900",children:[r.firstCallDate&&r.lastCallDate?Math.ceil((new Date(r.lastCallDate).getTime()-new Date(r.firstCallDate).getTime())/(1e3*60*60*24)):0," days"]}),e.jsxs("div",{className:"text-xs text-purple-600 mt-1",children:[r.totalCalls>0?Math.round(r.totalCalls/Math.max(1,Math.ceil((Date.now()-new Date(r.firstCallDate||r.createdAt||Date.now()).getTime())/(1e3*60*60*24*30)))):0,"/month"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-orange-700 uppercase tracking-wide mb-1",children:"Loyalty Level"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:r.callLoyaltyLevel||"Basic"}),e.jsxs("div",{className:"text-xs text-orange-600 mt-1",children:[r.missedCalls||0," missed calls"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-4",children:[e.jsx("div",{className:"text-xs font-medium text-indigo-700 uppercase tracking-wide mb-1",children:"Last Call"}),e.jsx("div",{className:"text-lg font-bold text-indigo-900",children:r.lastCallDate?new Date(r.lastCallDate).toLocaleDateString():"Unknown"}),e.jsxs("div",{className:"text-xs text-indigo-600 mt-1",children:[r.firstCallDate?new Date(r.firstCallDate).toLocaleDateString():"Unknown"," first"]})]})]}),_&&e.jsxs("div",{className:"space-y-6 border-t border-gray-200 pt-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ft,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Incoming"})]}),e.jsx("div",{className:"text-xl font-bold text-green-900",children:r.incomingCalls||0}),e.jsxs("div",{className:"text-xs text-green-600",children:[r.totalCalls?Math.round((r.incomingCalls||0)/r.totalCalls*100):0,"% of total"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ot,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Outgoing"})]}),e.jsx("div",{className:"text-xl font-bold text-blue-900",children:r.outgoingCalls||0}),e.jsxs("div",{className:"text-xs text-blue-600",children:[r.totalCalls?Math.round((r.outgoingCalls||0)/r.totalCalls*100):0,"% of total"]})]}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Vt,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-800",children:"Missed"})]}),e.jsx("div",{className:"text-xl font-bold text-red-900",children:r.missedCalls||0}),e.jsxs("div",{className:"text-xs text-red-600",children:[r.totalCalls?Math.round((r.missedCalls||0)/r.totalCalls*100):0,"% of total"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(xt,{className:"w-4 h-4"}),"Call Timeline"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"First Call"}),e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:r.firstCallDate?new Date(r.firstCallDate).toLocaleDateString():"Unknown"}),e.jsx("div",{className:"text-xs text-gray-500",children:r.firstCallDate?new Date(r.firstCallDate).toLocaleTimeString():""})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"Last Call"}),e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:r.lastCallDate?new Date(r.lastCallDate).toLocaleDateString():"Unknown"}),e.jsx("div",{className:"text-xs text-gray-500",children:r.lastCallDate?new Date(r.lastCallDate).toLocaleTimeString():""})]})]}),r.firstCallDate&&r.lastCallDate&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-medium text-blue-700 mb-1",children:"Call Activity Span"}),e.jsxs("div",{className:"text-lg font-semibold text-blue-900",children:[Math.ceil((new Date(r.lastCallDate).getTime()-new Date(r.firstCallDate).getTime())/(1e3*60*60*24))," days"]}),e.jsxs("div",{className:"text-xs text-blue-600",children:["From ",new Date(r.firstCallDate).toLocaleDateString()," to ",new Date(r.lastCallDate).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-indigo-800 mb-3 flex items-center gap-2",children:[e.jsx(gt,{className:"w-4 h-4"}),"Call Insights"]}),e.jsxs("div",{className:"space-y-2 text-sm text-indigo-700",children:[r.callLoyaltyLevel==="VIP"&&e.jsx("p",{children:"ðŸŒŸ This is a VIP customer with exceptional call activity!"}),r.callLoyaltyLevel==="Gold"&&e.jsx("p",{children:"â­ This customer has high call engagement and loyalty."}),r.callLoyaltyLevel==="Silver"&&e.jsx("p",{children:"ðŸ“ž This customer has been calling for more than 2 days, showing good engagement."}),r.callLoyaltyLevel==="Bronze"&&e.jsx("p",{children:"ðŸ“± This customer has made only one call - consider follow-up."}),r.totalCalls&&r.totalCalls>100&&e.jsx("p",{children:"ðŸ”¥ High call volume customer - excellent engagement!"}),r.avgCallDurationMinutes&&r.avgCallDurationMinutes>5&&e.jsx("p",{children:"â±ï¸ Long average call duration - detailed conversations."}),r.missedCalls&&r.missedCalls>r.totalCalls*.3&&e.jsx("p",{children:"âš ï¸ High missed call rate - consider alternative contact methods."})]})]})]})]})},Ns=({isOpen:r,onClose:_,customer:t,onEdit:U})=>{var et,tt,st,at,rt;const{currentUser:y}=Ct();ss(r),d.useEffect(()=>{if(r){const s=document.documentElement.style.overflow;return document.documentElement.style.overflow="hidden",()=>{document.documentElement.style.overflow=s}}},[r]);const{addNote:O,updateCustomer:f,markCustomerAsRead:j}=Dt(),[M,A]=d.useState(t),[i,$]=d.useState("overview"),[u,z]=d.useState([]),[x,q]=d.useState([]),[S,ee]=d.useState([]),[l,H]=d.useState([]),[be,Le]=d.useState([]),[Q,Ae]=d.useState(null),[ie,Pe]=d.useState(!1),[Ee,$e]=d.useState([]),[ls,Te]=d.useState([]),[Ie,ye]=d.useState([]),[ns,qe]=d.useState([]),[V,je]=d.useState(null),[Re,We]=d.useState(!1),[L,Fe]=d.useState(null),[Oe,Ve]=d.useState(!1),[pt,te]=d.useState(!1),[Ne,de]=d.useState(""),[Be,Ue]=d.useState(!1),[we,K]=d.useState(null),[ut,se]=d.useState(!1),[oe,ve]=d.useState(""),[ze,He]=d.useState(!1),[ce,X]=d.useState(null),[ft,_e]=d.useState(!1),[bt,me]=d.useState(!1),[yt,Ge]=d.useState(!1),[Je,Ze]=d.useState(!1),[jt,Qe]=d.useState(!1),[Ke,Xe]=d.useState(!1),[Nt,xe]=d.useState(!1),[wt,Se]=d.useState(!1);d.useEffect(()=>{A(t)},[t]),d.useEffect(()=>{r&&(t!=null&&t.id)&&(vt(),ae(),he())},[r,t==null?void 0:t.id]);const vt=async()=>{if(t!=null&&t.id){Pe(!0);try{z(t.devices||[]);const{data:s,error:a}=await p.from("customer_payments").select("*").eq("customer_id",t.id).order("payment_date",{ascending:!1});if(!a&&s){const g=s.map(o=>({id:o.id,customerId:o.customer_id,deviceId:o.device_id,amount:o.amount,method:o.method,type:o.payment_type,status:o.status,date:o.payment_date,createdAt:o.created_at,updatedAt:o.updated_at}));q(g)}else q(t.payments||[]);const{data:n,error:c}=await p.from("lats_sales").select(`
          id,
          sale_number,
          customer_id,
          subtotal,
          total_amount,
          payment_method,
          status,
          created_at,
          updated_at
        `).eq("customer_id",t.id).order("created_at",{ascending:!1});let h=n,v=c;if(c){console.warn("Complex customer detail sales query failed, trying simpler query:",c.message);const{data:g,error:o}=await p.from("lats_sales").select("*").eq("customer_id",t.id).order("created_at",{ascending:!1});o?(console.error("Simple customer detail sales query also failed:",o),h=[],v=null):(h=g,v=null,console.log(`âœ… Loaded ${(h==null?void 0:h.length)||0} customer detail sales (without joins)`))}else console.log(`âœ… Loaded ${(h==null?void 0:h.length)||0} customer detail sales`);if(!v&&h)if(ee(h),h.length>0){const g=h.map(B=>B.id),{data:o,error:C}=await p.from("lats_sale_items").select(`
              id,
              sale_id,
              product_id,
              variant_id,
              quantity,
              unit_price,
              total_price
            `).in("sale_id",g);if(!C&&o){const B=[...new Set(o.map(N=>N.product_id).filter(Boolean))],re=[...new Set(o.map(N=>N.variant_id).filter(Boolean))],{data:D}=await p.from("lats_products").select("id, name, description, sku").in("id",B),{data:I}=await p.from("lats_product_variants").select("id, name, sku, attributes").in("id",re),{data:R}=await p.from("sale_inventory_items").select("sale_id, inventory_item_id").in("sale_id",g);let W={};if(R&&R.length>0){const N=R.map(P=>P.inventory_item_id),{data:w}=await p.from("inventory_items").select("*").in("id",N);w&&w.forEach(P=>{const E=`${P.product_id}_${P.variant_id||"null"}`;W[E]||(W[E]=[]),W[E].push(P)})}const F=o.map(N=>{const w=h.find(E=>E.id===N.sale_id),P=`${N.product_id}_${N.variant_id||"null"}`;return{...N,saleNumber:w==null?void 0:w.sale_number,saleDate:w==null?void 0:w.created_at,paymentMethod:w==null?void 0:w.payment_method,saleStatus:w==null?void 0:w.status,product:D==null?void 0:D.find(E=>E.id===N.product_id),variant:I==null?void 0:I.find(E=>E.id===N.variant_id),serialNumbers:W[P]||[]}});H(F)}else H([])}else H([]);try{const{data:g}=await p.from("devices").select("id").eq("customer_id",t.id),o=(g==null?void 0:g.map(D=>D.id))||[];let C=[],B=null;if(o.length>0){const D=await p.from("lats_spare_part_usage").select("*").in("device_id",o).order("created_at",{ascending:!1});C=D.data||[],B=D.error}if(!B&&C&&C.length>0){const D=[...new Set(C.map(I=>I.spare_part_id).filter(Boolean))];if(D.length>0){const{data:I}=await p.from("lats_spare_parts").select("id, name, part_number, cost_price, selling_price").in("id",D),R=(I||[]).reduce((F,N)=>(F[N.id]=N,F),{}),W=C.map(F=>({...F,lats_spare_parts:R[F.spare_part_id]||null}));Le(W)}else Le(C)}const re=Ye(t.id,n||[],C||[]);Ae(re)}catch{console.log("Spare parts data not available for this customer");const o=Ye(t.id,n||[],[]);Ae(o)}}catch(s){console.error("Error fetching core customer data:",s)}finally{Pe(!1)}}},ae=async()=>{var s;if(t!=null&&t.id){We(!0);try{try{const a=await Et(t.id);$e(a||[])}catch(a){console.error("Error fetching appointments:",a),$e([])}try{const a=await Yt(t.id);Te(a||[])}catch(a){console.error("Error fetching returns:",a),Te([])}try{const{data:a,error:n}=await p.from("customer_communications").select("*").eq("customer_id",t.id).order("sent_at",{ascending:!1}).limit(50);if(!n&&a)ye(a);else{const{data:c,error:h}=await p.from("sms_logs").select("*").eq("phone_number",((s=t.phone)==null?void 0:s.replace(/\D/g,""))||"").order("created_at",{ascending:!1}).limit(50);if(!h&&c){const v=c.map(g=>({id:g.id,customer_id:t.id,type:"sms",message:g.message,status:g.status,phone_number:g.phone_number,sent_by:g.sent_by,sent_at:g.sent_at||g.created_at,created_at:g.created_at}));ye(v)}}}catch(a){console.error("Error fetching communication history:",a),ye([])}try{const{data:a,error:n}=await p.from("customers").select("id, name, phone, created_at, total_spent").eq("referred_by",t.id).order("created_at",{ascending:!1});!n&&a&&qe(a)}catch(a){console.error("Error fetching referrals:",a),qe([])}try{const{data:a,error:n}=await p.from("customer_preferences").select("*").eq("customer_id",t.id);!n&&a&&a.length>0?je(a[0]):je(null)}catch(a){console.error("Error fetching customer preferences:",a),je(null)}}catch(a){console.error("Error loading additional customer data:",a)}finally{We(!1)}}},he=async()=>{if(t!=null&&t.id){Ve(!0);try{const s=await kt(t.id);Fe(s)}catch(s){console.error("Error fetching customer status:",s),Fe(null)}finally{Ve(!1)}}},T=async s=>{if(t!=null&&t.id)try{await Lt(t.id,s),await he()}catch(a){console.error("Error tracking activity:",a)}},Ye=(s,a,n)=>{const c=a.reduce((m,k)=>m+(parseFloat(k.total_amount)||0),0),h=n.reduce((m,k)=>{var lt;return m+(parseFloat((lt=k.lats_spare_parts)==null?void 0:lt.selling_price)||0)},0),g=u.filter(m=>m.customerId===s).map(m=>m.id),o=x.filter(m=>m.deviceId&&g.includes(m.deviceId)),C=o.reduce((m,k)=>m+(k.amount||0),0),B=o.filter(m=>m.type==="deposit").reduce((m,k)=>m+(k.amount||0),0),re=o.filter(m=>m.type==="payment").reduce((m,k)=>m+(k.amount||0),0),D=o.filter(m=>m.type==="refund").reduce((m,k)=>m+(k.amount||0),0),I=C,R=c+h+I,W=a.flatMap(m=>(m.lats_sale_items||[]).map(k=>({...k,saleNumber:m.sale_number,saleDate:m.created_at,paymentMethod:m.payment_method,saleStatus:m.status}))),F=new Set(W.map(m=>m.product_id)).size,N=W.length,w=a.length>0?c/a.length:0,P=a.length>0?new Date(a[0].created_at):null,E=P?Math.floor((Date.now()-P.getTime())/(1e3*60*60*24)):null,_t=R>1e5?"Top Customer":R>5e4?"VIP Customer":"Regular Customer";return{totalSpent:R,totalPosSpent:c,totalSpareSpent:h,totalDeviceSpent:I,deviceBreakdown:{payments:re,deposits:B,refunds:D,totalPayments:C},uniqueProducts:F,totalItems:N,averageOrderValue:w,lastPurchaseDate:P,daysSinceLastPurchase:E,purchaseFrequency:a.length>0?a.length/Math.max(1,Math.floor((Date.now()-new Date((t==null?void 0:t.joinedDate)||Date.now()).getTime())/(1e3*60*60*24*30))):0,customerRanking:_t}};return!r||!t||typeof document>"u"||!document.body?null:e.jsxs(e.Fragment,{children:[At.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[99999]",style:{top:0,left:0,right:0,bottom:0,overflow:"hidden",overscrollBehavior:"none"},role:"dialog","aria-modal":"true","aria-labelledby":"customer-detail-title",onClick:_,children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{onClick:_,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(ct,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(pe,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"customer-detail-title",className:"text-2xl font-bold text-gray-900 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.phone||"No phone number"})]})]})}),e.jsx("div",{className:"bg-white flex-shrink-0 px-6 py-4",children:e.jsx(Pt,{tabs:[{id:"overview",label:"Overview",icon:e.jsx(Bt,{className:"w-4 h-4"})},{id:"transactions",label:"Transactions",icon:e.jsx(it,{className:"w-4 h-4"}),badge:S.length>0?S.length:void 0},{id:"repairs",label:"Repairs",icon:e.jsx(De,{className:"w-4 h-4"}),badge:u.length>0?u.length:void 0},{id:"communications",label:"Communications",icon:e.jsx(J,{className:"w-4 h-4"})},{id:"journey",label:"Journey",icon:e.jsx(gt,{className:"w-4 h-4"})}],activeTab:i,onTabChange:s=>$(s),variant:"modern",size:"sm"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[i==="overview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg",children:[e.jsx("div",{className:"text-xs font-medium opacity-90 mb-1",children:"Total Spent"}),e.jsx("div",{className:"text-2xl font-bold",children:ie?"...":G((Q==null?void 0:Q.totalSpent)||0).replace("Tsh ","").replace("TZS ","")})]}),e.jsxs("div",{className:"bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white shadow-lg",children:[e.jsx("div",{className:"text-xs font-medium opacity-90 mb-1",children:"Orders"}),e.jsx("div",{className:"text-2xl font-bold",children:ie?"...":S.length})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 text-white shadow-lg",children:[e.jsx("div",{className:"text-xs font-medium opacity-90 mb-1",children:"Repairs"}),e.jsx("div",{className:"text-2xl font-bold",children:ie?"...":u.length})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-lg",children:[e.jsx("div",{className:"text-xs font-medium opacity-90 mb-1",children:"Points"}),e.jsx("div",{className:"text-2xl font-bold",children:ie?"...":t.points||0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-5",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-xl shadow-lg flex-shrink-0",children:t.profileImage?e.jsx("img",{src:t.profileImage,alt:t.name,className:"w-full h-full rounded-full object-cover"}):t.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 truncate",children:t.name}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[t.loyaltyLevel&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700",children:[e.jsx(ne,{className:"w-3 h-3"}),t.loyaltyLevel]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${t.isActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.isActive?"Active":"Inactive"})]})]})]}),e.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(fe,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{children:"Phone"})]}),e.jsx("a",{href:`tel:${t.phone}`,className:"text-sm font-semibold text-blue-600 hover:text-blue-700 hover:underline",children:t.phone||"Not provided"})]}),t.whatsapp&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Z,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{children:"WhatsApp"})]}),e.jsx("a",{href:`https://wa.me/${t.whatsapp.replace(/[^0-9]/g,"")}`,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-semibold text-green-600 hover:text-green-700 hover:underline",children:t.whatsapp})]}),t.email&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(mt,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{children:"Email"})]}),e.jsx("a",{href:`mailto:${t.email}`,className:"text-sm font-semibold text-gray-900 hover:text-blue-600 hover:underline truncate max-w-[200px]",title:t.email,children:t.email})]}),t.city&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ut,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{children:"Location"})]}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.city})]})]})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-5 shadow-sm space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-3 border-b border-gray-200",children:[e.jsx(zt,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Customer Information"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Member Since"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:Oe?"...":L?new Date(L.memberSince).toLocaleDateString():t.createdAt?new Date(t.createdAt).toLocaleDateString():t.joinedDate?new Date(t.joinedDate).toLocaleDateString():"Unknown"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Last Visit"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:Oe?"...":L&&L.lastVisit?new Date(L.lastVisit).toLocaleDateString():t.lastVisit?new Date(t.lastVisit).toLocaleDateString():t.updatedAt?new Date(t.updatedAt).toLocaleDateString():"Never"}),L&&L.daysSinceActivity!==null&&e.jsx("p",{className:"text-xs text-gray-500",children:L.daysSinceActivity===0?"Today":L.daysSinceActivity===1?"1 day ago":`${L.daysSinceActivity} days ago`})]}),t.gender&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Gender"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 capitalize",children:t.gender})]}),t.country&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Country"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.country})]}),t.address&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Address"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.address})]}),t.notes&&e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Notes"}),e.jsx("p",{className:"text-sm text-gray-700 bg-gray-50 p-2 rounded-lg",children:t.notes})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-3 border-b border-gray-200 mb-4",children:[e.jsx(ke,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Status Overview"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Loyalty Level"}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-amber-100 text-amber-700",children:[e.jsx(ne,{className:"w-3 h-3"}),t.loyaltyLevel||"N/A"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total Devices"}),e.jsx("span",{className:"text-sm font-bold text-gray-900",children:u.length})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Active Repairs"}),e.jsx("span",{className:"text-sm font-bold text-orange-600",children:u.filter(s=>["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(s.status)).length})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Completed"}),e.jsx("span",{className:"text-sm font-bold text-green-600",children:u.filter(s=>s.status==="done").length})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-3 border-b border-blue-200 mb-4",children:[e.jsx(Ht,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Quick Actions"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>{te(!0),T("sms_opened")},className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Z,{className:"w-4 h-4"}),"Send SMS"]}),e.jsxs("button",{onClick:()=>{se(!0),T("whatsapp_opened")},className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(J,{className:"w-4 h-4"}),"WhatsApp"]}),e.jsxs("button",{onClick:()=>_e(!0),className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(ue,{className:"w-4 h-4"}),"Manage Points"]}),e.jsxs("button",{onClick:()=>{xe(!0),T("appointment_modal_opened")},className:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Y,{className:"w-4 h-4"}),"Book Appointment"]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-3 border-b border-gray-200 mb-4",children:[e.jsx(dt,{className:"w-5 h-5 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Customer Tags"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.colorTag&&e.jsxs("span",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium ${t.colorTag==="vip"?"bg-emerald-100 text-emerald-700":t.colorTag==="complainer"?"bg-rose-100 text-rose-700":t.colorTag==="purchased"?"bg-blue-100 text-blue-700":t.colorTag==="new"?"bg-purple-100 text-purple-700":"bg-gray-100 text-gray-700"}`,children:[e.jsx(dt,{className:"w-3 h-3"}),t.colorTag]}),t.callLoyaltyLevel&&e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${t.callLoyaltyLevel==="VIP"?"bg-purple-100 text-purple-800":t.callLoyaltyLevel==="Gold"?"bg-yellow-100 text-yellow-800":t.callLoyaltyLevel==="Silver"?"bg-gray-100 text-gray-800":t.callLoyaltyLevel==="Bronze"?"bg-orange-100 text-orange-800":"bg-blue-100 text-blue-800"}`,children:[e.jsx(fe,{className:"w-3 h-3 mr-1"}),t.callLoyaltyLevel]}),t.branchName&&t.isShared&&e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[e.jsx(Gt,{className:"w-3 h-3 mr-1"}),"Shared"]})]})]}),(t.totalCalls||0)>0&&e.jsx(ot,{customer:t})]})]})]}),i==="transactions"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white border-2 border-green-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Total Spent"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:G((Q==null?void 0:Q.totalSpent)||t.totalSpent||0).replace("Tsh ","").replace("TZS ","")})]}),e.jsxs("div",{className:"bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Orders"}),e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:S.length})]}),e.jsxs("div",{className:"bg-white border-2 border-purple-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Payments"}),e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:x.length})]}),e.jsxs("div",{className:"bg-white border-2 border-amber-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Points"}),e.jsx("div",{className:"text-2xl font-bold text-amber-600",children:t.points||0})]})]}),S.length>0&&e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"w-6 h-6 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Sales History"})]}),e.jsxs("div",{className:"text-sm font-medium text-gray-600",children:[S.length," ",S.length===1?"order":"orders"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Date"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Order ID"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Items"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Total"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"})]})}),e.jsx("tbody",{children:S.slice(0,10).map(s=>e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:new Date(s.created_at||s.date).toLocaleDateString()}),e.jsxs("td",{className:"p-3 font-medium text-blue-600",children:["#",s.id||s.sale_id]}),e.jsx("td",{className:"p-3",children:s.items_count||"N/A"}),e.jsx("td",{className:"p-3 font-medium",children:G(s.total_amount||s.total||0)}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-100 text-green-800":s.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.status||"completed"})})]},s.id))})]})})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Repair History"})})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Device"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Issue"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Created"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Total Paid"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Points"})]})}),e.jsxs("tbody",{children:[u.map(s=>{const a=x.filter(n=>n.deviceId===s.id&&n.status==="completed").reduce((n,c)=>n+(Number(c.amount)||0),0);return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[s.brand," ",s.model]}),e.jsx("div",{className:"text-xs text-gray-500",children:s.serialNumber||"No serial"})]})}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="done"?"bg-green-100 text-green-800":s.status==="failed"?"bg-red-100 text-red-800":["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(s.status)?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.status.replace(/-/g," ")})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"max-w-xs truncate",title:s.issueDescription,children:s.issueDescription})}),e.jsx("td",{className:"p-3",children:new Date(s.createdAt).toLocaleDateString()}),e.jsx("td",{className:"p-3",children:a>0?G(a):"-"}),e.jsx("td",{className:"p-3",children:e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[nt(s,t.loyaltyLevel)," pts"]})})]},s.id)}),u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-gray-500 py-4",children:"No repair history found"})})]})]})})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jt,{className:"w-6 h-6 text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Payment History"})]}),e.jsxs("div",{className:"text-sm font-medium text-gray-600",children:[G(x.reduce((s,a)=>s+(Number(a.amount)||0),0))," total"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Date"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Type"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Amount"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Method"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"})]})}),e.jsxs("tbody",{children:[x.slice(0,10).map(s=>e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:new Date(s.date).toLocaleDateString()}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.type==="payment"?"bg-green-100 text-green-800":s.type==="deposit"?"bg-blue-100 text-blue-800":"bg-orange-100 text-orange-800"}`,children:s.type})}),e.jsx("td",{className:"p-3 font-medium",children:G(s.amount)}),e.jsx("td",{className:"p-3",children:s.method}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-100 text-green-800":s.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.status})})]},s.id)),x.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center text-gray-500 py-4",children:"No payments found"})})]})]})})]}),x.length===0&&S.length===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(it,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"font-medium",children:"No transactions found"}),e.jsx("p",{className:"text-sm",children:"This customer hasn't made any purchases yet"})]})]}),i==="repairs"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white border-2 border-blue-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Total Repairs"}),e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:u.length})]}),e.jsxs("div",{className:"bg-white border-2 border-orange-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Active"}),e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:u.filter(s=>["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(s.status)).length})]}),e.jsxs("div",{className:"bg-white border-2 border-green-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Completed"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:u.filter(s=>s.status==="done").length})]}),e.jsxs("div",{className:"bg-white border-2 border-red-200 rounded-xl p-4 shadow-sm",children:[e.jsx("div",{className:"text-xs font-medium text-gray-500 mb-1",children:"Failed"}),e.jsx("div",{className:"text-2xl font-bold text-red-600",children:u.filter(s=>s.status==="failed").length})]})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-6 h-6 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Repair History"})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Device"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Issue"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Created"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Total Paid"}),e.jsx("th",{className:"text-left p-3 font-medium text-gray-700",children:"Points"})]})}),e.jsxs("tbody",{children:[u.map(s=>{const a=x.filter(n=>n.deviceId===s.id&&n.status==="completed").reduce((n,c)=>n+(Number(c.amount)||0),0);return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[s.brand," ",s.model]}),e.jsx("div",{className:"text-xs text-gray-500",children:s.serialNumber||"No serial"})]})}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="done"?"bg-green-100 text-green-800":s.status==="failed"?"bg-red-100 text-red-800":["assigned","diagnosis-started","awaiting-parts","in-repair","reassembled-testing"].includes(s.status)?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.status.replace(/-/g," ")})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"max-w-xs truncate",title:s.issueDescription,children:s.issueDescription})}),e.jsx("td",{className:"p-3",children:new Date(s.createdAt).toLocaleDateString()}),e.jsx("td",{className:"p-3",children:a>0?G(a):"-"}),e.jsx("td",{className:"p-3",children:e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[nt(s,t.loyaltyLevel)," pts"]})})]},s.id)}),u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-gray-500 py-8",children:"No repair history found"})})]})]})})]})]}),i==="communications"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 flex-wrap",children:[e.jsxs("button",{onClick:()=>{te(!0),T("sms_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Z,{className:"w-4 h-4"}),"Send SMS"]}),e.jsxs("button",{onClick:()=>{se(!0),T("whatsapp_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(J,{className:"w-4 h-4"}),"Send WhatsApp"]}),e.jsxs("button",{onClick:()=>{xe(!0),T("appointment_modal_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Y,{className:"w-4 h-4"}),"Schedule Appointment"]})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-6 h-6 text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Message History"})]})}),Re?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading communication history..."}):Ie.length>0?e.jsx("div",{className:"space-y-3",children:Ie.map((s,a)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0",children:e.jsx(Z,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"SMS"}),e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="delivered"?"bg-green-100 text-green-800":s.status==="sent"?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"}`,children:s.status})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-1",children:s.message}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleString()})]})]},a))}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(J,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No communication history found"}),e.jsx("p",{className:"text-sm",children:"Start a conversation with this customer"})]})]}),e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 space-y-4 shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-6 h-6 text-purple-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Appointments"})]})}),Re?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading appointments..."}):Ee.length>0?e.jsx("div",{className:"space-y-3",children:Ee.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center",children:e.jsx(Y,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.service_type}),e.jsxs("p",{className:"text-sm text-gray-500",children:[new Date(s.appointment_date).toLocaleDateString()," at ",s.appointment_time]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-100 text-green-800":s.status==="confirmed"?"bg-blue-100 text-blue-800":s.status==="pending"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:s.status}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[s.duration_minutes," min"]})]})]},s.id))}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Y,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No appointments found"}),e.jsx("p",{className:"text-sm",children:"Schedule the first appointment for this customer"})]})]}),(t.totalCalls||0)>0&&e.jsx(ot,{customer:t})]}),i==="journey"&&e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-6 shadow-sm",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Customer Journey"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Complete timeline of all interactions and activities"})]}),e.jsx(rs,{customerId:t.id,customerPhone:t.phone})]})]}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{te(!0),T("sms_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Z,{className:"w-4 h-4"}),"SMS"]}),e.jsxs("button",{onClick:()=>{se(!0),T("whatsapp_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(J,{className:"w-4 h-4"}),"WhatsApp"]}),e.jsxs("button",{onClick:()=>_e(!0),className:"flex items-center gap-2 px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(ue,{className:"w-4 h-4"}),"Points"]}),e.jsxs("button",{onClick:()=>{xe(!0),T("appointment_modal_opened")},className:"flex items-center gap-2 px-4 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg font-medium text-sm",children:[e.jsx(Y,{className:"w-4 h-4"}),"Schedule"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:_,className:"px-5 py-2.5 border-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl transition-colors text-sm font-medium",children:"Close"}),e.jsxs("button",{onClick:()=>me(!0),className:"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl transition-all shadow-lg hover:shadow-xl font-semibold text-sm",children:[e.jsx(Zt,{className:"w-4 h-4"}),"Edit"]})]})]})})]})}),document.body),e.jsx(le,{isOpen:pt,onClose:()=>{te(!1),de(""),K(null)},title:"Send SMS",maxWidth:"400px",zIndex:1e5,children:e.jsxs("form",{onSubmit:async s=>{s.preventDefault(),Ue(!0),K(null);try{const a=t.phone.replace(/\D/g,"");console.log("ðŸ“± Attempting to send message (smart routing: WhatsApp first, SMS fallback) to:",a);const{smartNotificationService:n}=await St(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),c=await n.sendNotification(a,Ne);if(console.log("ðŸ“± Smart Notification Result:",c),c.success){const h=c.method==="whatsapp"?"WhatsApp":"SMS",v=c.method==="whatsapp"?"whatsapp":"sms";let g=!1;try{const{data:o,error:C}=await p.from("customer_communications").insert({customer_id:t.id,type:v,message:Ne,status:"sent",phone_number:a,sent_by:y==null?void 0:y.id,sent_at:new Date().toISOString()}).select().single();C?console.warn("âš ï¸ Could not log to customer_communications table:",C.message):(g=!0,console.log(`âœ… ${h} logged to customer_communications table`))}catch(o){console.warn("âš ï¸ Exception logging customer communication:",o)}K(`âœ… ${h} message sent successfully!`),de(""),b.success(`${h} message sent successfully!`);try{await ae()}catch(o){console.warn("âš ï¸ Could not refresh communication history:",o)}}else{const h=c.error||"Unknown error occurred";console.error("âŒ SMS Failed:",h),K(`Failed: ${h}`),b.error(`SMS Failed: ${h}`)}}catch(a){console.error("âŒ SMS sending error:",a);let n="Failed to send SMS";a!=null&&a.message?n=a.message:a!=null&&a.error?n=typeof a.error=="string"?a.error:JSON.stringify(a.error):typeof a=="string"&&(n=a),K(`âŒ ${n}`),b.error(n)}finally{Ue(!1)}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"To"}),e.jsx("div",{className:"py-2 px-4 bg-blue-50 text-blue-700 font-medium rounded",children:t.phone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"Message"}),e.jsx("textarea",{value:Ne,onChange:s=>de(s.target.value),rows:3,className:"w-full py-2 px-4 bg-white/30 backdrop-blur-md border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50",placeholder:"Type your message here",required:!0})]}),we&&e.jsx("div",{className:`text-sm ${we.startsWith("Failed")?"text-red-600":"text-green-600"}`,children:we}),e.jsxs("div",{className:"flex gap-3 justify-end mt-4",children:[e.jsx(ge,{type:"button",variant:"secondary",onClick:()=>{te(!1),de(""),K(null)},children:"Cancel"}),e.jsx(ge,{type:"submit",variant:"primary",disabled:Be,children:Be?"Sending...":"Send SMS"})]})]})}),e.jsx(le,{isOpen:ut,onClose:()=>{se(!1),ve(""),X(null)},title:"Send WhatsApp Message",maxWidth:"400px",zIndex:1e5,children:e.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),!!oe.trim()){He(!0),X(null);try{const a=t.whatsapp||t.phone;if(!a)throw new Error("No phone number or WhatsApp number available for this customer");console.log("ðŸ’¬ Attempting to send WhatsApp to:",a);const n=await Kt.sendMessage(a,oe);if(console.log("ðŸ’¬ WhatsApp Service Result:",n),n.success){let c=!1;try{const{data:v,error:g}=await p.from("customer_communications").insert({customer_id:t.id,type:"whatsapp",message:oe,phone_number:a,status:"sent",sent_by:y==null?void 0:y.id,sent_at:new Date().toISOString(),created_at:new Date().toISOString()}).select().single();g?(console.warn("âš ï¸ Could not log to customer_communications table:",g.message),console.warn("   This is not critical - WhatsApp message was still sent")):(c=!0,console.log("âœ… WhatsApp message logged to customer_communications table"))}catch(v){console.warn("âš ï¸ Exception logging customer communication:",v)}X(`âœ… WhatsApp message sent${c?" and logged":""} successfully!`),b.success("WhatsApp message sent successfully!");try{await ae()}catch(v){console.warn("âš ï¸ Could not refresh communication history:",v)}}else{const c=n.error||"Unknown error occurred";console.error("âŒ WhatsApp Failed:",c),X(`âŒ ${c}`),b.error(`WhatsApp Failed: ${c}`)}}catch(a){console.error("âŒ WhatsApp sending error:",a);let n="Failed to send WhatsApp message";a!=null&&a.message?n=a.message:a!=null&&a.error?n=typeof a.error=="string"?a.error:JSON.stringify(a.error):typeof a=="string"&&(n=a),X(`âŒ ${n}`),b.error(n)}finally{He(!1)}}},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"To"}),e.jsx("div",{className:"py-2 px-4 bg-green-50 text-green-700 font-medium rounded",children:t.whatsapp||t.phone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 mb-1 font-medium",children:"Message"}),e.jsx("textarea",{value:oe,onChange:s=>ve(s.target.value),rows:4,className:"w-full py-2 px-4 bg-white/30 backdrop-blur-md border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/50",placeholder:"Type your WhatsApp message here...",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Message will be sent via WasenderAPI"})]}),ce&&e.jsx("div",{className:`text-sm ${ce.startsWith("âŒ")||ce.includes("Failed")?"text-red-600":"text-green-600"}`,children:ce}),e.jsxs("div",{className:"flex gap-3 justify-end mt-4",children:[e.jsx(ge,{type:"button",variant:"secondary",onClick:()=>{se(!1),ve(""),X(null)},children:"Cancel"}),e.jsx(ge,{type:"submit",variant:"primary",disabled:ze,children:ze?"Sending...":"Send WhatsApp"})]})]})}),e.jsx(as,{isOpen:ft,onClose:()=>_e(!1),customerId:t.id,customerName:t.name,currentPoints:t.points||0,loyaltyLevel:t.loyaltyLevel,onPointsUpdated:s=>{f(t.id,{points:s})}}),e.jsx(le,{isOpen:bt,onClose:()=>me(!1),title:"Edit Customer",maxWidth:"xl",children:e.jsx(Xt,{onSubmit:async s=>{Ge(!0);try{const{notes:a,referralSourceCustom:n,...c}=s;a&&a.trim()&&await O(t.id,a.trim());const h=n&&n.trim()?n.trim():c.referralSource,v={...c,referralSource:h};await f(t.id,v)?(me(!1),A(o=>({...o,...v})),b.success("Customer updated successfully!")):b.error("Failed to update customer")}catch(a){console.error("Error updating customer:",a),b.error("Failed to update customer")}finally{Ge(!1)}},onCancel:()=>me(!1),isLoading:yt,initialValues:{id:t.id,name:t.name||"",email:t.email||"",phone:t.phone||"",whatsapp:t.whatsapp||t.phone||"",gender:t.gender==="male"||t.gender==="female"?t.gender:"male",city:t.city||"",referralSource:t.referralSource||"",birthMonth:t.birthMonth||"",birthDay:t.birthDay||"",notes:Array.isArray(t.notes)&&t.notes.length>0?t.notes[t.notes.length-1].content:typeof t.notes=="string"?t.notes:""},renderActionsInModal:!0,children:(s,a)=>e.jsxs(e.Fragment,{children:[a,s]})})}),Je&&e.jsx(le,{isOpen:Je,onClose:()=>{Ze(!1),Qe(!1)},title:"Customer Check-in",children:e.jsx("div",{className:"p-4",children:jt?e.jsxs("div",{className:"text-green-600 font-bold text-center mb-4",children:["Check-in successful! 20 points awarded.",L&&!L.isActive&&e.jsx("div",{className:"text-blue-600 text-sm mt-2",children:"Customer has been reactivated automatically."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center text-gray-700",children:[e.jsx("p",{className:"text-sm mb-2",children:"Check in this customer:"}),e.jsx("p",{className:"font-medium text-lg",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500",children:t.phone})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("button",{onClick:async()=>{Xe(!0);try{if(!(y!=null&&y.id))throw new Error("No staff user.");const s=await Mt(t.id,y.id);s.success?(Qe(!0),s.wasReactivated?b.success("Customer checked in and reactivated! Points awarded."):b.success("Check-in successful! Points awarded."),await he(),A(a=>({...a,isActive:!0,lastVisit:new Date().toISOString()}))):b.error(s.message)}catch(s){console.error("Check-in failed:",s),b.error("Check-in failed: "+(s.message||"Unknown error"))}finally{Xe(!1)}},disabled:Ke,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white rounded-lg transition-colors font-medium",children:Ke?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Checking in..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),"Check In Customer"]})}),e.jsx("button",{onClick:()=>Ze(!1),className:"w-full px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"})]})]})})}),e.jsx(es,{isOpen:Nt,onClose:()=>xe(!1),customer:t,mode:"create",onSave:async s=>{try{await $t(s),await ae(),await he(),await T("appointment_created")}catch(a){throw console.error("Error creating appointment:",a),a}}}),e.jsx(le,{isOpen:wt,onClose:()=>Se(!1),title:"Customer Preferences",maxWidth:"md",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("form",{id:"preferences-form",children:V?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Preferred Contact Method"}),e.jsxs("select",{name:"preferred_contact_method",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:V.preferred_contact_method||"whatsapp",children:[e.jsx("option",{value:"whatsapp",children:"WhatsApp"}),e.jsx("option",{value:"sms",children:"SMS"}),e.jsx("option",{value:"phone",children:"Phone Call"}),e.jsx("option",{value:"email",children:"Email"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Language"}),e.jsxs("select",{name:"language",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:V.language||"en",children:[e.jsx("option",{value:"en",children:"English"}),e.jsx("option",{value:"sw",children:"Swahili"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notification Preferences"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"repair_updates",defaultChecked:(et=V.notification_preferences)==null?void 0:et.repair_updates,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Repair Updates"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"appointment_reminders",defaultChecked:(tt=V.notification_preferences)==null?void 0:tt.appointment_reminders,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Appointment Reminders"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"promotions",defaultChecked:(st=V.notification_preferences)==null?void 0:st.promotions,className:"mr-2"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Promotions"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Quiet Hours"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"time",name:"quiet_start",defaultValue:((at=V.quiet_hours)==null?void 0:at.start)||"22:00",className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("span",{className:"flex items-center justify-center text-gray-500",children:"to"}),e.jsx("input",{type:"time",name:"quiet_end",defaultValue:((rt=V.quiet_hours)==null?void 0:rt.end)||"08:00",className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Qt,{className:"w-12 h-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No preferences set for this customer"}),e.jsx("p",{className:"text-sm",children:"Preferences will be created when first saved"})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{onClick:()=>Se(!1),className:"px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{try{const s=document.querySelector("#preferences-form");if(!s){b.error("Form not found");return}const a=new FormData(s),n={customer_id:t.id,preferred_contact_method:a.get("preferred_contact_method")||"whatsapp",language:a.get("language")||"en",notification_preferences:{repair_updates:a.get("repair_updates")==="on",appointment_reminders:a.get("appointment_reminders")==="on",promotions:a.get("promotions")==="on"},quiet_hours:{start:a.get("quiet_start")||"22:00",end:a.get("quiet_end")||"08:00"}},{error:c}=await p.from("customer_preferences").upsert(n,{onConflict:"customer_id",ignoreDuplicates:!1});if(c){console.error("Error saving preferences:",c),b.error("Failed to save preferences");return}b.success("Preferences saved successfully!"),Se(!1),await ae()}catch(s){console.error("Error saving preferences:",s),b.error("Failed to save preferences")}},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Save Preferences"})]})]})})]})};export{Ns as C};
