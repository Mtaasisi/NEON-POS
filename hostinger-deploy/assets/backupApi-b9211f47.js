import{s as _}from"./index-61458a34.js";async function U(e,u,k="full"){try{const i=await e.text(),o=JSON.parse(i);if(!o.tables||typeof o.tables!="object")return{success:!1,message:"‚ùå Invalid backup format",error:'Invalid backup format: missing "tables" object'};const b=o.tables;let h=Object.keys(b);if(u&&u.length>0?(h=h.filter(t=>u.includes(t)),console.log(`üì¶ Restoring ${h.length} selected tables out of ${Object.keys(b).length} total tables`)):console.log(`üì¶ Found ${h.length} tables to restore`),k==="schema-only")return{success:!0,message:"‚úÖ Schema-only restore completed (client-side)",data:{tablesRestored:h.length,recordsRestored:0,fileName:e.name,format:"JSON",restoreType:"schema-only",note:"Schema-only restore requires backend server for SQL execution. Data was not restored."}};let w=0,S=0;const E=[],m=[];for(const t of h)try{const c=b[t];if(!c||!c.data||!Array.isArray(c.data)){m.push(`Table ${t}: No data to restore`);continue}const r=c.data;if(r.length===0){m.push(`Table ${t}: Empty table`);continue}console.log(`üîÑ Restoring table ${t} (${r.length} records)...`);const l=100;let d=0;for(let p=0;p<r.length;p+=l){const n=r.slice(p,p+l);try{const{error:f}=await _.from(t).upsert(n,{onConflict:"id",ignoreDuplicates:!1});if(f){console.warn(`‚ö†Ô∏è Batch upsert failed for ${t}, trying individual inserts:`,f.message);for(const v of n)try{const{error:s}=await _.from(t).upsert(v,{onConflict:"id",ignoreDuplicates:!1});s?m.push(`Table ${t}: Error inserting row - ${s.message}`):S++}catch(s){m.push(`Table ${t}: Error inserting row - ${s.message}`)}}else S+=n.length;d+=n.length}catch(f){E.push(`Table ${t}: Batch error - ${f.message}`),m.push(`Skipping remaining rows for ${t} due to errors`);break}}w++,console.log(`  ‚úÖ Restored ${S} records to ${t}`)}catch(c){E.push(`Table ${t}: ${c.message}`),m.push(`Skipping table ${t} due to errors`)}return{success:!0,message:`‚úÖ Restore completed successfully (client-side)!

Tables restored: ${w}
Records restored: ${S.toLocaleString()}
Format: JSON (Client-side)`,data:{tablesRestored:w,recordsRestored:S,fileName:e.name,format:"JSON",restoreType:"full",warnings:m.length>0?m:void 0,errors:E.length>0?E:void 0}}}catch(i){return{success:!1,message:"‚ùå Client-side restore failed",error:i instanceof Error?i.message:"Unknown error"}}}const O=e=>{if(typeof AbortSignal<"u"&&"timeout"in AbortSignal)return AbortSignal.timeout(e);const u=new AbortController;return setTimeout(()=>u.abort(),e),u.signal},T=async()=>{try{const{data:{session:e}}=await _.auth.getSession();return e!=null&&e.access_token?e.access_token:localStorage.getItem("authToken")||localStorage.getItem("auth_token")||localStorage.getItem("lats-app-auth-token")||null}catch(e){return console.warn("Error getting auth token:",e),localStorage.getItem("authToken")||localStorage.getItem("auth_token")||null}},B=async e=>{try{e==null||e(0,"Fetching database schema...");const{data:u,error:k}=await _.from("information_schema.tables").select("table_name").eq("table_schema","public").order("table_name");if(k)throw new Error(`Failed to fetch database schema: ${k.message}`);const i=(u==null?void 0:u.map(s=>s.table_name))||[];console.log(`üìä Found ${i.length} tables in database (backing up ALL tables)`),e==null||e(5,`Found ${i.length} tables. Starting backup...`);const{data:o,error:b}=await _.from("information_schema.columns").select("table_name, column_name, data_type, is_nullable, column_default").eq("table_schema","public").order("table_name").order("ordinal_position");b&&console.warn("Could not fetch column schema:",b);const h={};o==null||o.forEach(s=>{h[s.table_name]||(h[s.table_name]=[]),h[s.table_name].push({name:s.column_name,type:s.data_type,nullable:s.is_nullable==="YES",default:s.column_default})}),e==null||e(10,`Schema loaded. Backing up ${i.length} tables...`);const w={timestamp:new Date().toISOString(),backupType:"FULL_SCHEMA_AND_DATA",databaseInfo:{totalTables:i.length,backupIncludes:"All tables with full schema and data (including empty tables)"},schema:h,tables:{},summary:{totalTables:0,tablesWithData:0,emptyTables:0,totalRecords:0}};let S=0,E=0,m=0,a=0;for(const s of i)try{a++;const g=10+a/i.length*85;e==null||e(g,`Backing up: ${s} (${a}/${i.length})`);const y=[];let C=0;const $=1e3;for(;;){const{data:R,error:N}=await _.from(s).select("*").range(C,C+$-1);if(N){console.log(`‚ö†Ô∏è Could not read table '${s}':`,N.message),w.tables[s]={exists:!0,recordCount:0,schema:h[s]||[],data:[],error:N.message},m++;break}if(!R||R.length===0){C===0&&(w.tables[s]={exists:!0,recordCount:0,schema:h[s]||[],data:[]},m++);break}if(y.push(...R),R.length<$)break;C+=$,await new Promise(L=>setTimeout(L,30))}if(y.length>0){const R=y.length;w.tables[s]={exists:!0,recordCount:R,schema:h[s]||[],data:y},S+=R,E++}}catch(g){w.tables[s]={exists:!0,error:(g==null?void 0:g.message)||"Unknown error",schema:h[s]||[],data:null},console.log(`‚ùå Error backing up '${s}': ${g.message}`)}w.summary.totalTables=i.length,w.summary.tablesWithData=E,w.summary.emptyTables=m,w.summary.totalRecords=S,e==null||e(95,"Saving backup file...");const t=new Date,c=t.toISOString().split("T")[0],r=t.toTimeString().split(" ")[0].replace(/:/g,"-"),l=`database-backup-${c}_${r}.json`,d=JSON.stringify(w,null,2),p=new Blob([d],{type:"application/json"}),n=URL.createObjectURL(p),f=document.createElement("a");f.href=n,f.download=l,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(n),e==null||e(100,`‚úÖ Backup completed! ${S.toLocaleString()} records from ${E} tables`);const v=(p.size/(1024*1024)).toFixed(2);return{success:!0,message:`‚úÖ Full backup completed! ${S.toLocaleString()} records from ${E} tables (${m} empty tables included)`,data:{timestamp:new Date().toISOString(),fileName:l,fileSize:`${v} MB`,totalTables:i.length,tablesWithData:E,emptyTables:m,totalRecords:S,type:"full"}}}catch(u){return console.error("Error creating full database backup:",u),{success:!1,message:"‚ùå Backup failed",error:u instanceof Error?u.message:"Unknown error"}}},F=async e=>{var u,k,i;try{if(!e)return{success:!1,error:"No backup file provided"};if(e.name.endsWith(".json"))try{const t=await e.text(),c=JSON.parse(t);if(c.tables&&typeof c.tables=="object"){const r=[];let l=0;for(const[d,p]of Object.entries(c.tables)){const n=p==null?void 0:p.data,f=Array.isArray(n)?n.length:0;r.push({name:d,recordCount:f}),l+=f}return{success:!0,data:{fileName:e.name,format:"JSON",fileSize:e.size,tables:r.sort((d,p)=>d.name.localeCompare(p.name)),totalTables:r.length,totalRecords:l,timestamp:c.timestamp}}}}catch(t){console.warn("Client-side JSON preview failed, trying server:",t)}if(e.name.endsWith(".sql"))try{const t=await e.text(),c=new Map,r=t.matchAll(/INSERT\s+INTO\s+["']?(\w+)["']?/gi);for(const n of r){const f=n[1],v=c.get(f)||0;c.set(f,v+1)}const l=t.matchAll(/COPY\s+["']?(\w+)["']?/gi);for(const n of l){const f=n[1];c.has(f)||c.set(f,0)}const d=t.match(/-- Dumped.*?(\d{4}-\d{2}-\d{2}[\s\d:]+)/i),p=d?d[1]:void 0;if(c.size>0){const n=Array.from(c.entries()).map(([v,s])=>({name:v,recordCount:s||0})),f=n.reduce((v,s)=>v+s.recordCount,0);return{success:!0,data:{fileName:e.name,format:"SQL",fileSize:e.size,tables:n.sort((v,s)=>v.name.localeCompare(s.name)),totalTables:n.length,totalRecords:f||n.length,timestamp:p}}}}catch(t){console.warn("Client-side SQL preview failed, trying server:",t)}const h="http://localhost:8000",w=new FormData;w.append("backupFile",e);const S=await T(),E={};S&&(E.Authorization=`Bearer ${S}`);const m=await fetch(`${h}/api/backup/restore/preview`,{method:"POST",headers:E,body:w,signal:O(3e4)});if(!m.ok){let t=`Server returned ${m.status}`;const c=m.clone();try{if((m.headers.get("content-type")||"").includes("application/json"))try{const l=await c.json();(window.__originalConsole||console).log("üîç Preview error response:",l),t=l.error||l.message||t}catch{const d=await m.text();d&&d.trim()&&(t=d.trim().split(`
`)[0])}else{const l=await c.text();l&&l.trim()&&(t=l.trim().split(`
`)[0])}}catch(r){(window.__originalConsole||console).error("‚ùå Error parsing preview error response:",r),m.status===401?t="Authentication required":m.status===500&&(t="Internal server error - check server logs for details")}throw new Error(t)}const a=await m.json();if(a.success)return{success:!0,data:a.data};throw new Error(a.error||"Preview failed")}catch(o){return o instanceof TypeError&&o.message.includes("fetch")||o instanceof DOMException&&o.name==="AbortError"||((u=o==null?void 0:o.message)==null?void 0:u.includes("Failed to fetch"))||((k=o==null?void 0:o.message)==null?void 0:k.includes("ERR_CONNECTION_REFUSED"))||((i=o==null?void 0:o.message)==null?void 0:i.includes("NetworkError"))?{success:!1,error:"Could not connect to restore server at http://localhost:8000/api/backup/restore/preview. Please ensure the backend server is running and accessible. For JSON files, client-side preview is available. For SQL files, the backend server is required. Set VITE_API_URL environment variable to your backend server URL."}:(console.error("Error previewing backup file:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error"})}},I=async(e,u,k="full")=>{try{if(console.log("üîÑ Restoring from backup file:",e.name),!e)return{success:!1,message:"‚ùå No backup file provided",error:"Please select a backup file to restore"};if(e.size>1024*1024*1024)return{success:!1,message:"‚ùå File too large",error:"Backup file must be less than 1GB (1024MB)"};const i=e.name.endsWith(".sql"),o=e.name.endsWith(".json");if(!i&&!o)return{success:!1,message:"‚ùå Invalid file format",error:"Only .sql and .json backup files are supported"};if(o&&k==="full")try{console.log("üîÑ Attempting client-side JSON restore...");const b=await U(e,u,k);if(b.success)return b;console.warn("‚ö†Ô∏è Client-side restore failed, trying server:",b.error)}catch(b){console.warn("‚ö†Ô∏è Client-side restore error, trying server:",b)}if(i){const b="http://localhost:8000";return console.log("üîç SQL Restore Debug:",{hasViteApiUrl:!0,viteApiUrl:"http://localhost:8000",mode:"production",windowOrigin:window.location.origin,apiBaseUrl:b}),await A(b,e,u,k,"sql")}if(o)return await A("http://localhost:8000",e,u,k,"json")}catch(i){return{success:!1,message:"‚ùå Restore failed",error:i instanceof Error?i.message:"Unknown error occurred during restore"}}};async function A(e,u,k,i="full",o="sql"){var b,h,w,S,E,m;try{const a=new FormData;a.append("backupFile",u),k&&k.length>0&&a.append("selectedTables",JSON.stringify(k)),a.append("restoreType",i);const t=await T(),c={};t&&(c.Authorization=`Bearer ${t}`);try{const r=await fetch(`${e}/api/backup/restore`,{method:"POST",headers:c,body:a,signal:O(3e5)});if(!r.ok){let d=`Server returned ${r.status}`,p=null,n=null;const f=r.clone();try{if((r.headers.get("content-type")||"").includes("application/json"))try{n=await f.json();const g=window.__originalConsole||console;if(g.log("üîç Server error response (JSON):",n),p=n.error||n.message||n.details||null,p){const y=String(p).split(`
`)[0].trim();d=y.replace(/^Restore failed:\s*/i,""),String(p)!==y&&g.error("üìã Full restore error details:",p)}else n&&(d=`Error: ${JSON.stringify(n)}`)}catch(g){const y=window.__originalConsole||console;y.warn("‚ö†Ô∏è Failed to parse JSON error response, trying text:",g);const C=await r.text();C&&C.trim()&&(d=C.trim().split(`
`)[0].replace(/^Restore failed:\s*/i,""),p=C.trim(),y.log("üîç Server error response (text):",C.substring(0,500)))}else{const g=await f.text();(window.__originalConsole||console).log("üîç Server error response (text):",g.substring(0,500)),g&&g.trim()&&(d=g.trim().split(`
`)[0].replace(/^Restore failed:\s*/i,""),p=g.trim())}}catch(s){const g=window.__originalConsole||console;g.error("‚ùå Error parsing error response:",s);try{const y=await r.text();y&&y.trim()&&(g.log("üîç Raw error response:",y.substring(0,1e3)),d=y.trim().split(`
`)[0].substring(0,200))}catch(y){g.error("‚ùå Could not read error response at all:",y)}d===`Server returned ${r.status}`&&(r.status===401?d="Authentication required":r.status===500?d="Internal server error - check server logs for details":r.status===400&&(d="Bad request - check the backup file format"))}const v=new Error(d);throw p&&p!==d&&(v.fullDetails=p),n&&(v.rawErrorData=n),v}const l=await r.json();if(l.success)return console.log("‚úÖ Restore completed successfully:",l.data),{success:!0,message:l.message||"‚úÖ Restore completed successfully!",data:l.data};throw new Error(l.error||"Restore failed")}catch(r){if(r instanceof TypeError&&r.message.includes("fetch")||r instanceof TypeError&&r.message.includes("Failed to fetch")||((b=r.message)==null?void 0:b.includes("NetworkError"))||((h=r.message)==null?void 0:h.includes("network"))||((w=r.message)==null?void 0:w.includes("CORS")))return{success:!1,message:"‚ùå Backend server not available",error:`${o.toUpperCase()} file restore requires a backend server, but the server is not accessible.

Solutions:
1. **Deploy the backend server** and set VITE_API_URL environment variable:
   - Build: npm run backend:build
   - Start: npm run backend:start
   - Set VITE_API_URL=https://your-backend-url.com

2. **Use JSON backups instead** (works entirely client-side):
   - Create a new backup using "Create Backup" button
   - JSON backups can be restored without a backend server

Current API URL: ${e}
Error: ${r.message||"Connection failed"}`};throw r}}catch(a){if(a instanceof TypeError&&a.message.includes("fetch")||a instanceof DOMException&&a.name==="AbortError"||((S=a==null?void 0:a.message)==null?void 0:S.includes("Failed to fetch"))||((E=a==null?void 0:a.message)==null?void 0:E.includes("ERR_CONNECTION_REFUSED"))||((m=a==null?void 0:a.message)==null?void 0:m.includes("NetworkError"))){const c="http://localhost:8000";return{success:!1,message:"‚ùå Connection failed",error:u.name.endsWith(".json")?"Could not connect to restore server. JSON files can be restored client-side (automatically attempted). If this error persists, the backup file may be corrupted or the database connection failed.":`Could not connect to restore server at ${c}/api/backup/restore. SQL files require a backend server. Please ensure the backend server is running and accessible, or use JSON backups for client-side restore. Set VITE_API_URL environment variable to your backend server URL.`}}return console.error("Error restoring from backup:",a),{success:!1,message:"‚ùå Restore failed",error:a instanceof Error?a.message:"Unknown error"}}}const J=async()=>{try{const e="http://localhost:8000",u=await T(),k={};u&&(k.Authorization=`Bearer ${u}`);const i=await fetch(`${e}/api/backup/restore/formats`,{method:"GET",headers:k,signal:O(3e3)});if(i.ok)return await i.json()}catch{}return{formats:[{format:"SQL",extension:".sql",description:"PostgreSQL SQL dump format",advantages:["Standard PostgreSQL format","Contains both schema and data","Requires backend server for restore"]},{format:"JSON",extension:".json",description:"JSON backup format (RECOMMENDED for production)",advantages:["Works entirely client-side (no backend needed)","Human-readable","Easy to parse programmatically","Can be edited before restore","Good for selective restore"]}],recommended:"JSON",note:"JSON format works client-side without backend server. SQL format requires backend server for restore."}};export{B as c,J as g,F as p,I as r};
