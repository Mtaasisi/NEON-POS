import{_ as v}from"./supabase-cf010ec4.js";import{s as l}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";const C=async o=>{try{const{data:r,error:t}=await l.rpc("get_parent_variants",{product_id_param:o});if(t)throw t;return r||[]}catch(r){console.error("Error getting parent variants:",r);try{const{data:t,error:a}=await l.from("lats_product_variants").select("*").eq("product_id",o).eq("is_active",!0).in("variant_type",["parent","standard"]).order("created_at",{ascending:!0});if(a)throw a;return t||[]}catch(t){return console.error("Fallback query also failed:",t),[]}}},D=async o=>{try{const r=Date.now().toString(36),t=o.sku||`VAR-${r}`,{data:a,error:n}=await l.from("lats_product_variants").insert({product_id:o.product_id,variant_name:o.variant_name,sku:t,cost_price:o.cost_price||0,selling_price:o.selling_price||0,quantity:0,is_active:!0,is_parent:!0,variant_type:"parent",variant_attributes:o.attributes||{},branch_id:o.branch_id}).select().single();if(n)throw n;return{success:!0,data:a}}catch(r){return console.error("Error creating parent variant:",r),{success:!1,error:r instanceof Error?r.message:"Failed to create parent variant"}}},U=async o=>{try{const{error:r}=await l.from("lats_product_variants").update({is_parent:!0,variant_type:"parent",updated_at:new Date().toISOString()}).eq("id",o);if(r)throw r;return{success:!0}}catch(r){return console.error("Error converting to parent variant:",r),{success:!1,error:r instanceof Error?r.message:"Failed to convert variant"}}},k=async o=>{try{try{const{data:n,error:e}=await l.rpc("imei_exists",{check_imei:o});if(!e&&typeof n=="boolean")return n}catch{}const{data:r,error:t}=await l.from("lats_product_variants").select("id, variant_attributes").eq("variant_type","imei_child").eq("is_active",!0).limit(1e3);return t?(console.error("Error checking IMEI:",t),!1):!!(r||[]).find(n=>{var i,c,d;return(((i=n.variant_attributes)==null?void 0:i.imei)||((c=n.variant_attributes)==null?void 0:c.imei)||((d=n.attributes)==null?void 0:d.imei))===o})}catch(r){return console.error("Error checking IMEI:",r),!1}},y=async(o,r)=>{var t;console.log("ðŸ”§ [DEBUG] addIMEIToParentVariant called"),console.log("ðŸ“¥ [DEBUG] Input:",{parent_variant_id:o,imei:r.imei,serial_number:r.serial_number,cost_price:r.cost_price,selling_price:r.selling_price,condition:r.condition||"new"});try{if(r.imei&&r.imei.trim()){const{data:c,error:d}=await l.from("lats_product_variants").select("product_id").eq("id",o).single();if(d||!c)throw new Error("Parent variant not found");const _=r.imei.trim(),{data:u,error:s}=await l.from("lats_product_variants").select("id, name, variant_name, variant_attributes, attributes").eq("product_id",c.product_id).eq("variant_type","imei_child");if(s)console.warn("âš ï¸ Error checking for duplicate IMEI:",s);else if(u&&u.length>0&&u.find(p=>{var m,E;return(((m=p.variant_attributes)==null?void 0:m.imei)||((E=p.attributes)==null?void 0:E.imei)||p.name||p.variant_name||"").toString().trim().toLowerCase()===_.toLowerCase()})){const p=`IMEI/Serial number "${_}" already exists in this product. Each item must be unique.`;return console.error("âŒ Duplicate IMEI detected:",p),{success:!1,error:p}}}console.log("â³ [DEBUG] Step 1: Preparing Supabase RPC call...");const a={parent_variant_id_param:o,imei_param:r.imei||""};a.serial_number_param=String(r.imei||""),r.mac_address!=null&&r.mac_address!==""&&(a.mac_address_param=r.mac_address),a.cost_price_param=typeof r.cost_price=="number"&&!isNaN(r.cost_price)?r.cost_price:0,a.selling_price_param=typeof r.selling_price=="number"&&!isNaN(r.selling_price)?r.selling_price:0,a.condition_param=r.condition||"new",r.notes!=null&&r.notes!==""&&(a.notes_param=r.notes),typeof a.cost_price_param!="number"&&(a.cost_price_param=0),typeof a.selling_price_param!="number"&&(a.selling_price_param=0),console.log("ðŸ“¤ [DEBUG] RPC Parameters:",a),console.log("ðŸ“¤ [DEBUG] Parameter types:",{cost_price_type:typeof a.cost_price_param,selling_price_type:typeof a.selling_price_param,cost_price_value:a.cost_price_param,selling_price_value:a.selling_price_param}),console.log("â³ [DEBUG] Step 2: Calling supabase.rpc(add_imei_to_parent_variant)...");const{data:n,error:e}=await l.rpc("add_imei_to_parent_variant",a);if(console.log("ðŸ“¨ [DEBUG] Step 3: RPC Response received"),console.log("   - Data:",n),console.log("   - Error:",e),e)throw console.error("âŒ [DEBUG] RPC Error details:",{message:e.message,details:e.details,hint:e.hint,code:e.code}),e;const i=n==null?void 0:n[0];if(console.log("â³ [DEBUG] Step 4: Processing result:",i),!(i!=null&&i.success))throw console.error("âŒ [DEBUG] Function returned failure:",{success:i==null?void 0:i.success,error_message:i==null?void 0:i.error_message,child_variant_id:i==null?void 0:i.child_variant_id}),new Error((i==null?void 0:i.error_message)||"Failed to add IMEI");return console.log("âœ… [DEBUG] Success! Child variant created:",i.child_variant_id),console.log("âœ… [DEBUG] IMEI added successfully:",r.imei),{success:!0,child_variant_id:i.child_variant_id,imei:r.imei}}catch(a){return console.error("âŒ [DEBUG] Exception caught in addIMEIToParentVariant:"),console.error("   - Error type:",(t=a==null?void 0:a.constructor)==null?void 0:t.name),console.error("   - Error message:",a instanceof Error?a.message:String(a)),console.error("   - Error stack:",a instanceof Error?a.stack:"No stack trace"),console.error("   - Full error object:",a),{success:!1,error:a instanceof Error?a.message:"Failed to add IMEI"}}},I=async(o,r)=>{console.log("ðŸ”§ [DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ”§ [DEBUG] addIMEIsToParentVariant (BULK) started"),console.log("ðŸ”§ [DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ“¥ [DEBUG] Parent Variant ID:",o),console.log("ðŸ“¥ [DEBUG] Total IMEIs to process:",r.length),console.log("ðŸ“¥ [DEBUG] IMEI list:",r.map(c=>c.imei).join(", ")),console.log("");const t=new Set,a=[];for(const c of r)if(c.imei&&c.imei.trim()){const d=c.imei.trim().toLowerCase();t.has(d)?a.push(c.imei):t.add(d)}if(a.length>0){const c=`Duplicate IMEI/Serial numbers found in the batch: ${a.join(", ")}. Each item must be unique.`;return console.error("âŒ Duplicate IMEIs in batch:",c),{success:!1,created:0,failed:r.length,errors:[c]}}const n=[],e=[];let i=0;for(const c of r){i++,console.log(`â³ [DEBUG] Processing IMEI ${i}/${r.length}: ${c.imei}`),console.log("");const d=await y(o,c);d.success?(console.log(`âœ… [DEBUG] IMEI ${i} succeeded: ${c.imei}`),n.push(d)):(console.error(`âŒ [DEBUG] IMEI ${i} failed: ${c.imei}`),console.error(`   Error: ${d.error}`),e.push({imei:c.imei,error:d.error})),console.log("")}return console.log("ðŸ”§ [DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ”§ [DEBUG] BULK OPERATION COMPLETE"),console.log("ðŸ”§ [DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ“Š [DEBUG] Results Summary:"),console.log(`   âœ… Successful: ${n.length}`),console.log(`   âŒ Failed: ${e.length}`),console.log(`   ðŸ“ˆ Success Rate: ${(n.length/r.length*100).toFixed(1)}%`),e.length>0&&console.error("âŒ [DEBUG] Failed IMEIs:",e),console.log("ðŸ”§ [DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(""),{success:e.length===0,created:n.length,failed:e.length,data:n,errors:e}},B=async o=>{try{const{data:r}=await l.from("lats_product_variants").select("selling_price").eq("id",o).single(),t=(r==null?void 0:r.selling_price)||0,{loadChildIMEIs:a}=await v(()=>import("./variantHelpers-318d278a.js"),["assets/variantHelpers-318d278a.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);return(await a(o)).map(e=>{var d,_,u;const i=e.selling_price||e.sellingPrice||e.price,c=i&&i>0?i:t;return{id:e.id,parent_variant_id:o,product_id:e.product_id||"",imei:((d=e.variant_attributes)==null?void 0:d.imei)||"",serial_number:((_=e.variant_attributes)==null?void 0:_.serial_number)||"",condition:((u=e.variant_attributes)==null?void 0:u.condition)||"new",cost_price:e.cost_price||0,selling_price:c,quantity:e.quantity||0,is_active:e.is_active!==!1,created_at:e.created_at,variant_attributes:e.variant_attributes||{},is_legacy:e.is_legacy||!1}})}catch(r){return console.error("Error getting child IMEIs:",r),[]}},V=async o=>{try{const{data:r}=await l.from("lats_product_variants").select("selling_price").eq("id",o).single(),t=(r==null?void 0:r.selling_price)||0,{loadAvailableChildIMEIs:a}=await v(()=>import("./variantHelpers-318d278a.js"),["assets/variantHelpers-318d278a.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);return(await a(o)).map(e=>{var d,_,u;const i=e.selling_price||e.sellingPrice||e.price,c=i&&i>0?i:t;return{id:e.id,parent_variant_id:o,product_id:e.product_id||"",imei:((d=e.variant_attributes)==null?void 0:d.imei)||"",serial_number:((_=e.variant_attributes)==null?void 0:_.serial_number)||"",condition:((u=e.variant_attributes)==null?void 0:u.condition)||"new",cost_price:e.cost_price||0,selling_price:c,quantity:e.quantity||0,is_active:e.is_active!==!1,created_at:e.created_at,variant_attributes:e.variant_attributes||{},is_legacy:e.is_legacy||!1}})}catch(r){return console.error("Error getting available IMEIs for POS:",r),[]}},w=async(o,r)=>{try{const{data:t,error:a}=await l.from("lats_product_variants").select("id").eq("id",o).single();if(a||!t){const{data:i,error:c}=await l.from("inventory_items").select("id, status, product_id, variant_id, metadata").eq("id",o).single();if(i){const d={...i.metadata||{},sold_at:new Date().toISOString(),...r?{sale_id:r}:{}},{error:_}=await l.from("inventory_items").update({status:"sold",metadata:d,updated_at:new Date().toISOString()}).eq("id",o);if(_)throw _;if(i.id){let u=null;if(i.variant_id){const{data:g}=await l.from("lats_product_variants").select("id").eq("id",i.variant_id).maybeSingle();u=g?i.variant_id:null}const{error:s}=await l.from("lats_stock_movements").insert({product_id:i.product_id||null,variant_id:u,type:"sale",movement_type:"sale",quantity:-1,previous_quantity:1,new_quantity:0,reason:"Sale",reference_type:"pos_sale",reference_id:r||null,notes:`Sold legacy item ${o}`,created_at:new Date().toISOString()});s&&console.warn("Failed to create stock movement for legacy item:",s)}return{success:!0}}throw new Error("Item not found in variants or inventory_items")}const{data:n,error:e}=await l.rpc("mark_imei_as_sold",{child_variant_id_param:o,sale_id_param:r??null});if(e)throw e;return{success:!0,data:n}}catch(t){console.error("Error marking IMEI as sold:",t);try{const{data:a,error:n}=await l.from("lats_product_variants").select("variant_attributes").eq("id",o).single();if(n)throw n;const e={...(a==null?void 0:a.variant_attributes)||{},sold_at:new Date().toISOString(),...r?{sale_id:r}:{}},{error:i}=await l.from("lats_product_variants").update({quantity:0,is_active:!1,variant_attributes:e,updated_at:new Date().toISOString()}).eq("id",o);if(i)throw i;return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to mark as sold"}}}},G=async o=>{console.warn("âš ï¸ createIMEIVariants is deprecated. Use addIMEIsToParentVariant instead.");const{product_id:r,variants:t,branch_id:a}=o;return o.parent_variant_id?await I(o.parent_variant_id,t):{success:!1,error:"parent_variant_id is required. Create a parent variant first."}},F=async o=>{try{const{data:r,error:t}=await l.from("lats_product_variants").select(`
        *,
        parent:lats_product_variants!parent_variant_id(
          id,
          variant_name,
          name,
          sku
        ),
        product:lats_products(
          id,
          name,
          sku
        )
      `).filter("variant_attributes->>'imei'","eq",o).maybeSingle();return t&&t.code!=="PGRST116"?(console.error("Error getting variant by IMEI:",t),null):r}catch(r){return console.error("Error getting variant by IMEI:",r),null}},L=async(o,r)=>{console.warn(`ðŸ” [searchIMEIVariants] FUNCTION CALLED - searchTerm: "${o}", branch_id: ${r||"none"}`);try{const t=o.toLowerCase().trim(),a=[];let n=l.from("lats_product_variants").select(`
        *,
        product_id,
        parent:lats_product_variants!parent_variant_id(
          id,
          variant_name,
          name
        ),
        product:lats_products(
          id,
          name
        )
      `).eq("variant_type","imei_child").eq("is_active",!0);const{data:e,error:i}=await n.order("created_at",{ascending:!1}).limit(500);console.warn(`ðŸ” [searchIMEIVariants] Query result: variantData=${(e==null?void 0:e.length)||0} variants, error=${i?"yes":"no"}`),i?console.error("âŒ [searchIMEIVariants] Error fetching IMEI variants:",i):e&&(console.warn(`ðŸ” [searchIMEIVariants] Fetched ${e.length} IMEI child variants from database`),console.warn(`ðŸ” [searchIMEIVariants] Searching for: "${o}"`),e.length>0,e.forEach(u=>{let s=u.variant_attributes;if(typeof s=="string")try{s=JSON.parse(s)}catch{s={}}const g=(s==null?void 0:s.imei)||(s==null?void 0:s.IMEI)||"",p=(s==null?void 0:s.serial_number)||(s==null?void 0:s.serialNumber)||(s==null?void 0:s.serial)||"",f=u.sku||"";(String(g).toLowerCase().includes(t)||String(p).toLowerCase().includes(t)||String(f).toLowerCase().includes(t)||String(g).toLowerCase()===t||String(p).toLowerCase()===t)&&a.push(u)}));let c=l.from("inventory_items").select(`
        *,
        product:lats_products(
          id,
          name
        ),
        variant:lats_product_variants(
          id,
          product_id
        )
      `).eq("status","available").not("serial_number","is",null);const{data:d,error:_}=await c.limit(500);return _?console.error("Error fetching inventory items:",_):d&&d.forEach(u=>{var p,f;const s=u.serial_number||"",g=u.imei||"";if(String(s).toLowerCase().includes(t)||String(g).toLowerCase().includes(t)||String(s).toLowerCase()===t||String(g).toLowerCase()===t){const m=u.product_id||((p=u.variant)==null?void 0:p.product_id)||((f=u.product)==null?void 0:f.id);m&&a.push({id:u.id,product_id:m,variant_attributes:{imei:g||s,serial_number:s||g},product:u.product,variant_type:"imei_child",_from_inventory_items:!0})}}),a.slice(0,50)}catch(t){return console.error("Error searching IMEI variants:",t),[]}},h=async(o,r)=>{try{let t=l.from("lats_product_variants").select(`
        *,
        parent:lats_product_variants!parent_variant_id(
          id,
          variant_name,
          name
        )
      `).eq("product_id",o).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0);r&&(t=t.eq("branch_id",r));const{data:a,error:n}=await t.order("created_at",{ascending:!1});if(n)throw n;return a||[]}catch(t){return console.error("Error getting available IMEI variants:",t),[]}},$=async o=>{try{const{data:r,error:t}=await l.rpc("calculate_parent_variant_stock",{parent_variant_id_param:o});if(t)throw t;return r||0}catch(r){return console.error("Error calculating parent stock:",r),0}},O=async(o,r,t,a)=>{const n=r.map(e=>({imei:e.trim(),cost_price:t,selling_price:a,condition:"new",source:"purchase"}));return await I(o,n)},N=async o=>{try{const{data:r,error:t}=await l.from("lats_product_variants").select(`
        *,
        parent:lats_product_variants!parent_variant_id(
          id,
          variant_name,
          name,
          sku
        ),
        product:lats_products(
          id,
          name,
          description,
          sku,
          category:lats_categories(id, name)
        )
      `).eq("id",o).single();if(t)throw t;return{success:!0,data:r}}catch(r){return console.error("Error getting IMEI variant details:",r),{success:!1,error:r instanceof Error?r.message:"Failed to get variant details"}}},T=async(o,r)=>{try{const{data:t}=await l.from("lats_product_variants").select("variant_attributes").eq("id",o).single(),a={...(t==null?void 0:t.variant_attributes)||{},...r},{data:n,error:e}=await l.from("lats_product_variants").update({cost_price:r.cost_price,selling_price:r.selling_price,variant_attributes:a,updated_at:new Date().toISOString()}).eq("id",o).select().single();if(e)throw e;return{success:!0,data:n}}catch(t){return console.error("Error updating IMEI variant:",t),{success:!1,error:t instanceof Error?t.message:"Failed to update variant"}}},R=async o=>{try{const{error:r}=await l.from("lats_product_variants").update({is_active:!1,quantity:0,updated_at:new Date().toISOString()}).eq("id",o);if(r)throw r;return{success:!0}}catch(r){return console.error("Error deleting IMEI variant:",r),{success:!1,error:r instanceof Error?r.message:"Failed to delete variant"}}},x=w,A=h;export{y as addIMEIToParentVariant,I as addIMEIsToParentVariant,O as batchAddIMEIVariants,$ as calculateParentStock,k as checkIMEIExists,U as convertToParentVariant,G as createIMEIVariants,D as createParentVariant,R as deleteIMEIVariant,A as getAvailableIMEIVariants,h as getAvailableIMEIVariantsForProduct,V as getAvailableIMEIsForPOS,B as getChildIMEIs,N as getIMEIVariantDetails,C as getParentVariantsForProduct,F as getVariantByIMEI,w as markIMEIAsSold,L as searchIMEIVariants,x as selectIMEIVariantForSale,T as updateIMEIVariant};
