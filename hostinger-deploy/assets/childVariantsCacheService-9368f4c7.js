import{s as w}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";class N{constructor(){this.cache=new Map,this.isPreloading=!1,this.lastPreloadTime=0,this.CACHE_DURATION=5*60*1e3}async preloadAllChildVariants(i,t=!1){if(this.isPreloading&&!t){console.log("â³ [ChildVariantsCache] Already preloading, skipping...");return}const n=Date.now();if(!t&&this.cache.size>0&&n-this.lastPreloadTime<this.CACHE_DURATION){console.log("âš¡ [ChildVariantsCache] Using cached child variants (still fresh)");return}if(!i||i.length===0){console.log("â„¹ï¸ [ChildVariantsCache] No products provided, skipping preload");return}try{this.isPreloading=!0;const p=performance.now();console.log("ðŸš€ [ChildVariantsCache] Starting preload for all products...");const h=[];if(i.forEach(e=>{e.variants&&Array.isArray(e.variants)&&e.variants.forEach(a=>{a.id&&h.push(a.id)})}),h.length===0){console.log("â„¹ï¸ [ChildVariantsCache] No product variants found, skipping child preload"),this.lastPreloadTime=n,this.isPreloading=!1;return}const I=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,g=h.filter(e=>I.test(e)),C=h.filter(e=>!I.test(e));if(C.length>0&&console.warn(`âš ï¸ [ChildVariantsCache] Filtered out ${C.length} non-UUID variant IDs:`,C.slice(0,5)),g.length===0){console.log("â„¹ï¸ [ChildVariantsCache] No valid UUID variant IDs found, skipping child preload"),this.lastPreloadTime=n,this.isPreloading=!1;return}console.log(`ðŸ“Š [ChildVariantsCache] Found ${g.length} valid UUID variant IDs to check for children`);const{data:s,error:V}=await w.from("lats_product_variants").select("*").in("parent_variant_id",g).eq("variant_type","imei_child").eq("is_active",!0).gt("quantity",0).order("created_at",{ascending:!1});if(V){console.error("âŒ [ChildVariantsCache] Error preloading child variants:",V),this.lastPreloadTime=n;return}const{data:U}=await w.from("lats_product_variants").select("id, product_id").in("id",g),E=[...new Set((U||[]).map(e=>e.product_id).filter(Boolean))];let c=[];if(E.length>0){const{data:e,error:a}=await w.from("inventory_items").select("*").in("product_id",E).not("serial_number","is",null).eq("status","available").order("created_at",{ascending:!1}).limit(500);c=e||[],a&&console.warn("âš ï¸ Error loading legacy inventory items for cache:",a)}if((!s||s.length===0)&&c.length===0){console.log("â„¹ï¸ [ChildVariantsCache] No child variants or legacy items found in database"),this.cache=new Map,this.lastPreloadTime=n,this.isPreloading=!1;return}const _=new Map;i.forEach(e=>{e.variants&&Array.isArray(e.variants)&&e.variants.forEach(a=>{if(a.id){const r=a.sellingPrice??a.selling_price??a.price??0;_.set(a.id,r)}})});const o=new Map,u={};(s||[]).forEach(e=>{var T,A,D;const a=e.parent_variant_id;if(!a)return;const r=((T=e.variant_attributes)==null?void 0:T.imei)||((A=e.variant_attributes)==null?void 0:A.serial_number)||e.imei||e.serial_number||e.sku||"N/A",m=r,v=r,f=((D=e.variant_attributes)==null?void 0:D.condition)||e.condition||"New",l=e.selling_price||e.sellingPrice||e.price,P=_.get(a)||0,d=l&&l>0?l:P,y={id:e.id,name:e.variant_name||`IMEI: ${r}`,sku:e.sku||r,quantity:e.quantity||0,sellingPrice:d,price:d,imei:m,serialNumber:v,condition:f,variant_attributes:e.variant_attributes,is_imei_child:!0,is_legacy:!1,parent_variant_id:a,...e};o.has(a)||(o.set(a,[]),u[a]=0),o.get(a).push(y),u[a]++}),c.forEach(e=>{const a=e.variant_id;if(!a||!h.includes(a))return;const r=e.serial_number||e.imei||"Unknown",m=r,v=r,f=e.condition||"new",l=e.selling_price,P=_.get(a)||0,d=l&&l>0?l:P,y={id:e.id,name:r,sku:r,quantity:1,sellingPrice:d,price:d,imei:m,serialNumber:v,condition:f,variant_attributes:{serial_number:r,imei:r,mac_address:e.mac_address||"",condition:f,location:e.location||"",status:e.status||"available"},is_imei_child:!0,is_legacy:!0,variant_type:"imei_child",parent_variant_id:a,product_id:e.product_id,created_at:e.created_at};o.has(a)||(o.set(a,[]),u[a]=0),o.get(a).push(y),u[a]++}),this.cache=o,this.lastPreloadTime=n;const k=(performance.now()-p).toFixed(2),b=((s==null?void 0:s.length)||0)+c.length;console.log(`âœ… [ChildVariantsCache] Preloaded ${b} children (${(s==null?void 0:s.length)||0} IMEI + ${c.length} legacy) for ${o.size} parents in ${k}ms`,{totalChildren:b,imeiChildren:(s==null?void 0:s.length)||0,legacyItems:c.length,parentsWithChildren:o.size,cacheSize:this.cache.size})}catch(p){console.error("âŒ Error in preloadAllChildVariants:",p)}finally{this.isPreloading=!1}}getChildVariants(i){return this.cache.get(i)||null}hasChildren(i){var t;return this.cache.has(i)&&(((t=this.cache.get(i))==null?void 0:t.length)||0)>0}getChildCount(i){var t;return((t=this.cache.get(i))==null?void 0:t.length)||0}getChildCounts(i){const t={};return i.forEach(n=>{t[n]=this.getChildCount(n)}),t}clearCache(){typeof window<"u"&&"requestIdleCallback"in window?requestIdleCallback(()=>{try{this.cache.clear(),this.lastPreloadTime=0,this.isPreloading=!1}catch(i){console.warn("âš ï¸ [ChildVariantsCache] Error clearing cache:",i)}},{timeout:1e3}):setTimeout(()=>{try{this.cache.clear(),this.lastPreloadTime=0,this.isPreloading=!1}catch(i){console.warn("âš ï¸ [ChildVariantsCache] Error clearing cache:",i)}},0)}clearCacheSync(){this.cache.clear(),this.lastPreloadTime=0,this.isPreloading=!1,console.log("ðŸ—‘ï¸  Clearing child variants cache"),this.cache.clear(),this.lastPreloadTime=0}isCacheValid(){const i=Date.now();return this.cache.size>0&&i-this.lastPreloadTime<this.CACHE_DURATION}getCacheStats(){return{cachedParents:this.cache.size,totalChildren:Array.from(this.cache.values()).reduce((i,t)=>i+t.length,0),isValid:this.isCacheValid(),ageMinutes:((Date.now()-this.lastPreloadTime)/6e4).toFixed(1)}}}const x=new N;export{x as childVariantsCacheService};
