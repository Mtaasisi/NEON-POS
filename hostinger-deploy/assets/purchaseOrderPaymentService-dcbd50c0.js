import{s as u,M as b,$ as v}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";const A="00000000-0000-0000-0000-000000000001";class I{async processPayment(e){var r;try{const t=[];if(e.purchaseOrderId||t.push("Purchase Order ID"),e.paymentAccountId||t.push("Payment Account ID"),(!e.amount||e.amount<=0)&&t.push("Payment Amount"),e.paymentMethodId||t.push("Payment Method ID"),t.length>0)return{success:!1,message:`Missing required payment data: ${t.join(", ")}`};const{data:n,error:s}=await u.rpc("process_purchase_order_payment",{purchase_order_id_param:e.purchaseOrderId,payment_account_id_param:e.paymentAccountId,amount_param:e.amount,currency_param:e.currency||"TZS",payment_method_param:e.paymentMethod,payment_method_id_param:e.paymentMethodId,user_id_param:e.createdBy||"00000000-0000-0000-0000-000000000001",reference_param:e.reference||null,notes_param:e.notes||null});if(s)return console.error("‚ùå RPC function failed:",s),{success:!1,message:`Payment processing failed: ${s.message}`};let a=Array.isArray(n)?n[0]:n;if(a!=null&&a.process_purchase_order_payment&&(a=a.process_purchase_order_payment),!(a!=null&&a.success))return{success:!1,message:(a==null?void 0:a.message)||"Payment processing failed"};const o=(r=a.data)==null?void 0:r.payment_id;return o?{success:!0,message:"Payment processed successfully",payment:{id:o,purchaseOrderId:e.purchaseOrderId,paymentAccountId:e.paymentAccountId,amount:a.data.amount_paid,currency:e.currency||"TZS",paymentMethod:e.paymentMethod,paymentMethodId:e.paymentMethodId,reference:e.reference,notes:e.notes,status:"completed",paymentDate:new Date().toISOString(),createdBy:e.createdBy||"00000000-0000-0000-0000-000000000001",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}:{success:!1,message:"Payment processed but no payment ID returned"}}catch(t){return{success:!1,message:`Payment failed: ${t instanceof Error?t.message:"Unknown error"}`}}}async processBatchPayments(e){try{if(!e||e.length===0)return{success:!1,message:"No payments to process"};const r=e.map(a=>({purchase_order_id:a.purchaseOrderId,payment_account_id:a.paymentAccountId,amount:a.amount,currency:a.currency||"TZS",payment_method:a.paymentMethod,payment_method_id:a.paymentMethodId,user_id:a.createdBy||"00000000-0000-0000-0000-000000000001",reference:a.reference||null,notes:a.notes||null})),{data:t,error:n}=await u.rpc("process_purchase_order_payments_batch_simple",{payment_data_json:JSON.stringify(r)});if(n)return console.error("‚ùå Batch RPC function failed:",n),this.fallbackBatchProcessing(e);let s=Array.isArray(t)?t[0]:t;return s!=null&&s.process_purchase_order_payments_batch&&(s=s.process_purchase_order_payments_batch),s!=null&&s.success?{success:!0,message:"Batch payments processed successfully",results:s.results||[]}:{success:!1,message:(s==null?void 0:s.message)||"Batch payment processing failed"}}catch(r){return console.error("‚ùå Error in batch payment processing:",r),this.fallbackBatchProcessing(e)}}async fallbackBatchProcessing(e){try{const r=await Promise.all(e.map(async n=>{try{return{...await this.processPayment(n),payment:n}}catch(s){return{success:!1,message:`Failed to process payment: ${s instanceof Error?s.message:"Unknown error"}`,payment:n}}})),t=r.filter(n=>!n.success);return t.length>0?{success:!1,message:`Some payments failed: ${t.length} out of ${e.length}`,results:r}:{success:!0,message:"All payments processed successfully (fallback method)",results:r}}catch(r){return{success:!1,message:`Batch processing failed: ${r instanceof Error?r.message:"Unknown error"}`}}}async getPaymentSummary(e){try{const{data:r,error:t}=await u.rpc("get_purchase_order_payment_summary",{purchase_order_id_param:e});return t?(console.error("‚ùå Error getting payment summary:",t),{success:!1,message:"Failed to get payment summary"}):{success:!0,data:(r==null?void 0:r[0])||null}}catch(r){return console.error("‚ùå Error in getPaymentSummary:",r),{success:!1,message:`Unexpected error: ${r instanceof Error?r.message:"Unknown error"}`}}}async getPaymentHistory(e){try{const{data:r,error:t}=await u.rpc("get_purchase_order_payment_history",{purchase_order_id_param:e});return t?(console.error("‚ùå Error getting payment history:",t),{success:!1,message:"Failed to get payment history"}):{success:!0,data:r||[]}}catch(r){return console.error("‚ùå Error in getPaymentHistory:",r),{success:!1,message:`Unexpected error: ${r instanceof Error?r.message:"Unknown error"}`}}}async createPurchaseOrderPayment(e){try{console.log("üí∞ PurchaseOrderPaymentService: Creating purchase order payment...",e);const{data:r,error:t}=await u.from("finance_accounts").select("*").eq("id",e.paymentAccountId).single();if(t||!r)throw new Error("Payment account not found");let n=e.amount,s=r.balance||0;if((isNaN(s)||s===null||s===void 0)&&(console.warn("‚ö†Ô∏è Invalid account balance detected, defaulting to 0"),s=0),r.currency!==e.currency){console.log(`üîÑ Currency mismatch: Account is ${r.currency}, Payment is ${e.currency}`);const c=(d,y)=>{var h;try{if(typeof globalThis.import<"u"&&((h=globalThis.import.meta)!=null&&h.env))return globalThis.import.meta.env[d]||y;if(typeof process<"u"&&process.env)return process.env[d]||y;if(typeof window<"u"&&window.env)return window.env[d]||y}catch(p){console.warn("Environment variable access failed, using default:",p)}return y},P={USD_TZS:parseFloat(c("REACT_APP_USD_TZS_RATE","2500")),TZS_USD:parseFloat(c("REACT_APP_TZS_USD_RATE","0.0004")),EUR_TZS:parseFloat(c("REACT_APP_EUR_TZS_RATE","2700")),TZS_EUR:parseFloat(c("REACT_APP_TZS_EUR_RATE","0.00037")),GBP_TZS:parseFloat(c("REACT_APP_GBP_TZS_RATE","3200")),TZS_GBP:parseFloat(c("REACT_APP_TZS_GBP_RATE","0.00031"))},l=`${e.currency}_${r.currency}`,f=P[l];if(f)n=e.amount*f,console.log(`üí± Converting ${e.amount} ${e.currency} to ${n} ${r.currency} (rate: ${f})`);else throw new Error(`Currency conversion not supported: ${e.currency} to ${r.currency}. Please use matching currencies or contact support.`)}if(console.log(`üí∞ Balance check: Available=${s}, Required=${n}`),s<n){const c=n-s;throw new Error(`‚ùå Insufficient balance in ${r.name}!
Available: ${r.currency} ${s.toLocaleString()}
Required: ${r.currency} ${n.toLocaleString()}
Shortfall: ${r.currency} ${c.toLocaleString()}
Please add funds to the account or use a different payment method.`)}console.log(`‚úÖ Sufficient balance confirmed: ${s} >= ${n}`);const{data:a,error:o}=await u.from("users").select("id").limit(1).single();(o||!a)&&console.warn("‚ö†Ô∏è No valid user found, using fallback user ID:","00000000-0000-0000-0000-000000000001");let i=e.notes||"";if(r.currency!==e.currency){const c=`Original: ${e.amount} ${e.currency} (converted to ${n} ${r.currency})`;i=i?`${i}
${c}`:c}const{data:m,error:w}=await u.from("purchase_order_payments").insert({purchase_order_id:e.purchaseOrderId,payment_account_id:e.paymentAccountId,amount:n,currency:r.currency,payment_method:e.paymentMethod,payment_method_id:e.paymentMethodId,reference:e.reference,notes:i,status:"completed",payment_date:new Date().toISOString(),created_by:(a==null?void 0:a.id)||"00000000-0000-0000-0000-000000000001"}).select().single();if(w)throw console.error("‚ùå Error creating purchase order payment:",w),new Error("Failed to create purchase order payment record");const _=s-n;console.log(`üí≥ Deducting payment: ${s} - ${n} = ${_}`);const{error:E}=await u.from("finance_accounts").update({balance:_,updated_at:new Date().toISOString()}).eq("id",e.paymentAccountId);E?(console.error("‚ö†Ô∏è Error updating account balance:",E),console.warn("‚ö†Ô∏è Payment recorded but account balance not updated. Manual reconciliation may be required.")):console.log(`‚úÖ Account balance updated successfully: ${_}`);try{console.log("üìä Creating account transaction for PO payment...");const{data:c}=await u.from("lats_purchase_orders").select("po_number, supplier_id, currency, exchange_rate, base_currency, total_amount, total_amount_base_currency, branch_id").eq("id",e.purchaseOrderId).single();let P="Unknown Supplier";if(c!=null&&c.supplier_id){const{data:g}=await u.from("lats_suppliers").select("name").eq("id",c.supplier_id).single();g&&(P=g.name)}let l=(c==null?void 0:c.branch_id)||null;l||(l=r.branch_id||null),l||(l=b());const f=(c==null?void 0:c.po_number)||`PO-${e.purchaseOrderId.substring(0,8)}`,d=e.amount,y=(c==null?void 0:c.currency)||"TZS",h=(c==null?void 0:c.exchange_rate)||1,p=(c==null?void 0:c.base_currency)||"TZS";if(y!==p&&h!==1){const g=(c==null?void 0:c.total_amount_base_currency)||0,$=g>0?e.amount/g*100:0;console.log(`üí± Multi-currency PO payment:
            - PO Currency: ${y}
            - PO Total (Base): ${g} ${p}
            - Exchange Rate: ${h}
            - Payment Amount (TZS): ${e.amount}
            - Expense Tracked: ${d} ${p}
            - Payment Percentage: ${$.toFixed(2)}%`)}else console.log(`üí∞ Same currency transaction - Payment: ${d} ${p}`);const{error:S}=await u.from("account_transactions").insert({account_id:e.paymentAccountId,transaction_type:"expense",amount:n,balance_before:s,balance_after:_,description:`PO Payment: ${f} - ${P}`,reference_number:e.reference||`PO-PAY-${m.id.substring(0,8)}`,related_entity_type:"purchase_order_payment",related_entity_id:m.id,branch_id:l,metadata:{purchase_order_id:e.purchaseOrderId,po_reference:f,supplier:P,payment_method:e.paymentMethod,account_name:r.name,po_currency:y,po_total_amount:c==null?void 0:c.total_amount,po_total_amount_base_currency:c==null?void 0:c.total_amount_base_currency,po_exchange_rate:h,payment_amount_tzs:e.amount,base_currency:p,expense_amount_base_currency:d,account_currency:r.currency,account_amount:n},created_by:(a==null?void 0:a.id)||"00000000-0000-0000-0000-000000000001",created_at:new Date().toISOString()});S?console.warn("‚ö†Ô∏è Failed to create account transaction:",S):console.log(`‚úÖ Account transaction created with branch_id ${l} - Spending tracked in base currency: ${d} ${p}`)}catch(c){console.warn("‚ö†Ô∏è Error creating account transaction:",c)}return console.log("‚úÖ Purchase order payment created successfully:",m),m}catch(r){throw console.error("‚ùå PurchaseOrderPaymentService: Error creating payment:",r),r}}async createMultiplePurchaseOrderPayments(e){try{console.log("üí∞ PurchaseOrderPaymentService: Creating multiple purchase order payments...",e);const r=[];for(const t of e){const n=await this.createPurchaseOrderPayment(t);r.push(n)}return console.log("‚úÖ Multiple purchase order payments created successfully:",r),r}catch(r){throw console.error("‚ùå PurchaseOrderPaymentService: Error creating multiple payments:",r),r}}async getPurchaseOrderPayments(e){try{let r=u.from("purchase_order_payments").select("*").eq("purchase_order_id",e).order("created_at",{ascending:!1});const t=await v(r,"payments"),{data:n,error:s}=await t;if(s)throw console.error("‚ùå Error fetching purchase order payments:",s),new Error("Failed to fetch purchase order payments");return n||[]}catch(r){throw console.error("‚ùå PurchaseOrderPaymentService: Error fetching payments:",r),r}}async getPurchaseOrderPaymentSummary(e){var r;try{const{data:t,error:n}=await u.from("purchase_order_payments").select("amount, payment_date").eq("purchase_order_id",e).eq("status","completed");if(n)throw console.error("‚ùå Error fetching payment summary:",n),new Error("Failed to fetch payment summary");const s=(t==null?void 0:t.reduce((_,E)=>_+E.amount,0))||0,a=(t==null?void 0:t.length)||0,o=(r=t==null?void 0:t[0])==null?void 0:r.payment_date,{data:i,error:m}=await u.from("lats_purchase_orders").select("total_amount").eq("id",e).single();if(m)throw console.error("‚ùå Error fetching purchase order total:",m),new Error("Failed to fetch purchase order total");const w=((i==null?void 0:i.total_amount)||0)-s;return{totalPaid:s,remainingAmount:w,paymentCount:a,lastPaymentDate:o}}catch(t){throw console.error("‚ùå PurchaseOrderPaymentService: Error fetching payment summary:",t),t}}async updatePaymentStatus(e,r,t){try{const{error:n}=await u.from("purchase_order_payments").update({status:r,updated_at:new Date().toISOString()}).eq("id",e);if(n)throw console.error("‚ùå Error updating payment status:",n),new Error("Failed to update payment status");return!0}catch(n){throw console.error("‚ùå PurchaseOrderPaymentService: Error updating payment status:",n),n}}async reversePayment(e,r){try{const t=i=>i?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(i):!1;if(!t(e))throw new Error("Invalid payment ID provided");const n=r&&t(r)?r:A,{data:s,error:a}=await u.rpc("reverse_purchase_order_payment",{payment_id_param:e,user_id_param:n});if(a)return console.error("‚ùå Error reversing payment (RPC):",a),{success:!1,message:a.message||"Failed to reverse payment"};let o=Array.isArray(s)?s[0]:s;return o!=null&&o.reverse_purchase_order_payment&&(o=o.reverse_purchase_order_payment),o!=null&&o.success?{success:!0,message:o.message||"Payment reversed successfully",data:o.data}:{success:!1,message:(o==null?void 0:o.message)||"Failed to reverse payment"}}catch(t){return console.error("‚ùå PurchaseOrderPaymentService: Error reversing payment:",t),{success:!1,message:t instanceof Error?t.message:"Failed to reverse payment"}}}async reverseLatestPayment(e,r){try{if(!(o=>o?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o):!1)(e))throw new Error("Invalid purchase order ID provided");const{data:n,error:s}=await u.from("purchase_order_payments").select("id, amount, reference, payment_date").eq("purchase_order_id",e).order("payment_date",{ascending:!1}).limit(1).maybeSingle();if(s)return console.error("‚ùå Error fetching latest payment for reversal:",s),{success:!1,message:"Failed to fetch latest payment"};if(!n)return{success:!1,message:"No payments found to reverse for this purchase order"};const a=await this.reversePayment(n.id,r);return a.success&&(a.data={...a.data,reversed_payment_id:n.id,reversed_amount:n.amount,reversed_reference:n.reference,reversed_at:n.payment_date}),a}catch(t){return console.error("‚ùå PurchaseOrderPaymentService: Error reversing latest payment:",t),{success:!1,message:t instanceof Error?t.message:"Failed to reverse latest payment"}}}async deletePurchaseOrderPayment(e,r){try{const{data:t,error:n}=await u.from("purchase_order_payments").select("*").eq("id",e).single();if(n||!t)throw new Error("Payment not found");const{error:s}=await u.from("finance_accounts").update({balance:u.raw(`balance + ${t.amount}`),updated_at:new Date().toISOString()}).eq("id",t.payment_account_id);s&&console.error("‚ö†Ô∏è Error reversing account balance:",s);const{error:a}=await u.from("purchase_order_payments").delete().eq("id",e);if(a)throw console.error("‚ùå Error deleting payment:",a),new Error("Failed to delete payment");return!0}catch(t){throw console.error("‚ùå PurchaseOrderPaymentService: Error deleting payment:",t),t}}}const M=new I;export{M as purchaseOrderPaymentService};
