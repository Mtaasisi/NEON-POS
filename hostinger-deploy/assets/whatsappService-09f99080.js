var A=Object.defineProperty;var _=(f,s,e)=>s in f?A(f,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[s]=e;var m=(f,s,e)=>(_(f,typeof s!="symbol"?s+"":s,e),e);import{_ as I}from"./supabase-cf010ec4.js";import{ag as M,s as p}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";const w=class w{constructor(){m(this,"apiKey",null);m(this,"apiUrl","https://wasenderapi.com/api");m(this,"sessionId",null);m(this,"initialized",!1);m(this,"initializationPromise",null);this.initializationPromise=this.initializeService()}async initializeService(){var s,e,r,t,o;try{console.debug("üîß Initializing WhatsApp service from integrations...");const n=15e3,{getIntegration:a}=await I(()=>import("./index-61458a34.js").then(u=>u.b9),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),d=a("WHATSAPP_WASENDER"),c=new Promise((u,l)=>setTimeout(()=>l(new Error("WhatsApp initialization timeout")),n)),i=await Promise.race([d,c]);if(!i||!i.is_enabled){console.debug("‚ÑπÔ∏è WhatsApp integration not configured. WhatsApp features will be disabled until configured in Admin Settings ‚Üí Integrations"),this.initialized=!0;return}this.apiKey=((s=i.credentials)==null?void 0:s.api_key)||((e=i.credentials)==null?void 0:e.bearer_token)||null,this.sessionId=((r=i.credentials)==null?void 0:r.session_id)||((t=i.credentials)==null?void 0:t.whatsapp_session)||null,this.apiUrl=((o=i.config)==null?void 0:o.api_url)||"https://wasenderapi.com/api",console.debug("‚úÖ WhatsApp credentials loaded from integrations"),console.debug("üîë API Key:",this.apiKey?"‚úÖ Configured":"‚ùå Missing"),console.debug("üì± Session ID:",this.sessionId?"‚úÖ Configured":"‚ùå Missing"),console.debug("üåê API URL:",this.apiUrl?"‚úÖ Configured":"‚ùå Missing"),!this.apiKey||!this.sessionId?console.debug("‚ÑπÔ∏è WhatsApp service not fully configured. WhatsApp sending will fail until configured in Admin Settings ‚Üí Integrations"):console.debug("‚úÖ WhatsApp service initialized successfully"),this.initialized=!0}catch(n){const a=n instanceof Error?n.message:"Unknown error";a.includes("timeout")?console.debug("‚ÑπÔ∏è WhatsApp service initialization timed out (normal during cold starts) - will retry on first use"):console.warn("‚ùå WhatsApp service configuration error:",a),this.initialized=!0}}async ensureInitialized(){!this.initialized&&this.initializationPromise&&await this.initializationPromise}async sendMessage(s,e,r){try{if(await this.ensureInitialized(),!this.apiKey||!this.sessionId)return w.hasWarnedAboutConfig,{success:!1,error:"WhatsApp provider not configured. Configure WhatsApp WasenderAPI in Admin Settings ‚Üí Integrations."};const t=this.validatePhoneNumberSync(s);if(!t.valid)return console.error("‚ùå Phone validation failed:",t.error),{success:!1,error:`Invalid phone number: ${t.error}`};const o=t.formatted,n=(r==null?void 0:r.message_type)||"text";let a;switch(n){case"text":a=await this.sendTextMessage(o,e,r);break;case"image":a=await this.sendImageMessage(o,e,r);break;case"video":a=await this.sendVideoMessage(o,e,r);break;case"document":a=await this.sendDocumentMessage(o,e,r);break;case"audio":a=await this.sendAudioMessage(o,e,r);break;case"location":a=await this.sendLocationMessage(o,r);break;case"contact":a=await this.sendContactMessage(o,r);break;case"poll":a=await this.sendPollMessage(o,r);break;default:a=await this.sendTextMessage(o,e,r)}M("WHATSAPP_WASENDER",a.success).catch(u=>console.warn("Could not update integration usage:",u));const d={recipient_phone:o,message:e||(r==null?void 0:r.caption)||"",message_type:n,status:a.success?"sent":"failed",sent_at:new Date().toISOString(),created_at:new Date().toISOString(),message_id:a.message_id,media_url:r==null?void 0:r.media_url,session_id:(r==null?void 0:r.session_id)||null};a.error&&(d.error_message=a.error);const{data:c,error:i}=await p.from("whatsapp_logs").insert(d).select().single();return i&&console.error("Error logging WhatsApp message:",i),{success:a.success,error:a.error,log_id:c==null?void 0:c.id,message_id:a.message_id}}catch(t){return console.error("WhatsApp send error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async retryWithBackoff(s,e=3,r=5e3,t="API call"){let o;for(let n=0;n<=e;n++)try{return await s()}catch(a){if(o=a,!(a.status===429||a.statusCode===429||a.message&&(a.message.includes("429")||a.message.includes("rate limit")||a.message.includes("too many")||a.message.includes("account protection")))||n>=e)throw a;const c=r*Math.pow(2,n),i=Math.random()*1e3,u=c+i;console.warn(`‚ö†Ô∏è Rate limit hit for ${t}. Retry ${n+1}/${e} after ${(u/1e3).toFixed(1)}s...`),await new Promise(l=>setTimeout(l,u))}throw o}async sendTextMessage(s,e,r){const t=s.startsWith("+")?s.substring(1):s;try{return await this.retryWithBackoff(async()=>{const o=`${this.apiUrl}/send-message`,n={session:this.sessionId,to:t,text:e};r!=null&&r.quoted_message_id&&(n.quotedMessageId=r.quoted_message_id);const a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(n)});if(!a.ok){const c=await a.json().catch(()=>({}));let i=c.message||`HTTP ${a.status}: ${a.statusText}`,u="unknown";if(i.includes("JID does not exist")||i.includes("not_on_whatsapp")){u="not_on_whatsapp";const g=t,b=g.substring(0,3),P=g.length>=5?g.substring(3,5):"";let h=[];if(b==="255"){const $=["71","72","73","74","75","76","77","78","65","68","69","62","61"];$.includes(P)||h.push(`‚Ä¢ Invalid mobile prefix "${P}" - Tanzania uses: ${$.slice(0,5).join(", ")}, etc.`),h.push("‚Ä¢ Number not registered on WhatsApp"),h.push("‚Ä¢ Landline number (WhatsApp only works on mobile)"),h.push("‚Ä¢ Inactive or deactivated number")}else h.push("‚Ä¢ Number not registered on WhatsApp"),h.push(`‚Ä¢ Wrong country code (sent: ${b})`),h.push("‚Ä¢ Number format incorrect"),h.push("‚Ä¢ Inactive or deactivated number");i=`Phone: ${g}
Status: Not on WhatsApp ‚ùå

Possible reasons:
${h.join(`
`)}

üí° Tips:
‚Ä¢ Verify the number is correct
‚Ä¢ Check it's a mobile number (not landline)
‚Ä¢ Confirm WhatsApp is installed and active
‚Ä¢ For Tanzania: Use prefixes 71X-78X, 65X, 68X, 69X`}else i.includes("rate limit")||i.includes("too many")||i.includes("account protection")?(u="rate_limit",i=`‚ö†Ô∏è Rate limit exceeded. ${i}`):a.status===422?(u="invalid_format",i=`‚ùå Invalid request: ${i}.

Phone sent: ${t}
Check format: [CountryCode][Number] without +, spaces, or dashes`):(a.status===401||a.status===403)&&(u="authentication",i=`üîê Authentication error: ${i}.
Check your API key and session ID in Admin Settings ‚Üí Integrations`);console.error("‚ùå WhatsApp API error:",{errorType:u,originalPhone:s,formattedPhone:t,status:a.status,error:i,fullErrorData:c});const l=new Error(i);throw l.status=a.status,l.statusCode=a.status,l.errorType=u,l}const d=await a.json();return{success:!0,message_id:d.messageId||d.id}},3,5e3,`sendTextMessage(${t})`)}catch(o){const n=o instanceof Error?o.message:"Network error";return console.error("‚ùå WhatsApp send exception:",n),{success:!1,error:n}}}async sendMediaMessage(s,e,r,t){const o=s.startsWith("+")?s.substring(1):s;try{return t!=null&&t.media_url?await this.retryWithBackoff(async()=>{const n=`${this.apiUrl}/send-message`,a=r||t.caption||"",d={session:this.sessionId,to:o};switch(e){case"image":d.imageUrl=t.media_url;break;case"video":d.videoUrl=t.media_url;break;case"document":d.documentUrl=t.media_url;break;case"audio":d.audioUrl=t.media_url;break}a&&(d.text=a),t.viewOnce&&(e==="image"||e==="video")&&(d.viewOnce=!0);const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(d)});if(!c.ok){const l=(await c.json().catch(()=>({}))).message||`HTTP ${c.status}: ${c.statusText}`,g=new Error(l);throw g.status=c.status,g.statusCode=c.status,g}const i=await c.json();return{success:!0,message_id:i.messageId||i.id}},3,5e3,`send${e.charAt(0).toUpperCase()+e.slice(1)}(${o})`):{success:!1,error:`Media URL is required for ${e} messages`}}catch(n){const a=n instanceof Error?n.message:"Network error";return console.error(`‚ùå WhatsApp ${e} send exception:`,a),{success:!1,error:a}}}async sendImageMessage(s,e,r){return this.sendMediaMessage(s,"image",e,r)}async sendVideoMessage(s,e,r){return this.sendMediaMessage(s,"video",e,r)}async sendDocumentMessage(s,e,r){return this.sendMediaMessage(s,"document",e,r)}async sendAudioMessage(s,e,r){return this.sendMediaMessage(s,"audio",e,r)}async sendLocationMessage(s,e){const r=s.startsWith("+")?s.substring(1):s;try{return e!=null&&e.location?await this.retryWithBackoff(async()=>{const t=`${this.apiUrl}/send-message`,o={session:this.sessionId,to:r,location:{latitude:e.location.latitude,longitude:e.location.longitude,name:e.location.name||"",address:e.location.address||""}},n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(o)});if(!n.ok){const c=(await n.json().catch(()=>({}))).message||`HTTP ${n.status}: ${n.statusText}`,i=new Error(c);throw i.status=n.status,i.statusCode=n.status,i}const a=await n.json();return{success:!0,message_id:a.messageId||a.id}},3,5e3,`sendLocation(${r})`):{success:!1,error:"Location data is required for location messages"}}catch(t){const o=t instanceof Error?t.message:"Network error";return console.error("‚ùå WhatsApp location send exception:",o),{success:!1,error:o}}}async sendContactMessage(s,e){const r=s.startsWith("+")?s.substring(1):s;try{return e!=null&&e.contact?await this.retryWithBackoff(async()=>{const t=`${this.apiUrl}/send-message`,o={session:this.sessionId,to:r,contact:{name:e.contact.name,phone:e.contact.phone}},n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(o)});if(!n.ok){const c=(await n.json().catch(()=>({}))).message||`HTTP ${n.status}: ${n.statusText}`,i=new Error(c);throw i.status=n.status,i.statusCode=n.status,i}const a=await n.json();return{success:!0,message_id:a.messageId||a.id}},3,5e3,`sendContact(${r})`):{success:!1,error:"Contact data is required for contact messages"}}catch(t){const o=t instanceof Error?t.message:"Network error";return console.error("‚ùå WhatsApp contact send exception:",o),{success:!1,error:o}}}async sendPollMessage(s,e){const r=s.startsWith("+")?s.substring(1):s;try{return!(e!=null&&e.pollName)||!(e!=null&&e.pollOptions)||e.pollOptions.length<2?{success:!1,error:"Poll name and at least 2 options are required for poll messages"}:await this.retryWithBackoff(async()=>{const t=`${this.apiUrl}/send-message`,o={session:this.sessionId,to:r,poll:{question:e.pollName,options:e.pollOptions,multiSelect:e.allowMultipleAnswers||!1}};console.log("üì§ Sending poll message with payload:",JSON.stringify(o,null,2));const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(o)});if(!n.ok){const d=await n.json().catch(()=>({}));console.error("‚ùå Poll message failed:",{status:n.status,statusText:n.statusText,errorData:d,sentPayload:o});let c=`HTTP ${n.status}: ${n.statusText}`;if(d.message&&(c=d.message),d.errors){const u=JSON.stringify(d.errors);c+=` - ${u}`}const i=new Error(c);throw i.status=n.status,i.statusCode=n.status,i}const a=await n.json();return console.log("‚úÖ Poll message sent successfully:",a),{success:!0,message_id:a.messageId||a.id}},3,5e3,`sendPoll(${r})`)}catch(t){return console.error("‚ùå Poll message exception:",t),{success:!1,error:t instanceof Error?t.message:"Network error"}}}formatPhoneNumber(s){if(!s||typeof s!="string")throw new Error("Invalid phone number: Phone number is required");let e=s.replace(/[^\d+]/g,"");if(e=e.replace(/^\+/,""),!e||e.length<9)throw new Error(`Invalid phone number: Too short (${e.length} digits)`);if(e.startsWith("0")&&(e="255"+e.substring(1)),!e.match(/^[1-9]\d{10,14}$/)&&e.length>=9&&e.length<=10&&(e="255"+e),e.length<10||e.length>15)throw new Error(`Invalid phone number format: ${s} (cleaned: ${e}, ${e.length} digits)`);if(e.startsWith("255")){if(e.length!==12)throw new Error(`Invalid Tanzania number length: ${e} (expected 12 digits, got ${e.length})`);const r=e.substring(3,5),t=["71","72","73","74","75","76","77","78","65","68","69","62","61"];t.includes(r)||(console.warn(`‚ö†Ô∏è Unusual Tanzania mobile prefix: ${r} (number: ${e}). Valid prefixes: ${t.join(", ")}`),console.warn("   This number may not be registered on WhatsApp or may be a landline."))}return e}async validatePhoneNumber(s){try{const e=this.formatPhoneNumber(s);return e.match(/^[1-9]\d{9,14}$/)?{valid:!0,formatted:e}:{valid:!1,error:`Phone number doesn't match international format: ${e}`}}catch(e){return{valid:!1,error:e instanceof Error?e.message:"Invalid phone number format"}}}validatePhoneNumberSync(s){try{const e=this.formatPhoneNumber(s);return e.match(/^[1-9]\d{9,14}$/)?{valid:!0,formatted:e}:{valid:!1,error:`Phone number doesn't match international format: ${e}`}}catch(e){return{valid:!1,error:e instanceof Error?e.message:"Invalid phone number format"}}}async getWhatsAppLogs(s){try{let e=p.from("whatsapp_logs").select("*").order("created_at",{ascending:!1});s!=null&&s.search&&(e=e.or(`recipient_phone.ilike.%${s.search}%,message.ilike.%${s.search}%`)),s!=null&&s.status&&(e=e.eq("status",s.status));const{data:r,error:t}=await e;return t?(console.error("Error fetching WhatsApp logs:",t),[]):r||[]}catch(e){return console.error("Error fetching WhatsApp logs:",e),[]}}async getWhatsAppStats(){try{const{data:s}=await p.from("whatsapp_logs").select("status");return s?{total:s.length,sent:s.filter(e=>e.status==="sent").length,failed:s.filter(e=>e.status==="failed").length,pending:s.filter(e=>e.status==="pending").length,delivered:s.filter(e=>e.status==="delivered").length,read:s.filter(e=>e.status==="read").length}:{total:0,sent:0,failed:0,pending:0,delivered:0,read:0}}catch(s){return console.error("Error fetching WhatsApp stats:",s),{total:0,sent:0,failed:0,pending:0,delivered:0,read:0}}}async configureWebhook(s,e=["messages.received","messages.upsert","messages.update","messages.reaction","session.status","call.received","poll.results"]){try{if(await this.ensureInitialized(),!this.sessionId)return{success:!1,error:"Session ID not configured"};const r=`${this.apiUrl}/whatsapp-sessions/${this.sessionId}`,t=await fetch(r,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({webhook_url:s,webhook_events:e,webhook_enabled:!0})});if(!t.ok)return{success:!1,error:(await t.json().catch(()=>({}))).message||`HTTP ${t.status}: ${t.statusText}`};const o=await t.json();return console.log("‚úÖ Webhook configured successfully:",s),{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Failed to configure webhook"}}}async getIncomingMessages(s){try{let e=p.from("whatsapp_incoming_messages").select("*, customers(name, phone, whatsapp)").order("created_at",{ascending:!1});s!=null&&s.customer_id&&(e=e.eq("customer_id",s.customer_id)),s!=null&&s.unread_only&&(e=e.eq("is_read",!1)),s!=null&&s.limit&&(e=e.limit(s.limit));const{data:r,error:t}=await e;return t?(console.error("Error fetching incoming messages:",t),[]):r||[]}catch(e){return console.error("Error fetching incoming messages:",e),[]}}async markMessageAsRead(s){try{const{error:e}=await p.from("whatsapp_incoming_messages").update({is_read:!0}).eq("id",s);return!e}catch(e){return console.error("Error marking message as read:",e),!1}}async sendPresenceUpdate(s,e="composing"){try{if(await this.ensureInitialized(),!this.apiKey||!this.sessionId)return{success:!1,error:"WhatsApp not configured"};const r=s.startsWith("+")?s.substring(1):s,t=await fetch(`${this.apiUrl}/send-presence-update`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({session:this.sessionId,to:r,state:e})});return t.ok?{success:!0}:{success:!1,error:(await t.json().catch(()=>({}))).message||`HTTP ${t.status}: ${t.statusText}`}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Network error"}}}async isOnWhatsApp(s){try{if(await this.ensureInitialized(),!this.apiKey)return{exists:!1,error:"API key not configured"};const e=this.formatPhoneNumber(s),r=`${this.apiUrl}/on-whatsapp/${e}`,t=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}});return t.ok?{exists:(await t.json()).exists||!1}:{exists:!1,error:`HTTP ${t.status}`}}catch(e){return{exists:!1,error:e instanceof Error?e.message:"Network error"}}}async getMessageStatus(s){try{if(await this.ensureInitialized(),!this.apiKey)return{error:"API key not configured"};const e=`${this.apiUrl}/messages/${s}/info`,r=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}});return r.ok?await r.json():{error:`HTTP ${r.status}`}}catch(e){return{error:e instanceof Error?e.message:"Network error"}}}};m(w,"hasWarnedAboutConfig",!1);let y=w;const W=new y,C=W;export{C as default};
