import{_ as h}from"./supabase-cf010ec4.js";import u from"./whatsappService-09f99080.js";import{q as m}from"./index-61458a34.js";import{notificationSettingsService as i}from"./notificationSettingsService-1df2b297.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";import"./format-aff4c6a2.js";import"./formatPhoneForInvoice-e7084c6d.js";class d{async sendNotification(s,t,o={}){try{if(!s||!s.trim())return{success:!1,method:"none",error:"Phone number is required"};if(o.forceSMS)return await this.sendSMSOnly(s,t);const{notificationSettingsService:c}=await h(()=>import("./notificationSettingsService-1df2b297.js"),["assets/notificationSettingsService-1df2b297.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]);if(!c.getSettings().whatsappEnabled&&!o.forceWhatsApp)return console.log("ğŸ“± WhatsApp not enabled, sending SMS directly"),await this.sendSMSOnly(s,t);let r=!1;if(!o.skipWhatsAppCheck&&!o.forceWhatsApp){const p=await u.isOnWhatsApp(s);p.error&&!p.error.includes("not configured")&&console.log("âš ï¸ WhatsApp check failed, will try WhatsApp anyway:",p.error),r=p.exists,r?console.log(`âœ… WhatsApp check confirms ${s} IS on WhatsApp`):(console.log(`ğŸ“± WhatsApp check says ${s} is NOT on WhatsApp`),console.log("ğŸ’¡ Will try WhatsApp anyway - the actual send attempt is more reliable than the check"))}const n=await u.sendMessage(s,t);if(n.success)return console.log("âœ… WhatsApp sent successfully"),{success:!0,method:"whatsapp",whatsappResult:n};if(n.error&&(n.error.includes("not_on_whatsapp")||n.error.includes("JID does not exist")||n.error.includes("Not on WhatsApp")))return console.log("ğŸ“± Number not on WhatsApp (send failed), falling back to SMS"),await this.sendSMSOnly(s,t);console.log("âš ï¸ WhatsApp failed, falling back to SMS:",n.error);const l=await this.sendSMSOnly(s,t);return{success:l.success,method:l.success?"sms":"none",whatsappResult:n,smsResult:l,error:l.success?void 0:`WhatsApp failed: ${n.error}; SMS also failed: ${l.error}`}}catch(c){const e=c instanceof Error?c.message:"Unknown error";console.error("âŒ Smart notification error:",e);try{const r=await this.sendSMSOnly(s,t);return{success:r.success,method:r.success?"sms":"none",smsResult:r,error:r.success?void 0:e}}catch{return{success:!1,method:"none",error:e}}}}async sendInvoice(s,t={}){console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ğŸ” [DEBUG] SMART NOTIFICATION - INVOICE SENDING"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ğŸ“‹ [DEBUG] Invoice Details:",{invoice_no:s.invoice_no,customer_name:s.customer_name,customer_phone:s.customer_phone,total:s.total,items_count:s.items.length,business_name:s.business_name}),console.log("âš™ï¸ [DEBUG] Options:",t);try{if(!s.customer_phone)return console.error("âŒ [DEBUG] Error: Customer phone number is required"),{success:!1,method:"none",error:"Customer phone number is required"};if(console.log(`âœ… [DEBUG] Customer phone number provided: ${s.customer_phone}`),t.forceSMS){const e=await i.sendSMSInvoice(s);return{success:e.success,method:e.success?"sms":"none",smsResult:e,error:e.error}}const o=i.getSettings();let c=!1;if(!t.skipWhatsAppCheck&&!t.forceWhatsApp&&o.whatsappEnabled){const e=await u.isOnWhatsApp(s.customer_phone);e.error&&!e.error.includes("not configured")&&console.log("âš ï¸ WhatsApp check failed, will try anyway:",e.error),c=e.exists,c?console.log(`âœ… WhatsApp check confirms ${s.customer_phone} IS on WhatsApp`):(console.log(`ğŸ“± WhatsApp check says ${s.customer_phone} is NOT on WhatsApp`),console.log("ğŸ’¡ Will try WhatsApp anyway - the actual send attempt is more reliable than the check"))}if(o.whatsappEnabled||t.forceWhatsApp){console.log(`ğŸ“± Attempting to send WhatsApp invoice to ${s.customer_phone}...`);const e=await i.sendWhatsAppInvoice(s);if(e.success)return console.log("âœ… WhatsApp invoice sent successfully"),{success:!0,method:"whatsapp",whatsappResult:e};if(e.error&&(e.error.includes("not_on_whatsapp")||e.error.includes("JID does not exist")||e.error.includes("Not on WhatsApp"))){console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"),console.log("ğŸ“± [DEBUG] WHATSAPP SEND FAILED - Number not on WhatsApp"),console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"),console.log(`âŒ [DEBUG] Error: ${e.error}`),console.log(`ğŸ“ [DEBUG] Phone: ${s.customer_phone}`),console.log("ğŸ“± [DEBUG] Falling back to SMS invoice...");const n=Date.now(),a=await i.sendSMSInvoice(s),l=Date.now()-n;return console.log(`â±ï¸ [DEBUG] SMS send completed in ${l}ms`),console.log("ğŸ” [DEBUG] SMS result:",{success:a.success,error:a.error,duration_ms:l}),a.success&&(console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("âœ… [SUCCESS] Customer will receive SMS receipt (WhatsApp not available)"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")),{success:a.success,method:a.success?"sms":"none",whatsappResult:e,smsResult:a,error:a.error}}else console.warn(`âš ï¸ [DEBUG] WhatsApp failed for other reason: ${e.error}`)}if(o.smsEnabled){console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"),console.log("ğŸ“± [DEBUG] FALLING BACK TO SMS"),console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"),console.log(`ğŸ“ [DEBUG] Phone: ${s.customer_phone}`),console.log(`ğŸ“„ [DEBUG] Invoice: ${s.invoice_no}`),console.log("âš ï¸ [DEBUG] Reason: WhatsApp unavailable or failed");const e=Date.now();console.log("ğŸ“± [DEBUG] Starting SMS send...");const r=await i.sendSMSInvoice(s),n=Date.now()-e;return console.log(`â±ï¸ [DEBUG] SMS send completed in ${n}ms`),console.log("ğŸ” [DEBUG] SMS result:",{success:r.success,error:r.error,duration_ms:n}),{success:r.success,method:r.success?"sms":"none",whatsappResult:o.whatsappEnabled?{success:!1,error:"WhatsApp not enabled or failed"}:void 0,smsResult:r,error:r.error}}return{success:!1,method:"none",error:"Both WhatsApp and SMS are disabled or unavailable"}}catch(o){const c=o instanceof Error?o.message:"Unknown error";return console.error("âŒ Smart invoice sending error:",c),{success:!1,method:"none",error:c}}}async sendSMSOnly(s,t){try{const o=await m.sendSMS(s,t);return o.success&&console.log("âœ… SMS sent successfully"),o}catch(o){const c=o instanceof Error?o.message:"SMS sending failed";return console.error("âŒ SMS send error:",c),{success:!1,error:c}}}async checkWhatsAppStatus(s){return await u.isOnWhatsApp(s)}}const _=new d;export{_ as default,_ as smartNotificationService};
