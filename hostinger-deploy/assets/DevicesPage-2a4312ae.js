import{j as e,s as J,G as F,d as xs,u as Je,e as Le,i as is,k as ie,l as ns,c as os,b as us,r as gs,a as hs,m as ps}from"./index-61458a34.js";import{r as x,b as Ie}from"./vendor-36d2c7c1.js";import{S as bs}from"./SearchBar-c613e419.js";import{G as qe}from"./GlassSelect-e243562f.js";import{B as fs}from"./BackButton-02a80e74.js";import{t as L}from"./toastUtils-7054c9ca.js";import{_ as De}from"./supabase-cf010ec4.js";import{u as q,X as ne,G as js,n as h,v as Qe,J as ys,N as ve,d as se,O as Ns,U as ds,y as Xe,Q as Ge,V as K,m as Oe,Y as Ue,A as Pe,_ as vs,f as Ye,$ as We,a0 as es,S as Ae,I as ws,a1 as ss,e as Ss,r as Ze,a2 as ts,a3 as ks,a4 as Cs,a5 as as,a6 as _s,a7 as Ds,a8 as As,a9 as Ps,a as Rs,b as $s,aa as Ts,ab as Ms,ac as Es,ad as qs,l as rs}from"./ui-28e30067.js";import{u as Ls,S as Fs}from"./useSuccessModal-081786c4.js";import{S as Is}from"./SuccessModalIcons-fe811e4d.js";import{G as zs}from"./GlassInput-0475021a.js";import{P as Os}from"./PaymentsPopupModal-6fe61f19.js";import{C as Hs}from"./CustomerDetailModal-ad4a2166.js";import{a as cs}from"./routing-eb8c310c.js";import{C as Bs}from"./CBMCalculatorModal-27ed156d.js";import"./utils-95f4031a.js";import"./charts-d592fbd1.js";import"./useBodyScrollLock-341c8b9f.js";import"./currencyUtils-59109a41.js";import"./GlassTabs-05c8a392.js";import"./appointments-0b344a33.js";import"./whatsappService-09f99080.js";import"./Modal-a5e4c1ba.js";import"./CustomerForm-3440546b.js";import"./returns-8e3dd741.js";import"./AppointmentModal-91a07df7.js";import"./format-aff4c6a2.js";import"./index-5a6a7dda.js";import"./pdf-e6e38bab.js";const He=({status:a,className:o="",isUpdating:p=!1})=>{const l=v=>{switch(v){case"assigned":return{bg:"bg-gradient-to-r from-amber-500/80 to-orange-500/80",text:"text-white",label:"Assigned"};case"diagnosis-started":return{bg:"bg-gradient-to-r from-blue-500/80 to-blue-600/80",text:"text-white",label:"Diagnosis"};case"awaiting-parts":return{bg:"bg-gradient-to-r from-amber-600/80 to-orange-700/80",text:"text-white",label:"Awaiting Parts"};case"parts-arrived":return{bg:"bg-gradient-to-r from-green-500/80 to-emerald-500/80",text:"text-white",label:"Parts Arrived"};case"in-repair":return{bg:"bg-gradient-to-r from-purple-500/80 to-indigo-500/80",text:"text-white",label:"Repairing"};case"reassembled-testing":return{bg:"bg-gradient-to-r from-cyan-500/80 to-blue-400/80",text:"text-white",label:"Testing"};case"repair-complete":return{bg:"bg-gradient-to-r from-emerald-500/80 to-green-500/80",text:"text-white",label:"Complete"};case"returned-to-customer-care":return{bg:"bg-gradient-to-r from-teal-500/80 to-cyan-500/80",text:"text-white",label:"Back to CC"};case"done":return{bg:"bg-gradient-to-r from-gray-500/80 to-gray-700/80",text:"text-white",label:"Done"};case"failed":return{bg:"bg-gradient-to-r from-red-500/80 to-pink-500/80",text:"text-white",label:"Failed"};default:return{bg:"bg-gradient-to-r from-gray-200/80 to-gray-300/80",text:"text-gray-800",label:v}}},{bg:j,text:g,label:f}=l(a);return e.jsxs("span",{className:`
      ${j} ${g} px-3 py-1 rounded-full text-sm font-medium
      backdrop-blur-xl inline-flex items-center gap-1
      border border-white/20 shadow-sm
      transform transition-all duration-300
      hover:border-white/40 hover:shadow-lg
      whitespace-nowrap
      max-w-[120px] overflow-hidden text-ellipsis
      flex-shrink-0
      ${p?"animate-pulse":""}
      ${o}
    `,children:[f,p&&e.jsx("span",{className:"ml-1",children:"â³"})]})},Gs=async a=>{try{const{data:o,error:p}=await J.from("devices").select("repair_cost").eq("id",a).single();p&&console.error("Error fetching device repair cost:",p);const{data:l,error:j}=await J.from("repair_parts").select("total_cost, status").eq("device_id",a);j&&console.error("Error fetching repair parts:",j);const g=(l==null?void 0:l.filter(b=>["needed","received","used"].includes(b.status)).reduce((b,w)=>b+(w.total_cost||0),0))||0,{data:f,error:v}=await J.from("customer_payments").select("id, amount, status, payment_type, method, payment_date").eq("device_id",a).order("payment_date",{ascending:!1});v&&console.error("Error fetching payments:",v);const r=(f==null?void 0:f.filter(b=>b.status==="completed").reduce((b,w)=>b+w.amount,0))||0,I=(f==null?void 0:f.filter(b=>b.status==="pending").reduce((b,w)=>b+w.amount,0))||0,u=(o==null?void 0:o.repair_cost)||0,k=u+g;return{repairCost:u,sparePartsCost:g,totalPaid:r,totalPending:I,payments:f||[]}}catch(o){return console.error("Error getting device payment info:",o),{repairCost:0,sparePartsCost:0,totalPaid:0,totalPending:0,payments:[]}}},Ws=async(a,o)=>{try{const p=await Gs(a),l=[];if(p.repairCost>0&&(p.payments.some(g=>g.payment_type==="payment"&&g.status==="pending")||l.push({customer_id:o,device_id:a,amount:p.repairCost,method:"cash",payment_type:"payment",status:"pending",payment_date:new Date().toISOString(),notes:"Repair cost payment"})),p.sparePartsCost>0&&(p.payments.some(g=>{var f;return g.payment_type==="payment"&&((f=g.notes)==null?void 0:f.includes("spare parts"))})||l.push({customer_id:o,device_id:a,amount:p.sparePartsCost,method:"cash",payment_type:"payment",status:"pending",payment_date:new Date().toISOString(),notes:"Spare parts cost payment"})),l.length>0){const{error:j}=await J.from("customer_payments").insert(l);if(j)return console.error("Error creating pending payments:",j),!1}return!0}catch(p){return console.error("Error creating pending payments:",p),!1}},ls=({isOpen:a,onClose:o,onSave:p,editingPart:l})=>{const j=Ls(),[g,f]=x.useState({name:(l==null?void 0:l.name)||"",description:(l==null?void 0:l.description)||"",quantity:(l==null?void 0:l.quantity)||1,cost:(l==null?void 0:l.cost)||0,status:(l==null?void 0:l.status)||"ordered",supplier:(l==null?void 0:l.supplier)||"",estimatedArrival:(l==null?void 0:l.estimatedArrival)||"",notes:(l==null?void 0:l.notes)||""}),[v,r]=x.useState({}),I=()=>{const b={};return g.name.trim()||(b.name="Part name is required"),g.description.trim()||(b.description="Description is required"),g.quantity<=0&&(b.quantity="Quantity must be greater than 0"),g.cost<=0&&(b.cost="Cost must be greater than 0"),g.supplier.trim()||(b.supplier="Supplier is required"),r(b),Object.keys(b).length===0},u=b=>{if(b.preventDefault(),!I()){h.error("Please fix the errors before saving");return}const w={id:(l==null?void 0:l.id)||`part_${Date.now()}`,...g};p(w),j.show(l?`${g.name} has been updated successfully!`:`${g.name} has been added to repair parts!`,{title:l?"Part Updated! âœ…":"Part Added! âœ…",icon:Is.repairCompleted,autoCloseDelay:3e3}),o()},k=(b,w)=>{f(T=>({...T,[b]:w})),v[b]&&r(T=>({...T,[b]:""}))};return a?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30 backdrop-blur-sm",onClick:o}),e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center",children:e.jsx(q,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:l?"Edit Part":"Add New Part"}),e.jsx("p",{className:"text-sm text-gray-600",children:l?"Update part information":"Add a new part to the repair order"})]})]}),e.jsx("button",{onClick:o,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-5 h-5 text-gray-500"})})]}),e.jsxs("form",{onSubmit:u,className:"p-6 space-y-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Part Name *"}),e.jsx("input",{type:"text",value:g.name,onChange:b=>k("name",b.target.value),className:`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${v.name?"border-red-300":"border-gray-300"}`,placeholder:"e.g., Screen Assembly"}),v.name&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Supplier *"}),e.jsx("input",{type:"text",value:g.supplier,onChange:b=>k("supplier",b.target.value),className:`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${v.supplier?"border-red-300":"border-gray-300"}`,placeholder:"e.g., TechParts Ltd"}),v.supplier&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.supplier})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description *"}),e.jsx("textarea",{value:g.description,onChange:b=>k("description",b.target.value),className:`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none ${v.description?"border-red-300":"border-gray-300"}`,rows:3,placeholder:"Detailed description of the part..."}),v.description&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.description})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Quantity *"}),e.jsx("input",{type:"number",min:"1",value:g.quantity,onChange:b=>k("quantity",parseInt(b.target.value)||1),className:`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${v.quantity?"border-red-300":"border-gray-300"}`}),v.quantity&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.quantity})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cost (TSH) *"}),e.jsx("input",{type:"number",min:"0",step:"100",value:g.cost,onChange:b=>k("cost",parseInt(b.target.value)||0),className:`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${v.cost?"border-red-300":"border-gray-300"}`,placeholder:"0"}),v.cost&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.cost})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:g.status,onChange:b=>k("status",b.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"ordered",children:"Ordered"}),e.jsx("option",{value:"shipped",children:"Shipped"}),e.jsx("option",{value:"received",children:"Received"}),e.jsx("option",{value:"installed",children:"Installed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Estimated Arrival"}),e.jsx("input",{type:"date",value:g.estimatedArrival,onChange:b=>k("estimatedArrival",b.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes"}),e.jsx("textarea",{value:g.notes,onChange:b=>k("notes",b.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:3,placeholder:"Additional notes about this part..."})]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Total Cost:"}),e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:[(g.cost*g.quantity).toLocaleString()," TSH"]})]})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-gray-200",children:[e.jsx(F,{variant:"outline",onClick:o,size:"md",children:"Cancel"}),e.jsx(F,{variant:"primary",onClick:u,size:"md",icon:e.jsx(js,{className:"w-4 h-4"}),children:l?"Update Part":"Add Part"})]})]}),e.jsx(Fs,{...j.props})]}):null},ms=({device:a,onPartsSelected:o,onClose:p,isOpen:l})=>{const{spareParts:j,categories:g,isLoading:f,loadSpareParts:v,loadCategories:r}=xs(),[I,u]=x.useState(""),[k,b]=x.useState("all"),[w,T]=x.useState([]),[te,oe]=x.useState(!1),{currentUser:E}=Je(),z=(E==null?void 0:E.role)==="admin",B=j.filter(d=>{var M;const S=d.name.toLowerCase().includes(I.toLowerCase())||d.part_number.toLowerCase().includes(I.toLowerCase())||((M=d.brand)==null?void 0:M.toLowerCase().includes(I.toLowerCase())),C=k==="all"||d.category_id===k,_=d.quantity>0,G=d.is_active;return S&&C&&_&&G});x.useEffect(()=>{l&&(console.log("ðŸ” [SparePartsSelector] Loading data when modal opens"),v(),r())},[l,v,r]),x.useEffect(()=>{l&&console.log("ðŸ” [SparePartsSelector] Spare parts data:",{totalParts:j.length,isLoading:f,filteredParts:B.length,searchTerm:I,selectedCategory:k})},[j,f,B,I,k,l]);const Q=d=>{if(d.quantity<=0){h.error(`${d.name} is out of stock.`);return}const S=w.find(C=>C.spare_part_id===d.id);if(S){if(S.quantity+1>d.quantity){h.error(`Cannot add more. Only ${d.quantity} available in stock.`);return}T(C=>C.map(_=>_.spare_part_id===d.id?{..._,quantity:Math.min(_.quantity+1,d.quantity),total_cost:Math.min(_.quantity+1,d.quantity)*_.cost_per_unit}:_))}else{const C={spare_part_id:d.id,name:d.name,part_number:d.part_number,quantity:1,cost_per_unit:d.selling_price,total_cost:d.selling_price,notes:""};T(_=>[..._,C])}h.success("Part added to selection")},de=(d,S)=>{const C=j.find(G=>G.id===d);if(!C)return;if(S>C.quantity){h.error(`Cannot select ${S}. Only ${C.quantity} available in stock.`);return}if(S<1){h.error("Quantity must be at least 1.");return}const _=Math.max(1,Math.min(S,C.quantity));T(G=>G.map(M=>M.spare_part_id===d?{...M,quantity:_,total_cost:_*M.cost_per_unit}:M))},A=d=>{T(S=>S.filter(C=>C.spare_part_id!==d)),h.success("Part removed from selection")},O=w.reduce((d,S)=>d+S.total_cost,0),Z=w.reduce((d,S)=>d+S.quantity,0),X=()=>{if(w.length===0){h.error("Please select at least one part");return}o(w),p()};return l?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold",children:"Select Parts"}),e.jsxs("p",{className:"text-blue-100 text-sm",children:[a.brand," ",a.model]})]})]}),e.jsx("button",{onClick:p,className:"w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition-colors",children:e.jsx(ne,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"p-4 space-y-4 overflow-y-auto max-h-[calc(85vh-100px)]",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Search Parts"}),e.jsxs("div",{className:"relative",children:[e.jsx(Qe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 w-3 h-3"}),e.jsx(zs,{value:I,onChange:d=>u(d.target.value),placeholder:"Search by name, part number, or brand...",className:"pl-8 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Category"}),e.jsxs(qe,{value:k,onChange:d=>b(d.target.value),children:[e.jsx("option",{value:"all",children:"All Categories"}),g.map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))]})]})]}),w.length>0&&e.jsxs(Le,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Selected Parts (",w.length,")"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Total: ",Z," parts",z&&` â€¢ ${O.toLocaleString()} TZS`]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>oe(!te),children:[te?"Hide":"Show"," Details"]})]})]}),te&&e.jsx("div",{className:"space-y-3",children:w.map(d=>{const S=j.find(C=>C.id===d.spare_part_id);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:d.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:[d.part_number," â€¢ ",d.cost_per_unit.toLocaleString()," TZS each"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>de(d.spare_part_id,d.quantity-1),className:"w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300",children:e.jsx(ys,{className:"w-4 h-4"})}),e.jsx("span",{className:"w-12 text-center font-medium",children:d.quantity}),e.jsx("button",{onClick:()=>de(d.spare_part_id,d.quantity+1),className:"w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300",disabled:S&&d.quantity>=S.quantity,children:e.jsx(ve,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium",children:[d.total_cost.toLocaleString()," TZS"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Max: ",(S==null?void 0:S.quantity)||0]})]}),e.jsx("button",{onClick:()=>A(d.spare_part_id),className:"w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center hover:bg-red-200 text-red-600",children:e.jsx(ne,{className:"w-4 h-4"})})]})]},d.spare_part_id)})})]}),f?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading spare parts..."})]}):B.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No spare parts found"}),e.jsx("p",{className:"text-gray-500",children:"Try adjusting your search criteria or check if parts are in stock"}),e.jsxs("div",{className:"mt-4 text-sm text-gray-400",children:[e.jsxs("p",{children:["Total spare parts in database: ",j.length]}),e.jsxs("p",{children:["Filtered results: ",B.length]})]})]}):e.jsx(e.Fragment,{children:B.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No spare parts found"}),e.jsx("p",{className:"text-gray-500",children:"Try adjusting your search criteria or check if parts are in stock"}),e.jsxs("div",{className:"mt-4 text-sm text-gray-400",children:[e.jsxs("p",{children:["Total spare parts in database: ",j.length]}),e.jsxs("p",{children:["Filtered results: ",B.length]})]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:B.map(d=>{var _;const S=w.some(G=>G.spare_part_id===d.id),C=((_=w.find(G=>G.spare_part_id===d.id))==null?void 0:_.quantity)||0;return e.jsxs(Le,{className:"p-4 hover:shadow-lg transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:d.name}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["#",d.part_number]}),d.brand&&e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Brand: ",d.brand]})]}),S&&e.jsx("div",{className:"w-6 h-6 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(se,{className:"w-4 h-4 text-green-600"})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Price:"}),e.jsxs("span",{className:"font-medium",children:[d.selling_price.toLocaleString()," TZS"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Stock:"}),e.jsxs("span",{className:`font-medium ${d.quantity>10?"text-green-600":d.quantity>0?"text-yellow-600":"text-red-600"}`,children:[d.quantity," available"]})]}),C>0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Selected:"}),e.jsx("span",{className:"font-medium text-blue-600",children:C})]})]}),e.jsx(F,{onClick:()=>Q(d),disabled:d.quantity===0,className:"w-full",variant:S?"outline":"primary",children:S?e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Add More"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ns,{className:"w-4 h-4 mr-2"}),"Add to Selection"]})})]},d.id)})})})]}),e.jsxs("div",{className:"bg-gray-50 px-6 py-4 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:w.length>0&&e.jsxs(e.Fragment,{children:[w.length," parts selected",z&&` â€¢ ${O.toLocaleString()} TZS`]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(F,{variant:"outline",onClick:p,children:"Cancel"}),e.jsxs(F,{onClick:X,disabled:w.length===0,children:["Confirm Selection (",w.length,")"]})]})]})]})}):null};function Vs(a){return!a||a.length===0?!1:a.some(o=>o.status!=="received"&&o.status!=="used")}function Ks(a){return!a||a.length===0?!0:a.every(o=>o.status==="accepted"||o.status==="received"||o.status==="used")}function ze(a,o,p){if(console.log("ðŸ” [DEBUG] validateRepairProgress called:",{partsCount:(a==null?void 0:a.length)||0,currentStatus:o,targetStatus:p,parts:a==null?void 0:a.map(g=>({id:g.id,name:g.name,status:g.status}))}),!a||a.length===0)return{valid:!0,message:"No parts required for this repair"};const l=["diagnosis-started -> in-repair","awaiting-parts -> in-repair","parts-arrived -> in-repair","in-repair -> reassembled-testing","reassembled-testing -> repair-complete"],j=`${o} -> ${p}`;if(l.includes(j)){const g=a.every(f=>f.status==="accepted"||f.status==="received"||f.status==="used");if(console.log("ðŸ” [DEBUG] Parts readiness check:",{allPartsReady:g,partsStatuses:a.map(f=>({name:f.name,status:f.status}))}),!g){const f=a.filter(r=>r.status!=="accepted"&&r.status!=="received"&&r.status!=="used"),v=[...new Set(f.map(r=>r.status))];return{valid:!1,message:`Cannot continue repair: ${f.length} part(s) still pending (${v.join(", ")}). All parts must be accepted before continuing.`}}}return{valid:!0,message:"Repair can continue"}}function Ve(a,o){if(!a||a.length===0)return{shouldProgress:!1,nextStatus:null,message:"No parts to monitor"};if(!a.every(g=>g.status==="received"||g.status==="used"))return{shouldProgress:!1,nextStatus:null,message:"Not all parts are ready yet"};const j={"diagnosis-started":"in-repair","awaiting-parts":"parts-arrived","parts-arrived":"in-repair"}[o];return j?{shouldProgress:!0,nextStatus:j,message:`All parts received! Auto-progressing from ${o} to ${j}`}:{shouldProgress:!1,nextStatus:null,message:"No auto-progression rule for current status"}}function Qs(a,o){if(!a||!o)return!1;if(a.length!==o.length)return!0;for(let p=0;p<o.length;p++){const l=a[p],j=o[p];if(l&&j&&l.status!==j.status&&(j.status==="received"||j.status==="used"))return!0}return!1}const Ke=({device:a,currentUser:o,onStatusUpdate:p,onPartsUpdate:l})=>{const[j,g]=x.useState(null),[f,v]=x.useState(!1),[r,I]=x.useState(0),[u,k]=x.useState([]),[b,w]=x.useState([]),[T,te]=x.useState(!1),[oe,E]=x.useState(!1),[z,B]=x.useState(""),[Q,de]=x.useState(!1),[A,O]=x.useState([]),[Z,X]=x.useState(!1),[d,S]=x.useState(!1),[C,_]=x.useState(""),[G,M]=x.useState(!1),[be,W]=x.useState(null),[N,R]=x.useState(!1),[we,ge]=x.useState(!1),U=async(s,t)=>{await p(a.id,s,t)},ce=(s,t,i)=>({assigned:`Hujambo ${t}! Kifaa chako ${i} kimepewa technician. Tutakujulisha mwendelezo wa ukarabati. - LATS CHANCE`,"diagnosis-started":`Hujambo ${t}! Kifaa chako ${i} kimeanza diagnosis. Technician anachunguza tatizo. Tutakujulisha matokeo. - LATS CHANCE`,"awaiting-parts":`Hujambo ${t}! Kifaa chako ${i} kinahitaji spare parts. Tunasubiri parts kufika, tutakujulisha. - LATS CHANCE`,"in-repair":`Hujambo ${t}! Kifaa chako ${i} kinakarabatiwa. Technician anafanya kazi, tutakujulisha mwendelezo. - LATS CHANCE`,"repair-complete":`Hujambo ${t}! Kifaa chako ${i} kimekarabatiwa! Unaweza kuja kukichukua. - LATS CHANCE`,"reassembled-testing":`Hujambo ${t}! Kifaa chako ${i} kimekarabatiwa na kinajaribiwa. Karibu kukichukua. - LATS CHANCE`,"returned-to-customer-care":`Hujambo ${t}! Kifaa chako ${i} kimekarabatiwa na kiko tayari kuchukuliwa. Karibu ofisini. - LATS CHANCE`,done:`Asante ${t}! Kifaa chako ${i} kimechukuliwa. Karibu tena! - LATS CHANCE`,failed:`Hujambo ${t}. Kuna tatizo na kifaa chako ${i}. Tunaomba uje ofisini kujadili. - LATS CHANCE`})[s]||`Hujambo ${t}! Kuna update kuhusu kifaa chako ${i}. - LATS CHANCE`,Se=()=>{const s=a.customerName||"Mteja",t=`${a.brand} ${a.model}`||"kifaa chako",i=ce(a.status,s,t);B(i),E(!0)},me=async s=>{if(!z.trim()){h.error("Please enter a message");return}de(!0);try{const{data:t,error:i}=await J.from("customers").select("phone").eq("id",a.customerId).single();if(i||!(t!=null&&t.phone)){h.error("Customer phone number not found");return}if(s==="smart"){const{smartNotificationService:m}=await De(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),c=await m.sendNotification(t.phone,z);if(c.success){const D=c.method==="whatsapp"?"WhatsApp":"SMS";h.success(`${D} message sent successfully`)}else h.error(`Failed to send message: ${c.error||"Unknown error"}`)}else if(s==="sms"){const{default:m}=await De(()=>import("./index-61458a34.js").then(D=>D.ba),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),c=await m.sendSMS(t.phone,z);c.success?h.success("SMS sent successfully"):h.error(`SMS failed: ${c.error}`)}else{const c=await(await De(()=>import("./whatsappService-09f99080.js"),["assets/whatsappService-09f99080.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"])).default.sendMessage(t.phone,z);c.success?h.success("WhatsApp message sent successfully"):h.error(`WhatsApp failed: ${c.error}`)}E(!1),B("")}catch(t){console.error("Error sending message:",t),h.error("Failed to send message")}finally{de(!1)}},he=s=>{O(t=>t.includes(s)?t.filter(i=>i!==s):[...t,s])},n=()=>{const s=u.filter(t=>t.status==="needed"||t.status==="ordered");A.length===s.length?O([]):O(s.map(t=>t.id))},P=async()=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot accept parts for finished devices. This device is already completed.");return}if(A.length===0){h.error("âš ï¸ Please select parts from the list below to accept them. Click on the checkboxes next to the parts you want to accept.");return}X(!0);try{const{acceptSpareParts:s}=await De(()=>import("./index-61458a34.js").then(i=>i.bj),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=await s(A);if(t.ok&&t.data){const i=u.map(m=>A.includes(m.id)?{...m,status:"accepted"}:m);if(k(i),h.success(t.message),O([]),a&&a.id){const{areAllSparePartsReady:m}=await De(()=>import("./index-61458a34.js").then(D=>D.bj),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),c=await m(a.id);c.ready?(await U("parts-arrived"),h.success('âœ… All parts accepted! Device status updated to "Parts Arrived". You can now start repair work.')):h.success(`âœ… Parts accepted! ${c.message}. Continue accepting remaining parts to start repair work.`)}}else h.error(`âŒ Failed to accept parts: ${t.message||"Please try again or contact support if the issue persists."}`)}catch(s){console.error("Error accepting parts:",s),h.error("âŒ Failed to accept parts. Please try again or contact support if the issue persists.")}finally{X(!1)}},V=async()=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot reject parts for finished devices. This device is already completed.");return}if(A.length===0){h.error("Please select parts to reject");return}X(!0);try{const{rejectSpareParts:s}=await De(()=>import("./index-61458a34.js").then(i=>i.bj),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),t=await s(A,C);if(t.ok&&t.data){const i=u.map(m=>A.includes(m.id)?{...m,status:"needed",notes:C?`Rejected by customer care: ${C}`:m.notes}:m);k(i),h.success(t.message),O([]),S(!1),_("")}else h.error(t.message||"Failed to reject parts")}catch(s){console.error("Error rejecting parts:",s),h.error("Failed to reject parts")}finally{X(!1)}},Y=async()=>{if(u.length>0){const s=Ve(u,a.status);if(s.shouldProgress&&s.nextStatus){console.log("ðŸ”„ [AUTO-PROGRESSION] Manual check triggered auto-progression:",s);try{h.success(`ðŸš€ ${s.message}`,{duration:4e3,icon:"ðŸ”„"}),await U(s.nextStatus),h.success(`âœ… Repair progressed to: ${s.nextStatus.replace("-"," ")}`,{duration:5e3,icon:"ðŸŽ‰"})}catch(t){console.error("Error during manual auto-progression:",t),h.error("Failed to auto-progress repair status. Please try again.")}}else console.log("ðŸ”„ [AUTO-PROGRESSION] Manual check - no progression needed:",s.message)}},$=async(s,t)=>{try{const{error:i}=await J.from("customer_payments").insert({customer_id:a==null?void 0:a.customerId,device_id:a==null?void 0:a.id,amount:t||s.amount,method:s.method||"cash",payment_type:"payment",status:"completed",payment_date:new Date().toISOString(),currency:"TZS",payment_account_id:s.paymentAccountId||null,payment_method_id:s.paymentMethodId||null,reference:s.reference||null,notes:`Device payment - ${a==null?void 0:a.brand} ${a==null?void 0:a.model}`,created_at:new Date().toISOString()});if(i)throw i;h.success(`Payment of ${ie(t||s.amount)} recorded successfully`),v(!1)}catch(i){console.error("Error recording payment:",i),h.error("Failed to record payment")}};x.useEffect(()=>{a!=null&&a.id&&H()},[a==null?void 0:a.id]),x.useEffect(()=>{const s=setInterval(()=>{["diagnosis-started","awaiting-parts","parts-arrived"].includes(a.status)&&u.length>0&&(console.log("ðŸ”„ [AUTO-PROGRESSION] Periodic check for status:",a.status),Y())},3e4);return()=>clearInterval(s)},[a.status,u]),x.useEffect(()=>{if(u.length>0){const s=Ve(u,a.status);s.shouldProgress&&s.nextStatus&&(console.log("ðŸ”„ [AUTO-PROGRESSION] Status change triggered auto-progression check:",s),u.every(i=>i.status==="received"||i.status==="used")&&setTimeout(async()=>{try{h.success(`ðŸš€ ${s.message}`,{duration:4e3,icon:"ðŸ”„"}),await U(s.nextStatus),h.success(`âœ… Repair auto-progressed to: ${s.nextStatus.replace("-"," ")}`,{duration:5e3,icon:"ðŸŽ‰"})}catch(i){console.error("Error during status-change auto-progression:",i),h.error("Failed to auto-progress repair status. Please update manually.")}},1500))}},[a.status,u]);const H=async()=>{if(a!=null&&a.id){te(!0);try{const s=await is(a.id);if(s.ok&&s.data){const t=s.data.map(i=>{var m,c,D,y;return{id:i.id,name:((m=i.spare_part)==null?void 0:m.name)||"Unknown Part",description:((c=i.spare_part)==null?void 0:c.description)||"",quantity:i.quantity_needed||0,cost:i.cost_per_unit||0,status:i.status||"needed",supplier:((y=(D=i.spare_part)==null?void 0:D.supplier)==null?void 0:y.name)||"Unknown",estimatedArrival:i.estimated_arrival||null,notes:i.notes||""}});if(w(u),k(t),u.length>0&&Qs(u,t)){console.log("ðŸ”„ [AUTO-PROGRESSION] Parts status changed, checking for auto-progression...");const i=Ve(t,a.status);i.shouldProgress&&i.nextStatus?(console.log("ðŸ”„ [AUTO-PROGRESSION] Triggering auto-progression:",i),h.success(`ðŸš€ ${i.message}`,{duration:4e3,icon:"ðŸ”„"}),setTimeout(async()=>{try{await U(i.nextStatus),h.success(`âœ… Repair automatically progressed to: ${i.nextStatus.replace("-"," ")}`,{duration:5e3,icon:"ðŸŽ‰"})}catch(m){console.error("Error during auto-progression:",m),h.error("Failed to auto-progress repair status. Please update manually.")}},2e3)):console.log("ðŸ”„ [AUTO-PROGRESSION] No auto-progression needed:",i.message)}}else console.warn("Error loading repair parts:",s.message),k([])}catch(s){console.error("Error loading repair parts:",s),k([])}finally{te(!1)}}},pe=async s=>{if(a){if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot request parts for finished devices. This device is already completed.");return}try{await Promise.all(s.map(async t=>{const i={device_id:a.id,spare_part_id:t.spare_part_id,quantity_needed:t.quantity,cost_per_unit:t.cost_per_unit,notes:t.notes||""};return await ns(i)})),h.success(`${s.length} parts requested successfully`),H()}catch(t){console.error("Error requesting parts:",t),h.error("Failed to request parts")}}},fe=s=>{switch(s){case"ordered":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"shipped":return"bg-blue-100 text-blue-800 border-blue-200";case"received":return"bg-green-100 text-green-800 border-green-200";case"installed":return"bg-purple-100 text-purple-800 border-purple-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},je=s=>{switch(s){case"ordered":return e.jsx(Xe,{className:"w-4 h-4"});case"shipped":return e.jsx(Ge,{className:"w-4 h-4"});case"received":return e.jsx(q,{className:"w-4 h-4"});case"installed":return e.jsx(se,{className:"w-4 h-4"});default:return e.jsx(Pe,{className:"w-4 h-4"})}},ye=async()=>{console.log("[RepairStatusGrid] handleStartRepair called for device:",a.id);try{console.log("[RepairStatusGrid] Calling onStatusUpdate with:",{deviceId:a.id,status:"in-repair",notes:"Parts received, starting repair work"}),await p(a.id,"in-repair","Parts received, starting repair work")}catch(s){console.error("[RepairStatusGrid] Error in handleStartRepair:",s),h.error("Failed to update repair status")}},ee=(s,t)=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot update part status for finished devices. This device is already completed.");return}const i=u.map(m=>m.id===s?{...m,status:t}:m);k(i),l==null||l(i),h.success(`Part status updated to ${t}`)},Re=s=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot add parts for finished devices. This device is already completed."),M(!1);return}k(t=>[...t,s]),l==null||l([...u,s]),M(!1)},ke=s=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot edit parts for finished devices. This device is already completed."),W(null);return}const t=u.map(i=>i.id===s.id?s:i);k(t),l==null||l(t),W(null)},$e=s=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot delete parts for finished devices. This device is already completed.");return}const t=u.filter(i=>i.id!==s);k(t),l==null||l(t),h.success("Part removed successfully")},Fe=()=>u.some(s=>s.status==="received")&&u.every(s=>s.status==="received"||s.status==="installed"),Te=()=>u.reduce((s,t)=>s+t.cost*t.quantity,0),Me=()=>{const s=u.length,t=u.filter(i=>i.status==="received"||i.status==="installed").length;return s>0?Math.round(t/s*100):0};if(a.status==="awaiting-parts")return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center",children:e.jsx(q,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-orange-900",children:"Awaiting Parts"}),e.jsx("p",{className:"text-orange-700",children:"Waiting for replacement parts to arrive"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-900",children:[Me(),"%"]}),e.jsx("div",{className:"text-sm text-orange-600",children:"Parts Ready"})]})]}),e.jsx("div",{className:"w-full bg-orange-200 rounded-full h-3 mb-4",children:e.jsx("div",{className:"bg-gradient-to-r from-orange-500 to-amber-500 h-3 rounded-full transition-all duration-500",style:{width:`${Me()}%`}})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"Total Parts"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:u.length})]}),e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"Received"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:u.filter(s=>s.status==="received"||s.status==="installed").length})]}),e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"Total Cost"}),e.jsxs("div",{className:"text-lg font-bold text-orange-900",children:[Te().toLocaleString()," TSH"]})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:u.map(s=>e.jsxs(Le,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-1",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[e.jsxs("span",{children:["Qty: ",s.quantity]}),e.jsxs("span",{children:["Cost: ",s.cost.toLocaleString()," TSH"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${fe(s.status)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[je(s.status),s.status]})})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ds,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:["Supplier: ",s.supplier]})]}),s.estimatedArrival&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Xe,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{className:"text-gray-600",children:["ETA: ",s.estimatedArrival]})]}),s.notes&&e.jsx("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded",children:s.notes})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[s.status==="ordered"&&e.jsxs(F,{variant:"primary",size:"sm",onClick:()=>ee(s.id,"shipped"),children:[e.jsx(Ge,{className:"w-4 h-4"}),"Mark Shipped"]}),s.status==="shipped"&&e.jsxs(F,{variant:"success",size:"sm",onClick:()=>ee(s.id,"received"),children:[e.jsx(q,{className:"w-4 h-4"}),"Mark Received"]}),s.status==="received"&&e.jsxs(F,{variant:"secondary",size:"sm",onClick:()=>ee(s.id,"installed"),children:[e.jsx(K,{className:"w-4 h-4"}),"Mark Installed"]}),e.jsxs("div",{className:"flex gap-1 ml-auto",children:[e.jsx("button",{onClick:()=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot edit parts for finished devices. This device is already completed.");return}W(s)},className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Edit part",children:e.jsx(Oe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>$e(s.id),className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete part",children:e.jsx(Ue,{className:"w-4 h-4"})})]})]})]},s.id))}),Fe()&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center",children:e.jsx(K,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-green-900",children:"Ready to Start Repair"}),e.jsx("p",{className:"text-green-700",children:"All required parts have been received"})]})]}),e.jsxs(F,{variant:"success",size:"lg",onClick:ye,className:"px-6 py-3",children:[e.jsx(K,{className:"w-5 h-5"}),"Start Repair"]})]})}),e.jsxs("div",{className:"flex justify-center gap-4",children:[a.status!=="done"&&a.status!=="failed"&&e.jsxs(F,{variant:"outline",onClick:()=>M(!0),className:"px-6 py-3",children:[e.jsx(ve,{className:"w-5 h-5"}),"Add Part"]}),e.jsxs(F,{variant:"primary",onClick:()=>R(!0),className:"px-6 py-3",children:[e.jsx(q,{className:"w-5 h-5"}),"Manage Spare Parts"]})]}),e.jsx(ls,{isOpen:G,onClose:()=>M(!1),onSave:Re}),e.jsx(ls,{isOpen:!!be,onClose:()=>W(null),onSave:ke,editingPart:be}),N&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-purple-600"}),"Manage Spare Parts"]}),e.jsx("button",{onClick:()=>R(!1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-120px)]",children:e.jsxs("div",{className:"space-y-4",children:[a.status!=="done"&&a.status!=="failed"&&e.jsx("div",{className:"flex justify-end",children:e.jsxs(F,{variant:"primary",onClick:()=>M(!0),className:"px-4 py-2",children:[e.jsx(ve,{className:"w-4 h-4"}),"Add New Part"]})}),u.length>0?e.jsx("div",{className:"space-y-3",children:u.map(s=>e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.description})]})]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${s.status==="ordered"?"bg-blue-100 text-blue-800":s.status==="shipped"?"bg-yellow-100 text-yellow-800":s.status==="received"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-3",children:[e.jsxs("div",{children:["Quantity: ",s.quantity]}),e.jsxs("div",{children:["Cost: ",ie(s.cost)]}),e.jsxs("div",{children:["Total: ",ie(s.quantity*s.cost)]}),e.jsxs("div",{children:["Supplier: ",s.supplier]})]}),s.notes&&e.jsxs("div",{className:"text-sm text-gray-500 italic mb-3",children:["Note: ",s.notes]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[s.status==="ordered"&&e.jsxs(F,{variant:"primary",size:"sm",onClick:()=>ee(s.id,"shipped"),children:[e.jsx(Ge,{className:"w-4 h-4"}),"Mark Shipped"]}),s.status==="shipped"&&e.jsxs(F,{variant:"success",size:"sm",onClick:()=>ee(s.id,"received"),children:[e.jsx(se,{className:"w-4 h-4"}),"Mark Received"]}),s.status==="received"&&e.jsxs(F,{variant:"success",size:"sm",onClick:()=>ee(s.id,"installed"),children:[e.jsx(K,{className:"w-4 h-4"}),"Mark Installed"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>{if(a.status==="done"||a.status==="failed"){h.error("ðŸš« Cannot edit parts for finished devices. This device is already completed.");return}W(s),M(!0)},children:[e.jsx(Oe,{className:"w-4 h-4"}),"Edit"]}),e.jsxs(F,{variant:"danger",size:"sm",onClick:()=>$e(s.id),children:[e.jsx(Ue,{className:"w-4 h-4"}),"Delete"]})]})]},s.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(q,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No spare parts added"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Add spare parts needed for this repair"}),e.jsxs(F,{variant:"primary",onClick:()=>M(!0),className:"px-6 py-3",children:[e.jsx(ve,{className:"w-4 h-4"}),"Add First Part"]})]})]})}),e.jsx("div",{className:"flex justify-end gap-3 p-6 border-t border-gray-200",children:e.jsx(F,{variant:"outline",onClick:()=>R(!1),children:"Close"})})]})})]});if(a.status==="parts-arrived")return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center",children:e.jsx(q,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-green-900",children:"Parts Arrived"}),e.jsx("p",{className:"text-green-700",children:"All required parts have been received and are ready for repair"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-green-900",children:"100%"}),e.jsx("div",{className:"text-sm text-green-600",children:"Parts Ready"})]})]}),e.jsx("div",{className:"w-full bg-green-200 rounded-full h-3 mb-4",children:e.jsx("div",{className:"bg-gradient-to-r from-green-500 to-emerald-500 h-3 rounded-full transition-all duration-500 w-full"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"Total Parts"}),e.jsx("div",{className:"text-lg font-bold text-green-900",children:u.length})]}),e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"Received"}),e.jsx("div",{className:"text-lg font-bold text-green-900",children:u.filter(s=>s.status==="received"||s.status==="installed").length})]}),e.jsxs("div",{className:"bg-white/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"Total Cost"}),e.jsxs("div",{className:"text-lg font-bold text-green-900",children:[Te().toLocaleString()," TSH"]})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map(s=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:s.name}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.status==="received"?"bg-green-100 text-green-700":s.status==="installed"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:s.status})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Cost:"})," ",s.cost.toLocaleString()," TSH"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Supplier:"})," ",s.supplier]}),s.description&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Description:"})," ",s.description]}),s.notes&&e.jsx("div",{className:"text-sm text-gray-600 bg-gray-50 p-2 rounded",children:s.notes})]})]},s.id))}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(F,{variant:"primary",size:"lg",onClick:()=>p(a.id,"in-repair"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(K,{className:"w-5 h-5"}),"Start Repair"]})})]});const Ee=x.useMemo(()=>{const s=[],t=(o==null?void 0:o.role)==="technician"&&a.assignedTo===o.id,i=(o==null?void 0:o.role)==="admin",m=(o==null?void 0:o.role)==="customer-care";if(a.status==="assigned"&&(t||i||m)&&s.push({id:"start-diagnosis",title:"Start Diagnosis",description:"Begin diagnostic process",icon:e.jsx(Pe,{className:"w-6 h-6"}),color:"bg-yellow-500",action:async()=>{await U("diagnosis-started","Diagnostic process started")}}),a.status==="diagnosis-started"&&(t||i)){Vs(u);const c=ze(u,a.status,"in-repair");c.valid?s.push({id:"start-repair",title:"Start Repair",description:"Begin repair work with available parts",icon:e.jsx(K,{className:"w-6 h-6"}),color:"bg-purple-500",action:async()=>{g("start-repair");try{await p(a.id,"in-repair")}finally{g(null)}}}):s.push({id:"start-repair-disabled",title:"Start Repair",description:c.message||"Cannot start repair",icon:e.jsx(K,{className:"w-6 h-6"}),color:"bg-gray-400 cursor-not-allowed",disabled:!0,action:async()=>{h.error(c.message||"Cannot start repair")}})}if(a.status==="awaiting-parts"&&(t||i||m)&&(Ks(u)?s.push({id:"parts-arrived",title:"Parts Arrived",description:"All parts received, ready to start repair",icon:e.jsx(q,{className:"w-6 h-6"}),color:"bg-green-500",action:async()=>{g("parts-arrived");try{await p(a.id,"parts-arrived")}finally{g(null)}}}):s.push({id:"check-parts",title:"Check Parts Status",description:"Review spare parts delivery status",icon:e.jsx(q,{className:"w-6 h-6"}),color:"bg-blue-500",action:async()=>{R(!0)}})),a.status==="parts-arrived"&&(t||i)){const c=ze(u,a.status,"in-repair");c.valid?s.push({id:"start-repair",title:"Start Repair",description:"Begin repair work with all parts ready",icon:e.jsx(K,{className:"w-6 h-6"}),color:"bg-purple-500",action:async()=>{g("start-repair");try{await p(a.id,"in-repair")}finally{g(null)}}}):s.push({id:"start-repair-disabled",title:"Start Repair",description:c.message||"Cannot start repair",icon:e.jsx(K,{className:"w-6 h-6"}),color:"bg-gray-400 cursor-not-allowed",disabled:!0,action:async()=>{h.error(c.message||"Cannot start repair")}})}if(a.status==="in-repair"&&(t||i)){const c=ze(u,a.status,"reassembled-testing");c.valid?s.push({id:"testing",title:"Start Testing",description:"Device reassembled, begin testing",icon:e.jsx(se,{className:"w-6 h-6"}),color:"bg-indigo-500",action:async()=>{g("testing");try{await p(a.id,"reassembled-testing")}finally{g(null)}}}):s.push({id:"testing-disabled",title:"Start Testing",description:c.message||"Cannot start testing",icon:e.jsx(se,{className:"w-6 h-6"}),color:"bg-gray-400 cursor-not-allowed",disabled:!0,action:async()=>{h.error(c.message||"Cannot start testing")}})}if(a.status==="reassembled-testing"&&(t||i)){const c=ze(u,a.status,"repair-complete");c.valid?s.push({id:"complete",title:"Complete Repair",description:"Repair completed successfully",icon:e.jsx(se,{className:"w-6 h-6"}),color:"bg-green-500",action:async()=>{g("complete");try{await p(a.id,"repair-complete")}finally{g(null)}}}):s.push({id:"complete-disabled",title:"Complete Repair",description:c.message||"Cannot complete repair",icon:e.jsx(se,{className:"w-6 h-6"}),color:"bg-gray-400 cursor-not-allowed",disabled:!0,action:async()=>{h.error(c.message||"Cannot complete repair")}})}if(a.status==="repair-complete"&&(t||i||m)&&s.push({id:"return-to-customer-care",title:"Return to Customer Care",description:"Device ready for customer pickup",icon:e.jsx(vs,{className:"w-6 h-6"}),color:"bg-teal-500",action:async()=>{g("return-to-customer-care");try{await p(a.id,"returned-to-customer-care")}finally{g(null)}}}),a.status==="returned-to-customer-care"&&(i||m)&&s.push({id:"mark-done",title:"Mark as Done",description:"Customer has received device",icon:e.jsx(se,{className:"w-6 h-6"}),color:"bg-green-600",action:async()=>{g("mark-done");try{await p(a.id,"done")}finally{g(null)}}}),["diagnosis-started","awaiting-parts","parts-arrived","in-repair","reassembled-testing"].includes(a.status)&&(t||i)&&s.push({id:"mark-failed",title:"Mark as Failed",description:"Mark repair as failed - cannot be completed",icon:e.jsx(Ye,{className:"w-6 h-6"}),color:"bg-red-500",action:async()=>{g("mark-failed");try{await p(a.id,"failed")}finally{g(null)}}}),(m||i)&&a.customerId&&a.status!=="assigned"&&s.push({id:"send-sms",title:"Send SMS to Customer",description:"Send status update SMS to customer",icon:e.jsx(We,{className:"w-6 h-6"}),color:"bg-indigo-500",action:async()=>{Se()}}),m||i){const c=u.filter(D=>D.status==="needed"||D.status==="ordered");c.length>0&&s.push({id:"accept-parts",title:"Accept Spare Parts",description:`Accept ${c.length} requested spare parts`,icon:e.jsx(es,{className:"w-6 h-6"}),color:"bg-green-500",action:async()=>{h.success("ðŸ“‹ Parts Management: Use the parts list below to select and accept parts. Click on individual parts to mark them as accepted before starting repair work.")}})}return s},[a.status,a.assignedTo,o==null?void 0:o.role,o==null?void 0:o.id,u,j]);return a.status==="done"?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(se,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Repair Completed! ðŸŽ‰"}),e.jsx("p",{className:"text-gray-600",children:"Device has been successfully repaired and returned to customer"}),e.jsx("div",{className:"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Status:"})," ",a.status," (100% Complete)"]})})]}):Ee.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(se,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No Actions Available"}),e.jsxs("p",{className:"text-gray-600",children:["Current status: ",a.status]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"space-y-3",children:Ee.map(s=>e.jsxs("button",{onClick:s.action,disabled:j!==null||s.disabled,className:`
                group relative overflow-hidden rounded-xl p-4 transition-all duration-300 w-full
                ${j!==null||s.disabled?"opacity-50 cursor-not-allowed":"hover:scale-[1.01] hover:shadow-lg"}
                ${s.color==="bg-indigo-500"?"bg-gradient-to-br from-indigo-500 to-indigo-600":s.color==="bg-purple-500"?"bg-gradient-to-br from-purple-500 to-purple-600":s.color==="bg-green-500"?"bg-gradient-to-br from-green-500 to-green-600":s.color==="bg-orange-500"?"bg-gradient-to-br from-orange-500 to-orange-600":s.color==="bg-blue-500"?"bg-gradient-to-br from-blue-500 to-blue-600":s.color==="bg-red-500"?"bg-gradient-to-br from-red-500 to-red-600":s.color==="bg-gray-400"?"bg-gradient-to-br from-gray-400 to-gray-500":"bg-gradient-to-br from-slate-500 to-slate-600"}
                shadow-md hover:shadow-xl
              `,children:[e.jsx("div",{className:"absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),e.jsxs("div",{className:"relative flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm",children:e.jsx("div",{className:"text-white",children:s.icon})}),e.jsx("div",{className:"flex-1 text-left",children:j===s.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-white font-semibold",children:"Updating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"text-white font-bold text-lg mb-1",children:s.title}),e.jsx("p",{className:"text-white/80 text-sm",children:s.description})]})}),j!==s.id&&e.jsx("div",{className:"w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-white transform group-hover:translate-x-1 transition-transform",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})]},s.id))})}),((o==null?void 0:o.role)==="customer-care"||(o==null?void 0:o.role)==="admin")&&u.length>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Spare Parts Management"})]}),T?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx("div",{className:"animate-pulse bg-gray-200 h-16 rounded-lg"},s))}):e.jsxs("div",{className:"space-y-4",children:[(()=>{const s=u.filter(t=>t.status==="needed"||t.status==="ordered");return s.length>0?e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:A.length===s.length&&s.length>0,onChange:n,className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("span",{className:"text-sm font-medium text-blue-800",children:["Select All (",s.length," actionable)"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:P,disabled:A.length===0||Z,className:"flex items-center gap-1 px-3 py-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg text-xs font-medium transition-colors",children:[e.jsx(es,{className:"w-3 h-3"}),"Accept (",A.length,")"]}),e.jsxs("button",{onClick:()=>S(!0),disabled:A.length===0||Z,className:"flex items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white rounded-lg text-xs font-medium transition-colors",children:[e.jsx(Ye,{className:"w-3 h-3"}),"Decline (",A.length,")"]})]})]}),Z&&e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 text-sm text-blue-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-300 border-t-blue-600 rounded-full animate-spin"}),"Processing..."]})})]}):null})(),e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(s.status==="needed"||s.status==="ordered")&&e.jsx("input",{type:"checkbox",checked:A.includes(s.id),onChange:()=>he(s.id),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",children:s.name||"Unknown Part"}),e.jsxs("div",{className:"text-xs text-gray-600 truncate",children:["Qty: ",s.quantity," â€¢ ",ie(s.cost)," each"]}),s.notes&&e.jsx("div",{className:"text-xs text-gray-500 italic truncate",children:s.notes})]})]}),e.jsx("div",{className:"text-right flex-shrink-0",children:e.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${s.status==="needed"?"bg-yellow-100 text-yellow-800":s.status==="ordered"?"bg-blue-100 text-blue-800":s.status==="accepted"?"bg-purple-100 text-purple-800":s.status==="received"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status})})]},s.id))})]})]}),e.jsx(Os,{isOpen:f,onClose:()=>{v(!1),I(0)},amount:r,customerId:(a==null?void 0:a.customerId)||"",customerName:(a==null?void 0:a.customerName)||"Unknown Customer",description:`Device payment - ${a==null?void 0:a.brand} ${a==null?void 0:a.model}`,onPaymentComplete:$,deviceId:a==null?void 0:a.id,allowPriceEdit:!0,paymentType:"cash_in",title:"Device Repair Payment"}),a&&e.jsx(ms,{device:a,isOpen:we,onClose:()=>{console.log("Closing spare parts selector modal"),ge(!1)},onPartsSelected:pe}),oe&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Send Message to Customer"}),e.jsx("button",{onClick:()=>{E(!1),B("")},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Message (Swahili)"}),e.jsx("textarea",{value:z,onChange:s=>B(s.target.value),placeholder:"Enter your message here...",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none",rows:4}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Character count: ",z.length]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>me("sms"),disabled:Q||!z.trim(),className:"flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center justify-center gap-2",children:[Q?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(We,{className:"w-4 h-4"}),"Send SMS"]}),e.jsxs("button",{onClick:()=>me("whatsapp"),disabled:Q||!z.trim(),className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center justify-center gap-2",children:[Q?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(We,{className:"w-4 h-4"}),"Send WhatsApp"]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>{E(!1),B("")},className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"})})]})]})})}),d&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Reject Spare Parts"}),e.jsx("button",{onClick:()=>{S(!1),_("")},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsxs("strong",{children:[A.length," parts"]}),' will be rejected and returned to "needed" status.']})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rejection Reason (Optional)"}),e.jsx("textarea",{value:C,onChange:s=>_(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:3,placeholder:"Enter reason for rejection..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>{S(!1),_("")},className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:V,disabled:Z,className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center justify-center gap-2",children:[Z&&e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Reject Parts"]})]})]})]})})})]})},Ys=({isOpen:a,onClose:o,deviceId:p})=>{var ke,$e,Fe,Te,Me,Be,Ee;const{currentUser:l}=Je(),{devices:j,getDeviceById:g,updateDeviceStatus:f}=os(),{customers:v}=us();cs();const r=j.find(s=>s.id===p)||null;x.useState(!1);const[I,u]=x.useState("overview"),[k,b]=x.useState({}),[w,T]=x.useState(""),[te,oe]=x.useState(!1),[E,z]=x.useState([]),[B,Q]=x.useState(!1),[de,A]=x.useState(!1),[O,Z]=x.useState([]),[X,d]=x.useState(!1),[S,C]=x.useState(!1),[_,G]=x.useState(""),[M,be]=x.useState(null);x.useState(!1);const[W,N]=x.useState(null),[R,we]=x.useState(null),[ge,U]=x.useState(!1);x.useEffect(()=>{if(r){const s=[];r.assignedTo&&s.push(r.assignedTo),r.transitions&&r.transitions.forEach(i=>{i.performedBy&&!s.includes(i.performedBy)&&s.push(i.performedBy)});const t=s.filter(i=>!k[i]&&i!=="system");t.length>0&&n(t)}},[r,k]),x.useEffect(()=>{N(r?{repairCost:Number(r.repairCost)||0,depositAmount:Number(r.depositAmount)||0}:null)},[r]),x.useEffect(()=>{if(!(r!=null&&r.expectedReturnDate)){T("");return}const s=()=>{const i=new Date,c=new Date(r.expectedReturnDate).getTime()-i.getTime(),D=24*60*60*1e3;if(c<=-D){T("Overdue");return}const y=Math.floor(c/(1e3*60*60*24)),re=Math.floor(c%(1e3*60*60*24)/(1e3*60*60)),xe=Math.floor(c%(1e3*60*60)/(1e3*60));if(y>0)T(`${y}d ${re}h ${xe}m`);else if(re>0)T(`${re}h ${xe}m`);else if(xe>0)T(`${xe}m`);else{const ue=Math.floor(Math.abs(c)/36e5),Ne=Math.floor(Math.abs(c)%(1e3*60*60)/(1e3*60));ue>0?T(`${ue}h ${Ne}m overdue`):T(`${Ne}m overdue`)}};s();const t=setInterval(s,6e4);return()=>clearInterval(t)},[r==null?void 0:r.expectedReturnDate]),x.useEffect(()=>{r&&a&&(ce(),me(r.id),he(r.id),Se(r.id))},[r,a]);const ce=async()=>{try{const{data:s,error:t}=await J.from("users").select("id, full_name, username, email").not("id","is",null);if(t){console.error("Error loading user names:",t);return}if(s){const i={};s.forEach(m=>{i[m.id]=m.full_name||m.username||m.email||"Unknown User"}),b(i)}}catch(s){console.error("Error loading user names:",s)}},Se=async s=>{try{const{data:t,error:i}=await J.from("customer_payments").select("amount, status").eq("device_id",s);if(i){console.error("Error loading financial info:",i);return}const m={totalPaid:0,totalPending:0,totalFailed:0};t&&t.forEach(c=>{const D=Number(c.amount)||0;switch(c.status){case"completed":m.totalPaid+=D;break;case"pending":m.totalPending+=D;break;case"failed":m.totalFailed+=D;break}}),be(m)}catch(t){console.error("Error loading financial info:",t)}},me=async s=>{Q(!0);try{const t=await is(s);t.ok&&t.data?z(t.data):z([])}catch(t){console.error("Error loading repair parts:",t),z([])}finally{Q(!1)}},he=async s=>{var t,i;U(!0);try{const[m,c]=await Promise.all([J.from("devices").select("diagnostic_checklist").eq("id",s).single(),J.from("diagnostic_checks").select("*").eq("diagnostic_device_id",s).order("created_at",{ascending:!1})]);let D=null;if((t=m.data)!=null&&t.diagnostic_checklist){const y=typeof m.data.diagnostic_checklist=="string"?JSON.parse(m.data.diagnostic_checklist):m.data.diagnostic_checklist;let re=null,xe=y.overall_status||y.overallStatus;if(y.checklist_items&&Array.isArray(y.checklist_items)){const ue=y.checklist_items.length,Ne=y.checklist_items.filter(le=>le.result==="passed").length,Ce=y.checklist_items.filter(le=>le.result==="failed").length,ae=y.checklist_items.filter(le=>!le.completed).length;re={total:ue,passed:Ne,failed:Ce,pending:ae,lastUpdated:y.updated_at||y.completed_at},D={items:y.checklist_items.map(le=>({test:le.title,result:le.result,notes:le.notes,completed:le.completed})),summary:re,overallStatus:xe,individualChecks:y.checklist_items,technicianNotes:y.technician_notes,source:"device_checklist"}}else if(y.items&&Array.isArray(y.items)){const ue=y.items.length,Ne=y.items.filter(_e=>_e.result==="passed").length,Ce=y.items.filter(_e=>_e.result==="failed").length,ae=y.items.filter(_e=>!_e.completed).length;re={total:ue,passed:Ne,failed:Ce,pending:ae,lastUpdated:y.last_updated||y.updated_at},D={items:y.items,summary:re,overallStatus:xe,individualChecks:y.items,technicianNotes:y.notes,source:"device_checklist"}}else D={...y,source:"device_checklist"}}if(c.data&&c.data.length>0){const y=c.data,re=y.length,xe=y.filter(ae=>ae.result==="passed").length,ue=y.filter(ae=>ae.result==="failed").length,Ce={total:re,passed:xe,failed:ue,pending:0,lastUpdated:(i=y[0])==null?void 0:i.created_at};D?D={...D,individualChecks:y,summary:{...D.summary,...Ce}}:D={items:y.map(ae=>({test:ae.test_item,result:ae.result,notes:ae.remarks,completed:!0})),summary:Ce,overallStatus:ue>0?"issues-found":"all-passed",individualChecks:y,source:"diagnostic_checks"}}we(D)}catch(m){console.error("âŒ [DiagnosticData] Error loading diagnostic data:",m),we(null)}finally{U(!1)}},n=async s=>{if(s.length!==0)try{const{data:t,error:i}=await J.from("users").select("id, full_name, username").in("id",s);if(i){console.error("Error fetching user names:",i);return}if(t){const m={};t.forEach(c=>{m[c.id]=c.full_name||c.username||"Unknown User"}),b(c=>({...c,...m}))}}catch(t){console.error("Error fetching user names:",t)}},P=s=>s?k[s]?k[s]:s==="system"?"System":s.slice(0,8)+"...":"Unknown",V=()=>r&&{assigned:0,"diagnosis-started":20,"awaiting-parts":30,"in-repair":60,"reassembled-testing":80,"repair-complete":90,"returned-to-customer-care":95,done:100,failed:0}[r.status]||0,Y=(r==null?void 0:r.assignedTo)===(l==null?void 0:l.id),$=v.find(s=>s.id===(r==null?void 0:r.customerId)),H=async(s,t,i)=>{if(!r||r.id!==s){console.error("[DeviceRepairDetailModal] Invalid device or device ID mismatch"),L.error("Invalid device for status update");return}try{if(r.status===t){L(`Device is already in "${t}" status`);return}if(t==="in-repair"&&{isValid:!0,errors:[]}.isValid,t==="repair-complete"&&r.customerId)try{await Ws(s,r.customerId),L.success("Pending payments created for repair completion")}catch{L.error("Failed to create pending payments - please check payment setup")}await f(s,t,i||"")?(L.success(`Status updated to "${t}" successfully`),(t==="repair-complete"||t==="process-payments")&&await Se(s),(t==="awaiting-parts"||t==="parts-arrived"||t==="in-repair")&&await me(s)):L.error(`Failed to update status to "${t}". Please try again.`)}catch(m){console.error("[DeviceRepairDetailModal] Error updating status:",m),m instanceof Error?L.error(`Status update failed: ${m.message}`):L.error("Failed to update status. Please check your connection and try again.")}},pe=()=>{if(!r)return;const s={device:`${r.brand} ${r.model}`,serialNumber:r.serialNumber,customer:($==null?void 0:$.name)||"Unknown Customer",repairCost:(W==null?void 0:W.repairCost)||0,depositAmount:(W==null?void 0:W.depositAmount)||0,totalPaid:(M==null?void 0:M.totalPaid)||0,status:r.status,date:new Date().toLocaleDateString()},t=window.open("","_blank");t?(t.document.write(`
        <html>
          <head>
            <title>Repair Receipt - ${s.device}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
              .section { margin: 15px 0; }
              .row { display: flex; justify-content: space-between; margin: 5px 0; }
              .total { font-weight: bold; border-top: 1px solid #333; padding-top: 10px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>Device Repair Receipt</h2>
              <p>LATS CHANCE Repair Center</p>
            </div>
            <div class="section">
              <div class="row"><span>Device:</span><span>${s.device}</span></div>
              <div class="row"><span>Serial:</span><span>${s.serialNumber}</span></div>
              <div class="row"><span>Customer:</span><span>${s.customer}</span></div>
              <div class="row"><span>Date:</span><span>${s.date}</span></div>
              <div class="row"><span>Status:</span><span>${s.status}</span></div>
            </div>
            <div class="section">
              <div class="row"><span>Repair Cost:</span><span>${ie(s.repairCost)}</span></div>
              <div class="row"><span>Deposit:</span><span>${ie(s.depositAmount)}</span></div>
              <div class="row total"><span>Total Paid:</span><span>${ie(s.totalPaid)}</span></div>
            </div>
          </body>
        </html>
      `),t.document.close(),t.print(),L.success("Receipt generated successfully")):L.error("Unable to open print window. Please check your browser settings.")},fe=async()=>{if(!(!r||!$))try{let s="";const t=`${r.brand} ${r.model}`,i=$.name||"Valued Customer";switch(r.status){case"diagnosis-started":s=`Hello ${i}, your ${t} (Serial: ${r.serialNumber}) is now being diagnosed. We'll update you soon. - LATS CHANCE`;break;case"awaiting-parts":s=`Hello ${i}, we're waiting for parts for your ${t}. We'll notify you when they arrive. - LATS CHANCE`;break;case"in-repair":s=`Hello ${i}, your ${t} is currently being repaired. We'll update you on progress. - LATS CHANCE`;break;case"repair-complete":s=`Hello ${i}, your ${t} repair is complete! Please visit us to collect your device. - LATS CHANCE`;break;case"done":s=`Hello ${i}, thank you for choosing LATS CHANCE! Your ${t} is ready for collection. - LATS CHANCE`;break;default:s=`Hello ${i}, this is an update about your ${t} repair. Current status: ${r.status}. - LATS CHANCE`}const{error:m}=await J.from("customer_communications").insert({customer_id:$.id,type:"sms",message:s,status:"sent",phone_number:$.phone||$.whatsapp,sent_by:l==null?void 0:l.id,sent_at:new Date().toISOString()});if(m){console.error("Error saving SMS record:",m),L.error("Failed to save SMS record");return}L.success(`SMS sent to ${$.phone||"customer"}: "${s.substring(0,50)}..."`)}catch(s){console.error("Error sending SMS:",s),L.error("Failed to send SMS")}},je=async s=>{if(r)try{const t=await Promise.all(s.map(async c=>{const D={device_id:r.id,spare_part_id:c.spare_part_id,quantity_needed:c.quantity,cost_per_unit:c.cost_per_unit,notes:c.notes||`Requested for ${r.brand} ${r.model} repair`};return await ns(D)})),i=t.filter(c=>c.ok),m=t.filter(c=>!c.ok);i.length>0&&(L.success(`Successfully requested ${i.length} spare parts`),await me(r.id)),m.length>0&&L.error(`Failed to request ${m.length} spare parts`)}catch(t){console.error("Error requesting spare parts:",t),L.error("Failed to request spare parts")}},ye=s=>{Z(t=>t.includes(s)?t.filter(i=>i!==s):[...t,s])},ee=()=>{const s=E.filter(t=>t.status==="needed"||t.status==="ordered");O.length===s.length?Z([]):Z(s.map(t=>t.id))},Re=async()=>{if(O.length===0){L.error("Please select parts to reject");return}d(!0);try{const s=await gs(O,_);if(s.ok&&s.data){const t=E.map(i=>O.includes(i.id)?{...i,status:"needed",notes:_?`Rejected by customer care: ${_}`:i.notes}:i);z(t),L.success(s.message),Z([]),C(!1),G("")}else L.error(s.message||"Failed to reject parts")}catch(s){console.error("Error rejecting parts:",s),L.error("Failed to reject parts")}finally{d(!1)}};return a?r?r?Ie.createPortal(e.jsxs("div",{className:"fixed inset-0 flex items-center justify-center p-2 sm:p-4 overflow-y-auto",style:{zIndex:99999},children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm",onClick:s=>{s.preventDefault(),o()}}),e.jsxs("div",{className:"relative bg-white rounded-lg sm:rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] sm:max-h-[85vh] overflow-hidden flex flex-col my-2 sm:my-4",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-3 sm:p-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx("div",{className:"w-7 h-7 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 flex-shrink-0",children:e.jsx(Ae,{className:"w-3 h-3 sm:w-4 sm:h-4 text-white"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-bold text-gray-900 truncate",children:[r.brand," ",r.model]}),r.model&&r.model.includes("(")&&e.jsx("span",{className:"text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full",children:((ke=r.model.match(/\(([^)]+)\)/))==null?void 0:ke[1])||""})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsxs("p",{className:"text-xs text-gray-500 truncate",children:["Serial: ",r.serialNumber]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(He,{status:r.status})})]})]})]}),e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),o()},className:"p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors flex-shrink-0",children:e.jsx(ne,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"border-b border-gray-200 bg-white",children:e.jsxs("div",{className:"flex w-full",children:[e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),u("overview")},className:`flex-1 py-3 px-4 border-b-2 font-medium text-sm transition-colors ${I==="overview"?"border-blue-500 text-blue-600 bg-blue-50":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(ws,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Overview"}),e.jsx("span",{className:"sm:hidden",children:"Info"})]})}),e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),u("repair")},className:`flex-1 py-3 px-4 border-b-2 font-medium text-sm transition-colors ${I==="repair"?"border-blue-500 text-blue-600 bg-blue-50":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"Repair"})]})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:[e.jsxs("div",{className:"p-3 sm:p-4",children:[I==="overview"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-3 sm:gap-4 lg:gap-6",children:[e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-1.5 border-b border-gray-100",children:[e.jsx(Ae,{className:"w-4 h-4 text-blue-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Device Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Device Name"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:r.model||"N/A"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Serial Number"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 font-mono truncate",children:r.serialNumber||"N/A"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Status"}),e.jsx("div",{className:"mt-1",children:e.jsx(He,{status:r.status})})]}),r.assignedTo&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Assigned To"}),e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium border border-blue-200",children:[e.jsx(ds,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:P(r.assignedTo)})]})})]}),r.estimatedHours&&e.jsxs("div",{className:"space-y-1 sm:col-span-2",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Estimated Hours"}),e.jsx("div",{className:"mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-green-50 text-green-700 rounded-lg text-xs font-medium border border-green-200",children:[e.jsx(ss,{className:"w-3 h-3"}),r.estimatedHours,"h"]})})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-1.5 border-b border-gray-100",children:[e.jsx(Pe,{className:"w-4 h-4 text-red-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Issue & Problem"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Issue Description"}),e.jsx("div",{className:"bg-red-50 p-2 rounded-lg border border-red-100 max-h-24 overflow-y-auto",children:e.jsx("p",{className:"text-sm font-medium text-gray-900 break-words",children:r.issueDescription||"No issue description provided"})})]}),r.diagnosisRequired&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Diagnosis Required"}),e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:[e.jsx(Ss,{className:"w-3 h-3 mr-1"}),e.jsx("span",{className:"hidden sm:inline",children:"Yes - Diagnosis Required"}),e.jsx("span",{className:"sm:hidden",children:"Diagnosis Required"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-1.5 border-b border-gray-100",children:[e.jsx(Ze,{className:"w-4 h-4 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Dates & Timeline"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.createdAt).toLocaleDateString()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Last Updated"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.updatedAt).toLocaleDateString()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Expected Return"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.expectedReturnDate).toLocaleDateString()}),w&&e.jsxs("div",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${w==="Overdue"?"bg-red-100 text-red-700 border border-red-200":w.includes("overdue")?"bg-yellow-100 text-yellow-700 border border-yellow-200":"bg-orange-100 text-orange-700 border border-orange-200"}`,children:[e.jsx(ss,{className:"w-3 h-3"}),w]})]})]}),r.lastReturnDate&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Last Return"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.lastReturnDate).toLocaleDateString()})]})]})]}),r.deviceCondition&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(ts,{className:"w-5 h-5 text-orange-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Device Condition"})]}),e.jsx("div",{className:"space-y-2",children:typeof r.deviceCondition=="object"?e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(r.deviceCondition).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 capitalize",children:s.replace(/([A-Z])/g," $1").trim()}),e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:t?"Yes":"No"})]},s))}):e.jsx("p",{className:"text-sm font-medium text-gray-900 bg-gray-50 p-2 rounded",children:r.deviceCondition})})]}),r.repairChecklist&&r.status!=="done"&&r.status!=="failed"&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(K,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Repair Progress"})]}),e.jsx("div",{className:"bg-green-50 p-3 rounded-lg border border-green-100",children:(()=>{try{const s=typeof r.repairChecklist=="string"?JSON.parse(r.repairChecklist):r.repairChecklist;if(s.items){const t=s.items.filter(c=>c.completed).length,i=s.items.length,m=Math.round(t/i*100);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-green-600 font-semibold",children:[t,"/",i," Steps Complete"]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[m,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:"bg-green-500 h-3 rounded-full transition-all duration-300",style:{width:`${m}%`}})})]})}return e.jsx("p",{className:"text-sm text-gray-600",children:"Repair workflow available"})}catch{return e.jsx("p",{className:"text-sm text-gray-600",children:"Repair data available"})}})()})]}),(r.warrantyStart||r.warrantyEnd||r.warrantyStatus||r.repairCount)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(ts,{className:"w-5 h-5 text-indigo-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Warranty Information"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.warrantyStart&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Warranty Start"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.warrantyStart).toLocaleDateString()})]}),r.warrantyEnd&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Warranty End"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:new Date(r.warrantyEnd).toLocaleDateString()})]}),r.warrantyStatus&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Warranty Status"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 capitalize",children:r.warrantyStatus})]}),r.repairCount&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Repair Count"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:r.repairCount})]})]})]})]}),e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[r.status!=="done"&&r.status!=="failed"&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center",children:e.jsx(K,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Status Actions"})]}),e.jsx(Ke,{device:r,currentUser:l,onStatusUpdate:H,onPartsUpdate:s=>{}})]}),r.status!=="done"&&r.status!=="failed"&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-3 sm:p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2 border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 sm:w-5 sm:h-5 text-purple-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Requested Spare Parts"})]}),E.length>0&&e.jsxs("span",{className:"text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full",children:[E.length," parts"]})]}),B?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"animate-pulse bg-gray-200 h-4 rounded w-3/4"}),e.jsx("div",{className:"animate-pulse bg-gray-200 h-4 rounded w-1/2"})]}):E.length>0?e.jsxs("div",{className:"space-y-2",children:[((l==null?void 0:l.role)==="customer-care"||(l==null?void 0:l.role)==="admin")&&(()=>{const s=E.filter(t=>t.status==="needed"||t.status==="ordered");return s.length>0?e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:O.length===s.length&&s.length>0,onChange:ee,className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("span",{className:"text-sm font-medium text-blue-800",children:["Select All (",s.length," actionable)"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>C(!0),disabled:O.length===0||X,className:"flex items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white rounded-lg text-xs font-medium transition-colors",children:[e.jsx(Ye,{className:"w-3 h-3"}),"Decline (",O.length,")"]})})]}),X&&e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 text-sm text-blue-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-300 border-t-blue-600 rounded-full animate-spin"}),"Processing..."]})})]}):null})(),E.slice(0,3).map(s=>{var t;return e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[((l==null?void 0:l.role)==="customer-care"||(l==null?void 0:l.role)==="admin")&&(s.status==="needed"||s.status==="ordered")&&e.jsx("input",{type:"checkbox",checked:O.includes(s.id),onChange:()=>ye(s.id),className:"w-3 h-3 sm:w-4 sm:h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs sm:text-sm font-medium text-gray-900 truncate",children:((t=s.spare_part)==null?void 0:t.name)||"Unknown Part"}),e.jsxs("div",{className:"text-xs text-gray-600 truncate",children:["Qty: ",s.quantity_needed," â€¢ ",ie(s.cost_per_unit)," each"]})]})]}),e.jsx("div",{className:"text-right flex-shrink-0",children:e.jsxs("span",{className:`inline-flex items-center px-1 sm:px-2 py-1 rounded-full text-xs font-medium ${s.status==="needed"?"bg-yellow-100 text-yellow-800":s.status==="ordered"?"bg-blue-100 text-blue-800":s.status==="accepted"?"bg-purple-100 text-purple-800":s.status==="received"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:[e.jsx("span",{className:"hidden sm:inline",children:s.status}),e.jsx("span",{className:"sm:hidden",children:s.status.charAt(0).toUpperCase()})]})})]},s.id)}),E.length>3&&e.jsx("div",{className:"text-center",children:e.jsxs("button",{onClick:()=>u("repair"),className:"text-xs text-purple-600 hover:text-purple-700 font-medium",children:["View all ",E.length," parts â†’"]})})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(q,{className:"w-8 h-8 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No spare parts requested yet"})]}),(l==null?void 0:l.role)==="technician"&&r.assignedTo===l.id||(l==null?void 0:l.role)==="admin"?e.jsx("div",{className:"pt-3 border-t border-gray-200",children:e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),A(!0)},className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium text-sm",children:[e.jsx(q,{className:"w-4 h-4"}),"Request Parts"]})}):null]}),(r.unlockCode||r.deviceNotes)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-100",children:[e.jsx(ks,{className:"w-5 h-5 text-gray-600"}),e.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Additional Information"})]}),e.jsxs("div",{className:"space-y-3",children:[r.unlockCode&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Unlock Code"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 font-mono bg-gray-50 p-2 rounded",children:r.unlockCode})]}),r.deviceNotes&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs text-gray-500 uppercase tracking-wide",children:"Device Notes"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 bg-gray-50 p-3 rounded-lg",children:r.deviceNotes})]})]})]}),r.status==="done"&&e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg",children:e.jsx(se,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-green-800",children:"Repair Completed! ðŸŽ‰"}),e.jsx("p",{className:"text-green-600",children:"Device has been successfully repaired and returned to customer"})]})]}),e.jsxs("div",{className:"bg-white/60 backdrop-blur-sm rounded-lg p-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-green-800 font-semibold",children:"Status: Complete"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:"100%"}),e.jsx("div",{className:"text-xs text-green-600",children:"Complete"})]})]}),r.completedAt&&e.jsx("div",{className:"mt-3 pt-3 border-t border-green-200",children:e.jsxs("p",{className:"text-sm text-green-700",children:[e.jsx("strong",{children:"Completed on:"})," ",new Date(r.completedAt).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]})})]})]})]})]})}),I==="repair"&&r&&e.jsxs("div",{className:"space-y-6",children:[r.status==="done"||r.status==="failed"?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center",children:e.jsx(K,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Status Actions"})]}),e.jsx(Ke,{device:r,currentUser:l,onStatusUpdate:H,onPartsUpdate:s=>{}})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Requested Spare Parts"})]}),B?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx("div",{className:"animate-pulse bg-gray-200 h-16 rounded-lg"},s))}):E.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3",children:E.map(s=>{var t,i;return e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:((t=s.spare_part)==null?void 0:t.name)||"Unknown Part"}),e.jsxs("span",{className:"text-sm text-gray-500",children:["#",((i=s.spare_part)==null?void 0:i.part_number)||"N/A"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-gray-600",children:[e.jsxs("div",{children:["Quantity: ",s.quantity_needed]}),e.jsxs("div",{children:["Cost: ",ie(s.cost_per_unit)," each"]}),e.jsxs("div",{children:["Total: ",ie(s.quantity_needed*s.cost_per_unit)]}),e.jsxs("div",{children:["Used: ",s.quantity_used||0]})]}),s.notes&&e.jsxs("div",{className:"mt-2 text-sm text-gray-500 italic",children:["Note: ",s.notes]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${s.status==="needed"?"bg-yellow-100 text-yellow-800":s.status==="ordered"?"bg-blue-100 text-blue-800":s.status==="received"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:new Date(s.created_at).toLocaleDateString()})]})]},s.id)})}),(l==null?void 0:l.role)==="technician"&&r.assignedTo===l.id||(l==null?void 0:l.role)==="admin"?e.jsx("div",{className:"pt-2 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>A(!0),className:"flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium text-sm w-full justify-center",children:[e.jsx(q,{className:"w-4 h-4"}),"Request More Parts"]})}):null]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(q,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-2",children:"No spare parts requested"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Request spare parts needed for this repair"}),(l==null?void 0:l.role)==="technician"&&r.assignedTo===l.id||(l==null?void 0:l.role)==="admin"?e.jsxs("button",{onClick:()=>A(!0),className:"flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium text-sm mx-auto",children:[e.jsx(q,{className:"w-4 h-4"}),"Request Parts"]}):e.jsx("p",{className:"text-sm text-gray-500",children:"Contact your assigned technician or admin to request parts"})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center",children:e.jsx(K,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Status Actions"})]}),e.jsx(Ke,{device:r,currentUser:l,onStatusUpdate:H,onPartsUpdate:s=>{}})]})]}),r.status!=="done"&&r.status!=="failed"&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center",children:e.jsx(Cs,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Repair Progress"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Overall Progress"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:[V(),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300",style:{width:`${V()}%`}})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{className:"text-gray-600",children:"Diagnosis"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full"}),e.jsx("span",{className:"text-gray-600",children:"Repair"})]})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center",children:e.jsx(Qe,{className:"w-4 h-4 text-white"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Diagnostic Progress"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ge&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"}),e.jsx("span",{className:"text-xs text-blue-600",children:"Loading..."})]}),e.jsx("button",{onClick:()=>{r!=null&&r.id&&he(r.id)},disabled:ge,className:"p-1 text-gray-400 hover:text-blue-600 transition-colors disabled:opacity-50",title:"Refresh diagnostic data",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})]}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-100",children:ge?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"}),e.jsx("span",{className:"text-sm text-blue-600",children:"Fetching diagnostic data..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"animate-pulse bg-gray-200 h-4 rounded w-3/4"}),e.jsx("div",{className:"animate-pulse bg-gray-200 h-4 rounded w-1/2"})]})]}):R?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-600 font-semibold text-lg",children:["Total Tests: ",(($e=R.summary)==null?void 0:$e.total)||0]}),e.jsx("span",{className:"text-sm text-gray-600 px-3 py-1 bg-white rounded-full border",children:R.overallStatus==="all-passed"?"All Passed":R.overallStatus==="issues-found"?"Issues Found":R.overallStatus||"In Progress"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-center p-3 bg-green-100 rounded-lg border border-green-200",children:[e.jsx("div",{className:"text-green-600 font-bold text-xl",children:((Fe=R.summary)==null?void 0:Fe.passed)||0}),e.jsx("div",{className:"text-xs text-green-700 font-medium",children:"Passed"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-100 rounded-lg border border-red-200",children:[e.jsx("div",{className:"text-red-600 font-bold text-xl",children:((Te=R.summary)==null?void 0:Te.failed)||0}),e.jsx("div",{className:"text-xs text-red-700 font-medium",children:"Failed"})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-100 rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"text-yellow-600 font-bold text-xl",children:((Me=R.summary)==null?void 0:Me.pending)||0}),e.jsx("div",{className:"text-xs text-yellow-700 font-medium",children:"Pending"})]})]}),(l==null?void 0:l.role)==="admin"&&((Be=R.summary)==null?void 0:Be.failed)>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Pe,{className:"w-4 h-4 text-red-500"}),e.jsx("h4",{className:"text-sm font-semibold text-red-700",children:"Admin Review - Failed Diagnostics"})]}),e.jsxs("div",{className:"space-y-3",children:[(Ee=R.individualChecks)==null?void 0:Ee.filter(s=>s.result==="failed").map((s,t)=>e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium text-red-800",children:s.title||s.test_item||`Test ${t+1}`})]}),s.notes&&e.jsxs("p",{className:"text-xs text-red-700 mb-2",children:[e.jsx("strong",{children:"Failure Reason:"})," ",s.notes]}),s.remarks&&e.jsxs("p",{className:"text-xs text-red-600 mb-2",children:[e.jsx("strong",{children:"Technician Notes:"})," ",s.remarks]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-xs text-red-600 font-medium block mb-1",children:"Admin Comment:"}),e.jsx("textarea",{className:"w-full text-xs p-2 border border-red-200 rounded resize-none focus:ring-1 focus:ring-red-500 focus:border-red-500",rows:2,placeholder:"Add admin comment about this failure...",defaultValue:s.adminComment||"",onChange:i=>{}})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-xs text-red-500 font-medium",children:s.completed_at?new Date(s.completed_at).toLocaleDateString():"Unknown"})})]})},t)),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsx("button",{onClick:()=>{L.success("Admin comments saved successfully")},className:"px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded-lg transition-colors",children:"Save Admin Comments"})})]})]})]}):r.diagnosticChecklist?(()=>{try{const s=typeof r.diagnosticChecklist=="string"?JSON.parse(r.diagnosticChecklist):r.diagnosticChecklist;if(s.summary){const{total:t,passed:i,failed:m,pending:c}=s.summary;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-600 font-semibold text-lg",children:["Total Tests: ",t]}),e.jsx("span",{className:"text-sm text-gray-600 px-3 py-1 bg-white rounded-full border",children:s.overallStatus||"In Progress"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-center p-3 bg-green-100 rounded-lg border border-green-200",children:[e.jsx("div",{className:"text-green-600 font-bold text-xl",children:i}),e.jsx("div",{className:"text-xs text-green-700 font-medium",children:"Passed"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-100 rounded-lg border border-red-200",children:[e.jsx("div",{className:"text-red-600 font-bold text-xl",children:m}),e.jsx("div",{className:"text-xs text-red-700 font-medium",children:"Failed"})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-100 rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"text-yellow-600 font-bold text-xl",children:c}),e.jsx("div",{className:"text-xs text-yellow-700 font-medium",children:"Pending"})]})]})]})}return e.jsx("p",{className:"text-sm text-gray-600",children:"Diagnostic tests available"})}catch{return e.jsx("p",{className:"text-sm text-gray-600",children:"Diagnostic data available"})}})():e.jsxs("div",{className:"text-center py-6",children:[e.jsx(Qe,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"No diagnostic data available"}),e.jsx("p",{className:"text-xs text-gray-400 mb-4",children:"Check console logs for diagnostic data fetching details"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>{L('Use the "Start Diagnosis" button in the repair status section')},className:"block w-full text-sm text-gray-400 font-medium py-2 px-4 bg-gray-50 rounded-lg transition-colors cursor-not-allowed",disabled:!0,children:"Start Diagnostics â†’ (Use Repair Status Section)"}),e.jsx("button",{onClick:()=>{r!=null&&r.id&&he(r.id)},className:"block w-full text-sm text-gray-600 hover:text-gray-700 font-medium py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors",children:"Refresh Data"})]})]})})]})]}),!1]}),e.jsxs("div",{className:"flex items-center justify-between pt-3 border-t border-gray-100 bg-gray-50 px-4 py-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:r.status!=="assigned"&&e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),fe()},className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-xs",children:[e.jsx(as,{className:"w-3 h-3"}),"SMS"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),o()},className:"px-3 py-1.5 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors text-xs font-medium",children:"Close"}),(l==null?void 0:l.role)!=="technician"&&e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),pe()},className:"flex items-center gap-1.5 px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors font-medium text-xs",children:[e.jsx(_s,{className:"w-3 h-3"}),"Print"]}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),u("repair")},className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-xs",children:[e.jsx(K,{className:"w-3 h-3"}),"Repair"]})]})]})]}),$&&e.jsx(Hs,{isOpen:te,onClose:()=>oe(!1),customer:$,onEdit:s=>{}}),r&&e.jsx(ms,{device:r,isOpen:de,onClose:()=>A(!1),onPartsSelected:je}),S&&Ie.createPortal(e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm",style:{zIndex:1e5},children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Reject Spare Parts"}),e.jsx("button",{onClick:()=>{C(!1),G("")},className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsxs("strong",{children:[O.length," parts"]}),' will be rejected and returned to "needed" status.']})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rejection Reason (Optional)"}),e.jsx("textarea",{value:_,onChange:s=>G(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:3,placeholder:"Enter reason for rejection..."})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:()=>{C(!1),G("")},className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:Re,disabled:X,className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center justify-center gap-2",children:[X&&e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Reject Parts"]})]})]})]})})}),document.body),e.jsx("div",{className:"xl:hidden bg-white border-t border-gray-200 p-2 sm:p-3",children:e.jsxs("div",{className:"flex gap-1.5",children:[(Y||(l==null?void 0:l.role)==="admin"||(l==null?void 0:l.role)==="customer-care")&&e.jsx(e.Fragment,{children:e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),A(!0)},className:"flex-1 flex items-center justify-center gap-1.5 px-2 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium text-xs",children:[e.jsx(q,{className:"w-3 h-3"}),"Parts"]})}),(l==null?void 0:l.role)==="customer-care"&&$&&r.status!=="assigned"&&e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),fe()},className:"flex-1 flex items-center justify-center gap-1.5 px-2 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-xs",children:[e.jsx(as,{className:"w-3 h-3"}),"SMS"]})]})})]})]}),document.body):Ie.createPortal(e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm",style:{zIndex:99999},children:e.jsx("div",{className:"bg-white rounded-2xl p-8 shadow-2xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Pe,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Device Not Found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"The device you're looking for doesn't exist or has been deleted."}),e.jsx(F,{onClick:o,variant:"primary",children:"Close"})]})})}),document.body):Ie.createPortal(e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm",style:{zIndex:99999},children:e.jsx("div",{className:"bg-white rounded-2xl p-8 shadow-2xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Loading device details..."})]})})}),document.body):null},kt=()=>{var me,he;const a=cs(),{currentUser:o}=Je();hs();let p=[],l=!1,j=null,g=null;try{const n=os();p=(n==null?void 0:n.devices)||[],l=(n==null?void 0:n.loading)||!1,j=(n==null?void 0:n.deleteDevice)||null,g=(n==null?void 0:n.addDevice)||null}catch{}const[f,v]=x.useState(""),[r,I]=x.useState("all"),[u,k]=x.useState("all"),[b,w]=x.useState("all"),[T,te]=x.useState("all"),[oe,E]=x.useState("table"),[z,B]=x.useState("createdAt"),[Q,de]=x.useState("desc"),[A,O]=x.useState(!1),[Z,X]=x.useState([]),[d,S]=x.useState([]),[C,_]=x.useState(!1),[G,M]=x.useState(!1),[be,W]=x.useState(null),[N,R]=x.useState(null),[we,ge]=x.useState(!1);x.useEffect(()=>{(async()=>{try{const{data:P}=await J.from("users").select("id, full_name, email").eq("role","technician");X(P||[]);const{data:V}=await J.from("customers").select("id, name, phone").order("name");S(V||[])}catch(P){console.error("Error fetching filter data:",P)}})()},[]);const U=x.useMemo(()=>{const n=p.filter(P=>{var fe;const V=f===""||P.brand.toLowerCase().includes(f.toLowerCase())||P.model.toLowerCase().includes(f.toLowerCase())||((fe=P.serialNumber)==null?void 0:fe.toLowerCase().includes(f.toLowerCase()))||P.customerName.toLowerCase().includes(f.toLowerCase())||P.phoneNumber.includes(f),Y=r==="all"||P.status===r,$=u==="all"||P.assignedTo===u,H=b==="all"||P.customerId===b;let pe=!0;if(T!=="all"){const je=new Date(P.createdAt),ye=new Date,ee=new Date(ye.getFullYear(),ye.getMonth(),ye.getDate()),Re=new Date(ee.getTime()-7*24*60*60*1e3),ke=new Date(ee.getTime()-30*24*60*60*1e3);switch(T){case"today":pe=je>=ee;break;case"week":pe=je>=Re;break;case"month":pe=je>=ke;break}}return V&&Y&&$&&H&&pe});return n.sort((P,V)=>{let Y,$;switch(z){case"createdAt":Y=new Date(P.createdAt),$=new Date(V.createdAt);break;case"expectedReturnDate":Y=new Date(P.expectedReturnDate),$=new Date(V.expectedReturnDate);break;case"status":Y=P.status,$=V.status;break;case"customerName":Y=P.customerName,$=V.customerName;break;default:Y=new Date(P.createdAt),$=new Date(V.createdAt)}return Q==="asc"?Y>$?1:-1:Y<$?1:-1}),n},[p,f,r,u,b,T,z,Q]),ce=x.useMemo(()=>{const n=p.length,P=p.filter(H=>!["done","failed"].includes(H.status)).length,V=p.filter(H=>H.status==="done"||H.status==="failed"||!H.expectedReturnDate?!1:new Date(H.expectedReturnDate)<new Date).length,Y=p.filter(H=>H.status==="done").length,$=p.filter(H=>H.status==="failed").length;return{total:n,active:P,overdue:V,completed:Y,failed:$}},[p]),Se=()=>{v(""),I("all"),k("all"),w("all"),te("all")};return l?e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:e.jsxs("div",{className:"flex items-center justify-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#3498db]"}),e.jsx("span",{className:"ml-3 text-gray-600 font-medium",children:"Loading devices..."})]})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(fs,{to:"/dashboard"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Device Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage all devices in the repair system"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>ge(!0),className:"flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium bg-green-600 text-white hover:bg-green-700 transition-colors text-sm",title:"CBM Calculator",children:[e.jsx(Ds,{size:18}),"CBM"]}),e.jsxs("button",{onClick:()=>a("/devices/new"),className:"flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm",children:[e.jsx(ve,{size:18}),"Add Device"]}),(((me=o==null?void 0:o.permissions)==null?void 0:me.includes("all"))||((he=o==null?void 0:o.permissions)==null?void 0:he.includes("edit_settings"))||(o==null?void 0:o.role)==="admin")&&e.jsx("button",{onClick:()=>setShowTemplateManagerModal(!0),className:"flex items-center gap-2 px-3 py-2.5 rounded-lg font-medium bg-gray-600 text-white hover:bg-gray-700 transition-colors",children:e.jsx(As,{size:18})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-5 hover:bg-blue-100 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{className:"w-7 h-7 text-blue-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Devices"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce.total})]})]})}),e.jsx("div",{className:"bg-orange-50 rounded-lg p-5 hover:bg-orange-100 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-7 h-7 text-orange-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Active"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce.active})]})]})}),e.jsx("div",{className:"bg-red-50 rounded-lg p-5 hover:bg-red-100 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Pe,{className:"w-7 h-7 text-red-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Overdue"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce.overdue})]})]})}),e.jsx("div",{className:"bg-green-50 rounded-lg p-5 hover:bg-green-100 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"w-7 h-7 text-green-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce.completed})]})]})}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-5 hover:bg-gray-100 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{className:"w-7 h-7 text-gray-600 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Failed"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:ce.failed})]})]})})]}),e.jsx(Le,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(bs,{onSearch:v,placeholder:"Search devices by brand, model, serial number, or customer...",className:"w-full",suggestions:p.map(n=>`${n.brand} ${n.model}`),searchKey:"device_search"})}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(qe,{options:[{value:"all",label:"All Status"},{value:"assigned",label:"Assigned"},{value:"diagnosis-started",label:"Diagnosis Started"},{value:"awaiting-parts",label:"Awaiting Parts"},{value:"in-repair",label:"In Repair"},{value:"reassembled-testing",label:"Testing"},{value:"repair-complete",label:"Repair Complete"},{value:"returned-to-customer-care",label:"Returned to Care"},{value:"done",label:"Done"},{value:"failed",label:"Failed"}],value:r,onChange:n=>I(n),placeholder:"Filter by Status",className:"min-w-[150px]"}),e.jsxs("button",{onClick:()=>O(!A),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${A?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Ps,{size:16}),"More Filters",A?e.jsx(Rs,{size:16}):e.jsx($s,{size:16})]}),e.jsxs("div",{className:"flex rounded-lg bg-gray-100 p-1",children:[e.jsxs("button",{onClick:()=>E("table"),className:`flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${oe==="table"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:[e.jsx(Ts,{size:16}),"Table"]}),e.jsxs("button",{onClick:()=>E("grid"),className:`flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${oe==="grid"?"bg-white text-gray-900 shadow-sm":"text-gray-600"}`,children:[e.jsx(Ms,{size:16}),"Grid"]})]})]})]}),A&&e.jsxs("div",{className:"pt-4 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(qe,{options:[{value:"all",label:"All Technicians"},...Z.map(n=>({value:n.id,label:n.full_name}))],value:u,onChange:k,placeholder:"Filter by Technician",className:"w-full"}),e.jsx(qe,{options:[{value:"all",label:"All Customers"},...d.map(n=>({value:n.id,label:n.name}))],value:b,onChange:w,placeholder:"Filter by Customer",className:"w-full"}),e.jsx(qe,{options:[{value:"all",label:"All Time"},{value:"today",label:"Today"},{value:"week",label:"This Week"},{value:"month",label:"This Month"}],value:T,onChange:n=>te(n),placeholder:"Filter by Date",className:"w-full"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-600 font-medium",children:"Sort by:"}),e.jsxs("select",{value:z,onChange:n=>B(n.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#3498db] focus:border-transparent bg-white",children:[e.jsx("option",{value:"createdAt",children:"Date Created"}),e.jsx("option",{value:"expectedReturnDate",children:"Return Date"}),e.jsx("option",{value:"status",children:"Status"}),e.jsx("option",{value:"customerName",children:"Customer Name"})]}),e.jsx("button",{onClick:()=>de(Q==="asc"?"desc":"asc"),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:Q==="asc"?"Ascending":"Descending",children:Q==="asc"?e.jsx(Es,{size:18}):e.jsx(qs,{size:18})})]}),e.jsx("button",{onClick:Se,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Clear All Filters"})]})]})]})}),e.jsxs(Le,{className:"p-6",children:[oe==="table"?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Device"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Customer"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Issue"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Status"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Return Date"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Actions"})]})}),e.jsx("tbody",{children:U.map(n=>e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-[#3498db]/10 rounded-lg flex items-center justify-center",children:e.jsx(Ae,{className:"w-5 h-5 text-[#3498db]"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[n.brand," ",n.model]}),n.serialNumber&&e.jsxs("p",{className:"text-xs text-gray-500",children:["S/N: ",n.serialNumber]})]})]})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:n.customerName}),e.jsx("p",{className:"text-sm text-gray-500",children:n.phoneNumber})]})}),e.jsxs("td",{className:"py-3 px-4",children:[e.jsx("p",{className:"text-sm text-gray-700 truncate max-w-[250px]",title:n.issueDescription||n.issue,children:n.issueDescription||n.issue||"No description"}),n.estimatedHours&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Est: ",n.estimatedHours,"h"]})]}),e.jsx("td",{className:"py-3 px-4",children:e.jsx(He,{status:n.status})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ze,{size:14,className:"text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-700",children:n.expectedReturnDate?new Date(n.expectedReturnDate).toLocaleDateString():"Not set"})]})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex gap-1.5",children:[e.jsxs("button",{onClick:()=>{W(n.id),_(!0)},className:"flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",children:[e.jsx(rs,{size:13}),"View"]}),e.jsxs("button",{onClick:()=>{R(n),M(!0)},className:"flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium bg-gray-600 text-white hover:bg-gray-700 transition-colors",children:[e.jsx(Oe,{size:13}),"Edit"]})]})})]},n.id))})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:U.map(n=>e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 hover:border-gray-300 transition-colors",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex items-center gap-2.5 flex-1",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(Ae,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 text-sm truncate",children:[n.brand," ",n.model]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:n.serialNumber||"No S/N"})]})]})}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Customer"}),e.jsx("span",{className:"text-sm font-medium text-gray-900 truncate ml-2",title:n.customerName,children:n.customerName})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Status"}),e.jsx(He,{status:n.status})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Issue"}),e.jsx("span",{className:"text-xs text-gray-700 truncate ml-2 max-w-[150px]",title:n.issueDescription||n.issue,children:n.issueDescription||n.issue||"No description"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Return Date"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ze,{size:14,className:"text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-700",children:n.expectedReturnDate?new Date(n.expectedReturnDate).toLocaleDateString():"Not set"})]})]}),n.estimatedHours&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Estimated"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[n.estimatedHours,"h"]})]})]}),e.jsxs("div",{className:"flex gap-1.5 pt-3 border-t border-gray-100",children:[e.jsxs("button",{onClick:()=>{W(n.id),_(!0)},className:"flex-1 flex items-center justify-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",children:[e.jsx(rs,{size:13}),"View"]}),e.jsxs("button",{onClick:()=>{R(n),M(!0)},className:"flex-1 flex items-center justify-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium bg-gray-600 text-white hover:bg-gray-700 transition-colors",children:[e.jsx(Oe,{size:13}),"Edit"]})]})]},n.id))}),U.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ae,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No devices found"}),e.jsx("p",{className:"text-gray-500 mb-6",children:f||r!=="all"||u!=="all"||b!=="all"||T!=="all"?"Try adjusting your search or filters":"Get started by adding your first device"}),!f&&r==="all"&&u==="all"&&b==="all"&&T==="all"&&e.jsxs("button",{onClick:()=>a("/devices/new"),className:"flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors mx-auto",children:[e.jsx(ve,{size:18}),"Add Your First Device"]})]})]}),be&&e.jsx(Ys,{isOpen:C,onClose:()=>{_(!1),W(null)},deviceId:be}),N&&G&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4",style:{zIndex:99999},children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Device"}),e.jsx("button",{onClick:()=>{M(!1),R(null)},className:"text-gray-400 hover:text-gray-600",children:e.jsx(ne,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:async n=>{if(n.preventDefault(),!!(N!=null&&N.id))try{await ps(N.id,N),h.success("Device updated successfully"),M(!1),R(null),window.location.reload()}catch(P){console.error("Error updating device:",P),h.error("Failed to update device")}},children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Brand"}),e.jsx("input",{type:"text",value:(N==null?void 0:N.brand)||"",onChange:n=>N&&R({...N,brand:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Model"}),e.jsx("input",{type:"text",value:(N==null?void 0:N.model)||"",onChange:n=>N&&R({...N,model:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Serial Number"}),e.jsx("input",{type:"text",value:(N==null?void 0:N.serialNumber)||"",onChange:n=>N&&R({...N,serialNumber:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Issue Description"}),e.jsx("textarea",{value:(N==null?void 0:N.issueDescription)||"",onChange:n=>N&&R({...N,issueDescription:n.target.value}),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{value:(N==null?void 0:N.status)||"",onChange:n=>N&&R({...N,status:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"assigned",children:"Assigned"}),e.jsx("option",{value:"diagnosis-started",children:"Diagnosis Started"}),e.jsx("option",{value:"awaiting-parts",children:"Awaiting Parts"}),e.jsx("option",{value:"parts-arrived",children:"Parts Arrived"}),e.jsx("option",{value:"in-repair",children:"In Repair"}),e.jsx("option",{value:"reassembled-testing",children:"Reassembled Testing"}),e.jsx("option",{value:"repair-complete",children:"Repair Complete"}),e.jsx("option",{value:"returned-to-customer-care",children:"Returned to Customer Care"}),e.jsx("option",{value:"done",children:"Done"}),e.jsx("option",{value:"failed",children:"Failed"})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>{M(!1),R(null)},className:"flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors duration-200",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200",children:"Save Changes"})]})]})]})})}),e.jsx(Bs,{isOpen:we,onClose:()=>ge(!1)})]})};export{kt as DevicesPage,kt as default};
