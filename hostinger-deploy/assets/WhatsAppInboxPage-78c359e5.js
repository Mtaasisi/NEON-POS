import{_ as Jr}from"./supabase-cf010ec4.js";import{s as H,j as e,V as Rl,u as Il,W as Ul}from"./index-61458a34.js";import{r as m,R as Pt,b as Ta}from"./vendor-36d2c7c1.js";import Xe from"./whatsappService-09f99080.js";import{a9 as tr,X as Te,q as Ll,T as Fl,n as c,ai as xe,y as Le,k as gr,o as st,Z as ra,bG as rt,v as nt,e as _s,ag as Ds,b as Kt,R as rs,b2 as Ut,U as At,P as bt,N as Lt,D as ds,Y as ys,bI as ta,d as aa,bJ as Yr,aP as tt,l as yt,a3 as at,bK as Jt,bL as Yt,S as sa,bM as Bl,a8 as Ca,f as Da,ay as Ol,bN as cr,at as Cs,bC as Xr,bO as ar,A as Zr,a0 as Gl,$ as Ea,p as It,bh as dr,c as Xt,av as Rt,a5 as fs,bP as gn,G as ur,af as un,r as Ls,bQ as Zt,bj as zl,aG as en,s as rr,ba as Wl,ae as Hl,bR as ql,b0 as nr,bz as lr,bS as Vl,a_ as sn,bT as Ql,bU as or,w as tn,C as Kl,bV as Jl,bW as Yl}from"./ui-28e30067.js";import{g as Xl,a as ir}from"./inventorySettingsApi-fd100cf3.js";import{u as Zl}from"./useBodyScrollLock-341c8b9f.js";import{M as eo}from"./Modal-a5e4c1ba.js";import{a as so}from"./routing-eb8c310c.js";class Ft{static validateFile(t){return t?this.ALLOWED_TYPES.includes(t.type)?t.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size: ${this.MAX_FILE_SIZE/(1024*1024)}MB`}:{valid:!0}:{valid:!1,error:"Invalid file type. Allowed: images, videos, audio, PDF, Excel files"}:{valid:!1,error:"No file provided"}}static generateSafeFileName(t,n){var T;const l=Date.now(),i=Math.random().toString(36).substring(2,9),d=((T=t.split(".").pop())==null?void 0:T.toLowerCase())||"jpg",p=t.split(".")[0].replace(/[^a-zA-Z0-9]/g,"-").toLowerCase().substring(0,30);return`${n}/${p}-${l}-${i}.${d}`}static async fileToBase64(t){return new Promise((n,l)=>{const i=new FileReader;i.onload=()=>n(i.result),i.onerror=d=>l(d),i.readAsDataURL(t)})}static async uploadMedia(t,n="General"){var i;const l=performance.now();console.log("ğŸ” [DEBUG] localMediaStorage.uploadMedia() called");try{console.log("ğŸ“¤ [DEBUG] Upload parameters:",{name:t.name,type:t.type,size:t.size,sizeInMB:(t.size/1024/1024).toFixed(2),folder:n,timestamp:new Date().toISOString()}),console.log("âœ… [DEBUG] Validating file...");const d=this.validateFile(t);if(console.log("âœ… [DEBUG] Validation result:",d),!d.valid)return console.error("âŒ [DEBUG] File validation failed:",d.error),{success:!1,error:d.error};console.log("ğŸ“ [DEBUG] Generating safe filename...");const p=this.generateSafeFileName(t.name,n),T=`${this.MEDIA_BASE_PATH}/${p}`;console.log("ğŸ“ [DEBUG] Generated paths:",{relativePath:p,fullPath:T,storageKey:`${this.STORAGE_KEY_PREFIX}${p}`}),console.log("ğŸ”„ [DEBUG] Converting file to base64...");const v=performance.now(),L=await this.fileToBase64(t),G=(performance.now()-v).toFixed(2);console.log("ğŸ”„ [DEBUG] Base64 conversion completed in",G,"ms"),console.log("ğŸ”„ [DEBUG] Base64 data length:",L.length,"characters");const $=`${this.STORAGE_KEY_PREFIX}${p}`,E={base64:L,fileName:t.name,mimeType:t.type,size:t.size,uploadedAt:new Date().toISOString(),folder:n};console.log("ğŸ’¾ [DEBUG] Storing in localStorage..."),console.log("ğŸ’¾ [DEBUG] Storage key:",$),console.log("ğŸ’¾ [DEBUG] Media data size:",JSON.stringify(E).length,"characters");const k=performance.now();localStorage.setItem($,JSON.stringify(E));const U=(performance.now()-k).toFixed(2);console.log("ğŸ’¾ [DEBUG] localStorage.setItem() completed in",U,"ms"),console.log("âœ… [DEBUG] Media stored locally with key:",$);let ae=0;for(let P=0;P<localStorage.length;P++){const z=localStorage.key(P);z&&(ae+=((i=localStorage.getItem(z))==null?void 0:i.length)||0)}console.log("ğŸ“Š [DEBUG] Total localStorage size:",(ae/1024/1024).toFixed(2),"MB");const K=(performance.now()-l).toFixed(2);return console.log("âœ… [DEBUG] uploadMedia() completed successfully in",K,"ms"),{success:!0,relativePath:p,fullUrl:L}}catch(d){const p=(performance.now()-l).toFixed(2);return console.error("âŒ [DEBUG] Local upload error after",p,"ms:",d),console.error("âŒ [DEBUG] Error details:",{message:d.message,stack:d.stack,name:d.name}),{success:!1,error:d.message||"Upload failed"}}}static getMedia(t,n=!1){var l;console.log("ğŸ” [DEBUG] localMediaStorage.getMedia() called",{relativePath:t,silent:n});try{const i=`${this.STORAGE_KEY_PREFIX}${t}`;console.log("ğŸ”‘ [DEBUG] Storage key:",i);const d=performance.now(),p=localStorage.getItem(i),T=(performance.now()-d).toFixed(2);if(console.log("ğŸ“¥ [DEBUG] localStorage.getItem() completed in",T,"ms"),!p)return!n&&!this.missingMediaCache.has(t)?(this.missingMediaCache.add(t),console.warn("âš ï¸ [DEBUG] Media not found in local storage:",t),console.warn("âš ï¸ [DEBUG] Storage key:",i)):n||console.log("â„¹ï¸ [DEBUG] Media not found (already warned):",t),null;this.missingMediaCache.delete(t),console.log("âœ… [DEBUG] Media found in localStorage, parsing...");const v=performance.now(),L=JSON.parse(p),G=(performance.now()-v).toFixed(2);return console.log("âœ… [DEBUG] JSON.parse() completed in",G,"ms"),console.log("ğŸ“¦ [DEBUG] Media data:",{fileName:L.fileName,mimeType:L.mimeType,size:L.size,folder:L.folder,base64Length:((l=L.base64)==null?void 0:l.length)||0}),L.base64}catch(i){return n||(console.error("âŒ [DEBUG] Error retrieving media:",i),console.error("âŒ [DEBUG] Error details:",{message:i.message,stack:i.stack,relativePath:t})),null}}static getMediaUrl(t,n=!1){console.log("ğŸ” [DEBUG] localMediaStorage.getMediaUrl() called",{relativePath:t,silent:n});const l=this.getMedia(t,n);if(l)return console.log("âœ… [DEBUG] Found in localStorage, returning base64 URL"),l;const i=`${this.MEDIA_BASE_PATH}/${t}`;return console.log("âš ï¸ [DEBUG] Not found in localStorage, returning fallback URL:",i),i}static deleteMedia(t){console.log("ğŸ” [DEBUG] localMediaStorage.deleteMedia() called",{relativePath:t});try{const n=`${this.STORAGE_KEY_PREFIX}${t}`;console.log("ğŸ”‘ [DEBUG] Storage key to delete:",n);const l=localStorage.getItem(n)!==null;if(console.log("ğŸ” [DEBUG] Item exists in localStorage:",l),l){const i=performance.now();localStorage.removeItem(n);const d=(performance.now()-i).toFixed(2);console.log("ğŸ—‘ï¸ [DEBUG] localStorage.removeItem() completed in",d,"ms"),console.log("âœ… [DEBUG] Media deleted from local storage:",t)}else console.log("âš ï¸ [DEBUG] Item not found in localStorage, deletion skipped");return{success:!0}}catch(n){return console.error("âŒ [DEBUG] Delete error:",n),console.error("âŒ [DEBUG] Error details:",{message:n.message,stack:n.stack,relativePath:t}),{success:!1,error:n.message||"Delete failed"}}}static getAllMediaKeys(){const t=[];for(let n=0;n<localStorage.length;n++){const l=localStorage.key(n);l!=null&&l.startsWith(this.STORAGE_KEY_PREFIX)&&t.push(l.replace(this.STORAGE_KEY_PREFIX,""))}return t}static getMediaType(t){return t.startsWith("image/")?"image":t.startsWith("video/")?"video":t.startsWith("audio/")?"audio":"document"}static exportAllMedia(){const t={};return this.getAllMediaKeys().forEach(l=>{const i=`${this.STORAGE_KEY_PREFIX}${l}`,d=localStorage.getItem(i);d&&(t[l]=JSON.parse(d))}),t}static importMedia(t){let n=0;return Object.entries(t).forEach(([l,i])=>{try{const d=`${this.STORAGE_KEY_PREFIX}${l}`;localStorage.setItem(d,JSON.stringify(i)),n++}catch(d){console.error("Failed to import media:",l,d)}}),console.log(`âœ… Imported ${n} media files`),n}static clearAllMedia(){const t=this.getAllMediaKeys();return t.forEach(n=>{const l=`${this.STORAGE_KEY_PREFIX}${n}`;localStorage.removeItem(l)}),console.log(`ğŸ—‘ï¸ Cleared ${t.length} media files from local storage`),t.length}}Ft.MAX_FILE_SIZE=16*1024*1024;Ft.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif","video/mp4","video/3gpp","video/webm","audio/mpeg","audio/ogg","application/pdf","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];Ft.MEDIA_BASE_PATH="/media/whatsapp";Ft.STORAGE_KEY_PREFIX="local-media:";Ft.missingMediaCache=new Set;const bs=Ft,xn={async create(o){const{data:t,error:n}=await H.from("whatsapp_campaigns").insert(o).select().single();if(n)throw n;return t},async getAll(o=50){const{data:t,error:n}=await H.from("whatsapp_campaigns").select("*").order("created_at",{ascending:!1}).limit(o);if(n)throw n;return t||[]},async getById(o){const{data:t,error:n}=await H.from("whatsapp_campaigns").select("*").eq("id",o).single();return n?null:t},async update(o,t){const{error:n}=await H.from("whatsapp_campaigns").update({...t,updated_at:new Date().toISOString()}).eq("id",o);if(n)throw n},async delete(o){const{error:t}=await H.from("whatsapp_campaigns").delete().eq("id",o);if(t)throw t},async clone(o,t){const n=await this.getById(o);if(!n)throw new Error("Campaign not found");const l={...n,id:void 0,name:t,status:"draft",sent_count:0,success_count:0,failed_count:0,replied_count:0,started_at:void 0,completed_at:void 0,duration_seconds:void 0,created_at:void 0,updated_at:void 0};return this.create(l)},async cancel(o){const t=await this.getById(o);if(!t)throw new Error("Campaign not found");if(["pending","sending","draft","active"].includes(t.status))await this.update(o,{status:"stopped",completed_at:new Date().toISOString()});else throw new Error(`Cannot cancel campaign with status: ${t.status}`)}},to={async getCampaignMetrics(o){const{data:t,error:n}=await H.from("whatsapp_campaign_metrics").select("*").eq("campaign_id",o).single();return n?null:t},async getDashboard(){const{data:o}=await H.from("whatsapp_campaigns").select("*").eq("status","completed"),t={total_campaigns:(o==null?void 0:o.length)||0,total_sent:(o==null?void 0:o.reduce((l,i)=>l+i.sent_count,0))||0,total_success:(o==null?void 0:o.reduce((l,i)=>l+i.success_count,0))||0,total_failed:(o==null?void 0:o.reduce((l,i)=>l+i.failed_count,0))||0,avg_response_rate:0,total_revenue:0};if(t.total_sent>0){const l=(o==null?void 0:o.reduce((i,d)=>i+d.replied_count,0))||0;t.avg_response_rate=l/t.total_sent*100}const{data:n}=await H.from("whatsapp_campaigns").select("*").order("created_at",{ascending:!1}).limit(10);return{overview:t,recent_campaigns:n||[],performance_over_time:[],top_performing_messages:[],engagement_by_time:[]}},async exportCampaign(o){var d;const t=await xn.getById(o);if(!t)throw new Error("Campaign not found");const n=["Name","Phone","Status","Sent At"],l=((d=t.recipients_data)==null?void 0:d.map(p=>[p.name,p.phone,p.status,p.sent_at||""]))||[],i=[n.join(","),...l.map(p=>p.join(","))].join(`
`);return new Blob([i],{type:"text/csv"})}},ao={async add(o,t,n){const{error:l}=await H.from("whatsapp_blacklist").insert({phone:o,reason:t,notes:n});if(l)throw l},async remove(o){const{error:t}=await H.from("whatsapp_blacklist").delete().eq("phone",o);if(t)throw t},async isBlacklisted(o){const{data:t}=await H.from("whatsapp_blacklist").select("id").eq("phone",o).single();return!!t},async getAll(){const{data:o,error:t}=await H.from("whatsapp_blacklist").select("*").order("created_at",{ascending:!1});if(t)throw t;return o||[]},async importFromCSV(o,t){let n=0,l=0;for(const i of o)try{await this.isBlacklisted(i)?l++:(await this.add(i,t),n++)}catch{l++}return{added:n,skipped:l}}},ro={async upload(o,t="General"){var z;const n=performance.now();console.log("ğŸ” [DEBUG] mediaLibrary.upload() called"),console.log("ğŸ“¤ [DEBUG] Upload parameters:",{fileName:o.name,fileType:o.type,fileSize:o.size,sizeInMB:(o.size/1024/1024).toFixed(2),folder:t,timestamp:new Date().toISOString()}),console.log("ğŸ” [DEBUG] Checking for duplicate files in database...");const l=performance.now(),{data:i,error:d}=await H.from("whatsapp_media_library").select("*").eq("file_name",o.name).eq("folder",t).eq("file_size",o.size),p=(performance.now()-l).toFixed(2);if(console.log("ğŸ” [DEBUG] Duplicate check completed in",p,"ms"),console.log("ğŸ” [DEBUG] Duplicate check result:",{found:(i==null?void 0:i.length)||0,error:(d==null?void 0:d.message)||null}),d)console.warn("âš ï¸ [DEBUG] Could not check for duplicates:",d),console.warn("âš ï¸ [DEBUG] Error details:",{message:d.message,code:d.code,details:d.details});else if(i&&i.length>0){console.log(`âœ… [DEBUG] Found ${i.length} existing file(s) with same name, size, and folder`),console.log("ğŸ“„ [DEBUG] Existing file details:",{id:i[0].id,name:i[0].name,file_type:i[0].file_type,file_url:i[0].file_url,folder:i[0].folder,created_at:i[0].created_at}),console.log("ğŸ”— [DEBUG] Getting URL from localStorage for existing file...");const se=bs.getMediaUrl(i[0].file_url);console.log("ğŸ”— [DEBUG] Retrieved URL:",(se==null?void 0:se.substring(0,50))+"...");const Q=(performance.now()-n).toFixed(2);return console.log("âœ… [DEBUG] upload() completed (existing file) in",Q,"ms"),{...i[0],file_url:se}}console.log("ğŸ“ [DEBUG] No duplicates found, proceeding with upload to local storage...");const T=performance.now(),v=await bs.uploadMedia(o,t),L=(performance.now()-T).toFixed(2);if(console.log("ğŸ“ [DEBUG] Local storage upload completed in",L,"ms"),console.log("ğŸ“ [DEBUG] Upload result:",{success:v.success,relativePath:v.relativePath,fullUrl_preview:((z=v.fullUrl)==null?void 0:z.substring(0,50))+"...",error:v.error||null}),!v.success||!v.relativePath)throw console.error("âŒ [DEBUG] Local storage upload failed:",{success:v.success,error:v.error,relativePath:v.relativePath}),new Error(v.error||"Failed to upload file to local storage");console.log("âœ… [DEBUG] File uploaded to local storage successfully"),console.log("ğŸ”— [DEBUG] Relative path:",v.relativePath);const G=v.relativePath;console.log("ğŸ’¾ [DEBUG] Saving to media library database...");const $=performance.now(),E=o.type.startsWith("image")?"image":o.type.startsWith("video")?"video":o.type.startsWith("audio")?"audio":"document";console.log("ğŸ’¾ [DEBUG] Database insert data:",{name:o.name,file_name:o.name,file_url:G,file_type:E,file_size:o.size,mime_type:o.type,folder:t});const{data:k,error:U}=await H.from("whatsapp_media_library").insert({name:o.name,file_name:o.name,file_url:G,file_type:E,file_size:o.size,mime_type:o.type,folder:t}).select().single(),ae=(performance.now()-$).toFixed(2);if(console.log("ğŸ’¾ [DEBUG] Database insert completed in",ae,"ms"),U)throw console.error("âŒ [DEBUG] Database insert error:",U),console.error("âŒ [DEBUG] Error details:",{message:U.message,code:U.code,details:U.details,hint:U.hint}),U;console.log("âœ… [DEBUG] Media saved to library database successfully"),console.log("ğŸ“¦ [DEBUG] Saved media item:",{id:k.id,name:k.name,file_type:k.file_type,file_url:k.file_url,folder:k.folder,created_at:k.created_at});const K=v.fullUrl||bs.getMediaUrl(G);console.log("ğŸ”— [DEBUG] Final URL for display:",(K==null?void 0:K.substring(0,50))+"...");const P=(performance.now()-n).toFixed(2);return console.log("âœ… [DEBUG] upload() completed successfully in",P,"ms"),{...k,file_url:K}},async getAll(o){const t=performance.now();console.log("ğŸ” [DEBUG] mediaLibrary.getAll() called"),console.log("ğŸ“¥ [DEBUG] Parameters:",{folder:o||"all folders"});let n=H.from("whatsapp_media_library").select("*").order("created_at",{ascending:!1});o&&(console.log("ğŸ“ [DEBUG] Filtering by folder:",o),n=n.eq("folder",o));const l=performance.now(),{data:i,error:d}=await n,p=(performance.now()-l).toFixed(2);if(console.log("ğŸ“Š [DEBUG] Database query completed in",p,"ms"),console.log("ğŸ“Š [DEBUG] Query result:",{itemCount:(i==null?void 0:i.length)||0,error:(d==null?void 0:d.message)||null}),d)throw console.error("âŒ [DEBUG] Database query error:",d),console.error("âŒ [DEBUG] Error details:",{message:d.message,code:d.code,details:d.details}),d;console.log("ğŸ”„ [DEBUG] Converting relative paths to full URLs...");const T=performance.now(),v=(i||[]).map(($,E)=>{var ae;const k=$.file_url.startsWith("data:")||$.file_url.startsWith("http://")||$.file_url.startsWith("https://")||$.file_url.startsWith("/media/"),U=k?$.file_url:bs.getMediaUrl($.file_url,!0);return E<3&&console.log("ğŸ”— [DEBUG] URL conversion for item",E+1,":",{original:((ae=$.file_url)==null?void 0:ae.substring(0,50))+"...",converted:(U==null?void 0:U.substring(0,50))+"...",isFullUrl:k,file_type:$.file_type}),{...$,file_url:U,tags:$.tags||[]}}),L=(performance.now()-T).toFixed(2);console.log("ğŸ”„ [DEBUG] URL conversion completed in",L,"ms");const G=(performance.now()-t).toFixed(2);return console.log("âœ… [DEBUG] getAll() completed in",G,"ms, returning",v.length,"items"),v},async getFolders(){console.log("ğŸ” [DEBUG] mediaLibrary.getFolders() called");const o=performance.now(),{data:t,error:n}=await H.from("whatsapp_media_library").select("folder").order("folder"),l=(performance.now()-o).toFixed(2);if(console.log("ğŸ“Š [DEBUG] Folders query completed in",l,"ms"),n)throw console.error("âŒ [DEBUG] Folders query error:",n),n;const i=[...new Set((t==null?void 0:t.map(d=>d.folder))||[])];return console.log("ğŸ“ [DEBUG] Found folders:",i),console.log("âœ… [DEBUG] getFolders() completed, returning",i.length,"folders"),i},async delete(o){const t=performance.now();console.log("ğŸ” [DEBUG] mediaLibrary.delete() called"),console.log("ğŸ—‘ï¸ [DEBUG] Delete parameters:",{id:o}),console.log("ğŸ“¥ [DEBUG] Fetching media item from database...");const{data:n,error:l}=await H.from("whatsapp_media_library").select("file_url, file_type, name").eq("id",o).single();if(l)throw console.error("âŒ [DEBUG] Error fetching media item:",l),l;if(console.log("ğŸ“„ [DEBUG] Media item to delete:",{id:o,name:n==null?void 0:n.name,file_url:n==null?void 0:n.file_url,file_type:n==null?void 0:n.file_type}),n&&!n.file_url.startsWith("http")&&!n.file_url.startsWith("data:")){console.log("ğŸ—‘ï¸ [DEBUG] Deleting from local storage...");const p=bs.deleteMedia(n.file_url);console.log("ğŸ—‘ï¸ [DEBUG] Local storage delete result:",p)}else console.log("â„¹ï¸ [DEBUG] Skipping local storage delete (external URL or data URL)");console.log("ğŸ—‘ï¸ [DEBUG] Deleting from database...");const{error:i}=await H.from("whatsapp_media_library").delete().eq("id",o);if(i)throw console.error("âŒ [DEBUG] Database delete error:",i),console.error("âŒ [DEBUG] Error details:",{message:i.message,code:i.code,details:i.details}),i;const d=(performance.now()-t).toFixed(2);console.log("âœ… [DEBUG] delete() completed successfully in",d,"ms")},async incrementUsage(o){const{error:t}=await H.rpc("increment_media_usage",{media_id:o});t&&console.warn("Could not increment usage:",t)}},no={async getAll(){const{data:o,error:t}=await H.from("whatsapp_reply_templates").select("*").order("category");if(t)throw t;return o||[]},async create(o){const{data:t,error:n}=await H.from("whatsapp_reply_templates").insert(o).select().single();if(n)throw n;return t},async update(o,t){const{error:n}=await H.from("whatsapp_reply_templates").update(t).eq("id",o);if(n)throw n},async delete(o){const{error:t}=await H.from("whatsapp_reply_templates").delete().eq("id",o);if(t)throw t},async findByKeywords(o){const{data:t}=await H.from("whatsapp_reply_templates").select("*").eq("auto_send",!0);if(!t)return null;const n=o.toLowerCase();for(const l of t)if(l.keywords.some(i=>n.includes(i.toLowerCase())))return l;return null}},lo={async check(){var o,t;try{const n=Date.now(),l=await fetch("https://wasenderapi.com/api/status",{headers:{Authorization:"Bearer YOUR_API_KEY"}}),i=Date.now()-n,d=await l.json(),p={id:crypto.randomUUID(),status:l.ok?"healthy":"degraded",response_time_ms:i,rate_limit_remaining:((o=d.rateLimit)==null?void 0:o.remaining)||0,rate_limit_total:((t=d.rateLimit)==null?void 0:t.total)||0,credits_remaining:d.credits||0,warnings:d.warnings||[],errors:d.errors||[],checked_at:new Date().toISOString()};return await H.from("whatsapp_api_health").insert(p),p}catch(n){return{id:crypto.randomUUID(),status:"down",response_time_ms:0,rate_limit_remaining:0,rate_limit_total:0,credits_remaining:0,warnings:[],errors:[String(n)],checked_at:new Date().toISOString()}}},async getRecent(o=10){const{data:t,error:n}=await H.from("whatsapp_api_health").select("*").order("checked_at",{ascending:!1}).limit(o);if(n)throw n;return t||[]}},oo={async add(o){const{error:t}=await H.from("whatsapp_failed_queue").insert({...o,next_retry_at:new Date(Date.now()+3e5).toISOString()});if(t)throw t},async getReadyForRetry(){const{data:o,error:t}=await H.from("whatsapp_failed_queue").select("*").eq("status","pending").lte("next_retry_at",new Date().toISOString()).lt("retry_count",H.rpc("get_max_retries"));if(t)throw t;return o||[]},async updateRetryStatus(o,t){const{error:n}=await H.from("whatsapp_failed_queue").update({status:t?"success":"pending",retry_count:H.rpc("increment_retry_count",{msg_id:o}),last_retry_at:new Date().toISOString(),next_retry_at:t?null:new Date(Date.now()+9e5).toISOString(),resolved_at:t?new Date().toISOString():null}).eq("id",o);if(n)throw n}},Ae={campaign:xn,analytics:to,blacklist:ao,mediaLibrary:ro,replyTemplates:no,apiHealth:lo,failedQueue:oo};function io({onApply:o,onClear:t,currentFilter:n}){var v,L,G,$;const[l,i]=m.useState(!1),[d,p]=m.useState(n||{}),T=()=>{var k,U;if(!(d.minTotalSpent!==void 0||d.maxTotalSpent!==void 0||d.minOrders!==void 0||d.maxOrders!==void 0||d.daysSinceLastOrder!==void 0||d.lastPurchaseAmount!==void 0||d.hasEmail!==void 0||d.hasAddress!==void 0||((k=d.customerTags)==null?void 0:k.length)||((U=d.excludeTags)==null?void 0:U.length)||d.createdAfter||d.createdBefore||d.city||d.region)){c.error("Please set at least one filter criteria");return}o(d),i(!1)};return l?e.jsxs("div",{className:"mb-6 p-5 bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center",children:e.jsx(tr,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900",children:"Advanced Segmentation"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Filter recipients by customer data"})]})]}),e.jsx("button",{onClick:()=>i(!1),className:"w-8 h-8 flex items-center justify-center bg-white hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Te,{className:"w-4 h-4 text-gray-600"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-purple-100",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(Ll,{className:"w-4 h-4 text-purple-600"}),"Purchase History"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Min Total Spent"}),e.jsx("input",{type:"number",value:d.minTotalSpent||"",onChange:E=>p({...d,minTotalSpent:E.target.value?parseFloat(E.target.value):void 0}),placeholder:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Max Total Spent"}),e.jsx("input",{type:"number",value:d.maxTotalSpent||"",onChange:E=>p({...d,maxTotalSpent:E.target.value?parseFloat(E.target.value):void 0}),placeholder:"No limit",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Min Orders"}),e.jsx("input",{type:"number",value:d.minOrders||"",onChange:E=>p({...d,minOrders:E.target.value?parseInt(E.target.value):void 0}),placeholder:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Days Since Last Order (Min)"}),e.jsx("input",{type:"number",value:((v=d.daysSinceLastOrder)==null?void 0:v.min)||"",onChange:E=>p({...d,daysSinceLastOrder:{...d.daysSinceLastOrder,min:E.target.value?parseInt(E.target.value):void 0}}),placeholder:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Days Since Last Order (Max)"}),e.jsx("input",{type:"number",value:((L=d.daysSinceLastOrder)==null?void 0:L.max)||"",onChange:E=>p({...d,daysSinceLastOrder:{...d.daysSinceLastOrder,max:E.target.value?parseInt(E.target.value):void 0}}),placeholder:"No limit",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-purple-100",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(Fl,{className:"w-4 h-4 text-purple-600"}),"Customer Attributes"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:d.hasEmail||!1,onChange:E=>p({...d,hasEmail:E.target.checked||void 0}),className:"w-4 h-4 text-purple-600 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Has Email Address"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:d.hasAddress||!1,onChange:E=>p({...d,hasAddress:E.target.checked||void 0}),className:"w-4 h-4 text-purple-600 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Has Address"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Include Tags (comma-separated)"}),e.jsx("input",{type:"text",value:((G=d.customerTags)==null?void 0:G.join(", "))||"",onChange:E=>p({...d,customerTags:E.target.value?E.target.value.split(",").map(k=>k.trim()).filter(Boolean):void 0}),placeholder:"VIP, Premium, etc.",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Exclude Tags (comma-separated)"}),e.jsx("input",{type:"text",value:(($=d.excludeTags)==null?void 0:$.join(", "))||"",onChange:E=>p({...d,excludeTags:E.target.value?E.target.value.split(",").map(k=>k.trim()).filter(Boolean):void 0}),placeholder:"Do Not Contact, etc.",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"City"}),e.jsx("input",{type:"text",value:d.city||"",onChange:E=>p({...d,city:E.target.value||void 0}),placeholder:"Dar es Salaam",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600 mb-1 block",children:"Region"}),e.jsx("input",{type:"text",value:d.region||"",onChange:E=>p({...d,region:E.target.value||void 0}),placeholder:"Dar es Salaam",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]})]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-3",children:[e.jsxs("button",{onClick:T,className:"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold flex items-center justify-center gap-2",children:[e.jsx(tr,{className:"w-4 h-4"}),"Apply Filter"]}),n&&e.jsx("button",{onClick:()=>{p({}),t(),i(!1)},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Clear Filter"}),e.jsx("button",{onClick:()=>i(!1),className:"px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"Cancel"})]})]}):e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>i(!0),className:"w-full px-4 py-3 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl hover:border-purple-300 transition-all flex items-center justify-between group",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 transition-colors",children:e.jsx(tr,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:"Advanced Segmentation"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Filter by purchase history, tags, location..."})]})]}),n&&e.jsx("span",{className:"px-2 py-1 bg-purple-600 text-white text-xs rounded-full font-medium",children:"Active"})]})})}function co(o){const{filteredConversations:t,selectedRecipients:n,csvRecipients:l,blacklist:i,savedLists:d,sentPhones:p,campaignName:T,recipientSearch:v,activeQuickFilter:L,csvFile:G,csvUploading:$,showCsvTooltip:E,showImportSection:k,bulkSending:U,randomDelay:ae,minDelay:K,maxDelay:P,usePresence:z,setCampaignName:se,setRecipientSearch:Q,setSelectedRecipients:Y,applyQuickFilter:me,clearQuickFilter:X,handleCsvUpload:ge,clearCsvImport:Ce,setShowCsvPreviewModal:Me,setShowCsvTooltip:He,setShowSaveListModal:J,setShowCustomerImport:$e,setShowImportSection:De,loadRecipientList:_,loadAllCustomers:W,getInitials:he,getEngagementScore:Ge,isPhoneBlacklisted:j,isValidPhone:R,segmentFilter:V,applySegmentation:Z,clearSegmentation:te}=o,oe=t.filter(S=>{var ee,ie;if(p.includes(S.phone))return!1;if(!v)return!0;const N=v.toLowerCase();return((ee=S.customer_name)==null?void 0:ee.toLowerCase().includes(N))||((ie=S.phone)==null?void 0:ie.toLowerCase().includes(N))}),x={total:n.length,valid:n.filter(R).length,invalid:n.filter(S=>!R(S)).length,blacklisted:n.filter(j).length,duplicates:n.length-new Set(n).size,withNames:n.filter(S=>{const N=t.find(ie=>ie.phone===S),ee=l.find(ie=>ie.phone===S);return(N==null?void 0:N.customer_name)&&N.customer_name!=="Unknown"||(ee==null?void 0:ee.name)&&ee.name!=="Unknown"}).length,fromConversations:n.filter(S=>t.find(N=>N.phone===S)).length,fromCsv:n.filter(S=>l.find(N=>N.phone===S)).length},w=[];x.blacklisted>0&&w.push(`${x.blacklisted} blacklisted numbers will be auto-excluded`),x.invalid>0&&w.push(`${x.invalid} invalid phone numbers detected`),x.duplicates>0&&w.push(`${x.duplicates} duplicate phone numbers`);const C=n.filter(S=>{const N=t.find(Se=>Se.phone===S);if(!N)return!1;const ee=N.messages[N.messages.length-1];return!ee||ee.type!=="sent"?!1:(Date.now()-new Date(ee.timestamp).getTime())/(1e3*60*60)<6}).length;C>0&&w.push(`${C} contacts messaged in last 6h`);const b=(()=>{if(n.length===0)return"0s";const S=ae?(K+P)/2:K,N=z?1.5:0,ee=n.length*(S+N+1),ie=Math.floor(ee/60),Se=Math.floor(ee%60);return ie>0?`${ie}m ${Se}s`:`${Se}s`})();return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Campaign Name (Optional)"}),e.jsx("input",{type:"text",value:T,onChange:S=>se(S.target.value),placeholder:"e.g., Black Friday 2024",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900",title:"Name your campaign for tracking and analytics"})]}),p.length>0&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(xe,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:"font-semibold text-green-900 mb-1",children:[p.length," Contact",p.length!==1?"s":""," Already Sent"]}),e.jsx("p",{className:"text-sm text-green-700",children:"These contacts have been removed from the list below to prevent duplicate messages. Only pending recipients are shown."})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Quick Filters"}),e.jsxs("div",{className:"grid grid-cols-3 md:grid-cols-6 gap-2",children:[e.jsxs("button",{onClick:()=>me("inactive"),title:"Inactive (30+ days)",className:`p-3 rounded-lg border transition-all text-center ${L==="inactive"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(Le,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"Inactive"})]}),e.jsxs("button",{onClick:()=>me("new"),title:"New (Last 7 days)",className:`p-3 rounded-lg border transition-all text-center ${L==="new"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(gr,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"New"})]}),e.jsxs("button",{onClick:()=>me("unreplied"),title:"Unreplied messages",className:`p-3 rounded-lg border transition-all text-center ${L==="unreplied"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(st,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"Pending"})]}),e.jsxs("button",{onClick:()=>me("high-engagement"),title:"High engagement",className:`p-3 rounded-lg border transition-all text-center ${L==="high-engagement"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(ra,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"Engaged"})]}),e.jsxs("button",{onClick:()=>me("never-messaged"),title:"Never messaged",className:`p-3 rounded-lg border transition-all text-center ${L==="never-messaged"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(rt,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"Unsent"})]}),e.jsxs("button",{onClick:()=>me("all"),title:"Select all",className:`p-3 rounded-lg border transition-all text-center ${L==="all"?"bg-blue-600 text-white border-blue-600":"bg-white border-gray-300 hover:border-blue-400"}`,children:[e.jsx(xe,{className:"w-5 h-5 mx-auto mb-1"}),e.jsx("p",{className:"text-xs font-medium",children:"All"})]})]}),L&&e.jsxs("button",{onClick:X,className:"mt-2 text-sm text-gray-600 hover:text-gray-900 font-medium flex items-center gap-1",children:[e.jsx(Te,{className:"w-4 h-4"}),"Clear Filter"]})]}),e.jsx(io,{onApply:Z,onClear:te,currentFilter:V}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"search",value:v,onChange:S=>Q(S.target.value),placeholder:"Search by name or phone...",className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"})]})}),n.length>0&&e.jsx("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl",children:e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:x.total}),e.jsx("p",{className:"text-xs text-gray-600",children:"Selected"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:x.valid}),e.jsx("p",{className:"text-xs text-gray-600",children:"Valid"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:x.withNames}),e.jsx("p",{className:"text-xs text-gray-600",children:"Named"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:b}),e.jsx("p",{className:"text-xs text-gray-600",children:"Time"})]})]})}),w.length>0&&e.jsx("div",{className:"mb-6 p-3 bg-yellow-50 border border-yellow-200 rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(_s,{className:"w-4 h-4 text-yellow-700 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("ul",{className:"space-y-1 text-sm text-yellow-800",children:w.map((S,N)=>e.jsx("li",{children:S},N))})})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("button",{onClick:()=>De(!k),className:"w-full flex items-center justify-between p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all border border-gray-200",title:"Import recipients from CSV or database",children:[e.jsxs("span",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(Ds,{className:"w-4 h-4"}),"Import Recipients"]}),e.jsx(Kt,{className:`w-5 h-5 text-gray-600 transition-transform ${k?"rotate-180":""}`})]}),k&&e.jsxs("div",{className:"mt-2 p-4 bg-white border border-gray-200 rounded-xl space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"CSV File"}),e.jsxs("label",{className:"cursor-pointer block",children:[e.jsx("input",{type:"file",accept:".csv",onChange:ge,disabled:$||U,className:"hidden"}),e.jsx("div",{className:"px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all flex items-center justify-center gap-2 font-medium",children:$?e.jsxs(e.Fragment,{children:[e.jsx(rs,{className:"w-5 h-5 animate-spin"}),"Processing..."]}):G?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-5 h-5"}),G.name]}):e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-5 h-5"}),"Choose CSV"]})})]})]}),e.jsxs("button",{onClick:()=>{$e(!0),W()},className:"w-full px-4 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all font-medium flex items-center justify-center gap-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),"Customer Database"]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:[p.length>0?"Pending Recipients":"Recipients"," (",n.length," selected)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Y(oe.filter(S=>!j(S.phone)).map(S=>S.phone)),className:"text-sm px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium",children:"Select All"}),e.jsx("button",{onClick:()=>Y([]),className:"text-sm px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Clear"})]})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto border-2 border-gray-300 rounded-xl p-3 bg-gray-50",children:oe.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(nt,{className:"w-10 h-10 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No recipients match your search"})]}):e.jsx("div",{className:"space-y-2",children:oe.map(S=>{const N=j(S.phone);Ge(S);const ee=!R(S.phone);return e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all border ${N?"bg-red-50 border-red-200 opacity-60 cursor-not-allowed":ee?"bg-orange-50 border-orange-200":"bg-white border-gray-200 hover:bg-blue-50 hover:border-blue-300"}`,children:[e.jsx("input",{type:"checkbox",checked:n.includes(S.phone),onChange:ie=>{if(N){c.error("Cannot select blacklisted number");return}ie.target.checked?Y(Se=>[...Se,S.phone]):Y(Se=>Se.filter(h=>h!==S.phone))},disabled:U||N,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm ${N?"bg-gray-400":"bg-blue-600"}`,children:S.customer_name?he(S.customer_name):e.jsx(At,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5",children:[e.jsx("p",{className:"font-semibold text-gray-900 text-sm truncate",children:S.customer_name}),N&&e.jsx("span",{className:"px-2 py-0.5 bg-red-500 text-white text-xs rounded font-medium flex-shrink-0",children:"Blocked"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx(bt,{className:"w-3 h-3"}),e.jsx("span",{className:"font-mono",children:S.phone})]})]})]},S.phone)})})})]})]})}function mo({isOpen:o,onClose:t,onUpdate:n}){const[l,i]=m.useState([]),[d,p]=m.useState(!0),[T,v]=m.useState(""),[L,G]=m.useState(!1),[$,E]=m.useState(""),[k,U]=m.useState(""),[ae,K]=m.useState("");m.useEffect(()=>{o&&P()},[o]);async function P(){try{p(!0);const X=await Ae.blacklist.getAll();i(X)}catch(X){console.error("Error loading blacklist:",X),c.error("Failed to load blacklist")}finally{p(!1)}}async function z(){if(!$.trim()){c.error("Please enter a phone number");return}if($.replace(/[^\d+]/g,"").length<10){c.error("Invalid phone number format");return}try{await Ae.blacklist.add($,k||"Manual addition",ae),c.success("Number added to blacklist"),E(""),U(""),K(""),G(!1),P(),n&&n()}catch{c.error("Failed to add to blacklist")}}async function se(X){if(confirm(`Remove ${X} from blacklist?`))try{await Ae.blacklist.remove(X),c.success("Number removed from blacklist"),P(),n&&n()}catch{c.error("Failed to remove from blacklist")}}async function Q(X){var Ce;const ge=(Ce=X.target.files)==null?void 0:Ce[0];if(ge)try{const J=(await ge.text()).split(`
`).filter(De=>De.trim()).slice(1).map(De=>{const[_]=De.split(",");return _.trim()}).filter(De=>De),$e=await Ae.blacklist.importFromCSV(J,"CSV import");c.success(`Imported ${$e.added} numbers (${$e.skipped} skipped)`),P(),n&&n()}catch{c.error("Failed to import CSV")}}function Y(){const X=["phone,reason,opted_out_at,notes",...l.map(He=>`${He.phone},${He.reason||""},${He.opted_out_at},${He.notes||""}`)].join(`
`),ge=new Blob([X],{type:"text/csv"}),Ce=URL.createObjectURL(ge),Me=document.createElement("a");Me.href=Ce,Me.download=`whatsapp-blacklist-${new Date().toISOString().split("T")[0]}.csv`,Me.click(),c.success("Blacklist exported!")}const me=l.filter(X=>{var Ce;if(!T)return!0;const ge=T.toLowerCase();return X.phone.toLowerCase().includes(ge)||((Ce=X.reason)==null?void 0:Ce.toLowerCase().includes(ge))});return o?e.jsxs("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-red-600 to-rose-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(rt,{className:"w-7 h-7 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Blacklist Management"}),e.jsx("p",{className:"text-red-100",children:"Manage opt-outs and blocked numbers"})]})]}),e.jsx("button",{onClick:t,className:"w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-6 h-6 text-white"})})]})}),e.jsx("div",{className:"p-4 bg-gradient-to-r from-red-50 to-rose-50 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Blacklisted"}),e.jsx("p",{className:"text-3xl font-bold text-red-600",children:l.length})]}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("p",{children:["These numbers will ",e.jsx("strong",{children:"NOT"})," receive any bulk messages"]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>G(!0),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold flex items-center gap-2",children:[e.jsx(Lt,{className:"w-4 h-4"}),"Add Number"]}),e.jsxs("button",{onClick:Y,disabled:l.length===0,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2 disabled:opacity-50",children:[e.jsx(ds,{className:"w-4 h-4"}),"Export CSV"]}),e.jsxs("label",{className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"file",accept:".csv",onChange:Q,className:"hidden"}),e.jsx(Ds,{className:"w-4 h-4"}),"Import CSV"]})]})]})}),e.jsx("div",{className:"p-4 bg-white border-b border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"search",value:T,onChange:X=>v(X.target.value),placeholder:"Search blacklist by phone or reason...",className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:d?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"})}):me.length===0?e.jsxs("div",{className:"text-center py-20",children:[e.jsx(rt,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:T?"No matches found":"No blacklisted numbers yet"}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Numbers added here will be excluded from all bulk campaigns"})]}):e.jsx("div",{className:"space-y-3",children:me.map(X=>e.jsxs("div",{className:"flex items-center gap-4 p-4 bg-white border-2 border-red-200 rounded-xl hover:shadow-md transition-all",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(rt,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-bold text-gray-900 text-base",children:X.phone}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Reason: ",X.reason||"Not specified"]}),X.notes&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:X.notes}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Added: ",new Date(X.created_at).toLocaleDateString()]})]}),e.jsxs("button",{onClick:()=>se(X.phone),className:"px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold flex items-center gap-2",children:[e.jsx(ys,{className:"w-4 h-4"}),"Remove"]})]},X.id))})}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(_s,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsx("p",{className:"font-semibold mb-1",children:"ğŸ›¡ï¸ GDPR Compliance:"}),e.jsx("p",{children:'Blacklisted numbers are automatically excluded from all bulk campaigns. System also auto-detects and blocks users who reply with "STOP", "UNSUBSCRIBE", or similar commands.'})]})]})})]}),L&&e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-red-600 to-rose-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Add to Blacklist"}),e.jsx("button",{onClick:()=>{G(!1),E(""),U(""),K("")},className:"w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Phone Number *"}),e.jsx("input",{type:"tel",value:$,onChange:X=>E(X.target.value),placeholder:"+255712345678",className:"w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Reason"}),e.jsxs("select",{value:k,onChange:X=>U(X.target.value),className:"w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200",children:[e.jsx("option",{value:"",children:"Select reason..."}),e.jsx("option",{value:"stop_command",children:"Customer requested (STOP)"}),e.jsx("option",{value:"manual",children:"Manual addition"}),e.jsx("option",{value:"spam_report",children:"Spam report"}),e.jsx("option",{value:"invalid_number",children:"Invalid number"}),e.jsx("option",{value:"complaint",children:"Customer complaint"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Notes (Optional)"}),e.jsx("textarea",{value:ae,onChange:X=>K(X.target.value),placeholder:"Additional notes...",rows:3,className:"w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 resize-none"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{G(!1),E(""),U(""),K("")},className:"flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-semibold",children:"Cancel"}),e.jsxs("button",{onClick:z,disabled:!$.trim(),className:"flex-1 px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-semibold disabled:opacity-50 flex items-center justify-center gap-2",children:[e.jsx(Lt,{className:"w-5 h-5"}),"Add to Blacklist"]})]})]})]})})]}):null}async function go(){const o={success:!1,migrated:0,failed:0,skipped:0,errors:[]};try{console.log("ğŸ”„ Starting media migration to local storage...");const{data:t,error:n}=await H.from("whatsapp_media_library").select("*").order("created_at",{ascending:!1});if(n)return o.errors.push(`Failed to fetch media items: ${n.message}`),o;if(!t||t.length===0)return console.log("âœ… No media items to migrate"),o.success=!0,o;console.log(`ğŸ“Š Found ${t.length} media items to migrate`);for(const l of t)try{if(console.log(`
ğŸ“„ Processing: ${l.file_name}`),!l.file_url.startsWith("http://")&&!l.file_url.startsWith("https://")&&!l.file_url.startsWith("data:")){console.log("â­ï¸  Already migrated, skipping"),o.skipped++;continue}console.log(`ğŸ“¥ Downloading from: ${l.file_url.substring(0,100)}...`);let i;if(l.file_url.startsWith("data:"))console.log("ğŸ”„ Converting data URL to blob..."),i=await(await fetch(l.file_url)).blob();else{const v=await fetch(l.file_url,{mode:"cors",credentials:"omit"});if(!v.ok)throw new Error(`HTTP ${v.status}: ${v.statusText}`);i=await v.blob()}console.log(`âœ… Downloaded ${i.size} bytes`);const d=new File([i],l.file_name,{type:l.mime_type||"application/octet-stream"});console.log("ğŸ’¾ Saving to local storage...");const p=await bs.uploadMedia(d,l.folder);if(!p.success||!p.relativePath)throw new Error(p.error||"Upload failed");console.log(`âœ… Saved as: ${p.relativePath}`);const{error:T}=await H.from("whatsapp_media_library").update({file_url:p.relativePath}).eq("id",l.id);if(T)throw new Error(`Database update failed: ${T.message}`);console.log("âœ… Database updated"),o.migrated++}catch(i){console.error(`âŒ Failed to migrate ${l.file_name}:`,i.message),o.failed++,o.errors.push(`${l.file_name}: ${i.message}`)}return o.success=!0,console.log(`
âœ… Migration complete!`),console.log(`ğŸ“Š Results:
      - Migrated: ${o.migrated}
      - Skipped: ${o.skipped}
      - Failed: ${o.failed}
    `),o}catch(t){return console.error("âŒ Migration error:",t),o.errors.push(`Migration failed: ${t.message}`),o}}async function uo(){try{const{data:o}=await H.from("whatsapp_media_library").select("file_url");if(!o)return{total:0,migrated:0,pending:0,needsMigration:!1};const t=o.length,n=o.filter(i=>i.file_url.startsWith("http://")||i.file_url.startsWith("https://")).length,l=t-n;return{total:t,migrated:l,pending:n,needsMigration:n>0}}catch{return{total:0,migrated:0,pending:0,needsMigration:!1}}}function xo({onClose:o}){const[t,n]=m.useState(!1),[l,i]=m.useState(!1),[d,p]=m.useState(null);Pt.useEffect(()=>{T()},[]);async function T(){const $=await uo();p($)}async function v(){try{const $=bs.exportAllMedia(),E=JSON.stringify($,null,2),k=new Blob([E],{type:"application/json"}),U=URL.createObjectURL(k),ae=document.createElement("a");ae.href=U,ae.download=`whatsapp-media-backup-${Date.now()}.json`,ae.click(),URL.revokeObjectURL(U),c.success("Media backup downloaded!")}catch($){console.error("Export error:",$),c.error("Failed to export media")}}async function L($){var k;const E=(k=$.target.files)==null?void 0:k[0];if(E)try{n(!0);const U=await E.text(),ae=JSON.parse(U),K=bs.importMedia(ae);c.success(`Successfully imported ${K} media files!`),$.target.value=""}catch(U){console.error("Import error:",U),c.error("Failed to import media. Invalid file format.")}finally{n(!1)}}async function G(){if(confirm("Migrate all external media URLs to local storage? This may take a few minutes."))try{i(!0),c.loading("Migrating media...",{id:"migration"});const $=await go();c.dismiss("migration"),$.success?(c.success(`Migration complete! Migrated: ${$.migrated}, Skipped: ${$.skipped}, Failed: ${$.failed}`),T()):c.error("Migration failed. Check console for details."),$.errors.length>0&&console.error("Migration errors:",$.errors)}catch($){console.error("Migration error:",$),c.error("Migration failed")}finally{i(!1)}}return e.jsxs("div",{className:"p-6 bg-white rounded-xl",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:"Media Backup & Restore"}),d&&d.needsMigration&&e.jsx("div",{className:"mb-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_s,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-yellow-900 mb-1",children:"Migration Needed"}),e.jsxs("p",{className:"text-sm text-yellow-800 mb-3",children:["You have ",d.pending," media files with external URLs that should be migrated to local storage."]}),e.jsx("button",{onClick:G,disabled:l,className:"px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:opacity-50 flex items-center gap-2",children:l?e.jsxs(e.Fragment,{children:[e.jsx(ta,{className:"w-4 h-4 animate-spin"}),"Migrating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-4 h-4"}),"Migrate to Local Storage"]})})]})]})}),d&&!d.needsMigration&&d.total>0&&e.jsx("div",{className:"mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(aa,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-green-900 mb-1",children:"All Media Local"}),e.jsxs("p",{className:"text-sm text-green-800",children:["All ",d.total," media files are stored locally. No migration needed."]})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-2 flex items-center gap-2",children:[e.jsx(ds,{className:"w-5 h-5 text-blue-600"}),"Backup Media"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Export all media files to a JSON backup file. Use this to transfer media to another device or as a safety backup."}),e.jsxs("button",{onClick:v,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center gap-2",children:[e.jsx(ds,{className:"w-5 h-5"}),"Download Backup"]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-2 flex items-center gap-2",children:[e.jsx(Ds,{className:"w-5 h-5 text-purple-600"}),"Restore Media"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Import media from a previously exported backup file. This will add the media to your local storage."}),e.jsxs("label",{className:"px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold flex items-center gap-2 cursor-pointer inline-flex",children:[e.jsx("input",{type:"file",accept:".json",onChange:L,disabled:t,className:"hidden"}),t?e.jsxs(e.Fragment,{children:[e.jsx(ta,{className:"w-5 h-5 animate-spin"}),"Importing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ds,{className:"w-5 h-5"}),"Select Backup File"]})]})]}),e.jsx("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg",children:e.jsxs("p",{className:"text-xs text-gray-600",children:["ğŸ’¡ ",e.jsx("strong",{children:"Tip:"})," Media is stored in your browser's localStorage. Regular backups are recommended to prevent data loss when clearing browser cache or switching devices."]})}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:o,className:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Close"})})]})}function ho({isOpen:o,onClose:t,onSelect:n}){const[l,i]=m.useState([]),[d,p]=m.useState([]),[T,v]=m.useState("All"),[L,G]=m.useState(!0),[$,E]=m.useState(""),[k,U]=m.useState(null),[ae,K]=m.useState(!1),[P,z]=m.useState(new Set),[se,Q]=m.useState(new Set),[Y,me]=m.useState(!1),[X,ge]=m.useState(new Set);m.useEffect(()=>{o&&(Ce(),Me(),z(new Set),Q(new Set),ge(new Set))},[o]),m.useEffect(()=>{if(l.length>0){const j=l.filter(R=>R.file_type==="image").map(R=>R.id);Q(new Set(j))}},[l]);async function Ce(){console.log("ğŸ” [DEBUG] loadMedia() called");const j=performance.now();try{G(!0),console.log("ğŸ“¥ [DEBUG] Calling whatsappAdvancedService.mediaLibrary.getAll()...");const R=await Ae.mediaLibrary.getAll(),V=(performance.now()-j).toFixed(2);console.log(`âœ… [DEBUG] Loaded ${R.length} media items from library in ${V}ms`),console.log("ğŸ“Š [DEBUG] Media items breakdown:",{total:R.length,images:R.filter(Z=>Z.file_type==="image").length,videos:R.filter(Z=>Z.file_type==="video").length,documents:R.filter(Z=>Z.file_type==="document").length,audio:R.filter(Z=>Z.file_type==="audio").length}),console.log("ğŸ“‹ [DEBUG] First 3 items:",R.slice(0,3).map(Z=>{var te;return{id:Z.id,name:Z.name,file_type:Z.file_type,file_url_preview:((te=Z.file_url)==null?void 0:te.substring(0,50))+"...",folder:Z.folder}})),i(R),console.log("âœ… [DEBUG] Media state updated successfully")}catch(R){const V=(performance.now()-j).toFixed(2);console.error("âŒ [DEBUG] Error loading media after",V,"ms:",R),console.error("âŒ [DEBUG] Error details:",{message:R.message,stack:R.stack,name:R.name}),c.error("Failed to load media library")}finally{G(!1),console.log("ğŸ [DEBUG] loadMedia() completed, loading state set to false")}}async function Me(){console.log("ğŸ” [DEBUG] loadFolders() called");try{console.log("ğŸ“¥ [DEBUG] Calling whatsappAdvancedService.mediaLibrary.getFolders()...");const j=await Ae.mediaLibrary.getFolders();console.log("ğŸ“ [DEBUG] Received folders from service:",j);const R=["All",...j];console.log("ğŸ“ [DEBUG] Setting folders state:",R),p(R),console.log("âœ… [DEBUG] Folders loaded successfully")}catch(j){console.error("âŒ [DEBUG] Error loading folders:",j),console.error("âŒ [DEBUG] Error details:",{message:j.message,stack:j.stack,name:j.name})}}async function He(j){var te,oe,x;console.log("ğŸ” [DEBUG] handleUpload() called");const R=performance.now(),V=(te=j.target.files)==null?void 0:te[0];if(console.log("ğŸ“„ [DEBUG] File input event:",{filesCount:((oe=j.target.files)==null?void 0:oe.length)||0,selectedFile:V?{name:V.name,type:V.type,size:V.size,lastModified:new Date(V.lastModified).toISOString()}:null}),!V){console.warn("âš ï¸ [DEBUG] No file selected, returning early");return}const Z=16*1024*1024;if(console.log("ğŸ“ [DEBUG] Validating file size:",{fileSize:V.size,maxSize:Z,sizeInMB:(V.size/1024/1024).toFixed(2),isValid:V.size<=Z}),V.size>Z){console.error("âŒ [DEBUG] File too large:",{fileSize:V.size,maxSize:Z,exceedsBy:((V.size-Z)/1024/1024).toFixed(2)+"MB"}),c.error("File too large. Maximum 16MB for WhatsApp.");return}try{K(!0);const w=T==="All"?"General":T;console.log("ğŸ“¤ [DEBUG] Starting media upload to library:",{fileName:V.name,fileType:V.type,fileSize:V.size,sizeInMB:(V.size/1024/1024).toFixed(2),folder:w,selectedFolder:T,timestamp:new Date().toISOString()}),console.log("ğŸ“¥ [DEBUG] Calling whatsappAdvancedService.mediaLibrary.upload()...");const C=performance.now(),b=await Ae.mediaLibrary.upload(V,w),S=(performance.now()-C).toFixed(2);console.log("âœ… [DEBUG] Upload completed in",S,"ms"),console.log("ğŸ“¦ [DEBUG] Upload result:",{id:b.id,name:b.name,file_type:b.file_type,file_url_preview:((x=b.file_url)==null?void 0:x.substring(0,100))+"...",folder:b.folder,file_size:b.file_size}),c.success("Media uploaded successfully!"),console.log("âœ… [DEBUG] Media uploaded to library successfully"),console.log("ğŸ”„ [DEBUG] Reloading media list..."),await Ce();const N=(performance.now()-R).toFixed(2);console.log("âœ… [DEBUG] handleUpload() completed successfully in",N,"ms")}catch(w){const C=(performance.now()-R).toFixed(2);console.error("âŒ [DEBUG] Media library upload error after",C,"ms:",w),console.error("âŒ [DEBUG] Error details:",{message:w.message,stack:w.stack,name:w.name,fileName:V.name,fileSize:V.size,fileType:V.type});const b=w.message||"Upload failed";c.error(`Upload failed: ${b}`)}finally{K(!1),j.target.value="",console.log("ğŸ [DEBUG] handleUpload() cleanup completed, uploading state set to false")}}async function J(j){var Z;console.log("ğŸ” [DEBUG] handleDelete() called for mediaId:",j);const R=l.find(te=>te.id===j);if(console.log("ğŸ“„ [DEBUG] Media item to delete:",R?{id:R.id,name:R.name,file_type:R.file_type,file_url:((Z=R.file_url)==null?void 0:Z.substring(0,50))+"...",folder:R.folder}:"NOT FOUND"),!confirm("Delete this media file?")){console.log("ğŸš« [DEBUG] User cancelled deletion");return}const V=performance.now();try{console.log("ğŸ—‘ï¸ [DEBUG] Calling whatsappAdvancedService.mediaLibrary.delete()..."),await Ae.mediaLibrary.delete(j);const te=(performance.now()-V).toFixed(2);console.log("âœ… [DEBUG] Delete completed in",te,"ms"),c.success("Media deleted"),console.log("ğŸ”„ [DEBUG] Reloading media list after deletion..."),await Ce(),console.log("âœ… [DEBUG] handleDelete() completed successfully")}catch(te){const oe=(performance.now()-V).toFixed(2);console.error("âŒ [DEBUG] Delete error after",oe,"ms:",te),console.error("âŒ [DEBUG] Error details:",{message:te.message,stack:te.stack,name:te.name,mediaId:j}),c.error("Delete failed")}}function $e(j){n&&(n(j),t(),c.success("Media selected!"))}const De=j=>{var V;console.log("ğŸ–¼ï¸ [DEBUG] handleImageLoad() called for itemId:",j);const R=l.find(Z=>Z.id===j);console.log("ğŸ–¼ï¸ [DEBUG] Image loaded successfully:",{itemId:j,name:R==null?void 0:R.name,file_url_preview:((V=R==null?void 0:R.file_url)==null?void 0:V.substring(0,50))+"..."}),Q(Z=>{const te=new Set(Z);return te.delete(j),console.log("ğŸ–¼ï¸ [DEBUG] Updated imageLoading state, remaining:",Array.from(te)),te})},_=(j,R)=>{var Z;console.log("âŒ [DEBUG] handleImageError() called for itemId:",j),console.log("âŒ [DEBUG] Error details:",{itemId:j,url:(R==null?void 0:R.substring(0,100))+"...",alreadyRetried:X.has(j),retriedCount:X.size});const V=l.find(te=>te.id===j);if(console.log("ğŸ“„ [DEBUG] Media item with error:",V?{id:V.id,name:V.name,file_type:V.file_type,file_url:((Z=V.file_url)==null?void 0:Z.substring(0,50))+"...",folder:V.folder}:"NOT FOUND"),X.has(j)){console.log("âš ï¸ [DEBUG] Already retried this item, marking as error"),z(te=>new Set(te).add(j)),Q(te=>{const oe=new Set(te);return oe.delete(j),oe});return}if(R.startsWith("/media/whatsapp/")){const te=R.replace(/^\/media\/whatsapp\//,""),oe=bs.getMediaUrl(te,!0);if(!oe||oe===R||!oe.startsWith("data:")){ge(x=>new Set(x).add(j)),z(x=>new Set(x).add(j)),Q(x=>{const w=new Set(x);return w.delete(j),w});return}ge(x=>new Set(x).add(j)),i(x=>x.map(w=>w.id===j?{...w,file_url:oe}:w));return}if(V&&!R.startsWith("data:")){let te=V.file_url;te.startsWith("/media/whatsapp/")&&(te=te.replace(/^\/media\/whatsapp\//,""));const oe=bs.getMediaUrl(te,!0);if(oe&&oe!==R&&oe.startsWith("data:")){ge(x=>new Set(x).add(j)),i(x=>x.map(w=>w.id===j?{...w,file_url:oe}:w));return}}ge(te=>new Set(te).add(j)),z(te=>new Set(te).add(j)),Q(te=>{const oe=new Set(te);return oe.delete(j),oe})},W=l.filter(j=>{if(T!=="All"&&j.folder!==T)return!1;if($){const R=$.toLowerCase();return j.name.toLowerCase().includes(R)||j.file_name.toLowerCase().includes(R)}return!0}),he=j=>{switch(j){case"image":return e.jsx(tt,{className:"w-6 h-6"});case"video":return e.jsx(Yt,{className:"w-6 h-6"});case"audio":return e.jsx(Jt,{className:"w-6 h-6"});default:return e.jsx(at,{className:"w-6 h-6"})}},Ge={total:l.length,images:l.filter(j=>j.file_type==="image").length,videos:l.filter(j=>j.file_type==="video").length,documents:l.filter(j=>j.file_type==="document").length,audio:l.filter(j=>j.file_type==="audio").length};return o?e.jsxs("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-purple-600 to-pink-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(Yr,{className:"w-7 h-7 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Media Library"}),e.jsx("p",{className:"text-purple-100",children:"Organize and reuse your media files"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>me(!0),className:"w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",title:"Backup & Restore",children:e.jsx(Ut,{className:"w-5 h-5 text-white"})}),e.jsx("button",{onClick:t,className:"w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-6 h-6 text-white"})})]})]})}),e.jsxs("div",{className:"p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Ge.total}),e.jsx("p",{className:"text-xs text-gray-600",children:"Total"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl font-bold text-blue-600",children:Ge.images}),e.jsx("p",{className:"text-xs text-gray-600",children:"Images"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl font-bold text-green-600",children:Ge.videos}),e.jsx("p",{className:"text-xs text-gray-600",children:"Videos"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xl font-bold text-orange-600",children:Ge.documents}),e.jsx("p",{className:"text-xs text-gray-600",children:"Docs"})]})]}),e.jsxs("label",{className:"px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:from-purple-700 hover:to-pink-700 font-semibold flex items-center gap-2 cursor-pointer shadow-lg",children:[e.jsx("input",{type:"file",accept:"image/*,video/*,audio/*,.pdf,.doc,.docx",onChange:He,disabled:ae,className:"hidden"}),e.jsx(Ds,{className:"w-5 h-5"}),ae?"Uploading...":"Upload Media"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"search",value:$,onChange:j=>E(j.target.value),placeholder:"Search media by name...",className:"w-full pl-12 pr-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200"})]})]}),e.jsx("div",{className:"p-4 bg-white border-b border-gray-200",children:e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto",children:d.map(j=>e.jsxs("button",{onClick:()=>v(j),className:`px-4 py-2 rounded-full font-semibold text-sm whitespace-nowrap transition-all ${T===j?"bg-purple-600 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["ğŸ“ ",j]},j))})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:L?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"})}):W.length===0?e.jsxs("div",{className:"text-center py-20",children:[e.jsx(Yr,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No media files yet"}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Upload images, videos, or documents to get started"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:W.map(j=>e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl overflow-hidden hover:shadow-lg hover:border-purple-400 transition-all group",children:[e.jsxs("div",{className:"aspect-square bg-gray-100 relative overflow-hidden",children:[j.file_type==="image"?P.has(j.id)?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-red-50 to-orange-50 p-4",children:[e.jsx(tt,{className:"w-12 h-12 text-red-300 mb-2"}),e.jsx("p",{className:"text-xs text-red-600 text-center font-medium",children:"Failed to load"}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-1 truncate w-full px-2",children:j.file_name}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{onClick:()=>{z(R=>{const V=new Set(R);return V.delete(j.id),V}),Q(R=>new Set(R).add(j.id)),i(R=>R.map(V=>V.id===j.id?{...V,file_url:V.file_url+"?reload="+Date.now()}:V))},className:"text-xs text-blue-600 hover:text-blue-700 underline",children:"Retry"}),e.jsx("a",{href:j.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:text-blue-700 underline",title:j.file_url,children:"Open URL"})]})]}):e.jsxs(e.Fragment,{children:[se.has(j.id)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50 z-10",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"})}),e.jsx("img",{src:j.file_url,alt:j.name,className:"w-full h-full object-contain bg-white",onLoad:()=>De(j.id),onError:()=>_(j.id,j.file_url),loading:"lazy",title:j.name})]}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-100 to-pink-100",children:he(j.file_type)}),e.jsxs("div",{className:"absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>U(j),className:"w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-gray-100",title:"Preview",children:e.jsx(yt,{className:"w-5 h-5 text-gray-700"})}),n&&e.jsx("button",{onClick:()=>$e(j),className:"w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center hover:bg-purple-700",title:"Use this media",children:e.jsx(xe,{className:"w-5 h-5 text-white"})}),e.jsx("button",{onClick:()=>J(j.id),className:"w-10 h-10 bg-red-600 rounded-full flex items-center justify-center hover:bg-red-700",title:"Delete",children:e.jsx(ys,{className:"w-5 h-5 text-white"})})]})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:"font-bold text-sm text-gray-900 truncate",title:j.name,children:j.name}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:"text-xs text-gray-600",children:[(j.file_size/1024/1024).toFixed(1)," MB"]}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Used ",j.usage_count||0,"x"]})]})]})]},j.id))})}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"ğŸ’¡ Tip: All media is stored locally in your browser. Max file size: 16MB (WhatsApp limit)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[P.size>0&&e.jsxs("button",{onClick:()=>{z(new Set),Ce(),c.success("Reloading all images...")},className:"text-sm text-blue-600 hover:text-blue-700 font-medium underline",children:["Reload All Images (",P.size,")"]}),e.jsxs("button",{onClick:()=>me(!0),className:"text-sm text-purple-600 hover:text-purple-700 font-medium flex items-center gap-1",title:"Backup & Restore Media",children:[e.jsx(Ut,{className:"w-4 h-4"}),"Backup & Restore"]})]})]})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-[100000] p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl",children:e.jsx(xo,{onClose:()=>me(!1)})})}),k&&e.jsx("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-3xl",children:[e.jsxs("div",{className:"p-4 bg-gray-900 flex items-center justify-between rounded-t-2xl",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:k.name}),e.jsx("button",{onClick:()=>U(null),className:"w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]}),e.jsxs("div",{className:"p-6",children:[k.file_type==="image"?e.jsx("div",{className:"relative",children:e.jsx("img",{src:k.file_url,alt:k.name,className:"w-full max-h-[70vh] object-contain rounded-lg bg-gray-50",onError:j=>{var V;console.error("Preview image failed to load:",k.file_url),j.target.style.display="none";const R=document.createElement("div");R.className="w-full h-64 flex flex-col items-center justify-center bg-red-50 rounded-lg",R.innerHTML=`
                        <svg class="w-16 h-16 text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-red-600 font-medium">Failed to load image</p>
                        <p class="text-sm text-gray-500 mt-2">${k.file_name}</p>
                      `,(V=j.target.parentElement)==null||V.appendChild(R)}})}):k.file_type==="video"?e.jsx("video",{src:k.file_url,controls:!0,className:"w-full rounded-lg"}):e.jsxs("div",{className:"text-center py-10",children:[he(k.file_type),e.jsx("p",{className:"mt-4 text-gray-700",children:k.file_name}),e.jsx("a",{href:k.file_url,target:"_blank",rel:"noopener noreferrer",className:"inline-block mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Open File"})]}),n&&e.jsxs("button",{onClick:()=>$e(k),className:"w-full mt-4 px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-semibold flex items-center justify-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),"Use This Media in Campaign"]})]})]})})]}):null}class po{constructor(){this.baseUrl="https://www.wasenderapi.com/api",this.bearerToken=null}async getHeaders(){if(!this.bearerToken)try{const t=await Rl("WHATSAPP_WASENDER");if(!t)throw new Error("WhatsApp integration not configured. Please configure WaSender API in Admin Settings > Integrations.");if(!t.is_enabled)throw new Error("WhatsApp integration is disabled. Please enable it in Admin Settings > Integrations.");let n=t.credentials;if(typeof n=="string")try{n=JSON.parse(n)}catch(l){throw console.error("âš ï¸ [WhatsApp] Failed to parse credentials:",l),new Error("Invalid integration credentials format. Please reconfigure the integration.")}if(this.bearerToken=(n==null?void 0:n.bearer_token)||(n==null?void 0:n.api_key)||"",!this.bearerToken||this.bearerToken.trim()==="")throw new Error("WhatsApp API token is missing. Please configure your WaSender API Bearer Token in Admin Settings > Integrations.")}catch(t){throw console.error("âš ï¸ [WhatsApp] Integration not configured:",t),this.bearerToken=null,t}return{Authorization:`Bearer ${this.bearerToken}`,"Content-Type":"application/json"}}clearTokenCache(){this.bearerToken=null}async getAllSessions(){var t,n;try{const l=await this.getHeaders(),i=await fetch(`${this.baseUrl}/whatsapp-sessions`,{method:"GET",headers:l});let d;const p=i.headers.get("content-type");if(p&&p.includes("application/json")?d=await i.json():d={message:await i.text()||`HTTP ${i.status}: ${i.statusText}`},!i.ok){if(i.status===401){this.bearerToken=null;const T=d.message||d.error||"",v=T.includes("personal access token")||T.includes("valid")||T.includes("token")?"Invalid or expired API token. Please verify your WaSender API Bearer Token in Admin Settings > Integrations and ensure it is correct and active.":T||"Authentication failed. Please check your API token in Admin Settings > Integrations.";throw new Error(v)}throw new Error(d.message||d.error||`Failed to fetch sessions: ${i.status} ${i.statusText}`)}return{success:!0,data:d.data||[]}}catch(l){return!((t=l.message)!=null&&t.includes("not configured"))&&!((n=l.message)!=null&&n.includes("disabled"))&&console.error("âŒ [WhatsApp] Error fetching sessions:",l),{success:!1,data:[],error:l.message}}}async createSession(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions`,{method:"POST",headers:n,body:JSON.stringify(t)}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to create session");return{success:!0,data:i.data}}catch(n){return console.error("Error creating WhatsApp session:",n),{success:!1,error:n.message}}}async getSessionDetails(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}`,{method:"GET",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to fetch session details");return{success:!0,data:i.data}}catch(n){return console.error("Error fetching session details:",n),{success:!1,error:n.message}}}async updateSession(t,n){try{const l=await this.getHeaders(),i=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}`,{method:"PUT",headers:l,body:JSON.stringify(n)}),d=await i.json();if(!i.ok)throw new Error(d.message||"Failed to update session");return{success:!0,data:d.data}}catch(l){return console.error("Error updating session:",l),{success:!1,error:l.message}}}async deleteSession(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}`,{method:"DELETE",headers:n});if(!l.ok){const i=await l.json();throw new Error(i.message||"Failed to delete session")}return{success:!0}}catch(n){return console.error("Error deleting session:",n),{success:!1,error:n.message}}}async getSessionStatus(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/status`,{method:"GET",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to fetch session status");return{success:!0,status:i.status}}catch(n){return console.error("Error fetching session status:",n),{success:!1,error:n.message}}}async connectSession(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/connect`,{method:"POST",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to connect session");return{success:!0,qr_code:i.qr_code}}catch(n){return console.error("Error connecting session:",n),{success:!1,error:n.message}}}async restartSession(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/restart`,{method:"POST",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to restart session");return{success:!0}}catch(n){return console.error("Error restarting session:",n),{success:!1,error:n.message}}}async getQRCode(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/qr-code`,{method:"GET",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to fetch QR code");return{success:!0,qr_code:i.qr_code}}catch(n){return console.error("Error fetching QR code:",n),{success:!1,error:n.message}}}async disconnectSession(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/disconnect`,{method:"POST",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to disconnect session");return{success:!0}}catch(n){return console.error("Error disconnecting session:",n),{success:!1,error:n.message}}}async getSessionUserInfo(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/user-info`,{method:"GET",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to fetch user info");return{success:!0,user_info:i.data}}catch(n){return console.error("Error fetching user info:",n),{success:!1,error:n.message}}}async checkNumberOnWhatsApp(t,n){try{const l=await this.getHeaders(),i=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/check-number`,{method:"POST",headers:l,body:JSON.stringify({phone_number:n})}),d=await i.json();if(!i.ok)throw new Error(d.message||"Failed to check number");return{success:!0,exists:d.exists}}catch(l){return console.error("Error checking number:",l),{success:!1,error:l.message}}}async regenerateApiKey(t){try{const n=await this.getHeaders(),l=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/regenerate-api-key`,{method:"POST",headers:n}),i=await l.json();if(!l.ok)throw new Error(i.message||"Failed to regenerate API key");return{success:!0,api_key:i.api_key}}catch(n){return console.error("Error regenerating API key:",n),{success:!1,error:n.message}}}async sendPresence(t,n,l){try{const i=await this.getHeaders(),d=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/presence`,{method:"POST",headers:i,body:JSON.stringify({jid:n,type:l})}),p=await d.json();if(!d.ok)throw new Error(p.message||"Failed to send presence");return{success:!0}}catch(i){return console.error("Error sending presence:",i),{success:!1,error:i.message}}}async getMessageLogs(t,n=100){try{const l=await this.getHeaders(),i=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/message-logs?limit=${n}`,{method:"GET",headers:l}),d=await i.json();if(!i.ok)throw new Error(d.message||"Failed to fetch message logs");return{success:!0,logs:d.data||[]}}catch(l){return console.error("Error fetching message logs:",l),{success:!1,error:l.message}}}async getSessionLogs(t,n=100){try{const l=await this.getHeaders(),i=await fetch(`${this.baseUrl}/whatsapp-sessions/${t}/logs?limit=${n}`,{method:"GET",headers:l}),d=await i.json();if(!i.ok)throw new Error(d.message||"Failed to fetch session logs");return{success:!0,logs:d.data||[]}}catch(l){return console.error("Error fetching session logs:",l),{success:!1,error:l.message}}}}const fo=new po,et=fo;function bo({isOpen:o,onClose:t,onSessionConnected:n}){const[l,i]=m.useState([]),[d,p]=m.useState(!1),[T,v]=m.useState(!1),[L,G]=m.useState(null),[$,E]=m.useState(null),[k,U]=m.useState(!1),[ae,K]=m.useState(null),[P,z]=m.useState(!1),[se,Q]=m.useState(!1),[Y,me]=m.useState({name:"",phone_number:"",account_protection:!0,log_messages:!0,webhook_enabled:!1,webhook_url:"",webhook_events:["messages.received","messages.upsert","session.status"],read_incoming_messages:!1,auto_reject_calls:!1});m.useEffect(()=>(o&&X(),()=>{ae&&clearInterval(ae)}),[o]);const X=async()=>{p(!0),Q(!1);try{const _=await et.getAllSessions();if(_.success)i(_.data),Q(!1);else{const W=_.error||"";W.includes("not configured")||W.includes("disabled")||W.includes("Authentication failed")||W.includes("API token is missing")?Q(!0):c.error(W||"Failed to load sessions")}}catch(_){const W=(_==null?void 0:_.message)||"";W.includes("not configured")||W.includes("disabled")||W.includes("Authentication failed")||W.includes("API token is missing")?Q(!0):(console.error("Error loading sessions:",_),c.error(W||"Failed to load sessions"))}finally{p(!1)}},ge=async()=>{if(!Y.name||!Y.phone_number){c.error("Please fill in all required fields");return}p(!0);try{const _=await et.createSession(Y);_.success&&_.data?(c.success("Session created successfully!"),v(!1),me({name:"",phone_number:"",account_protection:!0,log_messages:!0,webhook_enabled:!1,webhook_url:"",webhook_events:["messages.received","messages.upsert","session.status"],read_incoming_messages:!1,auto_reject_calls:!1}),X()):c.error(_.error||"Failed to create session")}catch(_){console.error("Error creating session:",_),c.error("Failed to create session")}finally{p(!1)}},Ce=async _=>{G(_),U(!0),E(null);try{const W=await et.connectSession(_.id);W.success?(c.success("Connecting... Please scan QR code"),Me(_.id)):(c.error(W.error||"Failed to connect session"),U(!1))}catch(W){console.error("Error connecting session:",W),c.error("Failed to connect session"),U(!1)}},Me=_=>{ae&&clearInterval(ae);const W=setInterval(async()=>{try{const he=await et.getQRCode(_);he.success&&he.qr_code&&(E(he.qr_code),U(!1));const Ge=await et.getSessionStatus(_);if(Ge.success&&Ge.status==="connected"){clearInterval(W),K(null),E(null),G(null),c.success("WhatsApp connected successfully!"),X();const j=l.find(R=>R.id===_);j&&n&&n(j)}}catch(he){console.error("Error polling QR code:",he)}},2e3);K(W),setTimeout(()=>{ae&&(clearInterval(W),K(null),U(!1),c.error("QR code expired. Please try again."))},6e4)},He=async _=>{if(window.confirm(`Are you sure you want to disconnect "${_.name}"?`))try{const he=await et.disconnectSession(_.id);he.success?(c.success("Session disconnected"),X()):c.error(he.error||"Failed to disconnect session")}catch(he){console.error("Error disconnecting session:",he),c.error("Failed to disconnect session")}},J=async _=>{if(window.confirm(`Are you sure you want to delete "${_.name}"? This cannot be undone.`))try{const he=await et.deleteSession(_.id);he.success?(c.success("Session deleted"),X()):c.error(he.error||"Failed to delete session")}catch(he){console.error("Error deleting session:",he),c.error("Failed to delete session")}},$e=async _=>{try{const W=await et.restartSession(_.id);W.success?(c.success("Session restarted"),X()):c.error(W.error||"Failed to restart session")}catch(W){console.error("Error restarting session:",W),c.error("Failed to restart session")}},De=async()=>{z(!0);try{const _=await fetch("/api/whatsapp-sessions/sync-from-wasender",{method:"POST"}),W=await _.json().catch(()=>({success:!1,error:"Invalid server response"}));if(_.ok&&W.success)c.success(W.message||"Sessions synced successfully!"),X();else{const he=W.error||`Server error: ${_.status} ${_.statusText}`;c.error(he),console.warn("Sync from WasenderAPI failed:",he)}}catch(_){const W=_ instanceof Error?_.message:"Unknown error";console.error("Error syncing from WasenderAPI:",_),c.error(`Failed to sync sessions: ${W}`)}finally{z(!1)}};return o?e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-green-600 to-emerald-600 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(sa,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"WhatsApp Sessions"}),e.jsx("p",{className:"text-sm text-green-100",children:"Manage your WhatsApp Business connections"})]})]}),e.jsx("button",{onClick:t,className:"w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[L&&e.jsxs("div",{className:"mb-6 p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border-2 border-green-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-1",children:"Connect WhatsApp"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Scan QR code with WhatsApp mobile app"})]}),e.jsx("button",{onClick:()=>{G(null),E(null),ae&&(clearInterval(ae),K(null))},className:"p-2 hover:bg-white rounded-lg transition-colors",children:e.jsx(Te,{className:"w-5 h-5 text-gray-600"})})]}),e.jsx("div",{className:"flex flex-col items-center justify-center py-8",children:k?e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ta,{className:"w-12 h-12 text-green-600 animate-spin"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"Generating QR code..."})]}):$?e.jsxs("div",{className:"bg-white p-4 rounded-2xl shadow-lg",children:[e.jsx("img",{src:$,alt:"WhatsApp QR Code",className:"w-64 h-64"}),e.jsx("p",{className:"text-center text-sm text-gray-600 mt-4",children:"Open WhatsApp â†’ Settings â†’ Linked Devices â†’ Link a Device"})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(Bl,{className:"w-16 h-16 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600",children:"QR code will appear here..."})]})})]}),!se&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Your Sessions"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:De,disabled:P||d,className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all flex items-center gap-2 disabled:opacity-50",title:"Import sessions from WasenderAPI",children:[e.jsx(rs,{className:`w-4 h-4 ${P?"animate-spin":""}`}),"Sync from API"]}),e.jsxs("button",{onClick:X,disabled:d,className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all flex items-center gap-2 disabled:opacity-50",children:[e.jsx(rs,{className:`w-4 h-4 ${d?"animate-spin":""}`}),"Refresh"]}),e.jsxs("button",{onClick:()=>v(!T),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all flex items-center gap-2",children:[e.jsx(Lt,{className:"w-4 h-4"}),"New Session"]})]})]}),T&&e.jsxs("div",{className:"mb-6 p-6 bg-gray-50 rounded-2xl border-2 border-gray-200",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900 mb-4",children:"Create New Session"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Session Name *"}),e.jsx("input",{type:"text",value:Y.name,onChange:_=>me({...Y,name:_.target.value}),placeholder:"e.g., Business WhatsApp",className:"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Phone Number *"}),e.jsx("input",{type:"tel",value:Y.phone_number,onChange:_=>me({...Y,phone_number:_.target.value}),placeholder:"+1234567890",className:"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-4",children:[e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-white rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"checkbox",checked:Y.account_protection,onChange:_=>me({...Y,account_protection:_.target.checked}),className:"w-4 h-4 text-green-600 rounded"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Account Protection"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-white rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"checkbox",checked:Y.log_messages,onChange:_=>me({...Y,log_messages:_.target.checked}),className:"w-4 h-4 text-green-600 rounded"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Log Messages"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-white rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"checkbox",checked:Y.read_incoming_messages,onChange:_=>me({...Y,read_incoming_messages:_.target.checked}),className:"w-4 h-4 text-green-600 rounded"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Auto-Read Messages"})]}),e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-white rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"checkbox",checked:Y.auto_reject_calls,onChange:_=>me({...Y,auto_reject_calls:_.target.checked}),className:"w-4 h-4 text-green-600 rounded"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Auto-Reject Calls"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>v(!1),disabled:d,className:"flex-1 px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold",children:"Cancel"}),e.jsx("button",{onClick:ge,disabled:d||!Y.name||!Y.phone_number,className:"flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-all font-semibold",children:d?"Creating...":"Create Session"})]})]}),se&&e.jsx("div",{className:"mb-6 p-6 bg-amber-50 border-2 border-amber-300 rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ca,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-amber-900 mb-2 text-lg",children:"WhatsApp Integration Not Configured"}),e.jsx("p",{className:"text-sm text-amber-800 mb-4",children:"To use WhatsApp features, you need to configure the WaSender API integration first."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-amber-900 font-medium",children:"Steps to configure:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-sm text-amber-800 ml-2",children:[e.jsxs("li",{children:["Go to ",e.jsx("span",{className:"font-semibold",children:"Admin Settings â†’ Integrations"})]}),e.jsxs("li",{children:["Find ",e.jsx("span",{className:"font-semibold",children:"WhatsApp (WaSender)"})," integration"]}),e.jsx("li",{children:"Enter your WaSender API Bearer Token"}),e.jsx("li",{children:"Enable the integration and save"}),e.jsx("li",{children:"Come back here to create or import WhatsApp sessions"})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-amber-200",children:e.jsxs("p",{className:"text-xs text-amber-700",children:["Don't have a WaSender account? Visit ",e.jsx("a",{href:"https://wasenderapi.com",target:"_blank",rel:"noopener noreferrer",className:"font-semibold underline hover:text-amber-900",children:"wasenderapi.com"})," to get started."]})})]})]})]})}),!se&&l.length===0&&!T&&e.jsx("div",{className:"mb-6 p-5 bg-blue-50 border-2 border-blue-200 rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ra,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-blue-900 mb-2",children:"Already Have Sessions on WasenderAPI?"}),e.jsx("p",{className:"text-sm text-blue-700 mb-3",children:`If you've already created sessions on WasenderAPI dashboard, click "Sync from API" to import them into this system.`}),e.jsxs("button",{onClick:De,disabled:P,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all flex items-center gap-2 disabled:opacity-50 font-semibold",children:[e.jsx(rs,{className:`w-4 h-4 ${P?"animate-spin":""}`}),P?"Importing...":"Import Existing Sessions"]})]})]})}),d&&l.length===0&&!se?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(ta,{className:"w-8 h-8 text-green-600 animate-spin mb-3"}),e.jsx("p",{className:"text-gray-600",children:"Loading sessions..."})]}):!se&&l.length===0&&!T?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx(sa,{className:"w-16 h-16 text-gray-400 mb-3"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-1",children:"No sessions yet"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Create your first WhatsApp session to get started"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:De,disabled:P,className:"px-5 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all flex items-center gap-2 disabled:opacity-50 font-semibold",children:[e.jsx(rs,{className:`w-4 h-4 ${P?"animate-spin":""}`}),P?"Importing...":"Import from WasenderAPI"]}),e.jsx("span",{className:"text-gray-400 flex items-center",children:"or"}),e.jsxs("button",{onClick:()=>v(!0),className:"px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all flex items-center gap-2 font-semibold",children:[e.jsx(Lt,{className:"w-4 h-4"}),"Create New Session"]})]})]}):e.jsx("div",{className:"grid grid-cols-1 gap-4",children:l.map(_=>e.jsxs("div",{className:`p-5 rounded-2xl border-2 transition-all ${_.status==="connected"?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${_.status==="connected"?"bg-green-500":"bg-gray-400"}`,children:e.jsx(sa,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-lg font-bold text-gray-900",children:_.name}),e.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-1 mb-2",children:[e.jsx(bt,{className:"w-3 h-3"}),_.phone_number]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${_.status==="connected"?"bg-green-500 text-white":"bg-gray-400 text-white"}`,children:_.status==="connected"?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(aa,{className:"w-3 h-3"}),"Connected"]}):e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Da,{className:"w-3 h-3"}),"Disconnected"]})}),_.account_protection&&e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold",children:"Protected"}),_.log_messages&&e.jsx("span",{className:"px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold",children:"Logging"})]})]})]})}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[_.status!=="connected"?e.jsxs("button",{onClick:()=>Ce(_),className:"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all flex items-center gap-2 text-sm font-semibold",children:[e.jsx(Ol,{className:"w-4 h-4"}),"Connect"]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>He(_),className:"px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-all flex items-center gap-2 text-sm font-semibold",children:[e.jsx(Da,{className:"w-4 h-4"}),"Disconnect"]}),e.jsxs("button",{onClick:()=>$e(_),className:"px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-all flex items-center gap-2 text-sm font-semibold",children:[e.jsx(rs,{className:"w-4 h-4"}),"Restart"]})]}),e.jsxs("button",{onClick:()=>J(_),className:"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all flex items-center gap-2 text-sm font-semibold",children:[e.jsx(ys,{className:"w-4 h-4"}),"Delete"]})]})]},_.id))})]}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-xs text-gray-600",children:[l.length," session",l.length!==1?"s":""," â€¢ ",l.filter(_=>_.status==="connected").length," connected"]}),e.jsx("button",{onClick:t,className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-all font-semibold",children:"Close"})]})})]})}):null}const yo=({isOpen:o,onClose:t,currentActiveCampaign:n,onResumeCampaign:l,onViewCampaign:i,onDeleteCampaign:d,onClone:p})=>{const T=m.useRef(null),[v,L]=m.useState([]),[G,$]=m.useState(!0),[E,k]=m.useState(""),[U,ae]=m.useState("all"),[K,P]=m.useState("timestamp"),[z,se]=m.useState("desc"),[Q,Y]=m.useState(null),[me,X]=m.useState("all"),[ge,Ce]=m.useState(new Set),[Me,He]=m.useState(!1),[J,$e]=m.useState(null),De=async()=>{$(!0);try{const x=[];try{const w=await Ae.campaign.getAll(100);console.log(`ğŸ“Š Loaded ${w.length} campaigns from database`),w.forEach(C=>{var ie,Se;const b=((ie=C.recipients_data)==null?void 0:ie.length)||C.total_recipients||0,S=C.sent_count||0,N=C.success_count||0,ee=S-N;x.push({id:`db_${C.id}`,name:C.name,status:C.status||"pending",timestamp:C.created_at,selectedRecipients:((Se=C.recipients_data)==null?void 0:Se.map(h=>h.phone))||[],sentPhones:[],bulkMessage:C.message,bulkMessageType:C.message_type||"text",bulkProgress:{current:S,total:b,success:N,failed:ee},source:"database",dbCampaign:C})})}catch(w){console.error("Error loading database campaigns:",w),c.error("Failed to load database campaigns")}try{const C=Object.keys(localStorage).filter(b=>b.startsWith("whatsapp_paused_campaign")||b.startsWith("whatsapp_campaign_"));console.log(`ğŸ’¾ Found ${C.length} campaigns in localStorage`),C.forEach(b=>{var S,N,ee,ie,Se,h;try{const ce=localStorage.getItem(b);if(ce){const be=JSON.parse(ce);let Je="paused";((S=be.bulkProgress)==null?void 0:S.current)===((N=be.bulkProgress)==null?void 0:N.total)&&((ee=be.bulkProgress)==null?void 0:ee.total)>0?Je="completed":be.isStopped?Je="stopped":((ie=be.bulkProgress)==null?void 0:ie.failed)>((Se=be.bulkProgress)==null?void 0:Se.success)&&((h=be.bulkProgress)==null?void 0:h.current)>10?Je="failed":be.isPaused||b.includes("paused")?Je="paused":Je="active",x.push({id:b,name:be.campaignName||"Unnamed Campaign",status:Je,timestamp:be.timestamp||new Date().toISOString(),pauseTimestamp:be.pauseTimestamp,selectedRecipients:be.selectedRecipients||[],sentPhones:be.sentPhones||[],bulkMessage:be.bulkMessage||"",bulkMessageType:be.bulkMessageType||"text",bulkMedia:be.bulkMedia,bulkProgress:be.bulkProgress||{current:0,total:0,success:0,failed:0},usePersonalization:be.usePersonalization,randomDelay:be.randomDelay,minDelay:be.minDelay,maxDelay:be.maxDelay,source:"localStorage"})}}catch(ce){console.error("Error loading campaign from localStorage:",b,ce)}})}catch(w){console.error("Error loading localStorage campaigns:",w)}n&&(console.log("ğŸŸ¢ Adding current active campaign from session"),x.unshift({id:"current_active",name:n.name+" (Current)",status:n.status,timestamp:n.timestamp,selectedRecipients:n.selectedRecipients,sentPhones:n.sentPhones,bulkMessage:n.bulkMessage,bulkMessageType:n.bulkMessageType,bulkMedia:n.bulkMedia,bulkProgress:n.bulkProgress,usePersonalization:n.usePersonalization,randomDelay:n.randomDelay,minDelay:n.minDelay,maxDelay:n.maxDelay,source:"localStorage"})),console.log(`âœ… Total campaigns loaded: ${x.length}`),L(x)}catch(x){console.error("Error loading campaigns:",x),c.error("Failed to load campaigns")}finally{$(!1)}};m.useEffect(()=>{o&&De()},[o,n]);const _=m.useMemo(()=>{let x=[...v];return E&&(x=x.filter(w=>w.name.toLowerCase().includes(E.toLowerCase())||w.bulkMessage.toLowerCase().includes(E.toLowerCase()))),U!=="all"&&(x=x.filter(w=>w.status===U)),me!=="all"&&(x=x.filter(w=>w.source===me)),x.sort((w,C)=>{let b,S;switch(K){case"timestamp":b=new Date(w.timestamp).getTime(),S=new Date(C.timestamp).getTime();break;case"name":b=w.name.toLowerCase(),S=C.name.toLowerCase();break;case"progress":b=w.bulkProgress.current/w.bulkProgress.total||0,S=C.bulkProgress.current/C.bulkProgress.total||0;break;default:b=new Date(w.timestamp).getTime(),S=new Date(C.timestamp).getTime()}return z==="asc"?b>S?1:-1:b<S?1:-1}),x},[v,E,U,me,K,z]),W=m.useMemo(()=>({total:v.length,active:v.filter(x=>x.status==="active").length,paused:v.filter(x=>x.status==="paused").length,completed:v.filter(x=>x.status==="completed").length,stopped:v.filter(x=>x.status==="stopped").length,failed:v.filter(x=>x.status==="failed").length,database:v.filter(x=>x.source==="database").length,localStorage:v.filter(x=>x.source==="localStorage").length}),[v]),he=x=>{const w=v.find(C=>C.id===x);if((w==null?void 0:w.source)==="database"){c.error("Cannot delete database campaigns from here. Use Campaign History instead.",{duration:5e3});return}if(window.confirm("Are you sure you want to delete this local campaign? This action cannot be undone."))try{localStorage.removeItem(x),L(v.filter(C=>C.id!==x)),c.success("Campaign deleted successfully"),d&&d(x)}catch(C){console.error("Error deleting campaign:",C),c.error("Failed to delete campaign")}},Ge=x=>{l&&(l(x),t())},j=async x=>{if(!["pending","sending","draft","active","paused"].includes(x.status)){c.error(`Cannot cancel campaign with status: ${x.status}`);return}const C=x.source==="database"?`Are you sure you want to cancel "${x.name}"? This will stop the campaign and mark it as stopped.`:`Are you sure you want to cancel "${x.name}"? This will delete the campaign.`;if(window.confirm(C))try{if(x.source==="database"){const b=x.id.replace("db_","");await Ae.campaign.cancel(b),c.success("Campaign cancelled successfully"),De()}else localStorage.removeItem(x.id),L(v.filter(b=>b.id!==x.id)),c.success("Campaign cancelled and deleted"),d&&d(x.id)}catch(b){console.error("Error cancelling campaign:",b),c.error(b.message||"Failed to cancel campaign")}},R=async x=>{if(!x.dbCampaign&&x.source==="database")try{const w=x.id.replace("db_","");if(await Ae.campaign.getById(w)){const b=prompt("Enter name for cloned campaign:",`${x.name} (Copy)`);if(!b)return;const S=await Ae.campaign.clone(w,b);c.success(`Campaign "${b}" created!`),p&&(p(S),t())}}catch{c.error("Clone failed")}else if(x.dbCampaign){const w=prompt("Enter name for cloned campaign:",`${x.name} (Copy)`);if(!w)return;try{const C=await Ae.campaign.clone(x.dbCampaign.id,w);c.success(`Campaign "${w}" created!`),p&&(p(C),t())}catch{c.error("Clone failed")}}else c.error("Cannot clone local campaigns. Only database campaigns can be cloned.")},V=x=>{switch(x){case"active":return e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Cs,{className:"w-3 h-3"}),"Active"]});case"paused":return e.jsxs("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Xr,{className:"w-3 h-3"}),"Paused"]});case"pending":return e.jsxs("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3"}),"Pending"]});case"draft":return e.jsxs("span",{className:"px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(gn,{className:"w-3 h-3"}),"Draft"]});case"sending":return e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(fs,{className:"w-3 h-3"}),"Sending"]});case"completed":return e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(aa,{className:"w-3 h-3"}),"Completed"]});case"stopped":return e.jsxs("span",{className:"px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(ar,{className:"w-3 h-3"}),"Stopped"]});case"failed":return e.jsxs("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Zr,{className:"w-3 h-3"}),"Failed"]});default:return e.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium flex items-center gap-1",children:x})}},Z=x=>x.bulkProgress.total===0?0:Math.round(x.bulkProgress.current/x.bulkProgress.total*100),te=x=>{var b,S;if(x.source==="database")return Math.max(0,x.bulkProgress.total-x.bulkProgress.current);const w=((b=x.sentPhones)==null?void 0:b.length)||0,C=((S=x.selectedRecipients)==null?void 0:S.length)||0;return Math.max(0,C-w)},oe=x=>{const w=new Date(x),b=(new Date().getTime()-w.getTime())/(1e3*60*60);if(b<1){const S=Math.floor(b*60);return`${S} minute${S!==1?"s":""} ago`}else if(b<24){const S=Math.floor(b);return`${S} hour${S!==1?"s":""} ago`}else{const S=Math.floor(b/24);return`${S} day${S!==1?"s":""} ago`}};return o?Ta.createPortal(e.jsxs("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[99999] p-4",children:[e.jsxs("div",{ref:T,className:"bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(cr,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Campaign Management"}),e.jsx("p",{className:"text-blue-100 text-sm",children:"View and manage all WhatsApp campaigns"})]})]}),e.jsx("button",{onClick:t,className:"w-10 h-10 flex items-center justify-center bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full transition-colors",children:e.jsx(Te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-7 gap-2",children:[e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Total"}),e.jsx("p",{className:"text-xl font-bold",children:W.total})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Active"}),e.jsxs("p",{className:"text-xl font-bold flex items-center gap-1",children:[W.active,e.jsx(Cs,{className:"w-3 h-3"})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Paused"}),e.jsxs("p",{className:"text-xl font-bold flex items-center gap-1",children:[W.paused,e.jsx(Xr,{className:"w-3 h-3"})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Completed"}),e.jsxs("p",{className:"text-xl font-bold flex items-center gap-1",children:[W.completed,e.jsx(aa,{className:"w-3 h-3"})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Stopped"}),e.jsxs("p",{className:"text-xl font-bold flex items-center gap-1",children:[W.stopped,e.jsx(ar,{className:"w-3 h-3"})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"Failed"}),e.jsxs("p",{className:"text-xl font-bold flex items-center gap-1",children:[W.failed,e.jsx(Zr,{className:"w-3 h-3"})]})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-2",children:[e.jsx("p",{className:"text-blue-100 text-xs mb-1",children:"DB / Local"}),e.jsxs("p",{className:"text-xl font-bold",children:[W.database," / ",W.localStorage]})]})]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border-b border-gray-200 flex-shrink-0",children:[e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search campaigns...",value:E,onChange:x=>k(x.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),e.jsxs("select",{value:U,onChange:x=>ae(x.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"paused",children:"Paused"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"stopped",children:"Stopped"}),e.jsx("option",{value:"failed",children:"Failed"})]}),e.jsxs("select",{value:me,onChange:x=>X(x.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Sources"}),e.jsxs("option",{value:"database",children:["Database (",W.database,")"]}),e.jsxs("option",{value:"localStorage",children:["Local (",W.localStorage,")"]})]}),e.jsxs("select",{value:K,onChange:x=>P(x.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"timestamp",children:"Sort by Date"}),e.jsx("option",{value:"name",children:"Sort by Name"}),e.jsx("option",{value:"progress",children:"Sort by Progress"})]}),e.jsx("button",{onClick:()=>se(z==="asc"?"desc":"asc"),className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2",children:z==="asc"?"â†‘":"â†“"}),e.jsxs("button",{onClick:De,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(rs,{className:"w-4 h-4"}),"Refresh"]}),e.jsxs("button",{onClick:()=>{He(!Me),Me&&Ce(new Set)},className:`px-4 py-2 rounded-lg transition-colors flex items-center gap-2 ${Me?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:[e.jsx(Gl,{className:"w-4 h-4"}),Me?"Cancel":"Select"]})]}),Me&&ge.size>0&&e.jsxs("div",{className:"mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-purple-900",children:[ge.size," campaign",ge.size!==1?"s":""," selected"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>{const w=_.filter(C=>ge.has(C.id)).filter(C=>C.source==="localStorage"&&C.id!=="current_active");w.length>0?window.confirm(`Delete ${w.length} campaign(s)?`)&&(w.forEach(C=>{he(C.id),Ce(b=>{const S=new Set(b);return S.delete(C.id),S})}),c.success(`Deleted ${w.length} campaign(s)`)):c.error("Selected campaigns cannot be deleted")},className:"px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium flex items-center gap-1",children:[e.jsx(ys,{className:"w-3 h-3"}),"Delete Selected"]}),e.jsx("button",{onClick:()=>Ce(new Set),className:"px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-medium",children:"Clear"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[n&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full animate-pulse"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-blue-900",children:"Live Campaign Active"}),e.jsxs("p",{className:"text-sm text-blue-700",children:['Your current campaign "',n.name,'" is running now']})]})]})}),G?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ta,{className:"w-8 h-8 animate-spin text-blue-600"})}):_.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ea,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No campaigns found"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:E||U!=="all"?"Try adjusting your filters":"Start a bulk WhatsApp campaign to see it here"})]}):e.jsx("div",{className:"space-y-4",children:_.map(x=>e.jsxs("div",{className:`bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow overflow-hidden ${x.id==="current_active"?"border-2 border-blue-500 ring-2 ring-blue-200":"border border-gray-200"}`,children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1 flex items-start gap-3",children:[Me&&x.id!=="current_active"&&x.source==="localStorage"&&e.jsx("input",{type:"checkbox",checked:ge.has(x.id),onChange:w=>{Ce(C=>{const b=new Set(C);return w.target.checked?b.add(x.id):b.delete(x.id),b})},className:"mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-2 mb-2 flex-wrap",children:[e.jsx("h3",{className:"font-bold text-gray-900 text-lg",children:x.name}),x.id==="current_active"&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium flex items-center gap-1 animate-pulse",children:[e.jsx("span",{className:"w-2 h-2 bg-blue-600 rounded-full"}),"LIVE NOW"]}),V(x.status),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${x.source==="database"?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:x.source==="database"?"â˜ï¸ Database":"ğŸ’¾ Local"})]})}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{className:"w-4 h-4"}),oe(x.timestamp)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(It,{className:"w-4 h-4"}),x.selectedRecipients.length," recipients"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ea,{className:"w-4 h-4"}),x.bulkMessageType]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:x.id==="current_active"?e.jsxs("button",{onClick:()=>{t(),c.success("Showing live campaign in minimized view")},className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm font-medium",title:"View live campaign",children:[e.jsx(Cs,{className:"w-4 h-4"}),"View Live"]}):e.jsxs(e.Fragment,{children:[x.status==="paused"&&x.source==="localStorage"&&e.jsxs("button",{onClick:()=>Ge(x),className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 text-sm font-medium",title:"Resume campaign",children:[e.jsx(dr,{className:"w-4 h-4"}),"Resume"]}),e.jsxs("button",{onClick:()=>Y(Q===x.id?null:x.id),className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm font-medium",children:[e.jsx(yt,{className:"w-4 h-4"}),Q===x.id?"Hide":"View"]}),x.source==="database"&&x.dbCampaign&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>R(x),className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm font-medium",title:"Clone campaign",children:[e.jsx(Xt,{className:"w-4 h-4"}),"Clone"]}),e.jsx("button",{onClick:async()=>{try{const w=await Ae.analytics.exportCampaign(x.dbCampaign.id),C=URL.createObjectURL(w),b=document.createElement("a");b.href=C,b.download=`campaign-${x.name}-${new Date().toISOString().split("T")[0]}.csv`,b.click(),c.success("Campaign exported!")}catch{c.error("Export failed")}},className:"px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 text-sm font-medium",title:"Export campaign data",children:e.jsx(ds,{className:"w-4 h-4"})})]}),x.id!=="current_active"&&e.jsx("button",{onClick:()=>he(x.id),className:`px-3 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium ${x.source==="database"?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-red-600 text-white hover:bg-red-700"}`,title:x.source==="database"?"Cannot delete database campaigns":"Delete campaign",children:e.jsx(ys,{className:"w-4 h-4"})})]})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 text-sm",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Progress"}),e.jsxs("span",{className:"font-bold text-blue-600",children:[x.bulkProgress.current||0," / ",x.bulkProgress.total||0," (",Z(x),"%)"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-3 transition-all duration-300 ${x.status==="completed"?"bg-green-500":x.status==="failed"?"bg-red-500":x.status==="stopped"?"bg-orange-500":"bg-blue-500"}`,style:{width:`${Z(x)}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-green-50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-green-700 mb-1",children:"Successful"}),e.jsxs("p",{className:"text-lg font-bold text-green-600 flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),x.bulkProgress.success||0]})]}),e.jsxs("div",{className:"bg-red-50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-red-700 mb-1",children:"Failed"}),e.jsxs("p",{className:"text-lg font-bold text-red-600 flex items-center gap-1",children:[e.jsx(Da,{className:"w-4 h-4"}),x.bulkProgress.failed||0]})]}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-blue-700 mb-1",children:"Remaining"}),e.jsxs("p",{className:"text-lg font-bold text-blue-600 flex items-center gap-1",children:[e.jsx(Le,{className:"w-4 h-4"}),te(x)]})]})]})]}),Q===x.id&&e.jsxs("div",{className:"border-t border-gray-200 bg-gray-50 p-4",children:[x.id==="current_active"&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"ğŸ”´ This campaign is currently running in your session"}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"Real-time progress is shown below"})]}),e.jsxs("h4",{className:"font-bold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(Rt,{className:"w-5 h-5"}),"Campaign Details"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Message Type"}),e.jsx("p",{className:"font-medium text-gray-900",children:x.bulkMessageType})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Personalization"}),e.jsx("p",{className:"font-medium text-gray-900",children:x.usePersonalization?"Enabled":"Disabled"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Random Delay"}),e.jsx("p",{className:"font-medium text-gray-900",children:x.randomDelay?"Enabled":"Disabled"})]}),x.randomDelay&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Delay Range"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[x.minDelay,"s - ",x.maxDelay,"s"]})]}),x.pauseTimestamp&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Paused At"}),e.jsx("p",{className:"font-medium text-gray-900",children:oe(x.pauseTimestamp)})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Message Preview"}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap line-clamp-3",children:x.bulkMessage})})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[x.status==="paused"&&x.source==="localStorage"&&e.jsxs("button",{onClick:()=>Ge(x),className:"flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 font-medium",children:[e.jsx(Cs,{className:"w-4 h-4"}),"Resume Campaign"]}),x.source==="database"&&x.dbCampaign&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>R(x),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium",children:[e.jsx(Xt,{className:"w-4 h-4"}),"Clone"]}),e.jsxs("button",{onClick:()=>$e(x),className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 font-medium",children:[e.jsx(yt,{className:"w-4 h-4"}),"View Details"]})]}),x.source==="database"&&!x.dbCampaign&&e.jsx("div",{className:"flex-1 px-4 py-2 bg-purple-50 border border-purple-200 text-purple-700 rounded-lg text-center text-sm font-medium",children:"â˜ï¸ Completed campaign from database"}),e.jsxs("button",{onClick:()=>{navigator.clipboard.writeText(x.bulkMessage),c.success("Message copied to clipboard")},className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2 font-medium",children:[e.jsx(Xt,{className:"w-4 h-4"}),"Copy Message"]}),["pending","sending","draft","active","paused"].includes(x.status)&&e.jsxs("button",{onClick:()=>j(x),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 font-medium",children:[e.jsx(ar,{className:"w-4 h-4"}),"Cancel"]})]})]})]},x.id))})]}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",_.length," of ",v.length," campaigns"]}),e.jsx("button",{onClick:t,className:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Close"})]})})]}),J&&J.dbCampaign&&e.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-blue-600 to-indigo-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Campaign Details"}),e.jsx("button",{onClick:()=>$e(null),className:"w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h4",{className:"text-2xl font-bold text-gray-900 mb-4",children:J.name}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Message:"}),e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsx("p",{className:"whitespace-pre-wrap",children:J.bulkMessage})})]}),J.dbCampaign.media_url&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Media:"}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Type: ",J.dbCampaign.media_type]}),e.jsx("a",{href:J.dbCampaign.media_url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm",children:"View Media"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Status:"}),e.jsx("span",{className:`inline-block px-3 py-1 rounded-full text-sm font-bold ${J.status==="completed"?"bg-green-100 text-green-700":J.status==="failed"?"bg-red-100 text-red-700":J.status==="pending"?"bg-yellow-100 text-yellow-700":J.status==="sending"?"bg-blue-100 text-blue-700":"bg-gray-100 text-gray-700"}`,children:J.status})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Duration:"}),e.jsx("p",{className:"text-gray-900",children:J.dbCampaign.duration_seconds?`${Math.floor(J.dbCampaign.duration_seconds/60)}m ${J.dbCampaign.duration_seconds%60}s`:"N/A"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Performance:"}),e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-xl font-bold text-blue-600",children:J.dbCampaign.sent_count||0}),e.jsx("p",{className:"text-xs text-gray-600",children:"Sent"})]}),e.jsxs("div",{className:"p-3 bg-green-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-xl font-bold text-green-600",children:J.dbCampaign.success_count||0}),e.jsx("p",{className:"text-xs text-gray-600",children:"Success"})]}),e.jsxs("div",{className:"p-3 bg-red-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-xl font-bold text-red-600",children:J.dbCampaign.failed_count||0}),e.jsx("p",{className:"text-xs text-gray-600",children:"Failed"})]}),e.jsxs("div",{className:"p-3 bg-purple-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-xl font-bold text-purple-600",children:J.dbCampaign.replied_count||0}),e.jsx("p",{className:"text-xs text-gray-600",children:"Replied"})]})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsxs("button",{onClick:()=>{R(J),$e(null)},className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold flex items-center justify-center gap-2",children:[e.jsx(Xt,{className:"w-5 h-5"}),"Clone Campaign"]}),e.jsxs("button",{onClick:async()=>{try{const x=await Ae.analytics.exportCampaign(J.dbCampaign.id),w=URL.createObjectURL(x),C=document.createElement("a");C.href=w,C.download=`campaign-${J.name}-${new Date().toISOString().split("T")[0]}.csv`,C.click(),c.success("Campaign exported!")}catch{c.error("Export failed")}},className:"flex-1 px-4 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold flex items-center justify-center gap-2",children:[e.jsx(ds,{className:"w-5 h-5"}),"Export Data"]})]})]})]})})]}),document.body):null},wo=yo,Ma="whatsapp_campaign_templates";function Bt(){try{const o=localStorage.getItem(Ma);if(!o)return console.log("ğŸ“‹ No templates found in storage"),[];const n=JSON.parse(o).sort((l,i)=>i.useCount!==l.useCount?i.useCount-l.useCount:l.lastUsed&&i.lastUsed?new Date(i.lastUsed).getTime()-new Date(l.lastUsed).getTime():l.lastUsed?-1:i.lastUsed?1:new Date(i.createdAt).getTime()-new Date(l.createdAt).getTime());return console.log(`âœ… Loaded ${n.length} template(s) from storage`),n}catch(o){return console.error("âŒ Error loading templates:",o),[]}}function _a(o){const t=Bt(),n={...o,id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,createdAt:new Date().toISOString(),useCount:0};return t.push(n),localStorage.setItem(Ma,JSON.stringify(t)),n.id}function hn(o,t){const n=Bt(),l=n.findIndex(i=>i.id===o);return l===-1?!1:(n[l]={...n[l],...t},localStorage.setItem(Ma,JSON.stringify(n)),!0)}function jo(o){const t=Bt(),n=t.filter(l=>l.id!==o);return n.length===t.length?!1:(localStorage.setItem(Ma,JSON.stringify(n)),!0)}function No(o){return Bt().find(n=>n.id===o)||null}function vo(o){const t=No(o);t&&hn(o,{useCount:t.useCount+1,lastUsed:new Date().toISOString()})}const So=({isOpen:o,onClose:t,onLoadTemplate:n,currentCampaignData:l})=>{var Se;const[i,d]=m.useState([]),[p,T]=m.useState(!1),[v,L]=m.useState(""),[G,$]=m.useState("all"),[E,k]=m.useState(new Set),[U,ae]=m.useState(!1),[K,P]=m.useState(!1),[z,se]=m.useState(!1),[Q,Y]=m.useState(!1),[me,X]=m.useState(null),[ge,Ce]=m.useState(""),[Me,He]=m.useState(null),[J,$e]=m.useState({name:"",message:"",messageType:"text",category:"promotional",settings:{usePersonalization:!0,randomDelay:!0,minDelay:3,maxDelay:10,usePresence:!0,batchSize:10,batchDelay:5,maxPerHour:50,dailyLimit:200,skipRecentlyContacted:!1,respectQuietHours:!1,useInvisibleChars:!1,useEmojiVariation:!1,varyMessageLength:!1,viewOnce:!1,pollQuestion:"",pollOptions:[],allowMultiSelect:!1}}),De=[{id:"all",name:"All Templates",icon:"ğŸ“‹"},{id:"promotional",name:"Promotional",icon:"ğŸ"},{id:"onboarding",name:"Onboarding",icon:"ğŸ‘‹"},{id:"reminder",name:"Reminders",icon:"â°"},{id:"support",name:"Support",icon:"ğŸ†˜"},{id:"announcement",name:"Announcements",icon:"ğŸ“¢"}];m.useEffect(()=>{o&&(_(),W())},[o]);const _=()=>{T(!0);try{const h=Bt();d(h),console.log(`ğŸ“‹ Fetched ${h.length} template(s)`),h.length===0&&console.log("ğŸ’¡ No templates found. Create your first template to get started!")}catch(h){console.error("âŒ Error fetching templates:",h),c.error("Failed to load templates"),d([])}finally{T(!1)}},W=()=>{const h=localStorage.getItem("campaign_templates_favorites");h&&k(new Set(JSON.parse(h)))},he=h=>{localStorage.setItem("campaign_templates_favorites",JSON.stringify([...h])),k(h)},Ge=h=>{const ce=new Set(E);ce.has(h)?ce.delete(h):ce.add(h),he(ce)},j=()=>{if(!l){c.error("No campaign data to save");return}if(!ge.trim()){c.error("Please enter a template name");return}try{_a({name:ge,message:l.message,messageType:l.messageType,settings:l.settings}),c.success("Template saved successfully!"),Ce(""),ae(!1),_()}catch(h){console.error("Error saving template:",h),c.error("Failed to save template")}},R=()=>{var h;if(!J.name.trim()){c.error("Please enter a template name");return}if(J.messageType==="text"&&!J.message.trim()){c.error("Please enter a message");return}if(J.messageType==="poll"){if(!((h=J.settings.pollQuestion)!=null&&h.trim())){c.error("Please enter a poll question");return}if(!J.settings.pollOptions||J.settings.pollOptions.length<2){c.error("Please add at least 2 poll options");return}}try{_a({name:J.name,message:J.message,messageType:J.messageType,settings:J.settings}),c.success("Template created successfully!"),oe(),P(!1),_()}catch(ce){console.error("Error creating template:",ce),c.error("Failed to create template")}},V=()=>{var h;if(Me){if(!J.name.trim()){c.error("Please enter a template name");return}if(J.messageType==="text"&&!J.message.trim()){c.error("Please enter a message");return}if(J.messageType==="poll"){if(!((h=J.settings.pollQuestion)!=null&&h.trim())){c.error("Please enter a poll question");return}if(!J.settings.pollOptions||J.settings.pollOptions.length<2){c.error("Please add at least 2 poll options");return}}try{hn(Me.id,{name:J.name,message:J.message,messageType:J.messageType,settings:J.settings}),c.success("Template updated successfully!"),oe(),se(!1),He(null),_()}catch(ce){console.error("Error updating template:",ce),c.error("Failed to update template")}}},Z=h=>{He(h),$e({name:h.name,message:h.message,messageType:h.messageType,category:"promotional",settings:{...h.settings}}),se(!0)},te=()=>{oe(),P(!0)},oe=()=>{$e({name:"",message:"",messageType:"text",category:"promotional",settings:{usePersonalization:!0,randomDelay:!0,minDelay:3,maxDelay:10,usePresence:!0,batchSize:10,batchDelay:5,maxPerHour:50,dailyLimit:200,skipRecentlyContacted:!1,respectQuietHours:!1,useInvisibleChars:!1,useEmojiVariation:!1,varyMessageLength:!1,viewOnce:!1,pollQuestion:"",pollOptions:[],allowMultiSelect:!1}})},x=h=>{X(h),Y(!0)},w=h=>{try{_a({name:`${h.name} (Copy)`,message:h.message,messageType:h.messageType,settings:h.settings}),c.success("Template duplicated!"),_()}catch(ce){console.error("Error duplicating template:",ce),c.error("Failed to duplicate template")}},C=()=>{try{const h=JSON.stringify(i,null,2),ce=new Blob([h],{type:"application/json"}),be=URL.createObjectURL(ce),Je=document.createElement("a");Je.href=be,Je.download=`campaign-templates-${new Date().toISOString().split("T")[0]}.json`,Je.click(),URL.revokeObjectURL(be),c.success("Templates exported successfully!")}catch(h){console.error("Error exporting templates:",h),c.error("Failed to export templates")}},b=h=>{var Je;const ce=(Je=h.target.files)==null?void 0:Je[0];if(!ce)return;const be=new FileReader;be.onload=Pa=>{var na;try{const Es=JSON.parse((na=Pa.target)==null?void 0:na.result);if(!Array.isArray(Es)){c.error("Invalid template file format");return}let Gt=0;Es.forEach(ws=>{try{_a({name:ws.name||"Imported Template",message:ws.message||"",messageType:ws.messageType||"text",settings:ws.settings||{}}),Gt++}catch(Aa){console.error("Error importing template:",Aa)}}),c.success(`Imported ${Gt} template(s)!`),_()}catch(Es){console.error("Error parsing import file:",Es),c.error("Failed to import templates. Invalid file format.")}},be.readAsText(ce),h.target.value=""},S=h=>{vo(h.id),n(h),t(),c.success(`Template "${h.name}" loaded!`)},N=h=>{if(window.confirm("Delete this template?")){jo(h);const ce=new Set(E);ce.delete(h),he(ce),_(),c.success("Template deleted")}},ee=i.filter(h=>(h.name.toLowerCase().includes(v.toLowerCase())||h.message.toLowerCase().includes(v.toLowerCase()))&&G==="all"),ie=ee.filter(h=>E.has(h.id));return o?Ta.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:[e.jsx(at,{className:"w-8 h-8"}),"Campaign Templates"]}),e.jsx("p",{className:"text-purple-100",children:"Organize and reuse your best campaign configurations"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:te,className:"flex items-center gap-2 px-4 py-2 bg-white text-purple-600 rounded-lg font-semibold hover:shadow-lg transition-all",children:[e.jsx(Lt,{className:"w-5 h-5"}),"New Template"]}),l&&e.jsxs("button",{onClick:()=>ae(!0),className:"flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg font-medium transition-colors",children:[e.jsx(ur,{className:"w-4 h-4"}),"Save Current"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".json",onChange:b,className:"hidden",id:"import-templates"}),e.jsxs("label",{htmlFor:"import-templates",className:"flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg font-medium cursor-pointer transition-colors",children:[e.jsx(Ds,{className:"w-4 h-4"}),"Import"]})]}),e.jsxs("button",{onClick:C,className:"flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg font-medium transition-colors",children:[e.jsx(ds,{className:"w-4 h-4"}),"Export"]}),e.jsxs("button",{onClick:()=>{_(),W(),c.success("Templates refreshed!")},className:"flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg font-medium transition-colors",title:"Refresh templates",children:[e.jsx(rs,{className:"w-4 h-4"}),"Refresh"]}),e.jsx("button",{onClick:t,className:"p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors",children:e.jsx(Te,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"mt-4 relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:v,onChange:h=>L(h.target.value),placeholder:"Search templates...",className:"w-full pl-10 pr-4 py-3 rounded-lg text-gray-900 focus:outline-none"})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex",children:[e.jsxs("div",{className:"w-64 bg-gray-50 border-r-2 border-gray-200 p-4 overflow-y-auto",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-600 mb-3 uppercase",children:"Categories"}),e.jsx("div",{className:"space-y-1",children:De.map(h=>e.jsxs("button",{onClick:()=>$(h.id),className:`w-full text-left px-3 py-2 rounded-lg font-medium transition-all ${G===h.id?"bg-purple-600 text-white shadow-md":"text-gray-700 hover:bg-gray-200"}`,children:[e.jsx("span",{className:"mr-2",children:h.icon}),h.name]},h.id))}),e.jsx("div",{className:"mt-6 p-3 bg-white rounded-lg border-2 border-gray-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:p?"...":i.length}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Templates"}),i.length>0&&e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:[i.reduce((h,ce)=>h+ce.useCount,0)," total uses"]})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:p?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(rs,{className:"w-8 h-8 text-purple-600 animate-spin"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading templates..."})]}):e.jsxs(e.Fragment,{children:[ie.length>0&&G==="all"&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(gr,{className:"w-5 h-5 text-yellow-500 fill-yellow-500"}),"Favorites"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:ie.map(h=>e.jsx(an,{template:h,isFavorite:E.has(h.id),onSelect:()=>S(h),onToggleFavorite:()=>Ge(h.id),onPreview:()=>x(h),onEdit:()=>Z(h),onDuplicate:()=>w(h),onDelete:()=>N(h.id)},h.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-3",children:G==="all"?"All Templates":(Se=De.find(h=>h.id===G))==null?void 0:Se.name}),ee.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:ee.map(h=>e.jsx(an,{template:h,isFavorite:E.has(h.id),onSelect:()=>S(h),onToggleFavorite:()=>Ge(h.id),onPreview:()=>x(h),onEdit:()=>Z(h),onDuplicate:()=>w(h),onDelete:()=>N(h.id)},h.id))}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300",children:[e.jsx(at,{className:"w-12 h-12 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-600",children:v?"No templates match your search":"No templates found"}),!v&&e.jsx("button",{onClick:te,className:"mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium",children:"Create Your First Template"})]})]})]})})]})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-md",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Save Template"}),e.jsx("input",{type:"text",value:ge,onChange:h=>Ce(h.target.value),placeholder:"Template name...",className:"w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none mb-4",autoFocus:!0,onKeyPress:h=>h.key==="Enter"&&j()}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:j,className:"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium",children:"Save"}),e.jsx("button",{onClick:()=>{ae(!1),Ce("")},className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Cancel"})]})]})}),(K||z)&&e.jsx(ko,{isEdit:z,templateForm:J,setTemplateForm:$e,onSave:z?V:R,onClose:()=>{P(!1),se(!1),He(null),oe()}}),Q&&me&&e.jsx(_o,{template:me,onLoad:()=>{S(me),Y(!1)},onClose:()=>{Y(!1),X(null)}})]}),document.body):null};function an({template:o,isFavorite:t,onSelect:n,onToggleFavorite:l,onPreview:i,onEdit:d,onDuplicate:p,onDelete:T}){var L;const v=((L=o.message.match(/\{(\w+)\}/g))==null?void 0:L.map(G=>G.slice(1,-1)))||[];return e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-purple-300 hover:shadow-md transition-all",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h4",{className:"font-bold text-gray-900 flex-1",children:o.name}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:G=>{G.stopPropagation(),l()},className:"p-1 hover:bg-gray-100 rounded transition-colors",children:e.jsx(gr,{className:`w-4 h-4 ${t?"text-yellow-500 fill-yellow-500":"text-gray-400"}`})}),e.jsx("button",{onClick:G=>{G.stopPropagation(),T()},className:"p-1 hover:bg-red-50 rounded transition-colors text-red-600",children:e.jsx(ys,{className:"w-4 h-4"})})]})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3 line-clamp-2",children:o.message}),e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(un,{className:"w-3 h-3"}),o.useCount," uses"]}),v.length>0&&e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded",children:[v.length," variables"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3"}),new Date(o.createdAt).toLocaleDateString()]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:n,className:"flex-1 px-3 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors",children:"Use Template"}),e.jsx("button",{onClick:i,className:"px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors",title:"Preview",children:e.jsx(yt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:d,className:"px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors",title:"Edit",children:e.jsx(gn,{className:"w-4 h-4"})}),e.jsx("button",{onClick:p,className:"px-3 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors",title:"Duplicate",children:e.jsx(Xt,{className:"w-4 h-4"})})]})]})}function ko({isEdit:o,templateForm:t,setTemplateForm:n,onSave:l,onClose:i}){var d;return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white rounded-t-2xl",children:e.jsx("h3",{className:"text-2xl font-bold",children:o?"Edit Template":"Create New Template"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-bold text-gray-900 mb-2",children:["Template Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:t.name,onChange:p=>n({...t,name:p.target.value}),placeholder:"e.g., Summer Sale Message, Welcome Image, Product Poll",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none",maxLength:100}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[t.name.length,"/100 characters"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-900 mb-2",children:"Message Type"}),e.jsxs("select",{value:t.messageType,onChange:p=>n({...t,messageType:p.target.value}),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none",children:[e.jsx("option",{value:"text",children:"ğŸ’¬ Text Message"}),e.jsx("option",{value:"image",children:"ğŸ–¼ï¸ Image Message"}),e.jsx("option",{value:"video",children:"ğŸ¥ Video Message"}),e.jsx("option",{value:"document",children:"ğŸ“„ Document Message"}),e.jsx("option",{value:"audio",children:"ğŸµ Audio Message"}),e.jsx("option",{value:"poll",children:"ğŸ“Š Poll Message"})]}),t.messageType!=="text"&&t.messageType!=="poll"&&e.jsx("p",{className:"text-xs text-purple-600 mt-1 font-medium",children:"â„¹ï¸ Media will be selected when you use this template in a campaign"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-900 mb-2",children:t.messageType==="text"?e.jsxs(e.Fragment,{children:["Template Content ",e.jsx("span",{className:"text-red-500",children:"*"})]}):t.messageType==="image"?e.jsxs(e.Fragment,{children:["Image Caption ",e.jsx("span",{className:"text-gray-500 text-xs font-normal",children:"(Optional)"})]}):t.messageType==="video"?e.jsxs(e.Fragment,{children:["Video Caption ",e.jsx("span",{className:"text-gray-500 text-xs font-normal",children:"(Optional)"})]}):t.messageType==="document"?e.jsxs(e.Fragment,{children:["Document Caption ",e.jsx("span",{className:"text-gray-500 text-xs font-normal",children:"(Optional)"})]}):e.jsxs(e.Fragment,{children:["Message Content ",e.jsx("span",{className:"text-red-500",children:"*"})]})}),e.jsx("textarea",{value:t.message,onChange:p=>n({...t,message:p.target.value}),placeholder:t.messageType==="text"?"Your message here... Use {name}, {phone}, {date}, {time} for variables":t.messageType==="image"?"Image caption (optional)... Use {name}, {phone}, {date}, {time} for variables":t.messageType==="video"?"Video caption (optional)... Use {name}, {phone}, {date}, {time} for variables":t.messageType==="document"?"Document caption (optional)... Use {name}, {phone}, {date}, {time} for variables":"Your message here... Use {name}, {phone}, {date}, {time} for variables",rows:t.messageType==="text"?6:4,className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none resize-none"}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("p",{className:"text-xs text-gray-600",children:t.messageType==="text"?e.jsxs(e.Fragment,{children:["Tip: Use ","{name}",", ","{phone}",", ","{date}",", ","{time}"," for personalization"]}):t.messageType==="image"?e.jsx(e.Fragment,{children:"ğŸ’¡ For image templates: Select media when using this template. This field is for the caption."}):t.messageType==="video"?e.jsx(e.Fragment,{children:"ğŸ’¡ For video templates: Select media when using this template. This field is for the caption."}):t.messageType==="document"?e.jsx(e.Fragment,{children:"ğŸ’¡ For document templates: Select media when using this template. This field is for the caption."}):e.jsxs(e.Fragment,{children:["Tip: Use ","{name}",", ","{phone}",", ","{date}",", ","{time}"," for personalization"]})}),t.messageType==="text"&&e.jsxs("span",{className:`text-xs font-medium ${t.message.length>1e3?"text-red-600":t.message.length>800?"text-yellow-600":"text-gray-500"}`,children:[t.message.length," / 1024"]})]})]}),t.messageType==="poll"&&e.jsxs("div",{className:"space-y-3 p-4 bg-blue-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-900 mb-2",children:"Poll Question"}),e.jsx("input",{type:"text",value:t.settings.pollQuestion||"",onChange:p=>n({...t,settings:{...t.settings,pollQuestion:p.target.value}}),placeholder:"Enter poll question",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-900 mb-2",children:"Poll Options (one per line)"}),e.jsx("textarea",{value:((d=t.settings.pollOptions)==null?void 0:d.join(`
`))||"",onChange:p=>n({...t,settings:{...t.settings,pollOptions:p.target.value.split(`
`).filter(T=>T.trim())}}),placeholder:`Option 1
Option 2
Option 3`,rows:4,className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:t.settings.allowMultiSelect||!1,onChange:p=>n({...t,settings:{...t.settings,allowMultiSelect:p.target.checked}}),className:"rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow multiple selections"})]})]})]}),e.jsxs("div",{className:"border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-end gap-3",children:[e.jsx("button",{onClick:i,className:"px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:l,className:"px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all",children:o?"Update Template":"Save Template"})]})]})})}function _o({template:o,onLoad:t,onClose:n}){var i;const l=((i=o.message.match(/\{(\w+)\}/g))==null?void 0:i.map(d=>d.slice(1,-1)))||[];return e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100000] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-2xl font-bold",children:"Template Preview"}),e.jsx("button",{onClick:n,className:"w-8 h-8 flex items-center justify-center bg-gray-200 hover:bg-gray-300 rounded-full",children:e.jsx(Te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:o.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Message Type"}),e.jsx("p",{className:"text-gray-900 capitalize",children:o.messageType})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Message"}),e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsx("p",{className:"text-gray-900 whitespace-pre-wrap",children:o.message})})]}),l.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Variables"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:l.map((d,p)=>e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm",children:["{",d,"}"]},p))})]}),o.messageType==="poll"&&e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Poll Details"}),o.settings.pollQuestion&&e.jsx("p",{className:"font-semibold mb-2",children:o.settings.pollQuestion}),o.settings.pollOptions&&o.settings.pollOptions.length>0&&e.jsx("ul",{className:"list-disc list-inside space-y-1",children:o.settings.pollOptions.map((d,p)=>e.jsx("li",{className:"text-gray-700",children:d},p))}),o.settings.allowMultiSelect&&e.jsx("p",{className:"text-xs text-gray-600 mt-2",children:"Multiple selections allowed"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(un,{className:"w-3 h-3"}),"Used ",o.useCount," times"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3"}),"Created ",new Date(o.createdAt).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsx("button",{onClick:t,className:"flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium",children:"Load Template"}),e.jsx("button",{onClick:n,className:"flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Close"})]})]})]})})}const Co=So,$a="whatsapp_scheduled_campaigns";function Ot(){try{const o=localStorage.getItem($a);return o?JSON.parse(o):[]}catch(o){return console.error("Error loading scheduled campaigns:",o),[]}}function Do(){const o=Ot(),t=new Date;return o.filter(n=>n.status!=="pending"?!1:new Date(n.scheduledFor)<=t)}function Eo(o,t,n,l,i,d,p){const T=Ot(),v={id:`scheduled_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:o,scheduledFor:t,timezone:n,message:l,messageType:i,selectedRecipients:d,settings:p,status:"pending",createdAt:new Date().toISOString()};return T.push(v),localStorage.setItem($a,JSON.stringify(T)),v.id}function xr(o,t,n,l){const i=Ot(),d=i.findIndex(p=>p.id===o);return d===-1?!1:(i[d]={...i[d],status:t,...n&&{startedAt:n},...l&&{completedAt:l}},localStorage.setItem($a,JSON.stringify(i)),!0)}function To(o){return xr(o,"cancelled")}function Mo(o){const t=Ot(),n=t.filter(l=>l.id!==o);return n.length===t.length?!1:(localStorage.setItem($a,JSON.stringify(n)),!0)}const $o=({isOpen:o,onClose:t,onLoadCampaign:n})=>{const[l,i]=m.useState([]),[d,p]=m.useState(""),[T,v]=m.useState("all");m.useEffect(()=>{if(o){L();const k=setInterval(L,3e4);return()=>clearInterval(k)}},[o]);const L=()=>{const k=Ot();i(k)},G=l.filter(k=>{const U=k.name.toLowerCase().includes(d.toLowerCase())||k.message.toLowerCase().includes(d.toLowerCase()),ae=T==="all"||k.status===T;return U&&ae}),$=k=>{switch(k){case"pending":return e.jsxs("span",{className:"px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Le,{className:"w-3 h-3"}),"Pending"]});case"running":return e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(dr,{className:"w-3 h-3"}),"Running"]});case"completed":return e.jsxs("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(aa,{className:"w-3 h-3"}),"Completed"]});case"cancelled":return e.jsxs("span",{className:"px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(Da,{className:"w-3 h-3"}),"Cancelled"]})}},E=k=>{const U=new Date(k),ae=new Date,K=U.getTime()-ae.getTime();if(K<0)return"Past due";const P=Math.floor(K/(1e3*60*60*24)),z=Math.floor(K%(1e3*60*60*24)/(1e3*60*60)),se=Math.floor(K%(1e3*60*60)/(1e3*60));return P>0?`In ${P} day${P!==1?"s":""}`:z>0?`In ${z} hour${z!==1?"s":""}`:`In ${se} minute${se!==1?"s":""}`};return o?Ta.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-orange-600 to-red-600 text-white flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(Ls,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Scheduled Campaigns"}),e.jsx("p",{className:"text-orange-100 text-sm",children:"Manage campaigns scheduled for later"})]})]}),e.jsx("button",{onClick:t,className:"w-10 h-10 flex items-center justify-center bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full transition-colors",children:e.jsx(Te,{className:"w-5 h-5"})})]})}),e.jsx("div",{className:"p-4 bg-gray-50 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search scheduled campaigns...",value:d,onChange:k=>p(k.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})]})}),e.jsxs("select",{value:T,onChange:k=>v(k.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"running",children:"Running"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:G.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ls,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No scheduled campaigns"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:d||T!=="all"?"Try adjusting your filters":"Schedule campaigns from the Bulk Send modal"})]}):e.jsx("div",{className:"space-y-4",children:G.map(k=>e.jsx("div",{className:"bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("h3",{className:"font-bold text-gray-900",children:k.name}),$(k.status)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{className:"w-4 h-4"}),new Date(k.scheduledFor).toLocaleString()]}),e.jsx("span",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-orange-600 font-medium",children:k.status==="pending"?E(k.scheduledFor):"Executed"})}),e.jsxs("span",{className:"flex items-center gap-1",children:[k.selectedRecipients.length," recipients"]})]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2 line-clamp-2",children:[k.message.substring(0,150),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{window.confirm("Start this campaign now?")&&(n(k),xr(k.id,"running",new Date().toISOString()),t())},className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-1",children:[e.jsx(dr,{className:"w-4 h-4"}),"Start Now"]}),e.jsx("button",{onClick:()=>{window.confirm("Cancel this scheduled campaign?")&&(To(k.id),L(),c.success("Campaign cancelled"))},className:"px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium",children:e.jsx(Te,{className:"w-4 h-4"})})]}),k.status!=="pending"&&e.jsx("button",{onClick:()=>{Mo(k.id),L(),c.success("Scheduled campaign deleted")},className:"px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium",children:e.jsx(ys,{className:"w-4 h-4"})})]})]})},k.id))})}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[G.length," scheduled campaign",G.length!==1?"s":""]}),e.jsx("button",{onClick:t,className:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Close"})]})})]})}),document.body):null},Po=$o,Ao=({onNewMessage:o,onBulkSend:t,onCampaignManagement:n,onTemplates:l,onScheduled:i,onBlacklist:d,onMediaLibrary:p,onSessionManagement:T,onAutomation:v,onRefresh:L,onResumeCampaign:G,refreshing:$=!1,hasDraft:E=!1,pausedCampaignState:k,unreadCount:U=0,conversationsCount:ae=0})=>{const[K,P]=m.useState(!1),z=m.useRef(null);return m.useEffect(()=>{const se=Q=>{z.current&&!z.current.contains(Q.target)&&P(!1)};return K&&document.addEventListener("mousedown",se),()=>{document.removeEventListener("mousedown",se)}},[K]),e.jsx("div",{className:"fixed right-0 z-10 bg-gradient-to-b from-slate-50/95 via-white/90 to-white/95 backdrop-blur-3xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border-b-2 border-slate-200/60 rounded-b-3xl transition-[left] duration-500",style:{left:"var(--sidebar-width, 0px)",top:"var(--app-topbar-height, 64px)",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(148, 163, 184, 0.1) inset"},children:e.jsx("div",{className:"px-4 sm:px-6 py-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[k&&G&&e.jsxs("button",{onClick:G,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg hover:from-green-600 hover:to-emerald-700",children:[e.jsx(Cs,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Resume"})]}),o&&e.jsxs("button",{onClick:o,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg hover:from-green-600 hover:to-emerald-700",title:"Send new message",children:[e.jsx(fs,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"New Message"})]}),t&&e.jsxs("button",{onClick:t,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg hover:from-blue-600 hover:to-blue-700 relative",title:E?"Send bulk messages (Draft available)":"Send bulk messages",children:[e.jsx(It,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Bulk Send"}),E&&e.jsx("span",{className:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-green-300 rounded-full border-2 border-white animate-pulse",title:"Draft saved"})]}),n&&e.jsxs("button",{onClick:n,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-lg hover:from-indigo-600 hover:to-indigo-700",title:"Manage campaigns",children:[e.jsx(Cs,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Campaigns"})]}),l&&e.jsxs("button",{onClick:l,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg hover:from-purple-600 hover:to-purple-700",title:"Campaign templates",children:[e.jsx(Zt,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Templates"})]}),i&&e.jsxs("button",{onClick:i,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-orange-500 to-amber-600 text-white shadow-lg hover:from-orange-600 hover:to-amber-700",title:"Scheduled campaigns",children:[e.jsx(Ls,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Scheduled"})]}),d&&e.jsxs("button",{onClick:d,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg hover:from-red-600 hover:to-red-700",title:"Manage blacklist",children:[e.jsx(rt,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Blacklist"})]}),p&&e.jsxs("button",{onClick:p,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg hover:from-gray-600 hover:to-gray-700",title:"Media library",children:[e.jsx(Ds,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Media"})]}),e.jsxs("div",{className:"relative",ref:z,children:[e.jsxs("button",{onClick:()=>P(!K),className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg hover:from-gray-600 hover:to-gray-700",title:"Settings",children:[e.jsx(Ca,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"Settings"})]}),K&&e.jsxs("div",{className:"absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 z-50",children:[v&&e.jsxs("button",{onClick:()=>{P(!1),v()},className:"w-full flex items-center gap-3 px-4 py-3 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",title:"Manage WhatsApp automation",children:[e.jsx(ra,{size:18,className:"text-yellow-600"}),e.jsx("span",{children:"Automation"})]}),T&&e.jsxs("button",{onClick:()=>{P(!1),T()},className:"w-full flex items-center gap-3 px-4 py-3 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",title:"Manage WhatsApp sessions",children:[e.jsx(sa,{size:18,className:"text-indigo-600"}),e.jsx("span",{children:"Sessions"})]})]})]}),L&&e.jsxs("button",{onClick:L,disabled:$,className:"flex items-center gap-2 px-6 py-3 font-semibold text-sm rounded-xl transition-all duration-200 bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg hover:from-gray-600 hover:to-gray-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:from-gray-500 disabled:hover:to-gray-600",title:"Refresh messages",children:[e.jsx(rs,{size:18,className:$?"animate-spin":""}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]})]}),(ae>0||U>0)&&e.jsxs("div",{className:"flex items-center gap-3",children:[ae>0&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-slate-100/80 backdrop-blur-sm rounded-xl border border-slate-200/50 shadow-sm",children:[e.jsx(Ea,{size:16,className:"text-slate-700"}),e.jsxs("span",{className:"text-sm font-semibold text-slate-700",children:[ae," conversations"]})]}),U>0&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-slate-100/80 backdrop-blur-sm rounded-xl border border-slate-200/50 shadow-sm",children:[e.jsx("span",{className:"w-2 h-2 bg-emerald-500 rounded-full animate-pulse"}),e.jsxs("span",{className:"text-sm font-semibold text-slate-700",children:[U," new"]})]})]})]})})})},Ro=Ao,Io=({isOpen:o,onClose:t})=>{const[n,l]=m.useState(!1),[i,d]=m.useState(!1),[p,T]=m.useState([]),[v,L]=m.useState(""),[G,$]=m.useState([{id:"installment-due",name:"Installment Payment Due",description:"Notify when installment payments are due",enabled:!1,settingKey:"installment_due_notifications"},{id:"installment-overdue",name:"Installment Overdue",description:"Notify when installment payments are overdue",enabled:!1,settingKey:"installment_overdue_notifications"},{id:"inventory-low",name:"Low Stock Alerts",description:"Notify when inventory items are low on stock",enabled:!1,settingKey:"inventory_low_stock_notifications"},{id:"inventory-out",name:"Out of Stock Alerts",description:"Notify when items are completely out of stock",enabled:!1,settingKey:"inventory_out_of_stock_notifications"},{id:"sale-receipt",name:"Sale Receipts",description:"Automatically send receipts after sales",enabled:!1,settingKey:"sale_receipt_notifications"},{id:"payment-received",name:"Payment Received",description:"Notify when payments are received",enabled:!1,settingKey:"payment_received_notifications"}]);Zl(o),m.useEffect(()=>{o&&E()},[o]);const E=async()=>{l(!0);try{const{data:P}=await H.from("admin_settings").select("setting_value").eq("category","whatsapp_automation").eq("setting_key","notification_phones").single();if(P!=null&&P.setting_value)try{const Q=JSON.parse(P.setting_value);Array.isArray(Q)&&T(Q)}catch(Q){console.warn("Error parsing phone numbers:",Q)}if(p.length===0){const{data:Q}=await H.from("business_info").select("phone, whatsapp").single(),Y=[];Q!=null&&Q.phone&&Y.push(Q.phone),Q!=null&&Q.whatsapp&&Q.whatsapp!==Q.phone&&Y.push(Q.whatsapp),Y.length>0&&T(Y)}const{data:z}=await H.from("admin_settings").select("setting_key, setting_value").eq("category","whatsapp_automation");if(z){const Q=new Map(z.map(Y=>[Y.setting_key,Y.setting_value==="true"]));$(Y=>Y.map(me=>({...me,enabled:Q.get(me.settingKey)||!1})))}const se=await Xl();$(Q=>Q.map(Y=>Y.settingKey==="inventory_low_stock_notifications"?{...Y,enabled:se.low_stock_alerts||!1}:Y.settingKey==="inventory_out_of_stock_notifications"?{...Y,enabled:se.out_of_stock_alerts||!1}:Y))}catch(P){console.error("Error loading automation settings:",P),c.error("Failed to load settings")}finally{l(!1)}},k=async()=>{if(p.length===0){c.error("Please add at least one phone number");return}d(!0);try{const P=JSON.stringify(p),{data:z}=await H.from("admin_settings").select("id").eq("category","whatsapp_automation").eq("setting_key","notification_phones").single();z?await H.from("admin_settings").update({setting_value:P,updated_at:new Date().toISOString()}).eq("category","whatsapp_automation").eq("setting_key","notification_phones"):await H.from("admin_settings").insert({category:"whatsapp_automation",setting_key:"notification_phones",setting_value:P,setting_type:"string",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});for(const se of G){const{data:Q}=await H.from("admin_settings").select("id").eq("category","whatsapp_automation").eq("setting_key",se.settingKey).single();Q?await H.from("admin_settings").update({setting_value:se.enabled.toString(),setting_type:"boolean",updated_at:new Date().toISOString()}).eq("category","whatsapp_automation").eq("setting_key",se.settingKey):await H.from("admin_settings").insert({category:"whatsapp_automation",setting_key:se.settingKey,setting_value:se.enabled.toString(),setting_type:"boolean",is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),se.settingKey==="inventory_low_stock_notifications"&&await ir("low_stock_alerts",se.enabled),se.settingKey==="inventory_out_of_stock_notifications"&&await ir("out_of_stock_alerts",se.enabled),(se.settingKey==="inventory_low_stock_notifications"||se.settingKey==="inventory_out_of_stock_notifications")&&await ir("whatsapp_notifications",se.enabled)}c.success("Automation settings saved successfully!"),t()}catch(P){console.error("Error saving automation settings:",P),c.error("Failed to save settings")}finally{d(!1)}},U=()=>{if(!v.trim()){c.error("Please enter a phone number");return}const P=v.trim().replace(/\D/g,"");if(P.length<10){c.error("Please enter a valid phone number");return}const z=v.trim().startsWith("+")?v.trim():`+${P}`;if(p.includes(z)){c.error("This phone number is already added");return}T([...p,z]),L(""),c.success("Phone number added")},ae=P=>{T(p.filter((z,se)=>se!==P)),c.success("Phone number removed")},K=P=>{$(G.map(z=>z.id===P?{...z,enabled:!z.enabled}:z))};return o?Ta.createPortal(e.jsx(e.Fragment,{children:e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[99999]",style:{top:0,left:0,right:0,bottom:0,overflow:"hidden",overscrollBehavior:"none"},role:"dialog","aria-modal":"true","aria-labelledby":"automation-modal-title",onClick:t,children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",style:{pointerEvents:"auto"},onClick:P=>P.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:t,disabled:i||n,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(Te,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(ra,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",id:"automation-modal-title",children:"WhatsApp Automation"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Manage automated WhatsApp notifications"})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:n?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Notification Recipients"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Phone numbers that will receive WhatsApp notifications"}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("input",{type:"tel",value:v,onChange:P=>L(P.target.value),onKeyPress:P=>P.key==="Enter"&&U(),placeholder:"+255 123 456 789",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"}),e.jsxs("button",{onClick:U,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(Lt,{className:"w-4 h-4"}),"Add"]})]}),e.jsx("div",{className:"space-y-2",children:p.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(bt,{className:"w-12 h-12 mx-auto mb-2 text-gray-400"}),e.jsx("p",{className:"text-sm",children:"No phone numbers added yet"})]}):p.map((P,z)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(bt,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:P})]}),e.jsx("button",{onClick:()=>ae(z),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:e.jsx(ys,{className:"w-4 h-4"})})]},z))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Automation Types"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Choose which notifications to send automatically"}),e.jsx("div",{className:"space-y-3",children:G.map(P=>e.jsxs("label",{className:"flex items-start gap-3 p-4 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50/50 transition-colors cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:P.enabled,onChange:()=>K(P.id),className:"mt-1 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900",children:P.name}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:P.description})]}),P.enabled&&e.jsx(zl,{className:"w-5 h-5 text-green-600"})]},P.id))})]})]})}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200 flex-shrink-0 bg-white px-6 pb-6",children:[e.jsx("button",{type:"button",onClick:t,disabled:i||n,className:"flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),e.jsx("button",{type:"button",onClick:k,disabled:i||n||p.length===0,className:"flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ur,{className:"w-5 h-5"}),"Save Settings"]})})]})]})})}),document.body):null},Uo=Io;let hr=null,ea=0;const Lo=2e4;async function pn(o){try{const t=o.selectedRecipients.map(l=>{var d;const i=o.conversations.find(p=>p.phone===l);return{phone:l,name:(i==null?void 0:i.customer_name)||"Unknown",sent:o.sentPhones.includes(l),success:o.sentPhones.includes(l),error:((d=o.failedMessages.find(p=>p.phone===l))==null?void 0:d.error)||null}}),n=await Ae.campaign.create({name:o.name||`Campaign ${new Date().toLocaleDateString()}`,message:o.message,message_type:o.messageType,status:"active",total_recipients:o.selectedRecipients.length,sent_count:o.bulkProgress.current,success_count:o.bulkProgress.success,failed_count:o.bulkProgress.failed,replied_count:0,recipients_data:t,started_at:o.campaignStartTime?new Date(o.campaignStartTime).toISOString():new Date().toISOString(),completed_at:null,duration_seconds:o.campaignStartTime?Math.floor((Date.now()-o.campaignStartTime)/1e3):0,settings:o.settings});return hr=n.id,console.log(`âœ… Campaign created in DB with ID: ${n.id}`),n.id}catch(t){return console.error("âŒ Failed to create campaign in DB:",t),null}}async function Fo(o,t){if(!o)return;const n=Date.now(),l=n-ea,i=t.bulkProgress.current-(ea>0?Math.floor(ea/1e3):0);if(!(l<Lo&&i<10))try{const d=t.selectedRecipients.map(p=>{var v;const T=t.conversations.find(L=>L.phone===p);return{phone:p,name:(T==null?void 0:T.customer_name)||"Unknown",sent:t.sentPhones.includes(p),success:t.sentPhones.includes(p),error:((v=t.failedMessages.find(L=>L.phone===p))==null?void 0:v.error)||null}});await Ae.campaign.update(o,{sent_count:t.bulkProgress.current,success_count:t.bulkProgress.success,failed_count:t.bulkProgress.failed,recipients_data:d,duration_seconds:t.campaignStartTime?Math.floor((Date.now()-t.campaignStartTime)/1e3):0}),ea=n,console.log(`ğŸ’¾ Campaign progress saved (${t.bulkProgress.current}/${t.bulkProgress.total})`)}catch(d){console.error("âŒ Failed to update campaign progress:",d)}}async function Bo(o,t,n){if(!o){await pn(t);return}try{const l=t.selectedRecipients.map(d=>{var T;const p=t.conversations.find(v=>v.phone===d);return{phone:d,name:(p==null?void 0:p.customer_name)||"Unknown",sent:t.sentPhones.includes(d),success:t.sentPhones.includes(d),error:((T=t.failedMessages.find(v=>v.phone===d))==null?void 0:T.error)||null}}),i=t.campaignStartTime?Math.floor((Date.now()-t.campaignStartTime)/1e3):0;await Ae.campaign.update(o,{status:n?"completed":"failed",sent_count:t.bulkProgress.current,success_count:t.bulkProgress.success,failed_count:t.bulkProgress.failed,recipients_data:l,completed_at:new Date().toISOString(),duration_seconds:i}),console.log(`âœ… Campaign finalized in DB: ${n?"completed":"failed"}`),hr=null,ea=0}catch(l){console.error("âŒ Failed to finalize campaign:",l)}}function rn(){return hr}async function Oo(o){try{const{data:t}=await H.from("customers").select("id, name, phone, email").or(`phone.eq.${o},whatsapp.eq.${o}`).single();if(!t)return null;const{data:n}=await H.from("orders").select("total, created_at, items").eq("customer_id",t.id).order("created_at",{ascending:!1}).limit(100),l=(n==null?void 0:n.reduce(($,E)=>$+(parseFloat(E.total)||0),0))||0,i=(n==null?void 0:n.length)||0,d=n==null?void 0:n[0],p=d==null?void 0:d.created_at,T=d&&parseFloat(d.total)||0,v=p?Math.floor((Date.now()-new Date(p).getTime())/(1e3*60*60*24)):null,L={};n==null||n.forEach($=>{$.items&&Array.isArray($.items)&&$.items.forEach(E=>{const k=E.category||E.product_category||"Other";L[k]=(L[k]||0)+1})});const G=Object.keys(L).reduce(($,E)=>L[$]>L[E]?$:E,"General");return{id:t.id,name:t.name,phone:t.phone,email:t.email,total_spent:l,last_purchase_date:p,last_purchase_amount:T,favorite_category:G,total_orders:i,days_since_last_order:v}}catch(t){return console.error("Error fetching customer data:",t),null}}function nn(o){return new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS"}).format(o)}function Go(o){return new Date(o).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}function zo(){const o=new Date().getHours();return o<12?"Good morning":o<17?"Good afternoon":"Good evening"}function Wo(){const o=[()=>{const n=["âœ¨","ğŸŒŸ","ğŸ’«","â­","ğŸ‰","ğŸŠ","ğŸ’","ğŸ”¥","ğŸ’¯","ğŸ¯","ğŸš€","ğŸ’ª","ğŸ‘","ğŸ‘","ğŸ™Œ","ğŸ¤","ğŸ’","ğŸ","ğŸˆ","ğŸ†"];return n[Math.floor(Math.random()*n.length)]},()=>{const n=["â€‹","â€Œ","â€","\uFEFF"];return n[Math.floor(Math.random()*n.length)]},()=>{const n=["â€¢","â–ª","â–«","â—¦","â–ª","â–«"];return n[Math.floor(Math.random()*n.length)]},()=>""],t=o[Math.floor(Math.random()*o.length)];return t()}async function ln(o,t,n){if(!o.includes("{"))return o;let l=o;const i=await Oo(t);return l=l.replace(/{name}/g,n||(i==null?void 0:i.name)||"Valued Customer"),l=l.replace(/{phone}/g,t),l=l.replace(/{greeting}/g,zo()),l=l.replace(/{date}/g,new Date().toLocaleDateString()),l=l.replace(/{time}/g,new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),l=l.replace(/{day}/g,new Date().toLocaleDateString("en-US",{weekday:"long"})),l=l.replace(/{month}/g,new Date().toLocaleDateString("en-US",{month:"long"})),l=l.replace(/\{unique\}/gi,()=>Wo()),i?(l=l.replace(/{totalSpent}/g,nn(i.total_spent||0)),l=l.replace(/{lastPurchase}/g,i.last_purchase_date?Go(i.last_purchase_date):"No purchases yet"),l=l.replace(/{lastPurchaseAmount}/g,i.last_purchase_amount?nn(i.last_purchase_amount):"N/A"),l=l.replace(/{favoriteCategory}/g,i.favorite_category||"General"),l=l.replace(/{totalOrders}/g,String(i.total_orders||0)),l=l.replace(/{daysSinceLastOrder}/g,i.days_since_last_order!==null?String(i.days_since_last_order):"N/A")):(l=l.replace(/{totalSpent}/g,"N/A"),l=l.replace(/{lastPurchase}/g,"N/A"),l=l.replace(/{lastPurchaseAmount}/g,"N/A"),l=l.replace(/{favoriteCategory}/g,"General"),l=l.replace(/{totalOrders}/g,"0"),l=l.replace(/{daysSinceLastOrder}/g,"N/A")),l}const Ho=3,on=5e3,cn=3e5;function qo(o){const t=o.toLowerCase();return t.includes("rate limit")||t.includes("too many requests")||t.includes("429")?"rate_limit":t.includes("not on whatsapp")||t.includes("invalid number")||t.includes("number not found")||t.includes("blocked")||t.includes("banned")?"permanent":"temporary"}function fn(o,t){return t==="rate_limit"?Math.min(on*Math.pow(3,o),cn*2):Math.min(on*Math.pow(2,o),cn)}function Vo(o){if(o.errorType==="permanent"||o.retryCount>=Ho)return!1;const t=fn(o.retryCount,o.errorType);return Date.now()-o.lastRetryTime>=t}function Qo(o,t,n,l){return{phone:o,name:t,error:n,errorType:qo(n),retryCount:0,lastRetryTime:Date.now(),timestamp:l}}function Ko(o){return{...o,retryCount:o.retryCount+1,lastRetryTime:Date.now()}}function Jo(o){return o.filter(Vo)}async function bn(o){try{const{data:t}=await H.from("customers").select("id, name, phone, email, address, city, region, created_at, tags").or(`phone.eq.${o},whatsapp.eq.${o}`).single();if(!t)return{phone:o,total_spent:0,total_orders:0,last_order_amount:0,days_since_last_order:null,has_email:!!(t!=null&&t.email),has_address:!!(t!=null&&t.address),tags:(t==null?void 0:t.tags)||[]};const{data:n}=await H.from("orders").select("total, created_at").eq("customer_id",t.id).order("created_at",{ascending:!1}).limit(100),l=(n==null?void 0:n.reduce((L,G)=>L+(parseFloat(G.total)||0),0))||0,i=(n==null?void 0:n.length)||0,d=n==null?void 0:n[0],p=d==null?void 0:d.created_at,T=d&&parseFloat(d.total)||0,v=p?Math.floor((Date.now()-new Date(p).getTime())/(1e3*60*60*24)):null;return{phone:o,customer_id:t.id,name:t.name,total_spent:l,total_orders:i,last_order_date:p,last_order_amount:T,days_since_last_order:v,has_email:!!t.email,has_address:!!t.address,tags:t.tags||[],created_at:t.created_at,city:t.city,region:t.region}}catch(t){return console.error("Error getting customer segment data:",t),null}}async function dn(o,t){const n=[];for(const l of o){const i=await bn(l);if(!i)continue;let d=!0;t.minTotalSpent!==void 0&&i.total_spent<t.minTotalSpent&&(d=!1),t.maxTotalSpent!==void 0&&i.total_spent>t.maxTotalSpent&&(d=!1),t.minOrders!==void 0&&i.total_orders<t.minOrders&&(d=!1),t.maxOrders!==void 0&&i.total_orders>t.maxOrders&&(d=!1),t.daysSinceLastOrder&&(i.days_since_last_order===null?d=!1:(t.daysSinceLastOrder.min!==void 0&&i.days_since_last_order<t.daysSinceLastOrder.min&&(d=!1),t.daysSinceLastOrder.max!==void 0&&i.days_since_last_order>t.daysSinceLastOrder.max&&(d=!1))),t.lastPurchaseAmount&&(t.lastPurchaseAmount.min!==void 0&&i.last_order_amount<t.lastPurchaseAmount.min&&(d=!1),t.lastPurchaseAmount.max!==void 0&&i.last_order_amount>t.lastPurchaseAmount.max&&(d=!1)),t.hasEmail===!0&&!i.has_email&&(d=!1),t.hasAddress===!0&&!i.has_address&&(d=!1),t.customerTags&&t.customerTags.length>0&&(t.customerTags.some(T=>i.tags.includes(T))||(d=!1)),t.excludeTags&&t.excludeTags.length>0&&t.excludeTags.some(T=>i.tags.includes(T))&&(d=!1),t.createdAfter&&i.created_at&&new Date(i.created_at)<new Date(t.createdAfter)&&(d=!1),t.createdBefore&&i.created_at&&new Date(i.created_at)>new Date(t.createdBefore)&&(d=!1),t.city&&i.city!==t.city&&(d=!1),t.region&&i.region!==t.region&&(d=!1),d&&n.push(l)}return n}async function mn(o){const t={total:o.length,withOrders:0,totalSpent:0,totalOrders:0,byCity:{},byRegion:{}};for(const n of o){const l=await bn(n);l&&(l.total_orders>0&&t.withOrders++,t.totalSpent+=l.total_spent,t.totalOrders+=l.total_orders,l.city&&(t.byCity[l.city]=(t.byCity[l.city]||0)+1),l.region&&(t.byRegion[l.region]=(t.byRegion[l.region]||0)+1))}return{total:t.total,withOrders:t.withOrders,averageSpent:t.total>0?t.totalSpent/t.total:0,averageOrders:t.total>0?t.totalOrders/t.total:0,byCity:t.byCity,byRegion:t.byRegion}}const yn={milestones:[25,50,75,90],enableSounds:!0,enableDesktop:!0,enableEmail:!1};let mr=0;function Yo(o,t,n=yn){if(t===0)return;const l=Math.floor(o/t*100);for(const i of n.milestones)if(l>=i&&mr<i){Xo(i,o,t,n),mr=i;break}}function Xo(o,t,n,l){const i=`${o}% Complete: ${t}/${n} messages sent`;l.enableDesktop&&Notification.permission==="granted"&&new Notification(`Campaign Progress - ${o}%`,{body:i,icon:"/favicon.ico",tag:`campaign-${o}`,requireInteraction:!1}),l.enableSounds&&Zo(o),console.log(`ğŸ¯ Milestone reached: ${o}% - ${i}`)}function Zo(o){try{const t=new(window.AudioContext||window.webkitAudioContext),n=t.createOscillator(),l=t.createGain();n.connect(l),l.connect(t.destination);const i=400+o/10*50;n.frequency.value=i,n.type="sine",l.gain.setValueAtTime(.3,t.currentTime),l.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),n.start(t.currentTime),n.stop(t.currentTime+.3)}catch{}}function ei(o,t,n,l,i=yn){const d=n>0?Math.round(o/n*100):0,p=`Campaign Complete!
${o} sent, ${t} failed (${d}% success)
Duration: ${ti(l)}`;i.enableDesktop&&Notification.permission==="granted"&&new Notification("Campaign Complete! ğŸ‰",{body:p,icon:"/favicon.ico",tag:"campaign-complete",requireInteraction:!0}),i.enableSounds&&si(d)}function si(o){try{const t=new(window.AudioContext||window.webkitAudioContext),n=o>80?600:o>50?500:400;for(let l=0;l<3;l++)setTimeout(()=>{const i=t.createOscillator(),d=t.createGain();i.connect(d),d.connect(t.destination),i.frequency.value=n+l*50,i.type="sine",d.gain.setValueAtTime(.3,t.currentTime),d.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2),i.start(t.currentTime),i.stop(t.currentTime+.2)},l*150)}catch{}}function ti(o){const t=Math.floor(o/3600),n=Math.floor(o%3600/60),l=o%60;return t>0?`${t}h ${n}m ${l}s`:n>0?`${n}m ${l}s`:`${l}s`}function ai(){mr=0}async function ri(o,t,n){}async function ni(o,t,n){}function Di(){var qr,Vr,Qr,Kr;const o=so(),{currentUser:t}=Il(),[n,l]=m.useState([]),[i,d]=m.useState([]),[p,T]=m.useState(null),[v,L]=m.useState(!0),[G,$]=m.useState(!1),[E,k]=m.useState(null),[U,ae]=m.useState("all"),[K,P]=m.useState(null),[z,se]=m.useState(""),[Q,Y]=m.useState(!1),[me,X]=m.useState({}),[ge,Ce]=m.useState(""),[Me,He]=m.useState(null),[J,$e]=m.useState(!1),[De,_]=m.useState(""),[W,he]=m.useState(""),[Ge,j]=m.useState(!1),[R,V]=m.useState([]),[Z,te]=m.useState(null),[oe,x]=m.useState(!1),[w,C]=m.useState(1),[b,S]=m.useState(""),[N,ee]=m.useState([]),[ie,Se]=m.useState(!1),[h,ce]=m.useState({current:0,total:0,success:0,failed:0}),[be,Je]=m.useState([]),[Pa,na]=m.useState([]),[Es,Gt]=m.useState([]),[ws,Aa]=m.useState(""),[Re,ms]=m.useState(!0),[Ie,gs]=m.useState(!0),[ye,us]=m.useState(3),[Ee,cs]=m.useState(8),[Pe,lt]=m.useState(!1),[ns,Fs]=m.useState(999999),[Ra,wn]=m.useState(!1),[qe,Bs]=m.useState(20),[ze,Os]=m.useState(60),[es,Gs]=m.useState(!0),[Ye,zs]=m.useState(!0),[Qe,Ws]=m.useState(30),[Ve,Hs]=m.useState(!0),[ss,qs]=m.useState(!0),[ts,Vs]=m.useState(!0),[pr,li]=m.useState(!0),[jn,fr]=m.useState(!1),[Nn,br]=m.useState(!1),[vn,Ia]=m.useState(!1),[Sn,la]=m.useState(!1),[kn,yr]=m.useState(!1),[oi,_n]=m.useState([]),[Ua,Cn]=m.useState([]),[Dn,ii]=m.useState(null),[ls,ot]=m.useState(""),[ne,La]=m.useState(null),[En,Fa]=m.useState(!0),[oa,Tn]=m.useState(null),[zt,wr]=m.useState([]),[Mn,ci]=m.useState([]),[$n,Pn]=m.useState(""),[An,jr]=m.useState(null),[Rn,Nr]=m.useState(null),[In,vr]=m.useState(!1),[Un,Ln]=m.useState(!1),[Fn,Bn]=m.useState(!1),[di,On]=m.useState(!1),[mi,Gn]=m.useState(!1),[gi,zn]=m.useState(!1),[Fe,js]=m.useState(null),[Qs,xs]=m.useState(""),[Wt,Ks]=m.useState(""),[ui,ia]=m.useState(""),[q,Ue]=m.useState("text"),[Ts,it]=m.useState(!1),[hs,ct]=m.useState(""),[as,Ms]=m.useState(["",""]),[dt,mt]=m.useState(!1),[Ns,wt]=m.useState(""),[vs,jt]=m.useState(""),[Js,Nt]=m.useState(""),[Ys,vt]=m.useState(""),[Ht,Ba]=m.useState(!1),[St,ca]=m.useState(!1);m.useState(!1);const kt=Pt.useRef(null);Pt.useRef(null);const Wn=r=>r?r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<strong>$1</strong>").replace(/__([^_]+)__/g,"<strong>$1</strong>").replace(/_([^_]+)_/g,"<em>$1</em>").replace(/~~([^~]+)~~/g,"<del>$1</del>").replace(/~([^~]+)~/g,"<del>$1</del>").replace(/```([^`]+)```/g,'<code class="bg-gray-100 px-1 py-0.5 rounded font-mono text-sm">$1</code>').replace(/\{(\w+)\}/g,'<span class="text-green-600 font-semibold">{$1}</span>'):"",[Oa,_t]=m.useState(!1),[We,Sr]=m.useState("browser"),[da,gt]=m.useState(!1),[xi,Hn]=m.useState(null),[qt,kr]=m.useState(null);m.useState(!1),m.useState(""),m.useState("");const[$s,Ct]=m.useState(!1),[Ss,Vt]=m.useState(!1),[le,ut]=m.useState([]),[Ps,_r]=m.useState(null),[Dt,qn]=m.useState(!1),[de,xt]=m.useState([]),[os,Ga]=m.useState(null),[hi,za]=m.useState(null),[Qt,Wa]=m.useState([]),[ma,Cr]=m.useState(null),[ga,Vn]=m.useState(!1),[ua,Qn]=m.useState(!1),[Kn,Jn]=m.useState(!1),[ks,Yn]=m.useState(()=>{const r=localStorage.getItem("whatsapp_sound_enabled");return r!==null?JSON.parse(r):!0}),[Xs,Dr]=m.useState(!1),xa=Pt.useRef(new Set);m.useEffect(()=>{localStorage.setItem("whatsapp_sound_enabled",JSON.stringify(ks))},[ks]);const[Xn,ha]=m.useState(!1),[pi,Zn]=m.useState([]),[Ha,Er]=m.useState(!1),[el,Tr]=m.useState(!1),[fi,sl]=m.useState([]);m.useState(!1),m.useState(""),m.useState("");const[tl,pa]=m.useState(!1),[fa,Mr]=m.useState(""),[ba,$r]=m.useState("");m.useState([]);const[ya,Pr]=m.useState(null);m.useState(!1);const[bi,al]=m.useState(null),ht=r=>{if(ks)try{const s=new(window.AudioContext||window.webkitAudioContext),a=s.createOscillator(),g=s.createGain();a.connect(g),g.connect(s.destination);const f={pause:[400,300],complete:[500,600,700],error:[300,200],resume:[300,400,500],success:[600,700]}[r];let M=s.currentTime;f.forEach((F,we)=>{a.frequency.setValueAtTime(F,M);const D=r==="success"?.15:.3;g.gain.setValueAtTime(D,M),g.gain.exponentialRampToValueAtTime(.01,M+(r==="success"?.05:.1)),M+=r==="success"?.08:.15}),a.type="sine",a.start(s.currentTime),a.stop(M)}catch(s){console.warn("Could not play sound:",s)}},pt=(r,s,a)=>{Xs&&"Notification"in window&&Notification.permission==="granted"&&new Notification(r,{body:s,icon:a||"/whatsapp-icon.svg",badge:"/whatsapp-icon.svg"})},rl=async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()==="granted"&&(Dr(!0),c.success("Browser notifications enabled!"))},nl=(r,s,a)=>{if(r===0||!a)return null;const g=Date.now()-a,u=r/(g/1e3),M=(s-r)/u;return Math.round(M)},qa=r=>{if(r<60)return`${r}s`;if(r<3600)return`${Math.floor(r/60)}m ${r%60}s`;const s=Math.floor(r/3600),a=Math.floor(r%3600/60);return`${s}h ${a}m`},Ar=r=>{if(console.log("ğŸ” [DEBUG] resolveMediaUrl() called",{mediaUrl:(r==null?void 0:r.substring(0,50))+"..."}),!r){console.log("âš ï¸ [DEBUG] No mediaUrl provided, returning undefined");return}if(r.startsWith("data:")||r.startsWith("http://")||r.startsWith("https://"))return console.log("âœ… [DEBUG] Media URL is already a full URL (data/http/https), returning as is"),r;if(r.startsWith("/media/whatsapp/")){console.log("ğŸ“ [DEBUG] Media URL is a /media/whatsapp/ path, checking localStorage...");const s=r.replace("/media/whatsapp/","");console.log("ğŸ“ [DEBUG] Extracted relative path:",s);const a=bs.getMedia(s,!0);if(a)return console.log("âœ… [DEBUG] Found in localStorage, returning base64 URL"),a;console.log("âš ï¸ [DEBUG] Not found in localStorage, returning undefined to prevent 404");return}if(r.startsWith("/")){console.log("âš ï¸ [DEBUG] Media URL is a local path starting with /, returning undefined to prevent 404");return}return console.log("âœ… [DEBUG] Returning original mediaUrl as fallback"),r},Va=(r,s)=>{const a=["Phone,Name",...r.map(M=>`${M.phone},${M.name}`)].join(`
`),g=new Blob([a],{type:"text/csv"}),u=window.URL.createObjectURL(g),f=document.createElement("a");f.href=u,f.download=s,f.click(),window.URL.revokeObjectURL(u),c.success(`Exported ${r.length} recipients to ${s}`)},Rr=()=>{const r=le.map(s=>{const a=i.find(g=>g.phone===s);return{phone:s,name:(a==null?void 0:a.customer_name)||"Unknown"}});Va(r,`sent-recipients-${new Date().toISOString().split("T")[0]}.csv`)},ll=()=>{const s=N.filter(a=>!le.includes(a)).map(a=>{const g=i.find(u=>u.phone===a);return{phone:a,name:(g==null?void 0:g.customer_name)||"Unknown"}});Va(s,`pending-recipients-${new Date().toISOString().split("T")[0]}.csv`)},Ir=()=>{const r=de.map(s=>({phone:s.phone,name:s.name}));Va(r,`failed-recipients-${new Date().toISOString().split("T")[0]}.csv`)},Et=(r,s)=>{Wa(a=>[...a,{event:r,time:new Date().toISOString(),details:s}])},Ur=r=>{try{localStorage.setItem("whatsapp_bulk_campaign_paused",JSON.stringify({...r,timestamp:new Date().toISOString(),pauseTimestamp:new Date().toISOString(),failedMessages:de,campaignTimeline:Qt,campaignStartTime:os})),console.log("ğŸ’¾ Campaign state saved to localStorage")}catch(s){console.error("Failed to save campaign state:",s)}},ol=()=>{try{const r=localStorage.getItem("whatsapp_bulk_campaign_paused");if(r){const s=JSON.parse(r);return console.log("ğŸ“‚ Loaded paused campaign from localStorage:",s),s.failedMessages&&xt(s.failedMessages),s.campaignTimeline&&Wa(s.campaignTimeline),s.campaignStartTime&&Ga(s.campaignStartTime),s.pauseTimestamp&&za(s.pauseTimestamp),s}}catch(r){console.error("Failed to load paused campaign:",r)}return null},wa=()=>{try{localStorage.removeItem("whatsapp_bulk_campaign_paused"),_r(null),ut([]),Ct(!1),Vt(!1),xt([]),Wa([]),Ga(null),za(null),Cr(null),console.log("ğŸ—‘ï¸ Cleared paused campaign state")}catch(r){console.error("Failed to clear paused campaign:",r)}},il=async()=>{if(de.length===0){c.error("No failed messages to retry");return}if(!window.confirm(`Retry ${de.length} failed message${de.length>1?"s":""}?

This will attempt to resend to all failed recipients.`))return;console.log(`ğŸ”„ Retrying ${de.length} failed messages...`),Et("Retry Started",`${de.length} failed messages`);const s=de.map(a=>a.phone);ee(s),xt([]),ce({current:0,total:s.length,success:0,failed:0}),c.loading(`Retrying ${s.length} messages...`,{duration:3e3}),setTimeout(()=>{Tt(!1)},1e3)},Qa=async()=>{if(de.length===0){c.error("No failed messages to add to blacklist");return}if(!window.confirm(`âš ï¸ Add ${de.length} Failed Contact${de.length!==1?"s":""} to Blacklist?

This will prevent future campaigns from including these numbers.

Failed contacts will be blacklisted with their error reason.`))return;c.loading("Adding failed contacts to blacklist...");let s=0,a=0;const g=[];for(const u of de)try{Ua.some(M=>M.phone===u.phone)?(a++,console.log(`â­ï¸ Skipped ${u.phone} - already in blacklist`)):(await Ae.blacklist.add(u.phone,`Campaign failure: ${u.error}`,`Auto-added from campaign "${ls||"Unnamed"}" on ${new Date(u.timestamp).toLocaleString()}. Contact: ${u.name}`),s++,console.log(`âœ… Added ${u.phone} to blacklist: ${u.error}`))}catch(f){console.error(`Error adding ${u.phone} to blacklist:`,f),g.push(u.phone)}await Ka(),xt([]),s>0?c.success(`âœ… Added ${s} contact${s!==1?"s":""} to blacklist`+(a>0?` (${a} already blacklisted)`:""),{duration:5e3}):a>0&&c("All failed contacts were already blacklisted",{icon:"â„¹ï¸",duration:4e3}),g.length>0&&c.error(`Failed to blacklist ${g.length} contact(s)`,{duration:4e3})};m.useEffect(()=>{(async()=>{try{const a=await fetch("/api/antiban-settings",{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok){let u="Failed to load settings from database";try{const f=await a.json();u=f.error||f.message||u}catch{u=a.statusText||u}throw new Error(u)}const g=await a.json();ms(g.usePersonalization??!0),gs(g.randomDelay??!0),us(g.minDelay||3),cs(g.maxDelay||8),lt(g.usePresence??!1),Bs(g.batchSize||20),Os(g.batchDelay||60),Ws(g.maxPerHour||30),Fs(g.dailyLimit||999999),Hs(g.skipRecentlyContacted??!0),zs(g.respectQuietHours??!0),qs(g.useInvisibleChars??!0),Vs(g.useEmojiVariation??!0),Gs(g.varyMessageLength??!0),console.log("âš™ï¸ Anti-ban settings loaded from database")}catch(a){console.error("Failed to load anti-ban settings from database:",a);try{const g=localStorage.getItem("whatsapp_antiban_settings");if(g){const u=JSON.parse(g);ms(u.usePersonalization??!0),gs(u.randomDelay??!0),us(u.minDelay||3),cs(u.maxDelay||8),lt(u.usePresence??!1),Bs(u.batchSize||20),Os(u.batchDelay||60),Ws(u.maxPerHour||30),Fs(u.dailyLimit||999999),Hs(u.skipRecentlyContacted??!0),zs(u.respectQuietHours??!0),qs(u.useInvisibleChars??!0),Vs(u.useEmojiVariation??!0),Gs(u.varyMessageLength??!0),console.log("âš™ï¸ Anti-ban settings loaded from localStorage (fallback)")}}catch(g){console.error("Failed to load from localStorage fallback:",g)}}})();const s=ol();if(s){_r(s),ut(s.sentPhones||[]);const a=new Date(s.pauseTimestamp||s.timestamp).getTime(),g=(Date.now()-a)/(1e3*60*60);g>24?c.error(`âš ï¸ Campaign paused ${Math.floor(g)} hours ago. Recipients list may be outdated.`,{duration:1e4}):c('You have a paused campaign. Click "Resume Campaign" to continue.',{duration:8e3,icon:"â¸ï¸"})}},[]),m.useEffect(()=>{if(!oe||w!==4)return;const r=s=>{s.target instanceof HTMLInputElement||s.target instanceof HTMLTextAreaElement||((s.code==="Space"||s.key==="p"||s.key==="P")&&(s.preventDefault(),ie&&!$s&&!Ss&&(console.log("â¸ï¸ Keyboard shortcut: Pause (Space/P)"),Ct(!0),c("Pausing... Please wait for current message to complete",{icon:"â¸ï¸"}))),(s.key==="s"||s.key==="S")&&ie&&(s.preventDefault(),console.log("ğŸ›‘ Keyboard shortcut: Stop (S)"),window.confirm("Are you sure you want to stop the campaign?")&&(Vt(!0),c("Stopping... Please wait for current message to complete",{icon:"ğŸ›‘"}))),s.key==="Escape"&&!ie&&(s.preventDefault(),console.log("âŒ Keyboard shortcut: Close (Esc)"),x(!1)))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[oe,w,ie,$s,Ss]),m.useEffect(()=>{async function r(){try{await Promise.all([gl(),cl(),Ka(),ja(),Lr()]),localStorage.getItem("whatsapp_bulk_draft")&&(_t(!0),console.log("ğŸ’¾ Draft available"))}catch(s){const a=s instanceof Error?s.message:"Failed to initialize WhatsApp Inbox";console.error("Error initializing WhatsApp Inbox:",s),k(a),c.error("Failed to load some data. Please refresh the page.")}}r()},[t]);async function cl(){try{const r=await Ae.campaign.getAll(20);_n(r)}catch(r){console.error("Error loading campaigns:",r)}}function dl(){const r=Bt();Zn(r)}function ml(){const r=Ot();sl(r)}m.useEffect(()=>{dl(),ml();const r=setInterval(()=>{const s=Do();if(s.length>0&&!ie){const a=s[0];window.confirm(`Scheduled campaign "${a.name}" is ready to run.

Start now?`)&&(ot(a.name),S(a.message),Ue(a.messageType),ee(a.selectedRecipients),Object.entries(a.settings).forEach(([u,f])=>{u==="usePersonalization"&&ms(f),u==="randomDelay"&&gs(f),u==="minDelay"&&us(f),u==="maxDelay"&&cs(f)}),xr(a.id,"running",new Date().toISOString()),x(!0),C(4),setTimeout(()=>Tt(!1),500))}},6e4);return()=>clearInterval(r)},[ie]);async function Ka(){try{const r=await Ae.blacklist.getAll();Cn(r)}catch(r){console.error("Error loading blacklist:",r)}}async function ja(){if(!(t!=null&&t.id)){Fa(!1);return}try{Fa(!0);const r=await fetch(`/api/whatsapp-sessions/get-active?user_id=${t.id}`);if(!r.ok){let a=`Server returned ${r.status}`;try{const g=await r.json();a=g.error||g.message||a}catch{a=r.statusText||a}throw new Error(a)}const s=await r.json();s.success&&s.active_session?(La(s.active_session),console.log("âœ… Active WhatsApp session loaded:",s.active_session.name),s.warning&&console.warn("âš ï¸",s.warning)):(La(null),console.log("â„¹ï¸ No active WhatsApp session"))}catch(r){console.error("Error loading active session:",r),La(null)}finally{Fa(!1)}}async function Lr(){var r;try{const s=await fetch("/api/whatsapp-sessions/check-integration");if(!s.ok){let g=`Server returned ${s.status}`;try{const u=await s.json();g=u.error||u.message||g}catch{g=s.statusText||g}console.warn("âš ï¸ Failed to load session diagnostic:",g);return}const a=await s.json();a.success&&(Tn(a),console.log("ğŸ“Š Session Diagnostic:",a),a.status==="using_integration_credentials"&&(console.warn("âš ï¸ Using OLD integration credentials (not database sessions)"),console.log("   Session ID from integrations:",(r=a.integration)==null?void 0:r.session_id)))}catch(s){console.error("Error loading session diagnostic:",s)}}m.useEffect(()=>{const r=s=>{const a=s.target;Ht&&!a.closest(".attach-menu-container")&&Ba(!1),St&&!a.closest(".variables-menu-container")&&ca(!1)};return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[Ht,St]),m.useEffect(()=>{"Notification"in window&&(Notification.permission==="default"||Notification.permission==="granted"&&Dr(!0))},[]),m.useEffect(()=>{async function r(){try{await ps()}catch(g){const u=g instanceof Error?g.message:"Failed to load messages";console.error("Error loading messages:",g),k(u),c.error("Failed to load messages. Please refresh the page.")}}r();const s=H.channel("whatsapp_incoming").on("postgres_changes",{event:"*",schema:"public",table:"whatsapp_incoming_messages"},async g=>{var u,f;if(g.eventType==="INSERT"&&g.new){const M=g.new,F=M.id;if(!xa.current.has(F)&&(xa.current.add(F),!M.is_read)){let we="Unknown";if(M.from_phone)try{const{data:I}=await H.from("customers").select("name, phone").or(`phone.eq.${M.from_phone},phone.eq.+${M.from_phone},whatsapp.eq.${M.from_phone},whatsapp.eq.+${M.from_phone}`).limit(1).single();I?we=I.name||`+${M.from_phone}`:we=`+${M.from_phone}`}catch{we=M.from_phone?`+${M.from_phone}`:"Unknown"}const D=((u=M.message_text)==null?void 0:u.substring(0,50))||"New message";Xs&&pt(`New WhatsApp Message from ${we}`,D+(((f=M.message_text)==null?void 0:f.length)>50?"...":""),"/whatsapp-icon.svg"),ks&&ht("success")}}ps().catch(M=>{console.error("Error reloading messages:",M)})}).subscribe(),a=setInterval(()=>{ps().catch(g=>{console.error("Error in periodic message refresh:",g)})},12e4);return()=>{s.unsubscribe(),clearInterval(a)}},[U]);async function gl(){try{const{data:r,error:s}=await H.from("customers").select("id, name, phone, whatsapp").order("name");if(s)throw s;V(r||[])}catch(r){console.error("Error loading customers:",r)}}async function ps(){var r,s,a,g,u,f;try{$(!0);const{data:M,error:F}=await H.from("whatsapp_incoming_messages").select(`
          *,
          customers (
            name,
            phone,
            whatsapp
          )
        `).order("created_at",{ascending:!1}).limit(100);if(F)throw console.error("Database error (incoming):",F),F;const{data:we,error:D}=await H.from("whatsapp_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(D)throw console.error("Database error (outgoing):",D),D;const{data:I,error:O}=await H.from("customers").select("id, name, phone, whatsapp"),ke=new Map;(I||[]).forEach(y=>{if(y.phone){const A=y.phone.replace(/[^\d+]/g,"");ke.set(A,y)}if(y.whatsapp){const A=y.whatsapp.replace(/[^\d+]/g,"");ke.set(A,y)}});const pe=y=>{const A=y.replace(/[^\d+]/g,"");let je=ke.get(A);return!je&&A.startsWith("+")&&(je=ke.get(A.substring(1))),!je&&!A.startsWith("+")&&(je=ke.get("+"+A)),je},_e=new Map;(M||[]).forEach(y=>{const A=y.from_phone;if(!_e.has(A)){let ue=y.customers;ue||(ue=pe(A)),_e.set(A,{phone:A,customer_id:y.customer_id||(ue==null?void 0:ue.id),customer_name:(ue==null?void 0:ue.name)||"Unknown",last_message:y.message_text,last_message_time:y.created_at,unread_count:y.is_read?0:1,messages:[]})}const je=_e.get(A);y.customers&&je.customer_name==="Unknown"&&(je.customer_id=y.customer_id,je.customer_name=y.customers.name),je.messages.push({id:y.id,type:"received",message:y.message_text,message_type:y.message_type,media_url:y.media_url,timestamp:y.created_at,is_read:y.is_read}),y.is_read||je.unread_count++}),(we||[]).forEach(y=>{const A=y.recipient_phone;if(!_e.has(A)){const ue=pe(A);_e.set(A,{phone:A,customer_id:ue==null?void 0:ue.id,customer_name:(ue==null?void 0:ue.name)||"Unknown",last_message:y.message,last_message_time:y.created_at,unread_count:0,messages:[]})}const je=_e.get(A);if(je.customer_name==="Unknown"){const ue=pe(A);ue&&(je.customer_id=ue.id,je.customer_name=ue.name)}je.messages.push({id:y.id,type:"sent",message:y.message,message_type:y.message_type,media_url:y.media_url,timestamp:y.created_at,status:y.status})}),_e.forEach(y=>{if(y.messages.sort((A,je)=>new Date(A.timestamp).getTime()-new Date(je.timestamp).getTime()),y.messages.length>0){const A=y.messages[y.messages.length-1];y.last_message=A.message,y.last_message_time=A.timestamp}});let Ne=Array.from(_e.values());Ne.sort((y,A)=>new Date(A.last_message_time).getTime()-new Date(y.last_message_time).getTime()),U==="unread"?Ne=Ne.filter(y=>y.unread_count>0):U==="unreplied"&&(Ne=Ne.filter(y=>{const A=y.messages[y.messages.length-1];return(A==null?void 0:A.type)==="received"}));const Be=xa.current,Is=new Set((M||[]).map(y=>String(y.id))),B=(M||[]).filter(y=>!Be.has(String(y.id))&&!y.is_read);if(xa.current=Is,Be.size>0&&B.length>0)for(const y of B){const A=((r=y.customers)==null?void 0:r.name)||(y.from_phone?`+${y.from_phone}`:"Unknown"),je=((s=y.message_text)==null?void 0:s.substring(0,50))||"New message";Xs&&pt(`New WhatsApp Message from ${A}`,je+(((a=y.message_text)==null?void 0:a.length)>50?"...":""),"/whatsapp-icon.svg"),ks&&ht("success")}d(Ne),l(M||[]),v&&Ne.length>0&&c.success(`Loaded ${Ne.length} conversations`)}catch(M){console.error("Error loading messages:",M),(g=M.message)!=null&&g.includes("Failed to fetch")||(u=M.message)!=null&&u.includes("network")?c.error("Network error. Check your connection."):(f=M.message)!=null&&f.includes("not found")&&c.error("WhatsApp inbox table not found. Run database migration.")}finally{L(!1),$(!1)}}async function Fr(r){try{const s=r.messages.filter(a=>a.type==="received"&&a.is_read===!1).map(a=>a.id);s.length>0&&(await H.from("whatsapp_incoming_messages").update({is_read:!0}).in("id",s),ps(),c.success("Marked as read"))}catch(s){console.error("Error marking conversation as read:",s)}}async function ul(r){if(z.trim()){Y(!0);try{console.log("ğŸ’¬ Attempting to send WhatsApp reply to:",r.from_phone);const s=await Xe.sendMessage(r.from_phone,z,{quoted_message_id:r.message_id,session_id:(ne==null?void 0:ne.id)||void 0});console.log("ğŸ’¬ WhatsApp Service Result:",s),s.success?(c.success("âœ… Reply sent successfully!"),await H.from("whatsapp_incoming_messages").update({replied:!0,replied_at:new Date().toISOString()}).eq("id",r.id),se(""),P(null),ps()):c.error(s.error||"Failed to send reply")}catch(s){console.error("Error sending reply:",s),c.error("Failed to send reply. Please try again.")}finally{Y(!1)}}}async function Br(r){const s=me[r.phone];if(!(s!=null&&s.trim())){c.error("Please enter a message");return}Y(!0);try{console.log("ğŸ’¬ Attempting to send quick reply to:",r.phone);const a=await Xe.sendMessage(r.phone,s,{session_id:(ne==null?void 0:ne.id)||void 0});if(console.log("ğŸ’¬ WhatsApp Service Result:",a),a.success){if(c.success("âœ… Message sent successfully!"),X(g=>({...g,[r.phone]:""})),r.customer_id)try{await H.from("customer_communications").insert({customer_id:r.customer_id,type:"whatsapp",message:s,phone_number:r.phone,status:"sent",sent_by:t==null?void 0:t.id,sent_at:new Date().toISOString(),created_at:new Date().toISOString()})}catch(g){console.warn("âš ï¸ Could not log to customer_communications:",g)}ps()}else c.error(a.error||"Failed to send message")}catch(a){console.error("Error sending quick reply:",a),c.error("Failed to send message. Please try again.")}finally{Y(!1)}}async function xl(){if(!W.trim()){c.error("Please enter a message");return}const r=(Z==null?void 0:Z.whatsapp)||(Z==null?void 0:Z.phone)||De;if(!r){c.error("Please select a customer or enter a phone number");return}j(!0);try{console.log("ğŸ’¬ Attempting to send WhatsApp to:",r);const s=await Xe.sendMessage(r,W,{session_id:(ne==null?void 0:ne.id)||void 0});if(console.log("ğŸ’¬ WhatsApp Service Result:",s),s.success){if(c.success("âœ… Message sent successfully!"),Z)try{await H.from("customer_communications").insert({customer_id:Z.id,type:"whatsapp",message:W,phone_number:r,status:"sent",sent_by:t==null?void 0:t.id,sent_at:new Date().toISOString(),created_at:new Date().toISOString()}),console.log("âœ… WhatsApp message logged to customer_communications table")}catch(a){console.warn("âš ï¸ Could not log to customer_communications table:",a)}he(""),_(""),te(null),$e(!1),ps()}else c.error(s.error||"Failed to send message")}catch(s){console.error("Error sending message:",s),c.error("Failed to send message. Please try again.")}finally{j(!1)}}async function Tt(r=!1){var we;if(!b.trim()&&q==="text"){c.error("Please enter a message");return}if(N.length===0){c.error("Please select at least one recipient");return}const s=Xa(b),a=_l(N),g=[...s,...a];if(g.length>0){const D=g.map(O=>O.message).join(`
`);if(!window.confirm(`âš ï¸ Warnings detected:

${D}

Do you want to proceed anyway?`))return}if(b.trim().length>10&&na(D=>[b.trim(),...D].slice(0,100)),r&&Ps&&le.length===0&&((we=Ps.sentPhones)==null?void 0:we.length)>0&&(console.log("âš ï¸ State race condition detected! Using sentPhones from pausedCampaignState directly"),ut(Ps.sentPhones),await new Promise(D=>setTimeout(D,100))),Ye){const D=new Date().getHours();if(D>=22||D<8){c.error('Cannot send during quiet hours (10 PM - 8 AM). Disable "Respect Quiet Hours" to override.',{duration:5e3}),C(3);return}}let u=[...N];if(ya&&!r){console.log("ğŸ¯ Applying recipient segmentation...");const D=await dn(u,ya),I=await mn(u);if(console.log(`   Filtered: ${D.length}/${u.length} recipients match criteria`),console.log("   Stats:",I),u=D,u.length===0){c.error("No recipients match the segmentation criteria");return}}if(Ve&&!r){const D=Date.now()-216e5,I=new Set(i.filter(pe=>new Date(pe.last_message_time).getTime()>D).map(pe=>pe.phone)),O=u.length;u=u.filter(pe=>!I.has(pe));const ke=O-u.length;ke>0&&(console.log(`   â­ï¸  Excluded ${ke} recently contacted recipients`),c(`Excluded ${ke} recently contacted recipients`,{icon:"â„¹ï¸",duration:3e3}))}if(!r){console.log("ğŸ“‹ Validating phone numbers..."),c.loading("Validating phone numbers...",{id:"phone-validation"});const D=[],I=[];for(const O of u)try{if(typeof Xe.validatePhoneNumber=="function"){const ke=await Xe.validatePhoneNumber(O);ke.valid?D.push(O):(console.warn(`âŒ Invalid phone: ${O} - ${ke.error}`),I.push({phone:O,reason:ke.error||"Invalid format"}))}else{console.warn("âš ï¸ validatePhoneNumber method not available, using basic validation");const ke=/^[+]?[1-9]\d{9,14}$/,pe=O.replace(/\D/g,"");ke.test(pe)?D.push(O):I.push({phone:O,reason:"Invalid phone number format"})}}catch(ke){console.error(`Error validating phone ${O}:`,ke),D.push(O)}if(c.dismiss("phone-validation"),I.length>0){const O=`${I.length} invalid phone number${I.length>1?"s":""} found:
`+I.slice(0,5).map(pe=>`â€¢ ${pe.phone}: ${pe.reason}`).join(`
`)+(I.length>5?`
...and ${I.length-5} more`:"");if(console.error("âŒ Invalid phone numbers:",I),!window.confirm(`âš ï¸ Phone Number Validation Failed

${O}

Valid numbers: ${D.length}/${u.length}

Continue with valid numbers only?`)){C(3);return}c(`Sending to ${D.length} valid numbers (skipped ${I.length} invalid)`,{icon:"âš ï¸",duration:5e3})}else c.success("All phone numbers validated âœ“",{duration:2e3});u=D}if(Ve&&!r){const D=Date.now()-216e5,I=u.filter(ke=>{const pe=i.find(Ne=>Ne.phone===ke);if(!pe)return!0;const _e=pe.messages[pe.messages.length-1];return!_e||_e.type!=="sent"?!0:new Date(_e.timestamp).getTime()<D}),O=u.length-I.length;O>0&&(c(`Skipped ${O} recently contacted numbers (within 6h)`,{duration:4e3,icon:"â„¹ï¸"}),u=I)}let f=0;if(r)if(le.length===0)console.warn("âš ï¸ WARNING: Resuming but sentPhones is empty! This may cause duplicate sends."),c.error("Warning: Cannot find sent history. Campaign may send duplicates.",{duration:6e3});else{f=le.length;const D=u.length;u=u.filter(I=>!le.includes(I)),console.log("ğŸ“¤ Resuming campaign:"),console.log(`   - Already sent: ${f} phones`),console.log(`   - Total recipients: ${D}`),console.log(`   - After filtering: ${u.length} remaining`),console.log(`   - Filtered out: ${D-u.length} phones`),c(`Resuming: ${u.length} messages remaining (${f} already sent)`,{duration:5e3,icon:"â–¶ï¸"})}if(u.length===0){c.error("All recipients were filtered out or already sent. Adjust your settings."),C(3);return}const M=Math.ceil(u.length/Qe);if(M>3&&!r&&!window.confirm(`This will take approximately ${M} hours to send at ${Qe} messages/hour.

Rate limiting is applied to prevent spam detection. Continue?`)){C(3);return}const F=N.length;if(Se(!0),Ct(!1),Vt(!1),ce({current:f,total:F,success:le.filter(D=>N.includes(D)).length,failed:0}),r)Et("Campaign Resumed",`${u.length} remaining`),ht("resume"),pt("Campaign Resumed",`Continuing with ${u.length} messages`);else{const D=Date.now();Ga(D),Et("Campaign Started",`${N.length} recipients`),ai();try{const I=await pn({name:ls||`Campaign ${new Date().toLocaleDateString()}`,message:b,messageType:q,selectedRecipients:N,sentPhones:le,bulkProgress:{current:f,total:F,success:le.filter(O=>N.includes(O)).length,failed:0},failedMessages:[],campaignStartTime:D,settings:{usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es},conversations:i.map(O=>({phone:O.phone,customer_name:O.customer_name}))});I&&console.log(`âœ… Campaign created in DB: ${I}`)}catch(I){console.error("Failed to create campaign in DB:",I)}Xs&&Notification.permission==="default"&&rl()}try{console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`),console.log("â•‘         ğŸ“¤ BULK WHATSAPP SEND - BROWSER MODE START          â•‘"),console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ğŸ“Š Campaign Summary:"),console.log(`   â€¢ Total Recipients: ${u.length}`),console.log(`   â€¢ Message Type: ${q}`),console.log(`   â€¢ Has Media: ${!!Fe}`),console.log(`
ğŸ›¡ï¸  Anti-Ban Protection Settings:`),console.log(`   â€¢ Personalization: ${Re?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Random Delays: ${Ie?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Delay Range: ${ye}s - ${Ee}s`),console.log(`   â€¢ Batch Size: ${qe} messages`),console.log(`   â€¢ Batch Delay: ${ze}s`),console.log(`   â€¢ Skip Recently Contacted: ${Ve?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Respect Quiet Hours: ${Ye?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Use Presence (Typing): ${Pe?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Invisible Chars: ${ss?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Emoji Variation: ${ts?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`   â€¢ Vary Message Length: ${es?"âœ“ ENABLED":"âœ— DISABLED"}`),console.log(`
â±ï¸  Rate Limits:`),console.log(`   â€¢ Max per Hour: ${Qe} messages`),console.log(`   â€¢ Daily Limit: ${ns} messages`),console.log(`
ğŸ“ Message Preview:`),console.log(`   "${b.substring(0,100)}${b.length>100?"...":""}"`),console.log(`
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`);let D="";if(Fe&&Fe instanceof File&&["image","video","document","audio"].includes(q))try{console.log("ğŸ“¤ Uploading media file to WasenderAPI for sending..."),c.loading("Preparing media...",{id:"bulk-media-upload"});const{WhatsAppMediaStorageService:B}=await Jr(()=>import("./whatsappMediaStorage-31677baa.js"),["assets/whatsappMediaStorage-31677baa.js","assets/supabase-cf010ec4.js"]),y=await B.uploadMedia(Fe);if(!y.success||!y.url)throw new Error(y.error||"Failed to upload media");D=y.url,console.log("âœ… Media ready for sending:",D.substring(0,100)+"..."),c.success("Media ready!",{id:"bulk-media-upload"})}catch(B){console.error("âŒ Media preparation failed:",B),c.error(`Media preparation failed: ${B.message}. Please try a smaller file or use Media Library.`,{id:"bulk-media-upload",duration:5e3}),Se(!1),C(2);return}else if(typeof Fe=="string")if(Fe.startsWith("data:")){console.log("ğŸ“¤ Converting base64 media to file for WasenderAPI..."),c.loading("Preparing media from library...",{id:"bulk-media-upload"});try{const y=await(await fetch(Fe)).blob(),A=`library-media-${Date.now()}.${y.type.split("/")[1]||"jpg"}`,je=new File([y],A,{type:y.type}),{WhatsAppMediaStorageService:ue}=await Jr(()=>import("./whatsappMediaStorage-31677baa.js"),["assets/whatsappMediaStorage-31677baa.js","assets/supabase-cf010ec4.js"]),ve=await ue.uploadMedia(je);if(!ve.success||!ve.url)throw new Error(ve.error||"Failed to prepare media from library");D=ve.url,console.log("âœ… Library media converted and ready:",D.substring(0,100)+"..."),c.success("Media ready!",{id:"bulk-media-upload"})}catch(B){console.error("âŒ Failed to convert library media:",B),c.error(`Failed to prepare library media: ${B.message}`,{id:"bulk-media-upload",duration:5e3}),Se(!1),C(2);return}}else D=Fe,console.log("âœ… Using media URL from library:",D);let I=0,O=0,ke=0,pe=0,_e=Date.now();for(let B=0;B<u.length;B++){if(Ss){console.log("ğŸ›‘ STOP signal received. Stopping campaign..."),c.error("Campaign stopped by user",{duration:4e3}),wa();break}if($s){console.log("â¸ï¸ PAUSE signal received. Saving state..."),Et("Campaign Paused",`${f+B}/${N.length} sent`),za(new Date().toISOString());const ve={sentPhones:[...le],selectedRecipients:[...N],bulkMessage:b,bulkMessageType:q,bulkMedia:Fe,mediaDataUrl:D,bulkProgress:{current:f+B,total:N.length,success:I,failed:O},usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es,viewOnce:Ts,pollQuestion:hs,pollOptions:as,allowMultiSelect:dt,locationLat:Ns,locationLng:vs,locationName:Js,locationAddress:Ys};Ur(ve),ht("pause"),pt("Campaign Paused",`Progress saved: ${f+B}/${N.length} sent`),c.success("Campaign paused. Progress saved!",{duration:5e3}),Se(!1);return}const y=u[B],A=i.find(ve=>ve.phone===y);if((Date.now()-_e)/(1e3*60*60)>=1&&(pe=0,_e=Date.now()),pe>=Qe){const ve=3600-(Date.now()-_e)/1e3;ve>0&&(console.log(`â³ Hourly limit reached (${Qe}). Waiting ${Math.ceil(ve/60)} minutes...`),c(`â¸ï¸ Rate limit: Pausing for ${Math.ceil(ve/60)} minutes`,{duration:5e3}),await new Promise(fe=>setTimeout(fe,ve*1e3)),pe=0,_e=Date.now())}B>0&&B%qe===0&&(console.log(`ğŸ“Š Batch ${Math.floor(B/qe)} complete. Taking ${ze}s break...`),c(`Batch break: Waiting ${ze}s (sent ${B}/${u.length})`,{duration:3e3,icon:"â˜•"}),await new Promise(ve=>setTimeout(ve,ze*1e3)));const ue=Date.now();try{console.log(`
ğŸ“¤ [${B+1}/${u.length}] Sending to: ${y}`),console.log(`   Customer: ${(A==null?void 0:A.customer_name)||"Unknown"}`),console.log(`   Batch: ${Math.floor(B/qe)+1} | Messages this hour: ${pe}`);const ve=f+B+1;ce(re=>({...re,current:ve})),Xs&&Yo(ve,F,{milestones:[25,50,75,90],enableSounds:ks,enableDesktop:!0,enableEmail:!1});let fe=b;if(Re){const re=new Date,Ze=re.getHours(),Us=Ze<12?"Good morning":Ze<18?"Good afternoon":"Good evening";console.log("   ğŸ¨ Personalizing message with enhanced variables...");try{fe=await ln(fe,y,A==null?void 0:A.customer_name),fe=fe.replace(/\{company\}/gi,"Dukani Pro")}catch(is){console.warn("âš ï¸ Enhanced personalization failed, using basic:",is);const Mt=()=>{const $t=[()=>{const Zs=["âœ¨","ğŸŒŸ","ğŸ’«","â­","ğŸ‰","ğŸŠ","ğŸ’","ğŸ”¥","ğŸ’¯","ğŸ¯","ğŸš€","ğŸ’ª","ğŸ‘","ğŸ‘","ğŸ™Œ","ğŸ¤","ğŸ’","ğŸ","ğŸˆ","ğŸ†"];return Zs[Math.floor(Math.random()*Zs.length)]},()=>{const Zs=["â€‹","â€Œ","â€","\uFEFF"];return Zs[Math.floor(Math.random()*Zs.length)]},()=>{const Zs=["â€¢","â–ª","â–«","â—¦","â–ª","â–«"];return Zs[Math.floor(Math.random()*Zs.length)]},()=>""],sr=$t[Math.floor(Math.random()*$t.length)];return sr()};fe=fe.replace(/\{name\}/gi,(A==null?void 0:A.customer_name)||"Customer").replace(/\{phone\}/gi,y).replace(/\{date\}/gi,re.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})).replace(/\{time\}/gi,re.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})).replace(/\{day\}/gi,re.toLocaleDateString("en-US",{weekday:"long"})).replace(/\{month\}/gi,re.toLocaleDateString("en-US",{month:"long"})).replace(/\{greeting\}/gi,Us).replace(/\{company\}/gi,"Dukani Pro").replace(/\{unique\}/gi,()=>Mt())}}const Ke=[];if(ss&&(fe=El(fe,B),Ke.push("Invisible chars")),ts&&(fe=Tl(fe,B),Ke.push("Emoji variation")),es&&Math.random()>.5){const re=[" ",".","!","ğŸ˜Š"],Ze=re[Math.floor(Math.random()*re.length)];!fe.endsWith(Ze)&&!fe.endsWith(".")&&!fe.endsWith("!")&&(fe=fe.trim()+Ze,Ke.push("Length variation"))}if(Ke.length>0&&console.log(`   ğŸ­ Uniqueness applied: ${Ke.join(", ")}`),Pe)try{console.log("   âŒ¨ï¸  Sending typing presence..."),await Xe.sendPresenceUpdate(y,"composing");const re=1e3+Math.random()*1e3;console.log(`   â³ Simulating typing for ${(re/1e3).toFixed(1)}s...`),await new Promise(Ze=>setTimeout(Ze,re))}catch(re){console.debug("   âš ï¸  Presence update skipped:",re)}console.log(`   ğŸ’¬ Message type: ${q}`),console.log(`   ğŸ“ Final message: "${fe.substring(0,80)}${fe.length>80?"...":""}"`);let Oe;q==="text"?(console.log("   ğŸ“¨ Sending text message..."),Oe=await Xe.sendMessage(y,fe,{session_id:(ne==null?void 0:ne.id)||void 0})):q==="image"&&D?!D.startsWith("http://")&&!D.startsWith("https://")&&!D.startsWith("data:")?(console.error("âŒ Invalid image URL (missing protocol):",D),Oe={success:!1,error:"Invalid image URL: Must start with http://, https://, or data:"}):(console.log(`   ğŸ“¨ Sending image with caption (ViewOnce: ${Ts})...`),console.log(`   ğŸ–¼ï¸  Media URL: ${D.substring(0,60)}...`),Oe=await Xe.sendMessage(y,fe,{media_url:D,message_type:"image",caption:fe,viewOnce:Ts,session_id:(ne==null?void 0:ne.id)||void 0})):q==="video"&&D?!D.startsWith("http://")&&!D.startsWith("https://")&&!D.startsWith("data:")?(console.error("âŒ Invalid video URL (missing protocol):",D),Oe={success:!1,error:"Invalid video URL: Must start with http://, https://, or data:"}):Oe=await Xe.sendMessage(y,fe,{media_url:D,message_type:"video",caption:fe,viewOnce:Ts,session_id:(ne==null?void 0:ne.id)||void 0}):q==="document"&&D?!D.startsWith("http://")&&!D.startsWith("https://")&&!D.startsWith("data:")?(console.error("âŒ Invalid document URL (missing protocol):",D),Oe={success:!1,error:"Invalid document URL: Must start with http://, https://, or data:"}):Oe=await Xe.sendMessage(y,fe,{media_url:D,message_type:"document",caption:fe,session_id:(ne==null?void 0:ne.id)||void 0}):q==="audio"&&D?!D.startsWith("http://")&&!D.startsWith("https://")&&!D.startsWith("data:")?(console.error("âŒ Invalid audio URL (missing protocol):",D),Oe={success:!1,error:"Invalid audio URL: Must start with http://, https://, or data:"}):Oe=await Xe.sendMessage(y,"",{media_url:D,message_type:"audio",session_id:(ne==null?void 0:ne.id)||void 0}):q==="location"?Oe=await Xe.sendMessage(y,"",{message_type:"location",location:{latitude:parseFloat(Ns),longitude:parseFloat(vs),name:Js,address:Ys},session_id:(ne==null?void 0:ne.id)||void 0}):q==="poll"&&hs&&as.filter(re=>re.trim()).length>=2?Oe=await Xe.sendMessage(y,"",{message_type:"poll",pollName:hs,pollOptions:as.filter(re=>re.trim()),allowMultipleAnswers:dt,session_id:(ne==null?void 0:ne.id)||void 0}):Oe=await Xe.sendMessage(y,fe,{session_id:(ne==null?void 0:ne.id)||void 0});const ka=Date.now()-ue;if(Oe.success){I++,pe++,ht("success");const re=[...le,y];ut(re),ee(is=>is.filter(Mt=>Mt!==y)),await ni(y,fe,Dn||void 0),console.log(`   âœ… SUCCESS (${ka}ms)`),console.log(`   ğŸ“Š Progress: ${f+B+1}/${F} | Success: ${I} | Failed: ${O}`),console.log(`   ğŸ“Š Stats: ${I} sent | ${O} failed | ${pe} this hour`),console.log(`   ğŸ“ Saved to sentPhones (now ${re.length} total)`),console.log(`   ğŸ—‘ï¸ Removed from queue - ${N.length-1} pending remaining`);const Ze={sentPhones:re,selectedRecipients:[...N],bulkMessage:b,bulkMessageType:q,bulkMedia:Fe,mediaDataUrl:D,bulkProgress:{current:f+B+1,total:N.length,success:I,failed:O},usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es,viewOnce:Ts,pollQuestion:hs,pollOptions:as,allowMultiSelect:dt,locationLat:Ns,locationLng:vs,locationName:Js,locationAddress:Ys};Ur(Ze);const Us=rn();if(Us&&Fo(Us,{name:ls||`Campaign ${new Date().toLocaleDateString()}`,message:b,messageType:q,selectedRecipients:N,sentPhones:re,bulkProgress:{current:f+B+1,total:F,success:I,failed:O},failedMessages:de,campaignStartTime:os,settings:{usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es},conversations:i.map(is=>({phone:is.phone,customer_name:is.customer_name}))}),A!=null&&A.customer_id)try{await H.from("customer_communications").insert({customer_id:A.customer_id,type:"whatsapp",message:fe,phone_number:y,status:"sent",sent_by:t==null?void 0:t.id,sent_at:new Date().toISOString(),created_at:new Date().toISOString()})}catch(is){console.warn("âš ï¸ Could not log to customer_communications:",is)}}else{O++;const re=Oe.error||"Unknown error",Ze=re.includes("JID does not exist")||re.includes("not on WhatsApp")||re.includes("not registered"),Us=re.includes("Invalid")||re.includes("format"),is=re.includes("rate limit")||re.includes("too many"),Mt={phone:y,name:(A==null?void 0:A.customer_name)||"Unknown",error:re,errorType:Ze?"not_on_whatsapp":Us?"invalid_format":is?"rate_limit":"other",timestamp:new Date().toISOString()};xt($t=>[...$t,Mt]),ee($t=>$t.filter(sr=>sr!==y)),console.error(`   âŒ FAILED (${ka}ms):`),console.error(`      Error Type: ${Mt.errorType}`),console.error(`      Phone: ${y}`),console.error(`      Message: ${re}`),console.log(`   ğŸ“Š Progress: ${f+B+1}/${F} | Success: ${I} | Failed: ${O}`),console.log(`   ğŸ“Š Stats: ${I} sent | ${O} failed | ${pe} this hour`),console.log(`   ğŸ—‘ï¸ Removed from queue - ${N.length-1} truly pending remaining`),Ze?(console.warn(`   ğŸ’¡ SUGGESTION: Phone ${y} may have:`),console.warn("      â€¢ Wrong country code (check if it starts with correct code)"),console.warn("      â€¢ Not registered on WhatsApp"),console.warn("      â€¢ Been deactivated")):Us&&(console.warn("   ğŸ’¡ SUGGESTION: Fix phone format to: CountryCode+Number"),console.warn("      Example: 255712345678 (Tanzania)"),console.warn("      Remove: spaces, dashes, parentheses, + symbol"))}if(os){const re=nl(I+O,F,os);Cr(re)}ce({current:f+B+1,total:F,success:I,failed:O});const Za=f+B+1,er=I+O;if(Za!==er&&(console.warn(`âš ï¸ COUNT MISMATCH: Attempted ${Za} but only ${er} accounted for (${I} success + ${O} failed)`),console.warn(`   Missing: ${Za-er} messages`)),Xs){const re=(f+B+1)/N.length*100;[25,50,75].includes(Math.floor(re))&&Math.floor(re)!==Math.floor((f+B)/N.length*100)&&pt(`${Math.floor(re)}% Complete`,`${f+B+1}/${N.length} messages sent`)}if(B<u.length-1){let re=ye*1e3;Ie&&(re=(ye+Math.random()*(Ee-ye))*1e3,Math.random()>.7&&(re+=Math.random()*re*.3));const Ze=1+Math.floor(B/10)*.1,Us=re;re*=Ze,console.log(`   â±ï¸  Delay: ${(re/1e3).toFixed(1)}s (base: ${(Us/1e3).toFixed(1)}s, slowdown: ${Ze.toFixed(2)}x)`),await new Promise(is=>setTimeout(is,re))}}catch(ve){const fe=Date.now()-ue;O++;const Ke={phone:y,name:(A==null?void 0:A.customer_name)||"Unknown",error:ve instanceof Error?ve.message:"Unknown exception",errorType:"other",timestamp:new Date().toISOString()};xt(Oe=>[...Oe,Ke]),ee(Oe=>Oe.filter(ka=>ka!==y)),console.error(`   âŒ EXCEPTION (${fe}ms):`,ve),console.error("   ğŸ› Error details:",ve),console.log(`   ğŸ—‘ï¸ Removed from queue - ${N.length-1} pending remaining`),ce({current:f+B+1,total:F,success:I,failed:O})}}if(de.length>0){console.log(`
ğŸ”„ Processing Smart Retry Queue...`);const B=de.map(A=>Qo(A.phone,A.name,A.error,A.timestamp)),y=Jo(B);if(y.length>0){console.log(`   ğŸ“‹ ${y.length} messages eligible for retry`),c(`ğŸ”„ Retrying ${y.length} failed messages...`,{duration:4e3,icon:"ğŸ”„"});let A=0,je=0;for(const ue of y)try{const ve=fn(ue.retryCount,ue.errorType);if(console.log(`   â±ï¸  Waiting ${ve/1e3}s before retry (attempt ${ue.retryCount+1})...`),await new Promise(Ke=>setTimeout(Ke,ve)),console.log(`   ğŸ”„ Retrying ${ue.phone}...`),(await Xe.sendMessage(ue.phone,b,{session_id:(ne==null?void 0:ne.id)||void 0})).success)A++,I++,ut(Ke=>[...Ke,ue.phone]),console.log(`   âœ… Retry SUCCESS for ${ue.phone}`),xt(Ke=>Ke.filter(Oe=>Oe.phone!==ue.phone));else{je++;const Ke=Ko(ue);Ke.retryCount<3?console.log(`   â¸ï¸  Retry failed, will try again (attempt ${Ke.retryCount})`):console.log(`   âŒ Retry failed after ${Ke.retryCount} attempts`)}}catch(ve){je++,console.error(`   âŒ Retry exception for ${ue.phone}:`,ve)}A>0&&(c.success(`âœ… Retry successful: ${A} messages sent`,{duration:4e3}),Et("Smart Retry",`${A} messages retried successfully`)),je>0&&console.log(`   âš ï¸  ${je} messages still failed after retry`)}else console.log("   â„¹ï¸  No retryable errors (all failures are permanent)")}const Ne=u.length,Be=N.length-u.length;if(Et("Campaign Completed",`${I} sent, ${O} failed`),I>0&&O===0?ht("complete"):O>0&&ht("error"),Xs){I===Ne&&Ne>0?pt("âœ… Campaign Complete!",`All ${I} messages sent successfully!`):pt("ğŸ“Š Campaign Complete",`${I} sent, ${O} failed`);const B=os?Math.floor((Date.now()-os)/1e3):0;ei(I,O,Ne,B,{milestones:[25,50,75,90],enableSounds:ks,enableDesktop:!0,enableEmail:!1})}I===Ne&&Ne>0?c.success(`âœ… All ${I} messages sent successfully! ${Be>0?`(${Be} skipped)`:""}`,{duration:5e3}):I>0?c.success(`âœ… ${I} sent, ${O} failed${Be>0?`, ${Be} skipped`:""}`,{duration:5e3}):c.error(`âŒ All ${O} messages failed${Be>0?` (${Be} skipped)`:""}`),console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`),console.log("â•‘          ğŸ“Š BULK WHATSAPP SEND - FINAL RESULTS              â•‘"),console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(`âœ… Successfully Sent: ${I}/${Ne} (${Math.round(I/Ne*100)}%)`),console.log(`âŒ Failed: ${O}/${Ne} (${Math.round(O/Ne*100)}%)`),console.log(`â­ï¸  Skipped (Anti-ban): ${Be}`),console.log(`ğŸ“Š Total Processed: ${Ne}`),console.log(`ğŸ“Š Total Selected: ${N.length}`);const Is=rn();if(Is){const B=O===0||I>O;await Bo(Is,{name:ls||`Campaign ${new Date().toLocaleDateString()}`,message:b,messageType:q,selectedRecipients:N,sentPhones:le,bulkProgress:{current:f+Ne,total:F,success:I,failed:O},failedMessages:de,campaignStartTime:os,settings:{usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es},conversations:i.map(y=>({phone:y.phone,customer_name:y.customer_name}))},B),console.log("âœ… Campaign finalized in database"),Is&&await ri(Is,O===Ne?"failed":"completed",{success:I,failed:O,total:F})}if(de.length>0){console.log(`
âŒ FAILURE ANALYSIS (${de.length} failed):`);const B={not_on_whatsapp:de.filter(y=>y.errorType==="not_on_whatsapp"),invalid_format:de.filter(y=>y.errorType==="invalid_format"),rate_limit:de.filter(y=>y.errorType==="rate_limit"),other:de.filter(y=>y.errorType==="other")};B.not_on_whatsapp.length>0&&(console.log(`
ğŸ“± NOT ON WHATSAPP (${B.not_on_whatsapp.length}):`),console.log("   These numbers may have wrong country codes or aren't registered:"),B.not_on_whatsapp.slice(0,5).forEach(y=>{console.log(`   â€¢ ${y.phone} (${y.name})`)}),B.not_on_whatsapp.length>5&&console.log(`   ... and ${B.not_on_whatsapp.length-5} more`),console.log("   ğŸ’¡ TIP: Verify country codes and check if numbers are active on WhatsApp")),B.invalid_format.length>0&&(console.log(`
ğŸ”¢ INVALID FORMAT (${B.invalid_format.length}):`),console.log("   These numbers have formatting issues:"),B.invalid_format.slice(0,5).forEach(y=>{console.log(`   â€¢ ${y.phone} (${y.name})`)}),B.invalid_format.length>5&&console.log(`   ... and ${B.invalid_format.length-5} more`),console.log("   ğŸ’¡ TIP: Use format: CountryCode+Number (e.g., 255712345678)")),B.rate_limit.length>0&&(console.log(`
â±ï¸ RATE LIMIT (${B.rate_limit.length}):`),console.log("   These failed due to API rate limiting"),console.log("   ğŸ’¡ TIP: Increase delays or reduce batch size in anti-ban settings")),B.other.length>0&&(console.log(`
â“ OTHER ERRORS (${B.other.length}):`),B.other.slice(0,3).forEach(y=>{console.log(`   â€¢ ${y.phone}: ${y.error.substring(0,60)}...`)}))}console.log(`
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`),I>0&&(Sa(),console.log("ğŸ—‘ï¸ Draft cleared after successful send")),wa(),console.log("ğŸ—‘ï¸ Cleared paused campaign state after completion"),ps()}catch(D){console.error(`
âŒ [CRITICAL ERROR] Bulk send failed:`),console.error("Error details:",D),console.error("Stack trace:",D),c.error("Bulk send failed. Please try again."),C(3)}finally{Se(!1),console.log(`ğŸ Bulk send process finished
`)}}async function hl(){if(console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`),console.log("â•‘     â˜ï¸  BULK WHATSAPP - CLOUD MODE SUBMISSION START         â•‘"),console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),!b.trim()&&q==="text"){console.error("âŒ [VALIDATION ERROR] Message is empty"),c.error("Please enter a message");return}if(N.length===0){console.error("âŒ [VALIDATION ERROR] No recipients selected"),c.error("Please select at least one recipient");return}try{console.log("ğŸ“‹ [PREP] Preparing campaign data..."),console.log(`   â€¢ Recipients: ${N.length}`),console.log(`   â€¢ Campaign Name: ${ls||"Auto-generated"}`),console.log(`   â€¢ Message Type: ${q}`),console.log(`   â€¢ Has Media: ${!!Fe}`);const r=N.map(f=>{const M=i.find(F=>F.phone===f);return{phone:f,name:(M==null?void 0:M.customer_name)||"Customer"}});console.log(`   â€¢ Recipients prepared: ${r.length}`);let s=Fe;const a={userId:t==null?void 0:t.id,name:ls||`Campaign ${new Date().toLocaleDateString()}`,message:b,recipients:r,settings:{use_personalization:Re,random_delay:Ie,min_delay:ye,max_delay:Ee,use_presence:Pe},mediaUrl:s,mediaType:Qs!=="text"?Qs:void 0};console.log("ğŸ“¤ [API] Sending campaign to cloud backend..."),console.log("   Endpoint: POST /api/bulk-whatsapp/create"),console.log("   Payload:",{...a,message:a.message.substring(0,50)+"...",recipients:`${a.recipients.length} recipients`});const g=await fetch("/api/bulk-whatsapp/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});console.log(`ğŸ“¥ [RESPONSE] Status: ${g.status} ${g.statusText}`);const u=await g.json();if(console.log("   Response data:",u),u.success)console.log("âœ… [SUCCESS] Campaign created successfully"),console.log(`   Campaign ID: ${u.campaignId}`),Hn(u.campaignId),C(4),c.success("âœ… Campaign submitted to cloud! Processing in background..."),console.log("ğŸ”„ [POLLING] Starting progress monitoring..."),pl(u.campaignId);else throw console.error("âŒ [ERROR] Campaign creation failed:",u.error),new Error(u.error||"Failed to create campaign")}catch(r){console.error("âŒ [EXCEPTION] Error submitting cloud campaign:",r),console.error("Stack trace:",r),c.error("Failed to submit campaign to cloud")}console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`)}function pl(r){console.log(`
ğŸ”„ [POLLING] Starting progress monitoring for campaign: ${r}`),console.log("   Poll interval: 3 seconds"),qt&&(console.log("   Clearing existing polling interval"),clearInterval(qt));let s=0;const a=setInterval(async()=>{s++;try{console.log(`
ğŸ“Š [POLL #${s}] Fetching campaign status...`);const g=await fetch(`/api/bulk-whatsapp/status/${r}`),u=await g.json();if(console.log(`   Status: ${g.status}`),console.log(`   Success: ${u.success}`),u.success&&u.campaign){const f=u.campaign;console.log(`   Campaign Status: ${f.status}`),console.log(`   Progress: ${f.progress.current}/${f.progress.total}`),console.log(`   Success: ${f.progress.success} | Failed: ${f.progress.failed}`),ce({current:f.progress.current,total:f.progress.total,success:f.progress.success,failed:f.progress.failed}),(f.status==="completed"||f.status==="failed")&&(console.log(`
ğŸ [POLLING] Campaign finished with status: ${f.status}`),console.log(`   Total polls: ${s}`),console.log(`   Final results: ${f.progress.success} sent, ${f.progress.failed} failed`),console.log(`   Stopping polling...
`),clearInterval(a),kr(null),f.status==="completed"?c.success(`âœ… Campaign complete! ${f.progress.success} sent, ${f.progress.failed} failed`):c.error("Campaign failed"))}}catch(g){console.error(`âŒ [POLL ERROR] Error on poll #${s}:`,g)}},3e3);kr(a),console.log(`âœ… [POLLING] Polling interval started
`)}m.useEffect(()=>()=>{qt&&clearInterval(qt)},[qt]);const Na=i.reduce((r,s)=>r+s.unread_count,0),Or=i.filter(r=>{const s=r.messages&&r.messages.length>0?r.messages[r.messages.length-1]:null;return(s==null?void 0:s.type)==="received"}).length,va=i.filter(r=>{var s,a,g;if(ge){const u=ge.toLowerCase();return((s=r.last_message)==null?void 0:s.toLowerCase().includes(u))||((a=r.phone)==null?void 0:a.toLowerCase().includes(u))||((g=r.customer_name)==null?void 0:g.toLowerCase().includes(u))}return!0}),Ja=r=>{const s=new Date(r),g=(new Date().getTime()-s.getTime())/(1e3*60*60);return g<24?s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):g<48?"Yesterday "+s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):g<168?s.toLocaleDateString("en-US",{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!0}):s.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})},Ya=r=>r.split(" ").map(s=>s[0]).join("").toUpperCase().slice(0,2),Gr=r=>{const s=r.messages.length,a=r.messages.filter(f=>f.type==="received").length,g=s>0?a/s*100:0;let u=0;return u+=Math.min(s*2,30),u+=Math.min(a*10,50),u+=Math.min(g,20),u>=70?{level:"High",color:"green",score:u}:u>=40?{level:"Medium",color:"yellow",score:u}:{level:"Low",color:"gray",score:u}},fl=r=>Ua.some(s=>s.phone===r),zr=r=>{const s=r.replace(/[^\d+]/g,"");return s.length>=10&&/^\+?\d{10,15}$/.test(s)},bl=r=>{if(jr(r),r==="all")ee(i.map(s=>s.phone));else if(r==="high-engagement"){const s=i.filter(a=>Gr(a).level==="High");ee(s.map(a=>a.phone))}else if(r==="recent"){const s=i.slice(0,10);ee(s.map(a=>a.phone))}else if(r==="unread"){const s=i.filter(a=>a.unread_count>0);ee(s.map(a=>a.phone))}},yl=()=>{jr(null),ee([])},wl=async r=>{if(N.length===0){c.error("Please select recipients first");return}c.loading("Filtering recipients by segment criteria...",{id:"segment-filter"});try{const s=await dn(N,r);ee(s),Pr(r);const a=N.length-s.length;c.dismiss("segment-filter"),a>0?c.success(`Filtered: ${s.length} recipients match criteria (${a} removed)`,{duration:4e3}):c.success(`All ${s.length} recipients match criteria`,{duration:3e3});const g=await mn(s);al(g)}catch(s){c.dismiss("segment-filter"),console.error("Error applying segmentation:",s),c.error("Failed to apply segmentation filter")}},jl=async r=>{var a;const s=(a=r.target.files)==null?void 0:a[0];if(s){Nr(s),vr(!0);try{const u=(await s.text()).split(`
`).filter(M=>M.trim()),f=[];u.slice(1).forEach(M=>{const[F,we]=M.split(",").map(D=>D.trim());if(F&&we){const D=/^\+?\d{10,15}$/.test(F.replace(/[^\d+]/g,"")),I=D?F:we,O=D?we:F;zr(I)&&f.push({phone:I,name:O})}}),wr(f),ee(f.map(M=>M.phone)),c.success(`Imported ${f.length} recipients from CSV`)}catch(g){console.error("Error parsing CSV:",g),c.error("Failed to parse CSV file")}finally{vr(!1)}}},Nl=async r=>{var g;const s=(g=r.target.files)==null?void 0:g[0];if(!s)return;const a=16*1024*1024;if(s.size>a){c.error("File size must be less than 16MB");return}try{if(c.loading("Uploading media...",{id:"media-upload"}),s.type.startsWith("image/")){const u=new FileReader;u.onload=f=>{var M;Ks((M=f.target)==null?void 0:M.result)},u.readAsDataURL(s),xs("image"),Ue("image")}else s.type.startsWith("video/")?(xs("video"),Ue("video")):s.type.startsWith("audio/")?(xs("audio"),Ue("audio")):(xs("document"),Ue("document"));js(s),c.success("Media ready to send!",{id:"media-upload"})}catch(u){console.error("Error uploading media:",u),c.error("Failed to upload media",{id:"media-upload"})}},vl=()=>{Nr(null),wr([]),ee([])},Sl=async r=>{try{const{data:s,error:a}=await H.from("whatsapp_recipient_lists").select("*").eq("id",r).single();if(a)throw a;s&&(ee(s.recipients||[]),ot(s.name),c.success(`Loaded list: ${s.name}`))}catch(s){console.error("Error loading recipient list:",s),c.error("Failed to load recipient list")}},kl=async()=>{try{c.loading("Loading all customers from database...",{id:"load-customers"});let r=[],s=0;const a=1e3;let g=!0;for(;g;){const{data:f,error:M,count:F}=await H.from("customers").select("phone, whatsapp",{count:"exact"}).range(s,s+a-1);if(M)throw M;f&&f.length>0?(r=[...r,...f],s+=a,g=f.length===a):g=!1}const u=[];r.forEach(f=>{const M=F=>(F==null?void 0:F.replace(/[\s\-\(\)]/g,""))||"";if(f.whatsapp){const F=M(f.whatsapp);F&&!u.includes(F)&&u.push(F)}else if(f.phone){const F=M(f.phone);F&&!u.includes(F)&&u.push(F)}}),ee(u),c.success(`Loaded ${u.length} customers with phone numbers`,{id:"load-customers"})}catch(r){console.error("Error loading customers:",r),c.error("Failed to load customers",{id:"load-customers"})}},Xa=r=>{const s=[],a=["free money","click here","limited time","act now","urgent","guaranteed","no risk","winner","congratulations","prize","claim now","click below","buy now","discount code","special offer","exclusive deal","one time only"],g=r.toLowerCase(),u=a.filter(F=>g.includes(F));u.length>0&&s.push({type:"spam",message:`Potential spam words detected: ${u.slice(0,3).join(", ")}`}),r.length>3500?s.push({type:"character",message:`Message is very long (${r.length}/4096 characters). Consider shortening.`}):r.length>3e3&&s.push({type:"character",message:`Message is getting long (${r.length}/4096 characters)`});const f=r.toLowerCase().trim().replace(/\s+/g," ");return Pa.some(F=>F.toLowerCase().trim().replace(/\s+/g," ")===f)&&r.trim().length>10&&s.push({type:"duplicate",message:"This message was sent recently. Consider using a variation."}),s},_l=r=>{const s=[],a=[];return r.forEach(g=>{const u=g.replace(/\D/g,"");(u.length<10||u.length>15)&&a.push(g)}),a.length>0&&s.push({type:"phone",message:`${a.length} phone number(s) may be invalid: ${a.slice(0,3).join(", ")}`}),s},As=r=>{Gt(a=>[...a,b].slice(-50)),S(r);const s=Xa(r);Je(s)},Wr=()=>{if(Es.length>0){const r=Es[Es.length-1];Gt(a=>a.slice(0,-1)),S(r);const s=Xa(r);Je(s)}},Cl=async()=>{if(!ws||!b.trim()){c.error("Please enter your phone number and message");return}try{c.loading("Sending test message...",{id:"test-send"});let r=b;try{r=await ln(b,ws,"Test User"),r=r.replace(/\{company\}/gi,"Dukani Pro")}catch{r=b.replace(/\{name\}/gi,"Test User").replace(/\{phone\}/gi,ws).replace(/\{company\}/gi,"Dukani Pro")}const s=await Xe.sendMessage(ws,r,{session_id:(ne==null?void 0:ne.id)||void 0});s.success?c.success("Test message sent successfully!",{id:"test-send"}):c.error(s.error||"Failed to send test message",{id:"test-send"})}catch(r){c.error(r.message||"Failed to send test message",{id:"test-send"})}},Dl=async()=>{try{const r=await navigator.clipboard.readText();r&&r.trim()&&(As(b+(b?`
`:"")+r),c.success("Template pasted from clipboard"))}catch{c.error("Failed to read from clipboard")}},Rs=r=>{const s=kt.current;if(!s)return;const a=s.selectionStart,g=s.selectionEnd,u=b,f=u.substring(0,a),M=u.substring(g),F=f+r+M;As(F),setTimeout(()=>{s.focus(),s.setSelectionRange(a+r.length,a+r.length)},0),ca(!1)},ft=r=>{Ue(r),Ba(!1),r==="text"&&!b.trim()&&S("Hey {name}!! We miss you!! Come visit us and enjoy special discounts for returning customers."),c.success(`Switched to ${r} message`)},El=(r,s)=>{const a=["â€‹","â€Œ","â€","\uFEFF"],g=s%a.length,u=a[g],f=1+s%3;let M=r;for(let F=0;F<f;F++){const we=M.split(" ");if(we.length>1){const D=Math.floor(Math.random()*(we.length-1))+1;we.splice(D,0,u),M=we.join(" ")}else M+=u}return M},Tl=(r,s)=>{const a={"ğŸ‘":["ğŸ‘","ğŸ‘Œ","âœŒï¸","ğŸ¤™","ğŸ¤"],"ğŸ˜Š":["ğŸ˜Š","ğŸ˜ƒ","ğŸ™‚","ğŸ˜„","ğŸ˜"],"â¤ï¸":["â¤ï¸","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ§¡"],"ğŸ‰":["ğŸ‰","ğŸŠ","ğŸ¥³","ğŸˆ","âœ¨"],"ğŸ”¥":["ğŸ”¥","ğŸ’¥","âš¡","âœ¨","ğŸ’«"],"ğŸ˜":["ğŸ˜","ğŸ¤©","ğŸ˜»","ğŸ’–","ğŸ’•"],"ğŸ’¯":["ğŸ’¯","âœ…","ğŸ‘","ğŸ†","â­"],"ğŸ":["ğŸ","ğŸ€","ğŸ›ï¸","ğŸ’","ğŸŠ"]};let g=r;for(const[u,f]of Object.entries(a))if(g.includes(u)){const M=s%f.length,F=f[M];g=g.replace(u,F)}return g},Ml=()=>{if(!(w>2))try{const r={selectedRecipients:N,campaignName:ls,bulkStep:Math.min(w,2),bulkMessage:b,bulkMessageType:q,bulkMedia:typeof Fe=="string"?Fe:null,bulkMediaType:Qs,bulkMediaPreview:Wt,viewOnce:Ts,pollQuestion:hs,pollOptions:as,allowMultiSelect:dt,locationLat:Ns,locationLng:vs,locationName:Js,locationAddress:Ys,usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es,savedAt:new Date().toISOString()};localStorage.setItem("whatsapp_bulk_draft",JSON.stringify(r)),_t(!0),console.log("ğŸ’¾ Draft saved")}catch(r){console.error("Failed to save draft:",r)}},Hr=()=>{try{const r=localStorage.getItem("whatsapp_bulk_draft");if(!r)return _t(!1),!1;const s=JSON.parse(r);return ee(s.selectedRecipients||[]),ot(s.campaignName||""),C(Math.min(s.bulkStep||1,2)),S(s.bulkMessage||""),Ue(s.bulkMessageType||"text"),js(s.bulkMedia||null),xs(s.bulkMediaType||""),Ks(s.bulkMediaPreview||""),it(s.viewOnce||!1),ct(s.pollQuestion||""),Ms(s.pollOptions||["",""]),mt(s.allowMultiSelect||!1),wt(s.locationLat||""),jt(s.locationLng||""),Nt(s.locationName||""),vt(s.locationAddress||""),ms(s.usePersonalization??!0),gs(s.randomDelay??!0),us(s.minDelay||3),cs(s.maxDelay||8),Bs(s.batchSize||20),Os(s.batchDelay||60),Ws(s.maxPerHour||30),Fs(s.dailyLimit||100),Hs(s.skipRecentlyContacted??!0),zs(s.respectQuietHours??!0),qs(s.useInvisibleChars??!0),Vs(s.useEmojiVariation??!0),Gs(s.varyMessageLength??!0),_t(!0),console.log("ğŸ“‚ Draft loaded from:",s.savedAt),c.success("Draft restored! Continue where you left off."),!0}catch(r){return console.error("Failed to load draft:",r),_t(!1),!1}},Sa=()=>{try{localStorage.removeItem("whatsapp_bulk_draft"),_t(!1),c.success("Draft cleared"),console.log("ğŸ—‘ï¸ Draft cleared")}catch(r){console.error("Failed to clear draft:",r)}};m.useEffect(()=>{if(pr)return;const r=async()=>{try{const a={usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es};if(!(await fetch("/api/antiban-settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("Failed to save settings to database");console.log("âš™ï¸ Anti-ban settings saved to database"),localStorage.setItem("whatsapp_antiban_settings",JSON.stringify({...a,savedAt:new Date().toISOString()}))}catch(a){console.error("Failed to save anti-ban settings to database:",a);try{const g={usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es,savedAt:new Date().toISOString()};localStorage.setItem("whatsapp_antiban_settings",JSON.stringify(g)),console.log("âš™ï¸ Anti-ban settings saved to localStorage (fallback)")}catch(g){console.error("Failed to save to localStorage fallback:",g)}}},s=setTimeout(()=>{r()},1e3);return()=>clearTimeout(s)},[pr,Re,Ie,ye,Ee,Pe,qe,ze,Qe,ns,Ve,Ye,ss,ts,es]),m.useEffect(()=>{if(oe&&w<=2&&(N.length>0||b.trim()||ls.trim())){const r=setTimeout(()=>{Ml()},1e3);return()=>clearTimeout(r)}},[oe,N,b,q,ls,w,hs,Ns,vs]);const $l=r=>{let s=r;if(Re&&N.length>0){const a=i.find(M=>M.phone===N[0]),g=new Date,u=g.getHours(),f=u<12?"Good morning":u<18?"Good afternoon":"Good evening";s=s.replace(/\{name\}/gi,(a==null?void 0:a.customer_name)||"Customer").replace(/\{phone\}/gi,N[0]||"Phone").replace(/\{date\}/gi,g.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})).replace(/\{time\}/gi,g.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})).replace(/\{greeting\}/gi,f).replace(/\{day\}/gi,g.toLocaleDateString("en-US",{weekday:"long"})).replace(/\{month\}/gi,g.toLocaleDateString("en-US",{month:"long"})).replace(/\{company\}/gi,"Dukani Pro")}return s=s.replace(/\*([^*]+)\*/g,"<strong>$1</strong>"),s=s.replace(/_([^_]+)_/g,"<em>$1</em>"),s=s.replace(/~([^~]+)~/g,"<del>$1</del>"),s=s.replace(/```([^`]+)```/g,'<code class="bg-gray-200 px-1 rounded">$1</code>'),s};if(E)return e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto",children:e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(_s,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Failed to Load WhatsApp Inbox"}),e.jsx("p",{className:"text-gray-600 mb-6 text-center max-w-md",children:E}),e.jsxs("div",{className:"flex gap-3 flex-wrap justify-center",children:[e.jsxs("button",{onClick:()=>{const r=new Error(E);Ul.exportError(r,{severity:"critical",module:"WhatsAppInboxPage",function:"initialization",operation:"page_load",context:{filter:U,currentUser:t==null?void 0:t.id},autoDownload:!0}),c.success("Error details downloaded!")},className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2",children:[e.jsx(ds,{className:"w-4 h-4"}),"Download Error Details"]}),e.jsxs("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center gap-2",children:[e.jsx(rs,{className:"w-4 h-4"}),"Refresh Page"]}),e.jsx("button",{onClick:()=>o("/"),className:"px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold",children:"Go to Dashboard"})]})]})});const Pl=()=>{if(!da||!oe)return null;const r=ie||h.total>0;return h.success+h.failed>0&&Math.round(h.success/(h.success+h.failed)*100),e.jsxs("div",{className:"fixed bottom-4 right-4 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden",style:{zIndex:999999,width:"280px"},children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center shadow-lg",children:r?e.jsx(fs,{className:"w-4 h-4 text-white"}):e.jsx(It,{className:"w-4 h-4 text-white"})}),e.jsx("div",{children:e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:r?"Campaign Active":"Bulk Campaign"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>qn(!Dt),className:"w-7 h-7 flex items-center justify-center bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors",title:Dt?"Collapse":"Expand details",children:e.jsx(Kt,{className:`w-4 h-4 transition-transform ${Dt?"rotate-180":""}`})}),e.jsx("button",{onClick:()=>{gt(!1),c.success("Expanded to full view")},className:"w-7 h-7 flex items-center justify-center bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full transition-colors",title:"Expand to full modal",children:e.jsx(yt,{className:"w-4 h-4"})}),!r&&e.jsx("button",{onClick:()=>{window.confirm("Close campaign?")&&(gt(!1),x(!1),C(1),ee([]),S(""))},className:"w-7 h-7 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg",children:e.jsx(Te,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:`p-3 space-y-3 text-xs bg-white ${Dt?"overflow-y-auto":""}`,style:{maxHeight:Dt?"500px":"auto"},children:[r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-gray-700",children:[e.jsx("span",{className:"font-medium",children:"Progress"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:[h.current,"/",h.total]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-2 bg-gradient-to-r from-orange-500 to-orange-600 transition-all duration-300",style:{width:`${h.total>0?h.current/h.total*100:0}%`}})}),e.jsxs("p",{className:"text-center text-xs text-gray-600",children:[h.total>0?Math.round(h.current/h.total*100):0,"% Complete"]})]}),(h.success>0||h.failed>0)&&e.jsxs("div",{className:"flex gap-2 text-xs",children:[e.jsxs("div",{className:"flex-1 bg-green-50 border border-green-200 p-2 rounded-xl",children:[e.jsx("div",{className:"text-gray-600 mb-1",children:"Success"}),e.jsx("div",{className:"font-bold text-green-600 text-lg",children:h.success})]}),e.jsxs("div",{className:"flex-1 bg-red-50 border border-red-200 p-2 rounded-xl",children:[e.jsx("div",{className:"text-gray-600 mb-1",children:"Failed"}),e.jsx("div",{className:"font-bold text-red-600 text-lg",children:h.failed})]})]}),Dt&&e.jsxs(e.Fragment,{children:[(h.success>0||h.failed>0)&&e.jsxs("div",{className:"p-3 bg-purple-50 border border-purple-200 rounded-xl",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-2 text-xs",children:"Campaign Statistics"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Success Rate"}),e.jsxs("p",{className:"font-bold text-purple-600",children:[h.success+h.failed>0?Math.round(h.success/(h.success+h.failed)*100):0,"%"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Remaining"}),e.jsx("p",{className:"font-bold text-orange-600",children:h.total-h.current})]}),ma&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-gray-600",children:"Est. Time Left"}),e.jsx("p",{className:"font-bold text-blue-600",children:qa(ma)})]})]})]}),Qt.length>0&&e.jsxs("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-xl",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-2 text-xs flex items-center gap-1",children:[e.jsx(cr,{className:"w-3 h-3"}),"Recent Activity"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:[...Qt].reverse().slice(0,3).map((s,a)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full mt-1 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.event}),s.details&&e.jsx("p",{className:"text-gray-600 text-[10px]",children:s.details}),e.jsx("p",{className:"text-gray-500 text-[10px]",children:new Date(s.time).toLocaleTimeString()})]})]},a))})]}),le.length>0&&e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-xl",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-2 text-xs flex items-center gap-1",children:[e.jsx(xe,{className:"w-3 h-3"}),"Recently Sent (",le.length,")"]}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:le.slice(-3).reverse().map(s=>{const a=i.find(g=>g.phone===s);return e.jsxs("div",{className:"text-xs text-gray-700 flex items-center gap-2 bg-white p-1.5 rounded",children:[e.jsx(xe,{className:"w-2.5 h-2.5 text-green-500 flex-shrink-0"}),e.jsx("span",{className:"font-medium truncate",children:(a==null?void 0:a.customer_name)||"Unknown"})]},s)})})]}),de.length>0&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-xl",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 mb-2 text-xs flex items-center gap-1",children:[e.jsx(_s,{className:"w-3 h-3"}),"Failed (",de.length,")"]}),e.jsx("div",{className:"space-y-1 max-h-24 overflow-y-auto",children:de.slice(0,3).map((s,a)=>e.jsxs("div",{className:"bg-white p-1.5 rounded text-[10px]",children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.name}),e.jsxs("p",{className:"text-red-600 truncate",children:["âŒ ",s.error]})]},a))})]}),!ie&&(h.success>0||de.length>0)&&e.jsxs("div",{className:"pt-2 border-t border-gray-200 space-y-1",children:[e.jsx("p",{className:"text-[10px] font-semibold text-gray-700 mb-1",children:"Export Data"}),le.length>0&&e.jsxs("button",{onClick:Rr,className:"w-full px-2 py-1.5 bg-green-600 text-white text-[10px] font-medium rounded-lg hover:bg-green-700 flex items-center justify-center gap-1",children:[e.jsx(ds,{className:"w-3 h-3"}),"Export Sent (",le.length,")"]}),de.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Ir,className:"w-full px-2 py-1.5 bg-red-600 text-white text-[10px] font-medium rounded-lg hover:bg-red-700 flex items-center justify-center gap-1",children:[e.jsx(ds,{className:"w-3 h-3"}),"Export Failed (",de.length,")"]}),e.jsxs("button",{onClick:Qa,className:"w-full px-2 py-1.5 bg-gray-800 text-white text-[10px] font-medium rounded-lg hover:bg-gray-900 flex items-center justify-center gap-1",children:[e.jsx(rt,{className:"w-3 h-3"}),"Blacklist Failed"]})]})]})]}),r?e.jsxs("div",{className:"space-y-2 pt-2 border-t border-gray-200",children:[e.jsx("button",{onClick:()=>{Ct(!0),c("Pausing...")},disabled:$s||Ss,className:"w-full px-3 py-2 bg-yellow-500 text-white text-xs font-medium rounded-xl hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg",children:$s?"Pausing...":"Pause Campaign"}),e.jsx("button",{onClick:()=>{window.confirm("Stop campaign?")&&(Vt(!0),c("Stopping..."))},disabled:Ss,className:"w-full px-3 py-2 bg-red-500 text-white text-xs font-medium rounded-xl hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg",children:Ss?"Stopping...":"Stop Campaign"})]}):h.current===h.total&&h.total>0&&e.jsx("div",{className:"pt-2 border-t border-gray-200",children:e.jsx("button",{onClick:()=>{gt(!1),x(!1),C(1),Se(!1),ce({current:0,total:0,success:0,failed:0}),ee([]),S(""),wa(),c.success("Complete")},className:"w-full px-3 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs font-semibold rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg",children:"Done"})})]})]})},Al=()=>{if(console.log("â–¶ï¸ Opening resume options..."),!Ps)return;const r=new Date(Ps.pauseTimestamp||Ps.timestamp).getTime(),s=(Date.now()-r)/(1e3*60*60);s>24&&window.confirm(`âš ï¸ WARNING: Campaign paused ${Math.floor(s)} hours ago

Recipients list may be outdated. Review before sending?

Click OK to review, Cancel to resume as-is.`)&&Jn(!0);const a=Ps,g=a.sentPhones||[];ut(g),console.log(`ğŸ“‹ Restored ${g.length} already-sent phones from paused campaign`);const u=(a.selectedRecipients||[]).filter(f=>!g.includes(f));ee(u),console.log(`ğŸ“‹ ${u.length} pending recipients remaining (filtered out ${g.length} already sent)`),S(a.bulkMessage||""),Ue(a.bulkMessageType||"text"),js(a.bulkMedia||null),ce(a.bulkProgress||{current:0,total:0,success:0,failed:0}),a.usePersonalization!==void 0&&ms(a.usePersonalization),a.randomDelay!==void 0&&gs(a.randomDelay),a.minDelay&&us(a.minDelay),a.maxDelay&&cs(a.maxDelay),a.usePresence!==void 0&&lt(a.usePresence),a.batchSize&&Bs(a.batchSize),a.batchDelay&&Os(a.batchDelay),a.maxPerHour&&Ws(a.maxPerHour),a.dailyLimit&&Fs(a.dailyLimit),a.skipRecentlyContacted!==void 0&&Hs(a.skipRecentlyContacted),a.respectQuietHours!==void 0&&zs(a.respectQuietHours),a.useInvisibleChars!==void 0&&qs(a.useInvisibleChars),a.useEmojiVariation!==void 0&&Vs(a.useEmojiVariation),a.varyMessageLength!==void 0&&Gs(a.varyMessageLength),a.viewOnce!==void 0&&it(a.viewOnce),a.pollQuestion&&ct(a.pollQuestion),a.pollOptions&&Ms(a.pollOptions),a.allowMultiSelect!==void 0&&mt(a.allowMultiSelect),a.locationLat&&wt(a.locationLat),a.locationLng&&jt(a.locationLng),a.locationName&&Nt(a.locationName),a.locationAddress&&vt(a.locationAddress),x(!0),Kn?(C(2),c("Review and edit your message before resuming",{icon:"âœï¸",duration:5e3})):(C(4),setTimeout(()=>{Tt(!0)},500))};return e.jsxs(Pt.Fragment,{children:[e.jsx(Ro,{onNewMessage:()=>$e(!0),onBulkSend:()=>{console.log("ğŸš€ Opening Bulk Send modal..."),localStorage.getItem("whatsapp_bulk_draft")&&Oa?window.confirm(`ğŸ’¾ You have a saved draft from a previous session.

Would you like to continue where you left off?

Click OK to load draft, or Cancel to start fresh.`)?Hr():(Sa(),C(1)):C(1),gt(!1),Se(!1),ce({current:0,total:0,success:0,failed:0}),x(!0)},onCampaignManagement:()=>fr(!0),onTemplates:()=>ha(!0),onScheduled:()=>Tr(!0),onBlacklist:()=>br(!0),onMediaLibrary:()=>Ia(!0),onSessionManagement:()=>la(!0),onAutomation:()=>yr(!0),onRefresh:ps,onResumeCampaign:Ps?Al:void 0,refreshing:G,hasDraft:Oa,pausedCampaignState:Ps,unreadCount:Na,conversationsCount:i.length}),e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto",style:{paddingTop:"calc(var(--app-topbar-height, 0px) + 20px)"},children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col",style:{maxHeight:"calc(95vh - 20px)"},children:[e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg flex-shrink-0",children:e.jsx(st,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:"WhatsApp Business"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-2",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),n.length," conversations â€¢ ",Na," new"]}),ne&&e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-green-50 border border-green-200 rounded-full",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${ne.status==="connected"?"bg-green-500":"bg-red-500"}`}),e.jsxs("span",{className:"text-xs text-gray-700 font-medium",children:["ğŸ“± ",ne.name]})]}),!ne&&!En&&e.jsxs("button",{onClick:()=>la(!0),className:"px-3 py-1 bg-yellow-500 hover:bg-yellow-600 rounded-full text-xs text-white font-semibold transition-all flex items-center gap-1",title:"No active session - click to set up",children:[e.jsx(_s,{className:"w-3 h-3"}),"No Session"]})]})]})]})})}),e.jsxs("div",{className:"flex-1 overflow-y-auto bg-gradient-to-b from-gray-50 to-white",children:[e.jsx("div",{className:"p-4 flex-shrink-0 bg-white border-b border-gray-200 sticky top-0 z-10",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(nt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:ge,onChange:r=>Ce(r.target.value),className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-full focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-gray-900 bg-gray-50"})]})}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 rounded-full p-1",children:[e.jsxs("button",{onClick:()=>ae("all"),className:`px-4 py-2 rounded-full font-medium text-sm transition-all ${U==="all"?"bg-white text-green-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:["All ",n.length>0&&`(${n.length})`]}),e.jsxs("button",{onClick:()=>ae("unread"),className:`px-4 py-2 rounded-full font-medium text-sm transition-all ${U==="unread"?"bg-white text-green-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:["Unread ",Na>0&&`(${Na})`]}),e.jsxs("button",{onClick:()=>ae("unreplied"),className:`px-4 py-2 rounded-full font-medium text-sm transition-all ${U==="unreplied"?"bg-white text-green-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:["Pending ",Or>0&&`(${Or})`]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-4",children:v?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mb-4"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Loading conversations..."})]}):va.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(st,{className:"w-10 h-10 text-green-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"No conversations found"}),e.jsx("p",{className:"text-gray-500 text-sm max-w-md",children:ge||U!=="all"?"Try adjusting your search or filter to see more conversations":"When you send or receive WhatsApp messages, conversations will appear here"})]}):e.jsx("div",{className:"space-y-2 mb-4",children:va.map(r=>{var s;return e.jsxs("div",{className:`rounded-2xl bg-white shadow-sm transition-all duration-200 cursor-pointer overflow-hidden border ${r.unread_count>0?"border-green-500 bg-green-50/30":(p==null?void 0:p.phone)===r.phone?"border-green-500 shadow-md":"border-gray-200 hover:border-green-300"}`,onClick:()=>{T(r),He(r.phone),r.unread_count>0&&Fr(r)},children:[e.jsxs("div",{className:"flex items-center gap-3 p-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md ${r.unread_count>0?"bg-gradient-to-br from-green-500 to-green-600":"bg-gradient-to-br from-gray-400 to-gray-500"}`,children:r.customer_name?Ya(r.customer_name):e.jsx(At,{className:"w-6 h-6"})}),r.unread_count>0&&e.jsx("div",{className:"absolute -top-1 -right-1 min-w-[20px] h-5 bg-blue-500 border-2 border-white rounded-full flex items-center justify-center px-1",children:e.jsx("span",{className:"text-xs text-white font-bold",children:r.unread_count})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-bold text-gray-900 truncate",children:r.customer_name||"Unknown"}),e.jsx("span",{className:"text-xs text-gray-500 ml-2 flex-shrink-0",children:Ja(r.last_message_time)})]}),e.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-1 mb-1",children:[e.jsx(bt,{className:"w-3 h-3"}),r.phone]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("p",{className:`text-sm line-clamp-1 flex-1 ${r.unread_count>0?"font-semibold text-gray-900":"text-gray-600"}`,children:r.last_message})})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 flex-shrink-0",children:[e.jsxs("div",{className:"text-xs text-gray-500 font-medium",children:[r.messages.length," msgs"]}),(()=>{const a=r.messages[r.messages.length-1];return(a==null?void 0:a.type)==="sent"?e.jsx("div",{className:"flex items-center gap-1 text-green-600",children:e.jsx(xe,{className:"w-4 h-4"})}):r.unread_count>0?e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}):null})()]})]}),Me===r.phone&&e.jsxs("div",{className:"bg-gradient-to-b from-green-50/30 to-white px-4 pb-4 pt-3 border-t border-gray-200",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:r.messages.map((a,g)=>e.jsx("div",{className:`flex items-start gap-2 ${a.type==="sent"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-2xl p-3 shadow-sm ${a.type==="sent"?"bg-green-500 text-white rounded-tr-sm":"bg-white border border-gray-200 text-gray-900 rounded-tl-sm"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap leading-relaxed text-sm",children:a.message}),a.media_url&&(()=>{const u=Ar(a.media_url);return u?e.jsx("div",{className:"mt-2",children:a.message_type==="image"?e.jsx("img",{src:u,alt:"Message attachment",className:"max-w-full rounded-lg",onError:f=>{const M=f.target;M.style.display="none";const F=M.parentElement;if(F&&!F.querySelector(".media-error-placeholder")){const we=document.createElement("div");we.className="media-error-placeholder p-3 bg-gray-100 rounded-lg text-sm text-gray-600",we.textContent="Media file could not be loaded",F.appendChild(we)}}}):e.jsxs("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:`inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium ${a.type==="sent"?"bg-green-600 hover:bg-green-700":"bg-gray-100 hover:bg-gray-200"}`,children:[e.jsx(tt,{className:"w-4 h-4"}),"View ",a.message_type]})}):e.jsxs("div",{className:"mt-2 p-3 bg-gray-100 rounded-lg text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4 inline mr-2"}),"Media file not available"]})})(),e.jsxs("div",{className:`mt-1 text-xs flex items-center justify-between gap-2 ${a.type==="sent"?"text-green-100":"text-gray-500"}`,children:[e.jsx("span",{children:Ja(a.timestamp)}),a.type==="sent"&&a.status&&e.jsxs("span",{className:"flex items-center gap-1",children:[a.status==="sent"&&e.jsx(xe,{className:"w-3 h-3"}),a.status==="delivered"&&e.jsx(xe,{className:"w-3 h-3 text-green-200"}),a.status==="read"&&e.jsx(xe,{className:"w-3 h-3 text-blue-300"})]})]})]})},a.id))}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:me[r.phone]||"",onChange:a=>{a.stopPropagation(),X(g=>({...g,[r.phone]:a.target.value}))},onKeyPress:a=>{a.key==="Enter"&&!Q&&(a.preventDefault(),a.stopPropagation(),Br(r))},onClick:a=>a.stopPropagation(),placeholder:"Type a message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-sm",disabled:Q}),e.jsxs("button",{onClick:a=>{a.stopPropagation(),Br(r)},disabled:Q||!((s=me[r.phone])!=null&&s.trim()),className:"px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(fs,{className:"w-4 h-4"}),Q?"Sending...":"Send"]})]}),e.jsxs("div",{className:"flex gap-3 mt-2",children:[r.unread_count>0&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),Fr(r)},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 font-medium",children:[e.jsx(yt,{className:"w-3 h-3"}),"Mark as Read"]}),e.jsxs("button",{onClick:a=>{a.stopPropagation();const g=`https://wa.me/${r.phone.replace(/[^0-9]/g,"")}`;window.open(g,"_blank")},className:"text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1",children:[e.jsx(st,{className:"w-3 h-3"}),"Open in WhatsApp"]}),r.customer_id&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),o(`/customers?id=${r.customer_id}`)},className:"text-xs text-gray-600 hover:text-gray-900 flex items-center gap-1",children:[e.jsx(At,{className:"w-3 h-3"}),"Customer Profile"]})]})]})]})]},r.phone)})})})]})]}),oa&&oa.status==="using_integration_credentials"&&e.jsx("div",{className:"mt-6 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-2xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(_s,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-yellow-900 mb-1 flex items-center gap-2",children:"âš ï¸ Using Old Integration Credentials"}),e.jsxs("p",{className:"text-sm text-yellow-800 mb-3",children:["You can send messages because you have credentials configured in ",e.jsx("strong",{children:"Admin Settings â†’ Integrations"}),", but you haven't created any sessions in the database yet."]}),e.jsxs("div",{className:"bg-white/50 p-3 rounded-lg mb-3",children:[e.jsx("p",{className:"text-xs font-semibold text-yellow-900 mb-2",children:"Currently Using:"}),e.jsxs("div",{className:"space-y-1 text-xs text-yellow-800",children:[e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Session ID:"})," ",((qr=oa.integration)==null?void 0:qr.session_id)||"Not set"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"API Key:"})," ",((Vr=oa.integration)==null?void 0:Vr.api_key_preview)||"Not set"]}),e.jsxs("p",{children:["â€¢ ",e.jsx("strong",{children:"Status:"})," Configured in integrations table (old system)"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>la(!0),className:"px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-semibold text-sm transition-all flex items-center gap-2",children:[e.jsx(sa,{className:"w-4 h-4"}),"Create Database Session"]}),e.jsx("button",{onClick:()=>{Lr(),ja()},className:"px-4 py-2 bg-white border border-yellow-300 text-yellow-800 rounded-lg font-semibold text-sm transition-all hover:bg-yellow-50",children:e.jsx(rs,{className:"w-4 h-4"})})]})]})]})}),va.length===0&&!v&&!ge&&U==="all"&&e.jsx("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-2xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(st,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-blue-900 mb-1",children:"WhatsApp Integration Active"}),e.jsxs("p",{className:"text-sm text-blue-700 mb-2",children:["This inbox receives messages via ",e.jsx("strong",{children:"WasenderAPI"})," webhooks. Messages from customers appear automatically when they send you a WhatsApp message."]}),e.jsxs("div",{className:"text-xs text-blue-600 space-y-1",children:[e.jsx("p",{children:"âœ… Webhook configured and listening"}),e.jsx("p",{children:"âœ… Auto-links messages to customers by phone"}),e.jsx("p",{children:"âœ… Supports text, images, videos, documents & audio"}),e.jsx("p",{children:"âœ… Reply with quoted message support"})]}),e.jsx("a",{href:"https://wasenderapi.com/api-docs",target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 mt-3 text-xs text-blue-600 hover:text-blue-800 font-medium",children:"View API Documentation â†’"})]})]})}),K&&e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-green-600 to-emerald-600 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg bg-white/20 backdrop-blur-sm",children:(Qr=K.customers)!=null&&Qr.name?Ya(K.customers.name):e.jsx(At,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:((Kr=K.customers)==null?void 0:Kr.name)||"Unknown Customer"}),e.jsxs("p",{className:"text-sm text-green-100 flex items-center gap-1",children:[e.jsx(bt,{className:"w-3 h-3"}),K.from_phone]})]})]}),e.jsx("button",{onClick:()=>{P(null),se("")},className:"w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 bg-gradient-to-b from-green-50/30 to-white",children:[e.jsx("div",{className:"flex items-start gap-2 mb-6",children:e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"bg-white rounded-2xl rounded-tl-sm p-4 shadow-sm border border-gray-200 max-w-lg",children:[e.jsx("p",{className:"text-gray-900 whitespace-pre-wrap leading-relaxed",children:K.message_text}),K.media_url&&(()=>{const r=Ar(K.media_url);return r?e.jsx("div",{className:"mt-3",children:K.message_type==="image"?e.jsx("img",{src:r,alt:"Message attachment",className:"max-w-full rounded-lg shadow-md",onError:s=>{const a=s.target;a.style.display="none";const g=a.parentElement;if(g&&!g.querySelector(".media-error-placeholder")){const u=document.createElement("div");u.className="media-error-placeholder p-3 bg-gray-100 rounded-lg text-sm text-gray-600",u.textContent="Media file could not be loaded",g.appendChild(u)}}}):e.jsxs("a",{href:r,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-all text-sm font-medium",children:[e.jsx(tt,{className:"w-4 h-4"}),"View ",K.message_type]})}):e.jsxs("div",{className:"mt-3 p-3 bg-gray-100 rounded-lg text-sm text-gray-600",children:[e.jsx(tt,{className:"w-4 h-4 inline mr-2"}),"Media file not available"]})})(),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:Ja(K.received_at)})]})})}),e.jsxs("div",{className:"bg-white rounded-2xl border-2 border-green-500 p-4 shadow-lg",children:[e.jsxs("label",{className:"block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(fs,{className:"w-4 h-4 text-green-600"}),"Type your reply"]}),e.jsx("textarea",{value:z,onChange:r=>se(r.target.value),placeholder:"Type your message here...",rows:5,className:"w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-gray-900 resize-none",autoFocus:!0}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:[z.length," characters"]}),z.trim()&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"Ready to send âœ“"})]})]})]}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{P(null),se("")},disabled:Q,className:"flex-1 px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition-all font-semibold disabled:opacity-50",children:"Cancel"}),e.jsxs("button",{onClick:()=>ul(K),disabled:Q||!z.trim(),className:"flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all font-semibold shadow-lg",children:[e.jsx(fs,{className:"w-5 h-5"}),Q?"Sending...":"Send Reply"]})]})})]})}),J&&e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 bg-gradient-to-r from-green-600 to-emerald-600 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(fs,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"New WhatsApp Message"}),e.jsx("p",{className:"text-sm text-green-100",children:"Send a message to any customer"})]})]}),e.jsx("button",{onClick:()=>{$e(!1),he(""),_(""),te(null)},className:"w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors",children:e.jsx(Te,{className:"w-5 h-5 text-white"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 bg-gradient-to-b from-green-50/30 to-white",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Select Customer"}),e.jsxs("select",{value:(Z==null?void 0:Z.id)||"",onChange:r=>{const s=R.find(a=>a.id===r.target.value);te(s||null),_("")},className:"w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-gray-900",children:[e.jsx("option",{value:"",children:"-- Select a customer --"}),R.map(r=>e.jsxs("option",{value:r.id,children:[r.name," - ",r.whatsapp||r.phone]},r.id))]})]}),e.jsxs("div",{className:"flex items-center gap-3 my-4",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsx("span",{className:"text-sm text-gray-500 font-medium",children:"OR"}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Enter Phone Number"}),e.jsx("input",{type:"tel",value:De,onChange:r=>{_(r.target.value),te(null)},placeholder:"e.g., 255712345678 or +255712345678",disabled:!!Z,className:"w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-gray-900 disabled:bg-gray-100 disabled:cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Include country code (e.g., 255 for Tanzania)"})]}),e.jsxs("div",{className:"bg-white rounded-2xl border-2 border-green-500 p-4 shadow-lg",children:[e.jsxs("label",{className:"block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(st,{className:"w-4 h-4 text-green-600"}),"Your Message"]}),e.jsx("textarea",{value:W,onChange:r=>he(r.target.value),placeholder:"Type your message here...",rows:6,className:"w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-gray-900 resize-none",autoFocus:!0}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:[W.length," characters"]}),W.trim()&&(Z||De)&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"Ready to send âœ“"})]})]})]}),e.jsx("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{$e(!1),he(""),_(""),te(null)},disabled:Ge,className:"flex-1 px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition-all font-semibold disabled:opacity-50",children:"Cancel"}),e.jsxs("button",{onClick:xl,disabled:Ge||!W.trim()||!Z&&!De,className:"flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all font-semibold shadow-lg",children:[e.jsx(fs,{className:"w-5 h-5"}),Ge?"Sending...":"Send Message"]})]})})]})})]}),oe&&!da&&(()=>{var r;return console.log("ğŸ“‹ Rendering Bulk Modal - showBulkModal:",oe,"isMinimized:",da,"bulkStep:",w),e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:()=>{ie||(x(!1),C(1),S(""),ee([]),js(null),xs(""),Ks(""),ia(""),Ue("text"),it(!1),ct(""),Ms(["",""]),mt(!1),wt(""),jt(""),Nt(""),vt(""))},disabled:ie,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50 disabled:opacity-50",children:e.jsx(Te,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>{console.log("Minimizing to topbar..."),gt(!0)},title:"Minimize to top bar",className:"absolute top-4 right-16 w-9 h-9 flex items-center justify-center bg-gray-500 hover:bg-gray-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(en,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-orange-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(It,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Bulk WhatsApp Messages"}),Oa&&w===1&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>{Hr()&&x(!0)},className:"px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all text-xs font-semibold flex items-center gap-1",title:"Continue from saved draft",children:[e.jsx(Zt,{className:"w-3 h-3"}),"Load Draft"]}),e.jsx("button",{onClick:Sa,className:"p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all",title:"Delete saved draft",children:e.jsx(ys,{className:"w-3 h-3"})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm transition-all ${w>s?"bg-green-500 text-white":w===s?"bg-orange-600 text-white":"bg-gray-200 text-gray-400"}`,children:w>s?e.jsx(xe,{className:"w-4 h-4"}):s}),s<4&&e.jsx("div",{className:`w-12 h-1 mx-1 rounded-full transition-all ${w>s?"bg-green-500":"bg-gray-200"}`})]},s)),e.jsxs("span",{className:"ml-3 text-sm font-medium text-gray-600",children:[w===1&&"Select Recipients",w===2&&"Compose Message",w===3&&"Review & Confirm",w===4&&"Sending"]})]}),oe&&w<=2&&(N.length>0||b.trim())&&e.jsxs("div",{className:"mt-2 flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(ur,{className:"w-3 h-3"}),e.jsx("span",{children:"Auto-saving draft..."})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-8",children:[w===1&&e.jsx(co,{filteredConversations:va,selectedRecipients:N,csvRecipients:zt,blacklist:Ua,savedLists:Mn,sentPhones:le,campaignName:ls,recipientSearch:$n,activeQuickFilter:An,csvFile:Rn,csvUploading:In,showCsvTooltip:Un,showImportSection:Fn,bulkSending:ie,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,setCampaignName:ot,setRecipientSearch:Pn,setSelectedRecipients:ee,applyQuickFilter:bl,clearQuickFilter:yl,handleCsvUpload:jl,clearCsvImport:vl,setShowCsvPreviewModal:On,setShowCsvTooltip:Ln,setShowSaveListModal:Gn,setShowCustomerImport:zn,setShowImportSection:Bn,loadRecipientList:Sl,loadAllCustomers:kl,getInitials:Ya,getEngagementScore:Gr,isPhoneBlacklisted:fl,isValidPhone:zr,segmentFilter:ya,applySegmentation:wl,clearSegmentation:()=>{Pr(null),c.success("Segmentation filter cleared")}}),w===2&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Ea,{className:"w-4 h-4"}),"Message Type"]}),e.jsxs("button",{onClick:()=>ha(!0),className:"flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 rounded-lg shadow-md transition-all",title:"Choose from saved templates",children:[e.jsx(Zt,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Choose Template"}),e.jsx("span",{className:"sm:hidden",children:"Template"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsxs("button",{onClick:()=>Ue("text"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="text"?"bg-blue-600 text-white border-blue-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-blue-50"}`,children:[e.jsx(st,{className:"w-4 h-4"}),"Text"]}),e.jsxs("button",{onClick:()=>Ue("image"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="image"?"bg-purple-600 text-white border-purple-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-purple-50"}`,children:[e.jsx(tt,{className:"w-4 h-4"}),"Image"]}),e.jsxs("button",{onClick:()=>Ue("video"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="video"?"bg-red-600 text-white border-red-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-red-50"}`,children:[e.jsx(Yt,{className:"w-4 h-4"}),"Video"]}),e.jsxs("button",{onClick:()=>Ue("document"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="document"?"bg-indigo-600 text-white border-indigo-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-indigo-50"}`,children:[e.jsx(at,{className:"w-4 h-4"}),"Document"]}),e.jsxs("button",{onClick:()=>Ue("audio"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="audio"?"bg-pink-600 text-white border-pink-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-pink-50"}`,children:[e.jsx(Jt,{className:"w-4 h-4"}),"Audio"]}),e.jsxs("button",{onClick:()=>Ue("location"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="location"?"bg-green-600 text-white border-green-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-green-50"}`,children:[e.jsx(rr,{className:"w-4 h-4"}),"Location"]}),e.jsxs("button",{onClick:()=>Ue("poll"),className:`p-3 rounded-xl font-medium text-sm transition-all border-2 flex items-center justify-center gap-2 ${q==="poll"?"bg-teal-600 text-white border-teal-600 shadow-lg":"bg-white text-gray-700 border-gray-200 hover:bg-teal-50"}`,children:[e.jsx(Rt,{className:"w-4 h-4"}),"Poll"]})]})]}),q==="text"&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(Wl,{className:"w-4 h-4"}),"Quick Templates"]}),e.jsxs("button",{onClick:()=>ha(!0),className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-purple-600 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-colors",title:"Browse all saved templates",children:[e.jsx(Zt,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Choose from Templates"}),e.jsx("span",{className:"sm:hidden",children:"Templates"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[e.jsxs("button",{onClick:()=>S("Hi {name}! We have exciting news for you. Check out our latest offers today!"),className:"px-3 py-2 bg-white rounded-lg hover:bg-blue-50 transition-all text-sm border border-gray-300 font-medium flex items-center justify-center gap-2 group",title:"Promotional Offer Template",children:[e.jsx(Hl,{className:"w-4 h-4 text-gray-500 group-hover:text-blue-600 transition-colors"}),e.jsx("span",{className:"hidden md:inline",children:"Promotional"})]}),e.jsxs("button",{onClick:()=>S("Hello {name}, thank you for being our valued customer! We appreciate your business."),className:"px-3 py-2 bg-white rounded-lg hover:bg-blue-50 transition-all text-sm border border-gray-300 font-medium flex items-center justify-center gap-2 group",title:"Thank You Message Template",children:[e.jsx(ql,{className:"w-4 h-4 text-gray-500 group-hover:text-blue-600 transition-colors"}),e.jsx("span",{className:"hidden md:inline",children:"Thank You"})]}),e.jsxs("button",{onClick:()=>S("Hi {name}, just a friendly reminder about your upcoming appointment. See you soon!"),className:"px-3 py-2 bg-white rounded-lg hover:bg-blue-50 transition-all text-sm border border-gray-300 font-medium flex items-center justify-center gap-2 group",title:"Appointment Reminder Template",children:[e.jsx(Ls,{className:"w-4 h-4 text-gray-500 group-hover:text-blue-600 transition-colors"}),e.jsx("span",{className:"hidden md:inline",children:"Reminder"})]}),e.jsxs("button",{onClick:()=>S("Hey {name}! We miss you! Come visit us and enjoy special discounts for returning customers."),className:"px-3 py-2 bg-white rounded-lg hover:bg-blue-50 transition-all text-sm border border-gray-300 font-medium flex items-center justify-center gap-2 group",title:"Re-engagement Template",children:[e.jsx(nr,{className:"w-4 h-4 text-gray-500 group-hover:text-blue-600 transition-colors"}),e.jsx("span",{className:"hidden md:inline",children:"Re-engage"})]})]})]}),["image","video","document","audio"].includes(q)&&e.jsxs("div",{className:"mb-6",children:[Fe?e.jsx("div",{className:"p-3 bg-green-50 rounded-xl border border-green-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Qs==="image"&&Wt&&e.jsx("img",{src:Wt,alt:"Preview",className:"w-16 h-16 rounded-lg object-cover border border-gray-200"}),Qs==="video"&&e.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center border border-blue-200",children:e.jsx(Yt,{className:"w-8 h-8 text-blue-600"})}),Qs==="audio"&&e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center border border-green-200",children:e.jsx(Jt,{className:"w-8 h-8 text-green-600"})}),Qs==="document"&&e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200",children:e.jsx(at,{className:"w-8 h-8 text-gray-600"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-gray-900 text-sm flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Media Attached"]}),e.jsxs("p",{className:"text-xs text-gray-600 capitalize",children:[Qs," ready"]})]})]}),e.jsx("button",{onClick:()=>{js(null),xs(""),Ks("")},className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all",title:"Remove media",children:e.jsx(ys,{className:"w-4 h-4"})})]})}):e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("label",{className:"px-4 py-4 bg-white border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all text-center",title:`Upload ${q} file (Max 16MB)`,children:[e.jsx(Ds,{className:"w-6 h-6 mx-auto mb-2 text-gray-600"}),e.jsx("span",{className:"block text-sm font-medium text-gray-900",children:"Upload File"}),e.jsx("span",{className:"block text-xs text-gray-500 mt-1",children:"Max 16MB"}),e.jsx("input",{type:"file",accept:q==="image"?"image/*":q==="video"?"video/*":q==="audio"?"audio/*":".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx",onChange:Nl,className:"hidden"})]}),e.jsxs("button",{onClick:()=>Ia(!0),className:"px-4 py-4 bg-white border-2 border-gray-300 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all text-center",title:"Choose from saved media library",children:[e.jsx(Zt,{className:"w-6 h-6 mx-auto mb-2 text-gray-600"}),e.jsx("span",{className:"block text-sm font-medium text-gray-900",children:"Media Library"}),e.jsx("span",{className:"block text-xs text-gray-500 mt-1",children:"Reuse saved"})]})]})}),["image","video"].includes(q)&&Fe&&e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-all border border-gray-200",title:"Media will disappear after recipient views it once",children:[e.jsx("input",{type:"checkbox",checked:Ts,onChange:s=>it(s.target.checked),className:"w-4 h-4 text-blue-600 rounded"}),e.jsx(lr,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900 text-sm",children:"View Once"})]})})]}),q==="poll"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Poll Question"}),e.jsx("input",{type:"text",value:hs,onChange:s=>ct(s.target.value),placeholder:"e.g., What's your favorite product?",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"}),e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2 mt-4",children:"Poll Options"}),as.map((s,a)=>e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("input",{type:"text",value:s,onChange:g=>{const u=[...as];u[a]=g.target.value,Ms(u)},placeholder:`Option ${a+1}`,className:"flex-1 px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"}),as.length>2&&e.jsx("button",{onClick:()=>Ms(as.filter((g,u)=>u!==a)),className:"px-3 text-red-600 hover:bg-red-50 rounded-xl transition-all",title:"Remove option",children:e.jsx(ys,{className:"w-4 h-4"})})]},a)),as.length<12&&e.jsx("button",{onClick:()=>Ms([...as,""]),className:"w-full p-2 bg-white border-2 border-dashed border-gray-300 rounded-xl text-gray-700 font-medium hover:border-blue-400 hover:bg-blue-50 transition-all",title:"Add another poll option (max 12)",children:"+ Add Option"}),e.jsxs("label",{className:"flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-all border border-gray-200 mt-3",title:"Allow users to select multiple answers",children:[e.jsx("input",{type:"checkbox",checked:dt,onChange:s=>mt(s.target.checked),className:"w-4 h-4 text-blue-600 rounded"}),e.jsx(xe,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900 text-sm",children:"Multiple Selection"})]})]}),q==="location"&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Latitude *"}),e.jsx("input",{type:"text",value:Ns,onChange:s=>wt(s.target.value),placeholder:"-6.7924",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",title:"GPS Latitude coordinate"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Longitude *"}),e.jsx("input",{type:"text",value:vs,onChange:s=>jt(s.target.value),placeholder:"39.2083",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",title:"GPS Longitude coordinate"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Location Name"}),e.jsx("input",{type:"text",value:Js,onChange:s=>Nt(s.target.value),placeholder:"Our Store",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",title:"Optional: Name of the location"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Address"}),e.jsx("input",{type:"text",value:Ys,onChange:s=>vt(s.target.value),placeholder:"123 Main Street, Dar es Salaam",className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",title:"Optional: Full address of the location"})]})]}),["text","image","video","document"].includes(q)&&e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-200 shadow-sm focus-within:border-green-500 focus-within:shadow-md transition-all overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-1 px-3 py-2 bg-gray-50/30",children:[e.jsxs("div",{className:"relative attach-menu-container",children:[e.jsx("button",{onClick:()=>Ba(!Ht),className:`p-2 rounded-full transition-all flex items-center justify-center ${Ht?"bg-green-100 text-green-600":"hover:bg-gray-100 text-gray-500"}`,title:"Attach",children:e.jsx(Vl,{className:"w-5 h-5"})}),Ht&&e.jsx("div",{className:"absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-2xl shadow-2xl z-[9999] overflow-hidden attach-menu-container",children:e.jsxs("div",{className:"flex items-center gap-0 p-2",children:[e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("text")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Text",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(sn,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Text"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("image")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Image",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(tt,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Image"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("video")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Video",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Yt,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Video"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("document")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Document",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(at,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Document"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("audio")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Audio",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Jt,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Audio"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("location")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Location",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(rr,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Location"})]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),ft("poll")},className:"flex flex-col items-center gap-1.5 p-3 hover:bg-green-50 rounded-xl transition-all group",title:"Poll",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Rt,{className:"w-6 h-6 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Poll"})]})]})})]}),e.jsxs("div",{className:"relative variables-menu-container",children:[e.jsx("button",{onClick:()=>ca(!St),className:`p-2 rounded-full transition-all flex items-center justify-center ${St?"bg-green-100 text-green-600":"hover:bg-gray-100 text-gray-500"}`,title:"Variables (Ctrl+K)",children:e.jsx(Ql,{className:"w-5 h-5"})}),St&&e.jsx("div",{className:"absolute left-0 top-full mt-1 bg-white border border-gray-200 rounded-2xl shadow-2xl z-[9999] overflow-hidden variables-menu-container",children:e.jsxs("div",{className:"flex items-center gap-0 p-2",children:[e.jsxs("button",{onClick:()=>Rs("{name}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Name",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(At,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{name}"})]}),e.jsxs("button",{onClick:()=>Rs("{phone}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Phone",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(bt,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{phone}"})]}),e.jsxs("button",{onClick:()=>Rs("{greeting}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Greeting",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(or,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{greeting}"})]}),e.jsxs("button",{onClick:()=>Rs("{company}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Company",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Ut,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{company}"})]}),e.jsxs("button",{onClick:()=>Rs("{date}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Date",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Ls,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{date}"})]}),e.jsxs("button",{onClick:()=>Rs("{time}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Time",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Le,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{time}"})]}),e.jsxs("button",{onClick:()=>Rs("{day}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Day",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Ls,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{day}"})]}),e.jsxs("button",{onClick:()=>Rs("{month}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Month",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(Ls,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{month}"})]}),e.jsxs("button",{onClick:()=>Rs("{unique}"),className:"flex flex-col items-center gap-1.5 p-2.5 hover:bg-green-50 rounded-xl transition-all group",title:"Unique Content (Random emoji/invisible text - different for each message)",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors",children:e.jsx(tn,{className:"w-5 h-5 text-green-600"})}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"{unique}"})]})]})})]}),e.jsxs("div",{className:"flex items-center gap-1 ml-1",children:[e.jsx("button",{onClick:()=>{const s=kt.current;if(!s)return;const a=s.selectionStart,g=s.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`*${u}*`+b.substring(g);As(f),setTimeout(()=>{s.focus(),s.setSelectionRange(a+1,g+1)},0)}},className:"p-1.5 hover:bg-gray-200 rounded transition-all",title:"Bold (Ctrl+B)",children:e.jsx("span",{className:"text-gray-600 font-bold text-sm",children:"B"})}),e.jsx("button",{onClick:()=>{const s=kt.current;if(!s)return;const a=s.selectionStart,g=s.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`_${u}_`+b.substring(g);As(f),setTimeout(()=>{s.focus(),s.setSelectionRange(a+1,g+1)},0)}},className:"p-1.5 hover:bg-gray-200 rounded transition-all",title:"Italic (Ctrl+I)",children:e.jsx("span",{className:"text-gray-600 italic text-sm",children:"I"})}),e.jsx("button",{onClick:()=>{const s=kt.current;if(!s)return;const a=s.selectionStart,g=s.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`~${u}~`+b.substring(g);As(f),setTimeout(()=>{s.focus(),s.setSelectionRange(a+1,g+1)},0)}},className:"p-1.5 hover:bg-gray-200 rounded transition-all",title:"Strikethrough",children:e.jsx("span",{className:"text-gray-600 line-through text-sm",children:"S"})}),e.jsx("button",{onClick:()=>{const s=kt.current;if(!s)return;const a=s.selectionStart,g=s.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`\`\`\`${u}\`\`\``+b.substring(g);As(f),setTimeout(()=>{s.focus(),s.setSelectionRange(a+3,g+3)},0)}},className:"p-1.5 hover:bg-gray-200 rounded transition-all",title:"Monospace",children:e.jsx(Kl,{className:"w-4 h-4 text-gray-600"})})]}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{className:"p-2 hover:bg-gray-200 rounded-full transition-all",title:"Emoji",children:e.jsx(or,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[Es.length>0&&e.jsx("button",{onClick:Wr,className:"p-2 hover:bg-gray-200 rounded-full transition-all",title:"Undo (Ctrl+Z)",children:e.jsx(nr,{className:"w-4 h-4 text-gray-500"})}),e.jsx("button",{onClick:Dl,className:"p-2 hover:bg-gray-200 rounded-full transition-all",title:"Paste from clipboard",children:e.jsx(at,{className:"w-4 h-4 text-gray-500"})}),e.jsx("button",{onClick:()=>{if(ws)Cl();else{const s=prompt("Enter your phone number to test:");s&&Aa(s)}},className:"p-2 hover:bg-blue-100 rounded-full transition-all",title:"Send test message",children:e.jsx(fs,{className:"w-4 h-4 text-blue-600"})})]}),e.jsx("div",{className:"flex items-center gap-2 px-2",children:e.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${b.length>3500?"text-red-600 bg-red-50 font-semibold":b.length>3e3?"text-orange-600 bg-orange-50":"text-gray-400"}`,children:[b.length,"/4096"]})})]}),e.jsxs("div",{className:"relative",children:[!Ha&&b&&e.jsx("div",{className:"absolute inset-0 px-4 py-3 pointer-events-none text-gray-900 min-h-[60px] max-h-[200px] overflow-y-auto z-0",style:{whiteSpace:"pre-wrap",wordWrap:"break-word"},dangerouslySetInnerHTML:{__html:Wn(b)}}),be.length>0&&e.jsx("div",{className:"mb-2 space-y-1",children:be.map((s,a)=>e.jsxs("div",{className:`p-2 rounded-lg text-xs flex items-start gap-2 ${s.type==="spam"?"bg-red-50 border border-red-200 text-red-800":s.type==="duplicate"?"bg-yellow-50 border border-yellow-200 text-yellow-800":s.type==="character"?"bg-orange-50 border border-orange-200 text-orange-800":"bg-blue-50 border border-blue-200 text-blue-800"}`,children:[e.jsx(_s,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:s.message})]},a))}),e.jsx("textarea",{ref:kt,value:b,onChange:s=>As(s.target.value),onFocus:()=>Er(!0),onBlur:()=>Er(!1),onKeyDown:s=>{if((s.ctrlKey||s.metaKey)&&s.key==="z"&&!s.shiftKey){s.preventDefault(),Wr();return}if(s.ctrlKey||s.metaKey)if(s.key==="b"){s.preventDefault();const a=s.currentTarget.selectionStart,g=s.currentTarget.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`*${u}*`+b.substring(g);As(f),setTimeout(()=>{s.currentTarget.focus(),s.currentTarget.setSelectionRange(a+1,g+1)},0)}}else if(s.key==="i"){s.preventDefault();const a=s.currentTarget.selectionStart,g=s.currentTarget.selectionEnd,u=b.substring(a,g);if(u){const f=b.substring(0,a)+`_${u}_`+b.substring(g);As(f),setTimeout(()=>{s.currentTarget.focus(),s.currentTarget.setSelectionRange(a+1,g+1)},0)}}else s.key==="k"&&(s.preventDefault(),ca(!St))},placeholder:q==="text"?"Type your message...":"Add a caption...",rows:q==="text"?4:3,className:`w-full px-4 py-3 focus:outline-none resize-none bg-transparent relative z-10 ${Ha?"text-gray-900":"text-transparent"}`,style:{minHeight:"60px",maxHeight:"200px",caretColor:Ha?"#000":"transparent"},autoFocus:!0})]})]})}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("button",{onClick:()=>wn(!Ra),className:"w-full flex items-center justify-between p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all border border-gray-200",title:"Configure anti-ban protection features",children:[e.jsxs("span",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(Ca,{className:"w-4 h-4"}),"Anti-Ban Protection",(()=>{let s=N.length||zt.length||0;if(Ve&&s>0)try{const _e=Date.now()-216e5,Ne=new Set(i.filter(Be=>new Date(Be.last_message_time).getTime()>_e).map(Be=>Be.phone));s=(N.length>0?N:zt.map(Be=>Be.phone)).filter(Be=>!Ne.has(Be)).length}catch{}if(s===0)return null;const a=Ie?(ye+Ee)/2:ye,g=Pe?1.5:0,u=.3,f=a+g+1+u,F=(Math.ceil(s/qe)-1)*ze,we=2,D=s*f+F+we,I=Math.floor(D/3600),O=Math.floor(D%3600/60),ke=Math.floor(D%60);let pe="";return I>0?pe=`${I}h ${O}m`:O>0?pe=`${O}m`:pe=`${ke}s`,e.jsxs("span",{className:"ml-2 text-xs text-gray-500",children:["~",pe]})})()]}),e.jsx(Kt,{className:`w-5 h-5 text-gray-600 transition-transform ${Ra?"rotate-180":""}`})]}),Ra&&e.jsxs("div",{className:"mt-2 p-4 bg-white border border-gray-200 rounded-xl space-y-4",children:[(()=>{let s=N.length||zt.length||0;const a=s;if(Ve&&s>0)try{const B=Date.now()-216e5,y=new Set(i.filter(A=>new Date(A.last_message_time).getTime()>B).map(A=>A.phone));s=(N.length>0?N:zt.map(A=>A.phone)).filter(A=>!y.has(A)).length}catch(B){console.warn("Error calculating skip recent recipients:",B)}const g=Ie?(ye+Ee)/2:ye,u=Pe?1.5:0,f=.3,M=g+u+1+f,F=s>0?Math.ceil(s/qe):0,we=(F-1)*ze,D=2,I=s>0?s*M+we+D:0,O=Math.floor(I/3600),ke=Math.floor(I%3600/60),pe=Math.floor(I%60);let _e="";O>0?_e=`${O}h ${ke}m`:ke>0?_e=`${ke}m ${pe}s`:s>0?_e=`${pe}s`:_e="0s";const Ne=a-s,Be=Ne>0&&Ve,Is=ya&&s>0;return e.jsx("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-gray-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Estimated time: "}),e.jsx("span",{className:"text-lg font-semibold text-gray-900",children:_e}),s>0&&e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(",s," message",s!==1?"s":"",Be&&`, ${Ne} filtered`,Is&&" (segmentation may reduce count)",")"]}),s===0&&a>0&&e.jsx("span",{className:"text-xs text-orange-600 ml-2",children:"(all filtered out)"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["~",M.toFixed(1),"s per message"]}),F>1&&e.jsxs("div",{className:"text-xs text-gray-400 mt-0.5",children:[F," batch",F!==1?"es":""]})]})]})})})(),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Basic Protection"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[{icon:At,label:"Personalize",checked:Re,onChange:ms,title:"Replace {name} and other variables"},{icon:Le,label:"Random Delays",checked:Ie,onChange:gs,title:"Randomize timing between messages"},{icon:tn,label:"Vary Length",checked:es,onChange:Gs,title:"Add slight variations to message length"},{icon:rs,label:"Skip Recent",checked:Ve,onChange:Hs,title:"Skip contacts messaged in last 6 hours"},{icon:yt,label:"Invisible Chars",checked:ss,onChange:qs,title:"Add invisible Unicode characters"},{icon:or,label:"Emoji Rotation",checked:ts,onChange:Vs,title:"Rotate similar emojis"},{icon:sn,label:"Typing Indicator",checked:Pe,onChange:lt,title:"Show typing indicator before sending"},{icon:ks?Jl:Yl,label:"Sound Notifications",checked:ks,onChange:Yn,title:"Play sound for each successful message send"}].map(({icon:s,label:a,checked:g,onChange:u,title:f})=>e.jsxs("button",{onClick:()=>u(!g),className:"flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50/50 transition-all",title:f,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(s,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:a})]}),e.jsx("div",{className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${g?"bg-blue-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${g?"translate-x-6":"translate-x-1"}`})})]},a))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Timing Controls"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 bg-white border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Le,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Message Delay"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Min"}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[ye,"s"]})]}),e.jsx("input",{type:"range",value:ye,onChange:s=>{const a=parseInt(s.target.value);us(a),a>=Ee&&cs(a+1)},min:"1",max:"15",className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Max"}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[Ee,"s"]})]}),e.jsx("input",{type:"range",value:Ee,onChange:s=>cs(parseInt(s.target.value)),min:ye,max:"30",className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"})]})]})]}),e.jsxs("div",{className:"p-3 bg-white border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Cs,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Batch Break"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Delay"}),e.jsxs("span",{className:"text-xs font-medium text-gray-900",children:[ze,"s"]})]}),e.jsx("input",{type:"range",value:ze,onChange:s=>Os(parseInt(s.target.value)),min:"30",max:"300",step:"30",className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Rate Limits"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[{label:"Batch Size",value:qe,onChange:Bs,min:10,max:50,isUnlimited:!1},{label:"Per Hour",value:Qe,onChange:Ws,min:10,max:100,isUnlimited:!1},{label:"Per Day",value:ns,onChange:Fs,min:50,max:999999,isUnlimited:!0}].map(({label:s,value:a,onChange:g,min:u,max:f,isUnlimited:M})=>e.jsxs("div",{className:"p-3 bg-white border border-gray-200 rounded-lg",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:s}),e.jsx("input",{type:"number",value:M&&a>=999999?"":a,onChange:F=>{const we=F.target.value===""?999999:Number(F.target.value);g(Math.min(we,999999))},min:u,max:f,placeholder:M&&a>=999999?"Unlimited":`${u}-${f}`,className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),M&&a>=999999&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unlimited"})]},s))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Smart Protection"}),e.jsxs("button",{onClick:()=>zs(!Ye),className:"w-full flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50/50 transition-all",title:"Don't send between 10 PM and 8 AM",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-gray-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 block",children:"Respect Quiet Hours"}),e.jsx("span",{className:"text-xs text-gray-500",children:"No messages 10 PM - 8 AM"})]})]}),e.jsx("div",{className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${Ye?"bg-blue-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${Ye?"translate-x-6":"translate-x-1"}`})})]})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsxs("button",{onClick:async()=>{try{if(!(await fetch("/api/antiban-settings",{method:"DELETE",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to reset settings in database");ms(!0),gs(!0),us(3),cs(8),lt(!1),Bs(20),Os(60),Ws(30),Fs(100),Hs(!0),zs(!0),qs(!0),Vs(!0),Gs(!0);const a={usePersonalization:!0,randomDelay:!0,minDelay:3,maxDelay:8,usePresence:!1,batchSize:20,batchDelay:60,maxPerHour:30,dailyLimit:100,skipRecentlyContacted:!0,respectQuietHours:!0,useInvisibleChars:!0,useEmojiVariation:!0,varyMessageLength:!0};if(!(await fetch("/api/antiban-settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("Failed to save defaults");localStorage.setItem("whatsapp_antiban_settings",JSON.stringify({...a,savedAt:new Date().toISOString()})),console.log("âš™ï¸ Anti-ban settings reset to defaults and saved"),c.success("Settings reset to safe defaults")}catch(s){console.error("Failed to reset settings:",s),c.error("Failed to reset settings"),ms(!0),gs(!0),us(3),cs(8),lt(!1),Bs(20),Os(60),Ws(30),Fs(100),Hs(!0),zs(!0),qs(!0),Vs(!0),Gs(!0)}},className:"w-full px-4 py-2.5 bg-gray-50 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 hover:border-gray-400 transition-all text-sm font-medium flex items-center justify-center gap-2",title:"Reset all settings to recommended safe defaults",children:[e.jsx(rs,{className:"w-4 h-4"}),"Reset to Safe Defaults"]})})]})]})]}),w===3&&e.jsxs("div",{className:"space-y-6",children:[(()=>{const s=N.filter(a=>!le.includes(a));return e.jsx("div",{className:"p-5 bg-purple-50 border-2 border-purple-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-purple-900 mb-2 text-lg flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),"Review & Confirm"]}),e.jsxs("p",{className:"text-sm text-purple-700",children:["Review your message and settings before sending. ",le.length>0&&`${le.length} already sent.`]})]}),e.jsxs("div",{className:"text-right bg-white rounded-xl px-4 py-3 border-2 border-purple-300 shadow-sm",children:[e.jsx("p",{className:"text-xs text-gray-600 font-medium",children:"Sending to"}),e.jsx("p",{className:"text-3xl font-bold text-purple-900",children:s.length}),e.jsx("p",{className:"text-xs text-gray-600 font-medium",children:"recipients"})]})]})})})(),e.jsxs("div",{className:"p-5 bg-white border-2 border-gray-200 rounded-xl",children:[e.jsxs("label",{className:"block text-base font-bold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(It,{className:"w-5 h-5"}),"Recipients"]}),(()=>{const s=N.filter(a=>!le.includes(a));return e.jsx("div",{className:"space-y-2",children:s.length>0?e.jsxs(e.Fragment,{children:[s.slice(0,5).map(a=>{var u;const g=i.find(f=>f.phone===a);return e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-xl border-2 border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-semibold",children:((u=g==null?void 0:g.customer_name)==null?void 0:u.charAt(0))||"?"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 truncate",children:(g==null?void 0:g.customer_name)||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-500 font-mono truncate",children:a})]}),e.jsx(xe,{className:"w-5 h-5 text-green-600 flex-shrink-0"})]},a)}),s.length>5&&e.jsx("div",{className:"pt-2 border-t-2 border-gray-200",children:e.jsxs("p",{className:"text-sm text-gray-600 text-center font-medium",children:["+",s.length-5," more recipient",s.length-5!==1?"s":""]})})]}):le.length>0?e.jsxs("div",{className:"text-center py-6 bg-green-50 rounded-xl border-2 border-green-200",children:[e.jsx(xe,{className:"w-8 h-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-base font-semibold text-green-700",children:"All messages sent!"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"No pending recipients"})]}):null})})()]}),e.jsxs("div",{className:"p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl",children:[e.jsxs("label",{className:"block text-base font-bold text-green-900 mb-3 flex items-center gap-2",children:[e.jsx(st,{className:"w-5 h-5"}),"WhatsApp Preview"]}),e.jsx("p",{className:"text-sm text-green-700 mb-4",children:"Exact preview as it will appear"}),e.jsx("div",{className:"relative rounded-xl overflow-hidden bg-[#e5ddd5] p-6 min-h-[240px] flex flex-col justify-end",style:{backgroundImage:`url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='%23e5ddd5'/%3E%3Cpath d='M25 25h50v50H25z' fill='%23ffffff' opacity='0.03'/%3E%3C/svg%3E")`},children:e.jsx("div",{className:"flex justify-end mb-3",children:e.jsxs("div",{className:"max-w-[85%]",children:[e.jsxs("div",{className:"bg-[#dcf8c6] rounded-2xl rounded-tr-none shadow-lg",children:[Fe&&["image","video","document","audio"].includes(q)&&e.jsxs("div",{className:"p-1.5",children:[q==="image"&&Wt&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:Wt,alt:"Preview",className:"w-full rounded-xl max-h-64 object-cover"}),Ts&&e.jsxs("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/70 rounded-full flex items-center gap-1 backdrop-blur-sm",children:[e.jsx(lr,{className:"w-3 h-3 text-white"}),e.jsx("span",{className:"text-xs text-white font-medium",children:"View once"})]})]}),q==="video"&&e.jsxs("div",{className:"relative bg-black rounded-xl h-48 flex items-center justify-center",children:[e.jsx("div",{className:"w-20 h-20 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center",children:e.jsx(Yt,{className:"w-10 h-10 text-white"})}),Ts&&e.jsxs("div",{className:"absolute top-2 left-2 px-2 py-1 bg-black/70 rounded-full flex items-center gap-1 backdrop-blur-sm",children:[e.jsx(lr,{className:"w-3 h-3 text-white"}),e.jsx("span",{className:"text-xs text-white font-medium",children:"View once"})]})]}),q==="document"&&e.jsxs("div",{className:"bg-white rounded-xl p-4 flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center",children:e.jsx(at,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Document"}),e.jsx("p",{className:"text-xs text-gray-500",children:"PDF, DOC, or other file"})]})]}),q==="audio"&&e.jsxs("div",{className:"bg-white rounded-xl p-4 flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-500 rounded-full flex items-center justify-center",children:e.jsx(Jt,{className:"w-6 h-6 text-white"})}),e.jsx("div",{className:"flex-1 h-10 bg-gray-200 rounded-full flex items-center px-4",children:e.jsx("div",{className:"w-full h-1.5 bg-gray-400 rounded-full"})}),e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:"0:00"})]})]}),b&&["text","image","video","document"].includes(q)&&e.jsx("div",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-gray-900 leading-relaxed whitespace-pre-wrap break-words",dangerouslySetInnerHTML:{__html:$l(b)}})}),q==="poll"&&hs&&e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"mb-3",children:e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:hs})}),e.jsx("div",{className:"space-y-2",children:as.filter(s=>s.trim()).map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2.5 bg-white/60 rounded-lg border border-gray-300/50",children:[e.jsx("div",{className:`w-4 h-4 rounded-full border-2 border-gray-400 ${dt?"":"bg-white"}`}),e.jsx("span",{className:"text-sm text-gray-800",children:s})]},a))}),e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-300/50",children:e.jsxs("p",{className:"text-xs text-gray-600 flex items-center gap-1",children:[e.jsx(Rt,{className:"w-3.5 h-3.5"}),dt?"Select one or more options":"Select one option"]})})]}),q==="location"&&Ns&&vs&&e.jsxs("div",{className:"p-1.5",children:[e.jsxs("div",{className:"bg-gray-200 rounded-xl h-40 flex items-center justify-center relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 opacity-30",style:{backgroundImage:"repeating-linear-gradient(0deg, #ccc 0px, #ccc 1px, transparent 1px, transparent 20px), repeating-linear-gradient(90deg, #ccc 0px, #ccc 1px, transparent 1px, transparent 20px)"}}),e.jsx(rr,{className:"w-14 h-14 text-red-500 drop-shadow-xl relative z-10"})]}),(Js||Ys)&&e.jsxs("div",{className:"bg-white p-3 mt-1.5 rounded-xl",children:[Js&&e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:Js}),Ys&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:Ys}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[Ns,", ",vs]})]})]}),e.jsxs("div",{className:"px-4 pb-2 flex items-center justify-end gap-1.5",children:[e.jsx("span",{className:"text-[10px] text-gray-600",children:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}),e.jsx(xe,{className:"w-4 h-4 text-blue-500"})]})]}),e.jsx("div",{className:"text-right mt-2",children:e.jsxs("span",{className:"text-sm text-gray-600 font-medium",children:["To: ",((r=i.find(s=>s.phone===N[0]))==null?void 0:r.customer_name)||"Customer"]})})]})})})]}),e.jsxs("div",{className:"p-5 bg-purple-50 border-2 border-purple-200 rounded-xl",children:[e.jsxs("label",{className:"block text-base font-bold text-purple-900 mb-3 flex items-center gap-2",children:[e.jsx(Ca,{className:"w-5 h-5"}),"Protection Settings"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx("div",{className:`p-3 rounded-xl border-2 ${Re?"bg-white border-purple-300":"bg-white/50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Re?e.jsx(xe,{className:"w-5 h-5 text-green-600"}):e.jsx(Te,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:`text-sm font-semibold ${Re?"text-gray-900":"text-gray-500"}`,children:"Personalization"})]})}),e.jsx("div",{className:"p-3 rounded-xl border-2 bg-white border-purple-300",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5 text-purple-600"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["Delays: ",Ie?`${ye}-${Ee}s`:`${ye}s`]})]})}),e.jsx("div",{className:`p-3 rounded-xl border-2 ${Pe?"bg-white border-purple-300":"bg-white/50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Pe?e.jsx(xe,{className:"w-5 h-5 text-green-600"}):e.jsx(Te,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:`text-sm font-semibold ${Pe?"text-gray-900":"text-gray-500"}`,children:"Typing Indicator"})]})}),e.jsx("div",{className:"p-3 rounded-xl border-2 bg-white border-purple-300",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rt,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Limit: Unlimited"})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl",children:[e.jsxs("label",{className:"block text-base font-bold text-blue-900 mb-3 flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5"}),"Estimated Time"]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsx("div",{className:"text-4xl font-bold text-blue-900",children:(()=>{const s=Ie?(ye+Ee)/2:ye,a=Pe?1.5:0,g=N.length*(s+a+1),u=Math.floor(g/60),f=Math.floor(g%60);return`${u>0?`${u}m ${f}s`:`${f}s`}`})()})}),e.jsxs("p",{className:"text-sm text-blue-700 mt-2",children:["for ",N.length," message",N.length!==1?"s":""]})]}),e.jsxs("div",{className:"p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl",children:[e.jsxs("label",{className:"block text-base font-bold text-green-900 mb-3 flex items-center gap-2",children:[e.jsx(ra,{className:"w-5 h-5"}),"Sending Mode"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{onClick:()=>Sr("browser"),className:`p-4 rounded-xl border-2 cursor-pointer transition-all ${We==="browser"?"bg-green-600 text-white border-green-600 shadow-lg":"bg-white border-green-200 hover:border-green-400"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Cs,{className:`w-5 h-5 ${We==="browser"?"text-white":"text-green-600"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:`font-bold text-sm ${We==="browser"?"text-white":"text-gray-900"}`,children:"Browser Sending"}),e.jsx("p",{className:`text-xs ${We==="browser"?"text-green-100":"text-gray-500"}`,children:"Real-time feedback"})]})]}),We==="browser"&&e.jsx(xe,{className:"w-5 h-5 text-white"})]}),e.jsx("p",{className:`text-xs ${We==="browser"?"text-green-100":"text-gray-600"}`,children:"Best for < 100 recipients"})]}),e.jsxs("div",{onClick:()=>Sr("cloud"),className:`p-4 rounded-xl border-2 cursor-pointer transition-all ${We==="cloud"?"bg-green-600 text-white border-green-600 shadow-lg":"bg-white border-green-200 hover:border-green-400"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ut,{className:`w-5 h-5 ${We==="cloud"?"text-white":"text-green-600"}`}),e.jsxs("div",{children:[e.jsx("h4",{className:`font-bold text-sm ${We==="cloud"?"text-white":"text-gray-900"}`,children:"Cloud Processing"}),e.jsx("p",{className:`text-xs ${We==="cloud"?"text-green-100":"text-gray-500"}`,children:"Background processing"})]})]}),We==="cloud"&&e.jsx(xe,{className:"w-5 h-5 text-white"})]}),e.jsx("p",{className:`text-xs ${We==="cloud"?"text-green-100":"text-gray-600"}`,children:"Best for 100+ recipients"})]})]}),We==="cloud"&&e.jsx("div",{className:"mt-4",children:e.jsx("input",{type:"text",value:ls,onChange:s=>ot(s.target.value),placeholder:`Campaign ${new Date().toLocaleDateString()}`,className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-sm font-medium"})})]})]}),e.jsx("div",{className:"p-5 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md",children:e.jsx(_s,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-base font-bold text-amber-900 mb-2",children:"Final Confirmation"}),e.jsxs("p",{className:"text-sm text-amber-800",children:["You are about to send ",e.jsxs("strong",{className:"font-bold",children:[N.length," message",N.length!==1?"s":""]})," to your recipients. This action cannot be undone."]})]})]})})]}),w===4&&e.jsxs("div",{children:[e.jsxs("div",{className:"p-5 bg-white rounded-xl border-2 border-gray-200 mb-6",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3",children:e.jsx(fs,{className:"w-6 h-6 text-white"})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-2",children:We==="cloud"?"Processing in Cloud â˜ï¸":"Sending Messages..."}),e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:We==="cloud"?"You can close this window safely - campaign continues in background":"Please keep this window open"}),We==="browser"&&!da&&e.jsxs("button",{onClick:()=>{console.log("ğŸ”½ MINIMIZE CLICKED - Setting isMinimized to true"),gt(!0),c.success("Minimized to top bar! Campaign continues in background.",{duration:4e3,icon:"ğŸ”½"})},className:"mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-medium text-sm flex items-center gap-2 mx-auto",children:[e.jsx(en,{className:"w-4 h-4"}),"Minimize to Topbar"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Progress"}),e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:[h.current," / ",h.total]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 overflow-hidden",children:e.jsx("div",{className:"h-4 bg-green-500 transition-all duration-300 flex items-center justify-end pr-2",style:{width:`${h.total>0?h.current/h.total*100:0}%`},children:e.jsxs("span",{className:"text-xs text-white font-bold",children:[h.total>0?Math.round(h.current/h.total*100):0,"%"]})})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-4 bg-white rounded-xl border-2 border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1 font-medium",children:"Successful"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600 flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),h.success]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-xl border-2 border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1 font-medium",children:"Failed"}),e.jsxs("p",{className:"text-2xl font-bold text-red-600 flex items-center gap-2",children:[e.jsx(Te,{className:"w-5 h-5"}),h.failed]})]})]}),$s&&!ie&&e.jsx("div",{className:"mt-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-xl",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Le,{className:"w-10 h-10 text-yellow-600 mx-auto mb-2"}),e.jsx("h4",{className:"text-lg font-bold text-yellow-900 mb-1",children:"Campaign Paused"}),e.jsxs("p",{className:"text-sm text-yellow-800 mb-1",children:["Progress saved: ",le.length," messages sent"]}),e.jsxs("p",{className:"text-xs text-yellow-700",children:[N.length-le.length," messages remaining"]}),e.jsx("p",{className:"text-xs text-yellow-600 mt-2",children:"Your progress is saved. You can refresh the page and resume later."})]})})]}),(h.success>0||h.failed>0)&&e.jsxs("div",{className:"p-4 bg-white rounded-xl border-2 border-gray-200 mb-6",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 text-sm mb-3 flex items-center gap-2",children:[e.jsx(Rt,{className:"w-4 h-4"}),"Campaign Statistics"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm",children:[e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-gray-600 text-xs mb-1 font-medium",children:"Success Rate"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:[h.success+h.failed>0?Math.round(h.success/(h.success+h.failed)*100):0,"%"]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-gray-600 text-xs mb-1 font-medium",children:"Avg Time"}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:os&&h.current>0?`${Math.round((Date.now()-os)/h.current/1e3)}s`:"â€”"})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-gray-600 text-xs mb-1 font-medium",children:"Remaining"}),e.jsx("p",{className:"text-xl font-bold text-orange-600",children:ma?qa(ma):"â€”"})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-gray-600 text-xs mb-1 font-medium",children:"Duration"}),e.jsx("p",{className:"text-xl font-bold text-purple-600",children:os?qa(Math.floor((Date.now()-os)/1e3)):"â€”"})]})]})]}),le.length>0&&e.jsxs("div",{className:"mb-6 flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:Rr,className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all flex items-center gap-2 text-sm font-medium",children:[e.jsx(ds,{className:"w-4 h-4"}),"Export Sent (",le.length,")"]}),N.length>le.length&&e.jsxs("button",{onClick:ll,className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2 text-sm font-medium",children:[e.jsx(ds,{className:"w-4 h-4"}),"Export Pending (",N.length-le.length,")"]}),de.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Ir,className:"px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all flex items-center gap-2 text-sm font-medium",children:[e.jsx(ds,{className:"w-4 h-4"}),"Export Failed (",de.length,")"]}),!ie&&e.jsxs("button",{onClick:Qa,className:"px-3 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-all flex items-center gap-2 text-sm font-medium",title:"Add failed contacts to blacklist",children:[e.jsx(rt,{className:"w-4 h-4"}),"Blacklist Failed"]})]})]}),de.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-white rounded-xl border-2 border-red-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 text-sm flex items-center gap-2",children:[e.jsx(_s,{className:"w-4 h-4 text-red-600"}),"Failed Messages (",de.length,")"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!ie&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:il,className:"px-3 py-1.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all flex items-center gap-1.5 text-sm font-medium",title:"Retry all failed messages",children:[e.jsx(nr,{className:"w-3.5 h-3.5"}),"Retry All"]}),e.jsxs("button",{onClick:Qa,className:"px-3 py-1.5 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-all flex items-center gap-1.5 text-sm font-medium",title:"Add all failed contacts to blacklist with their error reasons",children:[e.jsx(rt,{className:"w-3.5 h-3.5"}),"Add to Blacklist"]})]}),e.jsxs("button",{onClick:()=>Qn(!ua),className:"text-sm text-red-600 hover:text-red-700 font-medium flex items-center gap-1",children:[ua?"Hide":"Show"," Details",e.jsx(Kt,{className:`w-4 h-4 transition-transform ${ua?"rotate-180":""}`})]})]})]}),e.jsx("div",{className:"mb-4 grid grid-cols-2 md:grid-cols-4 gap-3",children:(()=>{const s={not_on_whatsapp:de.filter(a=>a.errorType==="not_on_whatsapp").length,invalid_format:de.filter(a=>a.errorType==="invalid_format").length,rate_limit:de.filter(a=>a.errorType==="rate_limit").length,other:de.filter(a=>!a.errorType||a.errorType==="other").length};return e.jsxs(e.Fragment,{children:[s.not_on_whatsapp>0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg border border-orange-200",children:[e.jsx("div",{className:"text-lg mb-1",children:"ğŸ“µ"}),e.jsx("div",{className:"text-lg font-bold text-orange-700",children:s.not_on_whatsapp}),e.jsx("div",{className:"text-xs text-orange-600 font-medium",children:"Not on WhatsApp"})]}),s.invalid_format>0&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"text-lg mb-1",children:"âš ï¸"}),e.jsx("div",{className:"text-lg font-bold text-yellow-700",children:s.invalid_format}),e.jsx("div",{className:"text-xs text-yellow-600 font-medium",children:"Invalid Format"})]}),s.rate_limit>0&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-200",children:[e.jsx("div",{className:"text-lg mb-1",children:"â±ï¸"}),e.jsx("div",{className:"text-lg font-bold text-blue-700",children:s.rate_limit}),e.jsx("div",{className:"text-xs text-blue-600 font-medium",children:"Rate Limited"})]}),s.other>0&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("div",{className:"text-lg mb-1",children:"âŒ"}),e.jsx("div",{className:"text-lg font-bold text-gray-700",children:s.other}),e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Other Errors"})]})]})})()}),de.some(s=>s.errorType==="not_on_whatsapp")&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-sm",children:"ğŸ’¡"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 mb-1",children:'Tips for "Not on WhatsApp" errors:'}),e.jsxs("ul",{className:"text-xs text-gray-700 space-y-1",children:[e.jsx("li",{children:"â€¢ Verify the number is correct and active"}),e.jsx("li",{children:"â€¢ For Tanzania: Use prefixes 71X-78X, 65X, 68X, 69X (e.g., 255712345678)"}),e.jsx("li",{children:"â€¢ Check if it's a mobile number (not landline)"}),e.jsx("li",{children:"â€¢ Confirm WhatsApp is installed on the number"})]})]})]})}),ua&&e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:de.map((s,a)=>{const g=s.errorType==="not_on_whatsapp"?{icon:"ğŸ“µ",color:"orange",label:"Not on WhatsApp"}:s.errorType==="invalid_format"?{icon:"âš ï¸",color:"yellow",label:"Invalid Format"}:s.errorType==="rate_limit"?{icon:"â±ï¸",color:"blue",label:"Rate Limited"}:{icon:"âŒ",color:"red",label:"Error"};return e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200 hover:border-red-300 transition-colors",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm",children:g.icon}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded-full bg-${g.color}-100 text-${g.color}-700`,children:g.label})]}),e.jsx("p",{className:"font-medium text-gray-900 text-sm",children:s.name}),e.jsx("p",{className:"text-xs text-gray-600 font-mono",children:s.phone}),e.jsx("div",{className:"mt-2 p-2 bg-red-50 rounded text-xs text-red-700 leading-relaxed whitespace-pre-line",children:s.error}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:new Date(s.timestamp).toLocaleString()})]})})},a)})})]}),le.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-white rounded-xl border-2 border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 text-sm flex items-center gap-2",children:[e.jsx(It,{className:"w-4 h-4 text-gray-600"}),"Recipients Progress"]}),e.jsxs("button",{onClick:()=>Vn(!ga),className:"text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1",children:[ga?"Hide":"Show"," Details",e.jsx(Kt,{className:`w-4 h-4 transition-transform ${ga?"rotate-180":""}`})]})]}),ga&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsxs("p",{className:"font-semibold text-green-600 mb-2 flex items-center gap-2 text-sm",children:[e.jsx(xe,{className:"w-4 h-4"}),"Sent Recipients (",le.length,")"]}),e.jsxs("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:[le.slice(-5).reverse().map(s=>{const a=i.find(g=>g.phone===s);return e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-2",children:[e.jsx(xe,{className:"w-3 h-3 text-green-500"}),e.jsx("span",{className:"font-medium",children:(a==null?void 0:a.customer_name)||"Unknown"}),e.jsx("span",{className:"text-gray-400",children:"-"}),e.jsx("span",{className:"font-mono text-xs",children:s})]},s)}),le.length>5&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["... and ",le.length-5," more"]})]})]}),N.length>le.length&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsxs("p",{className:"font-semibold text-orange-600 mb-2 flex items-center gap-2 text-sm",children:[e.jsx(Le,{className:"w-4 h-4"}),"Pending Recipients (",N.length-le.length,")"]}),e.jsxs("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:[N.filter(s=>!le.includes(s)).slice(0,5).map(s=>{const a=i.find(g=>g.phone===s);return e.jsxs("div",{className:"text-sm text-gray-700 flex items-center gap-2",children:[e.jsx(Le,{className:"w-3 h-3 text-orange-500"}),e.jsx("span",{className:"font-medium",children:(a==null?void 0:a.customer_name)||"Unknown"}),e.jsx("span",{className:"text-gray-400",children:"-"}),e.jsx("span",{className:"font-mono text-xs",children:s})]},s)}),N.length-le.length>5&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["... and ",N.length-le.length-5," more"]})]})]})]})]}),Qt.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-white rounded-xl border-2 border-gray-200",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 text-sm mb-3 flex items-center gap-2",children:[e.jsx(cr,{className:"w-4 h-4"}),"Campaign Timeline"]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:[...Qt].reverse().map((s,a)=>e.jsxs("div",{className:"flex items-start gap-3 text-sm",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-1.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s.event}),s.details&&e.jsx("p",{className:"text-gray-600",children:s.details}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(s.time).toLocaleString()})]})]},a))})]}),e.jsxs("div",{className:"p-4 bg-white rounded-xl border-2 border-gray-200",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 text-sm mb-3 flex items-center gap-2",children:[e.jsx(Cs,{className:"w-4 h-4"}),"Activity Log",ie&&e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"(Keyboard: Space/P=Pause, S=Stop)"})]}),e.jsxs("div",{className:"text-sm text-gray-700 space-y-2 max-h-48 overflow-y-auto font-medium",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Anti-ban protection active"]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Sending with ",ye,"-",Ee,"s delays"]}),Re&&e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Personalizing messages"]}),Pe&&e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Showing typing indicators"]}),ks&&e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Sound notifications enabled"]}),Xs&&e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-green-600"}),"Browser notifications enabled"]}),e.jsxs("p",{className:"text-blue-600 font-bold mt-3 flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),"Processing message ",h.current," of ",h.total,"..."]})]})]}),h.current===h.total&&h.total>0&&e.jsx("div",{className:"p-5 bg-green-50 border-2 border-green-200 rounded-xl mt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-3",children:e.jsx(xe,{className:"w-6 h-6 text-white"})}),e.jsxs("h3",{className:"text-lg font-bold text-green-900 mb-2 flex items-center justify-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),"Sending Complete!"]}),e.jsxs("p",{className:"text-sm text-green-700 font-medium",children:["Successfully sent ",h.success," out of ",h.total," messages"]}),h.failed>0&&e.jsxs("p",{className:"text-sm text-red-600 mt-2 font-medium",children:[h.failed," message",h.failed!==1?"s":""," failed to send"]})]})})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200 flex-shrink-0 bg-white px-6 pb-6",children:[e.jsx("button",{onClick:()=>{w===1?(x(!1),C(1),S(""),ee([]),js(null),xs(""),Ks(""),ia(""),Ue("text"),it(!1),ct(""),Ms(["",""]),mt(!1),wt(""),jt(""),Nt(""),vt("")):w===4&&h.current<h.total&&h.total>0?c.error("Cannot go back while messages are being sent"):C(w-1)},className:"flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),w===1&&e.jsx("button",{onClick:()=>{if(N.length===0){c.error("Please select at least one recipient");return}C(2)},disabled:N.length===0,className:"flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:"Next: Compose Message"}),w===2&&e.jsx("button",{onClick:()=>{if(q==="text"&&!b.trim()){c.error("Please enter a message");return}if(["image","video","document","audio"].includes(q)&&!Fe){c.error(`Please upload a ${q} file`);return}if(q==="poll"){if(!hs.trim()){c.error("Please enter a poll question");return}if(as.filter(a=>a.trim()).length<2){c.error("Please add at least 2 poll options");return}}if(q==="location"&&(!Ns||!vs)){c.error("Please enter latitude and longitude");return}Sa(),C(3)},disabled:q==="text"&&!b.trim()||["image","video","document","audio"].includes(q)&&!Fe||q==="poll"&&(!hs.trim()||as.filter(s=>s.trim()).length<2)||q==="location"&&(!Ns||!vs),className:"flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:"Next: Review & Confirm"}),w===3&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{Mr(new Date().toISOString().split("T")[0]),$r("09:00"),pa(!0)},className:"px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg flex items-center justify-center gap-2",children:[e.jsx(Ls,{className:"w-5 h-5"}),"Schedule"]}),We==="browser"?e.jsxs("button",{onClick:()=>{C(4),Tt()},className:"flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2",children:[e.jsx(fs,{className:"w-5 h-5"}),(()=>{const s=N.filter(a=>!le.includes(a)).length;return le.length>0?`Send ${s} Pending`:`Send ${N.length} Message${N.length!==1?"s":""}`})()]}):e.jsxs("button",{onClick:hl,className:"flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),"Submit to Cloud"]})]}),w===4&&ie&&h.current<h.total&&!$s&&We==="browser"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{console.log("â¸ï¸ Pausing campaign..."),Ct(!0),c("Pausing...")},disabled:Ss,className:"flex-1 px-4 py-3 bg-yellow-500 text-white rounded-xl font-medium hover:bg-yellow-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg",children:[e.jsx(Le,{className:"w-5 h-5"}),"Pause"]}),e.jsxs("button",{onClick:()=>{console.log("ğŸ›‘ Stopping campaign..."),window.confirm("Stop campaign? All remaining messages will be cancelled.")&&(Vt(!0),c("Stopping..."))},disabled:Ss,className:"flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg",children:[e.jsx(Te,{className:"w-5 h-5"}),"Stop"]})]}),w===4&&($s||!ie)&&h.current<h.total&&!Ss&&We==="browser"&&e.jsxs("button",{onClick:()=>{console.log("â–¶ï¸ Resuming campaign..."),Ct(!1),Se(!0),c.success("Resuming campaign..."),setTimeout(()=>{Tt(!0)},500)},className:"flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2",children:[e.jsx(Cs,{className:"w-5 h-5"}),"â–¶ï¸ Resume Sending"]}),w===4&&h.current===h.total&&h.total>0&&e.jsxs("button",{onClick:()=>{x(!1),C(1),S(""),ee([]),ce({current:0,total:0,success:0,failed:0}),js(null),xs(""),Ks(""),ia(""),Ue("text"),it(!1),ct(""),Ms(["",""]),mt(!1),wt(""),jt(""),Nt(""),vt("")},className:"flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5"}),"Done"]})]})]})})})(),Pl(),e.jsxs(Pt.Fragment,{children:[e.jsx(wo,{isOpen:jn,onClose:()=>fr(!1),currentActiveCampaign:ie&&w===4?{name:ls||"Current Campaign",status:$s?"paused":Ss?"stopped":"active",selectedRecipients:N,sentPhones:le,bulkMessage:b,bulkMessageType:q,bulkMedia:Fe,bulkProgress:h,usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,timestamp:os?new Date(os).toISOString():new Date().toISOString()}:void 0,onResumeCampaign:r=>{ee(r.selectedRecipients||[]),S(r.bulkMessage||""),Ue(r.bulkMessageType||"text"),js(r.bulkMedia||null),ut(r.sentPhones||[]),ce(r.bulkProgress||{current:0,total:0,success:0,failed:0}),r.usePersonalization!==void 0&&ms(r.usePersonalization),r.randomDelay!==void 0&&gs(r.randomDelay),r.minDelay&&us(r.minDelay),r.maxDelay&&cs(r.maxDelay),x(!0),C(4),c.success("Campaign restored! Click Resume to continue.",{duration:5e3})},onDeleteCampaign:r=>{r==="whatsapp_paused_campaign"&&wa(),c.success("Campaign deleted")},onClone:r=>{if(S(r.message),r.recipients_data){const s=r.recipients_data.map(a=>a.phone);ee(s)}ot(`${r.name} (Copy)`),x(!0),C(2),c.success("Campaign cloned! Edit and send when ready.")}}),e.jsx(Co,{isOpen:Xn,onClose:()=>ha(!1),onLoadTemplate:r=>{console.log("ğŸ“‹ Loading template:",r.name),S(r.message),Ue(r.messageType),["image","video","document","audio"].includes(r.messageType)&&(js(null),Ks(""),xs(""),ia(r.message)),r.messageType==="poll"&&r.settings&&(r.settings.pollQuestion&&ct(r.settings.pollQuestion),r.settings.pollOptions&&Ms(r.settings.pollOptions),r.settings.allowMultiSelect!==void 0&&mt(r.settings.allowMultiSelect)),["image","video"].includes(r.messageType)&&r.settings.viewOnce!==void 0&&it(r.settings.viewOnce),Object.entries(r.settings).forEach(([s,a])=>{s==="usePersonalization"&&typeof a=="boolean"&&ms(a),s==="randomDelay"&&typeof a=="boolean"&&gs(a),s==="minDelay"&&typeof a=="number"&&us(a),s==="maxDelay"&&typeof a=="number"&&cs(a),s==="usePresence"&&typeof a=="boolean"&&lt(a),s==="batchSize"&&typeof a=="number"&&Bs(a),s==="batchDelay"&&typeof a=="number"&&Os(a),s==="maxPerHour"&&typeof a=="number"&&Ws(a),s==="dailyLimit"&&typeof a=="number"&&Fs(a),s==="skipRecentlyContacted"&&typeof a=="boolean"&&Hs(a),s==="respectQuietHours"&&typeof a=="boolean"&&zs(a),s==="useInvisibleChars"&&typeof a=="boolean"&&qs(a),s==="useEmojiVariation"&&typeof a=="boolean"&&Vs(a),s==="varyMessageLength"&&typeof a=="boolean"&&Gs(a)}),C(2),gt(!1),Se(!1),ce({current:0,total:0,success:0,failed:0}),x(!0),console.log("âœ… Template loaded, opening bulk modal at step 2"),["image","video","document","audio"].includes(r.messageType)?c.success(`Template "${r.name}" loaded! Please select ${r.messageType} media to continue.`,{duration:4e3}):r.messageType==="poll"?c.success(`Template "${r.name}" loaded! Poll is ready. Review and send when ready.`,{duration:4e3}):c.success(`Template "${r.name}" loaded! Review and send when ready.`,{duration:3e3})},currentCampaignData:b||N.length>0?{message:b,messageType:q,settings:{usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es}}:void 0}),e.jsx(Po,{isOpen:el,onClose:()=>Tr(!1),onLoadCampaign:r=>{ot(r.name),S(r.message),Ue(r.messageType),ee(r.selectedRecipients),Object.entries(r.settings).forEach(([s,a])=>{s==="usePersonalization"&&ms(a),s==="randomDelay"&&gs(a),s==="minDelay"&&us(a),s==="maxDelay"&&cs(a)}),x(!0),C(4),setTimeout(()=>Tt(!1),500)}}),e.jsx(mo,{isOpen:Nn,onClose:()=>br(!1),onUpdate:()=>{Ka(),ps()}}),e.jsx(ho,{isOpen:vn,onClose:()=>Ia(!1),onSelect:r=>{js(r.file_url),xs(r.file_type),r.file_type==="image"&&Ks(r.file_url),c.success(`${r.name} loaded from library!`),Ae.mediaLibrary.incrementUsage(r.id)}}),e.jsx(bo,{isOpen:Sn,onClose:()=>{la(!1),ja()},onSessionConnected:r=>{c.success(`WhatsApp session "${r.name}" connected successfully!`),ps(),ja()}}),e.jsx(Uo,{isOpen:kn,onClose:()=>yr(!1)}),e.jsx(eo,{isOpen:tl,onClose:()=>pa(!1),title:"Schedule Campaign",maxWidth:"md",actions:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>pa(!1),className:"px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors",children:"Cancel"}),e.jsx("button",{onClick:()=>{if(!fa||!ba){c.error("Please enter both date and time");return}if(!/^\d{4}-\d{2}-\d{2}$/.test(fa)){c.error("Please enter a valid date (YYYY-MM-DD)");return}if(!/^\d{2}:\d{2}$/.test(ba)){c.error("Please enter a valid time (HH:MM)");return}const a=`${fa}T${ba}:00`,g=Intl.DateTimeFormat().resolvedOptions().timeZone;try{const u=Eo(ls||`Campaign ${new Date().toLocaleDateString()}`,a,g,b,q,N,{usePersonalization:Re,randomDelay:Ie,minDelay:ye,maxDelay:Ee,usePresence:Pe,batchSize:qe,batchDelay:ze,maxPerHour:Qe,dailyLimit:ns,skipRecentlyContacted:Ve,respectQuietHours:Ye,useInvisibleChars:ss,useEmojiVariation:ts,varyMessageLength:es});c.success(`Campaign scheduled for ${new Date(a).toLocaleString()}`),x(!1),C(1),pa(!1)}catch(u){console.error("Error scheduling campaign:",u),c.error("Failed to schedule campaign")}},className:"px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-medium hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg",children:"Schedule"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ls,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:18}),e.jsx("input",{type:"date",value:fa,onChange:r=>Mr(r.target.value),min:new Date().toISOString().split("T")[0],className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent",required:!0})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Format: YYYY-MM-DD"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Time ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:18}),e.jsx("input",{type:"time",value:ba,onChange:r=>$r(r.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent",required:!0})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Format: HH:MM (24-hour format)"})]})]})})]},"modals")]})}export{Di as default};
