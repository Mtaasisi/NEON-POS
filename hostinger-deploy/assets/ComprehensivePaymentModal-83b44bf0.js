import{aC as W,s as z,b as H,j as e}from"./index-61458a34.js";import{r as n}from"./vendor-36d2c7c1.js";import{X as I,cJ as J,d as X,q as O,aE as Q,S as V,aw as Y,a$ as Z,ae as ee,n as f}from"./ui-28e30067.js";import{G as A}from"./GlassInput-0475021a.js";import{f as g}from"./currencyUtils-59109a41.js";const F=new Map,te=5*60*1e3;function se(q={}){const{autoFetch:j=!0,cacheKey:N="default",activeOnly:i=!0}=q,S=W(),[d,k]=n.useState([]),[c,p]=n.useState(!1),[y,m]=n.useState(null),o=n.useRef(!0);n.useEffect(()=>(o.current=!0,()=>{o.current=!1}),[]);const M=async(T=!1)=>{if(!o.current)return;const E=`${N}_${i?"active":"all"}`;if(!T&&S.length>0){let l=S;i&&(l=S.filter(a=>a.is_active!==!1)),console.log(`✅ Using preloaded payment methods: ${l.length} methods`),k(l),p(!1),m(null);return}if(!T){const l=F.get(E);if(l&&Date.now()-l.timestamp<te){k(l.data),p(!1),m(null);return}}try{p(!0),m(null);const{data:l,error:a}=await z.from("payment_methods").select("*").order("name",{ascending:!0});if(a)throw a;let b=l||[];i&&(b=b.filter(u=>u.is_active!==!1)),F.set(E,{data:b,timestamp:Date.now()}),o.current&&(k(b),p(!1),m(null))}catch(l){const a=l instanceof Error?l.message:"Failed to fetch payment methods";o.current&&(console.error("❌ Error fetching payment methods:",a),m(a),p(!1))}},_=async()=>{await M(!0)};return n.useEffect(()=>{j&&M()},[j,N,i]),{paymentMethods:d,loading:c,error:y,refetch:_}}const ce=({isOpen:q,onClose:j,totalAmount:N,discountAmount:i,onProcessPayment:S,selectedCustomer:d,isProcessing:k=!1})=>{se(),H();const[c,p]=n.useState(""),[y,m]=n.useState(N-i),[o,M]=n.useState(""),[_,T]=n.useState(0),[E,l]=n.useState(""),[a,b]=n.useState([]),[u,R]=n.useState(!1),[v,$]=n.useState(0),[w,G]=n.useState(0),h=n.useMemo(()=>N-i+v+w,[N,i,v,w]),P=[{id:"cash",name:"Cash",type:"cash",icon:e.jsx(O,{className:"w-5 h-5"}),color:"bg-green-500",requiresAmount:!0},{id:"card",name:"Credit/Debit Card",type:"card",icon:e.jsx(Q,{className:"w-5 h-5"}),color:"bg-blue-500",requiresAmount:!0,requiresReference:!0},{id:"mobile_money",name:"Mobile Money",type:"mobile_money",icon:e.jsx(V,{className:"w-5 h-5"}),color:"bg-purple-500",requiresAmount:!0,requiresReference:!0},{id:"bank_transfer",name:"Bank Transfer",type:"bank_transfer",icon:e.jsx(Y,{className:"w-5 h-5"}),color:"bg-orange-500",requiresAmount:!0,requiresReference:!0}];d&&d.points>0&&P.push({id:"loyalty_points",name:"Loyalty Points",type:"loyalty_points",icon:e.jsx(Z,{className:"w-5 h-5"}),color:"bg-yellow-500",requiresAmount:!0}),P.push({id:"gift_card",name:"Gift Card",type:"gift_card",icon:e.jsx(ee,{className:"w-5 h-5"}),color:"bg-pink-500",requiresAmount:!0}),n.useEffect(()=>{q&&(p(""),m(h),M(""),T(0),l(""),b([]),R(!1),$(0),G(0))},[q,h]);const L=async()=>{if(!c){f.error("Please select a payment method");return}const t=P.find(s=>s.id===c);if(!t){f.error("Invalid payment method selected");return}let r={method:t.type,amount:y,totalAmount:h,discountAmount:i,taxAmount:v,tipAmount:w};switch(t.type){case"cash":break;case"card":case"mobile_money":case"bank_transfer":if(t.requiresReference&&!o.trim()){f.error(`Please enter reference number for ${t.name}`);return}r.reference=o;break;case"loyalty_points":if(_<=0){f.error("Please enter loyalty points to use");return}if(d&&_>d.points){f.error("Not enough loyalty points available");return}r.loyaltyPoints=_;break;case"gift_card":if(!E.trim()){f.error("Please enter gift card code");return}r.giftCardCode=E;break}try{await S(r),j()}catch(s){console.error("Payment processing failed:",s)}},U=async()=>{const t=a.reduce((s,x)=>s+x.amount,0);if(Math.abs(t-h)>.01){f.error("Split payment amounts must equal the total amount");return}const r={method:"split",splitPayments:a,totalAmount:h,discountAmount:i,taxAmount:v,tipAmount:w};try{await S(r),j()}catch(s){console.error("Split payment processing failed:",s)}},B=()=>{if(!c){f.error("Please select a payment method");return}if(!P.find(x=>x.id===c))return;const r=h-a.reduce((x,D)=>x+D.amount,0);if(y<=0||y>r){f.error(`Payment amount must be between 0 and ${g.money(r)}`);return}const s={methodId:c,amount:y,reference:o||void 0};b([...a,s]),m(h-a.reduce((x,D)=>x+D.amount,0)-y),M("")},K=t=>{const r=[...a];r.splice(t,1),b(r)},C=P.find(t=>t.id===c);return q?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col",children:[e.jsx("div",{className:"bg-blue-600 p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Complete Payment"}),e.jsx("p",{className:"text-blue-100 mt-1",children:"Choose your payment method"})]}),e.jsx("button",{onClick:j,className:"p-2 hover:bg-blue-700 rounded-lg transition-colors",children:e.jsx(I,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsx("span",{className:"float-right font-medium",children:g.money(N)})]}),i>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-green-600",children:"Discount:"}),e.jsxs("span",{className:"float-right font-medium text-green-600",children:["-",g.money(i)]})]}),v>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Tax:"}),e.jsx("span",{className:"float-right font-medium",children:g.money(v)})]}),w>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Tip:"}),e.jsx("span",{className:"float-right font-medium",children:g.money(w)})]}),e.jsxs("div",{className:"border-t pt-2 col-span-2",children:[e.jsx("span",{className:"text-lg font-bold",children:"Total:"}),e.jsx("span",{className:"float-right text-lg font-bold text-blue-600",children:g.money(h)})]})]})}),e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:t=>R(t.target.checked),className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Split Payment"}),e.jsx(J,{className:"w-4 h-4 text-gray-400"})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Payment Method"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:P.map(t=>e.jsxs("button",{onClick:()=>p(t.id),className:`p-4 rounded-lg border-2 transition-all ${c===t.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("div",{className:`w-10 h-10 ${t.color} rounded-lg flex items-center justify-center text-white mb-2 mx-auto`,children:t.icon}),e.jsx("div",{className:"text-sm font-medium text-center",children:t.name})]},t.id))})]}),C&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Payment Details"}),e.jsxs("div",{className:"space-y-4",children:[!u&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Amount"}),e.jsx(A,{type:"number",value:y,onChange:t=>m(Number(t.target.value)),placeholder:"Enter amount",className:"w-full"})]}),C.requiresReference&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:C.type==="card"?"Transaction ID":C.type==="mobile_money"?"Transaction Reference":"Reference Number"}),e.jsx(A,{type:"text",value:o,onChange:t=>M(t.target.value),placeholder:"Enter reference number",className:"w-full"})]}),C.type==="loyalty_points"&&d&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["Loyalty Points (Available: ",d.points||0,")"]}),e.jsx(A,{type:"number",value:_,onChange:t=>T(Number(t.target.value)),placeholder:"Enter points to use",max:d.points||0,className:"w-full"})]}),C.type==="gift_card"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Gift Card Code"}),e.jsx(A,{type:"text",value:E,onChange:t=>l(t.target.value),placeholder:"Enter gift card code",className:"w-full"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Tax Amount"}),e.jsx(A,{type:"number",value:v,onChange:t=>$(Number(t.target.value)),placeholder:"0.00",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Tip Amount"}),e.jsx(A,{type:"number",value:w,onChange:t=>G(Number(t.target.value)),placeholder:"0.00",className:"w-full"})]})]})]})]}),u&&a.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Split Payments"}),e.jsxs("div",{className:"space-y-2",children:[a.map((t,r)=>{const s=P.find(x=>x.id===t.methodId);return e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-8 h-8 ${s==null?void 0:s.color} rounded-lg flex items-center justify-center text-white`,children:s==null?void 0:s.icon}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s==null?void 0:s.name}),t.reference&&e.jsxs("div",{className:"text-sm text-gray-500",children:["Ref: ",t.reference]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium",children:g.money(t.amount)}),e.jsx("button",{onClick:()=>K(r),className:"text-red-500 hover:text-red-700",children:e.jsx(I,{className:"w-4 h-4"})})]})]},r)}),e.jsxs("div",{className:"text-sm text-gray-600 pt-2 border-t",children:["Remaining: ",g.money(h-a.reduce((t,r)=>t+r.amount,0))]})]})]}),u&&C&&e.jsx("div",{className:"mb-6",children:e.jsx("button",{onClick:B,className:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors",children:"Add Payment Method"})})]}),e.jsx("div",{className:"bg-gray-50 p-6 border-t",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:j,className:"flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium",children:"Cancel"}),e.jsx("button",{onClick:u?U:L,disabled:k||!u&&!c||u&&a.length===0,className:"flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium flex items-center justify-center space-x-2",children:k?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),e.jsx("span",{children:"Processing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-5 h-5"}),e.jsx("span",{children:"Complete Payment"})]})})]})})]})}):null};export{ce as C};
