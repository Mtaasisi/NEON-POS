import{b as C,j as o}from"./index-61458a34.js";import{r as b,b as v}from"./vendor-36d2c7c1.js";import{X as j,U as N,j as A,n}from"./ui-28e30067.js";import{C as E}from"./CustomerForm-3440546b.js";import{f as k,a as S}from"./phoneUtils-a8934478.js";import{u as M,S as P}from"./useSuccessModal-081786c4.js";import{S as T}from"./SuccessModalIcons-fe811e4d.js";import{u as L}from"./useBodyScrollLock-341c8b9f.js";const $=({isOpen:l,onClose:t,onCustomerCreated:c,onAddAnother:i})=>{const{addCustomer:x}=C(),[a,m]=b.useState(!1),u=M(),y=async s=>{var h,g,p;try{console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸŽ¯ AddCustomerModal: Starting customer creation process"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ“ Form data received:",s),m(!0);const e={name:s.name,phone:k(s.phone),email:"",gender:s.gender,city:s.city,whatsapp:S(s.whatsapp||""),referralSource:s.referralSource,birthMonth:s.birthMonth,birthDay:s.birthDay,notes:[],loyaltyLevel:"interested",colorTag:s.customerTag,referrals:[],totalSpent:0,points:0,lastVisit:new Date().toISOString(),isActive:!0,devices:[]};console.log("ðŸ“¦ Customer payload prepared:",{name:e.name,phone:e.phone,gender:e.gender,city:e.city,whatsapp:e.whatsapp,loyaltyLevel:e.loyaltyLevel,colorTag:e.colorTag}),console.log("ðŸš€ Calling addCustomer function...");const r=await x(e);console.log("ðŸ“¨ addCustomer returned:",r?"Customer object":"null/undefined"),r?(console.log("âœ… Customer created successfully:",{id:r.id,name:r.name,phone:r.phone}),u.show(`${r.name} has been added to your customer list!`,{title:"Customer Added! âœ…",icon:T.customerAdded,autoCloseDelay:0,actionButtons:[{label:"Message on WhatsApp",onClick:()=>{const d=r.whatsapp||r.phone,f=d==null?void 0:d.replace(/\D/g,"");if(f){const w=encodeURIComponent(`Hello ${r.name}, thank you for becoming our customer!`);window.open(`https://wa.me/${f}?text=${w}`,"_blank")}else n.error("Customer has no phone number")},variant:"whatsapp"},{label:"View Customer",onClick:()=>{c&&c(r)},variant:"secondary"},{label:"Add Another",onClick:()=>{i?i():n.success("Ready to add another customer!")},variant:"secondary"}]}),t()):(console.error("âŒ AddCustomerModal: addCustomer returned null/undefined"),console.error("This should not happen - addCustomer should throw an error instead"),n.error("Failed to create customer. Please try again."))}catch(e){console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.error("âŒ AddCustomerModal: CUSTOMER CREATION FAILED"),console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.error("Error caught in AddCustomerModal.handleCustomerCreated"),console.error("Error Type:",((h=e==null?void 0:e.constructor)==null?void 0:h.name)||"Unknown"),console.error("Error Message:",(e==null?void 0:e.message)||"No message"),console.error("Error Code:",(e==null?void 0:e.code)||"No code"),console.error("Error Details:",(e==null?void 0:e.details)||"No details"),console.error("Error Hint:",(e==null?void 0:e.hint)||"No hint"),console.error("PostgreSQL Error:",e!=null&&e.code?"Yes (Database error)":"No (Application error)"),console.error("Full Error Object:",e),console.error("Stack Trace:",(e==null?void 0:e.stack)||"No stack trace"),console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");let r="Failed to create customer. Please try again.";(g=e==null?void 0:e.message)!=null&&g.includes("not authenticated")?(r="You are not logged in. Please log in and try again.",console.error("ðŸ” Authentication error detected")):(e==null?void 0:e.code)==="23505"?(r="A customer with this phone number already exists.",console.error("ðŸ“± Duplicate phone number error")):(e==null?void 0:e.code)==="23502"?(r="Missing required field. Please check all required fields.",console.error("ðŸ“ Missing required field error")):(e==null?void 0:e.code)==="42P01"?(r="Database table not found. Please contact support.",console.error("ðŸ—„ï¸ Database table missing error")):(e==null?void 0:e.code)==="42703"?(r="Database column not found. Please contact support.",console.error("ðŸ“Š Database column missing error")):(p=e==null?void 0:e.message)!=null&&p.includes("RLS")&&(r="Database security policy blocking insert. Please contact support.",console.error("ðŸ”’ RLS policy error")),console.error("ðŸ’¬ User-facing error message:",r),n.error(r)}finally{m(!1),console.log("ðŸ AddCustomerModal: Customer creation process ended")}};return L(l),b.useEffect(()=>{if(l){const s=document.documentElement.style.overflow;return document.documentElement.style.overflow="hidden",()=>{document.documentElement.style.overflow=s}}},[l]),l?v.createPortal(o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[99999]",style:{top:0,left:0,right:0,bottom:0,overflow:"hidden",overscrollBehavior:"none"},role:"dialog","aria-modal":"true","aria-labelledby":"customer-form-title",onClick:t,children:o.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",style:{pointerEvents:"auto"},onClick:s=>s.stopPropagation(),children:[o.jsx("button",{type:"button",onClick:t,disabled:a,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:o.jsx(j,{className:"w-5 h-5"})}),o.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:o.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[o.jsx("div",{className:"w-16 h-16 bg-orange-600 rounded-full flex items-center justify-center shadow-lg",children:o.jsx(N,{className:"w-8 h-8 text-white"})}),o.jsxs("div",{children:[o.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",id:"customer-form-title",children:"Add New Customer"}),o.jsx("p",{className:"text-sm text-gray-600",children:"Enter customer details below"})]})]})}),o.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:o.jsx(E,{onSubmit:y,onCancel:t,isLoading:a,renderActionsInModal:!1})}),o.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200 flex-shrink-0 bg-white px-6 pb-6",children:[o.jsx("button",{type:"button",onClick:t,disabled:a,className:"flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),o.jsx("button",{type:"button",onClick:()=>{const s=document.getElementById("customer-form");s&&s.requestSubmit()},disabled:a,className:"flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:a?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),"Adding..."]}):o.jsxs(o.Fragment,{children:[o.jsx(A,{className:"w-5 h-5"}),"Add Customer"]})})]})]})}),o.jsx(P,{...u.props})]}),document.body):null};export{$ as A};
