var bl=Object.defineProperty;var wl=(s,e,t)=>e in s?bl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var me=(s,e,t)=>(wl(s,typeof e!="symbol"?e+"":e,t),t);import{r as D,b as vl,c as Sl,d as El,g as Ao,R as er}from"./vendor-36d2c7c1.js";import{_ as z}from"./supabase-cf010ec4.js";import{u as ko,a as Io,N as it,B as xl,R as Pl,b as K}from"./routing-eb8c310c.js";import{n as ge,z as Gr,X as Co,Z as Al,C as aa,a as Do,b as na,c as To,R as tr,E as kl,L as Il,d as Ro,A as Jt,I as Cl,e as Dl,D as Tl,H as Oo,f as Rl,g as Ol,h as Nl,F as Ll}from"./ui-28e30067.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();var No={exports:{}},ys={};var Ul=D,jl=Symbol.for("react.element"),$l=Symbol.for("react.fragment"),Ml=Object.prototype.hasOwnProperty,ql=Ul.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Bl={key:!0,ref:!0,__self:!0,__source:!0};function Lo(s,e,t){var r,a={},n=null,o=null;t!==void 0&&(n=""+t),e.key!==void 0&&(n=""+e.key),e.ref!==void 0&&(o=e.ref);for(r in e)Ml.call(e,r)&&!Bl.hasOwnProperty(r)&&(a[r]=e[r]);if(s&&s.defaultProps)for(r in e=s.defaultProps,e)a[r]===void 0&&(a[r]=e[r]);return{$$typeof:jl,type:s,key:n,ref:o,props:a,_owner:ql.current}}ys.Fragment=$l;ys.jsx=Lo;ys.jsxs=Lo;No.exports=ys;var f=No.exports,oa={},vn=vl;oa.createRoot=vn.createRoot,oa.hydrateRoot=vn.hydrateRoot;var Fl=Object.create,ir=Object.defineProperty,zl=Object.getOwnPropertyDescriptor,Vl=Object.getOwnPropertyNames,Gl=Object.getPrototypeOf,Wl=Object.prototype.hasOwnProperty,Hl=(s,e,t)=>e in s?ir(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,I=(s,e)=>ir(s,"name",{value:e,configurable:!0}),Ve=(s,e)=>()=>(s&&(e=s(s=0)),e),ie=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),et=(s,e)=>{for(var t in e)ir(s,t,{get:e[t],enumerable:!0})},Uo=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Vl(e))!Wl.call(s,a)&&a!==t&&ir(s,a,{get:()=>e[a],enumerable:!(r=zl(e,a))||r.enumerable});return s},Ot=(s,e,t)=>(t=s!=null?Fl(Gl(s)):{},Uo(e||!s||!s.__esModule?ir(t,"default",{value:s,enumerable:!0}):t,s)),Ne=s=>Uo(ir({},"__esModule",{value:!0}),s),ae=(s,e,t)=>Hl(s,typeof e!="symbol"?e+"":e,t),Ql=ie(s=>{Z(),s.byteLength=c,s.toByteArray=d,s.fromByteArray=g;var e=[],t=[],r=typeof Uint8Array<"u"?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0,o=a.length;n<o;++n)e[n]=a[n],t[a.charCodeAt(n)]=n;var n,o;t[45]=62,t[95]=63;function i(p){var m=p.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var _=p.indexOf("=");_===-1&&(_=m);var b=_===m?0:4-_%4;return[_,b]}I(i,"getLens");function c(p){var m=i(p),_=m[0],b=m[1];return(_+b)*3/4-b}I(c,"byteLength");function l(p,m,_){return(m+_)*3/4-_}I(l,"_byteLength");function d(p){var m,_=i(p),b=_[0],S=_[1],v=new r(l(p,b,S)),C=0,T=S>0?b-4:b,x;for(x=0;x<T;x+=4)m=t[p.charCodeAt(x)]<<18|t[p.charCodeAt(x+1)]<<12|t[p.charCodeAt(x+2)]<<6|t[p.charCodeAt(x+3)],v[C++]=m>>16&255,v[C++]=m>>8&255,v[C++]=m&255;return S===2&&(m=t[p.charCodeAt(x)]<<2|t[p.charCodeAt(x+1)]>>4,v[C++]=m&255),S===1&&(m=t[p.charCodeAt(x)]<<10|t[p.charCodeAt(x+1)]<<4|t[p.charCodeAt(x+2)]>>2,v[C++]=m>>8&255,v[C++]=m&255),v}I(d,"toByteArray");function u(p){return e[p>>18&63]+e[p>>12&63]+e[p>>6&63]+e[p&63]}I(u,"tripletToBase64");function h(p,m,_){for(var b,S=[],v=m;v<_;v+=3)b=(p[v]<<16&16711680)+(p[v+1]<<8&65280)+(p[v+2]&255),S.push(u(b));return S.join("")}I(h,"encodeChunk");function g(p){for(var m,_=p.length,b=_%3,S=[],v=16383,C=0,T=_-b;C<T;C+=v)S.push(h(p,C,C+v>T?T:C+v));return b===1?(m=p[_-1],S.push(e[m>>2]+e[m<<4&63]+"==")):b===2&&(m=(p[_-2]<<8)+p[_-1],S.push(e[m>>10]+e[m>>4&63]+e[m<<2&63]+"=")),S.join("")}I(g,"fromByteArray")}),Kl=ie(s=>{Z(),s.read=function(e,t,r,a,n){var o,i,c=n*8-a-1,l=(1<<c)-1,d=l>>1,u=-7,h=r?n-1:0,g=r?-1:1,p=e[t+h];for(h+=g,o=p&(1<<-u)-1,p>>=-u,u+=c;u>0;o=o*256+e[t+h],h+=g,u-=8);for(i=o&(1<<-u)-1,o>>=-u,u+=a;u>0;i=i*256+e[t+h],h+=g,u-=8);if(o===0)o=1-d;else{if(o===l)return i?NaN:(p?-1:1)*(1/0);i=i+Math.pow(2,a),o=o-d}return(p?-1:1)*i*Math.pow(2,o-a)},s.write=function(e,t,r,a,n,o){var i,c,l,d=o*8-n-1,u=(1<<d)-1,h=u>>1,g=n===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=a?0:o-1,m=a?1:-1,_=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(c=isNaN(t)?1:0,i=u):(i=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-i))<1&&(i--,l*=2),i+h>=1?t+=g/l:t+=g*Math.pow(2,1-h),t*l>=2&&(i++,l/=2),i+h>=u?(c=0,i=u):i+h>=1?(c=(t*l-1)*Math.pow(2,n),i=i+h):(c=t*Math.pow(2,h-1)*Math.pow(2,n),i=0));n>=8;e[r+p]=c&255,p+=m,c/=256,n-=8);for(i=i<<n|c,d+=n;d>0;e[r+p]=i&255,p+=m,i/=256,d-=8);e[r+p-m]|=_*128}}),Jl=ie(s=>{Z();var e=Ql(),t=Kl(),r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;s.Buffer=i,s.SlowBuffer=S,s.INSPECT_MAX_BYTES=50;var a=2147483647;s.kMaxLength=a,i.TYPED_ARRAY_SUPPORT=n(),!i.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function n(){try{let y=new Uint8Array(1),E={foo:I(function(){return 42},"foo")};return Object.setPrototypeOf(E,Uint8Array.prototype),Object.setPrototypeOf(y,E),y.foo()===42}catch{return!1}}I(n,"typedArraySupport"),Object.defineProperty(i.prototype,"parent",{enumerable:!0,get:I(function(){if(i.isBuffer(this))return this.buffer},"get")}),Object.defineProperty(i.prototype,"offset",{enumerable:!0,get:I(function(){if(i.isBuffer(this))return this.byteOffset},"get")});function o(y){if(y>a)throw new RangeError('The value "'+y+'" is invalid for option "size"');let E=new Uint8Array(y);return Object.setPrototypeOf(E,i.prototype),E}I(o,"createBuffer");function i(y,E,A){if(typeof y=="number"){if(typeof E=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return u(y)}return c(y,E,A)}I(i,"Buffer"),i.poolSize=8192;function c(y,E,A){if(typeof y=="string")return h(y,E);if(ArrayBuffer.isView(y))return p(y);if(y==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof y);if(ke(y,ArrayBuffer)||y&&ke(y.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(ke(y,SharedArrayBuffer)||y&&ke(y.buffer,SharedArrayBuffer)))return m(y,E,A);if(typeof y=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let j=y.valueOf&&y.valueOf();if(j!=null&&j!==y)return i.from(j,E,A);let q=_(y);if(q)return q;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof y[Symbol.toPrimitive]=="function")return i.from(y[Symbol.toPrimitive]("string"),E,A);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof y)}I(c,"from"),i.from=function(y,E,A){return c(y,E,A)},Object.setPrototypeOf(i.prototype,Uint8Array.prototype),Object.setPrototypeOf(i,Uint8Array);function l(y){if(typeof y!="number")throw new TypeError('"size" argument must be of type number');if(y<0)throw new RangeError('The value "'+y+'" is invalid for option "size"')}I(l,"assertSize");function d(y,E,A){return l(y),y<=0?o(y):E!==void 0?typeof A=="string"?o(y).fill(E,A):o(y).fill(E):o(y)}I(d,"alloc"),i.alloc=function(y,E,A){return d(y,E,A)};function u(y){return l(y),o(y<0?0:b(y)|0)}I(u,"allocUnsafe"),i.allocUnsafe=function(y){return u(y)},i.allocUnsafeSlow=function(y){return u(y)};function h(y,E){if((typeof E!="string"||E==="")&&(E="utf8"),!i.isEncoding(E))throw new TypeError("Unknown encoding: "+E);let A=v(y,E)|0,j=o(A),q=j.write(y,E);return q!==A&&(j=j.slice(0,q)),j}I(h,"fromString");function g(y){let E=y.length<0?0:b(y.length)|0,A=o(E);for(let j=0;j<E;j+=1)A[j]=y[j]&255;return A}I(g,"fromArrayLike");function p(y){if(ke(y,Uint8Array)){let E=new Uint8Array(y);return m(E.buffer,E.byteOffset,E.byteLength)}return g(y)}I(p,"fromArrayView");function m(y,E,A){if(E<0||y.byteLength<E)throw new RangeError('"offset" is outside of buffer bounds');if(y.byteLength<E+(A||0))throw new RangeError('"length" is outside of buffer bounds');let j;return E===void 0&&A===void 0?j=new Uint8Array(y):A===void 0?j=new Uint8Array(y,E):j=new Uint8Array(y,E,A),Object.setPrototypeOf(j,i.prototype),j}I(m,"fromArrayBuffer");function _(y){if(i.isBuffer(y)){let E=b(y.length)|0,A=o(E);return A.length===0||y.copy(A,0,0,E),A}if(y.length!==void 0)return typeof y.length!="number"||Be(y.length)?o(0):g(y);if(y.type==="Buffer"&&Array.isArray(y.data))return g(y.data)}I(_,"fromObject");function b(y){if(y>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return y|0}I(b,"checked");function S(y){return+y!=y&&(y=0),i.alloc(+y)}I(S,"SlowBuffer"),i.isBuffer=I(function(y){return y!=null&&y._isBuffer===!0&&y!==i.prototype},"isBuffer"),i.compare=I(function(y,E){if(ke(y,Uint8Array)&&(y=i.from(y,y.offset,y.byteLength)),ke(E,Uint8Array)&&(E=i.from(E,E.offset,E.byteLength)),!i.isBuffer(y)||!i.isBuffer(E))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(y===E)return 0;let A=y.length,j=E.length;for(let q=0,V=Math.min(A,j);q<V;++q)if(y[q]!==E[q]){A=y[q],j=E[q];break}return A<j?-1:j<A?1:0},"compare"),i.isEncoding=I(function(y){switch(String(y).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},"isEncoding"),i.concat=I(function(y,E){if(!Array.isArray(y))throw new TypeError('"list" argument must be an Array of Buffers');if(y.length===0)return i.alloc(0);let A;if(E===void 0)for(E=0,A=0;A<y.length;++A)E+=y[A].length;let j=i.allocUnsafe(E),q=0;for(A=0;A<y.length;++A){let V=y[A];if(ke(V,Uint8Array))q+V.length>j.length?(i.isBuffer(V)||(V=i.from(V)),V.copy(j,q)):Uint8Array.prototype.set.call(j,V,q);else if(i.isBuffer(V))V.copy(j,q);else throw new TypeError('"list" argument must be an Array of Buffers');q+=V.length}return j},"concat");function v(y,E){if(i.isBuffer(y))return y.length;if(ArrayBuffer.isView(y)||ke(y,ArrayBuffer))return y.byteLength;if(typeof y!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof y);let A=y.length,j=arguments.length>2&&arguments[2]===!0;if(!j&&A===0)return 0;let q=!1;for(;;)switch(E){case"ascii":case"latin1":case"binary":return A;case"utf8":case"utf-8":return st(y).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A*2;case"hex":return A>>>1;case"base64":return Mt(y).length;default:if(q)return j?-1:st(y).length;E=(""+E).toLowerCase(),q=!0}}I(v,"byteLength"),i.byteLength=v;function C(y,E,A){let j=!1;if((E===void 0||E<0)&&(E=0),E>this.length||((A===void 0||A>this.length)&&(A=this.length),A<=0)||(A>>>=0,E>>>=0,A<=E))return"";for(y||(y="utf8");;)switch(y){case"hex":return Q(this,E,A);case"utf8":case"utf-8":return L(this,E,A);case"ascii":return W(this,E,A);case"latin1":case"binary":return H(this,E,A);case"base64":return M(this,E,A);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ce(this,E,A);default:if(j)throw new TypeError("Unknown encoding: "+y);y=(y+"").toLowerCase(),j=!0}}I(C,"slowToString"),i.prototype._isBuffer=!0;function T(y,E,A){let j=y[E];y[E]=y[A],y[A]=j}I(T,"swap"),i.prototype.swap16=I(function(){let y=this.length;if(y%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let E=0;E<y;E+=2)T(this,E,E+1);return this},"swap16"),i.prototype.swap32=I(function(){let y=this.length;if(y%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let E=0;E<y;E+=4)T(this,E,E+3),T(this,E+1,E+2);return this},"swap32"),i.prototype.swap64=I(function(){let y=this.length;if(y%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let E=0;E<y;E+=8)T(this,E,E+7),T(this,E+1,E+6),T(this,E+2,E+5),T(this,E+3,E+4);return this},"swap64"),i.prototype.toString=I(function(){let y=this.length;return y===0?"":arguments.length===0?L(this,0,y):C.apply(this,arguments)},"toString"),i.prototype.toLocaleString=i.prototype.toString,i.prototype.equals=I(function(y){if(!i.isBuffer(y))throw new TypeError("Argument must be a Buffer");return this===y?!0:i.compare(this,y)===0},"equals"),i.prototype.inspect=I(function(){let y="",E=s.INSPECT_MAX_BYTES;return y=this.toString("hex",0,E).replace(/(.{2})/g,"$1 ").trim(),this.length>E&&(y+=" ... "),"<Buffer "+y+">"},"inspect"),r&&(i.prototype[r]=i.prototype.inspect),i.prototype.compare=I(function(y,E,A,j,q){if(ke(y,Uint8Array)&&(y=i.from(y,y.offset,y.byteLength)),!i.isBuffer(y))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof y);if(E===void 0&&(E=0),A===void 0&&(A=y?y.length:0),j===void 0&&(j=0),q===void 0&&(q=this.length),E<0||A>y.length||j<0||q>this.length)throw new RangeError("out of range index");if(j>=q&&E>=A)return 0;if(j>=q)return-1;if(E>=A)return 1;if(E>>>=0,A>>>=0,j>>>=0,q>>>=0,this===y)return 0;let V=q-j,J=A-E,Se=Math.min(V,J),Re=this.slice(j,q),Ae=y.slice(E,A);for(let Ee=0;Ee<Se;++Ee)if(Re[Ee]!==Ae[Ee]){V=Re[Ee],J=Ae[Ee];break}return V<J?-1:J<V?1:0},"compare");function x(y,E,A,j,q){if(y.length===0)return-1;if(typeof A=="string"?(j=A,A=0):A>2147483647?A=2147483647:A<-2147483648&&(A=-2147483648),A=+A,Be(A)&&(A=q?0:y.length-1),A<0&&(A=y.length+A),A>=y.length){if(q)return-1;A=y.length-1}else if(A<0)if(q)A=0;else return-1;if(typeof E=="string"&&(E=i.from(E,j)),i.isBuffer(E))return E.length===0?-1:R(y,E,A,j,q);if(typeof E=="number")return E=E&255,typeof Uint8Array.prototype.indexOf=="function"?q?Uint8Array.prototype.indexOf.call(y,E,A):Uint8Array.prototype.lastIndexOf.call(y,E,A):R(y,[E],A,j,q);throw new TypeError("val must be string, number or Buffer")}I(x,"bidirectionalIndexOf");function R(y,E,A,j,q){let V=1,J=y.length,Se=E.length;if(j!==void 0&&(j=String(j).toLowerCase(),j==="ucs2"||j==="ucs-2"||j==="utf16le"||j==="utf-16le")){if(y.length<2||E.length<2)return-1;V=2,J/=2,Se/=2,A/=2}function Re(Ee,Ie){return V===1?Ee[Ie]:Ee.readUInt16BE(Ie*V)}I(Re,"read");let Ae;if(q){let Ee=-1;for(Ae=A;Ae<J;Ae++)if(Re(y,Ae)===Re(E,Ee===-1?0:Ae-Ee)){if(Ee===-1&&(Ee=Ae),Ae-Ee+1===Se)return Ee*V}else Ee!==-1&&(Ae-=Ae-Ee),Ee=-1}else for(A+Se>J&&(A=J-Se),Ae=A;Ae>=0;Ae--){let Ee=!0;for(let Ie=0;Ie<Se;Ie++)if(Re(y,Ae+Ie)!==Re(E,Ie)){Ee=!1;break}if(Ee)return Ae}return-1}I(R,"arrayIndexOf"),i.prototype.includes=I(function(y,E,A){return this.indexOf(y,E,A)!==-1},"includes"),i.prototype.indexOf=I(function(y,E,A){return x(this,y,E,A,!0)},"indexOf"),i.prototype.lastIndexOf=I(function(y,E,A){return x(this,y,E,A,!1)},"lastIndexOf");function k(y,E,A,j){A=Number(A)||0;let q=y.length-A;j?(j=Number(j),j>q&&(j=q)):j=q;let V=E.length;j>V/2&&(j=V/2);let J;for(J=0;J<j;++J){let Se=parseInt(E.substr(J*2,2),16);if(Be(Se))return J;y[A+J]=Se}return J}I(k,"hexWrite");function P(y,E,A,j){return he(st(E,y.length-A),y,A,j)}I(P,"utf8Write");function O(y,E,A,j){return he(Qe(E),y,A,j)}I(O,"asciiWrite");function N(y,E,A,j){return he(Mt(E),y,A,j)}I(N,"base64Write");function $(y,E,A,j){return he(mr(E,y.length-A),y,A,j)}I($,"ucs2Write"),i.prototype.write=I(function(y,E,A,j){if(E===void 0)j="utf8",A=this.length,E=0;else if(A===void 0&&typeof E=="string")j=E,A=this.length,E=0;else if(isFinite(E))E=E>>>0,isFinite(A)?(A=A>>>0,j===void 0&&(j="utf8")):(j=A,A=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let q=this.length-E;if((A===void 0||A>q)&&(A=q),y.length>0&&(A<0||E<0)||E>this.length)throw new RangeError("Attempt to write outside buffer bounds");j||(j="utf8");let V=!1;for(;;)switch(j){case"hex":return k(this,y,E,A);case"utf8":case"utf-8":return P(this,y,E,A);case"ascii":case"latin1":case"binary":return O(this,y,E,A);case"base64":return N(this,y,E,A);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return $(this,y,E,A);default:if(V)throw new TypeError("Unknown encoding: "+j);j=(""+j).toLowerCase(),V=!0}},"write"),i.prototype.toJSON=I(function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},"toJSON");function M(y,E,A){return E===0&&A===y.length?e.fromByteArray(y):e.fromByteArray(y.slice(E,A))}I(M,"base64Slice");function L(y,E,A){A=Math.min(y.length,A);let j=[],q=E;for(;q<A;){let V=y[q],J=null,Se=V>239?4:V>223?3:V>191?2:1;if(q+Se<=A){let Re,Ae,Ee,Ie;switch(Se){case 1:V<128&&(J=V);break;case 2:Re=y[q+1],(Re&192)===128&&(Ie=(V&31)<<6|Re&63,Ie>127&&(J=Ie));break;case 3:Re=y[q+1],Ae=y[q+2],(Re&192)===128&&(Ae&192)===128&&(Ie=(V&15)<<12|(Re&63)<<6|Ae&63,Ie>2047&&(Ie<55296||Ie>57343)&&(J=Ie));break;case 4:Re=y[q+1],Ae=y[q+2],Ee=y[q+3],(Re&192)===128&&(Ae&192)===128&&(Ee&192)===128&&(Ie=(V&15)<<18|(Re&63)<<12|(Ae&63)<<6|Ee&63,Ie>65535&&Ie<1114112&&(J=Ie))}}J===null?(J=65533,Se=1):J>65535&&(J-=65536,j.push(J>>>10&1023|55296),J=56320|J&1023),j.push(J),q+=Se}return U(j)}I(L,"utf8Slice");var B=4096;function U(y){let E=y.length;if(E<=B)return String.fromCharCode.apply(String,y);let A="",j=0;for(;j<E;)A+=String.fromCharCode.apply(String,y.slice(j,j+=B));return A}I(U,"decodeCodePointsArray");function W(y,E,A){let j="";A=Math.min(y.length,A);for(let q=E;q<A;++q)j+=String.fromCharCode(y[q]&127);return j}I(W,"asciiSlice");function H(y,E,A){let j="";A=Math.min(y.length,A);for(let q=E;q<A;++q)j+=String.fromCharCode(y[q]);return j}I(H,"latin1Slice");function Q(y,E,A){let j=y.length;(!E||E<0)&&(E=0),(!A||A<0||A>j)&&(A=j);let q="";for(let V=E;V<A;++V)q+=yl[y[V]];return q}I(Q,"hexSlice");function ce(y,E,A){let j=y.slice(E,A),q="";for(let V=0;V<j.length-1;V+=2)q+=String.fromCharCode(j[V]+j[V+1]*256);return q}I(ce,"utf16leSlice"),i.prototype.slice=I(function(y,E){let A=this.length;y=~~y,E=E===void 0?A:~~E,y<0?(y+=A,y<0&&(y=0)):y>A&&(y=A),E<0?(E+=A,E<0&&(E=0)):E>A&&(E=A),E<y&&(E=y);let j=this.subarray(y,E);return Object.setPrototypeOf(j,i.prototype),j},"slice");function X(y,E,A){if(y%1!==0||y<0)throw new RangeError("offset is not uint");if(y+E>A)throw new RangeError("Trying to access beyond buffer length")}I(X,"checkOffset"),i.prototype.readUintLE=i.prototype.readUIntLE=I(function(y,E,A){y=y>>>0,E=E>>>0,A||X(y,E,this.length);let j=this[y],q=1,V=0;for(;++V<E&&(q*=256);)j+=this[y+V]*q;return j},"readUIntLE"),i.prototype.readUintBE=i.prototype.readUIntBE=I(function(y,E,A){y=y>>>0,E=E>>>0,A||X(y,E,this.length);let j=this[y+--E],q=1;for(;E>0&&(q*=256);)j+=this[y+--E]*q;return j},"readUIntBE"),i.prototype.readUint8=i.prototype.readUInt8=I(function(y,E){return y=y>>>0,E||X(y,1,this.length),this[y]},"readUInt8"),i.prototype.readUint16LE=i.prototype.readUInt16LE=I(function(y,E){return y=y>>>0,E||X(y,2,this.length),this[y]|this[y+1]<<8},"readUInt16LE"),i.prototype.readUint16BE=i.prototype.readUInt16BE=I(function(y,E){return y=y>>>0,E||X(y,2,this.length),this[y]<<8|this[y+1]},"readUInt16BE"),i.prototype.readUint32LE=i.prototype.readUInt32LE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),(this[y]|this[y+1]<<8|this[y+2]<<16)+this[y+3]*16777216},"readUInt32LE"),i.prototype.readUint32BE=i.prototype.readUInt32BE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),this[y]*16777216+(this[y+1]<<16|this[y+2]<<8|this[y+3])},"readUInt32BE"),i.prototype.readBigUInt64LE=lt(I(function(y){y=y>>>0,G(y,"offset");let E=this[y],A=this[y+7];(E===void 0||A===void 0)&&de(y,this.length-8);let j=E+this[++y]*2**8+this[++y]*2**16+this[++y]*2**24,q=this[++y]+this[++y]*2**8+this[++y]*2**16+A*2**24;return BigInt(j)+(BigInt(q)<<BigInt(32))},"readBigUInt64LE")),i.prototype.readBigUInt64BE=lt(I(function(y){y=y>>>0,G(y,"offset");let E=this[y],A=this[y+7];(E===void 0||A===void 0)&&de(y,this.length-8);let j=E*2**24+this[++y]*2**16+this[++y]*2**8+this[++y],q=this[++y]*2**24+this[++y]*2**16+this[++y]*2**8+A;return(BigInt(j)<<BigInt(32))+BigInt(q)},"readBigUInt64BE")),i.prototype.readIntLE=I(function(y,E,A){y=y>>>0,E=E>>>0,A||X(y,E,this.length);let j=this[y],q=1,V=0;for(;++V<E&&(q*=256);)j+=this[y+V]*q;return q*=128,j>=q&&(j-=Math.pow(2,8*E)),j},"readIntLE"),i.prototype.readIntBE=I(function(y,E,A){y=y>>>0,E=E>>>0,A||X(y,E,this.length);let j=E,q=1,V=this[y+--j];for(;j>0&&(q*=256);)V+=this[y+--j]*q;return q*=128,V>=q&&(V-=Math.pow(2,8*E)),V},"readIntBE"),i.prototype.readInt8=I(function(y,E){return y=y>>>0,E||X(y,1,this.length),this[y]&128?(255-this[y]+1)*-1:this[y]},"readInt8"),i.prototype.readInt16LE=I(function(y,E){y=y>>>0,E||X(y,2,this.length);let A=this[y]|this[y+1]<<8;return A&32768?A|4294901760:A},"readInt16LE"),i.prototype.readInt16BE=I(function(y,E){y=y>>>0,E||X(y,2,this.length);let A=this[y+1]|this[y]<<8;return A&32768?A|4294901760:A},"readInt16BE"),i.prototype.readInt32LE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),this[y]|this[y+1]<<8|this[y+2]<<16|this[y+3]<<24},"readInt32LE"),i.prototype.readInt32BE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),this[y]<<24|this[y+1]<<16|this[y+2]<<8|this[y+3]},"readInt32BE"),i.prototype.readBigInt64LE=lt(I(function(y){y=y>>>0,G(y,"offset");let E=this[y],A=this[y+7];(E===void 0||A===void 0)&&de(y,this.length-8);let j=this[y+4]+this[y+5]*2**8+this[y+6]*2**16+(A<<24);return(BigInt(j)<<BigInt(32))+BigInt(E+this[++y]*2**8+this[++y]*2**16+this[++y]*2**24)},"readBigInt64LE")),i.prototype.readBigInt64BE=lt(I(function(y){y=y>>>0,G(y,"offset");let E=this[y],A=this[y+7];(E===void 0||A===void 0)&&de(y,this.length-8);let j=(E<<24)+this[++y]*2**16+this[++y]*2**8+this[++y];return(BigInt(j)<<BigInt(32))+BigInt(this[++y]*2**24+this[++y]*2**16+this[++y]*2**8+A)},"readBigInt64BE")),i.prototype.readFloatLE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),t.read(this,y,!0,23,4)},"readFloatLE"),i.prototype.readFloatBE=I(function(y,E){return y=y>>>0,E||X(y,4,this.length),t.read(this,y,!1,23,4)},"readFloatBE"),i.prototype.readDoubleLE=I(function(y,E){return y=y>>>0,E||X(y,8,this.length),t.read(this,y,!0,52,8)},"readDoubleLE"),i.prototype.readDoubleBE=I(function(y,E){return y=y>>>0,E||X(y,8,this.length),t.read(this,y,!1,52,8)},"readDoubleBE");function re(y,E,A,j,q,V){if(!i.isBuffer(y))throw new TypeError('"buffer" argument must be a Buffer instance');if(E>q||E<V)throw new RangeError('"value" argument is out of bounds');if(A+j>y.length)throw new RangeError("Index out of range")}I(re,"checkInt"),i.prototype.writeUintLE=i.prototype.writeUIntLE=I(function(y,E,A,j){if(y=+y,E=E>>>0,A=A>>>0,!j){let J=Math.pow(2,8*A)-1;re(this,y,E,A,J,0)}let q=1,V=0;for(this[E]=y&255;++V<A&&(q*=256);)this[E+V]=y/q&255;return E+A},"writeUIntLE"),i.prototype.writeUintBE=i.prototype.writeUIntBE=I(function(y,E,A,j){if(y=+y,E=E>>>0,A=A>>>0,!j){let J=Math.pow(2,8*A)-1;re(this,y,E,A,J,0)}let q=A-1,V=1;for(this[E+q]=y&255;--q>=0&&(V*=256);)this[E+q]=y/V&255;return E+A},"writeUIntBE"),i.prototype.writeUint8=i.prototype.writeUInt8=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,1,255,0),this[E]=y&255,E+1},"writeUInt8"),i.prototype.writeUint16LE=i.prototype.writeUInt16LE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,2,65535,0),this[E]=y&255,this[E+1]=y>>>8,E+2},"writeUInt16LE"),i.prototype.writeUint16BE=i.prototype.writeUInt16BE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,2,65535,0),this[E]=y>>>8,this[E+1]=y&255,E+2},"writeUInt16BE"),i.prototype.writeUint32LE=i.prototype.writeUInt32LE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,4,4294967295,0),this[E+3]=y>>>24,this[E+2]=y>>>16,this[E+1]=y>>>8,this[E]=y&255,E+4},"writeUInt32LE"),i.prototype.writeUint32BE=i.prototype.writeUInt32BE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,4,4294967295,0),this[E]=y>>>24,this[E+1]=y>>>16,this[E+2]=y>>>8,this[E+3]=y&255,E+4},"writeUInt32BE");function _e(y,E,A,j,q){hr(E,j,q,y,A,7);let V=Number(E&BigInt(4294967295));y[A++]=V,V=V>>8,y[A++]=V,V=V>>8,y[A++]=V,V=V>>8,y[A++]=V;let J=Number(E>>BigInt(32)&BigInt(4294967295));return y[A++]=J,J=J>>8,y[A++]=J,J=J>>8,y[A++]=J,J=J>>8,y[A++]=J,A}I(_e,"wrtBigUInt64LE");function le(y,E,A,j,q){hr(E,j,q,y,A,7);let V=Number(E&BigInt(4294967295));y[A+7]=V,V=V>>8,y[A+6]=V,V=V>>8,y[A+5]=V,V=V>>8,y[A+4]=V;let J=Number(E>>BigInt(32)&BigInt(4294967295));return y[A+3]=J,J=J>>8,y[A+2]=J,J=J>>8,y[A+1]=J,J=J>>8,y[A]=J,A+8}I(le,"wrtBigUInt64BE"),i.prototype.writeBigUInt64LE=lt(I(function(y,E=0){return _e(this,y,E,BigInt(0),BigInt("0xffffffffffffffff"))},"writeBigUInt64LE")),i.prototype.writeBigUInt64BE=lt(I(function(y,E=0){return le(this,y,E,BigInt(0),BigInt("0xffffffffffffffff"))},"writeBigUInt64BE")),i.prototype.writeIntLE=I(function(y,E,A,j){if(y=+y,E=E>>>0,!j){let Se=Math.pow(2,8*A-1);re(this,y,E,A,Se-1,-Se)}let q=0,V=1,J=0;for(this[E]=y&255;++q<A&&(V*=256);)y<0&&J===0&&this[E+q-1]!==0&&(J=1),this[E+q]=(y/V>>0)-J&255;return E+A},"writeIntLE"),i.prototype.writeIntBE=I(function(y,E,A,j){if(y=+y,E=E>>>0,!j){let Se=Math.pow(2,8*A-1);re(this,y,E,A,Se-1,-Se)}let q=A-1,V=1,J=0;for(this[E+q]=y&255;--q>=0&&(V*=256);)y<0&&J===0&&this[E+q+1]!==0&&(J=1),this[E+q]=(y/V>>0)-J&255;return E+A},"writeIntBE"),i.prototype.writeInt8=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,1,127,-128),y<0&&(y=255+y+1),this[E]=y&255,E+1},"writeInt8"),i.prototype.writeInt16LE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,2,32767,-32768),this[E]=y&255,this[E+1]=y>>>8,E+2},"writeInt16LE"),i.prototype.writeInt16BE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,2,32767,-32768),this[E]=y>>>8,this[E+1]=y&255,E+2},"writeInt16BE"),i.prototype.writeInt32LE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,4,2147483647,-2147483648),this[E]=y&255,this[E+1]=y>>>8,this[E+2]=y>>>16,this[E+3]=y>>>24,E+4},"writeInt32LE"),i.prototype.writeInt32BE=I(function(y,E,A){return y=+y,E=E>>>0,A||re(this,y,E,4,2147483647,-2147483648),y<0&&(y=4294967295+y+1),this[E]=y>>>24,this[E+1]=y>>>16,this[E+2]=y>>>8,this[E+3]=y&255,E+4},"writeInt32BE"),i.prototype.writeBigInt64LE=lt(I(function(y,E=0){return _e(this,y,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))},"writeBigInt64LE")),i.prototype.writeBigInt64BE=lt(I(function(y,E=0){return le(this,y,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))},"writeBigInt64BE"));function ve(y,E,A,j,q,V){if(A+j>y.length)throw new RangeError("Index out of range");if(A<0)throw new RangeError("Index out of range")}I(ve,"checkIEEE754");function Pe(y,E,A,j,q){return E=+E,A=A>>>0,q||ve(y,E,A,4),t.write(y,E,A,j,23,4),A+4}I(Pe,"writeFloat"),i.prototype.writeFloatLE=I(function(y,E,A){return Pe(this,y,E,!0,A)},"writeFloatLE"),i.prototype.writeFloatBE=I(function(y,E,A){return Pe(this,y,E,!1,A)},"writeFloatBE");function Xe(y,E,A,j,q){return E=+E,A=A>>>0,q||ve(y,E,A,8),t.write(y,E,A,j,52,8),A+8}I(Xe,"writeDouble"),i.prototype.writeDoubleLE=I(function(y,E,A){return Xe(this,y,E,!0,A)},"writeDoubleLE"),i.prototype.writeDoubleBE=I(function(y,E,A){return Xe(this,y,E,!1,A)},"writeDoubleBE"),i.prototype.copy=I(function(y,E,A,j){if(!i.isBuffer(y))throw new TypeError("argument should be a Buffer");if(A||(A=0),!j&&j!==0&&(j=this.length),E>=y.length&&(E=y.length),E||(E=0),j>0&&j<A&&(j=A),j===A||y.length===0||this.length===0)return 0;if(E<0)throw new RangeError("targetStart out of bounds");if(A<0||A>=this.length)throw new RangeError("Index out of range");if(j<0)throw new RangeError("sourceEnd out of bounds");j>this.length&&(j=this.length),y.length-E<j-A&&(j=y.length-E+A);let q=j-A;return this===y&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(E,A,j):Uint8Array.prototype.set.call(y,this.subarray(A,j),E),q},"copy"),i.prototype.fill=I(function(y,E,A,j){if(typeof y=="string"){if(typeof E=="string"?(j=E,E=0,A=this.length):typeof A=="string"&&(j=A,A=this.length),j!==void 0&&typeof j!="string")throw new TypeError("encoding must be a string");if(typeof j=="string"&&!i.isEncoding(j))throw new TypeError("Unknown encoding: "+j);if(y.length===1){let V=y.charCodeAt(0);(j==="utf8"&&V<128||j==="latin1")&&(y=V)}}else typeof y=="number"?y=y&255:typeof y=="boolean"&&(y=Number(y));if(E<0||this.length<E||this.length<A)throw new RangeError("Out of range index");if(A<=E)return this;E=E>>>0,A=A===void 0?this.length:A>>>0,y||(y=0);let q;if(typeof y=="number")for(q=E;q<A;++q)this[q]=y;else{let V=i.isBuffer(y)?y:i.from(y,j),J=V.length;if(J===0)throw new TypeError('The value "'+y+'" is invalid for argument "value"');for(q=0;q<A-E;++q)this[q+E]=V[q%J]}return this},"fill");var $e={};function $t(y,E,A){var j;$e[y]=(j=class extends A{constructor(){super(),Object.defineProperty(this,"message",{value:E.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${y}]`,this.stack,delete this.name}get code(){return y}set code(q){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:q,writable:!0})}toString(){return`${this.name} [${y}]: ${this.message}`}},I(j,"NodeError"),j)}I($t,"E"),$t("ERR_BUFFER_OUT_OF_BOUNDS",function(y){return y?`${y} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),$t("ERR_INVALID_ARG_TYPE",function(y,E){return`The "${y}" argument must be of type number. Received type ${typeof E}`},TypeError),$t("ERR_OUT_OF_RANGE",function(y,E,A){let j=`The value of "${y}" is out of range.`,q=A;return Number.isInteger(A)&&Math.abs(A)>2**32?q=dr(String(A)):typeof A=="bigint"&&(q=String(A),(A>BigInt(2)**BigInt(32)||A<-(BigInt(2)**BigInt(32)))&&(q=dr(q)),q+="n"),j+=` It must be ${E}. Received ${q}`,j},RangeError);function dr(y){let E="",A=y.length,j=y[0]==="-"?1:0;for(;A>=j+4;A-=3)E=`_${y.slice(A-3,A)}${E}`;return`${y.slice(0,A)}${E}`}I(dr,"addNumericalSeparator");function Vr(y,E,A){G(E,"offset"),(y[E]===void 0||y[E+A]===void 0)&&de(E,y.length-(A+1))}I(Vr,"checkBounds");function hr(y,E,A,j,q,V){if(y>A||y<E){let J=typeof E=="bigint"?"n":"",Se;throw V>3?E===0||E===BigInt(0)?Se=`>= 0${J} and < 2${J} ** ${(V+1)*8}${J}`:Se=`>= -(2${J} ** ${(V+1)*8-1}${J}) and < 2 ** ${(V+1)*8-1}${J}`:Se=`>= ${E}${J} and <= ${A}${J}`,new $e.ERR_OUT_OF_RANGE("value",Se,y)}Vr(j,q,V)}I(hr,"checkIntBI");function G(y,E){if(typeof y!="number")throw new $e.ERR_INVALID_ARG_TYPE(E,"number",y)}I(G,"validateNumber");function de(y,E,A){throw Math.floor(y)!==y?(G(y,A),new $e.ERR_OUT_OF_RANGE(A||"offset","an integer",y)):E<0?new $e.ERR_BUFFER_OUT_OF_BOUNDS:new $e.ERR_OUT_OF_RANGE(A||"offset",`>= ${A?1:0} and <= ${E}`,y)}I(de,"boundsError");var be=/[^+/0-9A-Za-z-_]/g;function ye(y){if(y=y.split("=")[0],y=y.trim().replace(be,""),y.length<2)return"";for(;y.length%4!==0;)y=y+"=";return y}I(ye,"base64clean");function st(y,E){E=E||1/0;let A,j=y.length,q=null,V=[];for(let J=0;J<j;++J){if(A=y.charCodeAt(J),A>55295&&A<57344){if(!q){if(A>56319){(E-=3)>-1&&V.push(239,191,189);continue}else if(J+1===j){(E-=3)>-1&&V.push(239,191,189);continue}q=A;continue}if(A<56320){(E-=3)>-1&&V.push(239,191,189),q=A;continue}A=(q-55296<<10|A-56320)+65536}else q&&(E-=3)>-1&&V.push(239,191,189);if(q=null,A<128){if((E-=1)<0)break;V.push(A)}else if(A<2048){if((E-=2)<0)break;V.push(A>>6|192,A&63|128)}else if(A<65536){if((E-=3)<0)break;V.push(A>>12|224,A>>6&63|128,A&63|128)}else if(A<1114112){if((E-=4)<0)break;V.push(A>>18|240,A>>12&63|128,A>>6&63|128,A&63|128)}else throw new Error("Invalid code point")}return V}I(st,"utf8ToBytes");function Qe(y){let E=[];for(let A=0;A<y.length;++A)E.push(y.charCodeAt(A)&255);return E}I(Qe,"asciiToBytes");function mr(y,E){let A,j,q,V=[];for(let J=0;J<y.length&&!((E-=2)<0);++J)A=y.charCodeAt(J),j=A>>8,q=A%256,V.push(q),V.push(j);return V}I(mr,"utf16leToBytes");function Mt(y){return e.toByteArray(ye(y))}I(Mt,"base64ToBytes");function he(y,E,A,j){let q;for(q=0;q<j&&!(q+A>=E.length||q>=y.length);++q)E[q+A]=y[q];return q}I(he,"blitBuffer");function ke(y,E){return y instanceof E||y!=null&&y.constructor!=null&&y.constructor.name!=null&&y.constructor.name===E.name}I(ke,"isInstance");function Be(y){return y!==y}I(Be,"numberIsNaN");var yl=function(){let y="0123456789abcdef",E=new Array(256);for(let A=0;A<16;++A){let j=A*16;for(let q=0;q<16;++q)E[j+q]=y[A]+y[q]}return E}();function lt(y){return typeof BigInt>"u"?wn:y}I(lt,"defineBigIntMethod");function wn(){throw new Error("BigInt not supported")}I(wn,"BufferBigIntNotDefined")}),bs,Ua,se,oe,Z=Ve(()=>{bs=globalThis,Ua=globalThis.setImmediate??(s=>setTimeout(s,0)),se=typeof globalThis.Buffer=="function"&&typeof globalThis.Buffer.allocUnsafe=="function"?globalThis.Buffer:Jl().Buffer,oe=globalThis.process??{},oe.env??(oe.env={});try{oe.nextTick(()=>{})}catch{let s=Promise.resolve();oe.nextTick=s.then.bind(s)}}),Nt=ie((s,e)=>{Z();var t=typeof Reflect=="object"?Reflect:null,r=t&&typeof t.apply=="function"?t.apply:I(function(x,R,k){return Function.prototype.apply.call(x,R,k)},"ReflectApply"),a;t&&typeof t.ownKeys=="function"?a=t.ownKeys:Object.getOwnPropertySymbols?a=I(function(x){return Object.getOwnPropertyNames(x).concat(Object.getOwnPropertySymbols(x))},"ReflectOwnKeys"):a=I(function(x){return Object.getOwnPropertyNames(x)},"ReflectOwnKeys");function n(x){console&&console.warn&&console.warn(x)}I(n,"ProcessEmitWarning");var o=Number.isNaN||I(function(x){return x!==x},"NumberIsNaN");function i(){i.init.call(this)}I(i,"EventEmitter"),e.exports=i,e.exports.once=v,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var c=10;function l(x){if(typeof x!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof x)}I(l,"checkListener"),Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:I(function(){return c},"get"),set:I(function(x){if(typeof x!="number"||x<0||o(x))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+x+".");c=x},"set")}),i.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=I(function(x){if(typeof x!="number"||x<0||o(x))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+x+".");return this._maxListeners=x,this},"setMaxListeners");function d(x){return x._maxListeners===void 0?i.defaultMaxListeners:x._maxListeners}I(d,"_getMaxListeners"),i.prototype.getMaxListeners=I(function(){return d(this)},"getMaxListeners"),i.prototype.emit=I(function(x){for(var R=[],k=1;k<arguments.length;k++)R.push(arguments[k]);var P=x==="error",O=this._events;if(O!==void 0)P=P&&O.error===void 0;else if(!P)return!1;if(P){var N;if(R.length>0&&(N=R[0]),N instanceof Error)throw N;var $=new Error("Unhandled error."+(N?" ("+N.message+")":""));throw $.context=N,$}var M=O[x];if(M===void 0)return!1;if(typeof M=="function")r(M,this,R);else for(var L=M.length,B=_(M,L),k=0;k<L;++k)r(B[k],this,R);return!0},"emit");function u(x,R,k,P){var O,N,$;if(l(k),N=x._events,N===void 0?(N=x._events=Object.create(null),x._eventsCount=0):(N.newListener!==void 0&&(x.emit("newListener",R,k.listener?k.listener:k),N=x._events),$=N[R]),$===void 0)$=N[R]=k,++x._eventsCount;else if(typeof $=="function"?$=N[R]=P?[k,$]:[$,k]:P?$.unshift(k):$.push(k),O=d(x),O>0&&$.length>O&&!$.warned){$.warned=!0;var M=new Error("Possible EventEmitter memory leak detected. "+$.length+" "+String(R)+" listeners added. Use emitter.setMaxListeners() to increase limit");M.name="MaxListenersExceededWarning",M.emitter=x,M.type=R,M.count=$.length,n(M)}return x}I(u,"_addListener"),i.prototype.addListener=I(function(x,R){return u(this,x,R,!1)},"addListener"),i.prototype.on=i.prototype.addListener,i.prototype.prependListener=I(function(x,R){return u(this,x,R,!0)},"prependListener");function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}I(h,"onceWrapper");function g(x,R,k){var P={fired:!1,wrapFn:void 0,target:x,type:R,listener:k},O=h.bind(P);return O.listener=k,P.wrapFn=O,O}I(g,"_onceWrap"),i.prototype.once=I(function(x,R){return l(R),this.on(x,g(this,x,R)),this},"once"),i.prototype.prependOnceListener=I(function(x,R){return l(R),this.prependListener(x,g(this,x,R)),this},"prependOnceListener"),i.prototype.removeListener=I(function(x,R){var k,P,O,N,$;if(l(R),P=this._events,P===void 0)return this;if(k=P[x],k===void 0)return this;if(k===R||k.listener===R)--this._eventsCount===0?this._events=Object.create(null):(delete P[x],P.removeListener&&this.emit("removeListener",x,k.listener||R));else if(typeof k!="function"){for(O=-1,N=k.length-1;N>=0;N--)if(k[N]===R||k[N].listener===R){$=k[N].listener,O=N;break}if(O<0)return this;O===0?k.shift():b(k,O),k.length===1&&(P[x]=k[0]),P.removeListener!==void 0&&this.emit("removeListener",x,$||R)}return this},"removeListener"),i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=I(function(x){var R,k,P;if(k=this._events,k===void 0)return this;if(k.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):k[x]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete k[x]),this;if(arguments.length===0){var O=Object.keys(k),N;for(P=0;P<O.length;++P)N=O[P],N!=="removeListener"&&this.removeAllListeners(N);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(R=k[x],typeof R=="function")this.removeListener(x,R);else if(R!==void 0)for(P=R.length-1;P>=0;P--)this.removeListener(x,R[P]);return this},"removeAllListeners");function p(x,R,k){var P=x._events;if(P===void 0)return[];var O=P[R];return O===void 0?[]:typeof O=="function"?k?[O.listener||O]:[O]:k?S(O):_(O,O.length)}I(p,"_listeners"),i.prototype.listeners=I(function(x){return p(this,x,!0)},"listeners"),i.prototype.rawListeners=I(function(x){return p(this,x,!1)},"rawListeners"),i.listenerCount=function(x,R){return typeof x.listenerCount=="function"?x.listenerCount(R):m.call(x,R)},i.prototype.listenerCount=m;function m(x){var R=this._events;if(R!==void 0){var k=R[x];if(typeof k=="function")return 1;if(k!==void 0)return k.length}return 0}I(m,"listenerCount"),i.prototype.eventNames=I(function(){return this._eventsCount>0?a(this._events):[]},"eventNames");function _(x,R){for(var k=new Array(R),P=0;P<R;++P)k[P]=x[P];return k}I(_,"arrayClone");function b(x,R){for(;R+1<x.length;R++)x[R]=x[R+1];x.pop()}I(b,"spliceOne");function S(x){for(var R=new Array(x.length),k=0;k<R.length;++k)R[k]=x[k].listener||x[k];return R}I(S,"unwrapListeners");function v(x,R){return new Promise(function(k,P){function O($){x.removeListener(R,N),P($)}I(O,"errorListener");function N(){typeof x.removeListener=="function"&&x.removeListener("error",O),k([].slice.call(arguments))}I(N,"resolver"),T(x,R,N,{once:!0}),R!=="error"&&C(x,O,{once:!0})})}I(v,"once");function C(x,R,k){typeof x.on=="function"&&T(x,"error",R,k)}I(C,"addErrorHandlerIfEventEmitter");function T(x,R,k,P){if(typeof x.on=="function")P.once?x.once(R,k):x.on(R,k);else if(typeof x.addEventListener=="function")x.addEventListener(R,I(function O(N){P.once&&x.removeEventListener(R,O),k(N)},"wrapListener"));else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof x)}I(T,"eventTargetAgnosticAddListener")}),jo={};et(jo,{Socket:()=>ct,isIP:()=>$o});function $o(s){return 0}var Sn,Ms,pr,ct,Tr=Ve(()=>{"use strict";Z(),Sn=Ot(Nt(),1),I($o,"isIP"),Ms=/^[^.]+\./,pr=class ee extends Sn.EventEmitter{constructor(){super(...arguments),ae(this,"opts",{}),ae(this,"connecting",!1),ae(this,"pending",!0),ae(this,"writable",!0),ae(this,"encrypted",!1),ae(this,"authorized",!1),ae(this,"destroyed",!1),ae(this,"ws",null),ae(this,"writeBuffer"),ae(this,"tlsState",0),ae(this,"tlsRead"),ae(this,"tlsWrite")}static get poolQueryViaFetch(){return ee.opts.poolQueryViaFetch??ee.defaults.poolQueryViaFetch}static set poolQueryViaFetch(e){ee.opts.poolQueryViaFetch=e}static get fetchEndpoint(){return ee.opts.fetchEndpoint??ee.defaults.fetchEndpoint}static set fetchEndpoint(e){ee.opts.fetchEndpoint=e}static get fetchConnectionCache(){return!0}static set fetchConnectionCache(e){console.warn("The `fetchConnectionCache` option is deprecated (now always `true`)")}static get fetchFunction(){return ee.opts.fetchFunction??ee.defaults.fetchFunction}static set fetchFunction(e){ee.opts.fetchFunction=e}static get webSocketConstructor(){return ee.opts.webSocketConstructor??ee.defaults.webSocketConstructor}static set webSocketConstructor(e){ee.opts.webSocketConstructor=e}get webSocketConstructor(){return this.opts.webSocketConstructor??ee.webSocketConstructor}set webSocketConstructor(e){this.opts.webSocketConstructor=e}static get wsProxy(){return ee.opts.wsProxy??ee.defaults.wsProxy}static set wsProxy(e){ee.opts.wsProxy=e}get wsProxy(){return this.opts.wsProxy??ee.wsProxy}set wsProxy(e){this.opts.wsProxy=e}static get coalesceWrites(){return ee.opts.coalesceWrites??ee.defaults.coalesceWrites}static set coalesceWrites(e){ee.opts.coalesceWrites=e}get coalesceWrites(){return this.opts.coalesceWrites??ee.coalesceWrites}set coalesceWrites(e){this.opts.coalesceWrites=e}static get useSecureWebSocket(){return ee.opts.useSecureWebSocket??ee.defaults.useSecureWebSocket}static set useSecureWebSocket(e){ee.opts.useSecureWebSocket=e}get useSecureWebSocket(){return this.opts.useSecureWebSocket??ee.useSecureWebSocket}set useSecureWebSocket(e){this.opts.useSecureWebSocket=e}static get forceDisablePgSSL(){return ee.opts.forceDisablePgSSL??ee.defaults.forceDisablePgSSL}static set forceDisablePgSSL(e){ee.opts.forceDisablePgSSL=e}get forceDisablePgSSL(){return this.opts.forceDisablePgSSL??ee.forceDisablePgSSL}set forceDisablePgSSL(e){this.opts.forceDisablePgSSL=e}static get disableSNI(){return ee.opts.disableSNI??ee.defaults.disableSNI}static set disableSNI(e){ee.opts.disableSNI=e}get disableSNI(){return this.opts.disableSNI??ee.disableSNI}set disableSNI(e){this.opts.disableSNI=e}static get disableWarningInBrowsers(){return ee.opts.disableWarningInBrowsers??ee.defaults.disableWarningInBrowsers}static set disableWarningInBrowsers(e){ee.opts.disableWarningInBrowsers=e}get disableWarningInBrowsers(){return this.opts.disableWarningInBrowsers??ee.disableWarningInBrowsers}set disableWarningInBrowsers(e){this.opts.disableWarningInBrowsers=e}static get pipelineConnect(){return ee.opts.pipelineConnect??ee.defaults.pipelineConnect}static set pipelineConnect(e){ee.opts.pipelineConnect=e}get pipelineConnect(){return this.opts.pipelineConnect??ee.pipelineConnect}set pipelineConnect(e){this.opts.pipelineConnect=e}static get subtls(){return ee.opts.subtls??ee.defaults.subtls}static set subtls(e){ee.opts.subtls=e}get subtls(){return this.opts.subtls??ee.subtls}set subtls(e){this.opts.subtls=e}static get pipelineTLS(){return ee.opts.pipelineTLS??ee.defaults.pipelineTLS}static set pipelineTLS(e){ee.opts.pipelineTLS=e}get pipelineTLS(){return this.opts.pipelineTLS??ee.pipelineTLS}set pipelineTLS(e){this.opts.pipelineTLS=e}static get rootCerts(){return ee.opts.rootCerts??ee.defaults.rootCerts}static set rootCerts(e){ee.opts.rootCerts=e}get rootCerts(){return this.opts.rootCerts??ee.rootCerts}set rootCerts(e){this.opts.rootCerts=e}wsProxyAddrForHost(e,t){let r=this.wsProxy;if(r===void 0)throw new Error("No WebSocket proxy is configured. Please see https://github.com/neondatabase/serverless/blob/main/CONFIG.md#wsproxy-string--host-string-port-number--string--string");return typeof r=="function"?r(e,t):`${r}?address=${e}:${t}`}setNoDelay(){return this}setKeepAlive(){return this}ref(){return this}unref(){return this}connect(e,t,r){this.connecting=!0,r&&this.once("connect",r);let a=I(()=>{this.connecting=!1,this.pending=!1,this.emit("connect"),this.emit("ready")},"handleWebSocketOpen"),n=I((i,c=!1)=>{i.binaryType="arraybuffer",i.addEventListener("error",l=>{this.emit("error",l),this.emit("close")}),i.addEventListener("message",l=>{if(this.tlsState===0){let d=se.from(l.data);this.emit("data",d)}}),i.addEventListener("close",()=>{this.emit("close")}),c?a():i.addEventListener("open",a)},"configureWebSocket"),o;try{o=this.wsProxyAddrForHost(t,typeof e=="string"?parseInt(e,10):e)}catch(i){this.emit("error",i),this.emit("close");return}try{let i=(this.useSecureWebSocket?"wss:":"ws:")+"//"+o;if(this.webSocketConstructor!==void 0)this.ws=new this.webSocketConstructor(i),n(this.ws);else try{this.ws=new WebSocket(i),n(this.ws)}catch{this.ws=new __unstable_WebSocket(i),n(this.ws)}}catch(i){let c=(this.useSecureWebSocket?"https:":"http:")+"//"+o;fetch(c,{headers:{Upgrade:"websocket"}}).then(l=>{if(this.ws=l.webSocket,this.ws==null)throw i;this.ws.accept(),n(this.ws,!0)}).catch(l=>{this.emit("error",new Error(`All attempts to open a WebSocket to connect to the database failed. Please refer to https://github.com/neondatabase/serverless/blob/main/CONFIG.md#websocketconstructor-typeof-websocket--undefined. Details: ${l}`)),this.emit("close")})}}async startTls(e){if(this.subtls===void 0)throw new Error("For Postgres SSL connections, you must set `neonConfig.subtls` to the subtls library. See https://github.com/neondatabase/serverless/blob/main/CONFIG.md for more information.");this.tlsState=1;let t=await this.subtls.TrustedCert.databaseFromPEM(this.rootCerts),r=new this.subtls.WebSocketReadQueue(this.ws),a=r.read.bind(r),n=this.rawWrite.bind(this),{read:o,write:i}=await this.subtls.startTls(e,t,a,n,{useSNI:!this.disableSNI,expectPreData:this.pipelineTLS?new Uint8Array([83]):void 0});this.tlsRead=o,this.tlsWrite=i,this.tlsState=2,this.encrypted=!0,this.authorized=!0,this.emit("secureConnection",this),this.tlsReadLoop()}async tlsReadLoop(){for(;;){let e=await this.tlsRead();if(e===void 0)break;{let t=se.from(e);this.emit("data",t)}}}rawWrite(e){if(!this.coalesceWrites){this.ws&&this.ws.send(e);return}if(this.writeBuffer===void 0)this.writeBuffer=e,setTimeout(()=>{this.ws&&this.ws.send(this.writeBuffer),this.writeBuffer=void 0},0);else{let t=new Uint8Array(this.writeBuffer.length+e.length);t.set(this.writeBuffer),t.set(e,this.writeBuffer.length),this.writeBuffer=t}}write(e,t="utf8",r=a=>{}){return e.length===0?(r(),!0):(typeof e=="string"&&(e=se.from(e,t)),this.tlsState===0?(this.rawWrite(e),r()):this.tlsState===1?this.once("secureConnection",()=>{this.write(e,t,r)}):(this.tlsWrite(e),r()),!0)}end(e=se.alloc(0),t="utf8",r=()=>{}){return this.write(e,t,()=>{this.ws.close(),r()}),this}destroy(){return this.destroyed=!0,this.end()}},I(pr,"Socket"),ae(pr,"defaults",{poolQueryViaFetch:!1,fetchEndpoint:I((s,e,t)=>{let r;return t!=null&&t.jwtAuth?r=s.replace(Ms,"apiauth."):r=s.replace(Ms,"api."),"https://"+r+"/sql"},"fetchEndpoint"),fetchConnectionCache:!0,fetchFunction:void 0,webSocketConstructor:void 0,wsProxy:I(s=>s+"/v2","wsProxy"),useSecureWebSocket:!0,forceDisablePgSSL:!0,coalesceWrites:!0,pipelineConnect:"password",subtls:void 0,rootCerts:"",pipelineTLS:!1,disableSNI:!1,disableWarningInBrowsers:!1}),ae(pr,"opts",{}),ct=pr}),Mo={};et(Mo,{parse:()=>ja});function ja(s,e=!1){let{protocol:t}=new URL(s),r="http:"+s.substring(t.length),{username:a,password:n,host:o,hostname:i,port:c,pathname:l,search:d,searchParams:u,hash:h}=new URL(r);n=decodeURIComponent(n),a=decodeURIComponent(a),l=decodeURIComponent(l);let g=a+":"+n,p=e?Object.fromEntries(u.entries()):d;return{href:s,protocol:t,auth:g,username:a,password:n,host:o,hostname:i,port:c,pathname:l,search:d,query:p,hash:h}}var qo=Ve(()=>{Z(),I(ja,"parse")}),Bo=ie(s=>{Z(),s.parse=function(a,n){return new t(a,n).parse()};var e=class Fo{constructor(n,o){this.source=n,this.transform=o||r,this.position=0,this.entries=[],this.recorded=[],this.dimension=0}isEof(){return this.position>=this.source.length}nextCharacter(){var n=this.source[this.position++];return n==="\\"?{value:this.source[this.position++],escaped:!0}:{value:n,escaped:!1}}record(n){this.recorded.push(n)}newEntry(n){var o;(this.recorded.length>0||n)&&(o=this.recorded.join(""),o==="NULL"&&!n&&(o=null),o!==null&&(o=this.transform(o)),this.entries.push(o),this.recorded=[])}consumeDimensions(){if(this.source[0]==="[")for(;!this.isEof();){var n=this.nextCharacter();if(n.value==="=")break}}parse(n){var o,i,c;for(this.consumeDimensions();!this.isEof();)if(o=this.nextCharacter(),o.value==="{"&&!c)this.dimension++,this.dimension>1&&(i=new Fo(this.source.substr(this.position-1),this.transform),this.entries.push(i.parse(!0)),this.position+=i.position-2);else if(o.value==="}"&&!c){if(this.dimension--,!this.dimension&&(this.newEntry(),n))return this.entries}else o.value==='"'&&!o.escaped?(c&&this.newEntry(!0),c=!c):o.value===","&&!c?this.newEntry():this.record(o.value);if(this.dimension!==0)throw new Error("array dimension not balanced");return this.entries}};I(e,"ArrayParser");var t=e;function r(a){return a}I(r,"identity")}),zo=ie((s,e)=>{Z();var t=Bo();e.exports={create:I(function(r,a){return{parse:I(function(){return t.parse(r,a)},"parse")}},"create")}}),Yl=ie((s,e)=>{Z();var t=/(\d{1,})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.\d{1,})?.*?( BC)?$/,r=/^(\d{1,})-(\d{2})-(\d{2})( BC)?$/,a=/([Z+-])(\d{2})?:?(\d{2})?:?(\d{2})?/,n=/^-?infinity$/;e.exports=I(function(d){if(n.test(d))return Number(d.replace("i","I"));var u=t.exec(d);if(!u)return o(d)||null;var h=!!u[8],g=parseInt(u[1],10);h&&(g=c(g));var p=parseInt(u[2],10)-1,m=u[3],_=parseInt(u[4],10),b=parseInt(u[5],10),S=parseInt(u[6],10),v=u[7];v=v?1e3*parseFloat(v):0;var C,T=i(d);return T!=null?(C=new Date(Date.UTC(g,p,m,_,b,S,v)),l(g)&&C.setUTCFullYear(g),T!==0&&C.setTime(C.getTime()-T)):(C=new Date(g,p,m,_,b,S,v),l(g)&&C.setFullYear(g)),C},"parseDate");function o(d){var u=r.exec(d);if(u){var h=parseInt(u[1],10),g=!!u[4];g&&(h=c(h));var p=parseInt(u[2],10)-1,m=u[3],_=new Date(h,p,m);return l(h)&&_.setFullYear(h),_}}I(o,"getDate");function i(d){if(d.endsWith("+00"))return 0;var u=a.exec(d.split(" ")[1]);if(u){var h=u[1];if(h==="Z")return 0;var g=h==="-"?-1:1,p=parseInt(u[2],10)*3600+parseInt(u[3]||0,10)*60+parseInt(u[4]||0,10);return p*g*1e3}}I(i,"timeZoneOffset");function c(d){return-(d-1)}I(c,"bcYearToNegativeYear");function l(d){return d>=0&&d<100}I(l,"is0To99")}),Xl=ie((s,e)=>{Z(),e.exports=r;var t=Object.prototype.hasOwnProperty;function r(a){for(var n=1;n<arguments.length;n++){var o=arguments[n];for(var i in o)t.call(o,i)&&(a[i]=o[i])}return a}I(r,"extend")}),Zl=ie((s,e)=>{Z();var t=Xl();e.exports=r;function r(S){if(!(this instanceof r))return new r(S);t(this,b(S))}I(r,"PostgresInterval");var a=["seconds","minutes","hours","days","months","years"];r.prototype.toPostgres=function(){var S=a.filter(this.hasOwnProperty,this);return this.milliseconds&&S.indexOf("seconds")<0&&S.push("seconds"),S.length===0?"0":S.map(function(v){var C=this[v]||0;return v==="seconds"&&this.milliseconds&&(C=(C+this.milliseconds/1e3).toFixed(6).replace(/\.?0+$/,"")),C+" "+v},this).join(" ")};var n={years:"Y",months:"M",days:"D",hours:"H",minutes:"M",seconds:"S"},o=["years","months","days"],i=["hours","minutes","seconds"];r.prototype.toISOString=r.prototype.toISO=function(){var S=o.map(C,this).join(""),v=i.map(C,this).join("");return"P"+S+"T"+v;function C(T){var x=this[T]||0;return T==="seconds"&&this.milliseconds&&(x=(x+this.milliseconds/1e3).toFixed(6).replace(/0+$/,"")),x+n[T]}};var c="([+-]?\\d+)",l=c+"\\s+years?",d=c+"\\s+mons?",u=c+"\\s+days?",h="([+-])?([\\d]*):(\\d\\d):(\\d\\d)\\.?(\\d{1,6})?",g=new RegExp([l,d,u,h].map(function(S){return"("+S+")?"}).join("\\s*")),p={years:2,months:4,days:6,hours:9,minutes:10,seconds:11,milliseconds:12},m=["hours","minutes","seconds","milliseconds"];function _(S){var v=S+"000000".slice(S.length);return parseInt(v,10)/1e3}I(_,"parseMilliseconds");function b(S){if(!S)return{};var v=g.exec(S),C=v[8]==="-";return Object.keys(p).reduce(function(T,x){var R=p[x],k=v[R];return!k||(k=x==="milliseconds"?_(k):parseInt(k,10),!k)||(C&&~m.indexOf(x)&&(k*=-1),T[x]=k),T},{})}I(b,"parse")}),eu=ie((s,e)=>{Z(),e.exports=I(function(t){if(/^\\x/.test(t))return new se(t.substr(2),"hex");for(var r="",a=0;a<t.length;)if(t[a]!=="\\")r+=t[a],++a;else if(/[0-7]{3}/.test(t.substr(a+1,3)))r+=String.fromCharCode(parseInt(t.substr(a+1,3),8)),a+=4;else{for(var n=1;a+n<t.length&&t[a+n]==="\\";)n++;for(var o=0;o<Math.floor(n/2);++o)r+="\\";a+=Math.floor(n/2)*2}return new se(r,"binary")},"parseBytea")}),tu=ie((s,e)=>{Z();var t=Bo(),r=zo(),a=Yl(),n=Zl(),o=eu();function i(P){return I(function(O){return O===null?O:P(O)},"nullAllowed")}I(i,"allowNull");function c(P){return P===null?P:P==="TRUE"||P==="t"||P==="true"||P==="y"||P==="yes"||P==="on"||P==="1"}I(c,"parseBool");function l(P){return P?t.parse(P,c):null}I(l,"parseBoolArray");function d(P){return parseInt(P,10)}I(d,"parseBaseTenInt");function u(P){return P?t.parse(P,i(d)):null}I(u,"parseIntegerArray");function h(P){return P?t.parse(P,i(function(O){return C(O).trim()})):null}I(h,"parseBigIntegerArray");var g=I(function(P){if(!P)return null;var O=r.create(P,function(N){return N!==null&&(N=x(N)),N});return O.parse()},"parsePointArray"),p=I(function(P){if(!P)return null;var O=r.create(P,function(N){return N!==null&&(N=parseFloat(N)),N});return O.parse()},"parseFloatArray"),m=I(function(P){if(!P)return null;var O=r.create(P);return O.parse()},"parseStringArray"),_=I(function(P){if(!P)return null;var O=r.create(P,function(N){return N!==null&&(N=a(N)),N});return O.parse()},"parseDateArray"),b=I(function(P){if(!P)return null;var O=r.create(P,function(N){return N!==null&&(N=n(N)),N});return O.parse()},"parseIntervalArray"),S=I(function(P){return P?t.parse(P,i(o)):null},"parseByteAArray"),v=I(function(P){return parseInt(P,10)},"parseInteger"),C=I(function(P){var O=String(P);return/^\d+$/.test(O)?O:P},"parseBigInteger"),T=I(function(P){return P?t.parse(P,i(JSON.parse)):null},"parseJsonArray"),x=I(function(P){return P[0]!=="("?null:(P=P.substring(1,P.length-1).split(","),{x:parseFloat(P[0]),y:parseFloat(P[1])})},"parsePoint"),R=I(function(P){if(P[0]!=="<"&&P[1]!=="(")return null;for(var O="(",N="",$=!1,M=2;M<P.length-1;M++){if($||(O+=P[M]),P[M]===")"){$=!0;continue}else if(!$)continue;P[M]!==","&&(N+=P[M])}var L=x(O);return L.radius=parseFloat(N),L},"parseCircle"),k=I(function(P){P(20,C),P(21,v),P(23,v),P(26,v),P(700,parseFloat),P(701,parseFloat),P(16,c),P(1082,a),P(1114,a),P(1184,a),P(600,x),P(651,m),P(718,R),P(1e3,l),P(1001,S),P(1005,u),P(1007,u),P(1028,u),P(1016,h),P(1017,g),P(1021,p),P(1022,p),P(1231,p),P(1014,m),P(1015,m),P(1008,m),P(1009,m),P(1040,m),P(1041,m),P(1115,_),P(1182,_),P(1185,_),P(1186,n),P(1187,b),P(17,o),P(114,JSON.parse.bind(JSON)),P(3802,JSON.parse.bind(JSON)),P(199,T),P(3807,T),P(3907,m),P(2951,m),P(791,m),P(1183,m),P(1270,m)},"init");e.exports={init:k}}),ru=ie((s,e)=>{Z();var t=1e6;function r(a){var n=a.readInt32BE(0),o=a.readUInt32BE(4),i="";n<0&&(n=~n+(o===0),o=~o+1>>>0,i="-");var c="",l,d,u,h,g,p;{if(l=n%t,n=n/t>>>0,d=4294967296*l+o,o=d/t>>>0,u=""+(d-t*o),o===0&&n===0)return i+u+c;for(h="",g=6-u.length,p=0;p<g;p++)h+="0";c=h+u+c}{if(l=n%t,n=n/t>>>0,d=4294967296*l+o,o=d/t>>>0,u=""+(d-t*o),o===0&&n===0)return i+u+c;for(h="",g=6-u.length,p=0;p<g;p++)h+="0";c=h+u+c}{if(l=n%t,n=n/t>>>0,d=4294967296*l+o,o=d/t>>>0,u=""+(d-t*o),o===0&&n===0)return i+u+c;for(h="",g=6-u.length,p=0;p<g;p++)h+="0";c=h+u+c}return l=n%t,d=4294967296*l+o,u=""+d%t,i+u+c}I(r,"readInt8"),e.exports=r}),su=ie((s,e)=>{Z();var t=ru(),r=I(function(m,_,b,S,v){b=b||0,S=S||!1,v=v||function($,M,L){return $*Math.pow(2,L)+M};var C=b>>3,T=I(function($){return S?~$&255:$},"inv"),x=255,R=8-b%8;_<R&&(x=255<<8-_&255,R=_),b&&(x=x>>b%8);var k=0;b%8+_>=8&&(k=v(0,T(m[C])&x,R));for(var P=_+b>>3,O=C+1;O<P;O++)k=v(k,T(m[O]),8);var N=(_+b)%8;return N>0&&(k=v(k,T(m[P])>>8-N,N)),k},"parseBits"),a=I(function(m,_,b){var S=Math.pow(2,b-1)-1,v=r(m,1),C=r(m,b,1);if(C===0)return 0;var T=1,x=I(function(k,P,O){k===0&&(k=1);for(var N=1;N<=O;N++)T/=2,(P&1<<O-N)>0&&(k+=T);return k},"parsePrecisionBits"),R=r(m,_,b+1,!1,x);return C==Math.pow(2,b+1)-1?R===0?v===0?1/0:-1/0:NaN:(v===0?1:-1)*Math.pow(2,C-S)*R},"parseFloatFromBits"),n=I(function(m){return r(m,1)==1?-1*(r(m,15,1,!0)+1):r(m,15,1)},"parseInt16"),o=I(function(m){return r(m,1)==1?-1*(r(m,31,1,!0)+1):r(m,31,1)},"parseInt32"),i=I(function(m){return a(m,23,8)},"parseFloat32"),c=I(function(m){return a(m,52,11)},"parseFloat64"),l=I(function(m){var _=r(m,16,32);if(_==49152)return NaN;for(var b=Math.pow(1e4,r(m,16,16)),S=0,v=[],C=r(m,16),T=0;T<C;T++)S+=r(m,16,64+16*T)*b,b/=1e4;var x=Math.pow(10,r(m,16,48));return(_===0?1:-1)*Math.round(S*x)/x},"parseNumeric"),d=I(function(m,_){var b=r(_,1),S=r(_,63,1),v=new Date((b===0?1:-1)*S/1e3+9466848e5);return m||v.setTime(v.getTime()+v.getTimezoneOffset()*6e4),v.usec=S%1e3,v.getMicroSeconds=function(){return this.usec},v.setMicroSeconds=function(C){this.usec=C},v.getUTCMicroSeconds=function(){return this.usec},v},"parseDate"),u=I(function(m){for(var _=r(m,32),b=r(m,32,32),S=r(m,32,64),v=96,C=[],T=0;T<_;T++)C[T]=r(m,32,v),v+=32,v+=32;var x=I(function(k){var P=r(m,32,v);if(v+=32,P==4294967295)return null;var O;if(k==23||k==20)return O=r(m,P*8,v),v+=P*8,O;if(k==25)return O=m.toString(this.encoding,v>>3,(v+=P<<3)>>3),O;console.log("ERROR: ElementType not implemented: "+k)},"parseElement"),R=I(function(k,P){var O=[],N;if(k.length>1){var $=k.shift();for(N=0;N<$;N++)O[N]=R(k,P);k.unshift($)}else for(N=0;N<k[0];N++)O[N]=x(P);return O},"parse");return R(C,S)},"parseArray"),h=I(function(m){return m.toString("utf8")},"parseText"),g=I(function(m){return m===null?null:r(m,8)>0},"parseBool"),p=I(function(m){m(20,t),m(21,n),m(23,o),m(26,o),m(1700,l),m(700,i),m(701,c),m(16,g),m(1114,d.bind(null,!1)),m(1184,d.bind(null,!0)),m(1e3,u),m(1007,u),m(1016,u),m(1008,u),m(1009,u),m(25,h)},"init");e.exports={init:p}}),au=ie((s,e)=>{Z(),e.exports={BOOL:16,BYTEA:17,CHAR:18,INT8:20,INT2:21,INT4:23,REGPROC:24,TEXT:25,OID:26,TID:27,XID:28,CID:29,JSON:114,XML:142,PG_NODE_TREE:194,SMGR:210,PATH:602,POLYGON:604,CIDR:650,FLOAT4:700,FLOAT8:701,ABSTIME:702,RELTIME:703,TINTERVAL:704,CIRCLE:718,MACADDR8:774,MONEY:790,MACADDR:829,INET:869,ACLITEM:1033,BPCHAR:1042,VARCHAR:1043,DATE:1082,TIME:1083,TIMESTAMP:1114,TIMESTAMPTZ:1184,INTERVAL:1186,TIMETZ:1266,BIT:1560,VARBIT:1562,NUMERIC:1700,REFCURSOR:1790,REGPROCEDURE:2202,REGOPER:2203,REGOPERATOR:2204,REGCLASS:2205,REGTYPE:2206,UUID:2950,TXID_SNAPSHOT:2970,PG_LSN:3220,PG_NDISTINCT:3361,PG_DEPENDENCIES:3402,TSVECTOR:3614,TSQUERY:3615,GTSVECTOR:3642,REGCONFIG:3734,REGDICTIONARY:3769,JSONB:3802,REGNAMESPACE:4089,REGROLE:4096}}),ws=ie(s=>{Z();var e=tu(),t=su(),r=zo(),a=au();s.getTypeParser=i,s.setTypeParser=c,s.arrayParser=r,s.builtins=a;var n={text:{},binary:{}};function o(l){return String(l)}I(o,"noParse");function i(l,d){return d=d||"text",n[d]&&n[d][l]||o}I(i,"getTypeParser");function c(l,d,u){typeof d=="function"&&(u=d,d="text"),n[d][l]=u}I(c,"setTypeParser"),e.init(function(l,d){n.text[l]=d}),t.init(function(l,d){n.binary[l]=d})}),$a=ie((s,e)=>{Z();var t=ws();function r(a){this._types=a||t,this.text={},this.binary={}}I(r,"TypeOverrides"),r.prototype.getOverrides=function(a){switch(a){case"text":return this.text;case"binary":return this.binary;default:return{}}},r.prototype.setTypeParser=function(a,n,o){typeof n=="function"&&(o=n,n="text"),this.getOverrides(n)[a]=o},r.prototype.getTypeParser=function(a,n){return n=n||"text",this.getOverrides(n)[a]||this._types.getTypeParser(a,n)},e.exports=r});function xr(s){let e=1779033703,t=3144134277,r=1013904242,a=2773480762,n=1359893119,o=2600822924,i=528734635,c=1541459225,l=0,d=0,u=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],h=I((S,v)=>S>>>v|S<<32-v,"rrot"),g=new Uint32Array(64),p=new Uint8Array(64),m=I(()=>{for(let O=0,N=0;O<16;O++,N+=4)g[O]=p[N]<<24|p[N+1]<<16|p[N+2]<<8|p[N+3];for(let O=16;O<64;O++){let N=h(g[O-15],7)^h(g[O-15],18)^g[O-15]>>>3,$=h(g[O-2],17)^h(g[O-2],19)^g[O-2]>>>10;g[O]=g[O-16]+N+g[O-7]+$|0}let S=e,v=t,C=r,T=a,x=n,R=o,k=i,P=c;for(let O=0;O<64;O++){let N=h(x,6)^h(x,11)^h(x,25),$=x&R^~x&k,M=P+N+$+u[O]+g[O]|0,L=h(S,2)^h(S,13)^h(S,22),B=S&v^S&C^v&C,U=L+B|0;P=k,k=R,R=x,x=T+M|0,T=C,C=v,v=S,S=M+U|0}e=e+S|0,t=t+v|0,r=r+C|0,a=a+T|0,n=n+x|0,o=o+R|0,i=i+k|0,c=c+P|0,d=0},"process"),_=I(S=>{typeof S=="string"&&(S=new TextEncoder().encode(S));for(let v=0;v<S.length;v++)p[d++]=S[v],d===64&&m();l+=S.length},"add"),b=I(()=>{if(p[d++]=128,d==64&&m(),d+8>64){for(;d<64;)p[d++]=0;m()}for(;d<58;)p[d++]=0;let S=l*8;p[d++]=S/1099511627776&255,p[d++]=S/4294967296&255,p[d++]=S>>>24,p[d++]=S>>>16&255,p[d++]=S>>>8&255,p[d++]=S&255,m();let v=new Uint8Array(32);return v[0]=e>>>24,v[1]=e>>>16&255,v[2]=e>>>8&255,v[3]=e&255,v[4]=t>>>24,v[5]=t>>>16&255,v[6]=t>>>8&255,v[7]=t&255,v[8]=r>>>24,v[9]=r>>>16&255,v[10]=r>>>8&255,v[11]=r&255,v[12]=a>>>24,v[13]=a>>>16&255,v[14]=a>>>8&255,v[15]=a&255,v[16]=n>>>24,v[17]=n>>>16&255,v[18]=n>>>8&255,v[19]=n&255,v[20]=o>>>24,v[21]=o>>>16&255,v[22]=o>>>8&255,v[23]=o&255,v[24]=i>>>24,v[25]=i>>>16&255,v[26]=i>>>8&255,v[27]=i&255,v[28]=c>>>24,v[29]=c>>>16&255,v[30]=c>>>8&255,v[31]=c&255,v},"digest");return s===void 0?{add:_,digest:b}:(_(s),b())}var nu=Ve(()=>{Z(),I(xr,"sha256")}),ut,ia,ou=Ve(()=>{Z(),ut=class Je{constructor(){ae(this,"_dataLength",0),ae(this,"_bufferLength",0),ae(this,"_state",new Int32Array(4)),ae(this,"_buffer",new ArrayBuffer(68)),ae(this,"_buffer8"),ae(this,"_buffer32"),this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}static hashByteArray(e,t=!1){return this.onePassHasher.start().appendByteArray(e).end(t)}static hashStr(e,t=!1){return this.onePassHasher.start().appendStr(e).end(t)}static hashAsciiStr(e,t=!1){return this.onePassHasher.start().appendAsciiStr(e).end(t)}static _hex(e){let t=Je.hexChars,r=Je.hexOut,a,n,o,i;for(i=0;i<4;i+=1)for(n=i*8,a=e[i],o=0;o<8;o+=2)r[n+1+o]=t.charAt(a&15),a>>>=4,r[n+0+o]=t.charAt(a&15),a>>>=4;return r.join("")}static _md5cycle(e,t){let r=e[0],a=e[1],n=e[2],o=e[3];r+=(a&n|~a&o)+t[0]-680876936|0,r=(r<<7|r>>>25)+a|0,o+=(r&a|~r&n)+t[1]-389564586|0,o=(o<<12|o>>>20)+r|0,n+=(o&r|~o&a)+t[2]+606105819|0,n=(n<<17|n>>>15)+o|0,a+=(n&o|~n&r)+t[3]-1044525330|0,a=(a<<22|a>>>10)+n|0,r+=(a&n|~a&o)+t[4]-176418897|0,r=(r<<7|r>>>25)+a|0,o+=(r&a|~r&n)+t[5]+1200080426|0,o=(o<<12|o>>>20)+r|0,n+=(o&r|~o&a)+t[6]-1473231341|0,n=(n<<17|n>>>15)+o|0,a+=(n&o|~n&r)+t[7]-45705983|0,a=(a<<22|a>>>10)+n|0,r+=(a&n|~a&o)+t[8]+1770035416|0,r=(r<<7|r>>>25)+a|0,o+=(r&a|~r&n)+t[9]-1958414417|0,o=(o<<12|o>>>20)+r|0,n+=(o&r|~o&a)+t[10]-42063|0,n=(n<<17|n>>>15)+o|0,a+=(n&o|~n&r)+t[11]-1990404162|0,a=(a<<22|a>>>10)+n|0,r+=(a&n|~a&o)+t[12]+1804603682|0,r=(r<<7|r>>>25)+a|0,o+=(r&a|~r&n)+t[13]-40341101|0,o=(o<<12|o>>>20)+r|0,n+=(o&r|~o&a)+t[14]-1502002290|0,n=(n<<17|n>>>15)+o|0,a+=(n&o|~n&r)+t[15]+1236535329|0,a=(a<<22|a>>>10)+n|0,r+=(a&o|n&~o)+t[1]-165796510|0,r=(r<<5|r>>>27)+a|0,o+=(r&n|a&~n)+t[6]-1069501632|0,o=(o<<9|o>>>23)+r|0,n+=(o&a|r&~a)+t[11]+643717713|0,n=(n<<14|n>>>18)+o|0,a+=(n&r|o&~r)+t[0]-373897302|0,a=(a<<20|a>>>12)+n|0,r+=(a&o|n&~o)+t[5]-701558691|0,r=(r<<5|r>>>27)+a|0,o+=(r&n|a&~n)+t[10]+38016083|0,o=(o<<9|o>>>23)+r|0,n+=(o&a|r&~a)+t[15]-660478335|0,n=(n<<14|n>>>18)+o|0,a+=(n&r|o&~r)+t[4]-405537848|0,a=(a<<20|a>>>12)+n|0,r+=(a&o|n&~o)+t[9]+568446438|0,r=(r<<5|r>>>27)+a|0,o+=(r&n|a&~n)+t[14]-1019803690|0,o=(o<<9|o>>>23)+r|0,n+=(o&a|r&~a)+t[3]-187363961|0,n=(n<<14|n>>>18)+o|0,a+=(n&r|o&~r)+t[8]+1163531501|0,a=(a<<20|a>>>12)+n|0,r+=(a&o|n&~o)+t[13]-1444681467|0,r=(r<<5|r>>>27)+a|0,o+=(r&n|a&~n)+t[2]-51403784|0,o=(o<<9|o>>>23)+r|0,n+=(o&a|r&~a)+t[7]+1735328473|0,n=(n<<14|n>>>18)+o|0,a+=(n&r|o&~r)+t[12]-1926607734|0,a=(a<<20|a>>>12)+n|0,r+=(a^n^o)+t[5]-378558|0,r=(r<<4|r>>>28)+a|0,o+=(r^a^n)+t[8]-2022574463|0,o=(o<<11|o>>>21)+r|0,n+=(o^r^a)+t[11]+1839030562|0,n=(n<<16|n>>>16)+o|0,a+=(n^o^r)+t[14]-35309556|0,a=(a<<23|a>>>9)+n|0,r+=(a^n^o)+t[1]-1530992060|0,r=(r<<4|r>>>28)+a|0,o+=(r^a^n)+t[4]+1272893353|0,o=(o<<11|o>>>21)+r|0,n+=(o^r^a)+t[7]-155497632|0,n=(n<<16|n>>>16)+o|0,a+=(n^o^r)+t[10]-1094730640|0,a=(a<<23|a>>>9)+n|0,r+=(a^n^o)+t[13]+681279174|0,r=(r<<4|r>>>28)+a|0,o+=(r^a^n)+t[0]-358537222|0,o=(o<<11|o>>>21)+r|0,n+=(o^r^a)+t[3]-722521979|0,n=(n<<16|n>>>16)+o|0,a+=(n^o^r)+t[6]+76029189|0,a=(a<<23|a>>>9)+n|0,r+=(a^n^o)+t[9]-640364487|0,r=(r<<4|r>>>28)+a|0,o+=(r^a^n)+t[12]-421815835|0,o=(o<<11|o>>>21)+r|0,n+=(o^r^a)+t[15]+530742520|0,n=(n<<16|n>>>16)+o|0,a+=(n^o^r)+t[2]-995338651|0,a=(a<<23|a>>>9)+n|0,r+=(n^(a|~o))+t[0]-198630844|0,r=(r<<6|r>>>26)+a|0,o+=(a^(r|~n))+t[7]+1126891415|0,o=(o<<10|o>>>22)+r|0,n+=(r^(o|~a))+t[14]-1416354905|0,n=(n<<15|n>>>17)+o|0,a+=(o^(n|~r))+t[5]-57434055|0,a=(a<<21|a>>>11)+n|0,r+=(n^(a|~o))+t[12]+1700485571|0,r=(r<<6|r>>>26)+a|0,o+=(a^(r|~n))+t[3]-1894986606|0,o=(o<<10|o>>>22)+r|0,n+=(r^(o|~a))+t[10]-1051523|0,n=(n<<15|n>>>17)+o|0,a+=(o^(n|~r))+t[1]-2054922799|0,a=(a<<21|a>>>11)+n|0,r+=(n^(a|~o))+t[8]+1873313359|0,r=(r<<6|r>>>26)+a|0,o+=(a^(r|~n))+t[15]-30611744|0,o=(o<<10|o>>>22)+r|0,n+=(r^(o|~a))+t[6]-1560198380|0,n=(n<<15|n>>>17)+o|0,a+=(o^(n|~r))+t[13]+1309151649|0,a=(a<<21|a>>>11)+n|0,r+=(n^(a|~o))+t[4]-145523070|0,r=(r<<6|r>>>26)+a|0,o+=(a^(r|~n))+t[11]-1120210379|0,o=(o<<10|o>>>22)+r|0,n+=(r^(o|~a))+t[2]+718787259|0,n=(n<<15|n>>>17)+o|0,a+=(o^(n|~r))+t[9]-343485551|0,a=(a<<21|a>>>11)+n|0,e[0]=r+e[0]|0,e[1]=a+e[1]|0,e[2]=n+e[2]|0,e[3]=o+e[3]|0}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(Je.stateIdentity),this}appendStr(e){let t=this._buffer8,r=this._buffer32,a=this._bufferLength,n,o;for(o=0;o<e.length;o+=1){if(n=e.charCodeAt(o),n<128)t[a++]=n;else if(n<2048)t[a++]=(n>>>6)+192,t[a++]=n&63|128;else if(n<55296||n>56319)t[a++]=(n>>>12)+224,t[a++]=n>>>6&63|128,t[a++]=n&63|128;else{if(n=(n-55296)*1024+(e.charCodeAt(++o)-56320)+65536,n>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");t[a++]=(n>>>18)+240,t[a++]=n>>>12&63|128,t[a++]=n>>>6&63|128,t[a++]=n&63|128}a>=64&&(this._dataLength+=64,Je._md5cycle(this._state,r),a-=64,r[0]=r[16])}return this._bufferLength=a,this}appendAsciiStr(e){let t=this._buffer8,r=this._buffer32,a=this._bufferLength,n,o=0;for(;;){for(n=Math.min(e.length-o,64-a);n--;)t[a++]=e.charCodeAt(o++);if(a<64)break;this._dataLength+=64,Je._md5cycle(this._state,r),a=0}return this._bufferLength=a,this}appendByteArray(e){let t=this._buffer8,r=this._buffer32,a=this._bufferLength,n,o=0;for(;;){for(n=Math.min(e.length-o,64-a);n--;)t[a++]=e[o++];if(a<64)break;this._dataLength+=64,Je._md5cycle(this._state,r),a=0}return this._bufferLength=a,this}getState(){let e=this._state;return{buffer:String.fromCharCode.apply(null,Array.from(this._buffer8)),buflen:this._bufferLength,length:this._dataLength,state:[e[0],e[1],e[2],e[3]]}}setState(e){let t=e.buffer,r=e.state,a=this._state,n;for(this._dataLength=e.length,this._bufferLength=e.buflen,a[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=r[3],n=0;n<t.length;n+=1)this._buffer8[n]=t.charCodeAt(n)}end(e=!1){let t=this._bufferLength,r=this._buffer8,a=this._buffer32,n=(t>>2)+1;this._dataLength+=t;let o=this._dataLength*8;if(r[t]=128,r[t+1]=r[t+2]=r[t+3]=0,a.set(Je.buffer32Identity.subarray(n),n),t>55&&(Je._md5cycle(this._state,a),a.set(Je.buffer32Identity)),o<=4294967295)a[14]=o;else{let i=o.toString(16).match(/(.*?)(.{0,8})$/);if(i===null)return;let c=parseInt(i[2],16),l=parseInt(i[1],16)||0;a[14]=c,a[15]=l}return Je._md5cycle(this._state,a),e?this._state:Je._hex(this._state)}},I(ut,"Md5"),ae(ut,"stateIdentity",new Int32Array([1732584193,-271733879,-1732584194,271733878])),ae(ut,"buffer32Identity",new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),ae(ut,"hexChars","0123456789abcdef"),ae(ut,"hexOut",[]),ae(ut,"onePassHasher",new ut),ia=ut}),Ma={};et(Ma,{createHash:()=>Go,createHmac:()=>Wo,randomBytes:()=>Vo});function Vo(s){return crypto.getRandomValues(se.alloc(s))}function Go(s){if(s==="sha256")return{update:I(function(e){return{digest:I(function(){return se.from(xr(e))},"digest")}},"update")};if(s==="md5")return{update:I(function(e){return{digest:I(function(){return typeof e=="string"?ia.hashStr(e):ia.hashByteArray(e)},"digest")}},"update")};throw new Error(`Hash type '${s}' not supported`)}function Wo(s,e){if(s!=="sha256")throw new Error(`Only sha256 is supported (requested: '${s}')`);return{update:I(function(t){return{digest:I(function(){typeof e=="string"&&(e=new TextEncoder().encode(e)),typeof t=="string"&&(t=new TextEncoder().encode(t));let r=e.length;if(r>64)e=xr(e);else if(r<64){let c=new Uint8Array(64);c.set(e),e=c}let a=new Uint8Array(64),n=new Uint8Array(64);for(let c=0;c<64;c++)a[c]=54^e[c],n[c]=92^e[c];let o=new Uint8Array(t.length+64);o.set(a,0),o.set(t,64);let i=new Uint8Array(96);return i.set(n,0),i.set(xr(o),64),se.from(xr(i))},"digest")}},"update")}}var Ho=Ve(()=>{Z(),nu(),ou(),I(Vo,"randomBytes"),I(Go,"createHash"),I(Wo,"createHmac")}),vs=ie((s,e)=>{Z(),e.exports={host:"localhost",user:oe.platform==="win32"?oe.env.USERNAME:oe.env.USER,database:void 0,password:null,connectionString:void 0,port:5432,rows:0,binary:!1,max:10,idleTimeoutMillis:3e4,client_encoding:"",ssl:!1,application_name:void 0,fallback_application_name:void 0,options:void 0,parseInputDatesAsUTC:!1,statement_timeout:!1,lock_timeout:!1,idle_in_transaction_session_timeout:!1,query_timeout:!1,connect_timeout:0,keepalives:1,keepalives_idle:0};var t=ws(),r=t.getTypeParser(20,"text"),a=t.getTypeParser(1016,"text");e.exports.__defineSetter__("parseInt8",function(n){t.setTypeParser(20,"text",n?t.getTypeParser(23,"text"):r),t.setTypeParser(1016,"text",n?t.getTypeParser(1007,"text"):a)})}),Ss=ie((s,e)=>{Z();var t=(Ho(),Ne(Ma)),r=vs();function a(p){var m=p.replace(/\\/g,"\\\\").replace(/"/g,'\\"');return'"'+m+'"'}I(a,"escapeElement");function n(p){for(var m="{",_=0;_<p.length;_++)_>0&&(m=m+","),p[_]===null||typeof p[_]>"u"?m=m+"NULL":Array.isArray(p[_])?m=m+n(p[_]):p[_]instanceof se?m+="\\\\x"+p[_].toString("hex"):m+=a(o(p[_]));return m=m+"}",m}I(n,"arrayString");var o=I(function(p,m){if(p==null)return null;if(p instanceof se)return p;if(ArrayBuffer.isView(p)){var _=se.from(p.buffer,p.byteOffset,p.byteLength);return _.length===p.byteLength?_:_.slice(p.byteOffset,p.byteOffset+p.byteLength)}return p instanceof Date?r.parseInputDatesAsUTC?d(p):l(p):Array.isArray(p)?n(p):typeof p=="object"?i(p,m):p.toString()},"prepareValue");function i(p,m){if(p&&typeof p.toPostgres=="function"){if(m=m||[],m.indexOf(p)!==-1)throw new Error('circular reference detected while preparing "'+p+'" for query');return m.push(p),o(p.toPostgres(o),m)}return JSON.stringify(p)}I(i,"prepareObject");function c(p,m){for(p=""+p;p.length<m;)p="0"+p;return p}I(c,"pad");function l(p){var m=-p.getTimezoneOffset(),_=p.getFullYear(),b=_<1;b&&(_=Math.abs(_)+1);var S=c(_,4)+"-"+c(p.getMonth()+1,2)+"-"+c(p.getDate(),2)+"T"+c(p.getHours(),2)+":"+c(p.getMinutes(),2)+":"+c(p.getSeconds(),2)+"."+c(p.getMilliseconds(),3);return m<0?(S+="-",m*=-1):S+="+",S+=c(Math.floor(m/60),2)+":"+c(m%60,2),b&&(S+=" BC"),S}I(l,"dateToString");function d(p){var m=p.getUTCFullYear(),_=m<1;_&&(m=Math.abs(m)+1);var b=c(m,4)+"-"+c(p.getUTCMonth()+1,2)+"-"+c(p.getUTCDate(),2)+"T"+c(p.getUTCHours(),2)+":"+c(p.getUTCMinutes(),2)+":"+c(p.getUTCSeconds(),2)+"."+c(p.getUTCMilliseconds(),3);return b+="+00:00",_&&(b+=" BC"),b}I(d,"dateToStringUTC");function u(p,m,_){return p=typeof p=="string"?{text:p}:p,m&&(typeof m=="function"?p.callback=m:p.values=m),_&&(p.callback=_),p}I(u,"normalizeQueryConfig");var h=I(function(p){return t.createHash("md5").update(p,"utf-8").digest("hex")},"md5"),g=I(function(p,m,_){var b=h(m+p),S=h(se.concat([se.from(b),_]));return"md5"+S},"postgresMd5PasswordHash");e.exports={prepareValue:I(function(p){return o(p)},"prepareValueWrapper"),normalizeQueryConfig:u,postgresMd5PasswordHash:g,md5:h}}),Rr={};et(Rr,{default:()=>Qo});var Qo,Es=Ve(()=>{Z(),Qo={}}),iu=ie((s,e)=>{Z();var t=(Ho(),Ne(Ma));function r(m){if(m.indexOf("SCRAM-SHA-256")===-1)throw new Error("SASL: Only mechanism SCRAM-SHA-256 is currently supported");let _=t.randomBytes(18).toString("base64");return{mechanism:"SCRAM-SHA-256",clientNonce:_,response:"n,,n=*,r="+_,message:"SASLInitialResponse"}}I(r,"startSession");function a(m,_,b){if(m.message!=="SASLInitialResponse")throw new Error("SASL: Last message was not SASLInitialResponse");if(typeof _!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string");if(typeof b!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: serverData must be a string");let S=l(b);if(S.nonce.startsWith(m.clientNonce)){if(S.nonce.length===m.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");var v=se.from(S.salt,"base64"),C=p(_,v,S.iteration),T=g(C,"Client Key"),x=h(T),R="n=*,r="+m.clientNonce,k="r="+S.nonce+",s="+S.salt+",i="+S.iteration,P="c=biws,r="+S.nonce,O=R+","+k+","+P,N=g(x,O),$=u(T,N),M=$.toString("base64"),L=g(C,"Server Key"),B=g(L,O);m.message="SASLResponse",m.serverSignature=B.toString("base64"),m.response=P+",p="+M}I(a,"continueSession");function n(m,_){if(m.message!=="SASLResponse")throw new Error("SASL: Last message was not SASLResponse");if(typeof _!="string")throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: serverData must be a string");let{serverSignature:b}=d(_);if(b!==m.serverSignature)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature does not match")}I(n,"finalizeSession");function o(m){if(typeof m!="string")throw new TypeError("SASL: text must be a string");return m.split("").map((_,b)=>m.charCodeAt(b)).every(_=>_>=33&&_<=43||_>=45&&_<=126)}I(o,"isPrintableChars");function i(m){return/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(m)}I(i,"isBase64");function c(m){if(typeof m!="string")throw new TypeError("SASL: attribute pairs text must be a string");return new Map(m.split(",").map(_=>{if(!/^.=/.test(_))throw new Error("SASL: Invalid attribute pair entry");let b=_[0],S=_.substring(2);return[b,S]}))}I(c,"parseAttributePairs");function l(m){let _=c(m),b=_.get("r");if(b){if(!o(b))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce must only contain printable characters")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");let S=_.get("s");if(S){if(!i(S))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt must be base64")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");let v=_.get("i");if(v){if(!/^[1-9][0-9]*$/.test(v))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: invalid iteration count")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");let C=parseInt(v,10);return{nonce:b,salt:S,iteration:C}}I(l,"parseServerFirstMessage");function d(m){let _=c(m).get("v");if(_){if(!i(_))throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature must be base64")}else throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing");return{serverSignature:_}}I(d,"parseServerFinalMessage");function u(m,_){if(!se.isBuffer(m))throw new TypeError("first argument must be a Buffer");if(!se.isBuffer(_))throw new TypeError("second argument must be a Buffer");if(m.length!==_.length)throw new Error("Buffer lengths must match");if(m.length===0)throw new Error("Buffers cannot be empty");return se.from(m.map((b,S)=>m[S]^_[S]))}I(u,"xorBuffers");function h(m){return t.createHash("sha256").update(m).digest()}I(h,"sha256");function g(m,_){return t.createHmac("sha256",m).update(_).digest()}I(g,"hmacSha256");function p(m,_,b){for(var S=g(m,se.concat([_,se.from([0,0,0,1])])),v=S,C=0;C<b-1;C++)S=g(m,S),v=u(v,S);return v}I(p,"Hi"),e.exports={startSession:r,continueSession:a,finalizeSession:n}}),qa={};et(qa,{join:()=>Ko});function Ko(...s){return s.join("/")}var Jo=Ve(()=>{Z(),I(Ko,"join")}),Ba={};et(Ba,{stat:()=>Yo});function Yo(s,e){e(new Error("No filesystem"))}var Xo=Ve(()=>{"use strict";Z(),I(Yo,"stat")}),Fa={};et(Fa,{default:()=>Zo});var Zo,ei=Ve(()=>{Z(),Zo={}}),ti={};et(ti,{StringDecoder:()=>ri});var qs,ri,cu=Ve(()=>{Z(),qs=class{constructor(e){ae(this,"td"),this.td=new TextDecoder(e)}write(e){return this.td.decode(e,{stream:!0})}end(e){return this.td.decode(e)}},I(qs,"StringDecoder"),ri=qs}),lu=ie((s,e)=>{Z();var{Transform:t}=(ei(),Ne(Fa)),{StringDecoder:r}=(cu(),Ne(ti)),a=Symbol("last"),n=Symbol("decoder");function o(u,h,g){let p;if(this.overflow){if(p=this[n].write(u).split(this.matcher),p.length===1)return g();p.shift(),this.overflow=!1}else this[a]+=this[n].write(u),p=this[a].split(this.matcher);this[a]=p.pop();for(let m=0;m<p.length;m++)try{c(this,this.mapper(p[m]))}catch(_){return g(_)}if(this.overflow=this[a].length>this.maxLength,this.overflow&&!this.skipOverflow){g(new Error("maximum buffer reached"));return}g()}I(o,"transform");function i(u){if(this[a]+=this[n].end(),this[a])try{c(this,this.mapper(this[a]))}catch(h){return u(h)}u()}I(i,"flush");function c(u,h){h!==void 0&&u.push(h)}I(c,"push");function l(u){return u}I(l,"noop");function d(u,h,g){switch(u=u||/\r?\n/,h=h||l,g=g||{},arguments.length){case 1:typeof u=="function"?(h=u,u=/\r?\n/):typeof u=="object"&&!(u instanceof RegExp)&&!u[Symbol.split]&&(g=u,u=/\r?\n/);break;case 2:typeof u=="function"?(g=h,h=u,u=/\r?\n/):typeof h=="object"&&(g=h,h=l)}g=Object.assign({},g),g.autoDestroy=!0,g.transform=o,g.flush=i,g.readableObjectMode=!0;let p=new t(g);return p[a]="",p[n]=new r("utf8"),p.matcher=u,p.mapper=h,p.maxLength=g.maxLength,p.skipOverflow=g.skipOverflow||!1,p.overflow=!1,p._destroy=function(m,_){this._writableState.errorEmitted=!1,_(m)},p}I(d,"split"),e.exports=d}),uu=ie((s,e)=>{Z();var t=(Jo(),Ne(qa)),r=(ei(),Ne(Fa)).Stream,a=lu(),n=(Es(),Ne(Rr)),o=5432,i=oe.platform==="win32",c=oe.stderr,l=56,d=7,u=61440,h=32768;function g(T){return(T&u)==h}I(g,"isRegFile");var p=["host","port","database","user","password"],m=p.length,_=p[m-1];function b(){var T=c instanceof r&&c.writable===!0;if(T){var x=Array.prototype.slice.call(arguments).concat(`
`);c.write(n.format.apply(n,x))}}I(b,"warn"),Object.defineProperty(e.exports,"isWin",{get:I(function(){return i},"get"),set:I(function(T){i=T},"set")}),e.exports.warnTo=function(T){var x=c;return c=T,x},e.exports.getFileName=function(T){var x=T||oe.env,R=x.PGPASSFILE||(i?t.join(x.APPDATA||"./","postgresql","pgpass.conf"):t.join(x.HOME||"./",".pgpass"));return R},e.exports.usePgPass=function(T,x){return Object.prototype.hasOwnProperty.call(oe.env,"PGPASSWORD")?!1:i?!0:(x=x||"<unkn>",g(T.mode)?T.mode&(l|d)?(b('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',x),!1):!0:(b('WARNING: password file "%s" is not a plain file',x),!1))};var S=e.exports.match=function(T,x){return p.slice(0,-1).reduce(function(R,k,P){return P==1&&Number(T[k]||o)===Number(x[k])?R&&!0:R&&(x[k]==="*"||x[k]===T[k])},!0)};e.exports.getPassword=function(T,x,R){var k,P=x.pipe(a());function O(M){var L=v(M);L&&C(L)&&S(T,L)&&(k=L[_],P.end())}I(O,"onLine");var N=I(function(){x.destroy(),R(k)},"onEnd"),$=I(function(M){x.destroy(),b("WARNING: error on reading file: %s",M),R(void 0)},"onErr");x.on("error",$),P.on("data",O).on("end",N).on("error",$)};var v=e.exports.parseLine=function(T){if(T.length<11||T.match(/^\s+#/))return null;for(var x="",R="",k=0,P=0,O=0,N={},$=!1,M=I(function(B,U,W){var H=T.substring(U,W);Object.hasOwnProperty.call(oe.env,"PGPASS_NO_DEESCAPE")||(H=H.replace(/\\([:\\])/g,"$1")),N[p[B]]=H},"addToObj"),L=0;L<T.length-1;L+=1){if(x=T.charAt(L+1),R=T.charAt(L),$=k==m-1,$){M(k,P);break}L>=0&&x==":"&&R!=="\\"&&(M(k,P,L+1),P=L+2,k+=1)}return N=Object.keys(N).length===m?N:null,N},C=e.exports.isValidEntry=function(T){for(var x={0:function(N){return N.length>0},1:function(N){return N==="*"?!0:(N=Number(N),isFinite(N)&&N>0&&N<9007199254740992&&Math.floor(N)===N)},2:function(N){return N.length>0},3:function(N){return N.length>0},4:function(N){return N.length>0}},R=0;R<p.length;R+=1){var k=x[R],P=T[p[R]]||"",O=k(P);if(!O)return!1}return!0}}),du=ie((s,e)=>{Z(),Jo(),Ne(qa);var t=(Xo(),Ne(Ba)),r=uu();e.exports=function(a,n){var o=r.getFileName();t.stat(o,function(i,c){if(i||!r.usePgPass(c,o))return n(void 0);var l=t.createReadStream(o);r.getPassword(a,l,n)})},e.exports.warnTo=r.warnTo}),si={};et(si,{default:()=>ai});var ai,hu=Ve(()=>{Z(),ai={}}),mu=ie((s,e)=>{Z();var t=(qo(),Ne(Mo)),r=(Xo(),Ne(Ba));function a(n){if(n.charAt(0)==="/"){var i=n.split(" ");return{host:i[0],database:i[1]}}var o=t.parse(/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(n)?encodeURI(n).replace(/\%25(\d\d)/g,"%$1"):n,!0),i=o.query;for(var c in i)Array.isArray(i[c])&&(i[c]=i[c][i[c].length-1]);var l=(o.auth||":").split(":");if(i.user=l[0],i.password=l.splice(1).join(":"),i.port=o.port,o.protocol=="socket:")return i.host=decodeURI(o.pathname),i.database=o.query.db,i.client_encoding=o.query.encoding,i;i.host||(i.host=o.hostname);var d=o.pathname;if(!i.host&&d&&/^%2f/i.test(d)){var u=d.split("/");i.host=decodeURIComponent(u[0]),d=u.splice(1).join("/")}switch(d&&d.charAt(0)==="/"&&(d=d.slice(1)||null),i.database=d&&decodeURI(d),(i.ssl==="true"||i.ssl==="1")&&(i.ssl=!0),i.ssl==="0"&&(i.ssl=!1),(i.sslcert||i.sslkey||i.sslrootcert||i.sslmode)&&(i.ssl={}),i.sslcert&&(i.ssl.cert=r.readFileSync(i.sslcert).toString()),i.sslkey&&(i.ssl.key=r.readFileSync(i.sslkey).toString()),i.sslrootcert&&(i.ssl.ca=r.readFileSync(i.sslrootcert).toString()),i.sslmode){case"disable":{i.ssl=!1;break}case"prefer":case"require":case"verify-ca":case"verify-full":break;case"no-verify":{i.ssl.rejectUnauthorized=!1;break}}return i}I(a,"parse"),e.exports=a,a.parse=a}),za=ie((s,e)=>{Z();var t=(hu(),Ne(si)),r=vs(),a=mu().parse,n=I(function(u,h,g){return g===void 0?g=oe.env["PG"+u.toUpperCase()]:g===!1||(g=oe.env[g]),h[u]||g||r[u]},"val"),o=I(function(){switch(oe.env.PGSSLMODE){case"disable":return!1;case"prefer":case"require":case"verify-ca":case"verify-full":return!0;case"no-verify":return{rejectUnauthorized:!1}}return r.ssl},"readSSLConfigFromEnvironment"),i=I(function(u){return"'"+(""+u).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},"quoteParamValue"),c=I(function(u,h,g){var p=h[g];p!=null&&u.push(g+"="+i(p))},"add"),l=class{constructor(h){h=typeof h=="string"?a(h):h||{},h.connectionString&&(h=Object.assign({},h,a(h.connectionString))),this.user=n("user",h),this.database=n("database",h),this.database===void 0&&(this.database=this.user),this.port=parseInt(n("port",h),10),this.host=n("host",h),Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:n("password",h)}),this.binary=n("binary",h),this.options=n("options",h),this.ssl=typeof h.ssl>"u"?o():h.ssl,typeof this.ssl=="string"&&this.ssl==="true"&&(this.ssl=!0),this.ssl==="no-verify"&&(this.ssl={rejectUnauthorized:!1}),this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this.client_encoding=n("client_encoding",h),this.replication=n("replication",h),this.isDomainSocket=!(this.host||"").indexOf("/"),this.application_name=n("application_name",h,"PGAPPNAME"),this.fallback_application_name=n("fallback_application_name",h,!1),this.statement_timeout=n("statement_timeout",h,!1),this.lock_timeout=n("lock_timeout",h,!1),this.idle_in_transaction_session_timeout=n("idle_in_transaction_session_timeout",h,!1),this.query_timeout=n("query_timeout",h,!1),h.connectionTimeoutMillis===void 0?this.connect_timeout=oe.env.PGCONNECT_TIMEOUT||0:this.connect_timeout=Math.floor(h.connectionTimeoutMillis/1e3),h.keepAlive===!1?this.keepalives=0:h.keepAlive===!0&&(this.keepalives=1),typeof h.keepAliveInitialDelayMillis=="number"&&(this.keepalives_idle=Math.floor(h.keepAliveInitialDelayMillis/1e3))}getLibpqConnectionString(h){var g=[];c(g,this,"user"),c(g,this,"password"),c(g,this,"port"),c(g,this,"application_name"),c(g,this,"fallback_application_name"),c(g,this,"connect_timeout"),c(g,this,"options");var p=typeof this.ssl=="object"?this.ssl:this.ssl?{sslmode:this.ssl}:{};if(c(g,p,"sslmode"),c(g,p,"sslca"),c(g,p,"sslkey"),c(g,p,"sslcert"),c(g,p,"sslrootcert"),this.database&&g.push("dbname="+i(this.database)),this.replication&&g.push("replication="+i(this.replication)),this.host&&g.push("host="+i(this.host)),this.isDomainSocket)return h(null,g.join(" "));this.client_encoding&&g.push("client_encoding="+i(this.client_encoding)),t.lookup(this.host,function(m,_){return m?h(m,null):(g.push("hostaddr="+i(_)),h(null,g.join(" ")))})}};I(l,"ConnectionParameters");var d=l;e.exports=d}),pu=ie((s,e)=>{Z();var t=ws(),r=/^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/,a=class{constructor(i,c){this.command=null,this.rowCount=null,this.oid=null,this.rows=[],this.fields=[],this._parsers=void 0,this._types=c,this.RowCtor=null,this.rowAsArray=i==="array",this.rowAsArray&&(this.parseRow=this._parseRowAsArray)}addCommandComplete(i){var c;i.text?c=r.exec(i.text):c=r.exec(i.command),c&&(this.command=c[1],c[3]?(this.oid=parseInt(c[2],10),this.rowCount=parseInt(c[3],10)):c[2]&&(this.rowCount=parseInt(c[2],10)))}_parseRowAsArray(i){for(var c=new Array(i.length),l=0,d=i.length;l<d;l++){var u=i[l];u!==null?c[l]=this._parsers[l](u):c[l]=null}return c}parseRow(i){for(var c={},l=0,d=i.length;l<d;l++){var u=i[l],h=this.fields[l].name;u!==null?c[h]=this._parsers[l](u):c[h]=null}return c}addRow(i){this.rows.push(i)}addFields(i){this.fields=i,this.fields.length&&(this._parsers=new Array(i.length));for(var c=0;c<i.length;c++){var l=i[c];this._types?this._parsers[c]=this._types.getTypeParser(l.dataTypeID,l.format||"text"):this._parsers[c]=t.getTypeParser(l.dataTypeID,l.format||"text")}}};I(a,"Result");var n=a;e.exports=n}),fu=ie((s,e)=>{Z();var{EventEmitter:t}=Nt(),r=pu(),a=Ss(),n=class extends t{constructor(c,l,d){super(),c=a.normalizeQueryConfig(c,l,d),this.text=c.text,this.values=c.values,this.rows=c.rows,this.types=c.types,this.name=c.name,this.binary=c.binary,this.portal=c.portal||"",this.callback=c.callback,this._rowMode=c.rowMode,oe.domain&&c.callback&&(this.callback=oe.domain.bind(c.callback)),this._result=new r(this._rowMode,this.types),this._results=this._result,this.isPreparedStatement=!1,this._canceledDueToError=!1,this._promise=null}requiresPreparation(){return this.name||this.rows?!0:!this.text||!this.values?!1:this.values.length>0}_checkForMultirow(){this._result.command&&(Array.isArray(this._results)||(this._results=[this._result]),this._result=new r(this._rowMode,this.types),this._results.push(this._result))}handleRowDescription(c){this._checkForMultirow(),this._result.addFields(c.fields),this._accumulateRows=this.callback||!this.listeners("row").length}handleDataRow(c){let l;if(!this._canceledDueToError){try{l=this._result.parseRow(c.fields)}catch(d){this._canceledDueToError=d;return}this.emit("row",l,this._result),this._accumulateRows&&this._result.addRow(l)}}handleCommandComplete(c,l){this._checkForMultirow(),this._result.addCommandComplete(c),this.rows&&l.sync()}handleEmptyQuery(c){this.rows&&c.sync()}handleError(c,l){if(this._canceledDueToError&&(c=this._canceledDueToError,this._canceledDueToError=!1),this.callback)return this.callback(c);this.emit("error",c)}handleReadyForQuery(c){if(this._canceledDueToError)return this.handleError(this._canceledDueToError,c);if(this.callback)try{this.callback(null,this._results)}catch(l){oe.nextTick(()=>{throw l})}this.emit("end",this._results)}submit(c){if(typeof this.text!="string"&&typeof this.name!="string")return new Error("A query must have either text or a name. Supplying neither is unsupported.");let l=c.parsedStatements[this.name];return this.text&&l&&this.text!==l?new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`):this.values&&!Array.isArray(this.values)?new Error("Query values must be an array"):(this.requiresPreparation()?this.prepare(c):c.query(this.text),null)}hasBeenParsed(c){return this.name&&c.parsedStatements[this.name]}handlePortalSuspended(c){this._getRows(c,this.rows)}_getRows(c,l){c.execute({portal:this.portal,rows:l}),l?c.flush():c.sync()}prepare(c){this.isPreparedStatement=!0,this.hasBeenParsed(c)||c.parse({text:this.text,name:this.name,types:this.types});try{c.bind({portal:this.portal,statement:this.name,values:this.values,binary:this.binary,valueMapper:a.prepareValue})}catch(l){this.handleError(l,c);return}c.describe({type:"P",name:this.portal||""}),this._getRows(c,this.rows)}handleCopyInResponse(c){c.sendCopyFail("No source stream defined")}handleCopyData(c,l){}};I(n,"Query");var o=n;e.exports=o}),ni=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.NoticeMessage=s.DataRowMessage=s.CommandCompleteMessage=s.ReadyForQueryMessage=s.NotificationResponseMessage=s.BackendKeyDataMessage=s.AuthenticationMD5Password=s.ParameterStatusMessage=s.ParameterDescriptionMessage=s.RowDescriptionMessage=s.Field=s.CopyResponse=s.CopyDataMessage=s.DatabaseError=s.copyDone=s.emptyQuery=s.replicationStart=s.portalSuspended=s.noData=s.closeComplete=s.bindComplete=s.parseComplete=void 0,s.parseComplete={name:"parseComplete",length:5},s.bindComplete={name:"bindComplete",length:5},s.closeComplete={name:"closeComplete",length:5},s.noData={name:"noData",length:5},s.portalSuspended={name:"portalSuspended",length:5},s.replicationStart={name:"replicationStart",length:4},s.emptyQuery={name:"emptyQuery",length:4},s.copyDone={name:"copyDone",length:4};var e=class extends Error{constructor(L,B,U){super(L),this.length=B,this.name=U}};I(e,"DatabaseError");var t=e;s.DatabaseError=t;var r=class{constructor(L,B){this.length=L,this.chunk=B,this.name="copyData"}};I(r,"CopyDataMessage");var a=r;s.CopyDataMessage=a;var n=class{constructor(L,B,U,W){this.length=L,this.name=B,this.binary=U,this.columnTypes=new Array(W)}};I(n,"CopyResponse");var o=n;s.CopyResponse=o;var i=class{constructor(L,B,U,W,H,Q,ce){this.name=L,this.tableID=B,this.columnID=U,this.dataTypeID=W,this.dataTypeSize=H,this.dataTypeModifier=Q,this.format=ce}};I(i,"Field");var c=i;s.Field=c;var l=class{constructor(L,B){this.length=L,this.fieldCount=B,this.name="rowDescription",this.fields=new Array(this.fieldCount)}};I(l,"RowDescriptionMessage");var d=l;s.RowDescriptionMessage=d;var u=class{constructor(L,B){this.length=L,this.parameterCount=B,this.name="parameterDescription",this.dataTypeIDs=new Array(this.parameterCount)}};I(u,"ParameterDescriptionMessage");var h=u;s.ParameterDescriptionMessage=h;var g=class{constructor(L,B,U){this.length=L,this.parameterName=B,this.parameterValue=U,this.name="parameterStatus"}};I(g,"ParameterStatusMessage");var p=g;s.ParameterStatusMessage=p;var m=class{constructor(L,B){this.length=L,this.salt=B,this.name="authenticationMD5Password"}};I(m,"AuthenticationMD5Password");var _=m;s.AuthenticationMD5Password=_;var b=class{constructor(L,B,U){this.length=L,this.processID=B,this.secretKey=U,this.name="backendKeyData"}};I(b,"BackendKeyDataMessage");var S=b;s.BackendKeyDataMessage=S;var v=class{constructor(L,B,U,W){this.length=L,this.processId=B,this.channel=U,this.payload=W,this.name="notification"}};I(v,"NotificationResponseMessage");var C=v;s.NotificationResponseMessage=C;var T=class{constructor(L,B){this.length=L,this.status=B,this.name="readyForQuery"}};I(T,"ReadyForQueryMessage");var x=T;s.ReadyForQueryMessage=x;var R=class{constructor(L,B){this.length=L,this.text=B,this.name="commandComplete"}};I(R,"CommandCompleteMessage");var k=R;s.CommandCompleteMessage=k;var P=class{constructor(L,B){this.length=L,this.fields=B,this.name="dataRow",this.fieldCount=B.length}};I(P,"DataRowMessage");var O=P;s.DataRowMessage=O;var N=class{constructor(L,B){this.length=L,this.message=B,this.name="notice"}};I(N,"NoticeMessage");var $=N;s.NoticeMessage=$}),gu=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.Writer=void 0;var e=class{constructor(a=256){this.size=a,this.offset=5,this.headerPosition=0,this.buffer=se.allocUnsafe(a)}ensure(a){if(this.buffer.length-this.offset<a){let n=this.buffer,o=n.length+(n.length>>1)+a;this.buffer=se.allocUnsafe(o),n.copy(this.buffer)}}addInt32(a){return this.ensure(4),this.buffer[this.offset++]=a>>>24&255,this.buffer[this.offset++]=a>>>16&255,this.buffer[this.offset++]=a>>>8&255,this.buffer[this.offset++]=a>>>0&255,this}addInt16(a){return this.ensure(2),this.buffer[this.offset++]=a>>>8&255,this.buffer[this.offset++]=a>>>0&255,this}addCString(a){if(!a)this.ensure(1);else{let n=se.byteLength(a);this.ensure(n+1),this.buffer.write(a,this.offset,"utf-8"),this.offset+=n}return this.buffer[this.offset++]=0,this}addString(a=""){let n=se.byteLength(a);return this.ensure(n),this.buffer.write(a,this.offset),this.offset+=n,this}add(a){return this.ensure(a.length),a.copy(this.buffer,this.offset),this.offset+=a.length,this}join(a){if(a){this.buffer[this.headerPosition]=a;let n=this.offset-(this.headerPosition+1);this.buffer.writeInt32BE(n,this.headerPosition+1)}return this.buffer.slice(a?0:5,this.offset)}flush(a){let n=this.join(a);return this.offset=5,this.headerPosition=0,this.buffer=se.allocUnsafe(this.size),n}};I(e,"Writer");var t=e;s.Writer=t}),_u=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.serialize=void 0;var e=gu(),t=new e.Writer,r=I(L=>{t.addInt16(3).addInt16(0);for(let W of Object.keys(L))t.addCString(W).addCString(L[W]);t.addCString("client_encoding").addCString("UTF8");let B=t.addCString("").flush(),U=B.length+4;return new e.Writer().addInt32(U).add(B).flush()},"startup"),a=I(()=>{let L=se.allocUnsafe(8);return L.writeInt32BE(8,0),L.writeInt32BE(80877103,4),L},"requestSsl"),n=I(L=>t.addCString(L).flush(112),"password"),o=I(function(L,B){return t.addCString(L).addInt32(se.byteLength(B)).addString(B),t.flush(112)},"sendSASLInitialResponseMessage"),i=I(function(L){return t.addString(L).flush(112)},"sendSCRAMClientFinalMessage"),c=I(L=>t.addCString(L).flush(81),"query"),l=[],d=I(L=>{let B=L.name||"";B.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",B,B.length),console.error("This can cause conflicts and silent errors executing queries"));let U=L.types||l,W=U.length,H=t.addCString(B).addCString(L.text).addInt16(W);for(let Q=0;Q<W;Q++)H.addInt32(U[Q]);return t.flush(80)},"parse"),u=new e.Writer,h=I(function(L,B){for(let U=0;U<L.length;U++){let W=B?B(L[U],U):L[U];W==null?(t.addInt16(0),u.addInt32(-1)):W instanceof se?(t.addInt16(1),u.addInt32(W.length),u.add(W)):(t.addInt16(0),u.addInt32(se.byteLength(W)),u.addString(W))}},"writeValues"),g=I((L={})=>{let B=L.portal||"",U=L.statement||"",W=L.binary||!1,H=L.values||l,Q=H.length;return t.addCString(B).addCString(U),t.addInt16(Q),h(H,L.valueMapper),t.addInt16(Q),t.add(u.flush()),t.addInt16(W?1:0),t.flush(66)},"bind"),p=se.from([69,0,0,0,9,0,0,0,0,0]),m=I(L=>{if(!L||!L.portal&&!L.rows)return p;let B=L.portal||"",U=L.rows||0,W=se.byteLength(B),H=4+W+1+4,Q=se.allocUnsafe(1+H);return Q[0]=69,Q.writeInt32BE(H,1),Q.write(B,5,"utf-8"),Q[W+5]=0,Q.writeUInt32BE(U,Q.length-4),Q},"execute"),_=I((L,B)=>{let U=se.allocUnsafe(16);return U.writeInt32BE(16,0),U.writeInt16BE(1234,4),U.writeInt16BE(5678,6),U.writeInt32BE(L,8),U.writeInt32BE(B,12),U},"cancel"),b=I((L,B)=>{let U=4+se.byteLength(B)+1,W=se.allocUnsafe(1+U);return W[0]=L,W.writeInt32BE(U,1),W.write(B,5,"utf-8"),W[U]=0,W},"cstringMessage"),S=t.addCString("P").flush(68),v=t.addCString("S").flush(68),C=I(L=>L.name?b(68,`${L.type}${L.name||""}`):L.type==="P"?S:v,"describe"),T=I(L=>{let B=`${L.type}${L.name||""}`;return b(67,B)},"close"),x=I(L=>t.add(L).flush(100),"copyData"),R=I(L=>b(102,L),"copyFail"),k=I(L=>se.from([L,0,0,0,4]),"codeOnlyBuffer"),P=k(72),O=k(83),N=k(88),$=k(99),M={startup:r,password:n,requestSsl:a,sendSASLInitialResponseMessage:o,sendSCRAMClientFinalMessage:i,query:c,parse:d,bind:g,execute:m,describe:C,close:T,flush:I(()=>P,"flush"),sync:I(()=>O,"sync"),end:I(()=>N,"end"),copyData:x,copyDone:I(()=>$,"copyDone"),copyFail:R,cancel:_};s.serialize=M}),yu=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.BufferReader=void 0;var e=se.allocUnsafe(0),t=class{constructor(n=0){this.offset=n,this.buffer=e,this.encoding="utf-8"}setBuffer(n,o){this.offset=n,this.buffer=o}int16(){let n=this.buffer.readInt16BE(this.offset);return this.offset+=2,n}byte(){let n=this.buffer[this.offset];return this.offset++,n}int32(){let n=this.buffer.readInt32BE(this.offset);return this.offset+=4,n}uint32(){let n=this.buffer.readUInt32BE(this.offset);return this.offset+=4,n}string(n){let o=this.buffer.toString(this.encoding,this.offset,this.offset+n);return this.offset+=n,o}cstring(){let n=this.offset,o=n;for(;this.buffer[o++]!==0;);return this.offset=o,this.buffer.toString(this.encoding,n,o-1)}bytes(n){let o=this.buffer.slice(this.offset,this.offset+n);return this.offset+=n,o}};I(t,"BufferReader");var r=t;s.BufferReader=r}),bu=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.Parser=void 0;var e=ni(),t=yu(),r=1,a=4,n=r+a,o=se.allocUnsafe(0),i=class{constructor(d){if(this.buffer=o,this.bufferLength=0,this.bufferOffset=0,this.reader=new t.BufferReader,(d==null?void 0:d.mode)==="binary")throw new Error("Binary mode not supported yet");this.mode=(d==null?void 0:d.mode)||"text"}parse(d,u){this.mergeBuffer(d);let h=this.bufferOffset+this.bufferLength,g=this.bufferOffset;for(;g+n<=h;){let p=this.buffer[g],m=this.buffer.readUInt32BE(g+r),_=r+m;if(_+g<=h){let b=this.handlePacket(g+n,p,m,this.buffer);u(b),g+=_}else break}g===h?(this.buffer=o,this.bufferLength=0,this.bufferOffset=0):(this.bufferLength=h-g,this.bufferOffset=g)}mergeBuffer(d){if(this.bufferLength>0){let u=this.bufferLength+d.byteLength;if(u+this.bufferOffset>this.buffer.byteLength){let h;if(u<=this.buffer.byteLength&&this.bufferOffset>=this.bufferLength)h=this.buffer;else{let g=this.buffer.byteLength*2;for(;u>=g;)g*=2;h=se.allocUnsafe(g)}this.buffer.copy(h,0,this.bufferOffset,this.bufferOffset+this.bufferLength),this.buffer=h,this.bufferOffset=0}d.copy(this.buffer,this.bufferOffset+this.bufferLength),this.bufferLength=u}else this.buffer=d,this.bufferOffset=0,this.bufferLength=d.byteLength}handlePacket(d,u,h,g){switch(u){case 50:return e.bindComplete;case 49:return e.parseComplete;case 51:return e.closeComplete;case 110:return e.noData;case 115:return e.portalSuspended;case 99:return e.copyDone;case 87:return e.replicationStart;case 73:return e.emptyQuery;case 68:return this.parseDataRowMessage(d,h,g);case 67:return this.parseCommandCompleteMessage(d,h,g);case 90:return this.parseReadyForQueryMessage(d,h,g);case 65:return this.parseNotificationMessage(d,h,g);case 82:return this.parseAuthenticationResponse(d,h,g);case 83:return this.parseParameterStatusMessage(d,h,g);case 75:return this.parseBackendKeyData(d,h,g);case 69:return this.parseErrorMessage(d,h,g,"error");case 78:return this.parseErrorMessage(d,h,g,"notice");case 84:return this.parseRowDescriptionMessage(d,h,g);case 116:return this.parseParameterDescriptionMessage(d,h,g);case 71:return this.parseCopyInMessage(d,h,g);case 72:return this.parseCopyOutMessage(d,h,g);case 100:return this.parseCopyData(d,h,g);default:return new e.DatabaseError("received invalid response: "+u.toString(16),h,"error")}}parseReadyForQueryMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.string(1);return new e.ReadyForQueryMessage(u,g)}parseCommandCompleteMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.cstring();return new e.CommandCompleteMessage(u,g)}parseCopyData(d,u,h){let g=h.slice(d,d+(u-4));return new e.CopyDataMessage(u,g)}parseCopyInMessage(d,u,h){return this.parseCopyMessage(d,u,h,"copyInResponse")}parseCopyOutMessage(d,u,h){return this.parseCopyMessage(d,u,h,"copyOutResponse")}parseCopyMessage(d,u,h,g){this.reader.setBuffer(d,h);let p=this.reader.byte()!==0,m=this.reader.int16(),_=new e.CopyResponse(u,g,p,m);for(let b=0;b<m;b++)_.columnTypes[b]=this.reader.int16();return _}parseNotificationMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int32(),p=this.reader.cstring(),m=this.reader.cstring();return new e.NotificationResponseMessage(u,g,p,m)}parseRowDescriptionMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int16(),p=new e.RowDescriptionMessage(u,g);for(let m=0;m<g;m++)p.fields[m]=this.parseField();return p}parseField(){let d=this.reader.cstring(),u=this.reader.uint32(),h=this.reader.int16(),g=this.reader.uint32(),p=this.reader.int16(),m=this.reader.int32(),_=this.reader.int16()===0?"text":"binary";return new e.Field(d,u,h,g,p,m,_)}parseParameterDescriptionMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int16(),p=new e.ParameterDescriptionMessage(u,g);for(let m=0;m<g;m++)p.dataTypeIDs[m]=this.reader.int32();return p}parseDataRowMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int16(),p=new Array(g);for(let m=0;m<g;m++){let _=this.reader.int32();p[m]=_===-1?null:this.reader.string(_)}return new e.DataRowMessage(u,p)}parseParameterStatusMessage(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.cstring(),p=this.reader.cstring();return new e.ParameterStatusMessage(u,g,p)}parseBackendKeyData(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int32(),p=this.reader.int32();return new e.BackendKeyDataMessage(u,g,p)}parseAuthenticationResponse(d,u,h){this.reader.setBuffer(d,h);let g=this.reader.int32(),p={name:"authenticationOk",length:u};switch(g){case 0:break;case 3:p.length===8&&(p.name="authenticationCleartextPassword");break;case 5:if(p.length===12){p.name="authenticationMD5Password";let m=this.reader.bytes(4);return new e.AuthenticationMD5Password(u,m)}break;case 10:{p.name="authenticationSASL",p.mechanisms=[];let m;do m=this.reader.cstring(),m&&p.mechanisms.push(m);while(m)}break;case 11:p.name="authenticationSASLContinue",p.data=this.reader.string(u-8);break;case 12:p.name="authenticationSASLFinal",p.data=this.reader.string(u-8);break;default:throw new Error("Unknown authenticationOk message type "+g)}return p}parseErrorMessage(d,u,h,g){this.reader.setBuffer(d,h);let p={},m=this.reader.string(1);for(;m!=="\0";)p[m]=this.reader.cstring(),m=this.reader.string(1);let _=p.M,b=g==="notice"?new e.NoticeMessage(u,_):new e.DatabaseError(_,u,g);return b.severity=p.S,b.code=p.C,b.detail=p.D,b.hint=p.H,b.position=p.P,b.internalPosition=p.p,b.internalQuery=p.q,b.where=p.W,b.schema=p.s,b.table=p.t,b.column=p.c,b.dataType=p.d,b.constraint=p.n,b.file=p.F,b.line=p.L,b.routine=p.R,b}};I(i,"Parser");var c=i;s.Parser=c}),oi=ie(s=>{Z(),Object.defineProperty(s,"__esModule",{value:!0}),s.DatabaseError=s.serialize=s.parse=void 0;var e=ni();Object.defineProperty(s,"DatabaseError",{enumerable:!0,get:I(function(){return e.DatabaseError},"get")});var t=_u();Object.defineProperty(s,"serialize",{enumerable:!0,get:I(function(){return t.serialize},"get")});var r=bu();function a(n,o){let i=new r.Parser;return n.on("data",c=>i.parse(c,o)),new Promise(c=>n.on("end",()=>c()))}I(a,"parse"),s.parse=a}),ii={};et(ii,{connect:()=>ci});function ci({socket:s,servername:e}){return s.startTls(e),s}var wu=Ve(()=>{Z(),I(ci,"connect")}),li=ie((s,e)=>{Z();var t=(Tr(),Ne(jo)),r=Nt().EventEmitter,{parse:a,serialize:n}=oi(),o=n.flush(),i=n.sync(),c=n.end(),l=class extends r{constructor(h){super(),h=h||{},this.stream=h.stream||new t.Socket,this._keepAlive=h.keepAlive,this._keepAliveInitialDelayMillis=h.keepAliveInitialDelayMillis,this.lastBuffer=!1,this.parsedStatements={},this.ssl=h.ssl||!1,this._ending=!1,this._emitMessage=!1;var g=this;this.on("newListener",function(p){p==="message"&&(g._emitMessage=!0)})}connect(h,g){var p=this;this._connecting=!0,this.stream.setNoDelay(!0),this.stream.connect(h,g),this.stream.once("connect",function(){p._keepAlive&&p.stream.setKeepAlive(!0,p._keepAliveInitialDelayMillis),p.emit("connect")});let m=I(function(_){p._ending&&(_.code==="ECONNRESET"||_.code==="EPIPE")||p.emit("error",_)},"reportStreamError");if(this.stream.on("error",m),this.stream.on("close",function(){p.emit("end")}),!this.ssl)return this.attachListeners(this.stream);this.stream.once("data",function(_){var b=_.toString("utf8");switch(b){case"S":break;case"N":return p.stream.end(),p.emit("error",new Error("The server does not support SSL connections"));default:return p.stream.end(),p.emit("error",new Error("There was an error establishing an SSL connection"))}var S=(wu(),Ne(ii));let v={socket:p.stream};p.ssl!==!0&&(Object.assign(v,p.ssl),"key"in p.ssl&&(v.key=p.ssl.key)),t.isIP(g)===0&&(v.servername=g);try{p.stream=S.connect(v)}catch(C){return p.emit("error",C)}p.attachListeners(p.stream),p.stream.on("error",m),p.emit("sslconnect")})}attachListeners(h){h.on("end",()=>{this.emit("end")}),a(h,g=>{var p=g.name==="error"?"errorMessage":g.name;this._emitMessage&&this.emit("message",g),this.emit(p,g)})}requestSsl(){this.stream.write(n.requestSsl())}startup(h){this.stream.write(n.startup(h))}cancel(h,g){this._send(n.cancel(h,g))}password(h){this._send(n.password(h))}sendSASLInitialResponseMessage(h,g){this._send(n.sendSASLInitialResponseMessage(h,g))}sendSCRAMClientFinalMessage(h){this._send(n.sendSCRAMClientFinalMessage(h))}_send(h){return this.stream.writable?this.stream.write(h):!1}query(h){this._send(n.query(h))}parse(h){this._send(n.parse(h))}bind(h){this._send(n.bind(h))}execute(h){this._send(n.execute(h))}flush(){this.stream.writable&&this.stream.write(o)}sync(){this._ending=!0,this._send(o),this._send(i)}ref(){this.stream.ref()}unref(){this.stream.unref()}end(){if(this._ending=!0,!this._connecting||!this.stream.writable){this.stream.end();return}return this.stream.write(c,()=>{this.stream.end()})}close(h){this._send(n.close(h))}describe(h){this._send(n.describe(h))}sendCopyFromChunk(h){this._send(n.copyData(h))}endCopyFrom(){this._send(n.copyDone())}sendCopyFail(h){this._send(n.copyFail(h))}};I(l,"Connection");var d=l;e.exports=d}),vu=ie((s,e)=>{Z();var t=Nt().EventEmitter;Es(),Ne(Rr);var r=Ss(),a=iu(),n=du(),o=$a(),i=za(),c=fu(),l=vs(),d=li(),u=class extends t{constructor(p){super(),this.connectionParameters=new i(p),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;var m=p||{};this._Promise=m.Promise||bs.Promise,this._types=new o(m.types),this._ending=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.connection=m.connection||new d({stream:m.stream,ssl:this.connectionParameters.ssl,keepAlive:m.keepAlive||!1,keepAliveInitialDelayMillis:m.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=m.binary||l.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=m.connectionTimeoutMillis||0}_errorAllQueries(p){let m=I(_=>{oe.nextTick(()=>{_.handleError(p,this.connection)})},"enqueueError");this.activeQuery&&(m(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(m),this.queryQueue.length=0}_connect(p){var m=this,_=this.connection;if(this._connectionCallback=p,this._connecting||this._connected){let b=new Error("Client has already been connected. You cannot reuse a client.");oe.nextTick(()=>{p(b)});return}this._connecting=!0,this.connectionTimeoutHandle,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{_._ending=!0,_.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis)),this.host&&this.host.indexOf("/")===0?_.connect(this.host+"/.s.PGSQL."+this.port):_.connect(this.port,this.host),_.on("connect",function(){m.ssl?_.requestSsl():_.startup(m.getStartupConf())}),_.on("sslconnect",function(){_.startup(m.getStartupConf())}),this._attachListeners(_),_.once("end",()=>{let b=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(b),this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(b):this._handleErrorEvent(b):this._connectionError||this._handleErrorEvent(b)),oe.nextTick(()=>{this.emit("end")})})}connect(p){if(p){this._connect(p);return}return new this._Promise((m,_)=>{this._connect(b=>{b?_(b):m()})})}_attachListeners(p){p.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),p.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),p.on("authenticationSASL",this._handleAuthSASL.bind(this)),p.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),p.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),p.on("backendKeyData",this._handleBackendKeyData.bind(this)),p.on("error",this._handleErrorEvent.bind(this)),p.on("errorMessage",this._handleErrorMessage.bind(this)),p.on("readyForQuery",this._handleReadyForQuery.bind(this)),p.on("notice",this._handleNotice.bind(this)),p.on("rowDescription",this._handleRowDescription.bind(this)),p.on("dataRow",this._handleDataRow.bind(this)),p.on("portalSuspended",this._handlePortalSuspended.bind(this)),p.on("emptyQuery",this._handleEmptyQuery.bind(this)),p.on("commandComplete",this._handleCommandComplete.bind(this)),p.on("parseComplete",this._handleParseComplete.bind(this)),p.on("copyInResponse",this._handleCopyInResponse.bind(this)),p.on("copyData",this._handleCopyData.bind(this)),p.on("notification",this._handleNotification.bind(this))}_checkPgPass(p){let m=this.connection;typeof this.password=="function"?this._Promise.resolve().then(()=>this.password()).then(_=>{if(_!==void 0){if(typeof _!="string"){m.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=_}else this.connectionParameters.password=this.password=null;p()}).catch(_=>{m.emit("error",_)}):this.password!==null?p():n(this.connectionParameters,_=>{_!==void 0&&(this.connectionParameters.password=this.password=_),p()})}_handleAuthCleartextPassword(p){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(p){this._checkPgPass(()=>{let m=r.postgresMd5PasswordHash(this.user,this.password,p.salt);this.connection.password(m)})}_handleAuthSASL(p){this._checkPgPass(()=>{this.saslSession=a.startSession(p.mechanisms),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)})}_handleAuthSASLContinue(p){a.continueSession(this.saslSession,this.password,p.data),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}_handleAuthSASLFinal(p){a.finalizeSession(this.saslSession,p.data),this.saslSession=null}_handleBackendKeyData(p){this.processID=p.processID,this.secretKey=p.secretKey}_handleReadyForQuery(p){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:m}=this;this.activeQuery=null,this.readyForQuery=!0,m&&m.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(p){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(p);this.emit("error",p)}}_handleErrorEvent(p){if(this._connecting)return this._handleErrorWhileConnecting(p);this._queryable=!1,this._errorAllQueries(p),this.emit("error",p)}_handleErrorMessage(p){if(this._connecting)return this._handleErrorWhileConnecting(p);let m=this.activeQuery;if(!m){this._handleErrorEvent(p);return}this.activeQuery=null,m.handleError(p,this.connection)}_handleRowDescription(p){this.activeQuery.handleRowDescription(p)}_handleDataRow(p){this.activeQuery.handleDataRow(p)}_handlePortalSuspended(p){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(p){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(p){this.activeQuery.handleCommandComplete(p,this.connection)}_handleParseComplete(p){this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(p){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(p){this.activeQuery.handleCopyData(p,this.connection)}_handleNotification(p){this.emit("notification",p)}_handleNotice(p){this.emit("notice",p)}getStartupConf(){var p=this.connectionParameters,m={user:p.user,database:p.database},_=p.application_name||p.fallback_application_name;return _&&(m.application_name=_),p.replication&&(m.replication=""+p.replication),p.statement_timeout&&(m.statement_timeout=String(parseInt(p.statement_timeout,10))),p.lock_timeout&&(m.lock_timeout=String(parseInt(p.lock_timeout,10))),p.idle_in_transaction_session_timeout&&(m.idle_in_transaction_session_timeout=String(parseInt(p.idle_in_transaction_session_timeout,10))),p.options&&(m.options=p.options),m}cancel(p,m){if(p.activeQuery===m){var _=this.connection;this.host&&this.host.indexOf("/")===0?_.connect(this.host+"/.s.PGSQL."+this.port):_.connect(this.port,this.host),_.on("connect",function(){_.cancel(p.processID,p.secretKey)})}else p.queryQueue.indexOf(m)!==-1&&p.queryQueue.splice(p.queryQueue.indexOf(m),1)}setTypeParser(p,m,_){return this._types.setTypeParser(p,m,_)}getTypeParser(p,m){return this._types.getTypeParser(p,m)}escapeIdentifier(p){return'"'+p.replace(/"/g,'""')+'"'}escapeLiteral(p){for(var m=!1,_="'",b=0;b<p.length;b++){var S=p[b];S==="'"?_+=S+S:S==="\\"?(_+=S+S,m=!0):_+=S}return _+="'",m===!0&&(_=" E"+_),_}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let p=this.activeQuery.submit(this.connection);p&&oe.nextTick(()=>{this.activeQuery.handleError(p,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(p,m,_){var b,S,v,C,T;if(p==null)throw new TypeError("Client was passed a null or undefined query");return typeof p.submit=="function"?(v=p.query_timeout||this.connectionParameters.query_timeout,S=b=p,typeof m=="function"&&(b.callback=b.callback||m)):(v=this.connectionParameters.query_timeout,b=new c(p,m,_),b.callback||(S=new this._Promise((x,R)=>{b.callback=(k,P)=>k?R(k):x(P)}))),v&&(T=b.callback,C=setTimeout(()=>{var x=new Error("Query read timeout");oe.nextTick(()=>{b.handleError(x,this.connection)}),T(x),b.callback=()=>{};var R=this.queryQueue.indexOf(b);R>-1&&this.queryQueue.splice(R,1),this._pulseQueryQueue()},v),b.callback=(x,R)=>{clearTimeout(C),T(x,R)}),this.binary&&!b.binary&&(b.binary=!0),b._result&&!b._result._types&&(b._result._types=this._types),this._queryable?this._ending?(oe.nextTick(()=>{b.handleError(new Error("Client was closed and is not queryable"),this.connection)}),S):(this.queryQueue.push(b),this._pulseQueryQueue(),S):(oe.nextTick(()=>{b.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),S)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(p){if(this._ending=!0,!this.connection._connecting)if(p)p();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),p)this.connection.once("end",p);else return new this._Promise(m=>{this.connection.once("end",m)})}};I(u,"Client");var h=u;h.Query=c,e.exports=h}),Su=ie((s,e)=>{Z();var t=Nt().EventEmitter,r=I(function(){},"NOOP"),a=I((p,m)=>{let _=p.findIndex(m);return _===-1?void 0:p.splice(_,1)[0]},"removeWhere"),n=class{constructor(m,_,b){this.client=m,this.idleListener=_,this.timeoutId=b}};I(n,"IdleItem");var o=n,i=class{constructor(m){this.callback=m}};I(i,"PendingItem");var c=i;function l(){throw new Error("Release called on client which has already been released to the pool.")}I(l,"throwOnDoubleRelease");function d(p,m){if(m)return{callback:m,result:void 0};let _,b,S=I(function(C,T){C?_(C):b(T)},"cb"),v=new p(function(C,T){b=C,_=T}).catch(C=>{throw Error.captureStackTrace(C),C});return{callback:S,result:v}}I(d,"promisify");function u(p,m){return I(function _(b){b.client=m,m.removeListener("error",_),m.on("error",()=>{p.log("additional client error after disconnection due to error",b)}),p._remove(m),p.emit("error",b,m)},"idleListener")}I(u,"makeIdleListener");var h=class extends t{constructor(m,_){super(),this.options=Object.assign({},m),m!=null&&"password"in m&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:m.password}),m!=null&&m.ssl&&m.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||_||xs().Client,this.Promise=this.options.Promise||bs.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(_=>{this._remove(_.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let m=this._pendingQueue.shift();if(this._idle.length){let _=this._idle.pop();clearTimeout(_.timeoutId);let b=_.client;b.ref&&b.ref();let S=_.idleListener;return this._acquireClient(b,m,S,!1)}if(!this._isFull())return this.newClient(m);throw new Error("unexpected condition")}_remove(m){let _=a(this._idle,b=>b.client===m);_!==void 0&&clearTimeout(_.timeoutId),this._clients=this._clients.filter(b=>b!==m),m.end(),this.emit("remove",m)}connect(m){if(this.ending){let S=new Error("Cannot use a pool after calling end on the pool");return m?m(S):this.Promise.reject(S)}let _=d(this.Promise,m),b=_.result;if(this._isFull()||this._idle.length){if(this._idle.length&&oe.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new c(_.callback)),b;let S=I((T,x,R)=>{clearTimeout(C),_.callback(T,x,R)},"queueCallback"),v=new c(S),C=setTimeout(()=>{a(this._pendingQueue,T=>T.callback===S),v.timedOut=!0,_.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return C.unref&&C.unref(),this._pendingQueue.push(v),b}return this.newClient(new c(_.callback)),b}newClient(m){let _=new this.Client(this.options);this._clients.push(_);let b=u(this,_);this.log("checking client timeout");let S,v=!1;this.options.connectionTimeoutMillis&&(S=setTimeout(()=>{this.log("ending client due to timeout"),v=!0,_.connection?_.connection.stream.destroy():_.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),_.connect(C=>{if(S&&clearTimeout(S),_.on("error",b),C)this.log("client failed to connect",C),this._clients=this._clients.filter(T=>T!==_),v&&(C=new Error("Connection terminated due to connection timeout",{cause:C})),this._pulseQueue(),m.timedOut||m.callback(C,void 0,r);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let T=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(_),this._idle.findIndex(x=>x.client===_)!==-1&&this._acquireClient(_,new c((x,R,k)=>k()),b,!1)},this.options.maxLifetimeSeconds*1e3);T.unref(),_.once("end",()=>clearTimeout(T))}return this._acquireClient(_,m,b,!0)}})}_acquireClient(m,_,b,S){S&&this.emit("connect",m),this.emit("acquire",m),m.release=this._releaseOnce(m,b),m.removeListener("error",b),_.timedOut?S&&this.options.verify?this.options.verify(m,m.release):m.release():S&&this.options.verify?this.options.verify(m,v=>{if(v)return m.release(v),_.callback(v,void 0,r);_.callback(void 0,m,m.release)}):_.callback(void 0,m,m.release)}_releaseOnce(m,_){let b=!1;return S=>{b&&l(),b=!0,this._release(m,_,S)}}_release(m,_,b){if(m.on("error",_),m._poolUseCount=(m._poolUseCount||0)+1,this.emit("release",b,m),b||this.ending||!m._queryable||m._ending||m._poolUseCount>=this.options.maxUses){m._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(m),this._pulseQueue();return}if(this._expired.has(m)){this.log("remove expired client"),this._expired.delete(m),this._remove(m),this._pulseQueue();return}let S;this.options.idleTimeoutMillis&&this._isAboveMin()&&(S=setTimeout(()=>{this.log("remove idle client"),this._remove(m)},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&S.unref()),this.options.allowExitOnIdle&&m.unref(),this._idle.push(new o(m,_,S)),this._pulseQueue()}query(m,_,b){if(typeof m=="function"){let v=d(this.Promise,m);return Ua(function(){return v.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),v.result}typeof _=="function"&&(b=_,_=void 0);let S=d(this.Promise,b);return b=S.callback,this.connect((v,C)=>{if(v)return b(v);let T=!1,x=I(R=>{T||(T=!0,C.release(R),b(R))},"onError");C.once("error",x),this.log("dispatching query");try{C.query(m,_,(R,k)=>{if(this.log("query dispatched"),C.removeListener("error",x),!T)return T=!0,C.release(R),R?b(R):b(void 0,k)})}catch(R){return C.release(R),b(R)}}),S.result}end(m){if(this.log("ending"),this.ending){let b=new Error("Called end on pool more than once");return m?m(b):this.Promise.reject(b)}this.ending=!0;let _=d(this.Promise,m);return this._endCallback=_.callback,this._pulseQueue(),_.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((m,_)=>m+(this._expired.has(_)?1:0),0)}get totalCount(){return this._clients.length}};I(h,"Pool");var g=h;e.exports=g}),ui={};et(ui,{default:()=>di});var di,Eu=Ve(()=>{Z(),di={}}),xu=ie((s,e)=>{e.exports={name:"pg",version:"8.8.0",description:"PostgreSQL client - pure javascript & libpq with the same API",keywords:["database","libpq","pg","postgre","postgres","postgresql","rdbms"],homepage:"https://github.com/brianc/node-postgres",repository:{type:"git",url:"git://github.com/brianc/node-postgres.git",directory:"packages/pg"},author:"Brian Carlson <brian.m.carlson@gmail.com>",main:"./lib",dependencies:{"buffer-writer":"2.0.0","packet-reader":"1.0.0","pg-connection-string":"^2.5.0","pg-pool":"^3.5.2","pg-protocol":"^1.5.0","pg-types":"^2.1.0",pgpass:"1.x"},devDependencies:{async:"2.6.4",bluebird:"3.5.2",co:"4.6.0","pg-copy-streams":"0.3.0"},peerDependencies:{"pg-native":">=3.0.1"},peerDependenciesMeta:{"pg-native":{optional:!0}},scripts:{test:"make test-all"},files:["lib","SPONSORS.md"],license:"MIT",engines:{node:">= 8.0.0"},gitHead:"c99fb2c127ddf8d712500db2c7b9a5491a178655"}}),Pu=ie((s,e)=>{Z();var t=Nt().EventEmitter,r=(Es(),Ne(Rr)),a=Ss(),n=e.exports=function(i,c,l){t.call(this),i=a.normalizeQueryConfig(i,c,l),this.text=i.text,this.values=i.values,this.name=i.name,this.callback=i.callback,this.state="new",this._arrayMode=i.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",(function(d){d==="row"&&(this._emitRowEvents=!0)}).bind(this))};r.inherits(n,t);var o={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};n.prototype.handleError=function(i){var c=this.native.pq.resultErrorFields();if(c)for(var l in c){var d=o[l]||l;i[d]=c[l]}this.callback?this.callback(i):this.emit("error",i),this.state="error"},n.prototype.then=function(i,c){return this._getPromise().then(i,c)},n.prototype.catch=function(i){return this._getPromise().catch(i)},n.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise((function(i,c){this._once("end",i),this._once("error",c)}).bind(this)),this._promise)},n.prototype.submit=function(i){this.state="running";var c=this;this.native=i.native,i.native.arrayMode=this._arrayMode;var l=I(function(h,g,p){if(i.native.arrayMode=!1,Ua(function(){c.emit("_done")}),h)return c.handleError(h);c._emitRowEvents&&(p.length>1?g.forEach((m,_)=>{m.forEach(b=>{c.emit("row",b,p[_])})}):g.forEach(function(m){c.emit("row",m,p)})),c.state="end",c.emit("end",p),c.callback&&c.callback(null,p)},"after");if(oe.domain&&(l=oe.domain.bind(l)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));var d=(this.values||[]).map(a.prepareValue);if(i.namedQueries[this.name]){if(this.text&&i.namedQueries[this.name]!==this.text){let h=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return l(h)}return i.native.execute(this.name,d,l)}return i.native.prepare(this.name,this.text,d.length,function(h){return h?l(h):(i.namedQueries[c.name]=c.text,c.native.execute(c.name,d,l))})}else if(this.values){if(!Array.isArray(this.values)){let h=new Error("Query values must be an array");return l(h)}var u=this.values.map(a.prepareValue);i.native.query(this.text,u,l)}else i.native.query(this.text,l)}}),Au=ie((s,e)=>{Z();var t=(Eu(),Ne(ui)),r=$a();xu();var a=Nt().EventEmitter,n=(Es(),Ne(Rr)),o=za(),i=Pu(),c=e.exports=function(l){a.call(this),l=l||{},this._Promise=l.Promise||bs.Promise,this._types=new r(l.types),this.native=new t({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;var d=this.connectionParameters=new o(l);this.user=d.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:d.password}),this.database=d.database,this.host=d.host,this.port=d.port,this.namedQueries={}};c.Query=i,n.inherits(c,a),c.prototype._errorAllQueries=function(l){let d=I(u=>{oe.nextTick(()=>{u.native=this.native,u.handleError(l)})},"enqueueError");this._hasActiveQuery()&&(d(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(d),this._queryQueue.length=0},c.prototype._connect=function(l){var d=this;if(this._connecting){oe.nextTick(()=>l(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(u,h){if(u)return l(u);d.native.connect(h,function(g){if(g)return d.native.end(),l(g);d._connected=!0,d.native.on("error",function(p){d._queryable=!1,d._errorAllQueries(p),d.emit("error",p)}),d.native.on("notification",function(p){d.emit("notification",{channel:p.relname,payload:p.extra})}),d.emit("connect"),d._pulseQueryQueue(!0),l()})})},c.prototype.connect=function(l){if(l){this._connect(l);return}return new this._Promise((d,u)=>{this._connect(h=>{h?u(h):d()})})},c.prototype.query=function(l,d,u){var h,g,p,m,_;if(l==null)throw new TypeError("Client was passed a null or undefined query");if(typeof l.submit=="function")p=l.query_timeout||this.connectionParameters.query_timeout,g=h=l,typeof d=="function"&&(l.callback=d);else if(p=this.connectionParameters.query_timeout,h=new i(l,d,u),!h.callback){let b,S;g=new this._Promise((v,C)=>{b=v,S=C}),h.callback=(v,C)=>v?S(v):b(C)}return p&&(_=h.callback,m=setTimeout(()=>{var b=new Error("Query read timeout");oe.nextTick(()=>{h.handleError(b,this.connection)}),_(b),h.callback=()=>{};var S=this._queryQueue.indexOf(h);S>-1&&this._queryQueue.splice(S,1),this._pulseQueryQueue()},p),h.callback=(b,S)=>{clearTimeout(m),_(b,S)}),this._queryable?this._ending?(h.native=this.native,oe.nextTick(()=>{h.handleError(new Error("Client was closed and is not queryable"))}),g):(this._queryQueue.push(h),this._pulseQueryQueue(),g):(h.native=this.native,oe.nextTick(()=>{h.handleError(new Error("Client has encountered a connection error and is not queryable"))}),g)},c.prototype.end=function(l){var d=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,l));var u;return l||(u=new this._Promise(function(h,g){l=I(p=>p?g(p):h(),"cb")})),this.native.end(function(){d._errorAllQueries(new Error("Connection terminated")),oe.nextTick(()=>{d.emit("end"),l&&l()})}),u},c.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"},c.prototype._pulseQueryQueue=function(l){if(this._connected&&!this._hasActiveQuery()){var d=this._queryQueue.shift();if(!d){l||this.emit("drain");return}this._activeQuery=d,d.submit(this);var u=this;d.once("_done",function(){u._pulseQueryQueue()})}},c.prototype.cancel=function(l){this._activeQuery===l?this.native.cancel(function(){}):this._queryQueue.indexOf(l)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(l),1)},c.prototype.ref=function(){},c.prototype.unref=function(){},c.prototype.setTypeParser=function(l,d,u){return this._types.setTypeParser(l,d,u)},c.prototype.getTypeParser=function(l,d){return this._types.getTypeParser(l,d)}}),En=ie((s,e)=>{Z(),e.exports=Au()}),xs=ie((s,e)=>{Z();var t=vu(),r=vs(),a=li(),n=Su(),{DatabaseError:o}=oi(),i=I(l=>{var d;return d=class extends n{constructor(u){super(u,l)}},I(d,"BoundPool"),d},"poolFactory"),c=I(function(l){this.defaults=r,this.Client=l,this.Query=this.Client.Query,this.Pool=i(this.Client),this._pools=[],this.Connection=a,this.types=ws(),this.DatabaseError=o},"PG");typeof oe.env.NODE_PG_FORCE_NATIVE<"u"?e.exports=new c(En()):(e.exports=new c(t),Object.defineProperty(e.exports,"native",{configurable:!0,enumerable:!1,get(){var l=null;try{l=new c(En())}catch(d){if(d.code!=="MODULE_NOT_FOUND")throw d}return Object.defineProperty(e.exports,"native",{value:l}),l}}))});Z();Z();Tr();qo();Z();var ku=Object.defineProperty,Iu=Object.defineProperties,Cu=Object.getOwnPropertyDescriptors,xn=Object.getOwnPropertySymbols,Du=Object.prototype.hasOwnProperty,Tu=Object.prototype.propertyIsEnumerable,Pn=I((s,e,t)=>e in s?ku(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,"__defNormalProp"),Ru=I((s,e)=>{for(var t in e||(e={}))Du.call(e,t)&&Pn(s,t,e[t]);if(xn)for(var t of xn(e))Tu.call(e,t)&&Pn(s,t,e[t]);return s},"__spreadValues"),Ou=I((s,e)=>Iu(s,Cu(e)),"__spreadProps"),Nu=1008e3,An=new Uint8Array(new Uint16Array([258]).buffer)[0]===2,Lu=new TextDecoder,Va=new TextEncoder,Wr=Va.encode("0123456789abcdef"),Hr=Va.encode("0123456789ABCDEF"),Uu=Va.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),hi=Uu.slice();hi[62]=45;hi[63]=95;var fr,Qr;function mi(s,{alphabet:e,scratchArr:t}={}){if(!fr)if(fr=new Uint16Array(256),Qr=new Uint16Array(256),An)for(let g=0;g<256;g++)fr[g]=Wr[g&15]<<8|Wr[g>>>4],Qr[g]=Hr[g&15]<<8|Hr[g>>>4];else for(let g=0;g<256;g++)fr[g]=Wr[g&15]|Wr[g>>>4]<<8,Qr[g]=Hr[g&15]|Hr[g>>>4]<<8;s.byteOffset%4!==0&&(s=new Uint8Array(s));let r=s.length,a=r>>>1,n=r>>>2,o=t||new Uint16Array(r),i=new Uint32Array(s.buffer,s.byteOffset,n),c=new Uint32Array(o.buffer,o.byteOffset,a),l=e==="upper"?Qr:fr,d=0,u=0,h;if(An)for(;d<n;)h=i[d++],c[u++]=l[h>>>8&255]<<16|l[h&255],c[u++]=l[h>>>24]<<16|l[h>>>16&255];else for(;d<n;)h=i[d++],c[u++]=l[h>>>24]<<16|l[h>>>16&255],c[u++]=l[h>>>8&255]<<16|l[h&255];for(d<<=2;d<r;)o[d]=l[s[d++]];return Lu.decode(o.subarray(0,r))}I(mi,"_toHex");function pi(s,e={}){let t="",r=s.length,a=Nu>>>1,n=Math.ceil(r/a),o=new Uint16Array(n>1?a:r);for(let i=0;i<n;i++){let c=i*a,l=c+a;t+=mi(s.subarray(c,l),Ou(Ru({},e),{scratchArr:o}))}return t}I(pi,"_toHexChunked");function fi(s,e={}){return e.alphabet!=="upper"&&typeof s.toHex=="function"?s.toHex():pi(s,e)}I(fi,"toHex");Z();var gi=class _i{constructor(e,t){this.strings=e,this.values=t}toParameterizedQuery(e={query:"",params:[]}){var a;let{strings:t,values:r}=this;for(let n=0,o=t.length;n<o;n++)if(e.query+=t[n],n<r.length){let i=r[n];if(i instanceof wi)e.query+=i.sql;else if(i instanceof ns)if(i.queryData instanceof _i)i.queryData.toParameterizedQuery(e);else{if((a=i.queryData.params)!=null&&a.length)throw new Error("This query is not composable");e.query+=i.queryData.query}else{let{params:c}=e;c.push(i),e.query+="$"+c.length,(i instanceof se||ArrayBuffer.isView(i))&&(e.query+="::bytea")}}return e}};I(gi,"SqlTemplate");var yi=gi,bi=class{constructor(e){this.sql=e}};I(bi,"UnsafeRawSql");var wi=bi;Z();function Ga(){typeof window<"u"&&typeof document<"u"&&typeof console<"u"&&typeof console.warn=="function"&&console.warn(`          
        ************************************************************
        *                                                          *
        *  WARNING: Running SQL directly from the browser can have *
        *  security implications. Even if your database is         *
        *  protected by Row-Level Security (RLS), use it at your   *
        *  own risk. This approach is great for fast prototyping,  *
        *  but ensure proper safeguards are in place to prevent    *
        *  misuse or execution of expensive SQL queries by your    *
        *  end users.                                              *
        *                                                          *
        *  If you've assessed the risks, suppress this message     *
        *  using the disableWarningInBrowsers configuration        *
        *  parameter.                                              *
        *                                                          *
        ************************************************************`)}I(Ga,"warnIfBrowser");Tr();var ju=Ot($a()),$u=Ot(Ss()),vi=class Si extends Error{constructor(e){super(e),ae(this,"name","NeonDbError"),ae(this,"severity"),ae(this,"code"),ae(this,"detail"),ae(this,"hint"),ae(this,"position"),ae(this,"internalPosition"),ae(this,"internalQuery"),ae(this,"where"),ae(this,"schema"),ae(this,"table"),ae(this,"column"),ae(this,"dataType"),ae(this,"constraint"),ae(this,"file"),ae(this,"line"),ae(this,"routine"),ae(this,"sourceError"),"captureStackTrace"in Error&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Si)}};I(vi,"NeonDbError");var Vt=vi,kn="transaction() expects an array of queries, or a function returning an array of queries",Mu=["severity","code","detail","hint","position","internalPosition","internalQuery","where","schema","table","column","dataType","constraint","file","line","routine"];function Ei(s){return s instanceof se?"\\x"+fi(s):s}I(Ei,"encodeBuffersAsBytea");function ca(s){let{query:e,params:t}=s instanceof yi?s.toParameterizedQuery():s;return{query:e,params:t.map(r=>Ei((0,$u.prepareValue)(r)))}}I(ca,"prepareQuery");function xi(s,{arrayMode:e,fullResults:t,fetchOptions:r,isolationLevel:a,readOnly:n,deferrable:o,authToken:i,disableWarningInBrowsers:c}={}){if(!s)throw new Error("No database connection string was provided to `neon()`. Perhaps an environment variable has not been set?");let l;try{l=ja(s)}catch{throw new Error("Database connection string provided to `neon()` is not a valid URL. Connection string: "+String(s))}let{protocol:d,username:u,hostname:h,port:g,pathname:p}=l;if(d!=="postgres:"&&d!=="postgresql:"||!u||!h||!p)throw new Error("Database connection string format for `neon()` should be: postgresql://user:password@host.tld/dbname?option=value");function m(b,...S){if(!(Array.isArray(b)&&Array.isArray(b.raw)&&Array.isArray(S)))throw new Error('This function can now be called only as a tagged-template function: sql`SELECT ${value}`, not sql("SELECT $1", [value], options). For a conventional function call with value placeholders ($1, $2, etc.), use sql.query("SELECT $1", [value], options).');return new ns(_,new yi(b,S))}I(m,"templateFn"),m.query=(b,S,v)=>new ns(_,{query:b,params:S??[]},v),m.unsafe=b=>new wi(b),m.transaction=async(b,S)=>{if(typeof b=="function"&&(b=b(m)),!Array.isArray(b))throw new Error(kn);b.forEach(T=>{if(!(T instanceof ns))throw new Error(kn)});let v=b.map(T=>T.queryData),C=b.map(T=>T.opts??{});return _(v,C,S)};async function _(b,S,v){let{fetchEndpoint:C,fetchFunction:T}=ct,x=Array.isArray(b)?{queries:b.map(H=>ca(H))}:ca(b),R=r??{},k=e??!1,P=t??!1,O=a,N=n,$=o;v!==void 0&&(v.fetchOptions!==void 0&&(R={...R,...v.fetchOptions}),v.arrayMode!==void 0&&(k=v.arrayMode),v.fullResults!==void 0&&(P=v.fullResults),v.isolationLevel!==void 0&&(O=v.isolationLevel),v.readOnly!==void 0&&(N=v.readOnly),v.deferrable!==void 0&&($=v.deferrable)),S!==void 0&&!Array.isArray(S)&&S.fetchOptions!==void 0&&(R={...R,...S.fetchOptions});let M=i;!Array.isArray(S)&&(S==null?void 0:S.authToken)!==void 0&&(M=S.authToken);let L=typeof C=="function"?C(h,g,{jwtAuth:M!==void 0}):C,B={"Neon-Connection-String":s,"Neon-Raw-Text-Output":"true","Neon-Array-Mode":"true"},U=await Ai(M);U&&(B.Authorization=`Bearer ${U}`),Array.isArray(b)&&(O!==void 0&&(B["Neon-Batch-Isolation-Level"]=O),N!==void 0&&(B["Neon-Batch-Read-Only"]=String(N)),$!==void 0&&(B["Neon-Batch-Deferrable"]=String($))),c||ct.disableWarningInBrowsers||Ga();let W;try{W=await(T??fetch)(L,{method:"POST",body:JSON.stringify(x),headers:B,...R})}catch(H){let Q=new Vt(`Error connecting to database: ${H}`);throw Q.sourceError=H,Q}if(W.ok){let H=await W.json();if(Array.isArray(b)){let Q=H.results;if(!Array.isArray(Q))throw new Vt("Neon internal error: unexpected result format");return Q.map((ce,X)=>{let re=S[X]??{},_e=re.arrayMode??k,le=re.fullResults??P;return la(ce,{arrayMode:_e,fullResults:le,types:re.types})})}else{let Q=S??{},ce=Q.arrayMode??k,X=Q.fullResults??P;return la(H,{arrayMode:ce,fullResults:X,types:Q.types})}}else{let{status:H}=W;if(H===400){let Q=await W.json(),ce=new Vt(Q.message);for(let X of Mu)ce[X]=Q[X]??void 0;throw ce}else{let Q=await W.text();throw new Vt(`Server error (HTTP status ${H}): ${Q}`)}}}return I(_,"execute"),m}I(xi,"neon");var Pi=class{constructor(e,t,r){this.execute=e,this.queryData=t,this.opts=r}then(e,t){return this.execute(this.queryData,this.opts).then(e,t)}catch(e){return this.execute(this.queryData,this.opts).catch(e)}finally(e){return this.execute(this.queryData,this.opts).finally(e)}};I(Pi,"NeonQueryPromise");var ns=Pi;function la(s,{arrayMode:e,fullResults:t,types:r}){let a=new ju.default(r),n=s.fields.map(c=>c.name),o=s.fields.map(c=>a.getTypeParser(c.dataTypeID)),i=e===!0?s.rows.map(c=>c.map((l,d)=>l===null?null:o[d](l))):s.rows.map(c=>Object.fromEntries(c.map((l,d)=>[n[d],l===null?null:o[d](l)])));return t?(s.viaNeonFetch=!0,s.rowAsArray=e,s.rows=i,s._parsers=o,s._types=a,s):i}I(la,"processQueryResult");async function Ai(s){if(typeof s=="string")return s;if(typeof s=="function")try{return await Promise.resolve(s())}catch(e){let t=new Vt("Error getting auth token.");throw e instanceof Error&&(t=new Vt(`Error getting auth token: ${e.message}`)),t}}I(Ai,"getAuthToken");Z();var qu=Ot(xs());Z();var Bu=Ot(xs()),ki=class extends Bu.Client{constructor(e){super(e),this.config=e}get neonConfig(){return this.connection.stream}connect(e){var l,d;let{neonConfig:t}=this;t.forceDisablePgSSL&&(this.ssl=this.connection.ssl=!1),this.ssl&&t.useSecureWebSocket&&console.warn("SSL is enabled for both Postgres (e.g. ?sslmode=require in the connection string + forceDisablePgSSL = false) and the WebSocket tunnel (useSecureWebSocket = true). Double encryption will increase latency and CPU usage. It may be appropriate to disable SSL in the Postgres connection parameters or set forceDisablePgSSL = true.");let r=typeof this.config!="string"&&((l=this.config)==null?void 0:l.host)!==void 0||typeof this.config!="string"&&((d=this.config)==null?void 0:d.connectionString)!==void 0||oe.env.PGHOST!==void 0,a=oe.env.USER??oe.env.USERNAME;if(!r&&this.host==="localhost"&&this.user===a&&this.database===a&&this.password===null)throw new Error(`No database host or connection string was set, and key parameters have default values (host: localhost, user: ${a}, db: ${a}, password: null). Is an environment variable missing? Alternatively, if you intended to connect with these parameters, please set the host to 'localhost' explicitly.`);let n=super.connect(e),o=t.pipelineTLS&&this.ssl,i=t.pipelineConnect==="password";if(!o&&!t.pipelineConnect)return n;let c=this.connection;if(o&&c.on("connect",()=>c.stream.emit("data","S")),i){c.removeAllListeners("authenticationCleartextPassword"),c.removeAllListeners("readyForQuery"),c.once("readyForQuery",()=>c.on("readyForQuery",this._handleReadyForQuery.bind(this)));let u=this.ssl?"sslconnect":"connect";c.on(u,()=>{this.neonConfig.disableWarningInBrowsers||Ga(),this._handleAuthCleartextPassword(),this._handleReadyForQuery()})}return n}async _handleAuthSASLContinue(e){if(typeof crypto>"u"||crypto.subtle===void 0||crypto.subtle.importKey===void 0)throw new Error("Cannot use SASL auth when `crypto.subtle` is not defined");let t=crypto.subtle,r=this.saslSession,a=this.password,n=e.data;if(r.message!=="SASLInitialResponse"||typeof a!="string"||typeof n!="string")throw new Error("SASL: protocol error");let o=Object.fromEntries(n.split(",").map(H=>{if(!/^.=/.test(H))throw new Error("SASL: Invalid attribute pair entry");let Q=H[0],ce=H.substring(2);return[Q,ce]})),i=o.r,c=o.s,l=o.i;if(!i||!/^[!-+--~]+$/.test(i))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing/unprintable");if(!c||!/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(c))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing/not base64");if(!l||!/^[1-9][0-9]*$/.test(l))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: missing/invalid iteration count");if(!i.startsWith(r.clientNonce))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");if(i.length===r.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short");let d=parseInt(l,10),u=se.from(c,"base64"),h=new TextEncoder,g=h.encode(a),p=await t.importKey("raw",g,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),m=new Uint8Array(await t.sign("HMAC",p,se.concat([u,se.from([0,0,0,1])]))),_=m;for(var b=0;b<d-1;b++)m=new Uint8Array(await t.sign("HMAC",p,m)),_=se.from(_.map((H,Q)=>_[Q]^m[Q]));let S=_,v=await t.importKey("raw",S,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),C=new Uint8Array(await t.sign("HMAC",v,h.encode("Client Key"))),T=await t.digest("SHA-256",C),x="n=*,r="+r.clientNonce,R="r="+i+",s="+c+",i="+d,k="c=biws,r="+i,P=x+","+R+","+k,O=await t.importKey("raw",T,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);var N=new Uint8Array(await t.sign("HMAC",O,h.encode(P))),$=se.from(C.map((H,Q)=>C[Q]^N[Q])),M=$.toString("base64");let L=await t.importKey("raw",S,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),B=await t.sign("HMAC",L,h.encode("Server Key")),U=await t.importKey("raw",B,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);var W=se.from(await t.sign("HMAC",U,h.encode(P)));r.message="SASLResponse",r.serverSignature=W.toString("base64"),r.response=k+",p="+M,this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}};I(ki,"NeonClient");var Fu=ki;Tr();var zu=Ot(za());function Ii(s,e){if(e)return{callback:e,result:void 0};let t,r,a=I(function(o,i){o?t(o):r(i)},"cb"),n=new s(function(o,i){r=o,t=i});return{callback:a,result:n}}I(Ii,"promisify");var Ci=class extends qu.Pool{constructor(){super(...arguments),ae(this,"Client",Fu),ae(this,"hasFetchUnsupportedListeners",!1),ae(this,"addListener",this.on)}on(e,t){return e!=="error"&&(this.hasFetchUnsupportedListeners=!0),super.on(e,t)}query(e,t,r){var n;if(!ct.poolQueryViaFetch||this.hasFetchUnsupportedListeners||typeof e=="function")return super.query(e,t,r);typeof t=="function"&&(r=t,t=void 0);let a=Ii(this.Promise,r);r=a.callback;try{let o=new zu.default(this.options),i=encodeURIComponent,c=encodeURI,l=`postgresql://${i(o.user)}:${i(o.password)}@${i(o.host)}/${c(o.database)}`,d=typeof e=="string"?e:e.text,u=t??e.values??[];xi(l,{fullResults:!0,arrayMode:e.rowMode==="array"}).query(d,u,{types:e.types??((n=this.options)==null?void 0:n.types)}).then(h=>r(void 0,h)).catch(h=>r(h))}catch(o){r(o)}return a.result}};I(Ci,"NeonPool");var Vu=Ci;Tr();var Or=Ot(xs());Or.DatabaseError;Or.defaults;Or.escapeIdentifier;Or.escapeLiteral;Or.types;typeof WebSocket<"u"&&(ct.webSocketConstructor=WebSocket);ct.useSecureWebSocket=!0;ct.pipelineConnect=!1;ct.pipelineTLS=!1;ct.disableWarningInBrowsers=!0;let Di="postgresql://postgres:[@SMASIKA!)!)]@db.jxhzveborezjhsmzsgbc.supabase.co:5432/postgres";console.log(" Neon client initializing with URL:",Di.substring(0,50)+"...");if(typeof window<"u"){const s=console.error,e=console.warn,t=console.log,r=new Map,a=(n,o,i)=>n.includes("WebSocket connection to")||n.includes("WebSocket is closed before the connection is established")||n.includes("Failed to construct 'WebSocket'")||n.includes("WebSocket connection")&&n.includes("failed")||o.includes("WebSocket connection to")||o.includes("WebSocket connection")&&o.includes("failed")||o.includes("wss://")&&(o.includes("neon.tech")||o.includes("neon")||o.includes("pooler"))&&(o.includes("failed")||o.includes("error"))||n.includes("@neondatabase/serverless")&&n.includes("Unhandled error")||o.includes("neon.tech")&&o.includes("WebSocket")||o.includes("@neondatabase_serverless.js")||o.includes("neondatabase_serverless.js")||o.includes("@neondatabase")&&(o.includes("WebSocket")||o.includes("wss://"))||i.includes("websocket")&&i.includes("failed")||i.includes("websocket")&&i.includes("neon")||i.includes("wss://")&&i.includes("pooler")&&(i.includes("failed")||i.includes("error"))||i.includes("websocket")&&i.includes("pooler")||i.includes("ep-icy-mouse")||i.includes("ep-")&&i.includes("pooler")||n.includes("connect @")&&i.includes("neondatabase")||o.includes("supabaseClient.ts")&&i.includes("websocket")||i.includes("neondatabase")&&i.includes("websocket")&&i.includes("failed")||i.includes("neondatabase")&&i.includes("wss://")&&i.includes("pooler");console.error=(...n)=>{const o=String(n[0]||""),i=n.map(l=>typeof l=="string"?l:l instanceof Error?l.message+" "+l.stack:typeof l=="object"&&l!==null?JSON.stringify(l):String(l)).join(" "),c=i.toLowerCase();if(a(o,i,c)){const l="websocket_connection_error",d=(r.get(l)||0)+1;r.set(l,d);return}s.apply(console,n)},console.warn=(...n)=>{const o=String(n[0]||""),i=n.map(l=>String(l)).join(" "),c=i.toLowerCase();a(o,i,c)||o.includes("Slow database response")||o.includes("possible cold start")||o.includes("Cold start detected")||i.includes("Database was asleep")||e.apply(console,n)},console.log=(...n)=>{const o=String(n[0]||""),i=n.map(l=>typeof l=="string"?l:l instanceof Error?l.message+" "+l.stack:typeof l=="object"&&l!==null?JSON.stringify(l):String(l)).join(" "),c=i.toLowerCase();a(o,i,c)||t.apply(console,n)},window.addEventListener("unhandledrejection",n=>{const o=n.reason,i=(o==null?void 0:o.message)||String(o||""),c=String(o||"").toLowerCase();(i.includes("WebSocket")||i.includes("neon.tech")||i.includes("pooler")||c.includes("websocket")||c.includes("wss://")||c.includes("neon")&&c.includes("pooler"))&&n.preventDefault()}),window.addEventListener("error",n=>{const o=n.message||String(n.error||""),i=o.toLowerCase();(i.includes("websocket")||i.includes("wss://")||i.includes("neon")&&i.includes("pooler")||o.includes("WebSocket connection to"))&&n.preventDefault()},!0)}let Ti,Ye;console.log(" Using Neon WebSocket Pooler for browser-compatible database connections");console.log("  Note: WebSocket pooler enabled for CORS-free browser access");try{Ye=new Vu({connectionString:Di,max:10,idleTimeoutMillis:3e4,connectionTimeoutMillis:6e4,maxUses:7500,statement_timeout:6e4,keepAlive:!0,keepAliveInitialDelayMillis:1e4}),Ye.on("error",s=>{const e=(s==null?void 0:s.message)||String(s||""),t=String(s||"").toLowerCase();e.includes("WebSocket")||e.includes("connection terminated")||e.includes("ECONNRESET")||e.includes("socket hang up")||t.includes("websocket")||t.includes("wss://")||t.includes("neon")&&t.includes("pooler")||t.includes("failed")&&(t.includes("websocket")||t.includes("wss://"))||console.warn(" Unexpected pool error (connection will be recreated):",e)}),Ye.on("connect",()=>{}),Ye.on("remove",()=>{}),Ti=async(s,...e)=>{let t=s[0];for(let a=0;a<e.length;a++){const n=e[a];let o;n==null?o="NULL":typeof n=="string"?o=`'${n.replace(/'/g,"''")}'`:typeof n=="boolean"?o=n?"TRUE":"FALSE":n instanceof Date?o=`'${n.toISOString()}'`:Array.isArray(n)?o=`ARRAY[${n.map(i=>`'${String(i).replace(/'/g,"''")}'`).join(",")}]`:typeof n=="object"?o=`'${JSON.stringify(n).replace(/'/g,"''")}'::jsonb`:o=String(n),t+=o+s[a+1]}return(await Ye.query(t)).rows},console.log(" Neon WebSocket Pool created successfully"),console.log("  Pool config: max=10, idle=30s, timeout=30s, statement_timeout=60s"),console.log("  Note: Transient errors are automatically retried - no action needed"),setTimeout(async()=>{try{console.log(" Warming up connection pool..."),await Ye.query("SELECT 1"),console.log(" Connection pool warmed up successfully")}catch{console.log("  Pool warmup deferred - will connect on first query")}},1e3),setInterval(async()=>{try{await Ye.query("SELECT 1"),console.log(" Database keep-alive ping successful")}catch(s){console.debug(" Keep-alive ping failed (will retry):",Dt(s))}},4*60*1e3)}catch(s){throw console.error(" Failed to create Neon pool:",s),s}const Dt=s=>{if(!s)return"Unknown error";if(s instanceof Event)return`Connection error: ${s.type||"Unknown event"}`;if(s instanceof Error)return s.message||"Unknown error";if(typeof s=="object"&&s.message)return String(s.message);if(typeof s=="string")return s;try{const e=JSON.stringify(s);if(e&&e!=="{}")return e}catch{}return"Unknown error occurred"},ua=s=>{var a,n,o;if(s instanceof Event)return!0;const e=((a=s==null?void 0:s.message)==null?void 0:a.toLowerCase())||"",t=((n=s==null?void 0:s.name)==null?void 0:n.toLowerCase())||"",r=((o=s==null?void 0:s.type)==null?void 0:o.toLowerCase())||"";return e.includes("network")||e.includes("err_network_changed")||e.includes("err_name_not_resolved")||e.includes("err_internet_disconnected")||e.includes("err_connection_closed")||e.includes("err_connection_refused")||e.includes("err_connection_reset")||e.includes("failed to fetch")||e.includes("network request failed")||e.includes("websocket")||e.includes("connection lost")||e.includes("connection terminated")||e.includes("connection closed")||e.includes("socket closed")||e.includes("socket hang up")||e.includes("econnreset")||e.includes("epipe")||e.includes("timeout")||e.includes("timed out")||e.includes("deadline")||r.includes("error")||t.includes("networkerror")||t.includes("typeerror")&&e.includes("fetch")},Ps=async(s,e=[],t=!1,r=0)=>{try{return(await Ye.query(s)).rows||[]}catch(c){const l=Dt(c),d=l.includes("400")||(c==null?void 0:c.status)===400||(c==null?void 0:c.statusCode)===400,u=ua(c),h=l.toLowerCase().includes("connection terminated"),g=l.toLowerCase().includes("timeout"),p=l.includes("WebSocket")||l.includes("wss://");if(d&&r<5||u&&r<5||h&&r<5||g&&r<5||p&&r<5){if(h&&!t)console.warn(` Connection terminated (attempt ${r+1}/5)`),console.warn(" Reconnecting to database pool...");else if(u&&!t){const b=Dt(c);console.warn(` Network error detected (attempt ${r+1}/5): ${b}`),console.warn(" Tip: Check your internet connection. Retrying...")}const _=u||h||g?800*2:800;return await new Promise(b=>setTimeout(b,_*(r+1))),Ps(s,e,t,r+1)}if(!t){const _=Dt(c);g?(console.error(" Database connection timeout after",5,"retries"),console.error(" Possible causes:"),console.error("   - Database is cold-starting (first request after idle period)"),console.error("   - Network latency is high"),console.error("   - Query is too complex"),console.error("Error details:",_)):u?(console.error(" Network connection failed after",5,"retries"),console.error(" Please check your internet connection and try again"),console.error("Error details:",_)):d?console.error(" Persistent 400 error after",5,"retries:",_):console.error(" SQL Error:",_);const b=(c==null?void 0:c.code)||"";b==="42703"?(console.error(" COLUMN ERROR - Full Query:",s),console.error(" Error Code:",b)):b&&b!=="42P01"&&console.error("Code:",b,"| Query:",s.substring(0,100))}throw c}};class Gu{constructor(e){me(this,"tableName");me(this,"selectFields","*");me(this,"whereConditions",[]);me(this,"orderByClause","");me(this,"limitClause","");me(this,"rangeClause",null);me(this,"suppressErrors",!1);me(this,"countMode",null);me(this,"headMode",!1);me(this,"joins",[]);this.tableName=e,this.isInsert=!1,this.isUpdate=!1,this.isUpsert=!1,this.isDelete=!1,this.insertData=null,this.updateData=null,this.deleteData=null}select(e="*",t){if(t!=null&&t.count&&(this.countMode=t.count),t!=null&&t.head&&(this.headMode=!0),e.includes("(")&&e.includes(")")){console.log(" Parsing PostgREST relationship syntax:",e.substring(0,150));const r=(u,h)=>{let g=1;for(let p=h+1;p<u.length;p++)if(u[p]==="(")g++;else if(u[p]===")"&&(g--,g===0))return p;return-1},a=u=>{let h=u;const g=/(\w+):(\w+)\s*\(/g;let p,m=10;for(;m-- >0&&(p=g.exec(h))!==null;){const b=p.index+p[0].length-1,S=r(h,b);if(S!==-1){const v=h.substring(p.index,S+1);h=h.replace(v,""),g.lastIndex=0}else g.lastIndex=p.index+1}return h.split(",").map(b=>b.trim()).filter(b=>b&&b.length>0&&/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(b))},n=[];let o=e;const i=/(\w+):(\w+)!(\w+)\s*\(/g;let c;for(;(c=i.exec(o))!==null;){const[u,h,g,p]=c,m=c.index+u.length-1,_=r(o,m);if(_===-1){console.warn(` [Explicit FK] Could not find matching parenthesis for: ${u}`),i.lastIndex=0;continue}const b=o.substring(c.index,_+1),S=o.substring(m+1,_),v=["inner","left","right","outer","full"];let C;v.includes(p.toLowerCase())?(C=`${h}_id`,console.log(` [JOIN Type] Detected ${p.toUpperCase()} JOIN, inferring FK: ${C}`)):C=p;const T=a(S);console.log(` [Explicit FK] Alias: ${h}, Table: ${g}, FK: ${C}, Columns: ${T.join(", ")}`),n.push({alias:h,table:g,foreignKey:C,columns:T}),o=o.replace(b,""),i.lastIndex=0}const l=/(\w+):(\w+)\s*\(/g;for(;(c=l.exec(o))!==null;){const[u,h,g]=c;if(n.some(T=>T.alias===h&&T.table===g)){l.lastIndex=0;continue}const p=c.index+u.length-1,m=r(o,p);if(m===-1){console.warn(` [Inferred FK] Could not find matching parenthesis for: ${u}`),l.lastIndex=0;continue}const _=o.substring(c.index,m+1),b=o.substring(p+1,m),S={lats_categories:"category_id",lats_category:"category_id",categories:"category_id",category:"category_id",lats_product_variants:"product_id",product_variants:"product_id",variants:"product_id"};let v=S[h]||S[g];if(!v&&(v=`${h}_id`,["variants","items","details","lines"].some(R=>h.includes(R)||g.includes(`_${R}`)))){const R=/^(.+)_(variants|items|details|lines)$/,k=g.match(R);if(k){const O=k[1].split("_");v=`${O[O.length-1]}_id`,console.log(` [FK Inference] Child table: ${g}, Alias: ${h}, Inferred FK: ${v}`)}}const C=a(b);console.log(` [Inferred FK] Alias: ${h}, Table: ${g}, FK: ${v}, Columns: ${C.join(", ")}`),n.push({alias:h,table:g,foreignKey:v,columns:C}),o=o.replace(_,""),l.lastIndex=0}const d=/(\w+)\s*\(/g;for(;(c=d.exec(o))!==null;){const[u,h]=c;if(n.some(x=>x.alias===h)){d.lastIndex=0;continue}const g=c.index+u.length-1,p=r(o,g);if(p===-1){console.warn(` [Simple Syntax] Could not find matching parenthesis for: ${u}`),d.lastIndex=0;continue}const m=o.substring(c.index,p+1),_=o.substring(g+1,p),b=h,S=h;let C={lats_categories:"category_id",lats_category:"category_id",categories:"category_id",category:"category_id",lats_product_variants:"product_id",product_variants:"product_id",variants:"product_id"}[h];C||(C=`${h}_id`,h.endsWith("s")&&h.length>1&&(C=`${h.slice(0,-1)}_id`));const T=a(_);console.log(` [Simple Syntax] Table: ${S}, Inferred FK: ${C}`),n.push({alias:b,table:S,foreignKey:C,columns:T}),o=o.replace(m,""),d.lastIndex=0}if(o=o.replace(/,\s*,/g,",").replace(/,\s*$/,"").replace(/^\s*,/,"").replace(/[()]/g,"").trim(),this.joins=n.map(u=>({table:u.table,alias:u.alias,on:u.foreignKey,columns:u.columns.filter(h=>h&&typeof h=="string"&&h.length>0&&h!=="undefined")})),o&&o!=="*"&&o.length>0){const u=o.split(",").map(h=>h.trim()).filter(h=>h&&h.length>0&&/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(h));u.length>0?this.selectFields=u.map(h=>h==="*"?`${this.tableName}.*`:`${this.tableName}.${h} as ${h}`).join(", "):this.selectFields=`${this.tableName}.*`}else this.selectFields=`${this.tableName}.*`;for(const u of this.joins){const h=u.columns.filter(g=>g&&typeof g=="string"&&g.length>0&&g!=="undefined");if(h.length>0){const g=h.map(p=>`'${p}', ${u.alias}.${p}`).join(", ");this.selectFields+=`, json_build_object(${g}) as ${u.alias}`}else this.selectFields+=`, row_to_json(${u.alias}.*) as ${u.alias}`}console.log(" Parsed JOINs:",this.joins),console.log(" Select fields:",this.selectFields)}else this.selectFields=e;return this}qualifyColumn(e){return this.joins.length>0&&!e.includes(".")?`${this.tableName}.${e}`:e}eq(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} = ${this.formatValue(t)}`),this}neq(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} != ${this.formatValue(t)}`),this}gt(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} > ${this.formatValue(t)}`),this}gte(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} >= ${this.formatValue(t)}`),this}lt(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} < ${this.formatValue(t)}`),this}lte(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} <= ${this.formatValue(t)}`),this}like(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} LIKE ${this.formatValue(t)}`),this}ilike(e,t){return this.whereConditions.push(`${this.qualifyColumn(e)} ILIKE ${this.formatValue(t)}`),this}is(e,t){return t===null?this.whereConditions.push(`${this.qualifyColumn(e)} IS NULL`):this.whereConditions.push(`${this.qualifyColumn(e)} = ${this.formatValue(t)}`),this}in(e,t){if(!t||t.length===0)return this.whereConditions.push("1 = 0"),this;const r=t.map(a=>this.formatValue(a)).join(", ");return this.whereConditions.push(`${this.qualifyColumn(e)} IN (${r})`),this}order(e,t){const r=(t==null?void 0:t.ascending)===!1?"DESC":"ASC",a=this.joins.length>0&&!e.includes(".")?`${this.tableName}.${e}`:e;return this.orderByClause=`ORDER BY ${a} ${r}`,this}limit(e){return this.limitClause=`LIMIT ${e}`,this}range(e,t){return this.rangeClause={from:e,to:t},this}single(){return this.limitClause="LIMIT 1",this.then(e=>{const t=this.isInsert,r=!1;return t&&r&&console.log(" [single()] Processing result:",{hasData:!!e.data,dataType:Array.isArray(e.data)?"array":typeof e.data,dataLength:Array.isArray(e.data)?e.data.length:"N/A",hasError:!!e.error,error:e.error}),e.error?{data:null,error:e.error}:e.data&&Array.isArray(e.data)?e.data.length>0?{data:e.data[0],error:null}:t&&r?(console.error(" [single()] INSERT returned empty array - possible RLS issue"),{data:null,error:{message:"No data returned from insert. Check RLS policies and database triggers."}}):{data:null,error:{message:"No rows found",code:"PGRST116"}}:e.data&&typeof e.data=="object"?{data:e.data,error:null}:{data:null,error:{message:"No data returned from operation"}}})}maybeSingle(){return this.single()}formatValue(e){return e==null?"NULL":typeof e=="string"?`'${e.replace(/'/g,"''")}'`:typeof e=="boolean"?e?"TRUE":"FALSE":e instanceof Date?`'${e.toISOString()}'`:Array.isArray(e)?e.length===0||typeof e[0]=="string"?(e.map(t=>`"${String(t).replace(/"/g,'\\"')}"`).join(","),`ARRAY[${e.map(t=>`'${String(t).replace(/'/g,"''")}'`).join(",")}]`):`'${JSON.stringify(e).replace(/'/g,"''")}'::jsonb`:typeof e=="object"?`'${JSON.stringify(e).replace(/'/g,"''")}'::jsonb`:String(e)}buildQuery(){if(this.headMode&&this.countMode){let t=`SELECT COUNT(*) as count FROM ${this.tableName}`;return this.whereConditions.length>0&&(t+=` WHERE ${this.whereConditions.join(" AND ")}`),t}let e=`SELECT ${this.selectFields} FROM ${this.tableName}`;for(const t of this.joins)["variants","items","details","lines","payments","images","transactions","orders","sales"].some(n=>t.alias.includes(n)||t.table.includes(`_${n}`)||t.table.endsWith("_"+n))||!t.on.endsWith("_id")?e+=` LEFT JOIN ${t.table} AS ${t.alias} ON ${this.tableName}.id = ${t.alias}.${t.on}`:e+=` LEFT JOIN ${t.table} AS ${t.alias} ON ${this.tableName}.${t.on} = ${t.alias}.id`;if(this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),this.orderByClause&&(e+=` ${this.orderByClause}`),this.rangeClause){const t=this.rangeClause.from,r=this.rangeClause.to-this.rangeClause.from+1;e+=` LIMIT ${r} OFFSET ${t}`}else this.limitClause&&(e+=` ${this.limitClause}`);return this.joins.length>0,e}then(e,t){return this.execute().then(e,t)}async execute(){let e;const t=this.isInsert;if(this.isUpsert){const a=this.upsertData,n=this.upsertOptions;if(Array.isArray(a)){if(a.length===0)return{data:[],error:null};const o=new Set;a.forEach(h=>{Object.entries(h).forEach(([g,p])=>{p!==void 0&&o.add(g)})});const i=Array.from(o),c=i.join(", "),l=a.map(h=>`(${i.map(p=>{const m=h[p];return m!==void 0?this.formatValue(m):"NULL"}).join(", ")})`).join(", "),d=(n==null?void 0:n.onConflict)||i.join(","),u=i.map(h=>`${h} = EXCLUDED.${h}`).join(", ");e=`INSERT INTO ${this.tableName} (${c}) VALUES ${l} ON CONFLICT (${d}) DO UPDATE SET ${u} RETURNING *`}else{const o=Object.fromEntries(Object.entries(a).filter(([u,h])=>h!==void 0)),i=Object.keys(o).join(", "),c=Object.values(o).map(u=>this.formatValue(u)).join(", "),l=(n==null?void 0:n.onConflict)||Object.keys(o)[0],d=Object.entries(o).map(([u,h])=>`${u} = ${this.formatValue(h)}`).join(", ");e=`INSERT INTO ${this.tableName} (${i}) VALUES (${c}) ON CONFLICT (${l}) DO UPDATE SET ${d} RETURNING *`}}else if(this.isInsert){const a=this.insertData;if(Array.isArray(a)){if(a.length===0)return{data:[],error:null};const n=new Set;a.forEach(l=>{Object.entries(l).forEach(([d,u])=>{u!==void 0&&n.add(d)})});const o=Array.from(n),i=o.join(", "),c=a.map(l=>`(${o.map(u=>{const h=l[u];return h!==void 0?this.formatValue(h):"NULL"}).join(", ")})`).join(", ");e=`INSERT INTO ${this.tableName} (${i}) VALUES ${c} RETURNING *`}else{const n=Object.fromEntries(Object.entries(a).filter(([c,l])=>l!==void 0)),o=Object.keys(n).join(", "),i=Object.values(n).map(c=>this.formatValue(c)).join(", ");e=`INSERT INTO ${this.tableName} (${o}) VALUES (${i}) RETURNING *`}}else if(this.isUpdate){const a=this.updateData,n=Object.entries(a).filter(([o,i])=>i!==void 0).map(([o,i])=>`${o} = ${this.formatValue(i)}`).join(", ");e=`UPDATE ${this.tableName} SET ${n}`,this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),e+=" RETURNING *"}else this.isDelete?(e=`DELETE FROM ${this.tableName}`,this.whereConditions.length>0&&(e+=` WHERE ${this.whereConditions.join(" AND ")}`),e+=" RETURNING *"):e=this.buildQuery();const r=!1;try{!this.suppressErrors&&r&&console.log(" [SQL Query]:",e.substring(0,300)+(e.length>300?"...":""));let a=await Ps(e,[],this.suppressErrors),n=null;return this.headMode&&this.countMode&&a&&a.length>0&&(n=parseInt(a[0].count,10),a=null),{data:a,error:null,count:n}}catch(a){const n=Dt(a),o=(a==null?void 0:a.code)||"",i=n.includes("does not exist")||n.includes("relation")||o==="42P01"||n.includes("column")||o==="42703",c=n.includes("400")||(a==null?void 0:a.status)===400||(a==null?void 0:a.statusCode)===400;return!this.suppressErrors&&!i&&r&&(console.error(` Query failed on '${this.tableName}':`,n),c&&(console.error(" Failing SQL Query:",e),console.error(" Error Code:",o),console.error(" Error Details:",a))),o==="42703"&&r&&(console.error(" COLUMN ERROR - Table:",this.tableName),console.error(" COLUMN ERROR - Full Query:",e),console.error(" COLUMN ERROR - Error:",n)),{data:null,error:{message:n,code:o||"400"},count:null}}}catch(e){return this.then(void 0,e)}resetOperationFlags(){this.isInsert=!1,this.isUpdate=!1,this.isUpsert=!1,this.isDelete=!1,this.insertData=null,this.updateData=null,this.deleteData=null}insert(e){return this.resetOperationFlags(),this.insertData=e,this.isInsert=!0,this}update(e){return this.resetOperationFlags(),this.updateData=e,this.isUpdate=!0,this}delete(){return this.resetOperationFlags(),this.isDelete=!0,this}upsert(e,t){return this.resetOperationFlags(),this.upsertData=e,this.upsertOptions=t,this.isUpsert=!0,this}match(e){return Object.entries(e).forEach(([t,r])=>{this.eq(t,r)}),this}not(e,t,r){return t==="is"&&r==null?this.whereConditions.push(`${this.qualifyColumn(e)} IS NOT NULL`):this.whereConditions.push(`NOT (${this.qualifyColumn(e)} ${t} ${this.formatValue(r)})`),this}or(e){const r=e.split(",").map(a=>{const n=a.trim().match(/^(\w+)\.(eq|neq|gt|gte|lt|lte|like|ilike|is)\.(.+)$/);if(n){const[,o,i,c]=n;let l="=";switch(i){case"eq":l="=";break;case"neq":l="!=";break;case"gt":l=">";break;case"gte":l=">=";break;case"lt":l="<";break;case"lte":l="<=";break;case"like":l="LIKE";break;case"ilike":l="ILIKE";break;case"is":l="IS";break}return i==="is"&&c.toLowerCase()==="null"?`${o} IS NULL`:`${o} ${l} ${this.formatValue(c)}`}return a.trim()});return this.whereConditions.push(`(${r.join(" OR ")})`),this}filter(e,t,r){return this.whereConditions.push(`${e} ${t} ${this.formatValue(r)}`),this}contains(e,t){return this.whereConditions.push(`${e} @> ${this.formatValue(t)}`),this}containedBy(e,t){return this.whereConditions.push(`${e} <@ ${this.formatValue(t)}`),this}rangeGt(e,t){return this.whereConditions.push(`${e} >> ${this.formatValue(t)}`),this}rangeGte(e,t){return this.whereConditions.push(`${e} >>= ${this.formatValue(t)}`),this}rangeLt(e,t){return this.whereConditions.push(`${e} << ${this.formatValue(t)}`),this}rangeLte(e,t){return this.whereConditions.push(`${e} <<= ${this.formatValue(t)}`),this}rangeAdjacent(e,t){return this.whereConditions.push(`${e} -|- ${this.formatValue(t)}`),this}overlaps(e,t){return this.whereConditions.push(`${e} && ${this.formatValue(t)}`),this}textSearch(e,t){return this.whereConditions.push(`to_tsvector(${e}) @@ plainto_tsquery(${this.formatValue(t)})`),this}csv(){return this}}const os={signInWithPassword:async({email:s,password:e})=>{try{console.log(" Attempting login with:",{email:s,password:e});const t=s.replace(/'/g,"''"),r=e.replace(/'/g,"''"),a=`
        SELECT id, email, full_name, role, is_active, created_at, updated_at 
        FROM users 
        WHERE email = '${t}'
        AND password = '${r}'
        AND is_active = true
        LIMIT 1
      `,o=(await Ye.query(a)).rows;if(console.log(" Login query result:",{result:o,length:o==null?void 0:o.length}),o&&Array.isArray(o)&&o.length>0){const i=o[0],c={access_token:btoa(JSON.stringify({userId:i.id,email:i.email})),refresh_token:btoa(JSON.stringify({userId:i.id})),expires_at:Date.now()+36e5,user:i};return localStorage.setItem("supabase.auth.session",JSON.stringify(c)),{data:{user:i,session:c},error:null}}return{data:{user:null,session:null},error:{message:"Invalid login credentials"}}}catch(t){return console.error("Auth error:",t),{data:{user:null,session:null},error:{message:t.message}}}},signIn:async s=>os.signInWithPassword(s),signUp:async({email:s,password:e,options:t})=>{try{const r=(t==null?void 0:t.data)||{},a=r.full_name||"",n=r.role||"customer-care",o=s.replace(/'/g,"''"),i=e.replace(/'/g,"''"),c=a.replace(/'/g,"''"),l=n.replace(/'/g,"''"),d=`
        INSERT INTO users (email, password, full_name, role, is_active, created_at, updated_at)
        VALUES ('${o}', '${i}', '${c}', '${l}', true, NOW(), NOW())
        RETURNING id, email, full_name, role, is_active, created_at, updated_at
      `,u=await Ye.query(d);return u.rows&&u.rows.length>0?{data:{user:u.rows[0]},error:null}:{data:null,error:{message:"Failed to create user"}}}catch(r){return console.error("Sign up error:",r),{data:null,error:{message:r.message}}}},signOut:async()=>(localStorage.removeItem("supabase.auth.session"),{error:null}),getSession:async()=>{try{const s=localStorage.getItem("supabase.auth.session");if(s){const e=JSON.parse(s);if(e.expires_at>Date.now())return{data:{session:e},error:null}}return{data:{session:null},error:null}}catch{return{data:{session:null},error:null}}},getUser:async()=>{try{const s=localStorage.getItem("supabase.auth.session");if(s){const e=JSON.parse(s);if(e.expires_at>Date.now())return{data:{user:e.user},error:null}}return{data:{user:null},error:null}}catch{return{data:{user:null},error:null}}},onAuthStateChange:s=>(os.getSession().then(({data:e})=>{e.session?s("SIGNED_IN",e.session):s("SIGNED_OUT",null)}),{data:{subscription:{unsubscribe:()=>{}}}}),updateUser:async s=>{try{const e=localStorage.getItem("supabase.auth.session");if(!e)return{data:null,error:{message:"Not authenticated"}};const t=JSON.parse(e),r=t.user.id,n=`
        UPDATE users 
        SET ${Object.entries(s).map(([i,c])=>typeof c=="string"?`${i} = '${c.replace(/'/g,"''")}'`:`${i} = ${c}`).join(", ")}, updated_at = NOW()
        WHERE id = '${r}'
        RETURNING id, email, full_name, role, is_active, created_at, updated_at
      `,o=await Ps(n);return o&&o.length>0?(t.user=o[0],localStorage.setItem("supabase.auth.session",JSON.stringify(t)),{data:{user:o[0]},error:null}):{data:null,error:{message:"Failed to update user"}}}catch(e){return console.error("Update user error:",e),{data:null,error:{message:e.message}}}},setSession:async s=>(s&&localStorage.setItem("supabase.auth.session",JSON.stringify(s)),{data:{session:s},error:null}),refreshSession:async()=>{const{data:s}=await os.getSession();return s.session?(s.session.expires_at=Date.now()+36e5,localStorage.setItem("supabase.auth.session",JSON.stringify(s.session)),{data:s,error:null}):{data:{session:null,user:null},error:{message:"No session to refresh"}}}},Wu={from:s=>({upload:async(e,t,r)=>{try{console.log(" Storage upload:",{bucket:s,path:e,fileSize:t.size});const a=t instanceof File?t:new File([t],e.split("/").pop()||"file",{type:t.type}),{WhatsAppMediaStorageService:n}=await z(()=>import("./whatsappMediaStorage-31677baa.js"),["assets/whatsappMediaStorage-31677baa.js","assets/supabase-cf010ec4.js"]),o=await n.uploadMedia(a);return o.success&&o.url?(localStorage.setItem(`storage:${s}:${e}`,o.url),{data:{path:e,id:e,fullPath:e},error:null}):{data:null,error:{message:o.error||"Upload failed",statusCode:"400"}}}catch(a){return console.error(" Storage upload error:",a),{data:null,error:{message:a.message||"Upload failed",statusCode:"500"}}}},download:()=>Promise.resolve({data:null,error:null}),list:()=>Promise.resolve({data:[],error:null}),remove:async e=>{try{const{WhatsAppMediaStorageService:t}=await z(()=>import("./whatsappMediaStorage-31677baa.js"),["assets/whatsappMediaStorage-31677baa.js","assets/supabase-cf010ec4.js"]);for(const r of e){const a=localStorage.getItem(`storage:${s}:${r}`);a&&(await t.deleteMedia(a),localStorage.removeItem(`storage:${s}:${r}`))}return{data:null,error:null}}catch(t){return{data:null,error:{message:t.message}}}},createSignedUrl:()=>Promise.resolve({data:null,error:null}),getPublicUrl:e=>{const t=localStorage.getItem(`storage:${s}:${e}`)||"";return console.log(" Getting public URL:",{bucket:s,path:e,url:t.substring(0,50)+"..."}),{data:{publicUrl:t}}}})},da=()=>({on:()=>da(),subscribe:()=>da(),unsubscribe:()=>Promise.resolve()}),Hu=async(s,e)=>{try{const t=o=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o),r=e?Object.entries(e).map(([o,i])=>{if(i===null)return"NULL";if(typeof i=="boolean")return i?"TRUE":"FALSE";if(typeof i=="number")return String(i);if(typeof i=="string"){const c=i.replace(/'/g,"''");return(o.endsWith("_id")||o.endsWith("_id_param"))&&t(i)?`'${c}'::uuid`:`'${c}'::text`}return String(i)}).join(", "):"",a=`SELECT * FROM ${s}(${r})`;return{data:await Ps(a,[],!1),error:null}}catch(t){const r=Dt(t);return console.error(` RPC Error calling ${s}:`,r),console.error("   Params:",e),{data:null,error:{message:r,code:(t==null?void 0:t.code)||"400"}}}},w={from:s=>new Gu(s),auth:os,storage:Wu,rpc:Hu,channel:da};async function Ri(s,e=3,t=1e3){let r;for(let a=0;a<e;a++)try{return await s()}catch(n){if(r=n,n&&typeof n=="object"){const u=Dt(n);if(u.includes("401")||u.includes("403")||u.includes("Invalid")||u.includes("not found"))throw n;ua(n)&&a<e-1&&console.warn(` Network error in retryWithBackoff (attempt ${a+1}/${e})`)}if(a===e-1)throw console.error(` All retry attempts exhausted (${e})`),r;const c=(ua(r)?t*2:t)*Math.pow(2,a),l=Math.random()*.3*c,d=Math.round(c+l);console.log(` Retry attempt ${a+1}/${e} after ${d}ms`),await new Promise(u=>setTimeout(u,d))}throw r}async function Qu(){try{const s=await Ye.query("SELECT 1 as test");return s.rows&&s.rows.length>0?{success:!0,message:"Database connection successful",details:{connected:!0}}:{success:!1,message:"Database query returned no results",details:{connected:!1}}}catch(s){return console.error("Database connection test failed:",s),{success:!1,message:`Database connection failed: ${s.message}`,details:{error:s.message}}}}const S0=Object.freeze(Object.defineProperty({__proto__:null,default:w,get pool(){return Ye},retryWithBackoff:Ri,get sql(){return Ti},supabase:w,testSupabaseConnection:Qu},Symbol.toStringTag,{value:"Module"}));class Ku{constructor(){this.cachedInfo=null,this.cacheTimestamp=0,this.CACHE_DURATION=5*60*1e3}async getBusinessInfo(){const e=Date.now();if(this.cachedInfo&&e-this.cacheTimestamp<this.CACHE_DURATION)return this.cachedInfo;try{const{data:r,error:a}=await w.from("lats_pos_general_settings").select("business_name, business_address, business_phone, business_email, business_website, business_logo").limit(1).single();if(!a&&r)return this.cachedInfo={name:r.business_name||"inauzwa",address:r.business_address||"Dar es Salaam, Tanzania",phone:r.business_phone||"+255 123 456 789",email:r.business_email||void 0,website:r.business_website||void 0,logo:r.business_logo||null},this.cacheTimestamp=e,this.cachedInfo;a&&console.warn(" Error loading business info from lats_pos_general_settings:",a)}catch(r){console.warn(" Could not load business info from lats_pos_general_settings:",r)}return{name:"inauzwa",address:"Dar es Salaam, Tanzania",phone:"+255 123 456 789",email:"info@mystore.com",website:void 0,logo:null}}clearCache(){this.cachedInfo=null,this.cacheTimestamp=0}async updateBusinessInfo(e){try{const t={business_name:e.name,business_address:e.address,business_phone:e.phone,business_email:e.email,business_website:e.website,business_logo:e.logo},{data:r}=await w.from("lats_pos_general_settings").select("id").limit(1).single();if(!r)return console.error("No settings record found in lats_pos_general_settings"),!1;const{error:a}=await w.from("lats_pos_general_settings").update(t).eq("id",r.id);if(a)throw a;return this.clearCache(),!0}catch(t){return console.error("Failed to update business info:",t),!1}}}const ha=new Ku,In=Object.freeze(Object.defineProperty({__proto__:null,businessInfoService:ha},Symbol.toStringTag,{value:"Module"})),nt={general:"lats_pos_general_settings",pricing:"lats_pos_dynamic_pricing_settings",receipt:"lats_pos_receipt_settings",scanner:"lats_pos_barcode_scanner_settings",delivery:"lats_pos_delivery_settings",search:"lats_pos_search_filter_settings",permissions:"lats_pos_user_permissions_settings",loyalty:"lats_pos_loyalty_customer_settings",analytics:"lats_pos_analytics_reporting_settings",notifications:"lats_pos_notification_settings",advanced:"lats_pos_advanced_settings"};let gr=null;const Ju=10*60*1e3;let _r=null;class ue{static async getCurrentUser(){if(gr&&Date.now()-gr.timestamp<Ju)return gr.user;if(_r)return await _r;_r=this.performAuthRefresh();try{return await _r}finally{_r=null}}static async performAuthRefresh(){try{const{data:{session:e},error:t}=await w.auth.getSession();if(t||!e)throw new Error("No active session");const{data:{user:r},error:a}=await w.auth.getUser();if(a||!r)throw new Error("User not authenticated");return gr={user:r,timestamp:Date.now()},r}catch(e){throw e}}static clearUserCache(){gr=null}static getDefaultSettings(e,t){const r={user_id:t,business_id:null};switch(e){case"general":return{...r,theme:"light",language:"en",currency:"TZS",timezone:"Africa/Dar_es_Salaam",date_format:"DD/MM/YYYY",time_format:"24",font_size:"medium",show_product_images:!0,show_stock_levels:!0,show_prices:!0,show_barcodes:!0,products_per_page:20,auto_complete_search:!0,confirm_delete:!0,show_confirmations:!0,enable_sound_effects:!0,enable_animations:!0,enable_caching:!0,cache_duration:300,enable_lazy_loading:!0,max_search_results:50,enable_tax:!1,tax_rate:16};case"pricing":return{...r,enable_dynamic_pricing:!0,enable_loyalty_pricing:!0,enable_bulk_pricing:!0,enable_time_based_pricing:!1,enable_customer_pricing:!1,enable_special_events:!1,loyalty_discount_percent:5,loyalty_points_threshold:1e3,loyalty_max_discount:20,bulk_discount_enabled:!0,bulk_discount_threshold:10,bulk_discount_percent:10,time_based_discount_enabled:!1,time_based_start_time:"18:00",time_based_end_time:"22:00",time_based_discount_percent:15,customer_pricing_enabled:!1,vip_customer_discount:10,regular_customer_discount:5,special_events_enabled:!1,special_event_discount_percent:20};case"receipt":return{...r,receipt_template:"standard",receipt_width:80,receipt_font_size:12,show_business_logo:!0,show_business_name:!0,show_business_address:!0,show_business_phone:!0,show_business_email:!1,show_business_website:!1,show_transaction_id:!0,show_date_time:!0,show_cashier_name:!0,show_customer_name:!0,show_customer_phone:!1,show_product_names:!0,show_product_skus:!1,show_product_barcodes:!1,show_quantities:!0,show_unit_prices:!0,show_discounts:!0,show_subtotal:!0,show_tax:!0,show_discount_total:!0,show_grand_total:!0,show_payment_method:!0,show_change_amount:!0,auto_print_receipt:!1,print_duplicate_receipt:!1,enable_email_receipt:!1,enable_sms_receipt:!1,enable_receipt_numbering:!0,receipt_number_prefix:"RCP",receipt_number_start:1,receipt_number_format:"RCP-{YEAR}-{NUMBER}",show_footer_message:!0,footer_message:"Thank you for your business!",show_return_policy:!1,return_policy_text:"Returns accepted within 7 days with receipt",sms_header_message:"Thank you for your purchase!",sms_footer_message:"Thank you for choosing us!"};case"scanner":return{...r,enable_barcode_scanner:!0,enable_camera_scanner:!1,enable_keyboard_input:!0,enable_manual_entry:!0,auto_add_to_cart:!0,auto_focus_search:!0,play_sound_on_scan:!0,vibrate_on_scan:!1,show_scan_feedback:!0,show_invalid_barcode_alert:!0,allow_unknown_products:!1,prompt_for_unknown_products:!0,retry_on_error:!0,max_retry_attempts:3,scanner_connection_type:"usb",scanner_timeout:5e3,support_ean13:!0,support_ean8:!0,support_upc_a:!0,support_upc_e:!0,support_code128:!0,support_code39:!0,support_qr_code:!0,support_data_matrix:!1,enable_continuous_scanning:!1,scan_delay:500,enable_scan_history:!0,max_scan_history:50};case"delivery":return{...r,enable_delivery:!0,default_delivery_fee:5e3,free_delivery_threshold:5e4,max_delivery_distance:20,enable_delivery_areas:!1,delivery_areas:null,area_delivery_fees:null,area_delivery_times:null,enable_delivery_hours:!1,delivery_start_time:"08:00",delivery_end_time:"18:00",enable_same_day_delivery:!0,enable_next_day_delivery:!0,delivery_time_slots:null,notify_customer_on_delivery:!0,notify_driver_on_assignment:!0,enable_sms_notifications:!1,enable_email_notifications:!1,enable_driver_assignment:!1,driver_commission:10,require_signature:!1,enable_driver_tracking:!1,enable_scheduled_delivery:!1,enable_partial_delivery:!1,require_advance_payment:!1,advance_payment_percent:50};case"search":return{...r,enable_product_search:!0,enable_customer_search:!0,enable_sales_search:!0,search_by_name:!0,search_by_barcode:!0,search_by_sku:!0,search_by_category:!0,search_by_supplier:!0,search_by_description:!0,search_by_tags:!0,enable_fuzzy_search:!0,enable_autocomplete:!0,min_search_length:2,max_search_results:50,search_timeout:5e3,search_debounce_time:300,enable_search_history:!0,max_search_history:50,enable_recent_searches:!0,enable_popular_searches:!0,enable_search_suggestions:!0};case"permissions":return{...r,enable_pos_access:!0,enable_sales_access:!0,enable_refunds_access:!0,enable_void_access:!1,enable_discount_access:!0,enable_inventory_view:!0,enable_inventory_edit:!0,enable_stock_adjustments:!0,enable_product_creation:!0,enable_product_deletion:!1,enable_customer_view:!0,enable_customer_creation:!0,enable_customer_edit:!0,enable_customer_deletion:!1,enable_customer_history:!0,enable_payment_processing:!0,enable_cash_management:!0,enable_daily_reports:!0,enable_financial_reports:!1,enable_tax_management:!1,enable_settings_access:!1,enable_user_management:!1,enable_backup_restore:!1,enable_system_maintenance:!1,enable_api_access:!1,enable_audit_logs:!1,enable_security_settings:!1,enable_password_reset:!1,enable_session_management:!1,enable_data_export:!0};case"loyalty":return{...r,enable_loyalty_program:!0,loyalty_program_name:"Loyalty Rewards",points_per_currency:1,points_redemption_rate:100,minimum_points_redemption:500,points_expiry_days:365,enable_customer_registration:!0,require_customer_info:!1,enable_customer_categories:!0,enable_customer_tags:!0,enable_customer_notes:!0,enable_automatic_rewards:!0,enable_manual_rewards:!0,enable_birthday_rewards:!0,enable_anniversary_rewards:!1,enable_referral_rewards:!1,enable_email_communication:!1,enable_sms_communication:!1,enable_push_notifications:!1,enable_marketing_emails:!1,enable_customer_analytics:!0,enable_purchase_history:!0,enable_spending_patterns:!0,enable_customer_segmentation:!1,enable_customer_insights:!1};case"analytics":return{...r,enable_analytics:!0,enable_real_time_analytics:!0,analytics_refresh_interval:3e4,enable_data_export:!0,enable_sales_analytics:!0,enable_sales_trends:!0,enable_product_performance:!0,enable_customer_analytics:!0,enable_revenue_tracking:!0,enable_inventory_analytics:!0,enable_stock_alerts:!0,enable_low_stock_reports:!0,enable_inventory_turnover:!0,enable_supplier_analytics:!1,enable_automated_reports:!1,report_generation_time:"08:00",enable_email_reports:!1,enable_pdf_reports:!0,enable_excel_reports:!0,enable_custom_dashboard:!0,enable_kpi_widgets:!0,enable_chart_animations:!0,enable_data_drill_down:!0,enable_comparative_analysis:!0,enable_predictive_analytics:!1,enable_data_retention:!0,data_retention_days:365,enable_data_backup:!0,enable_api_export:!1};case"notifications":return{...r,enable_notifications:!0,enable_sound_notifications:!0,enable_visual_notifications:!0,enable_push_notifications:!1,notification_timeout:5e3,enable_sales_notifications:!0,notify_on_sale_completion:!0,notify_on_refund:!0,notify_on_void:!0,notify_on_discount:!1,enable_inventory_notifications:!0,notify_on_low_stock:!0,low_stock_threshold:10,notify_on_out_of_stock:!0,notify_on_stock_adjustment:!1,enable_customer_notifications:!1,notify_on_customer_registration:!1,notify_on_loyalty_points:!1,notify_on_customer_birthday:!1,notify_on_customer_anniversary:!1,enable_system_notifications:!0,notify_on_system_errors:!0,notify_on_backup_completion:!1,notify_on_sync_completion:!1,notify_on_maintenance:!0,enable_email_notifications:!1,enable_sms_notifications:!1,enable_in_app_notifications:!0,enable_desktop_notifications:!1};case"advanced":return{...r,enable_performance_mode:!0,enable_caching:!0,cache_size:100,enable_lazy_loading:!0,max_concurrent_requests:5,enable_database_optimization:!0,enable_auto_backup:!1,backup_frequency:"daily",enable_data_compression:!1,enable_query_optimization:!0,enable_two_factor_auth:!1,enable_session_timeout:!0,session_timeout_minutes:60,enable_audit_logging:!1,enable_encryption:!1,enable_api_access:!1,enable_webhooks:!1,enable_third_party_integrations:!1,enable_data_sync:!0,sync_interval:3e5,enable_debug_mode:!1,enable_error_reporting:!0,enable_performance_monitoring:!1,enable_logging:!0,log_level:"error",enable_experimental_features:!1,enable_beta_features:!1,enable_custom_scripts:!1,enable_plugin_system:!1,enable_auto_updates:!1};default:return r}}static async loadSettings(e){var t,r,a,n,o,i;try{const c=await this.getCurrentUser(),l=nt[e],{data:d,error:u}=await w.from(l).select("*").eq("user_id",c.id);if(u)return u.code==="400"||(t=u.message)!=null&&t.includes("400")||(r=u.message)!=null&&r.includes("Bad Request")?this.getDefaultSettings(e,c.id):u.code==="406"||(a=u.message)!=null&&a.includes("Not Acceptable")?this.getDefaultSettings(e,c.id):u.code==="42P01"||(n=u.message)!=null&&n.includes("does not exist")?this.getDefaultSettings(e,c.id):u.code==="PGRST301"||(o=u.message)!=null&&o.includes("JWT")?this.getDefaultSettings(e,c.id):this.getDefaultSettings(e,c.id);if(d&&d.length>0)return d.length===1,d[0];const{data:h}=await w.from("users").select("id").eq("id",c.id).single(),g=this.getDefaultSettings(e,h?c.id:null),{data:p,error:m}=await w.from(l).insert(g).select().single();return m?m.code==="23503"||(i=m.message)!=null&&i.includes("foreign key constraint")?(console.log(" User not found in users table, using global settings"),this.getDefaultSettings(e,null)):g:p}catch{try{const l=await this.getCurrentUser();return this.getDefaultSettings(e,l.id)}catch{return null}}}static async saveSettings(e,t){var r,a,n,o;try{const i=await this.getCurrentUser(),c=nt[e],{data:l,error:d}=await w.from(c).select("id").eq("user_id",i.id).single();if(d&&d.code!=="PGRST116"&&(d.code==="400"||(r=d.message)!=null&&r.includes("400")||(a=d.message)!=null&&a.includes("Bad Request")))return this.getDefaultSettings(e,i.id);if(l){const{id:u,...h}=t,{data:g,error:p}=await w.from(c).update({...h,user_id:i.id}).eq("user_id",i.id).select().single();return p?((p.code==="23503"||(n=p.message)!=null&&n.includes("foreign key constraint"))&&console.log(" User not found in users table - cannot update settings"),console.error(`Database update error for ${e}:`,p.message),null):(e==="general"&&(ha.clearCache(),console.log(" Business info cache cleared - components will refresh")),g)}else{const{data:u,error:h}=await w.from(c).insert({...t,user_id:i.id}).select().single();return h?((h.code==="23503"||(o=h.message)!=null&&o.includes("foreign key constraint"))&&console.log(" User not found in users table - cannot save settings"),null):(e==="general"&&(ha.clearCache(),console.log(" Business info cache cleared - components will refresh")),u)}}catch{return null}}static async updateSettings(e,t){try{const r=await this.getCurrentUser(),a=nt[e],{data:n,error:o}=await w.from(a).update({...t,updated_at:new Date().toISOString()}).eq("user_id",r.id).select().single();return o?null:n}catch{return null}}static async deleteSettings(e){try{const t=await this.getCurrentUser(),r=nt[e],{error:a}=await w.from(r).delete().eq("user_id",t.id);return!a}catch{return!1}}static async loadAllSettings(){const e={};for(const t of Object.keys(nt))e[t]=await this.loadSettings(t);return e}static async saveAllSettings(e){const t={};for(const[r,a]of Object.entries(e))a&&(t[r]=await this.saveSettings(r,a));return t}static async resetSettings(e){try{const t=await this.getCurrentUser(),r=nt[e],{error:a}=await w.from(r).delete().eq("user_id",t.id);return!a}catch{return!1}}static async exportSettings(e){try{const t=await this.loadSettings(e);return JSON.stringify(t,null,2)}catch{return""}}static async importSettings(e,t){try{const r=JSON.parse(t);return await this.saveSettings(e,r)!==null}catch{return!1}}static subscribeToSettings(e,t){const r=w.auth.getUser(),a=nt[e];return w.channel(`${a}_changes`).on("postgres_changes",{event:"*",schema:"public",table:a,filter:`user_id=eq.${r.then(n=>{var o;return(o=n.data.user)==null?void 0:o.id})}`},n=>{t(n.new)}).subscribe()}static unsubscribeFromSettings(e){const t=nt[e];w.removeChannel(`${t}_changes`)}}const is={loadGeneralSettings:()=>ue.loadSettings("general"),saveGeneralSettings:s=>ue.saveSettings("general",s),updateGeneralSettings:s=>ue.updateSettings("general",s),loadDynamicPricingSettings:()=>ue.loadSettings("pricing"),saveDynamicPricingSettings:s=>ue.saveSettings("pricing",s),updateDynamicPricingSettings:s=>ue.updateSettings("pricing",s),loadReceiptSettings:()=>ue.loadSettings("receipt"),saveReceiptSettings:s=>ue.saveSettings("receipt",s),updateReceiptSettings:s=>ue.updateSettings("receipt",s),loadBarcodeScannerSettings:()=>ue.loadSettings("scanner"),saveBarcodeScannerSettings:s=>ue.saveSettings("scanner",s),updateBarcodeScannerSettings:s=>ue.updateSettings("scanner",s),loadDeliverySettings:()=>ue.loadSettings("delivery"),saveDeliverySettings:s=>ue.saveSettings("delivery",s),updateDeliverySettings:s=>ue.updateSettings("delivery",s),loadSearchFilterSettings:()=>ue.loadSettings("search"),saveSearchFilterSettings:s=>ue.saveSettings("search",s),updateSearchFilterSettings:s=>ue.updateSettings("search",s),loadUserPermissionsSettings:()=>ue.loadSettings("permissions"),saveUserPermissionsSettings:s=>ue.saveSettings("permissions",s),updateUserPermissionsSettings:s=>ue.updateSettings("permissions",s),loadLoyaltyCustomerSettings:()=>ue.loadSettings("loyalty"),saveLoyaltyCustomerSettings:s=>ue.saveSettings("loyalty",s),updateLoyaltyCustomerSettings:s=>ue.updateSettings("loyalty",s),loadAnalyticsReportingSettings:()=>ue.loadSettings("analytics"),saveAnalyticsReportingSettings:s=>ue.saveSettings("analytics",s),updateAnalyticsReportingSettings:s=>ue.updateSettings("analytics",s),loadNotificationSettings:()=>ue.loadSettings("notifications"),saveNotificationSettings:s=>ue.saveSettings("notifications",s),updateNotificationSettings:s=>ue.updateSettings("notifications",s),loadAdvancedSettings:()=>ue.loadSettings("advanced"),saveAdvancedSettings:s=>ue.saveSettings("advanced",s),updateAdvancedSettings:s=>ue.updateSettings("advanced",s),loadAllSettings:()=>ue.loadAllSettings(),saveAllSettings:s=>ue.saveAllSettings(s),resetAllSettings:async()=>{const s={};for(const e of Object.keys(nt))s[e]=await ue.resetSettings(e);return s}},E0=Object.freeze(Object.defineProperty({__proto__:null,POSSettingsAPI:ue,POSSettingsService:is,SETTINGS_TABLES:nt},Symbol.toStringTag,{value:"Module"}));class Gt{constructor(){this.initializedComponents=new Set,this.config={enabled:!1,logLevel:"error"}}static getInstance(){return Gt.instance||(Gt.instance=new Gt),Gt.instance}log(e,t,r,...a){if(!this.config.enabled)return;const n={none:0,error:1,warn:2,info:3,debug:4},o=n[this.config.logLevel];if(n[e]<=o){const c=`[${t.toUpperCase()}]`;switch(e){case"error":console.error(c,r,...a);break}}}trackInitialization(e){return this.initializedComponents.has(e)?(this.log("warn",e,"Already initialized, skipping..."),!1):(this.initializedComponents.add(e),this.log("info",e,"Initializing..."),!0)}resetInitialization(e){e?(this.initializedComponents.delete(e),this.log("info",e,"Reset initialization state")):(this.initializedComponents.clear(),this.log("info","DEBUG","Reset all initialization states"))}getInitializedComponents(){return Array.from(this.initializedComponents)}}const As=Gt.getInstance(),Cn=(s,e,...t)=>As.log("error",s,e,...t),Dn=(s,e,...t)=>As.log("warn",s,e,...t),Fe=(s,e,...t)=>As.log("info",s,e,...t),Yu=s=>As.trackInitialization(s),Oi=async()=>{try{console.log(" Clearing authentication state..."),await w.auth.signOut(),typeof window<"u"&&(["lats-app-auth-token","sb-jxhzveborezjhsmzsgbc-auth-token","supabase.auth.token","supabase.auth.session"].forEach(e=>{localStorage.removeItem(e),console.log(` Cleared localStorage key: ${e}`)}),Object.keys(localStorage).forEach(e=>{(e.includes("supabase")||e.includes("auth")||e.includes("session"))&&(localStorage.removeItem(e),console.log(` Cleared auth-related localStorage key: ${e}`))})),console.log(" Authentication state cleared successfully")}catch(s){console.error(" Error clearing authentication state:",s)}},Xu=async()=>{try{const{data:{session:s},error:e}=await w.auth.getSession();if(e)return console.error(" Session check error:",e),!1;if(!s)return!1;const t=Math.floor(Date.now()/1e3);return s.expires_at&&s.expires_at<t?!1:(console.log(" Session is valid"),!0)}catch(s){return console.error(" Error checking session validity:",s),!1}},Bs=async()=>{console.log(" Handling 403 Forbidden error..."),await Oi(),typeof window<"u"&&alert("Your session has expired. Please log in again.")},Zu={all:"all",view_devices:"devices",add_device:"devices",edit_device:"devices",delete_device:"devices",update_device_status:"devices",assign_devices:"devices",view_customers:"customers",create_customers:"customers",edit_customers:"customers",delete_customers:"customers",view_inventory:"inventory",add_products:"inventory",edit_products:"inventory",delete_products:"inventory",adjust_stock:"inventory",view_stock_history:"inventory",access_pos:"pos",process_sales:"pos",process_refunds:"pos",apply_discounts:"pos",view_reports:"reports",view_financial_reports:"reports",daily_close:"reports",view_settings:"settings",edit_settings:"settings",manage_users:"settings",view_purchase_orders:"purchase_orders",create_purchase_orders:"purchase_orders",edit_purchase_orders:"purchase_orders",delete_purchase_orders:"purchase_orders",approve_purchase_orders:"purchase_orders",view_spare_parts:"spare_parts",create_spare_parts:"spare_parts",edit_spare_parts:"spare_parts",delete_spare_parts:"spare_parts"},Tn={admin:["all"],manager:["all"],"customer-care":["view_devices","add_device","edit_device","assign_devices","view_customers","create_customers","edit_customers","access_pos","process_sales","apply_discounts","view_reports"],technician:["view_devices","update_device_status","view_customers","view_inventory","view_stock_history","view_spare_parts"],sales:["view_customers","create_customers","edit_customers","access_pos","process_sales","apply_discounts","view_reports"],"store-keeper":["view_inventory","view_stock_history","adjust_stock","view_purchase_orders","edit_purchase_orders","view_reports"],user:["view_devices","view_customers"]},ed={"/lats/pos":["access_pos"],"/lats/inventory/management":["view_inventory","edit_settings"],"/lats/inventory/new":["add_products"],"/lats/inventory/products":["view_inventory"],"/lats/inventory/products/:id/edit":["edit_products"],"/lats/inventory/purchase-orders":["view_purchase_orders"],"/lats/inventory/purchase-orders/new":["create_purchase_orders"],"/lats/inventory/stock-transfer":["view_inventory","adjust_stock"],"/lats/add-product":["add_products"],"/lats/spare-parts":["view_spare_parts"],"/lats/reports":["view_reports"],"/lats/sales-reports":["view_reports"],"/settings":["view_settings"],"/admin":["manage_users"],"/users":["manage_users"]};function pe(s,e){if(!s)return!1;const t=Li(s);if(t.includes("all")||t.includes(e))return!0;const r=Zu[e];return!!(r&&t.includes(r))}function Wa(s,e){return!s||!e||e.length===0?!1:e.some(t=>pe(s,t))}function Ni(s,e){return!s||!e||e.length===0?!1:e.every(t=>pe(s,t))}function td(s,e){if(!s)return!1;if(pe(s,"all"))return!0;for(const[t,r]of Object.entries(ed)){const a=t.replace(/:\w+/g,"[^/]+");if(new RegExp(`^${a}$`).test(e))return Wa(s,r)}return!0}function Li(s){if(!s)return[];if(s.permissions&&Array.isArray(s.permissions)&&s.permissions.length>0)return s.permissions;const e=s.role;return Tn[e]||Tn.user}function Ha(s,e){return!s||!s.role?!1:(Array.isArray(e)?e:[e]).includes(s.role)}function rd(s,e){if(!s)return!1;const{roles:t,permissions:r,requireAll:a=!1}=e;return t&&t.length>0&&Ha(s,t)?!0:r&&r.length>0?a?Ni(s,r):Wa(s,r):!1}const sd={canViewDevices:s=>pe(s,"view_devices"),canAddDevice:s=>pe(s,"add_device"),canEditDevice:s=>pe(s,"edit_device"),canDeleteDevice:s=>pe(s,"delete_device"),canUpdateDeviceStatus:s=>pe(s,"update_device_status"),canViewCustomers:s=>pe(s,"view_customers"),canCreateCustomers:s=>pe(s,"create_customers"),canEditCustomers:s=>pe(s,"edit_customers"),canDeleteCustomers:s=>pe(s,"delete_customers"),canViewInventory:s=>pe(s,"view_inventory"),canAddProducts:s=>pe(s,"add_products"),canEditProducts:s=>pe(s,"edit_products"),canDeleteProducts:s=>pe(s,"delete_products"),canAdjustStock:s=>pe(s,"adjust_stock"),canAccessPOS:s=>pe(s,"access_pos"),canProcessSales:s=>pe(s,"process_sales"),canProcessRefunds:s=>pe(s,"process_refunds"),canApplyDiscounts:s=>pe(s,"apply_discounts"),canViewReports:s=>pe(s,"view_reports"),canViewFinancialReports:s=>pe(s,"view_financial_reports"),canCloseDailySales:s=>pe(s,"daily_close"),canViewSettings:s=>pe(s,"view_settings"),canEditSettings:s=>pe(s,"edit_settings"),canManageUsers:s=>pe(s,"manage_users"),canViewPurchaseOrders:s=>pe(s,"view_purchase_orders"),canCreatePurchaseOrders:s=>pe(s,"create_purchase_orders"),canEditPurchaseOrders:s=>pe(s,"edit_purchase_orders"),canApprovePurchaseOrders:s=>pe(s,"approve_purchase_orders"),isAdmin:s=>pe(s,"all")||Ha(s,["admin","manager"])},Nr=D.createContext(void 0),Lt=()=>{const s=D.useContext(Nr);if(!s)throw new Error("useAuth must be used within an AuthProvider");return s};let Rn=!1;function ad(s){const e=t=>{switch(t){case"admin":return["all"];case"technician":return["view_devices","update_device_status","view_customers","view_spare_parts"];case"customer-care":return["view_customers","create_customers","edit_customers","view_devices","assign_devices"];case"store-keeper":return["view_inventory","view_stock_history","adjust_stock","view_purchase_orders","edit_purchase_orders","view_reports"];default:return["view_devices","update_device_status","view_customers"]}};return{...s,isActive:s.is_active,maxDevicesAllowed:s.max_devices_allowed||10,requireApproval:s.require_approval||!1,failedLoginAttempts:s.failed_login_attempts||0,twoFactorEnabled:s.two_factor_enabled||!1,twoFactorSecret:s.two_factor_secret,lastLogin:s.last_login,permissions:s.permissions&&Array.isArray(s.permissions)&&s.permissions.length>0?s.permissions:e(s.role),assignedDevices:[],assignedCustomers:[]}}const nd=({children:s})=>{const[e,t]=D.useState(null),[r,a]=D.useState(()=>{if(typeof window<"u"){const U=localStorage.getItem("admin_impersonation_state");if(U)try{const{originalUser:W}=JSON.parse(U);return W||null}catch{return null}}return null}),[n,o]=D.useState(()=>{if(typeof window<"u"){const U=localStorage.getItem("admin_impersonation_state");if(U)try{const{isImpersonating:W}=JSON.parse(U);return W||!1}catch{return!1}}return!1}),[i,c]=D.useState(!0),[l,d]=D.useState(null),u=D.useRef(!1),h=D.useRef(0),g=D.useRef(!1),p=(U,W=null,H=null)=>{typeof window<"u"&&(U&&W&&H?localStorage.setItem("admin_impersonation_state",JSON.stringify({isImpersonating:!0,originalUser:W,impersonatedUser:H})):localStorage.removeItem("admin_impersonation_state"))};D.useEffect(()=>{typeof window<"u"&&(window.__AUTH_DATA_LOADED_FLAG__=g.current)},[]);const m=async()=>{if(g.current){console.log(" Data already loaded, skipping...");return}try{console.log(" Starting comprehensive data preload..."),g.current=!0,await new Promise(Q=>setTimeout(Q,300));const{dataPreloadService:U}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);(await U.preloadAllData()).success||console.warn(" Data preload completed with some failures");const H=U.getSummary();console.log(" Preload Summary:",{customers:H.dataCounts.customers,products:H.dataCounts.products,categories:H.dataCounts.categories,suppliers:H.dataCounts.suppliers})}catch(U){console.error(" Error in background data loading:",U),g.current=!1}},_=async U=>{var W,H,Q,ce;try{let{data:X,error:re}=await w.from("users").select("*").eq("id",U.id).single();if(re||!X){console.log(` Trying to find profile by email: ${U.email}`);const{data:le,error:ve}=await w.from("users").select("*").eq("email",U.email).single();console.log(" Profile data by email:",le,"Error:",ve),!ve&&le&&(X=le,console.log(" Found profile by email:",X))}if(!X){const ve=U.email==="admin@pos.com"||U.email==="care@care.com"?"admin":"technician";console.log(`Creating default profile for ${U.email} with role: ${ve}`);const Pe={id:U.id,email:U.email,username:((W=U.email)==null?void 0:W.split("@")[0])||"user",full_name:((H=U.email)==null?void 0:H.split("@")[0])||"User",password:"123456",role:ve,is_active:!0,permissions:ve==="admin"?["all"]:["view_devices","view_customers"],max_devices_allowed:1e3,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:Xe}=await w.from("users").insert([Pe]);Xe?console.error("Error creating default profile:",Xe):X=Pe}if(!X){const le=U.email==="admin@pos.com"||U.email==="care@care.com",ve=le?"admin":"technician";console.log(`Using fallback user for ${U.email} with role: ${ve}`);const Pe={...U,role:ve,full_name:((Q=U.email)==null?void 0:Q.split("@")[0])||"User",is_active:!0,permissions:le?["all"]:["view_devices","update_device_status","view_customers"]};t(Pe),c(!1),m();return}const _e=ad(X);t(_e),c(!1)}catch(X){console.error("Error in fetchAndSetUserProfile:",X);const re=U.email==="admin@pos.com"||U.email==="care@care.com",_e=re?"admin":"technician";console.log(`Error fallback for ${U.email} with role: ${_e}`);const le={...U,role:_e,full_name:((ce=U.email)==null?void 0:ce.split("@")[0])||"User",is_active:!0,permissions:re?["all"]:["view_devices","update_device_status","view_customers"]};t(le),c(!1)}},b=async()=>{try{const U=await Ri(async()=>await w.auth.refreshSession()),{data:W,error:H}=U;return H?(console.error(" Session refresh failed:",H),!1):W.session?(await _(W.session.user),!0):!1}catch(U){return console.error(" Error refreshing session:",U),!1}},S=async U=>{var W,H,Q,ce,X,re;if((U==null?void 0:U.status)===401||(U==null?void 0:U.status)===403||(W=U==null?void 0:U.message)!=null&&W.includes("401")||(H=U==null?void 0:U.message)!=null&&H.includes("403")||(Q=U==null?void 0:U.message)!=null&&Q.includes("Unauthorized")||(ce=U==null?void 0:U.message)!=null&&ce.includes("Forbidden")||(X=U==null?void 0:U.message)!=null&&X.includes("bad_jwt")||(re=U==null?void 0:U.message)!=null&&re.includes("missing sub claim")){const _e=await b();return _e||(await Bs(),t(null),d("Session expired. Please log in again.")),_e}return!1};D.useEffect(()=>{if(u.current||Rn){Dn("AuthProvider","Already initialized, skipping...");return}if(!Yu("AuthProvider"))return;Rn=!0,h.current++,Fe("AuthProvider",`Initializing (mount #${h.current})`);const U=async()=>{var H,Q,ce,X,re,_e;try{if(c(!0),Fe("AuthProvider","Checking for existing session..."),!await Xu()){Fe("AuthProvider","No valid session found, clearing auth state"),await Oi(),t(null),c(!1),u.current=!0;return}const{data:{session:ve},error:Pe}=await w.auth.getSession();if(Pe){Cn("AuthProvider","Session error:",Pe),((H=Pe.message)!=null&&H.includes("403")||(Q=Pe.message)!=null&&Q.includes("Forbidden")||(ce=Pe.message)!=null&&ce.includes("bad_jwt"))&&(Fe("AuthProvider","403 error detected, clearing auth state"),await Bs()),t(null),c(!1);return}if(ve!=null&&ve.user){if(Fe("AuthProvider",`Found existing session for user: ${ve.user.email}`),await _(ve.user),typeof window<"u"){const Xe=localStorage.getItem("admin_impersonation_state");if(Xe&&n)try{const{impersonatedUser:$e}=JSON.parse(Xe);$e&&(Fe("AuthProvider",`Restoring impersonation as: ${$e.full_name} (${$e.role})`),t($e))}catch($e){Dn("AuthProvider","Failed to restore impersonation state:",$e),localStorage.removeItem("admin_impersonation_state"),o(!1),a(null)}}}else Fe("AuthProvider","No existing session found"),t(null),typeof window<"u"&&localStorage.removeItem("admin_impersonation_state"),o(!1),a(null);c(!1),u.current=!0,Fe("AuthProvider","Auth initialization complete")}catch(le){Cn("AuthProvider","Error initializing auth:",le),((X=le==null?void 0:le.message)!=null&&X.includes("403")||(re=le==null?void 0:le.message)!=null&&re.includes("Forbidden")||(_e=le==null?void 0:le.message)!=null&&_e.includes("bad_jwt"))&&(Fe("AuthProvider","403 error in catch block, clearing auth state"),await Bs()),t(null),c(!1),u.current=!0}},{data:{subscription:W}}=w.auth.onAuthStateChange((H,Q)=>{var ce;Fe("AuthProvider",`Auth state change: ${H}`,(ce=Q==null?void 0:Q.user)==null?void 0:ce.email),H==="SIGNED_IN"&&(Q!=null&&Q.user)?(Fe("AuthProvider",`User signed in: ${Q.user.email}`),_(Q.user)):H==="SIGNED_OUT"?(Fe("AuthProvider","User signed out"),t(null),c(!1),g.current=!1):H==="TOKEN_REFRESHED"&&(Q!=null&&Q.user)&&(Fe("AuthProvider",`Token refreshed for user: ${Q.user.email}`),e||_(Q.user))});return U(),()=>{Fe("AuthProvider","Cleaning up AuthProvider"),W.unsubscribe(),h.current--}},[]),D.useEffect(()=>{e&&!g.current&&m()},[e]);const v=async(U,W)=>{try{d(null),c(!0);const{data:H,error:Q}=await w.auth.signInWithPassword({email:U,password:W});return Q?(console.error(" Login error:",Q),d(Q.message||"Invalid email or password"),c(!1),!1):H.user?(await _(H.user),c(!1),!0):(d("Login failed"),c(!1),!1)}catch(H){return console.error(" Login error:",H),d("An unexpected error occurred during login"),c(!1),!1}},C=async()=>{try{console.log(" Logging out..."),c(!0),ue.clearUserCache();try{const{dataPreloadService:U}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);U.clearAll(),console.log(" Cleared preloaded data")}catch(U){console.error(" Error clearing preloaded data:",U)}typeof window<"u"&&localStorage.removeItem("admin_impersonation_state"),o(!1),a(null),await w.auth.signOut(),t(null),d(null),g.current=!1}catch(U){console.error(" Logout error:",U)}finally{c(!1)}},T=()=>d(null),x=U=>pe(e,U),R=U=>Wa(e,U),k=U=>Ni(e,U),P=U=>td(e,U),O=()=>Li(e),N=U=>Ha(e,U),$=U=>rd(e,U),M=async U=>{if(!e||e.role!=="admin")return ge.error("Only admins can impersonate users"),!1;try{a(e),o(!0);const{data:W,error:H}=await w.from("users").select("id, full_name, email, role, is_active").eq("id",U).single();if(H||!W)throw new Error("User not found");const Q=X=>{switch(X){case"admin":return["all"];case"technician":return["view_devices","update_device_status","view_customers"];case"customer-care":return["view_customers","create_customers","edit_customers","view_devices","assign_devices"];default:return["view_devices","update_device_status","view_customers"]}},ce={...W,role:W.role||"user",permissions:Q(W.role||"user"),name:W.full_name||W.name||W.email||"Unknown User"};return t(ce),p(!0,e,ce),ge.success(`Now testing as: ${ce.name} (${ce.role})`),!0}catch(W){return console.error("Impersonation error:",W),ge.error("Failed to impersonate user"),!1}},L=()=>{r&&(t(r),a(null),o(!1),p(!1),ge.success("Returned to admin account"))},B=async()=>{if(!e||e.role!=="admin")return[];try{const{data:U,error:W}=await w.from("users").select("id, full_name, email, role").neq("role","admin").eq("is_active",!0).order("full_name");if(W)throw W;return U||[]}catch(U){return console.error("Error fetching test users:",U),[]}};return f.jsx(Nr.Provider,{value:{currentUser:e,originalUser:r,isImpersonating:n,login:v,logout:C,isAuthenticated:!!e,error:l,clearError:T,loading:i,refreshSession:b,handleAuthError:S,impersonateUser:M,stopImpersonation:L,getAvailableTestUsers:B,hasPermission:x,hasAnyPermission:R,hasAllPermissions:k,canAccessRoute:P,getUserPermissions:O,hasRole:N,checkAccess:$,Permission:sd},children:s})},Ui=D.createContext(void 0),od=({children:s})=>{const{currentUser:e}=Lt(),[t,r]=D.useState(null),[a,n]=D.useState([]),[o,i]=D.useState(!0);D.useEffect(()=>{e&&c()},[e]);const c=async()=>{try{i(!0);const{data:m,error:_}=await w.from("store_locations").select("*").eq("is_active",!0).order("is_main",{ascending:!1}).order("name",{ascending:!0});if(_)throw _;if(n(m||[]),(e==null?void 0:e.role)==="admin"){const b=localStorage.getItem("current_branch_id"),S=m==null?void 0:m.find(T=>T.id===b),v=m==null?void 0:m.find(T=>T.is_main),C=S||v||(m==null?void 0:m[0])||null;C&&localStorage.setItem("current_branch_id",C.id),r(C),i(!1);return}try{const{data:b,error:S}=await w.from("user_branch_assignments").select("*").eq("user_id",e==null?void 0:e.id);if(S){console.error("Error loading branch assignments:",S);const v=m==null?void 0:m.find(C=>C.is_main);r(v||(m==null?void 0:m[0])||null),i(!1);return}if(b&&b.length>0){const v=b.map(N=>N.branch_id).filter(Boolean),{data:C,error:T}=await w.from("store_locations").select("*").in("id",v);if(T){console.error("Error loading store locations:",T);const N=m==null?void 0:m.find($=>$.is_main);r(N||(m==null?void 0:m[0])||null),i(!1);return}const x=new Map((C==null?void 0:C.map(N=>[N.id,N]))||[]),R=b.map(N=>({...N,store_locations:x.get(N.branch_id)})),k=R.find(N=>N.is_primary),P=(k==null?void 0:k.store_locations)||R[0].store_locations;P&&localStorage.setItem("current_branch_id",P.id),r(P);const O=b.map(N=>N.branch_id);n((m==null?void 0:m.filter(N=>O.includes(N.id)))||[])}else{const C=(m==null?void 0:m.find(T=>T.is_main))||(m==null?void 0:m[0])||null;C&&localStorage.setItem("current_branch_id",C.id),r(C)}}catch(b){console.error("Error in branch assignments:",b);const v=(m==null?void 0:m.find(C=>C.is_main))||(m==null?void 0:m[0])||null;v&&localStorage.setItem("current_branch_id",v.id),r(v)}}catch(m){console.error("Error loading branches:",m),Gr.error("Failed to load branch information")}finally{i(!1)}},l=async m=>{const _=a.find(b=>b.id===m);if(!_){Gr.error("Branch not found or not accessible");return}if(!d(m)){Gr.error("You do not have permission to access this branch");return}r(_),localStorage.setItem("current_branch_id",m),Gr.success(`Switched to ${_.name}`);try{await w.from("branch_activity_log").insert({branch_id:m,user_id:e==null?void 0:e.id,action_type:"BRANCH_SWITCH",description:`User switched to branch: ${_.name}`,metadata:{previous_branch:t==null?void 0:t.id}})}catch{}},d=m=>(e==null?void 0:e.role)==="admin"?!0:a.some(_=>_.id===m),p={currentBranch:t,availableBranches:a,loading:o,switchBranch:l,canAccessBranch:d,isDataShared:m=>!t||t.data_isolation_mode==="shared"?!0:t.data_isolation_mode==="isolated"?!1:{products:t.share_products,customers:t.share_customers,inventory:t.share_inventory,suppliers:t.share_suppliers,categories:t.share_categories,employees:t.share_employees}[m]??!1,getBranchFilterClause:()=>!t||(e==null?void 0:e.role)==="admin"&&t.can_view_other_branches?"":`(branch_id.eq.${t.id},or(is_shared.eq.true))`,refreshBranches:async()=>{await c()}};return f.jsx(Ui.Provider,{value:p,children:s})},id=()=>{const s=D.useContext(Ui);if(s===void 0)throw new Error("useBranch must be used within a BranchProvider");return s},ji=D.createContext(void 0),cd=()=>{const s=new Date,e=new Date;return e.setDate(s.getDate()-7),{startDate:e,endDate:s,preset:"7days"}},ld=({children:s})=>{const[e,t]=D.useState(cd()),r=()=>({startDate:e.startDate.toISOString(),endDate:e.endDate.toISOString()});return f.jsx(ji.Provider,{value:{dateRange:e,setDateRange:t,getDateRangeForQuery:r},children:s})},x0=()=>{const s=D.useContext(ji);if(!s)throw new Error("useDateRange must be used within a DateRangeProvider");return s},ud=(s,e)=>e.some(t=>s instanceof t);let On,Nn;function dd(){return On||(On=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function hd(){return Nn||(Nn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const $i=new WeakMap,ma=new WeakMap,Mi=new WeakMap,Fs=new WeakMap,Qa=new WeakMap;function md(s){const e=new Promise((t,r)=>{const a=()=>{s.removeEventListener("success",n),s.removeEventListener("error",o)},n=()=>{t(_t(s.result)),a()},o=()=>{r(s.error),a()};s.addEventListener("success",n),s.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&$i.set(t,s)}).catch(()=>{}),Qa.set(e,s),e}function pd(s){if(ma.has(s))return;const e=new Promise((t,r)=>{const a=()=>{s.removeEventListener("complete",n),s.removeEventListener("error",o),s.removeEventListener("abort",o)},n=()=>{t(),a()},o=()=>{r(s.error||new DOMException("AbortError","AbortError")),a()};s.addEventListener("complete",n),s.addEventListener("error",o),s.addEventListener("abort",o)});ma.set(s,e)}let pa={get(s,e,t){if(s instanceof IDBTransaction){if(e==="done")return ma.get(s);if(e==="objectStoreNames")return s.objectStoreNames||Mi.get(s);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return _t(s[e])},set(s,e,t){return s[e]=t,!0},has(s,e){return s instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in s}};function fd(s){pa=s(pa)}function gd(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const r=s.call(zs(this),e,...t);return Mi.set(r,e.sort?e.sort():[e]),_t(r)}:hd().includes(s)?function(...e){return s.apply(zs(this),e),_t($i.get(this))}:function(...e){return _t(s.apply(zs(this),e))}}function _d(s){return typeof s=="function"?gd(s):(s instanceof IDBTransaction&&pd(s),ud(s,dd())?new Proxy(s,pa):s)}function _t(s){if(s instanceof IDBRequest)return md(s);if(Fs.has(s))return Fs.get(s);const e=_d(s);return e!==s&&(Fs.set(s,e),Qa.set(e,s)),e}const zs=s=>Qa.get(s);function Ka(s,e,{blocked:t,upgrade:r,blocking:a,terminated:n}={}){const o=indexedDB.open(s,e),i=_t(o);return r&&o.addEventListener("upgradeneeded",c=>{r(_t(o.result),c.oldVersion,c.newVersion,_t(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),i.then(c=>{n&&c.addEventListener("close",()=>n()),a&&c.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),i}const yd=["get","getKey","getAll","getAllKeys","count"],bd=["put","add","delete","clear"],Vs=new Map;function Ln(s,e){if(!(s instanceof IDBDatabase&&!(e in s)&&typeof e=="string"))return;if(Vs.get(e))return Vs.get(e);const t=e.replace(/FromIndex$/,""),r=e!==t,a=bd.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(a||yd.includes(t)))return;const n=async function(o,...i){const c=this.transaction(o,a?"readwrite":"readonly");let l=c.store;return r&&(l=l.index(i.shift())),(await Promise.all([l[t](...i),a&&c.done]))[0]};return Vs.set(e,n),n}fd(s=>({...s,get:(e,t,r)=>Ln(e,t)||s.get(e,t,r),has:(e,t)=>!!Ln(e,t)||s.has(e,t)}));const qi="clean-app-cache",ps=["customers","devices","returns"],Ja=5*60*1e3;async function ht(){return Ka(qi,4,{upgrade(s,e,t){for(const r of ps)s.objectStoreNames.contains(r)||s.createObjectStore(r,{keyPath:"id"});s.objectStoreNames.contains("cache_metadata")||s.createObjectStore("cache_metadata",{keyPath:"store"})}})}async function fa(s,e){try{const r=(await ht()).transaction([s,"cache_metadata"],"readwrite");await r.objectStore(s).clear();const a=Date.now();for(const n of e)await r.objectStore(s).put({...n,_cachedAt:a});await r.objectStore("cache_metadata").put({store:s,lastUpdated:a,itemCount:e.length}),await r.done}catch(t){console.warn(`Failed to cache data for ${s}:`,t)}}async function ga(s){try{const t=(await ht()).transaction([s,"cache_metadata"],"readonly"),r=await t.objectStore("cache_metadata").get(s);return r&&Date.now()-r.lastUpdated>Ja?[]:(await t.objectStore(s).getAll()).map(n=>{const{_cachedAt:o,...i}=n;return i})}catch(e){return console.warn(`Failed to get cached data for ${s}:`,e),[]}}async function wd(s){try{const r=await(await ht()).transaction("cache_metadata","readonly").objectStore("cache_metadata").get(s);return r?Date.now()-r.lastUpdated<=Ja:!1}catch(e){return console.warn(`Failed to check cache validity for ${s}:`,e),!1}}async function vd(s){try{const t=(await ht()).transaction([s,"cache_metadata"],"readwrite");await t.objectStore(s).clear(),await t.objectStore("cache_metadata").delete(s),await t.done}catch(e){console.warn(`Failed to clear cache for ${s}:`,e)}}async function Sd(){try{const s=await ht(),e={};for(const t of ps){const a=await s.transaction("cache_metadata","readonly").objectStore("cache_metadata").get(t);a&&(e[t]={itemCount:a.itemCount,lastUpdated:new Date(a.lastUpdated),isValid:Date.now()-a.lastUpdated<=Ja})}return e}catch(s){return console.warn("Failed to get cache stats:",s),{}}}async function Bi(){try{const e=(await ht()).transaction([...ps,"cache_metadata"],"readwrite");for(const t of ps)await e.objectStore(t).clear();await e.objectStore("cache_metadata").clear(),await e.done}catch(s){console.warn("Failed to clear all cache:",s)}}async function Ya(){try{await Ed(qi)}catch(s){console.warn("Failed to reset cache database:",s)}}async function Ed(s){return new Promise((e,t)=>{const r=indexedDB.deleteDatabase(s);r.onsuccess=()=>e(),r.onerror=()=>t(r.error)})}async function Fi(){try{await(await ht()).transaction("cache_metadata","readonly").objectStore("cache_metadata").get("test")}catch(s){console.warn("Cache initialization failed, resetting database:",s);try{await Ya(),await ht()}catch(e){console.error("Failed to reset cache database:",e)}}}typeof window<"u"&&(window.resetCleanAppCache=async()=>{try{await Ya()}catch(s){console.error("Failed to reset cache:",s)}},window.clearCleanAppCache=async()=>{try{await Bi()}catch(s){console.error("Failed to clear cache:",s)}});const Pr=Object.freeze(Object.defineProperty({__proto__:null,cacheClear:vd,cacheGetAll:ga,cacheGetStats:Sd,cacheIsValid:wd,cacheSetAll:fa,clearAllCache:Bi,getCacheDB:ht,initializeCache:Fi,resetCacheDatabase:Ya},Symbol.toStringTag,{value:"Module"}));async function xd(){if(navigator.onLine)try{const s=localStorage.getItem("current_branch_id");let e=w.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          problem_description,
          status,
          technician_id,
          estimated_completion_date,
          created_at,
          updated_at,
          estimated_cost,
          actual_cost,
          deposit_amount
        `).order("created_at",{ascending:!1});s&&(e=e.eq("branch_id",s));const{data:t,error:r}=await e;if(r){const{data:n,error:o}=await w.from("devices").select(`
            id,
            customer_id,
            brand,
            model,
            serial_number,
            problem_description,
            status,
            technician_id,
            estimated_completion_date,
            created_at,
            updated_at,
            estimated_cost,
            actual_cost,
            deposit_amount
          `).order("created_at",{ascending:!1});if(o)throw console.error("Error fetching devices:",o),o;const i=(n||[]).map(c=>{const l=(c.remarks||[]).map(h=>({id:h.id,content:h.content,createdBy:h.created_by,createdAt:h.created_at})),d=(c.transitions||[]).map(h=>({id:h.id,fromStatus:h.from_status,toStatus:h.to_status,performedBy:h.performed_by,timestamp:h.created_at,signature:h.signature||""})),u=(c.ratings||[]).map(h=>({id:h.id,deviceId:h.device_id,technicianId:h.technician_id,score:h.score||5,comment:h.comment,createdAt:h.created_at}));return{...c,serialNumber:c.serial_number,issueDescription:c.issue_description,customerId:c.customer_id,assignedTo:c.assigned_to,expectedReturnDate:c.expected_return_date,customerName:"",phoneNumber:"",remarks:l,transitions:d,ratings:u,createdAt:c.created_at,updatedAt:c.updated_at}});return await fa("devices",i),i}const a=(t||[]).map(n=>{var o,i,c,l,d,u,h;return{...n,serialNumber:n.serial_number,issueDescription:n.issue_description,customerId:n.customer_id,assignedTo:n.assigned_to,expectedReturnDate:n.expected_return_date,customerName:((o=n.customers)==null?void 0:o.name)||"",phoneNumber:((i=n.customers)==null?void 0:i.phone)||"",customerEmail:((c=n.customers)==null?void 0:c.email)||"",customerLoyaltyLevel:((l=n.customers)==null?void 0:l.loyalty_level)||"",customerTotalSpent:((d=n.customers)==null?void 0:d.total_spent)||0,customerLastVisit:((u=n.customers)==null?void 0:u.last_visit)||null,customerColorTag:((h=n.customers)==null?void 0:h.color_tag)||"",repairCost:n.repair_cost||null,depositAmount:n.deposit_amount||null,deviceCost:n.device_cost,repairPrice:n.repair_price||null,unlockCode:null,diagnosisRequired:n.diagnosis_required,deviceNotes:n.device_notes,deviceCondition:null,diagnosticChecklist:null,repairChecklist:null,remarks:[],transitions:[],ratings:[],createdAt:n.created_at,updatedAt:n.updated_at}});return await fa("devices",a),a}catch(s){return console.error("Error fetching devices:",s),await ga("devices")}else return await ga("devices")}async function Pd(s){const e=localStorage.getItem("current_branch_id"),t={id:s.id,branch_id:e||"00000000-0000-0000-0000-000000000001",customer_id:s.customerId,device_name:s.model||`${s.brand} Device`||"Unknown Device",brand:s.brand,model:s.model,serial_number:s.serialNumber,problem_description:s.issueDescription,issue_description:s.issueDescription,status:s.status,technician_id:s.assignedTo||null,assigned_to:s.assignedTo||null,expected_return_date:s.expectedReturnDate===""?null:s.expectedReturnDate,estimated_completion_date:s.expectedReturnDate===""?null:s.expectedReturnDate,created_at:s.createdAt,updated_at:s.updatedAt,unlock_code:s.unlockCode||null,repair_cost:s.repairCost||null,repair_price:s.repairPrice||null,deposit_amount:s.depositAmount||null,diagnosis_required:s.diagnosisRequired||!1,device_notes:s.deviceNotes||null,device_cost:s.deviceCost||null,estimated_hours:s.estimatedHours||null,device_condition:s.deviceCondition||null},{data:r,error:a}=await w.from("devices").insert([t]).select();if(a)throw a;return r&&r[0]?r[0]:null}async function Un(s,e){const t=["assigned","diagnosis-started","awaiting-parts","parts-arrived","in-repair","reassembled-testing","repair-complete","process-payments","returned-to-customer-care","done","failed"],r=["assignedTo","serialNumber","issueDescription","customerId","expectedReturnDate","estimatedHours","warrantyStart","warrantyEnd","warrantyStatus","repairCount","lastReturnDate","brand","model","status"],a={};if(Object.keys(e).forEach(u=>{if(r.includes(u)&&e[u]!==void 0){const h=e[u];if(u==="status")if(typeof h=="string"&&t.includes(h))a[u]=h;else{typeof h=="string"&&h.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)&&(console.error("[updateDeviceInDb]  CRITICAL BUG: Status field contains UUID instead of valid status!"),console.error("[updateDeviceInDb] This indicates a data corruption bug in the application."),console.error("[updateDeviceInDb] Device ID:",s,"Invalid status UUID:",h));return}else a[u]=h}}),Object.keys(a).length===0)return{success:!1,message:"No valid updates to process"};const n={...a};"assignedTo"in n&&(n.assigned_to=n.assignedTo,delete n.assignedTo),"serialNumber"in n&&(n.serial_number=n.serialNumber,delete n.serialNumber),"issueDescription"in n&&(n.issue_description=n.issueDescription,delete n.issueDescription),"customerId"in n&&(n.customer_id=n.customerId,delete n.customerId),"expectedReturnDate"in n&&(n.expected_return_date=n.expectedReturnDate,delete n.expectedReturnDate),"estimatedHours"in n&&(n.estimated_hours=n.estimatedHours,delete n.estimatedHours),"warrantyStart"in n&&(n.warranty_start=n.warrantyStart,delete n.warrantyStart),"warrantyEnd"in n&&(n.warranty_end=n.warrantyEnd,delete n.warrantyEnd),"warrantyStatus"in n&&(n.warranty_status=n.warrantyStatus,delete n.warrantyStatus),"repairCount"in n&&(n.repair_count=n.repairCount,delete n.repairCount),"lastReturnDate"in n&&(n.last_return_date=n.lastReturnDate,delete n.lastReturnDate);const o=["id","customer_id","brand","model","serial_number","issue_description","status","assigned_to","estimated_hours","expected_return_date","warranty_start","warranty_end","warranty_status","repair_count","last_return_date","diagnostic_checklist","created_at","updated_at"];Object.keys(n).forEach(u=>{o.includes(u)||delete n[u]}),console.log("[updateDeviceInDb] Update fields count:",Object.keys(n).length);const{data:i,error:c}=await w.from("devices").select("*").eq("id",s).single();if(c)throw console.error("[updateDeviceInDb] Device not found:",c),console.error("[updateDeviceInDb] Check error details:",{message:c.message,details:c.details,hint:c.hint,code:c.code}),new Error(`Device with ID ${s} not found`);Object.keys(n).forEach(u=>{i[u],n[u]});const{data:l,error:d}=await w.from("devices").update(n).eq("id",s).select();if(d)throw console.error("[updateDeviceInDb]  Database update failed:",d),console.error("[updateDeviceInDb] Error details:",{message:d.message,details:d.details,hint:d.hint,code:d.code}),console.error("[updateDeviceInDb] Failed update data:",n),d;return l&&l[0]?{...l[0],assignedTo:l[0].assigned_to}:null}async function Ad(s){const{error:e}=await w.from("devices").delete().eq("id",s);if(e)throw e;return!0}const qe=class{static startKeepAlive(){this.keepAliveInterval||(this.keepAliveInterval=setInterval(async()=>{if(this.audioContext&&this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch{}},1e3))}static stopKeepAlive(){this.keepAliveInterval&&(clearInterval(this.keepAliveInterval),this.keepAliveInterval=null)}static async initialize(){if(!(this.isInitialized&&this.audioContext)&&this.userInteracted){if(this.initializationPromise){await this.initializationPromise;return}this.initializationPromise=this.createAudioContext(),await this.initializationPromise}}static async createAudioContext(){try{if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;if(!e){this.isInitialized=!0;return}this.audioContext=new e,this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.isInitialized=!0}}catch{this.isInitialized=!0}}static markUserInteracted(){this.userInteracted||(this.userInteracted=!0,this.initialize())}static getStats(){var e;return{isInitialized:this.isInitialized,userInteracted:this.userInteracted,hasAudioContext:!!this.audioContext,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"not-created",soundsPlayed:this.soundsPlayed,soundErrors:this.soundErrors,successRate:this.soundsPlayed>0?(this.soundsPlayed/(this.soundsPlayed+this.soundErrors)*100).toFixed(1)+"%":"N/A"}}static logStatus(){const e=this.getStats();console.log(" SoundManager Status:",e)}static forceUserInteraction(){this.userInteracted=!0,this.initialize()}static async playRemarkSound(){if(this.userInteracted)if(this.markUserInteracted(),await this.initialize(),this.audioContext&&this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.frequency.setValueAtTime(600,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(800,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}}}else this.playFallbackSound()}static playFallbackSound(){}static async playSuccessSound(){if(this.markUserInteracted(),await this.initialize(),this.audioContext&&this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(523,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(784,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}}}}static async playErrorSound(){if(this.markUserInteracted(),await this.initialize(),this.audioContext&&this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(784,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(523,this.audioContext.currentTime+.2),t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.3),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}}}}static async playClickSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext){this.soundErrors++;return}if(this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(1e3,this.audioContext.currentTime),e.type="square",t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.05),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.05),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}},this.soundsPlayed++}else this.soundErrors++}catch{this.soundErrors++}}static playCartAddSound(){try{if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;e&&(this.audioContext=new e,this.isInitialized=!0,this.userInteracted=!0)}if(!this.audioContext){this.soundErrors++;return}if(this.audioContext.state==="suspended"){this.audioContext.resume().then(()=>{this.playCartAddSoundImmediate()});return}this.playCartAddSoundImmediate()}catch{this.soundErrors++}}static playCartAddSoundImmediate(){try{if(!this.audioContext||this.audioContext.state!=="running")return;const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.frequency.setValueAtTime(1e3,this.audioContext.currentTime+.05),e.type="sine",t.gain.setValueAtTime(.3,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.15),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}},this.soundsPlayed++}catch{this.soundErrors++}}static async playPaymentSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext){this.soundErrors++;return}if(this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(523,this.audioContext.currentTime),e.frequency.setValueAtTime(659,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(784,this.audioContext.currentTime+.2),e.frequency.setValueAtTime(1047,this.audioContext.currentTime+.3),t.gain.setValueAtTime(.25,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.4),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.4),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}},this.soundsPlayed++}else this.soundErrors++}catch{this.soundErrors++}}static async playDeleteSound(){try{if(this.audioContext||(this.markUserInteracted(),await this.initialize()),!this.audioContext){this.soundErrors++;return}if(this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.audioContext.state==="running"){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(600,this.audioContext.currentTime),e.frequency.setValueAtTime(400,this.audioContext.currentTime+.1),e.type="sawtooth",t.gain.setValueAtTime(.2,this.audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.2),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.2),e.onended=()=>{try{e.disconnect(),t.disconnect()}catch{}},this.soundsPlayed++}else this.soundErrors++}catch{this.soundErrors++}}static async testSound(){try{await this.playRemarkSound()}catch(e){console.error(" Sound test failed:",e)}}};qe.audioContext=null;qe.isInitialized=!1;qe.userInteracted=!1;qe.initializationPromise=null;qe.soundsPlayed=0;qe.soundErrors=0;qe.keepAliveInterval=null;(()=>{const s=async()=>{qe.markUserInteracted();try{const e=window.AudioContext||window.webkitAudioContext;e&&!qe.audioContext&&(qe.audioContext=new e,qe.audioContext.state==="suspended"&&await qe.audioContext.resume(),qe.isInitialized=!0,qe.startKeepAlive())}catch{}document.removeEventListener("click",s,!0),document.removeEventListener("keydown",s,!0),document.removeEventListener("touchstart",s,!0)};document.addEventListener("click",s,!0),document.addEventListener("keydown",s,!0),document.addEventListener("touchstart",s,!0)})();let cs=qe;async function kd(s,e){const{data:t,error:r}=await w.from("customer_notes").insert([{...s,customer_id:e}]).select();if(r)throw r;try{await cs.playRemarkSound()}catch(a){console.warn("Could not play remark sound:",a)}return t&&t[0]?t[0]:null}async function Id(s,e){const{data:t,error:r}=await w.from("promo_messages").insert([{...s,customer_id:e}]).select();if(r)throw r;return t&&t[0]?t[0]:null}async function Cd(s){const{data:e,error:t}=await w.from("device_ratings").insert([s]).select();if(t)throw t;return e&&e[0]?e[0]:null}async function zi(s,e="general"){try{console.log(` Tracking ${e} activity for customer: ${s}`);const{error:t}=await w.rpc("track_customer_activity",{customer_id:s,activity_type:e});if(t)throw console.error(" Error tracking customer activity:",t),t;console.log(" Customer activity tracked successfully")}catch(t){throw console.error(" Failed to track customer activity:",t),t}}async function A0(s){try{console.log(` Getting status for customer: ${s}`);const{data:e,error:t}=await w.rpc("get_customer_status",{customer_id:s});if(t)throw console.error(" Error getting customer status:",t),t;if(!e||e.length===0)return console.log(" No customer found with ID:",s),null;const r=e[0];return{id:r.id,name:r.name,isActive:r.is_active,memberSince:r.member_since,lastVisit:r.last_visit,daysSinceActivity:r.days_since_activity,statusReason:r.status_reason}}catch(e){throw console.error(" Failed to get customer status:",e),e}}async function Dd(s){try{console.log(` Reactivating customer: ${s}`);const{error:e}=await w.from("customers").update({is_active:!0,last_activity_date:new Date().toISOString(),last_visit:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",s);if(e)throw console.error(" Error reactivating customer:",e),e;console.log(" Customer reactivated successfully")}catch(e){throw console.error(" Failed to reactivate customer:",e),e}}async function k0(s,e){try{console.log(` Checking in customer with auto-reactivation: ${s}`);const{data:t,error:r}=await w.from("customers").select("is_active, name").eq("id",s).single();let a=!1;!r&&t&&!t.is_active&&(console.log(` Customer ${t.name} is inactive, reactivating...`),await Dd(s),console.log(` Customer ${t.name} reactivated automatically`),a=!0);const{error:n}=await w.from("customer_checkins").insert([{customer_id:s,staff_id:e,checkin_date:new Date().toISOString()}]);if(n)return console.error(" Error recording check-in:",n),{success:!1,message:"Failed to record check-in"};await zi(s,"checkin");const o=a?"Customer checked in and reactivated successfully!":"Customer checked in successfully!";return console.log(" Customer check-in completed successfully"),{success:!0,message:o,wasReactivated:a}}catch(t){return console.error(" Failed to check in customer with reactivation:",t),{success:!1,message:"Failed to check in customer"}}}const Td={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2};function Rd(s){const e=s.message||s.toString(),t=s.name||"",r=s.code||"";if(e.includes("QUIC_PROTOCOL_ERROR")||e.includes("net::ERR_QUIC_PROTOCOL_ERROR"))return!0;const n=["Failed to fetch","NetworkError","NETWORK_ERROR","AbortError","TimeoutError","Connection refused","Connection reset","Connection timeout","Service Unavailable","Gateway Timeout","Internal Server Error"].some(u=>e.includes(u)||t.includes(u)),i=["NETWORK_ERROR","ABORT_ERR","TIMEOUT_ERR"].includes(r),c=s.status||s.code,d=[408,429,500,502,503,504].includes(c);return n||i||d}function Od(s){const{error:e,context:t,retryCount:r=0,maxRetries:a=0}=s,n=e.message||e.toString();console.error(` ${t} failed:`,{message:n,code:e.code,status:e.status,name:e.name,context:t,retryCount:r,maxRetries:a,timestamp:new Date().toISOString()}),(n.includes("QUIC_PROTOCOL_ERROR")||n.includes("net::ERR_QUIC_PROTOCOL_ERROR"))&&(console.error(" QUIC Protocol Error detected. This may be due to:"),console.error("   - Network instability or poor connection quality"),console.error("   - Firewall or proxy interference with QUIC protocol"),console.error("   - Browser network stack issues (try refreshing the page)"),console.error("   - Supabase server connectivity problems"),console.error("   - DNS resolution issues"),console.error("   - Corporate network restrictions"),console.error("   - Browser cache corruption (try clearing browser cache)"),r<a&&console.warn(` Will retry request (${r+1}/${a+1})`)),n.includes("Failed to fetch")&&(console.error(" Network fetch failed. This may be due to:"),console.error("   - Internet connection issues"),console.error("   - Server is down or unreachable"),console.error("   - CORS policy restrictions"),console.error("   - Network timeout")),n.includes("Service Unavailable")&&(console.error(" Service Unavailable. This may be due to:"),console.error("   - Server overload or maintenance"),console.error("   - Rate limiting"),console.error("   - Temporary infrastructure issues"))}async function Vi(s,e={}){const t={...Td,...e};let r;for(let a=0;a<=t.maxRetries;a++)try{return await s()}catch(n){if(r=n,Od({error:n,context:"Network request",retryCount:a,maxRetries:t.maxRetries}),!Rd(n)||a>=t.maxRetries)throw n;const o=Math.min(t.baseDelay*Math.pow(t.backoffMultiplier,a),t.maxDelay),i=Math.random()*1e3,c=o+i;console.warn(` Retrying in ${Math.round(c)}ms (attempt ${a+1}/${t.maxRetries+1})`),await new Promise(l=>setTimeout(l,c))}throw r}function Nd(s,e,t="Request timeout"){return Promise.race([s,new Promise((r,a)=>{setTimeout(()=>a(new Error(t)),e)})])}async function Ld(s,e=9e4,t={}){return Vi(async()=>Nd(s(),e,`Request timed out after ${e}ms`),t)}const Ud=50,jd=100,$d=3,Md=1e3,yt=9e4,He=new Map;function Le(){if(!w)throw new Error("Supabase client not initialized");return w}async function Yt(s,e=$d,t=Md){return Ld(s,yt,{maxRetries:e,baseDelay:t,maxDelay:1e4,backoffMultiplier:2})}async function Xt(s,e=yt){const t=new Promise((r,a)=>{setTimeout(()=>a(new Error(`Request timeout after ${e}ms`)),e)});return Promise.race([s,t])}function qd(){const s={online:navigator.onLine,connectionType:"unknown",effectiveType:"unknown",downlink:0,rtt:0,saveData:!1};if("connection"in navigator){const e=navigator.connection;e&&(s.connectionType=e.effectiveType||"unknown",s.effectiveType=e.effectiveType||"unknown",s.downlink=e.downlink||0,s.rtt=e.rtt||0,s.saveData=e.saveData||!1)}return s}function Bd(){const s=qd();return s.online?s.effectiveType==="slow-2g"||s.effectiveType==="2g"?{quality:"poor",message:"Slow connection detected"}:s.effectiveType==="3g"?{quality:"fair",message:"Moderate connection speed"}:s.effectiveType==="4g"?{quality:"good",message:"Good connection speed"}:{quality:"unknown",message:"Connection quality unknown"}:{quality:"offline",message:"No internet connection"}}function rr(s){if(!s)return"new";const e=s.trim().toLowerCase();return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[e]||"new"}function I0(s){return"Tsh "+Number(s).toLocaleString("en-TZ",{minimumFractionDigits:0,maximumFractionDigits:0})}async function Fd(){const s="fetchAllCustomers";if(He.has(s))return He.get(s);const e=zd();He.set(s,e);try{return await e}finally{setTimeout(()=>{He.delete(s)},1e3)}}async function zd(){if(navigator.onLine)try{const s=localStorage.getItem("current_branch_id");let e="shared",t=!0;if(s)try{const{data:l}=await Le().from("store_locations").select("data_isolation_mode, share_customers").eq("id",s).single();l&&(e=l.data_isolation_mode,t=e==="shared"||e==="hybrid"&&l.share_customers)}catch{console.warn(" Could not fetch branch settings, defaulting to shared mode")}const{count:r,error:a}=await Xt(Yt(async()=>{let l=Le().from("customers").select("id",{count:"exact",head:!0});s&&!t&&(l=l.eq("branch_id",s));const d=await l;if(d.error)throw d.error;return d}),yt);if(a)throw console.error(""),console.error(" ERROR COUNTING CUSTOMERS"),console.error(""),console.error("Error:",a),console.error(""),a;const n=Ud,o=Math.ceil((r||0)/n),i=[],c=Math.min(o,100);for(let l=1;l<=c;l++){const d=(l-1)*n,u=d+n-1;try{const{data:h,error:g}=await Xt(Yt(async()=>{let p=Le().from("customers").select(`
                  id,name,phone,email,whatsapp,gender,city,country,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,birthday,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared,created_by_branch_id,created_by_branch_name,profile_image,whatsapp_opt_out,referred_by,created_by,last_purchase_date,total_purchases,total_calls,total_call_duration_minutes,incoming_calls,outgoing_calls,missed_calls,avg_call_duration_minutes,first_call_date,last_call_date,call_loyalty_level,total_returns
                `).range(d,u).order("created_at",{ascending:!1});s&&(e==="isolated"?(p=p.eq("branch_id",s),console.log(` [fetchAllCustomers] ISOLATED MODE - Only showing customers from branch ${s}`)):e==="shared"?console.log(" [fetchAllCustomers] SHARED MODE - Showing all customers"):e==="hybrid"&&(t?console.log(" [fetchAllCustomers] HYBRID MODE - Customers are SHARED - Showing all customers"):(p=p.eq("branch_id",s),console.log(` [fetchAllCustomers] HYBRID MODE - Customers are NOT SHARED - Only showing branch ${s}`))));const m=await p;if(m.error)throw m.error;return m}),yt);if(g)throw console.error(""),console.error(` ERROR FETCHING PAGE ${l}/${c}`),console.error(""),console.error("Error:",g),console.error("Page range:",d,"-",u),console.error("Branch filter:",s||"NONE"),console.error(""),g;if(h&&h.length>0){const p=[...new Set(h.map(_=>_.branch_id))],m=h.filter(_=>!_.branch_id).length;m>0&&console.warn(`     ${m} customers WITHOUT branch_id (will be invisible in filtered view)`)}if(h&&Array.isArray(h)){const p=(b,S=0)=>{if(b==null)return S;const v=typeof b=="string"?parseFloat(b):Number(b);return isNaN(v)||v>1e12||v<0?(console.warn(" Detected corrupted value:",b,"- resetting to",S),S):v};let m={};try{const b=[...new Set(h.map(S=>S.branch_id).filter(Boolean))];if(b.length>0){const v=await Le().from("store_locations").select("id, name").in("id",b);v.data&&(m=v.data.reduce((C,T)=>(C[T.id]=T.name,C),{}))}}catch(b){console.warn(" Could not fetch branch names:",b)}const _=h.map(b=>({id:b.id,name:b.name,email:b.email,phone:b.phone,gender:b.gender,city:b.city,joinedDate:b.joined_date||b.created_at,loyaltyLevel:b.loyalty_level,colorTag:rr(b.color_tag||"new"),referredBy:null,totalSpent:p(b.total_spent,0),points:p(b.points,0),lastVisit:b.last_visit,branchName:m[b.branch_id]||b.created_by_branch_name||"Unknown Branch",isActive:b.is_active,referralSource:b.referral_source,birthMonth:b.birth_month,birthDay:b.birth_day,totalReturns:0,profileImage:null,createdAt:b.created_at,updatedAt:b.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,whatsapp:b.phone,whatsappOptOut:!1,initialNotes:b.initial_notes,locationDescription:b.location_description,nationalId:b.national_id,notes:b.notes?typeof b.notes=="string"?(()=>{try{return JSON.parse(b.notes)}catch{return[]}})():b.notes:[],referrals:[],customerTag:b.customer_tag,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[],branchId:b.branch_id,createdByBranchId:b.created_by_branch_id,createdByBranchName:b.created_by_branch_name}));i.push(..._)}l<c&&await new Promise(p=>setTimeout(p,jd))}catch(h){console.error(` Failed to fetch page ${l}:`,h);break}}if(s){const l=[...new Set(i.map(g=>g.branchId))],d=i.filter(g=>!g.branchId).length,u=i.filter(g=>g.branchId&&g.branchId!==s).length;d>0&&console.warn(`     ${d} customers missing branch_id`),(e==="isolated"||e==="hybrid"&&!t)&&u>0&&(console.error(`    ${u} customers from WRONG branch!`),console.error("    This indicates a filtering problem!"))}else{console.warn("  No Branch Filter:"),console.warn("   - Fetched customers from ALL branches");const l=[...new Set(i.map(u=>u.branchId).filter(Boolean))];console.warn("   - Branches represented:",l.length),console.warn("   - Branch IDs:",l);const d=i.filter(u=>!u.branchId).length;d>0&&console.warn(`   - ${d} customers without branch_id`)}return i.slice(0,3).forEach((l,d)=>{}),i}catch(s){throw console.error(" Error fetching customers:",s),s}else return await z(()=>Promise.resolve().then(()=>Pr),void 0).then(e=>e.cacheGetAll("customers"))||[]}async function Vd(){const s="fetchAllCustomersLight";if(He.has(s))return He.get(s);const e=Wd();He.set(s,e);try{return await e}finally{setTimeout(()=>{He.delete(s)},1e3)}}async function Gd(){const s="fetchAllCustomersSimple";if(He.has(s))return He.get(s);const e=Hd();He.set(s,e);try{return await e}finally{setTimeout(()=>{He.delete(s)},1e3)}}async function Wd(){if(navigator.onLine)try{const s=localStorage.getItem("current_branch_id");let e="shared",t=!0;if(s)try{const{data:n}=await Le().from("store_locations").select("data_isolation_mode, share_customers").eq("id",s).single();n&&(e=n.data_isolation_mode,t=e==="shared"||e==="hybrid"&&n.share_customers)}catch{console.warn(" Could not fetch branch settings, defaulting to shared mode")}const{data:r,error:a}=await Xt(Yt(async()=>{let n=Le().from("customers").select(`
              id,name,phone,email,is_active,total_spent,last_visit,points,city,branch_id
            `).order("id",{ascending:!1}).limit(2e3);return s&&(e==="isolated"?(n=n.eq("branch_id",s),console.log(` [fetchAllCustomersLight] ISOLATED MODE - Only showing customers from branch ${s}`)):e==="shared"?console.log(" [fetchAllCustomersLight] SHARED MODE - Showing all customers"):e==="hybrid"&&(t?console.log(" [fetchAllCustomersLight] HYBRID MODE - Customers are SHARED - Showing all customers"):(n=n.eq("branch_id",s),console.log(` [fetchAllCustomersLight] HYBRID MODE - Customers are NOT SHARED - Only showing branch ${s}`)))),await n}),yt);if(a){console.error(" Error fetching customers (light):",a);try{const n=await z(()=>Promise.resolve().then(()=>Pr),void 0).then(o=>o.cacheGetAll("customers"));if(n&&n.length>0)return console.log(` Using cached customers (${n.length}) due to fetch error`),n}catch{}throw a}return console.log(` Fetched ${(r==null?void 0:r.length)||0} customers (lightweight)`),r||[]}catch(s){console.error(" Error fetching customers (light):",s.message||s);try{const e=await z(()=>Promise.resolve().then(()=>Pr),void 0).then(t=>t.cacheGetAll("customers"));if(e&&e.length>0)return console.log(` Using cached customers (${e.length}) due to error`),e}catch(e){console.warn(" Could not load cached customers:",e)}return console.warn(" Returning empty customer array due to error"),[]}else return await z(()=>Promise.resolve().then(()=>Pr),void 0).then(e=>e.cacheGetAll("customers"))||[]}async function Hd(){if(navigator.onLine)try{const s=localStorage.getItem("current_branch_id");let e="shared",t=!0;if(s)try{const{data:o}=await Le().from("store_locations").select("data_isolation_mode, share_customers").eq("id",s).single();o&&(e=o.data_isolation_mode,t=e==="shared"||e==="hybrid"&&o.share_customers)}catch{console.warn(" Could not fetch branch settings, defaulting to shared mode")}const r=await Xt(Yt(async()=>{let o=Le().from("customers").select("id",{count:"exact",head:!0});return s&&!t&&(o=o.eq("branch_id",s)),await o}),yt);if(r.error)throw console.error(" Error getting customer count:",r.error),console.error(" Error details:",JSON.stringify(r.error,null,2)),r.error;const n=r.count??-1;if((n>0||n===-1)&&(n<=1e5||n===-1)){const{data:o,error:i}=await Xt(Yt(async()=>{let c=Le().from("customers").select(`
                id,name,phone,email,whatsapp,gender,city,country,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,birthday,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared,created_by_branch_id,created_by_branch_name,profile_image,whatsapp_opt_out,referred_by,created_by,last_purchase_date,total_purchases,total_calls,total_call_duration_minutes,incoming_calls,outgoing_calls,missed_calls,avg_call_duration_minutes,first_call_date,last_call_date,call_loyalty_level,total_returns
              `).order("created_at",{ascending:!1}).limit(1e5);s&&(e==="isolated"?(c=c.eq("branch_id",s),console.log(` [fetchAllCustomersSimple] ISOLATED MODE - Only showing customers from branch ${s}`)):e==="shared"?console.log(" [fetchAllCustomersSimple] SHARED MODE - Showing all customers"):e==="hybrid"&&(t?console.log(" [fetchAllCustomersSimple] HYBRID MODE - Customers are SHARED - Showing all customers"):(c=c.eq("branch_id",s),console.log(` [fetchAllCustomersSimple] HYBRID MODE - Customers are NOT SHARED - Only showing branch ${s}`))));const l=await c;if(l.error)throw l.error;return l}),yt);if(i)throw console.error(" Error fetching customers (simple):",i),console.error(" Error details:",JSON.stringify(i,null,2)),console.error(" Error message:",i==null?void 0:i.message),console.error(" Error code:",i==null?void 0:i.code),console.error(" Error hint:",i==null?void 0:i.hint),console.error(" Error details:",i==null?void 0:i.details),i;if(o&&Array.isArray(o)){o.length>0;const c=(u,h=0)=>{if(u==null)return h;const g=typeof u=="string"?parseFloat(u):Number(u);return isNaN(g)||g>1e12||g<0?(console.warn(" Detected corrupted value:",u,"- resetting to",h),h):g};let l={};try{const u=[...new Set(o.map(h=>h.branch_id).filter(Boolean))];if(u.length>0){const g=await Le().from("store_locations").select("id, name").in("id",u);g.data&&(l=g.data.reduce((p,m)=>(p[m.id]=m.name,p),{}))}}catch(u){console.warn(" Could not fetch branch names:",u)}return o.map(u=>({id:u.id,name:u.name||"Unknown Customer",phone:u.phone||`NO_PHONE_${u.id}`,email:u.email||"",gender:u.gender||"other",city:u.city||"",colorTag:rr(u.color_tag||"new"),loyaltyLevel:u.loyalty_level||"interested",points:c(u.points,0),totalSpent:c(u.total_spent,0),lastVisit:u.last_visit||u.created_at,isActive:u.is_active!==!1,referralSource:u.referral_source,birthMonth:u.birth_month,birthDay:u.birth_day,totalReturns:0,profileImage:null,branchName:l[u.branch_id]||u.created_by_branch_name||"Unknown Branch",whatsapp:u.phone,whatsappOptOut:!1,initialNotes:u.initial_notes,notes:u.notes?typeof u.notes=="string"?(()=>{try{return JSON.parse(u.notes)}catch{return[]}})():u.notes:[],referrals:[],customerTag:u.customer_tag,joinedDate:u.joined_date||u.created_at,createdAt:u.created_at,updatedAt:u.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:u.location_description,nationalId:u.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[],branchId:u.branch_id,createdByBranchId:u.created_by_branch_id,createdByBranchName:u.created_by_branch_name}))}else return console.warn(" No customer data returned from query"),[]}else{if(n===0)return[];const{data:o,error:i}=await Xt(Yt(async()=>{let c=Le().from("customers").select("id,name,phone,email,gender,city,color_tag,loyalty_level,points,total_spent,last_visit,is_active,referral_source,birth_month,birth_day,initial_notes,notes,customer_tag,location_description,national_id,joined_date,created_at,updated_at,branch_id,is_shared").order("created_at",{ascending:!1}).limit(1e5);s&&!t&&(c=c.or(`branch_id.eq.${s},is_shared.eq.true`));const l=await c;if(l.error)throw l.error;return l}),yt);if(i)throw console.error(" Error fetching customers (fallback):",i),i;return o&&Array.isArray(o)?(o.length>0,o.map(l=>({id:l.id,name:l.name||"Unknown Customer",phone:l.phone||`NO_PHONE_${l.id}`,email:l.email||"",gender:l.gender||"other",city:l.city||"",colorTag:rr(l.color_tag||"new"),loyaltyLevel:l.loyalty_level||"bronze",points:l.points||0,totalSpent:l.total_spent||0,lastVisit:l.last_visit||l.created_at,isActive:l.is_active!==!1,referralSource:l.referral_source,birthMonth:l.birth_month,birthDay:l.birth_day,totalReturns:0,profileImage:null,whatsapp:l.phone,whatsappOptOut:!1,initialNotes:l.initial_notes,notes:l.notes?typeof l.notes=="string"?(()=>{try{return JSON.parse(l.notes)}catch{return[]}})():l.notes:[],referrals:[],customerTag:l.customer_tag,joinedDate:l.joined_date||l.created_at,createdAt:l.created_at,updatedAt:l.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:l.location_description,nationalId:l.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]}))):[]}}catch(s){throw console.error(" Error fetching customers (simple):",s),console.error(" Error type:",typeof s),console.error(" Error stringified:",JSON.stringify(s,null,2)),s&&typeof s=="object"&&(console.error(" Error keys:",Object.keys(s)),console.error(" Error message:",s==null?void 0:s.message),console.error(" Error code:",s==null?void 0:s.code),console.error(" Error hint:",s==null?void 0:s.hint),console.error(" Error details:",s==null?void 0:s.details)),s}else return await z(()=>Promise.resolve().then(()=>Pr),void 0).then(e=>e.cacheGetAll("customers"))||[]}async function C0(s){try{const{data:e,error:t}=await Le().from("customers").select(`
        id,
        name,
        phone,
        email,
        whatsapp,
        gender,
        city,
        country,
        address,
        color_tag,
        loyalty_level,
        points,
        total_spent,
        last_visit,
        is_active,
        referral_source,
        birth_month,
        birth_day,
        birthday,
        initial_notes,
        notes,
        customer_tag,
        location_description,
        national_id,
        joined_date,
        created_at,
        updated_at,
        branch_id,
        is_shared,
        created_by_branch_id,
        created_by_branch_name,
        profile_image,
        whatsapp_opt_out,
        referred_by,
        created_by,
        last_purchase_date,
        total_purchases,
        total_calls,
        total_call_duration_minutes,
        incoming_calls,
        outgoing_calls,
        missed_calls,
        avg_call_duration_minutes,
        first_call_date,
        last_call_date,
        call_loyalty_level,
        total_returns
      `).eq("id",s).single();if(t)throw console.error(" Error fetching customer by ID:",t),t;return e&&!t&&typeof e=="object"&&"id"in e?{id:e.id,name:e.name,phone:e.phone,email:e.email,gender:e.gender||"other",city:e.city||"",colorTag:rr(e.color_tag||"new"),loyaltyLevel:e.loyalty_level||"bronze",points:e.points||0,totalSpent:e.total_spent||0,lastVisit:e.last_visit||e.created_at,isActive:e.is_active!==!1,referralSource:e.referral_source,birthMonth:e.birth_month,birthDay:e.birth_day,totalReturns:0,profileImage:null,whatsapp:e.phone,whatsappOptOut:!1,initialNotes:e.initial_notes,notes:e.notes?typeof e.notes=="string"?(()=>{try{return JSON.parse(e.notes)}catch{return[]}})():e.notes:[],referrals:[],customerTag:e.customer_tag,joinedDate:e.joined_date||e.created_at,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:null,lastPurchaseDate:null,totalPurchases:0,birthday:null,referredBy:null,locationDescription:e.location_description,nationalId:e.national_id,totalCalls:0,totalCallDurationMinutes:0,incomingCalls:0,outgoingCalls:0,missedCalls:0,avgCallDurationMinutes:0,firstCallDate:"",lastCallDate:"",callLoyaltyLevel:"Basic",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]}:null}catch(e){throw console.error(" Error fetching customer by ID:",e),e}}async function Qd(s){var e;try{const t={colorTag:"color_tag",isActive:"is_active",isShared:"is_shared",lastVisit:"last_visit",joinedDate:"joined_date",loyaltyLevel:"loyalty_level",totalSpent:"total_spent",referralSource:"referral_source",birthMonth:"birth_month",birthDay:"birth_day",totalReturns:"total_returns",initialNotes:"initial_notes",locationDescription:"location_description",nationalId:"national_id",customerTag:"customer_tag",createdAt:"created_at",updatedAt:"updated_at",createdBy:"created_by",whatsapp:"whatsapp",branchId:"branch_id",createdByBranchId:"created_by_branch_id",createdByBranchName:"created_by_branch_name"},r=["devices","promoHistory","payments","notes","referrals"],a={};Object.entries(s).forEach(([c,l])=>{if(!r.includes(c)&&l!=null){const d=t[c]||c;a[d]=l}});const n=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null;if(n){let c=null,l=null;try{const{data:d}=await Le().from("store_locations").select("id, name").eq("id",n).single();if(!d)throw new Error(`Branch ID ${n} not found in store_locations`);l=d.name;const{data:u,error:h}=await Le().from("lats_branches").select("id, name").eq("id",n).single();if(u&&!h)c=u.id,l=u.name||l,console.log(" Branch verified in lats_branches:",l);else{console.warn("  Creating branch in lats_branches with same ID...");const{data:g,error:p}=await Le().from("lats_branches").insert([{id:n,name:d.name,is_active:!0}]).select("id, name").single();if(g&&!p)c=g.id,l=g.name,console.log(" Created branch in lats_branches:",l);else throw new Error(`Failed to create branch: ${(p==null?void 0:p.message)||"Unknown error"}`)}}catch(d){throw console.error(" Error verifying branch:",d),new Error(`Failed to verify branch: ${d.message||"Unknown error"}`)}c&&(a.branch_id=c,a.created_by_branch_id=c,l&&(a.created_by_branch_name=l),a.is_shared=!1)}else console.warn("  No current branch ID found!"),console.warn("  Customer will be created WITHOUT branch assignment"),console.warn("  This customer will NOT appear in branch-filtered views"),console.warn(" Tip: Make sure a branch is selected before creating customers");if(a.color_tag){const c=a.color_tag;a.color_tag=rr(a.color_tag)}if(!a.phone||a.phone.trim()===""){const c=`NO_PHONE_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;console.warn(`  No phone provided, generating: ${c}`),a.phone=c}const{data:o,error:i}=await Le().from("customers").insert([a]).select().single();if(i)throw console.error(""),console.error(" DATABASE INSERT FAILED"),console.error(""),console.error("Supabase Error Details:"),console.error("  Error Message:",i.message),console.error("  Error Code:",i.code),console.error("  Error Details:",i.details),console.error("  Error Hint:",i.hint),console.error("Full Error Object:",i),console.error(""),console.error("Database object that failed to insert:",a),console.error(""),i;return o!=null&&o.branch_id||(console.error(" CRITICAL WARNING "),console.error(""),console.error(" Customer was created WITHOUT branch_id in database!"),console.error(" This customer will NOT appear in branch-filtered queries!"),console.error(" User will NOT see this customer in their customer list!"),console.error(""),console.error("Possible causes:"),console.error("  1. No branch selected (check localStorage.current_branch_id)"),console.error('  2. Database column "branch_id" missing in customers table'),console.error("  3. Database permissions preventing branch_id insert"),console.error("")),o}catch(t){throw console.error(""),console.error(" customerApi.addCustomerToDb: EXCEPTION CAUGHT"),console.error(""),console.error("Exception Type:",((e=t==null?void 0:t.constructor)==null?void 0:e.name)||"Unknown"),console.error("Exception Message:",(t==null?void 0:t.message)||"No message"),console.error("Exception Code:",(t==null?void 0:t.code)||"No code"),console.error("Is Supabase Error:",t!=null&&t.code?"Yes":"No"),console.error("Full Exception:",t),console.error("Stack Trace:",(t==null?void 0:t.stack)||"No stack trace"),console.error(""),t}}async function _a(s,e){try{const t={colorTag:"color_tag",isActive:"is_active",isShared:"is_shared",lastVisit:"last_visit",joinedDate:"joined_date",loyaltyLevel:"loyalty_level",totalSpent:"total_spent",referralSource:"referral_source",birthMonth:"birth_month",birthDay:"birth_day",totalReturns:"total_returns",initialNotes:"initial_notes",locationDescription:"location_description",nationalId:"national_id",customerTag:"customer_tag",createdAt:"created_at",updatedAt:"updated_at",createdBy:"created_by",whatsapp:"whatsapp",branchId:"branch_id",createdByBranchId:"created_by_branch_id",createdByBranchName:"created_by_branch_name"},r={};Object.entries(e).forEach(([l,d])=>{if(d!=null){const u=t[l]||l;r[u]=d}}),r.updated_at=new Date().toISOString(),r.color_tag&&(r.color_tag=rr(r.color_tag)),r.phone!==void 0&&(!r.phone||r.phone.trim()==="")&&(r.phone=`NO_PHONE_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const a=["id","name","email","phone","gender","city","address","joined_date","loyalty_level","color_tag","total_spent","points","last_visit","is_active","referral_source","birth_month","birth_day","total_returns","initial_notes","notes","customer_tag","location_description","national_id","created_at","updated_at","branch_id","is_shared","created_by_branch_id","created_by_branch_name","whatsapp"],n={},o=[];Object.entries(r).forEach(([l,d])=>{a.includes(l)?l==="notes"&&Array.isArray(d)?n[l]=JSON.stringify(d):l==="points"&&typeof d=="string"?n[l]=parseInt(d,10)||0:l==="total_spent"&&typeof d=="string"?n[l]=parseFloat(d)||0:l==="total_returns"&&typeof d=="string"?n[l]=parseInt(d,10)||0:l==="is_active"&&typeof d=="string"?n[l]=d==="true"||d==="1":n[l]=d:(o.push(l),console.warn(` Skipping invalid field: ${l} (not in database schema)`))}),o.length>0&&console.warn(` Filtered out ${o.length} invalid fields:`,o);const{data:i,error:c}=await Le().from("lats_customers").update(n).eq("id",s).select().single();if(c)throw console.error(" Error updating customer:",c),console.error(" Error details:",{message:c.message,details:c.details,hint:c.hint,code:c.code}),console.error(" Update data that caused error:",n),c;try{await zi(s,"profile_updated")}catch{}return i}catch(t){throw console.error(" Error updating customer:",t),t}}function Kd(){He.clear()}const At=class At{constructor(){me(this,"status",{isAvailable:!0,requestCount:0,maxRequestsPerMinute:1})}static getInstance(){return At.instance||(At.instance=new At),At.instance}updateStatus(e){this.status={...this.status,...e}}getStatus(){return{...this.status}}isServiceAvailable(){if(!this.status.isAvailable){if(this.status.retryAfter&&Date.now()<this.status.retryAfter)return!1;this.status.isAvailable=!0,this.status.lastError=void 0,this.status.retryAfter=void 0}return this.status.isAvailable}getStatusMessage(){return this.status.isAvailable?this.status.requestCount>=this.status.maxRequestsPerMinute?"AI service rate limit reached. Please wait before making another request.":"AI service is available.":this.status.retryAfter?`AI service temporarily unavailable. Retry in ${Math.ceil((this.status.retryAfter-Date.now())/1e3)} seconds.`:"AI service temporarily unavailable. Please try again later."}getStatusColor(){return this.status.isAvailable?this.status.requestCount>=this.status.maxRequestsPerMinute?"yellow":"green":"red"}incrementRequestCount(){this.status.requestCount++,setTimeout(()=>{this.status.requestCount=Math.max(0,this.status.requestCount-1)},6e4)}markServiceUnavailable(e,t=3e5){this.status.isAvailable=!1,this.status.lastError=e,this.status.lastErrorTime=Date.now(),this.status.retryAfter=Date.now()+t}};me(At,"instance");let ya=At;const Kr=ya.getInstance(),ot={websocket:{maxRetries:5,baseDelay:1e3,reconnectInterval:5e3},images:{maxFileSize:5*1024*1024,maxWidth:800,maxHeight:800,quality:.8,allowedTypes:["image/jpeg","image/png","image/webp"],loading:{timeout:1e4,retryAttempts:2,useFallbacks:!0,blockUnreliableUrls:!0}},api:{baseUrl:"http://localhost:8000",timeout:3e4,maxRetries:3},realtime:{enabled:!0,stockUpdateInterval:5e3,productUpdateInterval:1e4,connection:{maxRetries:1,retryDelay:5e3,maxRetryDelay:15e3,connectionTimeout:1e4,cooldownPeriod:3e4,circuitBreakerTimeout:12e4}},audio:{enabled:!0,volume:.5,sounds:{notification:"/sounds/notification.mp3",error:"/sounds/error.mp3",success:"/sounds/success.mp3"}},errors:{showNotifications:!0,logToConsole:!0,retryOnFailure:!0},development:{debugMode:!1,mockData:{}.VITE_USE_MOCK_DATA==="true",logLevel:"info"},http:{maxHeaderSize:8192,requestTimeout:3e4,retryAttempts:3},ai:{enabled:!0,gemini:{enabled:!0,maxRequestsPerMinute:2,minRequestInterval:3e4,errorCooldown:12e4},fallback:{enabled:!0}}},Jd=()=>{switch("production"){case"production":return{...ot,development:{...ot.development,debugMode:!1,logLevel:"warn"},realtime:{...ot.realtime,connection:{...ot.realtime.connection,maxRetries:2}}};case"test":return{...ot,realtime:{...ot.realtime,enabled:!1},audio:{...ot.audio,enabled:!1}};default:return ot}};Jd();const kt=class kt{constructor(){me(this,"apiKey",null);me(this,"baseUrl","https://generativelanguage.googleapis.com/v1beta/models");me(this,"config",{model:"gemini-1.5-flash",temperature:.7,maxTokens:1e3});me(this,"requestCount",0);me(this,"lastRequestTime",0);me(this,"maxRequestsPerMinute",1);me(this,"minRequestInterval",6e4);me(this,"serviceAvailable",!0);me(this,"lastErrorTime",0);me(this,"errorCooldown",3e5);me(this,"consecutiveErrors",0);me(this,"maxConsecutiveErrors",2);me(this,"requestQueue",[]);me(this,"isProcessingQueue",!1);this.apiKey={}.VITE_GEMINI_API_KEY||null,Kr.updateStatus({isAvailable:!0,requestCount:0,maxRequestsPerMinute:this.maxRequestsPerMinute}),this.loadApiKeyFromDatabase()}async loadApiKeyFromDatabase(){var e;try{const{getIntegration:t}=await z(()=>Promise.resolve().then(()=>wa),void 0),r=await t("GEMINI_AI");r&&r.is_enabled&&((e=r.credentials)!=null&&e.api_key)?(this.apiKey=r.credentials.api_key,console.log(" Gemini API key loaded from database")):!this.apiKey&&!kt.hasShownApiKeyWarning&&(console.debug(" Gemini API key not found in database or environment. AI features will be disabled until configured."),kt.hasShownApiKeyWarning=!0)}catch(t){kt.hasShownApiKeyWarning||(console.debug(" Error fetching Gemini credentials from database (this is normal if not configured):",t),kt.hasShownApiKeyWarning=!0)}}setApiKey(e){this.apiKey=e}isServiceEnabled(){return ot.ai.enabled&&ot.ai.gemini.enabled}canMakeRequest(){const e=Date.now();return!this.serviceAvailable&&e-this.lastErrorTime<this.errorCooldown?(console.warn(" Gemini service in cooldown, cannot make request"),!1):this.requestCount>=this.maxRequestsPerMinute?(console.warn(" Rate limit reached, cannot make request"),!1):e-this.lastRequestTime<this.minRequestInterval?(console.warn(" Minimum interval not met, cannot make request"),!1):!0}updateRequestTracking(){this.requestCount++,this.lastRequestTime=Date.now(),Kr.incrementRequestCount(),setTimeout(()=>{this.requestCount=Math.max(0,this.requestCount-1)},6e4)}markServiceUnavailable(){this.serviceAvailable=!1,this.lastErrorTime=Date.now(),this.consecutiveErrors++;const e=Math.min(this.errorCooldown*Math.pow(2,this.consecutiveErrors-1),9e5);console.warn(` Gemini service marked unavailable. Backoff time: ${e/1e3}s (error #${this.consecutiveErrors})`),Kr.markServiceUnavailable("Rate limit exceeded",e),setTimeout(()=>{this.serviceAvailable=!0,console.log(" Gemini service re-enabled after backoff"),Kr.updateStatus({isAvailable:!0})},e)}resetErrorCount(){this.consecutiveErrors=0}async processQueue(){if(!(this.isProcessingQueue||this.requestQueue.length===0)){for(this.isProcessingQueue=!0;this.requestQueue.length>0;){const e=this.requestQueue.shift();if(e)try{await e(),await new Promise(t=>setTimeout(t,this.minRequestInterval))}catch(t){console.error("Error processing queued request:",t)}}this.isProcessingQueue=!1}}async queueRequest(e){return new Promise((t,r)=>{this.requestQueue.push(async()=>{try{const a=await e();t(a)}catch(a){r(a)}}),this.processQueue()})}async testConnection(){return this.isServiceEnabled()?this.apiKey?this.queueRequest(async()=>{try{const e=await fetch(`${this.baseUrl}/${this.config.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:"Hello, this is a test message."}]}],generationConfig:{temperature:.1,maxOutputTokens:10}})});return e.ok?(this.serviceAvailable=!0,this.resetErrorCount(),{success:!0,data:"Connection successful"}):(this.markServiceUnavailable(),{success:!1,error:`Connection failed: ${e.status}`})}catch(e){return this.markServiceUnavailable(),{success:!1,error:`Connection error: ${e}`}}}):{success:!1,error:"API key not configured"}:(console.log(" AI service disabled in configuration, skipping connection test"),{success:!1,error:"AI service disabled in configuration"})}async chat(e){return this.isServiceEnabled()?this.apiKey?this.canMakeRequest()?this.queueRequest(async()=>{var t,r,a,n,o,i,c;try{this.updateRequestTracking();const l=e.map(h=>({parts:[{text:h.content}],role:h.role==="user"?"user":"model"})),d=await fetch(`${this.baseUrl}/${this.config.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:l,generationConfig:{temperature:this.config.temperature,maxOutputTokens:this.config.maxTokens}})}),u=await d.json();return d.status===429?(console.warn(" Gemini API rate limit exceeded (429). Service will be unavailable for backoff period."),this.markServiceUnavailable(),{success:!1,error:"API rate limit exceeded. Please try again later."}):d.ok&&((o=(n=(a=(r=(t=u.candidates)==null?void 0:t[0])==null?void 0:r.content)==null?void 0:a.parts)==null?void 0:n[0])!=null&&o.text)?(this.serviceAvailable=!0,this.resetErrorCount(),console.log(" Gemini API request successful"),{success:!0,data:u.candidates[0].content.parts[0].text}):(console.warn(" Gemini API request failed:",((i=u.error)==null?void 0:i.message)||"Unknown error"),this.markServiceUnavailable(),{success:!1,error:((c=u.error)==null?void 0:c.message)||"AI request failed"})}catch(l){return this.markServiceUnavailable(),{success:!1,error:`Network error: ${l}`}}}):{success:!1,error:"Service temporarily unavailable due to rate limiting or errors"}:{success:!1,error:"API key not configured"}:(console.log(" AI service disabled in configuration, returning fallback response"),{success:!1,error:"AI service disabled in configuration"})}async generateCustomerResponse(e,t){const r=await this.chat([{role:"user",content:`You are a helpful customer service representative. Please respond to this customer query in a friendly and professional manner: "${e}"${t?`

Context: ${t}`:""}`}]);return r.success?r:{success:!0,data:this.getFallbackCustomerResponse(e)}}async generateInventoryResponse(e,t){const r=await this.chat([{role:"user",content:`You are an inventory management assistant. Please help with this inventory query: "${e}"${t?`

Product Data: ${JSON.stringify(t)}`:""}`}]);return r.success?r:{success:!0,data:this.getFallbackInventoryResponse(e)}}async analyzeExpense(e,t){const r=await this.chat([{role:"user",content:`Please analyze this business expense and provide insights: Description: "${e}", Amount: $${t}`}]);return r.success?r:{success:!0,data:this.getFallbackExpenseAnalysis(e,t)}}getFallbackCustomerResponse(e){const t=e.toLowerCase();return t.includes("hello")||t.includes("hi")?"Hello! Thank you for contacting us. How can I assist you today?":t.includes("help")||t.includes("support")?"I'm here to help! Please let me know what specific assistance you need, and I'll do my best to support you.":t.includes("price")||t.includes("cost")?"For pricing information, please contact our sales team or check our website. I can also help you find specific product details.":t.includes("order")||t.includes("purchase")?"I'd be happy to help you with your order! Please provide more details about what you're looking to purchase.":"Thank you for your message. I'm here to help with any questions or concerns you may have. Please let me know how I can assist you further."}getFallbackInventoryResponse(e){const t=e.toLowerCase();return t.includes("stock")||t.includes("available")?"I can help you check stock availability. Please specify which product you're looking for, and I'll check our inventory.":t.includes("product")||t.includes("item")?"I can help you find product information. Please provide the product name or category you're interested in.":t.includes("order")||t.includes("purchase")?"I can help you with inventory-related orders. Please let me know what products you need and the quantity.":"I'm here to help with inventory management. Please let me know what specific information you need about our products or stock levels."}getFallbackExpenseAnalysis(e,t){return`Expense Analysis:
    
Description: ${e}
Amount: $${t}

Key Insights:
 This appears to be a business expense
 Amount: $${t}
 Category: ${this.categorizeExpense(e)}

Recommendations:
 Keep detailed records for tax purposes
 Consider if this expense is necessary for business operations
 Review if there are more cost-effective alternatives

Please consult with your accountant for specific tax advice.`}categorizeExpense(e){const t=e.toLowerCase();return t.includes("office")||t.includes("supplies")?"Office Supplies":t.includes("travel")||t.includes("transport")?"Travel":t.includes("meal")||t.includes("food")?"Meals & Entertainment":t.includes("equipment")||t.includes("hardware")?"Equipment":t.includes("software")||t.includes("subscription")?"Software/Subscriptions":t.includes("marketing")||t.includes("advertising")?"Marketing":"General Business Expense"}getRateLimitStatus(){const t=Date.now()-this.lastRequestTime,r=Math.max(0,this.maxRequestsPerMinute-this.requestCount),a=this.isServiceEnabled()&&this.canMakeRequest(),n=this.isServiceEnabled()?this.serviceAvailable?"available":"unavailable":"disabled";return{requestsRemaining:r,timeSinceLastRequest:t,canMakeRequest:a,serviceStatus:n,maxRequestsPerMinute:this.maxRequestsPerMinute,minRequestInterval:this.minRequestInterval,errorCooldown:this.errorCooldown,isEnabled:this.isServiceEnabled()}}isServiceAvailable(){return this.isServiceEnabled()&&this.serviceAvailable&&this.canMakeRequest()}};me(kt,"hasShownApiKeyWarning",!1);let ba=kt;const jn=new ba;async function Yd(){const{data:s,error:e}=await w.from("lats_pos_integrations_settings").select("*").order("integration_type",{ascending:!0}).order("integration_name",{ascending:!0});if(e)throw e;return s||[]}async function Xd(s){const{data:e,error:t}=await w.from("lats_pos_integrations_settings").select("*").eq("integration_type",s).order("integration_name",{ascending:!0});if(t)throw t;return e||[]}async function ks(s){const{data:e,error:t}=await w.from("lats_pos_integrations_settings").select("*").eq("integration_name",s).single();if(t){if(t.code==="PGRST116")return null;throw t}return e}async function Zd(){const{data:s,error:e}=await w.from("lats_pos_integrations_settings").select("*").eq("is_enabled",!0).eq("is_active",!0).order("integration_type",{ascending:!0});if(e)throw e;return s||[]}async function eh(s){const e=await ks(s);return!e||!e.is_enabled?null:e.credentials}async function Gi(s){var a;const{data:e}=await w.auth.getUser(),{data:t,error:r}=await w.from("lats_pos_integrations_settings").insert({...s,user_id:(a=e==null?void 0:e.user)==null?void 0:a.id}).select().single();if(r)throw r;return t}async function Wi(s,e){const{data:t,error:r}=await w.from("lats_pos_integrations_settings").update({...e,updated_at:new Date().toISOString()}).eq("integration_name",s).select().single();if(r)throw r;return t}async function th(s){var a;const{data:e}=await w.auth.getUser(),t=s.user_id||((a=e==null?void 0:e.user)==null?void 0:a.id);return await ks(s.integration_name)?await Wi(s.integration_name,{...s,user_id:t}):await Gi({...s,user_id:t})}async function rh(s){const{error:e}=await w.from("lats_pos_integrations_settings").delete().eq("integration_name",s);if(e)throw e}async function sh(s,e){const{error:t}=await w.from("lats_pos_integrations_settings").update({is_enabled:e,is_active:e,updated_at:new Date().toISOString()}).eq("integration_name",s);if(t)throw t}async function Hi(s,e){const t=await ks(s);if(!t)return;const{error:r}=await w.from("lats_pos_integrations_settings").update({last_used_at:new Date().toISOString(),total_requests:(t.total_requests||0)+1,successful_requests:e?(t.successful_requests||0)+1:t.successful_requests,failed_requests:e?t.failed_requests:(t.failed_requests||0)+1,updated_at:new Date().toISOString()}).eq("integration_name",s);if(r)throw r}function ah(){return[{integration_name:"SMS_GATEWAY",integration_type:"sms",provider_name:"MShastra",icon:"Smartphone",description:"Send SMS notifications and receipts via MShastra (Tanzania)",credentials_fields:[{name:"api_key",label:"API Username",type:"text",required:!0,placeholder:"Your MShastra username"},{name:"api_password",label:"API Password",type:"password",required:!0,placeholder:"Your MShastra password"},{name:"sender_id",label:"Sender ID",type:"text",required:!0,placeholder:"LATS POS"}],config_fields:[{name:"api_url",label:"API URL",type:"url",required:!0,placeholder:"https://api.mshastra.com/sms"},{name:"priority",label:"Priority",type:"select",required:!1,options:[{value:"High",label:"High"},{value:"Medium",label:"Medium"},{value:"Low",label:"Low"}]},{name:"country_code",label:"Country Code",type:"text",required:!1,placeholder:"ALL"},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"3"},{name:"timeout",label:"Timeout (ms)",type:"number",required:!1,placeholder:"30000"}]},{integration_name:"WHATSAPP_GATEWAY",integration_type:"whatsapp",provider_name:"Green API",icon:"MessageCircle",description:"Send WhatsApp messages, receipts, and media via Green API",credentials_fields:[{name:"instance_id",label:"Instance ID",type:"text",required:!0,placeholder:"7105284900"},{name:"api_token",label:"API Token",type:"password",required:!0,placeholder:"Your Green API token"},{name:"phone_number",label:"WhatsApp Phone Number",type:"text",required:!1,placeholder:"+255712345678 (optional)"}],config_fields:[{name:"api_url",label:"API URL / Host",type:"url",required:!0,placeholder:"https://7105.api.greenapi.com"},{name:"webhook_url",label:"Webhook URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/whatsapp/webhook"},{name:"webhook_token",label:"Webhook Token",type:"password",required:!1,placeholder:"Webhook verification token"},{name:"link_preview",label:"Enable Link Preview",type:"checkbox",required:!1},{name:"mark_messages_read",label:"Auto-mark Messages as Read",type:"checkbox",required:!1},{name:"delay_send_ms",label:"Delay Between Messages (ms)",type:"number",required:!1,placeholder:"1000"}]},{integration_name:"WHATSAPP_WASENDER",integration_type:"whatsapp",provider_name:"WasenderAPI",icon:"MessageCircle",description:"Send WhatsApp messages, receipts, and media via WasenderAPI",credentials_fields:[{name:"api_key",label:"API Key (Bearer Token)",type:"password",required:!0,placeholder:"Your WasenderAPI bearer token"},{name:"session_id",label:"WhatsApp Session ID",type:"text",required:!0,placeholder:"Your WhatsApp session ID"}],config_fields:[{name:"api_url",label:"API Base URL",type:"url",required:!1,placeholder:"https://wasenderapi.com/api"},{name:"webhook_url",label:"Webhook URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/whatsapp/webhook"},{name:"webhook_token",label:"Webhook Token",type:"password",required:!1,placeholder:"Webhook verification token"}]},{integration_name:"EMAIL_SERVICE",integration_type:"email",provider_name:"SendGrid",icon:"Mail",description:"Send email receipts and notifications via SendGrid",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"SG.xxxxxx"},{name:"sender_email",label:"Sender Email",type:"text",required:!0,placeholder:"noreply@yourbusiness.com"},{name:"sender_name",label:"Sender Name",type:"text",required:!0,placeholder:"LATS CHANCE"}],config_fields:[{name:"template_id",label:"Default Template ID",type:"text",required:!1,placeholder:"d-xxxxxxxxxxxxxxxx"},{name:"enable_tracking",label:"Enable Open Tracking",type:"checkbox",required:!1},{name:"enable_click_tracking",label:"Enable Click Tracking",type:"checkbox",required:!1},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"2"},{name:"sandbox_mode",label:"Sandbox Mode",type:"checkbox",required:!1}]},{integration_name:"MPESA_PAYMENT",integration_type:"payment",provider_name:"M-Pesa",icon:"CreditCard",description:"Accept M-Pesa mobile money payments (Safaricom/Vodacom)",credentials_fields:[{name:"consumer_key",label:"Consumer Key",type:"password",required:!0,placeholder:"Your M-Pesa consumer key"},{name:"consumer_secret",label:"Consumer Secret",type:"password",required:!0,placeholder:"Your M-Pesa consumer secret"},{name:"business_short_code",label:"Business Shortcode",type:"text",required:!0,placeholder:"174379"},{name:"passkey",label:"Lipa Na M-Pesa Passkey",type:"password",required:!0,placeholder:"Your passkey"},{name:"initiator_name",label:"Initiator Name",type:"text",required:!1,placeholder:"testapi"},{name:"security_credential",label:"Security Credential",type:"password",required:!1,placeholder:"Encrypted password"}],config_fields:[{name:"transaction_type",label:"Transaction Type",type:"select",required:!0,options:[{value:"CustomerPayBillOnline",label:"Pay Bill"},{value:"CustomerBuyGoodsOnline",label:"Buy Goods"}]},{name:"callback_url",label:"Callback URL",type:"url",required:!0,placeholder:"https://yourapp.com/api/mpesa/callback"},{name:"timeout_url",label:"Timeout URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/mpesa/timeout"},{name:"result_url",label:"Result URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/mpesa/result"},{name:"enable_validation",label:"Enable Validation",type:"checkbox",required:!1}]},{integration_name:"STRIPE_PAYMENT",integration_type:"payment",provider_name:"Stripe",icon:"CreditCard",description:"Accept international card payments via Stripe",credentials_fields:[{name:"publishable_key",label:"Publishable Key",type:"text",required:!0,placeholder:"pk_test_xxxxx or pk_live_xxxxx"},{name:"secret_key",label:"Secret Key",type:"password",required:!0,placeholder:"sk_test_xxxxx or sk_live_xxxxx"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"whsec_xxxxx"}],config_fields:[{name:"currency",label:"Default Currency",type:"text",required:!0,placeholder:"usd"},{name:"capture_method",label:"Capture Method",type:"select",required:!1,options:[{value:"automatic",label:"Automatic"},{value:"manual",label:"Manual"}]},{name:"enable_saved_cards",label:"Enable Saved Cards",type:"checkbox",required:!1},{name:"statement_descriptor",label:"Statement Descriptor",type:"text",required:!1,placeholder:"LATS POS"}]},{integration_name:"GOOGLE_ANALYTICS",integration_type:"analytics",provider_name:"Google Analytics",icon:"BarChart",description:"Track user behavior, sales analytics, and ecommerce data",credentials_fields:[{name:"tracking_id",label:"Tracking ID (UA)",type:"text",required:!1,placeholder:"UA-XXXXXXXXX-X"},{name:"measurement_id",label:"Measurement ID (GA4)",type:"text",required:!0,placeholder:"G-XXXXXXXXXX"},{name:"api_secret",label:"API Secret (for server events)",type:"password",required:!1,placeholder:"Your API secret"}],config_fields:[{name:"enable_ecommerce",label:"Enable Ecommerce Tracking",type:"checkbox",required:!1},{name:"enable_enhanced_ecommerce",label:"Enable Enhanced Ecommerce",type:"checkbox",required:!1},{name:"anonymize_ip",label:"Anonymize IP Addresses",type:"checkbox",required:!1},{name:"debug_mode",label:"Debug Mode",type:"checkbox",required:!1}]},{integration_name:"GEMINI_AI",integration_type:"ai",provider_name:"Google Gemini",icon:"Zap",description:"AI-powered features, automation, and content generation",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"AIzaSy..."}],config_fields:[{name:"model",label:"Model",type:"select",required:!1,options:[{value:"gemini-1.5-flash",label:"Gemini 1.5 Flash (Fast)"},{value:"gemini-1.5-pro",label:"Gemini 1.5 Pro (Better Quality)"},{value:"gemini-pro",label:"Gemini Pro (Legacy)"}]},{name:"temperature",label:"Temperature (0-1)",type:"number",required:!1,placeholder:"0.7"},{name:"max_tokens",label:"Max Output Tokens",type:"number",required:!1,placeholder:"1000"},{name:"base_url",label:"API Base URL",type:"url",required:!1,placeholder:"https://generativelanguage.googleapis.com/v1beta/models"}]},{integration_name:"CUSTOM_API",integration_type:"custom",provider_name:"Custom API",icon:"Globe",description:"Integrate any custom API service or third-party platform",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your API key or token"},{name:"api_secret",label:"API Secret",type:"password",required:!1,placeholder:"API secret (if required)"},{name:"api_url",label:"API Base URL",type:"url",required:!0,placeholder:"https://api.example.com"},{name:"username",label:"Username",type:"text",required:!1,placeholder:"Username (if required)"}],config_fields:[{name:"auth_type",label:"Authentication Type",type:"select",required:!1,options:[{value:"bearer",label:"Bearer Token"},{value:"basic",label:"Basic Auth"},{value:"api_key",label:"API Key"},{value:"custom",label:"Custom"}]},{name:"timeout",label:"Timeout (ms)",type:"number",required:!1,placeholder:"30000"},{name:"max_retries",label:"Max Retries",type:"number",required:!1,placeholder:"3"},{name:"rate_limit",label:"Rate Limit (req/min)",type:"number",required:!1,placeholder:"60"}]},{integration_name:"BEEM_PAYMENT",integration_type:"payment",provider_name:"Beem Africa",icon:"CreditCard",description:"Accept payments via Beem Africa (Tanzania, Kenya, Uganda)",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your Beem API Key"},{name:"secret_key",label:"Secret Key",type:"password",required:!0,placeholder:"Your Beem Secret Key"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"Webhook verification secret"}],config_fields:[{name:"api_url",label:"API URL",type:"url",required:!0,placeholder:"https://beem.africa/api"},{name:"currency",label:"Default Currency",type:"select",required:!0,options:[{value:"TZS",label:"TZS - Tanzanian Shilling"},{value:"KES",label:"KES - Kenyan Shilling"},{value:"UGX",label:"UGX - Ugandan Shilling"},{value:"USD",label:"USD - US Dollar"}]},{name:"callback_url",label:"Callback URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/beem/callback"},{name:"auto_return",label:"Auto Return After Payment",type:"checkbox",required:!1},{name:"checkout_timeout",label:"Checkout Timeout (minutes)",type:"number",required:!1,placeholder:"30"}]},{integration_name:"ZENOPAY_PAYMENT",integration_type:"payment",provider_name:"ZenoPay",icon:"CreditCard",description:"Accept mobile money payments via ZenoPay with USSD popup",credentials_fields:[{name:"api_key",label:"API Key",type:"password",required:!0,placeholder:"Your ZenoPay API Key"},{name:"merchant_id",label:"Merchant ID",type:"text",required:!0,placeholder:"Your ZenoPay Merchant ID"},{name:"webhook_secret",label:"Webhook Secret",type:"password",required:!1,placeholder:"Webhook verification secret"}],config_fields:[{name:"api_url",label:"API Base URL",type:"url",required:!0,placeholder:"http://localhost:8000 (or production URL)"},{name:"callback_url",label:"Callback URL",type:"url",required:!1,placeholder:"https://yourapp.com/api/zenopay/callback"},{name:"enable_ussd_popup",label:"Enable USSD Popup",type:"checkbox",required:!1},{name:"ussd_timeout",label:"USSD Popup Timeout (seconds)",type:"number",required:!1,placeholder:"300"},{name:"retry_attempts",label:"Retry Attempts",type:"number",required:!1,placeholder:"3"}]},{integration_name:"GOOGLE_MAPS",integration_type:"maps",provider_name:"Google Maps",icon:"MapPin",description:"Location services, maps, and geofencing for attendance tracking",credentials_fields:[{name:"api_key",label:"Google Maps API Key",type:"password",required:!0,placeholder:"AIzaSy..."}],config_fields:[{name:"default_lat",label:"Default Latitude",type:"text",required:!1,placeholder:"-6.7924"},{name:"default_lng",label:"Default Longitude",type:"text",required:!1,placeholder:"39.2083"},{name:"default_zoom",label:"Default Zoom Level",type:"number",required:!1,placeholder:"13"},{name:"enable_geofencing",label:"Enable Geofencing",type:"checkbox",required:!1},{name:"geofence_radius",label:"Geofence Radius (meters)",type:"number",required:!1,placeholder:"100"}]},{integration_name:"HOSTINGER_STORAGE",integration_type:"storage",provider_name:"Hostinger",icon:"HardDrive",description:"Cloud file storage for logos, images, and documents via Hostinger",credentials_fields:[{name:"api_token",label:"Hostinger API Token",type:"password",required:!0,placeholder:"Your Hostinger API token"},{name:"domain",label:"Domain",type:"text",required:!0,placeholder:"yourdomain.com"}],config_fields:[{name:"api_endpoint",label:"API Endpoint",type:"url",required:!1,placeholder:"https://api.hostinger.com/v1"},{name:"default_path",label:"Default Upload Path",type:"text",required:!1,placeholder:"/uploads"},{name:"max_file_size",label:"Max File Size (MB)",type:"number",required:!1,placeholder:"10"},{name:"allowed_types",label:"Allowed File Types",type:"text",required:!1,placeholder:"jpg,png,pdf,doc"},{name:"auto_optimize",label:"Auto-Optimize Images",type:"checkbox",required:!1}]}]}const wa=Object.freeze(Object.defineProperty({__proto__:null,createIntegration:Gi,deleteIntegration:rh,getAllIntegrations:Yd,getCredentials:eh,getEnabledIntegrations:Zd,getIntegration:ks,getIntegrationTemplates:ah,getIntegrationsByType:Xd,toggleIntegration:sh,updateIntegration:Wi,updateIntegrationUsage:Hi,upsertIntegration:th},Symbol.toStringTag,{value:"Module"}));class Qi{constructor(){me(this,"apiKey",null);me(this,"apiUrl",null);me(this,"apiPassword",null);me(this,"initialized",!1);me(this,"initializationPromise",null);this.initializationPromise=this.initializeService()}async initializeService(){var e,t,r,a;try{console.debug(" Initializing SMS service from integrations...");const{getIntegration:n}=await z(()=>Promise.resolve().then(()=>wa),void 0),o=15e3,i=n("SMS_GATEWAY"),c=new Promise((d,u)=>setTimeout(()=>u(new Error("SMS initialization timeout")),o)),l=await Promise.race([i,c]);if(!l||!l.is_enabled){console.debug(" SMS integration not configured. SMS features will be disabled until configured in Admin Settings  Integrations"),this.initialized=!0;return}this.apiKey=((e=l.credentials)==null?void 0:e.api_key)||null,this.apiPassword=((t=l.credentials)==null?void 0:t.api_password)||((r=l.credentials)==null?void 0:r.api_secret)||null,this.apiUrl=((a=l.config)==null?void 0:a.api_url)||"https://mshastra.com/sendurl.aspx",console.debug(" SMS credentials loaded from integrations"),console.debug(" API Key:",this.apiKey?" Configured":" Missing"),console.debug(" API URL:",this.apiUrl?" Configured":" Missing"),console.debug(" Password:",this.apiPassword?" Configured":" Missing"),!this.apiKey||!this.apiUrl?console.debug(" SMS service not fully configured. SMS notifications will fail until configured in Admin Settings  Integrations"):console.debug(" SMS service initialized successfully"),this.initialized=!0}catch(n){const o=n instanceof Error?n.message:"Unknown error";o.includes("timeout")?console.debug(" SMS service initialization timed out (normal during cold starts) - will retry on first use"):console.warn(" SMS service configuration error:",o),this.initialized=!0}}async ensureInitialized(){!this.initialized&&this.initializationPromise&&await this.initializationPromise}async sendSMS(e,t,r){try{await this.ensureInitialized();let a=t,n=!1,o=null;if(r!=null&&r.ai_enhanced){const u=await this.enhanceMessageWithAI(t,e);u.success&&(a=u.enhanced_message,n=!0,o=u.personalization_data)}const i=await this.sendSMSToProvider(e,a);Hi("SMS_GATEWAY",i.success).catch(u=>console.warn("Could not update integration usage:",u));const c={recipient_phone:e,message:a,status:i.success?"sent":"failed",sent_at:new Date().toISOString(),created_at:new Date().toISOString()};i.error&&(c.error_message=i.error);const{data:l,error:d}=await w.from("sms_logs").insert(c).select().single();return d&&console.error("Error logging SMS:",d),{success:i.success,error:i.error,log_id:l==null?void 0:l.id}}catch(a){return console.error("SMS send error:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async sendBulkSMS(e){const t={success:!0,sent:0,failed:0,errors:[]};try{if(e.ai_enhanced){const r=await this.analyzeBulkCampaign(e);console.log("AI Campaign Analysis:",r)}for(const r of e.recipients)try{let a=e.message;if(e.personalization_data&&e.personalization_data[r]){const o=e.personalization_data[r];a=this.personalizeMessage(e.message,o)}const n=await this.sendSMS(r,a,{ai_enhanced:e.ai_enhanced});n.success?t.sent++:(t.failed++,t.errors.push(`${r}: ${n.error}`)),await new Promise(o=>setTimeout(o,100))}catch(a){t.failed++;const n=a instanceof Error?a.message:"Unknown error";t.errors.push(`${r}: ${n}`)}return t}catch(r){console.error("Bulk SMS error:",r);const a=r instanceof Error?r.message:"Unknown error occurred";return{success:!1,sent:t.sent,failed:t.failed,errors:[...t.errors,a]}}}async enhanceMessageWithAI(e,t){try{let r=null;if(t){const{data:o}=await w.from("customers").select("*").eq("phone",t).single();r=o}const a=`Enhance this SMS message for a device repair and sales business:

Original Message: "${e}"
${r?`Customer Data: ${JSON.stringify(r,null,2)}`:""}

Requirements:
- Keep the core message intact
- Improve clarity and professionalism
- Add personalization if customer data is available
- Ensure it's under 160 characters
- Make it more engaging and actionable
- Use appropriate tone (friendly but professional)

Return only the enhanced message, no explanations.`,n=await jn.chat([{role:"user",content:a}]);if(n.success&&n.data)return{success:!0,enhanced_message:n.data.trim(),personalization_data:r}}catch(r){console.error("AI enhancement error:",r)}return{success:!1,enhanced_message:e}}async analyzeBulkCampaign(e){try{const t=`Analyze this bulk SMS campaign for a device repair and sales business:

Message: "${e.message}"
Recipients: ${e.recipients.length} customers
${e.personalization_data?"Personalization: Enabled":"Personalization: Disabled"}

Please analyze and provide:
1. Message quality score (0-1)
2. Suggested improvements
3. Personalization suggestions
4. Optimal send time recommendations
5. Customer segment insights

Respond in JSON format:
{
  "message_quality": 0.8,
  "suggested_improvements": ["Add call-to-action", "Include business name"],
  "personalization_suggestions": ["Use customer name", "Reference loyalty level"],
  "optimal_send_time": "10:00 AM - 2:00 PM",
  "customer_segment_insights": "This message targets..."
}`,r=await jn.chat([{role:"user",content:t}]);if(r.success&&r.data)try{return JSON.parse(r.data)}catch(a){console.error("Failed to parse AI analysis:",a)}}catch(t){console.error("AI campaign analysis error:",t)}return{message_quality:.5,suggested_improvements:[],personalization_suggestions:[]}}personalizeMessage(e,t){let r=e;return t.name&&(r=r.replace(/{name}/g,t.name)),t.loyaltyLevel&&(r=r.replace(/{loyaltyLevel}/g,t.loyaltyLevel)),t.totalSpent&&(r=r.replace(/{totalSpent}/g,t.totalSpent.toString())),t.points&&(r=r.replace(/{points}/g,t.points.toString())),r}async sendSMSToProvider(e,t){var r,a,n,o,i,c,l,d;if(await this.ensureInitialized(),!this.apiKey||!this.apiUrl)return{success:!1,error:"SMS provider not configured. Messages will be logged but not sent. Configure SMS Gateway in Admin Settings  Integrations."};try{if(e==="255700000000"||e.startsWith("255700"))return console.log(" Test SMS - simulating success for phone:",e),{success:!0};const u=!1,h=!0;let g;g="http://localhost:8000/api/sms-proxy";const p=g.includes("localhost")||g.includes("127.0.0.1"),{getIntegration:m}=await z(()=>Promise.resolve().then(()=>wa),void 0),_=await m("SMS_GATEWAY"),b=((r=_==null?void 0:_.credentials)==null?void 0:r.sender_id)||"LATS POS",S=((a=_==null?void 0:_.config)==null?void 0:a.api_url)||this.apiUrl||"https://mshastra.com/sendurl.aspx",v=((n=_==null?void 0:_.credentials)==null?void 0:n.api_key)||this.apiKey,C=((o=_==null?void 0:_.credentials)==null?void 0:o.api_password)||this.apiPassword,T=((i=_==null?void 0:_.config)==null?void 0:i.priority)||"High",x=((c=_==null?void 0:_.config)==null?void 0:c.country_code)||"ALL",R=((l=_==null?void 0:_.config)==null?void 0:l.timeout)||3e4,k=((d=_==null?void 0:_.config)==null?void 0:d.max_retries)||3;let P;try{const N=p&&u?2e3:5e3,$=new AbortController,M=setTimeout(()=>$.abort(),N);try{const L=fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:e,message:t,apiUrl:S,apiKey:v,apiPassword:C,senderId:b,priority:T,countryCode:x,timeout:R,maxRetries:k}),signal:$.signal}).catch(B=>{const U=B instanceof Error?B.message:String(B);if((B instanceof Error?B.name:"")==="TypeError"||U.includes("Failed to fetch")||U.includes("ERR_CONNECTION_REFUSED")||U.includes("ECONNREFUSED")||U.includes("NetworkError")||U.includes("network")||U.includes("fetch"))return Promise.reject(new Error("SMS_PROXY_CONNECTION_ERROR"));throw B});P=await Promise.race([L,new Promise((B,U)=>{setTimeout(()=>U(new Error("SMS proxy timeout")),N)})]),clearTimeout(M)}catch(L){if(clearTimeout(M),L.name==="AbortError"||$.signal.aborted||L.message==="SMS proxy timeout")return{success:!1,error:"SMS proxy server not running"};const B=L instanceof Error?L.message:String(L);if(B==="SMS_PROXY_CONNECTION_ERROR"||B.includes("Failed to fetch")||B.includes("ERR_CONNECTION_REFUSED")||B.includes("ECONNREFUSED")||B.includes("NetworkError"))return{success:!1,error:"SMS proxy server not running"};throw L}}catch(N){const $=N instanceof Error?N.message:String(N);if($==="SMS_PROXY_CONNECTION_ERROR"||$.includes("Failed to fetch")||$.includes("ERR_CONNECTION_REFUSED")||$.includes("ECONNREFUSED")||$.includes("NetworkError")||$.includes("network"))return{success:!1,error:"SMS proxy server not running"};throw N}const O=await P.json();return O.success?(console.log(" SMS sent successfully via proxy"),{success:!0}):(console.error(" SMS Provider Error via proxy:",O.error),{success:!1,error:O.error||"SMS sending failed"})}catch(u){const h=u instanceof Error?u.message:String(u),g=String(u),p=u instanceof Error?u.name:"";return h==="SMS_PROXY_CONNECTION_ERROR"||p==="AbortError"||p==="TypeError"||h.includes("Failed to fetch")||h.includes("ERR_CONNECTION_REFUSED")||h.includes("ECONNREFUSED")||h.includes("NetworkError")||h.includes("network")||h.includes("fetch")||g.includes("ERR_CONNECTION_REFUSED")||g.includes("ECONNREFUSED")||u instanceof TypeError?{success:!1,error:"SMS proxy server not running"}:{success:!1,error:`SMS error: ${h}`}}}async getSMSLogs(e){try{let t=w.from("sms_logs").select("*").order("created_at",{ascending:!1});e!=null&&e.search&&(t=t.or(`recipient_phone.ilike.%${e.search}%,message.ilike.%${e.search}%`));const{data:r,error:a}=await t;return a?(console.error("Error fetching SMS logs:",a),[]):r||[]}catch(t){return console.error("Error fetching SMS logs:",t),[]}}async getTemplates(){try{const{data:e}=await w.from("communication_templates").select("*").eq("template_type","sms").eq("is_active",!0).order("created_at",{ascending:!1});return e||[]}catch(e){return console.error("Error fetching templates:",e),[]}}async getSMSStats(){try{const{data:e}=await w.from("sms_logs").select("status, created_at");return e?{total:e.length,sent:e.filter(r=>r.status==="sent").length,failed:e.filter(r=>r.status==="failed").length,pending:e.filter(r=>r.status==="pending").length,delivered:e.filter(r=>r.status==="delivered").length,totalCost:e.length*15}:{total:0,sent:0,failed:0,pending:0,delivered:0,totalCost:0}}catch(e){return console.error("Error fetching SMS stats:",e),{total:0,sent:0,failed:0,pending:0,delivered:0,totalCost:0}}}async resendSMS(e){try{const{data:t}=await w.from("sms_logs").select("*").eq("id",e).single();if(!t)return{success:!1,error:"SMS log not found"};await this.checkServerAvailability();const r=await this.sendSMS(t.recipient_phone,t.message);return await w.from("sms_logs").update({status:r.success?"sent":"failed",error_message:r.error,sent_at:new Date().toISOString()}).eq("id",e),r}catch(t){return console.error("Resend SMS error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async scheduleSMS(e){try{const{data:t}=await w.from("scheduled_sms").insert({recipients:e.recipients,message:e.message,template_id:e.template_id,variables:e.variables,ai_enhanced:e.ai_enhanced,personalization_data:e.personalization_data,scheduled_for:e.scheduledFor.toISOString(),created_by:e.created_by,status:"pending"});return{success:!0}}catch(t){return console.error("Schedule SMS error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async logManualSMS(e){try{const{data:t,error:r}=await w.from("customers").select("phone").eq("id",e.customerId).single();if(r)return console.error("Error fetching customer for SMS logging:",r),!1;const{error:a}=await w.from("sms_logs").insert({recipient_phone:(t==null?void 0:t.phone)||"",message:e.message,status:"sent",sent_by:e.sentBy,device_id:e.deviceId,sent_at:new Date().toISOString(),created_at:new Date().toISOString()});return a?(console.error("Error logging manual SMS:",a),!1):!0}catch(t){return console.error("Error logging manual SMS:",t),!1}}async sendDeviceReceivedSMS(e,t,r,a,n,o,i){try{const c=` Tumepokea Kimepokelewa!

Hellow Mtaasisi ${t},

Habari njema! ${r} ${a} yako imepokelewa na sasa iko katika foleni ya ukarabati wa Inauzwa.

 Namba ya Kumbukumbu: #${n}
 Tarehe ya Kupokea: ${new Date().toLocaleDateString("sw-TZ")}
 Tatizo: ${o}

Subiri ujumbe kupitia SMS kikiwa tayari!

Asante kwa kumtumaini Inauzwa `,l=await this.sendSMS(e,c,{ai_enhanced:!1});if(l.success&&l.log_id)try{await w.from("sms_logs").update({device_id:n}).eq("id",l.log_id)}catch(d){console.warn("Failed to update SMS log with device data:",d)}return l}catch(c){return console.error("Error sending device received SMS:",c),{success:!1,error:c instanceof Error?c.message:"Unknown error occurred"}}}async sendDeviceReadySMS(e,t,r,a,n,o){try{const i=` Kifaa Chako Tayari!

Habari Mtaasisi ${t},

Habari njema! ${r} ${a} yako imekamilika na tayari kuchukuliwa.

 Namba ya Kumbukumbu: #${n}
 Tarehe ya Kukamilisha: ${new Date().toLocaleDateString("sw-TZ")}

Tafadhali uje kuchukua kifaa chako katika ofisi yetu ndani ya muda ili kuepuka usumbufu.

Asante kwa kumtumaini Inauzwa! `,c=await this.sendSMS(e,i,{ai_enhanced:!1});if(c.success&&c.log_id)try{await w.from("sms_logs").update({device_id:n}).eq("id",c.log_id)}catch(l){console.warn("Failed to update SMS log with device data:",l)}return c}catch(i){return console.error("Error sending device ready SMS:",i),{success:!1,error:i instanceof Error?i.message:"Unknown error occurred"}}}async sendTemplateSMS(e,t,r,a){try{const{data:n,error:o}=await w.from("sms_templates").select("*").eq("id",t).single();if(o||!n)return{success:!1,error:"Template not found"};let i=n.content;Object.entries(r).forEach(([l,d])=>{const u=`{${l}}`;i=i.replace(new RegExp(u,"g"),d)});const c=await this.sendSMS(e,i,{ai_enhanced:!1});if(c.success&&c.log_id)try{console.log("Template SMS sent successfully:",{template_id:t,template_name:n.name,variables:r,customer_id:a})}catch(l){console.warn("Failed to log template SMS data:",l)}return c}catch(n){return console.error("Error sending template SMS:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}}clearServerCache(){if(typeof window<"u"){const e="sms_proxy_server_unavailable";localStorage.removeItem(e),console.log(" SMS proxy server cache cleared")}}async checkServerAvailability(){try{const e="http://localhost:8000/health",t=new AbortController,r=setTimeout(()=>t.abort(),2e3);try{const a=await fetch(e,{method:"GET",signal:t.signal,mode:"cors",cache:"no-cache"});return clearTimeout(r),a.ok?(this.clearServerCache(),!0):!1}catch{return clearTimeout(r),!1}}catch{return!1}}}me(Qi,"hasWarnedAboutConfig",!1);const Pt=new Qi,nh=async s=>Pt.logManualSMS(s),D0=Object.freeze(Object.defineProperty({__proto__:null,logManualSMS:nh,smsService:Pt},Symbol.toStringTag,{value:"Module"})),oh={basePoints:100,brandBonuses:{apple:5,samsung:3,google:2,xiaomi:1,huawei:1},modelBonuses:{"iphone 15":3,"iphone 14":2,"galaxy s24":3,"galaxy s23":2,"pixel 8":2,"pixel 7":1},deviceTypeBonuses:{smartphone:0,tablet:2,laptop:5,desktop:3,smartwatch:1},enablePointsForNewDevices:!0,maxPointsPerDay:50,customerLoyaltyMultipliers:{interested:1,engaged:1.05,payment_customer:1.1,active:1.15,regular:1.2,premium:1.3,vip:1.5}};function ih(s,e,t=oh){if(!t.enablePointsForNewDevices)return 0;let r=t.basePoints;if(s.brand){const a=t.brandBonuses[s.brand.toLowerCase()];a&&(r+=a)}if(s.model){const a=s.model.toLowerCase();for(const[n,o]of Object.entries(t.modelBonuses))if(a.includes(n.toLowerCase())){r+=o;break}}if(s.deviceType){const a=t.deviceTypeBonuses[s.deviceType.toLowerCase()];a&&(r+=a)}if(e){const a=t.customerLoyaltyMultipliers[e.toLowerCase()]||1;r=Math.round(r*a)}return r}var Xa={exports:{}},Za={exports:{}};function Ki(s,e){return function(){return s.apply(e,arguments)}}const{toString:ch}=Object.prototype,{getPrototypeOf:en}=Object,{iterator:Is,toStringTag:Ji}=Symbol,Cs=(s=>e=>{const t=ch.call(e);return s[t]||(s[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),tt=s=>(s=s.toLowerCase(),e=>Cs(e)===s),Ds=s=>e=>typeof e===s,{isArray:cr}=Array,sr=Ds("undefined");function Lr(s){return s!==null&&!sr(s)&&s.constructor!==null&&!sr(s.constructor)&&ze(s.constructor.isBuffer)&&s.constructor.isBuffer(s)}const Yi=tt("ArrayBuffer");function lh(s){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(s):e=s&&s.buffer&&Yi(s.buffer),e}const uh=Ds("string"),ze=Ds("function"),Xi=Ds("number"),Ur=s=>s!==null&&typeof s=="object",dh=s=>s===!0||s===!1,ls=s=>{if(Cs(s)!=="object")return!1;const e=en(s);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Ji in s)&&!(Is in s)},hh=s=>{if(!Ur(s)||Lr(s))return!1;try{return Object.keys(s).length===0&&Object.getPrototypeOf(s)===Object.prototype}catch{return!1}},mh=tt("Date"),ph=tt("File"),fh=tt("Blob"),gh=tt("FileList"),_h=s=>Ur(s)&&ze(s.pipe),yh=s=>{let e;return s&&(typeof FormData=="function"&&s instanceof FormData||ze(s.append)&&((e=Cs(s))==="formdata"||e==="object"&&ze(s.toString)&&s.toString()==="[object FormData]"))},bh=tt("URLSearchParams"),[wh,vh,Sh,Eh]=["ReadableStream","Request","Response","Headers"].map(tt),xh=s=>s.trim?s.trim():s.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function jr(s,e,{allOwnKeys:t=!1}={}){if(s===null||typeof s>"u")return;let r,a;if(typeof s!="object"&&(s=[s]),cr(s))for(r=0,a=s.length;r<a;r++)e.call(null,s[r],r,s);else{if(Lr(s))return;const n=t?Object.getOwnPropertyNames(s):Object.keys(s),o=n.length;let i;for(r=0;r<o;r++)i=n[r],e.call(null,s[i],i,s)}}function Zi(s,e){if(Lr(s))return null;e=e.toLowerCase();const t=Object.keys(s);let r=t.length,a;for(;r-- >0;)if(a=t[r],e===a.toLowerCase())return a;return null}const It=(()=>typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Sl)(),ec=s=>!sr(s)&&s!==It;function va(){const{caseless:s,skipUndefined:e}=ec(this)&&this||{},t={},r=(a,n)=>{const o=s&&Zi(t,n)||n;ls(t[o])&&ls(a)?t[o]=va(t[o],a):ls(a)?t[o]=va({},a):cr(a)?t[o]=a.slice():(!e||!sr(a))&&(t[o]=a)};for(let a=0,n=arguments.length;a<n;a++)arguments[a]&&jr(arguments[a],r);return t}const Ph=(s,e,t,{allOwnKeys:r}={})=>(jr(e,(a,n)=>{t&&ze(a)?s[n]=Ki(a,t):s[n]=a},{allOwnKeys:r}),s),Ah=s=>(s.charCodeAt(0)===65279&&(s=s.slice(1)),s),kh=(s,e,t,r)=>{s.prototype=Object.create(e.prototype,r),s.prototype.constructor=s,Object.defineProperty(s,"super",{value:e.prototype}),t&&Object.assign(s.prototype,t)},Ih=(s,e,t,r)=>{let a,n,o;const i={};if(e=e||{},s==null)return e;do{for(a=Object.getOwnPropertyNames(s),n=a.length;n-- >0;)o=a[n],(!r||r(o,s,e))&&!i[o]&&(e[o]=s[o],i[o]=!0);s=t!==!1&&en(s)}while(s&&(!t||t(s,e))&&s!==Object.prototype);return e},Ch=(s,e,t)=>{s=String(s),(t===void 0||t>s.length)&&(t=s.length),t-=e.length;const r=s.indexOf(e,t);return r!==-1&&r===t},Dh=s=>{if(!s)return null;if(cr(s))return s;let e=s.length;if(!Xi(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=s[e];return t},Th=(s=>e=>s&&e instanceof s)(typeof Uint8Array<"u"&&en(Uint8Array)),Rh=(s,e)=>{const r=(s&&s[Is]).call(s);let a;for(;(a=r.next())&&!a.done;){const n=a.value;e.call(s,n[0],n[1])}},Oh=(s,e)=>{let t;const r=[];for(;(t=s.exec(e))!==null;)r.push(t);return r},Nh=tt("HTMLFormElement"),Lh=s=>s.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,r,a){return r.toUpperCase()+a}),$n=(({hasOwnProperty:s})=>(e,t)=>s.call(e,t))(Object.prototype),Uh=tt("RegExp"),tc=(s,e)=>{const t=Object.getOwnPropertyDescriptors(s),r={};jr(t,(a,n)=>{let o;(o=e(a,n,s))!==!1&&(r[n]=o||a)}),Object.defineProperties(s,r)},jh=s=>{tc(s,(e,t)=>{if(ze(s)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const r=s[t];if(ze(r)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},$h=(s,e)=>{const t={},r=a=>{a.forEach(n=>{t[n]=!0})};return cr(s)?r(s):r(String(s).split(e)),t},Mh=()=>{},qh=(s,e)=>s!=null&&Number.isFinite(s=+s)?s:e;function Bh(s){return!!(s&&ze(s.append)&&s[Ji]==="FormData"&&s[Is])}const Fh=s=>{const e=new Array(10),t=(r,a)=>{if(Ur(r)){if(e.indexOf(r)>=0)return;if(Lr(r))return r;if(!("toJSON"in r)){e[a]=r;const n=cr(r)?[]:{};return jr(r,(o,i)=>{const c=t(o,a+1);!sr(c)&&(n[i]=c)}),e[a]=void 0,n}}return r};return t(s,0)},zh=tt("AsyncFunction"),Vh=s=>s&&(Ur(s)||ze(s))&&ze(s.then)&&ze(s.catch),rc=((s,e)=>s?setImmediate:e?((t,r)=>(It.addEventListener("message",({source:a,data:n})=>{a===It&&n===t&&r.length&&r.shift()()},!1),a=>{r.push(a),It.postMessage(t,"*")}))(`axios@${Math.random()}`,[]):t=>setTimeout(t))(typeof setImmediate=="function",ze(It.postMessage)),Gh=typeof queueMicrotask<"u"?queueMicrotask.bind(It):typeof process<"u"&&process.nextTick||rc,Wh=s=>s!=null&&ze(s[Is]);var F={isArray:cr,isArrayBuffer:Yi,isBuffer:Lr,isFormData:yh,isArrayBufferView:lh,isString:uh,isNumber:Xi,isBoolean:dh,isObject:Ur,isPlainObject:ls,isEmptyObject:hh,isReadableStream:wh,isRequest:vh,isResponse:Sh,isHeaders:Eh,isUndefined:sr,isDate:mh,isFile:ph,isBlob:fh,isRegExp:Uh,isFunction:ze,isStream:_h,isURLSearchParams:bh,isTypedArray:Th,isFileList:gh,forEach:jr,merge:va,extend:Ph,trim:xh,stripBOM:Ah,inherits:kh,toFlatObject:Ih,kindOf:Cs,kindOfTest:tt,endsWith:Ch,toArray:Dh,forEachEntry:Rh,matchAll:Oh,isHTMLForm:Nh,hasOwnProperty:$n,hasOwnProp:$n,reduceDescriptors:tc,freezeMethods:jh,toObjectSet:$h,toCamelCase:Lh,noop:Mh,toFiniteNumber:qh,findKey:Zi,global:It,isContextDefined:ec,isSpecCompliantForm:Bh,toJSONObject:Fh,isAsyncFn:zh,isThenable:Vh,setImmediate:rc,asap:Gh,isIterable:Wh};function ne(s,e,t,r,a){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=s,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),r&&(this.request=r),a&&(this.response=a,this.status=a.status?a.status:null)}F.inherits(ne,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:F.toJSONObject(this.config),code:this.code,status:this.status}}});const sc=ne.prototype,ac={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(s=>{ac[s]={value:s}});Object.defineProperties(ne,ac);Object.defineProperty(sc,"isAxiosError",{value:!0});ne.from=(s,e,t,r,a,n)=>{const o=Object.create(sc);F.toFlatObject(s,o,function(d){return d!==Error.prototype},l=>l!=="isAxiosError");const i=s&&s.message?s.message:"Error",c=e==null&&s?s.code:e;return ne.call(o,i,c,t,r,a),s&&o.cause==null&&Object.defineProperty(o,"cause",{value:s,configurable:!0}),o.name=s&&s.name||"Error",n&&Object.assign(o,n),o};var Hh=null;function Sa(s){return F.isPlainObject(s)||F.isArray(s)}function nc(s){return F.endsWith(s,"[]")?s.slice(0,-2):s}function Mn(s,e,t){return s?s.concat(e).map(function(a,n){return a=nc(a),!t&&n?"["+a+"]":a}).join(t?".":""):e}function Qh(s){return F.isArray(s)&&!s.some(Sa)}const Kh=F.toFlatObject(F,{},null,function(e){return/^is[A-Z]/.test(e)});function Ts(s,e,t){if(!F.isObject(s))throw new TypeError("target must be an object");e=e||new FormData,t=F.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(m,_){return!F.isUndefined(_[m])});const r=t.metaTokens,a=t.visitor||d,n=t.dots,o=t.indexes,c=(t.Blob||typeof Blob<"u"&&Blob)&&F.isSpecCompliantForm(e);if(!F.isFunction(a))throw new TypeError("visitor must be a function");function l(p){if(p===null)return"";if(F.isDate(p))return p.toISOString();if(F.isBoolean(p))return p.toString();if(!c&&F.isBlob(p))throw new ne("Blob is not supported. Use a Buffer instead.");return F.isArrayBuffer(p)||F.isTypedArray(p)?c&&typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}function d(p,m,_){let b=p;if(p&&!_&&typeof p=="object"){if(F.endsWith(m,"{}"))m=r?m:m.slice(0,-2),p=JSON.stringify(p);else if(F.isArray(p)&&Qh(p)||(F.isFileList(p)||F.endsWith(m,"[]"))&&(b=F.toArray(p)))return m=nc(m),b.forEach(function(v,C){!(F.isUndefined(v)||v===null)&&e.append(o===!0?Mn([m],C,n):o===null?m:m+"[]",l(v))}),!1}return Sa(p)?!0:(e.append(Mn(_,m,n),l(p)),!1)}const u=[],h=Object.assign(Kh,{defaultVisitor:d,convertValue:l,isVisitable:Sa});function g(p,m){if(!F.isUndefined(p)){if(u.indexOf(p)!==-1)throw Error("Circular reference detected in "+m.join("."));u.push(p),F.forEach(p,function(b,S){(!(F.isUndefined(b)||b===null)&&a.call(e,b,F.isString(S)?S.trim():S,m,h))===!0&&g(b,m?m.concat(S):[S])}),u.pop()}}if(!F.isObject(s))throw new TypeError("data must be an object");return g(s),e}function qn(s){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(s).replace(/[!'()~]|%20|%00/g,function(r){return e[r]})}function tn(s,e){this._pairs=[],s&&Ts(s,this,e)}const oc=tn.prototype;oc.append=function(e,t){this._pairs.push([e,t])};oc.toString=function(e){const t=e?function(r){return e.call(this,r,qn)}:qn;return this._pairs.map(function(a){return t(a[0])+"="+t(a[1])},"").join("&")};function Jh(s){return encodeURIComponent(s).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function ic(s,e,t){if(!e)return s;const r=t&&t.encode||Jh;F.isFunction(t)&&(t={serialize:t});const a=t&&t.serialize;let n;if(a?n=a(e,t):n=F.isURLSearchParams(e)?e.toString():new tn(e,t).toString(r),n){const o=s.indexOf("#");o!==-1&&(s=s.slice(0,o)),s+=(s.indexOf("?")===-1?"?":"&")+n}return s}class Yh{constructor(){this.handlers=[]}use(e,t,r){return this.handlers.push({fulfilled:e,rejected:t,synchronous:r?r.synchronous:!1,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){F.forEach(this.handlers,function(r){r!==null&&e(r)})}}var Bn=Yh,cc={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Xh=typeof URLSearchParams<"u"?URLSearchParams:tn,Zh=typeof FormData<"u"?FormData:null,em=typeof Blob<"u"?Blob:null,tm={isBrowser:!0,classes:{URLSearchParams:Xh,FormData:Zh,Blob:em},protocols:["http","https","file","blob","url","data"]};const rn=typeof window<"u"&&typeof document<"u",Ea=typeof navigator=="object"&&navigator||void 0,rm=rn&&(!Ea||["ReactNative","NativeScript","NS"].indexOf(Ea.product)<0),sm=(()=>typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function")(),am=rn&&window.location.href||"http://localhost";var nm=Object.freeze({__proto__:null,hasBrowserEnv:rn,hasStandardBrowserWebWorkerEnv:sm,hasStandardBrowserEnv:rm,navigator:Ea,origin:am}),je={...nm,...tm};function om(s,e){return Ts(s,new je.classes.URLSearchParams,{visitor:function(t,r,a,n){return je.isNode&&F.isBuffer(t)?(this.append(r,t.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)},...e})}function im(s){return F.matchAll(/\w+|\[(\w*)]/g,s).map(e=>e[0]==="[]"?"":e[1]||e[0])}function cm(s){const e={},t=Object.keys(s);let r;const a=t.length;let n;for(r=0;r<a;r++)n=t[r],e[n]=s[n];return e}function lc(s){function e(t,r,a,n){let o=t[n++];if(o==="__proto__")return!0;const i=Number.isFinite(+o),c=n>=t.length;return o=!o&&F.isArray(a)?a.length:o,c?(F.hasOwnProp(a,o)?a[o]=[a[o],r]:a[o]=r,!i):((!a[o]||!F.isObject(a[o]))&&(a[o]=[]),e(t,r,a[o],n)&&F.isArray(a[o])&&(a[o]=cm(a[o])),!i)}if(F.isFormData(s)&&F.isFunction(s.entries)){const t={};return F.forEachEntry(s,(r,a)=>{e(im(r),a,t,0)}),t}return null}function lm(s,e,t){if(F.isString(s))try{return(e||JSON.parse)(s),F.trim(s)}catch(r){if(r.name!=="SyntaxError")throw r}return(t||JSON.stringify)(s)}const sn={transitional:cc,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const r=t.getContentType()||"",a=r.indexOf("application/json")>-1,n=F.isObject(e);if(n&&F.isHTMLForm(e)&&(e=new FormData(e)),F.isFormData(e))return a?JSON.stringify(lc(e)):e;if(F.isArrayBuffer(e)||F.isBuffer(e)||F.isStream(e)||F.isFile(e)||F.isBlob(e)||F.isReadableStream(e))return e;if(F.isArrayBufferView(e))return e.buffer;if(F.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let i;if(n){if(r.indexOf("application/x-www-form-urlencoded")>-1)return om(e,this.formSerializer).toString();if((i=F.isFileList(e))||r.indexOf("multipart/form-data")>-1){const c=this.env&&this.env.FormData;return Ts(i?{"files[]":e}:e,c&&new c,this.formSerializer)}}return n||a?(t.setContentType("application/json",!1),lm(e)):e}],transformResponse:[function(e){const t=this.transitional||sn.transitional,r=t&&t.forcedJSONParsing,a=this.responseType==="json";if(F.isResponse(e)||F.isReadableStream(e))return e;if(e&&F.isString(e)&&(r&&!this.responseType||a)){const o=!(t&&t.silentJSONParsing)&&a;try{return JSON.parse(e,this.parseReviver)}catch(i){if(o)throw i.name==="SyntaxError"?ne.from(i,ne.ERR_BAD_RESPONSE,this,null,this.response):i}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:je.classes.FormData,Blob:je.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};F.forEach(["delete","get","head","post","put","patch"],s=>{sn.headers[s]={}});var an=sn;const um=F.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);var dm=s=>{const e={};let t,r,a;return s&&s.split(`
`).forEach(function(o){a=o.indexOf(":"),t=o.substring(0,a).trim().toLowerCase(),r=o.substring(a+1).trim(),!(!t||e[t]&&um[t])&&(t==="set-cookie"?e[t]?e[t].push(r):e[t]=[r]:e[t]=e[t]?e[t]+", "+r:r)}),e};const Fn=Symbol("internals");function yr(s){return s&&String(s).trim().toLowerCase()}function us(s){return s===!1||s==null?s:F.isArray(s)?s.map(us):String(s)}function hm(s){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=t.exec(s);)e[r[1]]=r[2];return e}const mm=s=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(s.trim());function Gs(s,e,t,r,a){if(F.isFunction(r))return r.call(this,e,t);if(a&&(e=t),!!F.isString(e)){if(F.isString(r))return e.indexOf(r)!==-1;if(F.isRegExp(r))return r.test(e)}}function pm(s){return s.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,r)=>t.toUpperCase()+r)}function fm(s,e){const t=F.toCamelCase(" "+e);["get","set","has"].forEach(r=>{Object.defineProperty(s,r+t,{value:function(a,n,o){return this[r].call(this,e,a,n,o)},configurable:!0})})}class Rs{constructor(e){e&&this.set(e)}set(e,t,r){const a=this;function n(i,c,l){const d=yr(c);if(!d)throw new Error("header name must be a non-empty string");const u=F.findKey(a,d);(!u||a[u]===void 0||l===!0||l===void 0&&a[u]!==!1)&&(a[u||c]=us(i))}const o=(i,c)=>F.forEach(i,(l,d)=>n(l,d,c));if(F.isPlainObject(e)||e instanceof this.constructor)o(e,t);else if(F.isString(e)&&(e=e.trim())&&!mm(e))o(dm(e),t);else if(F.isObject(e)&&F.isIterable(e)){let i={},c,l;for(const d of e){if(!F.isArray(d))throw TypeError("Object iterator must return a key-value pair");i[l=d[0]]=(c=i[l])?F.isArray(c)?[...c,d[1]]:[c,d[1]]:d[1]}o(i,t)}else e!=null&&n(t,e,r);return this}get(e,t){if(e=yr(e),e){const r=F.findKey(this,e);if(r){const a=this[r];if(!t)return a;if(t===!0)return hm(a);if(F.isFunction(t))return t.call(this,a,r);if(F.isRegExp(t))return t.exec(a);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=yr(e),e){const r=F.findKey(this,e);return!!(r&&this[r]!==void 0&&(!t||Gs(this,this[r],r,t)))}return!1}delete(e,t){const r=this;let a=!1;function n(o){if(o=yr(o),o){const i=F.findKey(r,o);i&&(!t||Gs(r,r[i],i,t))&&(delete r[i],a=!0)}}return F.isArray(e)?e.forEach(n):n(e),a}clear(e){const t=Object.keys(this);let r=t.length,a=!1;for(;r--;){const n=t[r];(!e||Gs(this,this[n],n,e,!0))&&(delete this[n],a=!0)}return a}normalize(e){const t=this,r={};return F.forEach(this,(a,n)=>{const o=F.findKey(r,n);if(o){t[o]=us(a),delete t[n];return}const i=e?pm(n):String(n).trim();i!==n&&delete t[n],t[i]=us(a),r[i]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return F.forEach(this,(r,a)=>{r!=null&&r!==!1&&(t[a]=e&&F.isArray(r)?r.join(", "):r)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const r=new this(e);return t.forEach(a=>r.set(a)),r}static accessor(e){const r=(this[Fn]=this[Fn]={accessors:{}}).accessors,a=this.prototype;function n(o){const i=yr(o);r[i]||(fm(a,o),r[i]=!0)}return F.isArray(e)?e.forEach(n):n(e),this}}Rs.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);F.reduceDescriptors(Rs.prototype,({value:s},e)=>{let t=e[0].toUpperCase()+e.slice(1);return{get:()=>s,set(r){this[t]=r}}});F.freezeMethods(Rs);var Ze=Rs;function Ws(s,e){const t=this||an,r=e||t,a=Ze.from(r.headers);let n=r.data;return F.forEach(s,function(i){n=i.call(t,n,a.normalize(),e?e.status:void 0)}),a.normalize(),n}function uc(s){return!!(s&&s.__CANCEL__)}function lr(s,e,t){ne.call(this,s??"canceled",ne.ERR_CANCELED,e,t),this.name="CanceledError"}F.inherits(lr,ne,{__CANCEL__:!0});function dc(s,e,t){const r=t.config.validateStatus;!t.status||!r||r(t.status)?s(t):e(new ne("Request failed with status code "+t.status,[ne.ERR_BAD_REQUEST,ne.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}function gm(s){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(s);return e&&e[1]||""}function _m(s,e){s=s||10;const t=new Array(s),r=new Array(s);let a=0,n=0,o;return e=e!==void 0?e:1e3,function(c){const l=Date.now(),d=r[n];o||(o=l),t[a]=c,r[a]=l;let u=n,h=0;for(;u!==a;)h+=t[u++],u=u%s;if(a=(a+1)%s,a===n&&(n=(n+1)%s),l-o<e)return;const g=d&&l-d;return g?Math.round(h*1e3/g):void 0}}function ym(s,e){let t=0,r=1e3/e,a,n;const o=(l,d=Date.now())=>{t=d,a=null,n&&(clearTimeout(n),n=null),s(...l)};return[(...l)=>{const d=Date.now(),u=d-t;u>=r?o(l,d):(a=l,n||(n=setTimeout(()=>{n=null,o(a)},r-u)))},()=>a&&o(a)]}const fs=(s,e,t=3)=>{let r=0;const a=_m(50,250);return ym(n=>{const o=n.loaded,i=n.lengthComputable?n.total:void 0,c=o-r,l=a(c),d=o<=i;r=o;const u={loaded:o,total:i,progress:i?o/i:void 0,bytes:c,rate:l||void 0,estimated:l&&i&&d?(i-o)/l:void 0,event:n,lengthComputable:i!=null,[e?"download":"upload"]:!0};s(u)},t)},zn=(s,e)=>{const t=s!=null;return[r=>e[0]({lengthComputable:t,total:s,loaded:r}),e[1]]},Vn=s=>(...e)=>F.asap(()=>s(...e));var bm=je.hasStandardBrowserEnv?((s,e)=>t=>(t=new URL(t,je.origin),s.protocol===t.protocol&&s.host===t.host&&(e||s.port===t.port)))(new URL(je.origin),je.navigator&&/(msie|trident)/i.test(je.navigator.userAgent)):()=>!0,wm=je.hasStandardBrowserEnv?{write(s,e,t,r,a,n,o){if(typeof document>"u")return;const i=[`${s}=${encodeURIComponent(e)}`];F.isNumber(t)&&i.push(`expires=${new Date(t).toUTCString()}`),F.isString(r)&&i.push(`path=${r}`),F.isString(a)&&i.push(`domain=${a}`),n===!0&&i.push("secure"),F.isString(o)&&i.push(`SameSite=${o}`),document.cookie=i.join("; ")},read(s){if(typeof document>"u")return null;const e=document.cookie.match(new RegExp("(?:^|; )"+s+"=([^;]*)"));return e?decodeURIComponent(e[1]):null},remove(s){this.write(s,"",Date.now()-864e5,"/")}}:{write(){},read(){return null},remove(){}};function vm(s){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(s)}function Sm(s,e){return e?s.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):s}function hc(s,e,t){let r=!vm(e);return s&&(r||t==!1)?Sm(s,e):e}const Gn=s=>s instanceof Ze?{...s}:s;function Rt(s,e){e=e||{};const t={};function r(l,d,u,h){return F.isPlainObject(l)&&F.isPlainObject(d)?F.merge.call({caseless:h},l,d):F.isPlainObject(d)?F.merge({},d):F.isArray(d)?d.slice():d}function a(l,d,u,h){if(F.isUndefined(d)){if(!F.isUndefined(l))return r(void 0,l,u,h)}else return r(l,d,u,h)}function n(l,d){if(!F.isUndefined(d))return r(void 0,d)}function o(l,d){if(F.isUndefined(d)){if(!F.isUndefined(l))return r(void 0,l)}else return r(void 0,d)}function i(l,d,u){if(u in e)return r(l,d);if(u in s)return r(void 0,l)}const c={url:n,method:n,data:n,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:i,headers:(l,d,u)=>a(Gn(l),Gn(d),u,!0)};return F.forEach(Object.keys({...s,...e}),function(d){const u=c[d]||a,h=u(s[d],e[d],d);F.isUndefined(h)&&u!==i||(t[d]=h)}),t}var mc=s=>{const e=Rt({},s);let{data:t,withXSRFToken:r,xsrfHeaderName:a,xsrfCookieName:n,headers:o,auth:i}=e;if(e.headers=o=Ze.from(o),e.url=ic(hc(e.baseURL,e.url,e.allowAbsoluteUrls),s.params,s.paramsSerializer),i&&o.set("Authorization","Basic "+btoa((i.username||"")+":"+(i.password?unescape(encodeURIComponent(i.password)):""))),F.isFormData(t)){if(je.hasStandardBrowserEnv||je.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(F.isFunction(t.getHeaders)){const c=t.getHeaders(),l=["content-type","content-length"];Object.entries(c).forEach(([d,u])=>{l.includes(d.toLowerCase())&&o.set(d,u)})}}if(je.hasStandardBrowserEnv&&(r&&F.isFunction(r)&&(r=r(e)),r||r!==!1&&bm(e.url))){const c=a&&n&&wm.read(n);c&&o.set(a,c)}return e};const Em=typeof XMLHttpRequest<"u";var xm=Em&&function(s){return new Promise(function(t,r){const a=mc(s);let n=a.data;const o=Ze.from(a.headers).normalize();let{responseType:i,onUploadProgress:c,onDownloadProgress:l}=a,d,u,h,g,p;function m(){g&&g(),p&&p(),a.cancelToken&&a.cancelToken.unsubscribe(d),a.signal&&a.signal.removeEventListener("abort",d)}let _=new XMLHttpRequest;_.open(a.method.toUpperCase(),a.url,!0),_.timeout=a.timeout;function b(){if(!_)return;const v=Ze.from("getAllResponseHeaders"in _&&_.getAllResponseHeaders()),T={data:!i||i==="text"||i==="json"?_.responseText:_.response,status:_.status,statusText:_.statusText,headers:v,config:s,request:_};dc(function(R){t(R),m()},function(R){r(R),m()},T),_=null}"onloadend"in _?_.onloadend=b:_.onreadystatechange=function(){!_||_.readyState!==4||_.status===0&&!(_.responseURL&&_.responseURL.indexOf("file:")===0)||setTimeout(b)},_.onabort=function(){_&&(r(new ne("Request aborted",ne.ECONNABORTED,s,_)),_=null)},_.onerror=function(C){const T=C&&C.message?C.message:"Network Error",x=new ne(T,ne.ERR_NETWORK,s,_);x.event=C||null,r(x),_=null},_.ontimeout=function(){let C=a.timeout?"timeout of "+a.timeout+"ms exceeded":"timeout exceeded";const T=a.transitional||cc;a.timeoutErrorMessage&&(C=a.timeoutErrorMessage),r(new ne(C,T.clarifyTimeoutError?ne.ETIMEDOUT:ne.ECONNABORTED,s,_)),_=null},n===void 0&&o.setContentType(null),"setRequestHeader"in _&&F.forEach(o.toJSON(),function(C,T){_.setRequestHeader(T,C)}),F.isUndefined(a.withCredentials)||(_.withCredentials=!!a.withCredentials),i&&i!=="json"&&(_.responseType=a.responseType),l&&([h,p]=fs(l,!0),_.addEventListener("progress",h)),c&&_.upload&&([u,g]=fs(c),_.upload.addEventListener("progress",u),_.upload.addEventListener("loadend",g)),(a.cancelToken||a.signal)&&(d=v=>{_&&(r(!v||v.type?new lr(null,s,_):v),_.abort(),_=null)},a.cancelToken&&a.cancelToken.subscribe(d),a.signal&&(a.signal.aborted?d():a.signal.addEventListener("abort",d)));const S=gm(a.url);if(S&&je.protocols.indexOf(S)===-1){r(new ne("Unsupported protocol "+S+":",ne.ERR_BAD_REQUEST,s));return}_.send(n||null)})};const Pm=(s,e)=>{const{length:t}=s=s?s.filter(Boolean):[];if(e||t){let r=new AbortController,a;const n=function(l){if(!a){a=!0,i();const d=l instanceof Error?l:this.reason;r.abort(d instanceof ne?d:new lr(d instanceof Error?d.message:d))}};let o=e&&setTimeout(()=>{o=null,n(new ne(`timeout ${e} of ms exceeded`,ne.ETIMEDOUT))},e);const i=()=>{s&&(o&&clearTimeout(o),o=null,s.forEach(l=>{l.unsubscribe?l.unsubscribe(n):l.removeEventListener("abort",n)}),s=null)};s.forEach(l=>l.addEventListener("abort",n));const{signal:c}=r;return c.unsubscribe=()=>F.asap(i),c}};var Am=Pm;const km=function*(s,e){let t=s.byteLength;if(!e||t<e){yield s;return}let r=0,a;for(;r<t;)a=r+e,yield s.slice(r,a),r=a},Im=async function*(s,e){for await(const t of Cm(s))yield*km(t,e)},Cm=async function*(s){if(s[Symbol.asyncIterator]){yield*s;return}const e=s.getReader();try{for(;;){const{done:t,value:r}=await e.read();if(t)break;yield r}}finally{await e.cancel()}},Wn=(s,e,t,r)=>{const a=Im(s,e);let n=0,o,i=c=>{o||(o=!0,r&&r(c))};return new ReadableStream({async pull(c){try{const{done:l,value:d}=await a.next();if(l){i(),c.close();return}let u=d.byteLength;if(t){let h=n+=u;t(h)}c.enqueue(new Uint8Array(d))}catch(l){throw i(l),l}},cancel(c){return i(c),a.return()}},{highWaterMark:2})},Hn=64*1024,{isFunction:Jr}=F,Dm=(({Request:s,Response:e})=>({Request:s,Response:e}))(F.global),{ReadableStream:Qn,TextEncoder:Kn}=F.global,Jn=(s,...e)=>{try{return!!s(...e)}catch{return!1}},Tm=s=>{s=F.merge.call({skipUndefined:!0},Dm,s);const{fetch:e,Request:t,Response:r}=s,a=e?Jr(e):typeof fetch=="function",n=Jr(t),o=Jr(r);if(!a)return!1;const i=a&&Jr(Qn),c=a&&(typeof Kn=="function"?(p=>m=>p.encode(m))(new Kn):async p=>new Uint8Array(await new t(p).arrayBuffer())),l=n&&i&&Jn(()=>{let p=!1;const m=new t(je.origin,{body:new Qn,method:"POST",get duplex(){return p=!0,"half"}}).headers.has("Content-Type");return p&&!m}),d=o&&i&&Jn(()=>F.isReadableStream(new r("").body)),u={stream:d&&(p=>p.body)};a&&["text","arrayBuffer","blob","formData","stream"].forEach(p=>{!u[p]&&(u[p]=(m,_)=>{let b=m&&m[p];if(b)return b.call(m);throw new ne(`Response type '${p}' is not supported`,ne.ERR_NOT_SUPPORT,_)})});const h=async p=>{if(p==null)return 0;if(F.isBlob(p))return p.size;if(F.isSpecCompliantForm(p))return(await new t(je.origin,{method:"POST",body:p}).arrayBuffer()).byteLength;if(F.isArrayBufferView(p)||F.isArrayBuffer(p))return p.byteLength;if(F.isURLSearchParams(p)&&(p=p+""),F.isString(p))return(await c(p)).byteLength},g=async(p,m)=>{const _=F.toFiniteNumber(p.getContentLength());return _??h(m)};return async p=>{let{url:m,method:_,data:b,signal:S,cancelToken:v,timeout:C,onDownloadProgress:T,onUploadProgress:x,responseType:R,headers:k,withCredentials:P="same-origin",fetchOptions:O}=mc(p),N=e||fetch;R=R?(R+"").toLowerCase():"text";let $=Am([S,v&&v.toAbortSignal()],C),M=null;const L=$&&$.unsubscribe&&(()=>{$.unsubscribe()});let B;try{if(x&&l&&_!=="get"&&_!=="head"&&(B=await g(k,b))!==0){let X=new t(m,{method:"POST",body:b,duplex:"half"}),re;if(F.isFormData(b)&&(re=X.headers.get("content-type"))&&k.setContentType(re),X.body){const[_e,le]=zn(B,fs(Vn(x)));b=Wn(X.body,Hn,_e,le)}}F.isString(P)||(P=P?"include":"omit");const U=n&&"credentials"in t.prototype,W={...O,signal:$,method:_.toUpperCase(),headers:k.normalize().toJSON(),body:b,duplex:"half",credentials:U?P:void 0};M=n&&new t(m,W);let H=await(n?N(M,O):N(m,W));const Q=d&&(R==="stream"||R==="response");if(d&&(T||Q&&L)){const X={};["status","statusText","headers"].forEach(ve=>{X[ve]=H[ve]});const re=F.toFiniteNumber(H.headers.get("content-length")),[_e,le]=T&&zn(re,fs(Vn(T),!0))||[];H=new r(Wn(H.body,Hn,_e,()=>{le&&le(),L&&L()}),X)}R=R||"text";let ce=await u[F.findKey(u,R)||"text"](H,p);return!Q&&L&&L(),await new Promise((X,re)=>{dc(X,re,{data:ce,headers:Ze.from(H.headers),status:H.status,statusText:H.statusText,config:p,request:M})})}catch(U){throw L&&L(),U&&U.name==="TypeError"&&/Load failed|fetch/i.test(U.message)?Object.assign(new ne("Network Error",ne.ERR_NETWORK,p,M),{cause:U.cause||U}):ne.from(U,U&&U.code,p,M)}}},Rm=new Map,pc=s=>{let e=s&&s.env||{};const{fetch:t,Request:r,Response:a}=e,n=[r,a,t];let o=n.length,i=o,c,l,d=Rm;for(;i--;)c=n[i],l=d.get(c),l===void 0&&d.set(c,l=i?new Map:Tm(e)),d=l;return l};pc();const nn={http:Hh,xhr:xm,fetch:{get:pc}};F.forEach(nn,(s,e)=>{if(s){try{Object.defineProperty(s,"name",{value:e})}catch{}Object.defineProperty(s,"adapterName",{value:e})}});const Yn=s=>`- ${s}`,Om=s=>F.isFunction(s)||s===null||s===!1;function Nm(s,e){s=F.isArray(s)?s:[s];const{length:t}=s;let r,a;const n={};for(let o=0;o<t;o++){r=s[o];let i;if(a=r,!Om(r)&&(a=nn[(i=String(r)).toLowerCase()],a===void 0))throw new ne(`Unknown adapter '${i}'`);if(a&&(F.isFunction(a)||(a=a.get(e))))break;n[i||"#"+o]=a}if(!a){const o=Object.entries(n).map(([c,l])=>`adapter ${c} `+(l===!1?"is not supported by the environment":"is not available in the build"));let i=t?o.length>1?`since :
`+o.map(Yn).join(`
`):" "+Yn(o[0]):"as no adapter specified";throw new ne("There is no suitable adapter to dispatch the request "+i,"ERR_NOT_SUPPORT")}return a}var fc={getAdapter:Nm,adapters:nn};function Hs(s){if(s.cancelToken&&s.cancelToken.throwIfRequested(),s.signal&&s.signal.aborted)throw new lr(null,s)}function Xn(s){return Hs(s),s.headers=Ze.from(s.headers),s.data=Ws.call(s,s.transformRequest),["post","put","patch"].indexOf(s.method)!==-1&&s.headers.setContentType("application/x-www-form-urlencoded",!1),fc.getAdapter(s.adapter||an.adapter,s)(s).then(function(r){return Hs(s),r.data=Ws.call(s,s.transformResponse,r),r.headers=Ze.from(r.headers),r},function(r){return uc(r)||(Hs(s),r&&r.response&&(r.response.data=Ws.call(s,s.transformResponse,r.response),r.response.headers=Ze.from(r.response.headers))),Promise.reject(r)})}const gc="1.13.2",Os={};["object","boolean","number","function","string","symbol"].forEach((s,e)=>{Os[s]=function(r){return typeof r===s||"a"+(e<1?"n ":" ")+s}});const Zn={};Os.transitional=function(e,t,r){function a(n,o){return"[Axios v"+gc+"] Transitional option '"+n+"'"+o+(r?". "+r:"")}return(n,o,i)=>{if(e===!1)throw new ne(a(o," has been removed"+(t?" in "+t:"")),ne.ERR_DEPRECATED);return t&&!Zn[o]&&(Zn[o]=!0,console.warn(a(o," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(n,o,i):!0}};Os.spelling=function(e){return(t,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};function Lm(s,e,t){if(typeof s!="object")throw new ne("options must be an object",ne.ERR_BAD_OPTION_VALUE);const r=Object.keys(s);let a=r.length;for(;a-- >0;){const n=r[a],o=e[n];if(o){const i=s[n],c=i===void 0||o(i,n,s);if(c!==!0)throw new ne("option "+n+" must be "+c,ne.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new ne("Unknown option "+n,ne.ERR_BAD_OPTION)}}var ds={assertOptions:Lm,validators:Os};const at=ds.validators;class gs{constructor(e){this.defaults=e||{},this.interceptors={request:new Bn,response:new Bn}}async request(e,t){try{return await this._request(e,t)}catch(r){if(r instanceof Error){let a={};Error.captureStackTrace?Error.captureStackTrace(a):a=new Error;const n=a.stack?a.stack.replace(/^.+\n/,""):"";try{r.stack?n&&!String(r.stack).endsWith(n.replace(/^.+\n.+\n/,""))&&(r.stack+=`
`+n):r.stack=n}catch{}}throw r}}_request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=Rt(this.defaults,t);const{transitional:r,paramsSerializer:a,headers:n}=t;r!==void 0&&ds.assertOptions(r,{silentJSONParsing:at.transitional(at.boolean),forcedJSONParsing:at.transitional(at.boolean),clarifyTimeoutError:at.transitional(at.boolean)},!1),a!=null&&(F.isFunction(a)?t.paramsSerializer={serialize:a}:ds.assertOptions(a,{encode:at.function,serialize:at.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),ds.assertOptions(t,{baseUrl:at.spelling("baseURL"),withXsrfToken:at.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=n&&F.merge(n.common,n[t.method]);n&&F.forEach(["delete","get","head","post","put","patch","common"],p=>{delete n[p]}),t.headers=Ze.concat(o,n);const i=[];let c=!0;this.interceptors.request.forEach(function(m){typeof m.runWhen=="function"&&m.runWhen(t)===!1||(c=c&&m.synchronous,i.unshift(m.fulfilled,m.rejected))});const l=[];this.interceptors.response.forEach(function(m){l.push(m.fulfilled,m.rejected)});let d,u=0,h;if(!c){const p=[Xn.bind(this),void 0];for(p.unshift(...i),p.push(...l),h=p.length,d=Promise.resolve(t);u<h;)d=d.then(p[u++],p[u++]);return d}h=i.length;let g=t;for(;u<h;){const p=i[u++],m=i[u++];try{g=p(g)}catch(_){m.call(this,_);break}}try{d=Xn.call(this,g)}catch(p){return Promise.reject(p)}for(u=0,h=l.length;u<h;)d=d.then(l[u++],l[u++]);return d}getUri(e){e=Rt(this.defaults,e);const t=hc(e.baseURL,e.url,e.allowAbsoluteUrls);return ic(t,e.params,e.paramsSerializer)}}F.forEach(["delete","get","head","options"],function(e){gs.prototype[e]=function(t,r){return this.request(Rt(r||{},{method:e,url:t,data:(r||{}).data}))}});F.forEach(["post","put","patch"],function(e){function t(r){return function(n,o,i){return this.request(Rt(i||{},{method:e,headers:r?{"Content-Type":"multipart/form-data"}:{},url:n,data:o}))}}gs.prototype[e]=t(),gs.prototype[e+"Form"]=t(!0)});var hs=gs;class on{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(n){t=n});const r=this;this.promise.then(a=>{if(!r._listeners)return;let n=r._listeners.length;for(;n-- >0;)r._listeners[n](a);r._listeners=null}),this.promise.then=a=>{let n;const o=new Promise(i=>{r.subscribe(i),n=i}).then(a);return o.cancel=function(){r.unsubscribe(n)},o},e(function(n,o,i){r.reason||(r.reason=new lr(n,o,i),t(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=r=>{e.abort(r)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new on(function(a){e=a}),cancel:e}}}var Um=on;function jm(s){return function(t){return s.apply(null,t)}}function $m(s){return F.isObject(s)&&s.isAxiosError===!0}const xa={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(xa).forEach(([s,e])=>{xa[e]=s});var Mm=xa;function _c(s){const e=new hs(s),t=Ki(hs.prototype.request,e);return F.extend(t,hs.prototype,e,{allOwnKeys:!0}),F.extend(t,e,null,{allOwnKeys:!0}),t.create=function(a){return _c(Rt(s,a))},t}const Ce=_c(an);Ce.Axios=hs;Ce.CanceledError=lr;Ce.CancelToken=Um;Ce.isCancel=uc;Ce.VERSION=gc;Ce.toFormData=Ts;Ce.AxiosError=ne;Ce.Cancel=Ce.CanceledError;Ce.all=function(e){return Promise.all(e)};Ce.spread=jm;Ce.isAxiosError=$m;Ce.mergeConfig=Rt;Ce.AxiosHeaders=Ze;Ce.formToJSON=s=>lc(F.isHTMLForm(s)?new FormData(s):s);Ce.getAdapter=fc.getAdapter;Ce.HttpStatusCode=Mm;Ce.default=Ce;var qm=Ce;const Bm="@sendgrid/client",Fm="Twilio SendGrid NodeJS API client",zm="8.1.6",Vm="Twilio SendGrid <help@twilio.com> (sendgrid.com)",Gm=["Kyle Partridge <kyle.partridge@sendgrid.com>","David Tomberlin <david.tomberlin@sendgrid.com>","Swift <swift@sendgrid.com>","Brandon West <brandon.west@sendgrid.com>","Scott Motte <scott.motte@sendgrid.com>","Robert Acosta <robert.acosta@sendgrid.com>","Elmer Thomas <ethomas@twilio.com>","Adam Reis <adam@reis.nz>"],Wm="MIT",Hm="https://sendgrid.com",Qm={type:"git",url:"git://github.com/sendgrid/sendgrid-nodejs.git"},Km={access:"public"},Jm="index.js",Ym={node:">=12.*"},Xm={"@sendgrid/helpers":"^8.0.0",axios:"^1.12.0"},Zm={chai:"4.2.0",nock:"^10.0.6"},ep={chai:"4.2.0"},tp=["http","rest","api","mail","sendgrid"],rp="498e2329e87d804d83f4a7b519d33fa09198d0ca",sp={name:Bm,description:Fm,version:zm,author:Vm,contributors:Gm,license:Wm,homepage:Hm,repository:Qm,publishConfig:Km,main:Jm,engines:Ym,dependencies:Xm,devDependencies:Zm,resolutions:ep,tags:tp,gitHead:rp};var cn=function s(e,t,r){if(typeof e!="object"||e===null)throw new Error("Non object passed to convertKeys: "+e);if(Array.isArray(e))return e;Array.isArray(r)||(r=[]);for(const a in e)if(e.hasOwnProperty(a)){const n=t(a);typeof e[a]=="object"&&e[a]!==null&&!r.includes(a)&&!r.includes(n)&&(e[a]=s(e[a],t,r)),n!==a&&(e[n]=e[a],delete e[a])}return e},ap=function(e){if(typeof e!="string")throw new Error("String expected for conversion to snake case");return e.trim().replace(/_+|\-+/g," ").replace(/(?:^\w|[A-Z]|\b\w|\s+)/g,function(t,r){return Number(t)===0?"":r===0?t.toLowerCase():t.toUpperCase()})};const np=cn,op=ap;var $r=function(e,t){return np(e,op,t)},ip=function(e){if(typeof e!="string")throw new Error("String expected for conversion to snake case");return e.trim().replace(/(\s*\-*\b\w|[A-Z])/g,function(t){return t=t.trim().toLowerCase().replace("-",""),(t[0]==="_"?"":"_")+t}).slice(1)};const cp=cn,lp=ip;var Ns=function(e,t){return cp(e,lp,t)},Mr=function(e){return JSON.parse(JSON.stringify(e))};const up={},dp=Object.freeze(Object.defineProperty({__proto__:null,default:up},Symbol.toStringTag,{value:"Module"})),yc=El(dp),hp=$r,mp=Ns,pp=Mr,fp=yc,gp=yc;let _p=class{constructor(e){e&&this.fromData(e)}fromData(e){if(typeof e!="object")throw new Error("Expecting object for Mail data");e=pp(e),e=hp(e);const{content:t,filename:r,type:a,disposition:n,contentId:o,filePath:i}=e;if(typeof t<"u"&&typeof i<"u")throw new Error("The props 'content' and 'filePath' cannot be used together.");this.setFilename(r),this.setType(a),this.setDisposition(n),this.setContentId(o),this.setContent(i?this.readFile(i):t)}readFile(e){return fp.readFileSync(gp.resolve(e))}setContent(e){if(typeof e=="string"){this.content=e;return}else if(e instanceof Buffer&&e.toString!==void 0){this.content=e.toString(),this.disposition==="attachment"&&(this.content=e.toString("base64"));return}throw new Error("`content` expected to be either Buffer or string")}setFileContent(e){if(e instanceof Buffer&&e.toString!==void 0){this.content=e.toString("base64");return}throw new Error("`content` expected to be Buffer")}setFilename(e){if(!(typeof e>"u")){if(e&&typeof e!="string")throw new Error("String expected for `filename`");this.filename=e}}setType(e){if(!(typeof e>"u")){if(typeof e!="string")throw new Error("String expected for `type`");this.type=e}}setDisposition(e){if(!(typeof e>"u")){if(typeof e!="string")throw new Error("String expected for `disposition`");this.disposition=e}}setContentId(e){if(!(typeof e>"u")){if(typeof e!="string")throw new Error("String expected for `contentId`");this.contentId=e}}toJSON(){const{content:e,filename:t,type:r,disposition:a,contentId:n}=this,o={content:e,filename:t};return typeof r<"u"&&(o.type=r),typeof a<"u"&&(o.disposition=a),typeof n<"u"&&(o.contentId=n),mp(o)}};var yp=_p,bc=function(e){if(e.indexOf("<")===-1)return["",e];let[t,r]=e.split("<");return t=t.trim(),r=r.replace(">","").trim(),[t,r]};const bp=bc;let wp=class Pa{constructor(e){e&&this.fromData(e)}fromData(e){if(typeof e=="string"){const[a,n]=bp(e);e={name:a,email:n}}if(typeof e!="object")throw new Error("Expecting object or string for EmailAddress data");const{name:t,email:r}=e;this.setEmail(r),this.setName(t)}setName(e){if(!(typeof e>"u")){if(typeof e!="string")throw new Error("String expected for `name`");this.name=e}}setEmail(e){if(typeof e>"u")throw new Error("Must provide `email`");if(typeof e!="string")throw new Error("String expected for `email`");this.email=e}toJSON(){const{email:e,name:t}=this,r={email:e};return t!==""&&(r.name=t),r}static create(e){return Array.isArray(e)?e.filter(t=>!!t).map(t=>this.create(t)):e instanceof Pa?e:new Pa(e)}};var ln=wp,vp=function(e){return Sp(e)&&!Ep(e)};function Sp(s){return!!s&&typeof s=="object"}function Ep(s){var e=Object.prototype.toString.call(s);return e==="[object RegExp]"||e==="[object Date]"||Ap(s)}var xp=typeof Symbol=="function"&&Symbol.for,Pp=xp?Symbol.for("react.element"):60103;function Ap(s){return s.$$typeof===Pp}function kp(s){return Array.isArray(s)?[]:{}}function kr(s,e){return e.clone!==!1&&e.isMergeableObject(s)?ar(kp(s),s,e):s}function Ip(s,e,t){return s.concat(e).map(function(r){return kr(r,t)})}function Cp(s,e){if(!e.customMerge)return ar;var t=e.customMerge(s);return typeof t=="function"?t:ar}function Dp(s){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(s).filter(function(e){return Object.propertyIsEnumerable.call(s,e)}):[]}function eo(s){return Object.keys(s).concat(Dp(s))}function wc(s,e){try{return e in s}catch{return!1}}function Tp(s,e){return wc(s,e)&&!(Object.hasOwnProperty.call(s,e)&&Object.propertyIsEnumerable.call(s,e))}function Rp(s,e,t){var r={};return t.isMergeableObject(s)&&eo(s).forEach(function(a){r[a]=kr(s[a],t)}),eo(e).forEach(function(a){Tp(s,a)||(wc(s,a)&&t.isMergeableObject(e[a])?r[a]=Cp(a,t)(s[a],e[a],t):r[a]=kr(e[a],t))}),r}function ar(s,e,t){t=t||{},t.arrayMerge=t.arrayMerge||Ip,t.isMergeableObject=t.isMergeableObject||vp,t.cloneUnlessOtherwiseSpecified=kr;var r=Array.isArray(e),a=Array.isArray(s),n=r===a;return n?r?t.arrayMerge(s,e,t):Rp(s,e,t):kr(e,t)}ar.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(r,a){return ar(r,a,t)},{})};var Op=ar,Np=Op,vc=function s(e,t="{{",r="}}"){if(Array.isArray(e))return e.map(n=>s(n,t,r));const a={};for(const n in e)e.hasOwnProperty(n)&&(a[t+n+r]=String(e[n]));return a};const vt=ln,Lp=$r,Up=Ns,jp=Mr,$p=Np,Mp=vc;let qp=class{constructor(e){this.to=[],this.cc=[],this.bcc=[],this.headers={},this.customArgs={},this.substitutions={},this.substitutionWrappers=["{{","}}"],this.dynamicTemplateData={},e&&this.fromData(e)}fromData(e){if(typeof e!="object")throw new Error("Expecting object for Mail data");e=jp(e),e=Lp(e,["substitutions","dynamicTemplateData","customArgs","headers"]);const{to:t,from:r,cc:a,bcc:n,subject:o,headers:i,customArgs:c,sendAt:l,substitutions:d,substitutionWrappers:u,dynamicTemplateData:h}=e;this.setTo(t),this.setFrom(r),this.setCc(a),this.setBcc(n),this.setSubject(o),this.setHeaders(i),this.setSubstitutions(d),this.setSubstitutionWrappers(u),this.setCustomArgs(c),this.setDynamicTemplateData(h),this.setSendAt(l)}setSubject(e){if(!(typeof e>"u")){if(typeof e!="string")throw new Error("String expected for `subject`");this.subject=e}}setSendAt(e){if(!(typeof e>"u")){if(!Number.isInteger(e))throw new Error("Integer expected for `sendAt`");this.sendAt=e}}setTo(e){typeof e>"u"||(Array.isArray(e)||(e=[e]),this.to=vt.create(e))}setFrom(e){typeof e>"u"||(this.from=vt.create(e))}addTo(e){typeof e>"u"||this.to.push(vt.create(e))}setCc(e){typeof e>"u"||(Array.isArray(e)||(e=[e]),this.cc=vt.create(e))}addCc(e){typeof e>"u"||this.cc.push(vt.create(e))}setBcc(e){typeof e>"u"||(Array.isArray(e)||(e=[e]),this.bcc=vt.create(e))}addBcc(e){typeof e>"u"||this.bcc.push(vt.create(e))}setHeaders(e){if(!(typeof e>"u")){if(typeof e!="object"||e===null)throw new Error("Object expected for `headers`");this.headers=e}}addHeader(e,t){if(typeof e!="string")throw new Error("String expected for header key");if(typeof t!="string")throw new Error("String expected for header value");this.headers[e]=t}setCustomArgs(e){if(!(typeof e>"u")){if(typeof e!="object"||e===null)throw new Error("Object expected for `customArgs`");this.customArgs=e}}addCustomArg(e,t){if(typeof e!="string")throw new Error("String expected for custom arg key");if(typeof t!="string")throw new Error("String expected for custom arg value");this.customArgs[e]=t}setSubstitutions(e){if(!(typeof e>"u")){if(typeof e!="object")throw new Error("Object expected for `substitutions`");this.substitutions=e}}addSubstitution(e,t){if(typeof e!="string")throw new Error("String expected for substitution key");if(typeof t!="string"&&typeof t!="number")throw new Error("String or Number expected for substitution value");this.substitutions[e]=t}reverseMergeSubstitutions(e){if(!(typeof e>"u"||e===null)){if(typeof e!="object")throw new Error("Object expected for `substitutions` in reverseMergeSubstitutions");this.substitutions=Object.assign({},e,this.substitutions)}}setSubstitutionWrappers(e){if(!(typeof e>"u"||e===null)){if(!Array.isArray(e)||e.length!==2)throw new Error("Array expected with two elements for `substitutionWrappers`");this.substitutionWrappers=e}}deepMergeDynamicTemplateData(e){if(!(typeof e>"u"||e===null)){if(typeof e!="object")throw new Error("Object expected for `dynamicTemplateData` in deepMergeDynamicTemplateData");this.dynamicTemplateData=$p(e,this.dynamicTemplateData)}}setDynamicTemplateData(e){if(!(typeof e>"u")){if(typeof e!="object")throw new Error("Object expected for `dynamicTemplateData`");this.dynamicTemplateData=e}}toJSON(){const{to:e,from:t,cc:r,bcc:a,subject:n,headers:o,customArgs:i,sendAt:c,substitutions:l,substitutionWrappers:d,dynamicTemplateData:u}=this,h={to:e};if(Array.isArray(r)&&r.length>0&&(h.cc=r),Array.isArray(a)&&a.length>0&&(h.bcc=a),Object.keys(o).length>0&&(h.headers=o),l&&Object.keys(l).length>0){const[g,p]=d;h.substitutions=Mp(l,g,p)}return Object.keys(i).length>0&&(h.customArgs=i),u&&Object.keys(u).length>0&&(h.dynamicTemplateData=u),typeof n<"u"&&(h.subject=n),typeof c<"u"&&(h.sendAt=c),typeof t<"u"&&(h.from=t),Up(h,["substitutions","dynamicTemplateData","customArgs","headers"])}};var Sc=qp,Ec=function(e){return e.map(t=>typeof t=="object"&&t!==null&&typeof t.toJSON=="function"?t.toJSON():t)};const Bp=`
Content with characters ', " or & may need to be escaped with three brackets
{{{ content }}}
See https://sendgrid.com/docs/for-developers/sending-email/using-handlebars/ for more information.`;var Fp={DYNAMIC_TEMPLATE_CHAR_WARNING:Bp};const we=(s,e,t,r)=>{if(!(typeof s>"u"||typeof s[t]>"u")&&typeof s[t]!==r)throw new Error(`${r} expected for \`${e}.${t}\``)};var zp={validateMailSettings(s){if(typeof s!="object")throw new Error("Object expected for `mailSettings`");const{bcc:e,bypassListManagement:t,bypassSpamManagement:r,bypassBounceManagement:a,bypassUnsubscribeManagement:n,footer:o,sandboxMode:i,spamCheck:c}=s;we(e,"bcc","enable","boolean"),we(e,"bcc","email","string"),we(t,"bypassListManagement","enable","boolean"),we(r,"bypassSpamManagement","enable","boolean"),we(a,"bypassBounceManagement","enable","boolean"),we(n,"bypassUnsubscribeManagement","enable","boolean"),we(o,"footer","enable","boolean"),we(o,"footer","text","string"),we(o,"footer","html","string"),we(i,"sandboxMode","enable","boolean"),we(c,"spamCheck","enable","boolean"),we(c,"spamCheck","threshold","number"),we(c,"spamCheck","postToUrl","string")},validateTrackingSettings(s){if(typeof s!="object")throw new Error("Object expected for `trackingSettings`");const{clickTracking:e,openTracking:t,subscriptionTracking:r,ganalytics:a}=s;we(e,"clickTracking","enable","boolean"),we(e,"clickTracking","enableText","boolean"),we(t,"openTracking","enable","boolean"),we(t,"openTracking","substitutionTag","string"),we(r,"subscriptionTracking","enable","boolean"),we(r,"subscriptionTracking","text","string"),we(r,"subscriptionTracking","html","string"),we(r,"subscriptionTracking","substitutionTag","string"),we(a,"ganalytics","enable","boolean"),we(a,"ganalytics","utm_source","string"),we(a,"ganalytics","utm_medium","string"),we(a,"ganalytics","utm_term","string"),we(a,"ganalytics","utm_content","string"),we(a,"ganalytics","utm_campaign","string")}};const to=ln,br=Sc,Vp=$r,Gp=Ns,Wp=Mr,Qs=Ec,{DYNAMIC_TEMPLATE_CHAR_WARNING:Hp}=Fp,{validateMailSettings:Qp,validateTrackingSettings:Kp}=zp;let Jp=class Aa{constructor(e){this.isDynamic=!1,this.hideWarnings=!1,this.personalizations=[],this.attachments=[],this.content=[],this.categories=[],this.headers={},this.sections={},this.customArgs={},this.trackingSettings={},this.mailSettings={},this.asm={},this.substitutions=null,this.substitutionWrappers=null,this.dynamicTemplateData=null,e&&this.fromData(e)}fromData(e){if(typeof e!="object")throw new Error("Expecting object for Mail data");e=Wp(e),e=Vp(e,["substitutions","dynamicTemplateData","customArgs","headers","sections"]);const{to:t,from:r,replyTo:a,cc:n,bcc:o,sendAt:i,subject:c,text:l,html:d,content:u,templateId:h,personalizations:g,attachments:p,ipPoolName:m,batchId:_,sections:b,headers:S,categories:v,category:C,customArgs:T,asm:x,mailSettings:R,trackingSettings:k,substitutions:P,substitutionWrappers:O,dynamicTemplateData:N,isMultiple:$,hideWarnings:M,replyToList:L}=e;this.setFrom(r),this.setReplyTo(a),this.setSubject(c),this.setSendAt(i),this.setTemplateId(h),this.setBatchId(_),this.setIpPoolName(m),this.setAttachments(p),this.setContent(u),this.setSections(b),this.setHeaders(S),this.setCategories(C),this.setCategories(v),this.setCustomArgs(T),this.setAsm(x),this.setMailSettings(R),this.setTrackingSettings(k),this.setHideWarnings(M),this.setReplyToList(L),this.isDynamic?this.setDynamicTemplateData(N):(this.setSubstitutions(P),this.setSubstitutionWrappers(O)),this.addTextContent(l),this.addHtmlContent(d),g?this.setPersonalizations(g):$&&Array.isArray(t)?t.forEach(B=>this.addTo(B,n,o)):this.addTo(t,n,o)}setFrom(e){if(this._checkProperty("from",e,[this._checkUndefined])){if(typeof e!="string"&&typeof e.email!="string")throw new Error("String or address object expected for `from`");this.from=to.create(e)}}setReplyTo(e){if(this._checkProperty("replyTo",e,[this._checkUndefined])){if(typeof e!="string"&&typeof e.email!="string")throw new Error("String or address object expected for `replyTo`");this.replyTo=to.create(e)}}setSubject(e){this._setProperty("subject",e,"string")}setSendAt(e){this._checkProperty("sendAt",e,[this._checkUndefined,this._createCheckThatThrows(Number.isInteger,"Integer expected for `sendAt`")])&&(this.sendAt=e)}setTemplateId(e){this._setProperty("templateId",e,"string")&&e.indexOf("d-")===0&&(this.isDynamic=!0)}setBatchId(e){this._setProperty("batchId",e,"string")}setIpPoolName(e){this._setProperty("ipPoolName",e,"string")}setAsm(e){if(this._checkProperty("asm",e,[this._checkUndefined,this._createTypeCheck("object")])){if(typeof e.groupId!="number")throw new Error("Expected `asm` to include an integer in its `groupId` field");if(e.groupsToDisplay&&(!Array.isArray(e.groupsToDisplay)||!e.groupsToDisplay.every(t=>typeof t=="number")))throw new Error("Array of integers expected for `asm.groupsToDisplay`");this.asm=e}}setPersonalizations(e){if(this._doArrayCheck("personalizations",e)){if(!e.every(t=>typeof t=="object"))throw new Error("Array of objects expected for `personalizations`");this.personalizations=[],e.forEach(t=>this.addPersonalization(t))}}addPersonalization(e){this.isDynamic&&e.substitutions?delete e.substitutions:!this.isDynamic&&e.dynamicTemplateData&&delete e.dynamicTemplateData,e instanceof br||(e=new br(e)),this.isDynamic?this.applyDynamicTemplateData(e):this.applySubstitutions(e),this.personalizations.push(e)}addTo(e,t,r){if(typeof e>"u"&&typeof t>"u"&&typeof r>"u")throw new Error("Provide at least one of to, cc or bcc");this.addPersonalization(new br({to:e,cc:t,bcc:r}))}setSubstitutions(e){this._setProperty("substitutions",e,"object")}setSubstitutionWrappers(e){let t=(r,a)=>{if(!Array.isArray(a)||a.length!==2)throw new Error("Array expected with two elements for `"+r+"`")};this._checkProperty("substitutionWrappers",e,[this._checkUndefined,t])&&(this.substitutionWrappers=e)}applySubstitutions(e){e instanceof br&&(e.reverseMergeSubstitutions(this.substitutions),e.setSubstitutionWrappers(this.substitutionWrappers))}applyDynamicTemplateData(e){e instanceof br&&e.deepMergeDynamicTemplateData(this.dynamicTemplateData)}setDynamicTemplateData(e){if(!(typeof e>"u")){if(typeof e!="object")throw new Error("Object expected for `dynamicTemplateData`");this.hideWarnings||Object.values(e).forEach(t=>{/['"&]/.test(t)&&console.warn(Hp)}),this.dynamicTemplateData=e}}setContent(e){if(this._doArrayCheck("content",e)){if(!e.every(t=>typeof t=="object"))throw new Error("Expected each entry in `content` to be an object");if(!e.every(t=>typeof t.type=="string"))throw new Error("Expected each `content` entry to contain a `type` string");if(!e.every(t=>typeof t.value=="string"))throw new Error("Expected each `content` entry to contain a `value` string");this.content=e}}addContent(e){this._checkProperty("content",e,[this._createTypeCheck("object")])&&this.content.push(e)}addTextContent(e){this._checkProperty("text",e,[this._checkUndefined,this._createTypeCheck("string")])&&this.addContent({value:e,type:"text/plain"})}addHtmlContent(e){this._checkProperty("html",e,[this._checkUndefined,this._createTypeCheck("string")])&&this.addContent({value:e,type:"text/html"})}setAttachments(e){if(this._doArrayCheck("attachments",e)){if(!e.every(t=>typeof t.content=="string"))throw new Error("Expected each attachment to contain a `content` string");if(!e.every(t=>typeof t.filename=="string"))throw new Error("Expected each attachment to contain a `filename` string");if(!e.every(t=>!t.type||typeof t.type=="string"))throw new Error("Expected the attachment's `type` field to be a string");if(!e.every(t=>!t.disposition||typeof t.disposition=="string"))throw new Error("Expected the attachment's `disposition` field to be a string");this.attachments=e}}addAttachment(e){this._checkProperty("attachment",e,[this._checkUndefined,this._createTypeCheck("object")])&&this.attachments.push(e)}setCategories(e){let t=(r,a)=>{if(!Array.isArray(a)||!a.every(n=>typeof n=="string"))throw new Error("Array of strings expected for `"+r+"`")};typeof e=="string"&&(e=[e]),this._checkProperty("categories",e,[this._checkUndefined,t])&&(this.categories=e)}addCategory(e){this._checkProperty("category",e,[this._createTypeCheck("string")])&&this.categories.push(e)}setHeaders(e){this._setProperty("headers",e,"object")}addHeader(e,t){this._checkProperty("key",e,[this._createTypeCheck("string")])&&this._checkProperty("value",t,[this._createTypeCheck("string")])&&(this.headers[e]=t)}setSections(e){this._setProperty("sections",e,"object")}setCustomArgs(e){this._setProperty("customArgs",e,"object")}setTrackingSettings(e){typeof e>"u"||(Kp(e),this.trackingSettings=e)}setMailSettings(e){typeof e>"u"||(Qp(e),this.mailSettings=e)}setHideWarnings(e){if(!(typeof e>"u")){if(typeof e!="boolean")throw new Error("Boolean expected for `hideWarnings`");this.hideWarnings=e}}toJSON(){const{from:e,replyTo:t,sendAt:r,subject:a,content:n,templateId:o,personalizations:i,attachments:c,ipPoolName:l,batchId:d,asm:u,sections:h,headers:g,categories:p,customArgs:m,mailSettings:_,trackingSettings:b,replyToList:S}=this,v={from:e,subject:a,personalizations:Qs(i)};return Array.isArray(c)&&c.length>0&&(v.attachments=Qs(c)),Array.isArray(p)&&p.length>0&&(v.categories=p.filter(C=>C!=="")),Array.isArray(n)&&n.length>0&&(v.content=Qs(n)),Object.keys(g).length>0&&(v.headers=g),Object.keys(_).length>0&&(v.mailSettings=_),Object.keys(b).length>0&&(v.trackingSettings=b),Object.keys(m).length>0&&(v.customArgs=m),Object.keys(h).length>0&&(v.sections=h),Object.keys(u).length>0&&(v.asm=u),typeof t<"u"&&(v.replyTo=t),typeof r<"u"&&(v.sendAt=r),typeof d<"u"&&(v.batchId=d),typeof o<"u"&&(v.templateId=o),typeof l<"u"&&(v.ipPoolName=l),typeof S<"u"&&(v.replyToList=S),Gp(v,["substitutions","dynamicTemplateData","customArgs","headers","sections"])}static create(e){return Array.isArray(e)?e.filter(t=>!!t).map(t=>this.create(t)):e instanceof Aa?e:new Aa(e)}_checkProperty(e,t,r){return!r.some(a=>a(e,t))}_setProperty(e,t,r){let a=this._checkProperty(e,t,[this._checkUndefined,this._createTypeCheck(r)]);return a&&(this[e]=t),a}_checkUndefined(e,t){return typeof t>"u"}_createTypeCheck(e){return(t,r)=>{if(typeof r!==e)throw new Error(e+" expected for `"+t+"`")}}_createCheckThatThrows(e,t){return(r,a)=>{if(!e(a))throw new Error(t)}}_setArrayProperty(e,t){this._doArrayCheck(e,t)&&(this[e]=t)}_doArrayCheck(e,t){return this._checkProperty(e,t,[this._checkUndefined,this._createCheckThatThrows(Array.isArray,"Array expected for`"+e+"`")])}setReplyToList(e){if(this._doArrayCheck("replyToList",e)&&e.length){if(!e.every(t=>t&&typeof t.email=="string"))throw new Error("Expected each replyTo to contain an `email` string");this.replyToList=e}}};var Yp=Jp;let Xp=class{constructor(e,t,r){this.statusCode=e,this.body=t,this.headers=r}toString(){return"HTTP "+this.statusCode+" "+this.body}};var Zp=Xp;let ef=class extends Error{constructor(e){super();const{headers:t,status:r,statusText:a,data:n}=e;this.code=r,this.message=a,this.response={headers:t,body:n},this.stack||Error.captureStackTrace(this,this.constructor);const o=new RegExp(process.cwd()+"/","gi");this.stack=this.stack.replace(o,"")}toString(){const{body:e}=this.response;let t=`${this.message} (${this.code})`;return e&&Array.isArray(e.errors)&&e.errors.forEach(r=>{const a=r.message,n=r.field,o=r.help;t+=`
  ${a}
    ${n}
    ${o}`}),t}toJSON(){const{message:e,code:t,response:r}=this;return{message:e,code:t,response:r}}};var tf=ef;const rf=$r,sf=Mr,af=["day","week","month"],nf=["us","ca"],Yr=["desc","asc"];let of=class{constructor(e){this.startDate=null,this.endDate=null,this.aggregatedBy=null,e&&this.fromData(e)}fromData(e){if(typeof e!="object")throw new Error("Expecting object for Statistics data");e=sf(e),e=rf(e,["substitutions","customArgs"]);const{startDate:t,endDate:r,aggregatedBy:a}=e;this.setStartDate(t),this.setEndDate(r),this.setAggregatedBy(a)}setStartDate(e){if(typeof e>"u")throw new Error("Date expected for `startDate`");if(new Date(e)==="Invalid Date"||isNaN(new Date(e)))throw new Error("Date expected for `startDate`");console.log(e),this.startDate=new Date(e).toISOString().slice(0,10)}setEndDate(e){if(typeof e>"u"){this.endDate=new Date().toISOString().slice(0,10);return}if(new Date(e)==="Invalid Date"||isNaN(new Date(e)))throw new Error("Date expected for `endDate`");this.endDate=new Date(e).toISOString().slice(0,10)}setAggregatedBy(e){if(!(typeof e>"u"))if(typeof e=="string"&&af.includes(e.toLowerCase()))this.aggregatedBy=e;else throw new Error("Incorrect value for `aggregatedBy`")}getGlobal(){const{startDate:e,endDate:t,aggregatedBy:r}=this;return{startDate:e,endDate:t,aggregatedBy:r}}getAdvanced(e){const t=this.getGlobal();return typeof e>"u"||typeof e=="string"&&nf.includes(e.toLowerCase())&&(t.country=e),t}getAdvancedMailboxProviders(e){const t=this.getGlobal();if(typeof e>"u")return t;if(Array.isArray(e)&&e.some(r=>typeof r!="string"))throw new Error("Array of strings expected for `mailboxProviders`");return t.mailBoxProviders=e,t}getAdvancedBrowsers(e){const t=this.getGlobal();if(typeof e>"u")return t;if(Array.isArray(e)&&e.some(r=>typeof r!="string"))throw new Error("Array of strings expected for `browsers`");return t.browsers=e,t}getCategories(e){if(typeof e>"u")throw new Error("Array of strings expected for `categories`");if(!this._isValidArrayOfStrings(e))throw new Error("Array of strings expected for `categories`");const t=this.getGlobal();return t.categories=e,t}getSubuser(e){if(typeof e>"u")throw new Error("Array of strings expected for `subusers`");if(!this._isValidArrayOfStrings(e))throw new Error("Array of strings expected for `subusers`");const t=this.getGlobal();return t.subusers=e,t}getSubuserSum(e="delivered",t=Yr[0],r=5,a=0){if(typeof e!="string")throw new Error("string expected for `sortByMetric`");if(!Yr.includes(t.toLowerCase()))throw new Error("desc or asc expected for `sortByDirection`");if(typeof r!="number")throw new Error("number expected for `limit`");if(typeof a!="number")throw new Error("number expected for `offset`");const n=this.getGlobal();return n.sortByMetric=e,n.sortByDirection=t,n.limit=r,n.offset=a,n}getSubuserMonthly(e="delivered",t=Yr[0],r=5,a=0){if(typeof e!="string")throw new Error("string expected for `sortByMetric`");if(!Yr.includes(t.toLowerCase()))throw new Error("desc or asc expected for `sortByDirection`");if(typeof r!="number")throw new Error("number expected for `limit`");if(typeof a!="number")throw new Error("number expected for `offset`");const n=this.getGlobal();return n.sortByMetric=e,n.sortByDirection=t,n.limit=r,n.offset=a,n}_isValidArrayOfStrings(e){return!(!Array.isArray(e)||e.length<1||e.some(t=>typeof t!="string"))}};var cf=of;const lf=yp,uf=ln,df=Yp,hf=Sc,mf=Zp,pf=tf,ff=cf;var gf={Attachment:lf,EmailAddress:uf,Mail:df,Personalization:hf,Response:mf,ResponseError:pf,Statistics:ff},_f=function(e,t){if(typeof e!="object"||e===null)throw new Error("Not an object provided for base");if(typeof t!="object"||t===null)throw new Error("Not an object provided for data");const r=Object.assign({},e);for(const a in t)t.hasOwnProperty(a)&&(t[a]&&Array.isArray(t[a])?r[a]=t[a]:t[a]&&typeof t[a]=="object"?r[a]=Object.assign({},t[a]):t[a]&&(r[a]=t[a]));return r};const yf=Ec,bf=cn,wf=Mr,vf=_f,Sf=bc,Ef=$r,xf=Ns,Pf=vc;var Af={arrayToJSON:yf,convertKeys:bf,deepClone:wf,mergeData:vf,splitNameEmail:Sf,toCamelCase:Ef,toSnakeCase:xf,wrapSubstitutions:Pf};const kf=gf,If=Af;var xc={classes:kf,helpers:If};const Cf=qm,Df=sp,{helpers:{mergeData:ro},classes:{Response:Tf,ResponseError:Rf}}=xc,so="SG.",Of="https://api.sendgrid.com/",Nf="https://email.twilio.com/",Lf="global",Ks={eu:"https://api.eu.sendgrid.com/",global:"https://api.sendgrid.com/"};let Uf=class{constructor(){this.auth="",this.impersonateSubuser="",this.sendgrid_region=Lf,this.defaultHeaders={Accept:"application/json","Content-Type":"application/json","User-Agent":"sendgrid/"+Df.version+";nodejs"},this.defaultRequest={baseUrl:Of,url:"",method:"GET",headers:{},maxContentLength:1/0,maxBodyLength:1/0}}setApiKey(e){this.auth="Bearer "+e,this.setDefaultRequest("baseUrl",Ks[this.sendgrid_region]),this.isValidApiKey(e)||console.warn(`API key does not start with "${so}".`)}setTwilioEmailAuth(e,t){const r=Buffer.from(e+":"+t).toString("base64");this.auth="Basic "+r,this.setDefaultRequest("baseUrl",Nf),this.isValidTwilioAuth(e,t)||console.warn("Twilio Email credentials must be non-empty strings.")}isValidApiKey(e){return this.isString(e)&&e.trim().startsWith(so)}isValidTwilioAuth(e,t){return this.isString(e)&&e&&this.isString(t)&&t}isString(e){return typeof e=="string"||e instanceof String}setImpersonateSubuser(e){this.impersonateSubuser=e}setDefaultHeader(e,t){return e!==null&&typeof e=="object"?(Object.assign(this.defaultHeaders,e),this):(this.defaultHeaders[e]=t,this)}setDefaultRequest(e,t){return e!==null&&typeof e=="object"?(Object.assign(this.defaultRequest,e),this):(this.defaultRequest[e]=t,this)}setDataResidency(e){return Ks.hasOwnProperty(e)?(this.sendgrid_region=e,this.setDefaultRequest("baseUrl",Ks[e])):console.warn('Region can only be "global" or "eu".'),this}createHeaders(e){const t=ro(this.defaultHeaders,e);return typeof t.Authorization>"u"&&this.auth&&(t.Authorization=this.auth),this.impersonateSubuser&&(t["On-Behalf-Of"]=this.impersonateSubuser),t}createRequest(e){let t={url:e.uri||e.url,baseUrl:e.baseUrl,method:e.method,data:e.body,params:e.qs,headers:e.headers};return t=ro(this.defaultRequest,t),t.headers=this.createHeaders(t.headers),t.baseURL=t.baseUrl,delete t.baseUrl,t}request(e,t){e=this.createRequest(e);const r=new Promise((a,n)=>{Cf(e).then(o=>a([new Tf(o.status,o.data,o.headers),o.data])).catch(o=>o.response&&o.response.status>=400?n(new Rf(o.response)):n(o))});if(t&&typeof t!="function")throw new Error("Callback passed is not a function.");return t?r.then(a=>t(null,a)).catch(a=>t(a,null)):r}};var Pc=Uf;const jf=Pc;var $f=new jf;const Mf=$f,qf=Pc;Za.exports=Mf;Za.exports.Client=qf;var Bf=Za.exports;const{Client:Ff}=Bf,{classes:{Mail:zf}}=xc;let Vf=class{constructor(){this.setClient(new Ff),this.setSubstitutionWrappers("{{","}}"),this.secretRules=[]}setClient(e){return this.client=e,this}setApiKey(e){return this.client.setApiKey(e),this}setTwilioEmailAuth(e,t){this.client.setTwilioEmailAuth(e,t)}setTimeout(e){typeof e>"u"||this.client.setDefaultRequest("timeout",e)}setSubstitutionWrappers(e,t){if(typeof e>"u"||typeof t>"u")throw new Error("Must provide both left and right side wrappers");return Array.isArray(this.substitutionWrappers)||(this.substitutionWrappers=[]),this.substitutionWrappers[0]=e,this.substitutionWrappers[1]=t,this}setSecretRules(e){e instanceof Array||(e=[e]);const t=e.map(function(r){const a=typeof r;if(a==="string")return{pattern:new RegExp(r)};if(a==="object"){r instanceof RegExp?r={pattern:r}:r.hasOwnProperty("pattern")&&typeof r.pattern=="string"&&(r.pattern=new RegExp(r.pattern));try{return r.pattern.test(""),r}catch{}}});this.secretRules=t.filter(function(r){return r})}filterSecrets(e){if(typeof e=="object"&&!e.hasOwnProperty("content"))return;const t=this;e.content.forEach(function(r){t.secretRules.forEach(function(a){if(a.hasOwnProperty("pattern")&&!a.pattern.test(r.value))return;let n=`The pattern '${a.pattern}'`;throw a.name&&(n+=`identified by '${a.name}'`),n+=" was found in the Mail content!",new Error(n)})})}send(e,t=!1,r){if(typeof t=="function"&&(r=t,t=!1),Array.isArray(e)){const a=Promise.all(e.map(n=>this.send(n,t)));return r&&a.then(n=>r(null,n)).catch(n=>r(n,null)),a}try{typeof e.isMultiple>"u"&&(e.isMultiple=t),typeof e.substitutionWrappers>"u"&&(e.substitutionWrappers=this.substitutionWrappers);const a=zf.create(e),n=a.toJSON();this.filterSecrets(n);const o={method:"POST",url:"/v3/mail/send",headers:a.headers,body:n};return this.client.request(o,r)}catch(a){return r&&r(a,null),Promise.reject(a)}}sendMultiple(e,t){return this.send(e,!0,t)}};var Ac=Vf;const Gf=Ac;var Wf=new Gf;const Hf=Wf,Qf=Ac;Xa.exports=Hf;Xa.exports.MailService=Qf;var Kf=Xa.exports;const kc=Ao(Kf);console.log(" Using Neon database client (Supabase-compatible API)");const ka={}.VITE_SENDGRID_API_KEY,Jf={}.VITE_FROM_EMAIL||"noreply@dukani.site",Yf={}.VITE_FROM_NAME||"NEON POS";ka&&kc.setApiKey(ka);class Wt{constructor(){this.queue=[],this.isProcessing=!1,this.maxRetries=3,setInterval(()=>this.processQueue(),1e4)}static getInstance(){return Wt.instance||(Wt.instance=new Wt),Wt.instance}async send(e){if(!ka)return{success:!1,error:"Email service not configured"};try{const t={to:e.to,from:{email:Jf,name:Yf},subject:e.subject,html:e.html,text:e.text,cc:e.cc,bcc:e.bcc,replyTo:e.replyTo,attachments:e.attachments,sendAt:e.sendAt};e.templateId&&(t.templateId=e.templateId,t.dynamicTemplateData=e.templateData||{});const[r]=await kc.send(t);return await this.logEmail({to:Array.isArray(e.to)?e.to.join(", "):e.to,subject:e.subject,status:"sent",message_id:r.headers["x-message-id"]||void 0,provider_response:JSON.stringify(r)}),console.log(" [Email] Sent successfully"),{success:!0,messageId:r.headers["x-message-id"]}}catch(t){return console.error(" [Email] Send failed:",t),await this.logEmail({to:Array.isArray(e.to)?e.to.join(", "):e.to,subject:e.subject,status:"failed",error_message:t.message}),{success:!1,error:t.message}}}async sendWithRetry(e){const t=await this.send(e);return!t.success&&this.maxRetries>0&&this.queue.push({options:e,retries:0}),t}async processQueue(){if(this.queue.length===0||this.isProcessing)return;this.isProcessing=!0;const e=this.queue.shift();if(!e){this.isProcessing=!1;return}!(await this.send(e.options)).success&&e.retries<this.maxRetries&&(this.queue.push({options:e.options,retries:e.retries+1}),console.log(` [Email] Retry ${e.retries+1}/${this.maxRetries} for ${e.options.to}`)),this.isProcessing=!1}async logEmail(e){try{const t=localStorage.getItem("userId"),r=localStorage.getItem("selectedBranch");await w.from("email_logs").insert({...e,user_id:t,branch_id:r,created_at:new Date().toISOString()})}catch(t){console.error(" [Email] Failed to log email:",t)}}async sendReceipt(e){const t=this.generateReceiptHTML(e);return this.sendWithRetry({to:e.to,subject:`Receipt for Order #${e.saleId}`,html:t})}async sendWelcome(e){const t=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Welcome to NEON POS!</h2>
        <p>Hello ${e.name},</p>
        <p>Your account has been created successfully.</p>
        ${e.temporaryPassword?`
          <p>Your temporary password is: <strong>${e.temporaryPassword}</strong></p>
          <p>Please change it after your first login.</p>
        `:""}
        <p>Best regards,<br>NEON POS Team</p>
      </div>
    `;return this.sendWithRetry({to:e.to,subject:"Welcome to NEON POS",html:t})}async sendPasswordReset(e){const t=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2>Password Reset Request</h2>
        <p>Hello ${e.name},</p>
        <p>You requested to reset your password. Click the button below to set a new password:</p>
        <p style="text-align: center; margin: 30px 0;">
          <a href="${e.resetLink}" 
             style="background-color: #4F46E5; color: white; padding: 12px 30px; 
                    text-decoration: none; border-radius: 5px; display: inline-block;">
            Reset Password
          </a>
        </p>
        <p>This link will expire in 1 hour.</p>
        <p>If you didn't request this, please ignore this email.</p>
        <p>Best regards,<br>NEON POS Team</p>
      </div>
    `;return this.sendWithRetry({to:e.to,subject:"Password Reset Request",html:t})}async sendLowStockAlert(e){const r=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h2> Low Stock Alert</h2>
        <p>The following products are running low on stock:</p>
        <ul>${e.products.map(a=>`<li>${a.name}: ${a.currentStock} units (Min: ${a.minStock})</li>`).join("")}</ul>
        <p>Please reorder soon to avoid stockouts.</p>
        <p>Best regards,<br>NEON POS System</p>
      </div>
    `;return this.sendWithRetry({to:e.to,subject:" Low Stock Alert",html:r})}generateReceiptHTML(e){const t=e.items.map(r=>`
        <tr>
          <td>${r.name}</td>
          <td style="text-align: center;">${r.quantity}</td>
          <td style="text-align: right;">TZS ${r.price.toLocaleString()}</td>
          <td style="text-align: right;">TZS ${(r.quantity*r.price).toLocaleString()}</td>
        </tr>
      `).join("");return`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="text-align: center; color: #4F46E5;">NEON POS</h1>
        <h2 style="text-align: center;">Receipt</h2>
        <p><strong>Order ID:</strong> ${e.saleId}</p>
        <p><strong>Customer:</strong> ${e.customerName}</p>
        <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
          <thead>
            <tr style="background-color: #f3f4f6;">
              <th style="padding: 10px; text-align: left;">Item</th>
              <th style="padding: 10px; text-align: center;">Qty</th>
              <th style="padding: 10px; text-align: right;">Price</th>
              <th style="padding: 10px; text-align: right;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${t}
          </tbody>
          <tfoot>
            <tr style="border-top: 2px solid #000; font-weight: bold;">
              <td colspan="3" style="padding: 10px; text-align: right;">Total:</td>
              <td style="padding: 10px; text-align: right;">TZS ${e.total.toLocaleString()}</td>
            </tr>
          </tfoot>
        </table>
        
        <p><strong>Payment Method:</strong> ${e.paymentMethod}</p>
        <p style="text-align: center; margin-top: 30px; color: #666;">
          Thank you for your business!
        </p>
      </div>
    `}}const St=Wt.getInstance(),qr=async s=>{try{const{data:{user:e}}=await w.auth.getUser(),t={action:s.action,details:s.details,user_id:s.user_id||(e==null?void 0:e.id),timestamp:s.timestamp||new Date().toISOString(),entity_type:s.entity_type||"system",entity_id:s.entity_id,user_role:s.user_role||"user",ip_address:s.ip_address,user_agent:s.user_agent},{error:r}=await w.from("audit_logs").insert(t);return r?(console.error("Error logging audit event:",r),!1):!0}catch(e){return console.error("Error logging audit event:",e),!1}},Xf=async(s={})=>{try{let e=w.from("audit_logs").select("*").order("timestamp",{ascending:!1});s.action&&(e=e.eq("action",s.action)),s.entity_type&&(e=e.eq("entity_type",s.entity_type)),s.user_id&&(e=e.eq("user_id",s.user_id)),s.dateFrom&&(e=e.gte("timestamp",s.dateFrom)),s.dateTo&&(e=e.lte("timestamp",s.dateTo));const{data:t,error:r}=await e;return r?(console.error("Error fetching audit logs:",r),[]):t||[]}catch(e){return console.error("Error fetching audit logs:",e),[]}},Zf=async(s,e,t="system")=>qr({action:`settings_${s}`,details:e,entity_type:t}),eg=async(s,e,t="user")=>qr({action:`user_${s}`,details:e,entity_type:t}),tg=async(s,e,t="system")=>qr({action:`system_${s}`,details:e,entity_type:t}),rg=async()=>{try{const{data:s,error:e}=await w.from("audit_logs").select("action, entity_type, timestamp");if(e)return console.error("Error fetching audit statistics:",e),null;const t=new Date,r=new Date(t.getTime()-24*60*60*1e3),a=new Date(t.getTime()-7*24*60*60*1e3),n={total:(s==null?void 0:s.length)||0,today:(s==null?void 0:s.filter(o=>new Date(o.timestamp)>r).length)||0,thisWeek:(s==null?void 0:s.filter(o=>new Date(o.timestamp)>a).length)||0,byEntityType:{device:(s==null?void 0:s.filter(o=>o.entity_type==="device").length)||0,customer:(s==null?void 0:s.filter(o=>o.entity_type==="customer").length)||0,user:(s==null?void 0:s.filter(o=>o.entity_type==="user").length)||0,system:(s==null?void 0:s.filter(o=>o.entity_type==="system").length)||0},byAction:{}};return s==null||s.forEach(o=>{n.byAction[o.action]=(n.byAction[o.action]||0)+1}),n}catch(s){return console.error("Error getting audit statistics:",s),null}},sg=async(s,e,t,r,a,n)=>qr({action:"device_status_change",details:`Device ${s} status changed from ${r} to ${a} by ${t} (${e}). Signature: ${n}`,entity_type:"device",entity_id:s,user_id:e,user_role:t}),ag={logAuditEvent:qr,getAuditLogs:Xf,logSettingsChange:Zf,logUserActivity:eg,logSystemEvent:tg,getAuditStatistics:rg,logDeviceStatusChange:sg},Ic=D.createContext(void 0),ng=()=>{const s=D.useContext(Ic);if(!s)throw new Error("useDevices must be used within a DevicesProvider");return s};async function og(){const{data:s,error:e}=await w.from("users").select("email").eq("role","customer-care");return e||!s?[]:s.map(t=>t.email).filter(Boolean)}const ig=er.memo(({children:s})=>{const[e,t]=D.useState([]),[r,a]=D.useState(!1),n=D.useContext(Nr),o=(n==null?void 0:n.currentUser)||null,i=D.useRef(new Set);D.useEffect(()=>{if(o)for(const T of e)for(const x of T.remarks||[])!i.current.has(x.id)&&x.createdBy!==o.id&&(cs.playRemarkSound().catch(()=>{}),i.current.add(x.id))},[e,o]),D.useEffect(()=>{if(!o)return;a(!0),(async()=>{try{let x;if(o.role==="technician"){const{deviceServices:R}=await z(()=>import("./deviceServices-7fb8f60c.js"),["assets/deviceServices-7fb8f60c.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);x=await R.getDevicesByTechnician(o.id)}else x=await xd();t(x)}catch(x){console.error("Error fetching devices:",x),t([])}finally{a(!1)}})()},[o]);const c=async T=>{var O;if(!o)throw new Error("User not authenticated");if(o.role==="technician")throw new Error("Technicians are not allowed to create devices.");const x=crypto.randomUUID(),R=new Date().toISOString(),k={...T,id:x,createdAt:R,updatedAt:R,status:"assigned",remarks:[],transitions:[{id:`t-${Date.now()}`,fromStatus:"assigned",toStatus:"assigned",performedBy:o.id,timestamp:R,signature:""}]},P=await Pd(k);if(!P)throw new Error("Failed to add device to database");try{const N=T.customerId,{data:$,error:M}=await w.from("customers").select("points, loyalty_level").eq("id",N).single();if(!M&&$){const L=ih(T,$.loyalty_level);L===0&&(console.log(" No points awarded. This could be because:"),console.log("   - Points system is disabled"),console.log("   - Device brand/model not in bonus list"),console.log("   - Customer loyalty level issue"));const U=($.points||0)+L;try{const W=await _a(N,{points:U});console.log(" Customer points updated successfully")}catch(W){console.error(" Failed to update customer points:",W)}try{const W={note:`+${L} points for new device: ${T.brand} ${T.model}`,created_by:o.id,customer_id:N};console.log(" Attempting to insert note:",W);const H=await w.from("customer_notes").insert(W);H.error?(console.error(" Note insertion error:",H.error),console.error(" Full error details:",JSON.stringify(H.error,null,2))):console.log(" Note inserted successfully")}catch(W){console.error(" Exception during note insertion:",W)}console.debug(` Added ${L} points to customer ${N}. New total: ${U}`),ge.success(`Added ${L} loyalty points to customer for new device intake!`)}else console.warn(" Could not update customer points:",M),console.warn("Customer data:",$)}catch(N){console.error(" Error adding points to customer:",N)}t(N=>[...N.filter(M=>M.id!==P.id&&M.serialNumber!==P.serialNumber),P]);try{console.log(" Fetching customer data for SMS...");const{data:N,error:$}=await w.from("customers").select("name, phone").eq("id",T.customerId).single();if($&&(console.error(" Error fetching customer for SMS:",$),console.error(" Full customer error:",JSON.stringify($,null,2))),!$&&N&&N.phone){console.log(" Customer data retrieved, sending SMS to:",N.phone);const M=await Pt.sendDeviceReceivedSMS(N.phone,N.name||"Mteja",T.brand,T.model,x,T.issueDescription||"Ukarabati wa kifaa",T.customerId);M.success?(console.log(" SMS sent successfully"),ge.success("SMS notification sent to customer")):(console.warn(" SMS sending failed:",M.error),(O=M.error)!=null&&O.includes("proxy server")||ge.error("SMS notification failed to send"))}else N!=null&&N.phone||console.warn(" Customer has no phone number, skipping SMS")}catch(N){console.error(" Exception during SMS notification:",N)}try{await cs.playSuccessSound()}catch(N){console.warn("Could not play device received sound:",N)}return{...k,...P}},l=async(T,x,R)=>{if(!o)return!1;const k=e.find($=>$.id===T);if(!k)return!1;const P={id:`t-${Date.now()}`,fromStatus:k.status,toStatus:x,performedBy:o.id,timestamp:new Date().toISOString(),signature:R},O={...k,status:x,updatedAt:new Date().toISOString(),transitions:[...k.transitions||[],P]};return t($=>$.map(M=>M.id===T?O:M)),(async()=>{try{await w.from("device_transitions").insert({device_id:T,from_status:k.status,to_status:x,performed_by:o.id,created_at:P.timestamp,signature:R});const $=await Un(T,O);if(!$)return t(L=>L.map(B=>B.id===T?k:B)),ge.error("Failed to update status in database"),!1;t(L=>L.map(B=>B.id===T?{...O,...$}:B));let M=[];try{const{data:L,error:B,status:U}=await w.from("sms_triggers").select("*").or(`trigger_type.eq.${x},trigger_event.eq.${x}`);if(B&&U!==406&&U!==400)throw B;M=L||[]}catch{M=[]}if(M&&M.length>0)for(const L of M){const{data:B,error:U}=await w.from("communication_templates").select("*").eq("id",L.template_id).eq("is_active",!0).single();if(!B||U)continue;const{data:W,error:H}=await w.from("customers").select("*").eq("id",k.customerId).single();if(!W||H||!W.phone||L.condition&&(L.condition.brand&&k.brand!==L.condition.brand||L.condition.customerTag&&W.customerTag!==L.condition.customerTag))continue;const Q={};let ce=!1;if(B.variables&&Array.isArray(B.variables))for(const re of B.variables){const _e=re,le=re;k[_e]!==void 0?Q[re]=String(k[_e]):W[le]!==void 0?Q[re]=String(W[le]):(ce=!0,Q[re]="")}if(ce){await w.from("sms_trigger_logs").insert({trigger_id:L.id,device_id:T,customer_id:k.customerId,status:x,template_id:B.id,recipient:W.phone,result:"skipped",error:"Missing variable(s) for template"});continue}const X=await Pt.sendTemplateSMS(W.phone,B.id,Q,k.customerId);await w.from("sms_trigger_logs").insert({trigger_id:L.id,device_id:T,customer_id:k.customerId,status:x,template_id:B.id,recipient:W.phone,result:X.success?"sent":"failed",error:X.error||null})}if(x==="repair-complete"){if(k.assignedTo&&(o==null?void 0:o.role)==="technician")try{try{const{data:L,error:B}=await w.from("users").select("points").eq("id",k.assignedTo).single();if(!B&&L){const W=(L.points||0)+20,{error:H}=await w.from("users").update({points:W}).eq("id",k.assignedTo);if(H)console.error("Error updating technician points:",H),ge.success("Repair completed successfully!");else{ge.success(`Repair completed! +20 points awarded. Total: ${W} points`);try{await w.from("staff_points").insert({user_id:k.assignedTo,points:20,reason:`Repair completed for device ${k.brand} ${k.model}`,created_by:o.id})}catch(Q){console.warn("Could not log points transaction:",Q)}}}else console.error("Error fetching technician data:",B),ge.success("Repair completed successfully!")}catch(L){console.error("Error awarding points for repair completion:",L),ge.success("Repair completed successfully!")}}catch(L){console.error("Error awarding points for repair completion:",L)}if(ge.success("Device ready for handover. Customer care notified."),typeof St<"u"&&St.sendEmail){const L=await og();L.length>0&&await St.sendEmail({to:L.join(","),subject:"Device Ready for Handover",content:`Device ${k.brand} ${k.model} (SN: ${k.serialNumber}) is ready for customer handover.`})}}if(x==="done"){const{data:L,error:B}=await w.from("customers").select("name, phone, email").eq("id",k.customerId).single();!B&&L&&(L.phone&&Pt&&Pt.sendDeviceReadySMS&&await Pt.sendDeviceReadySMS(L.phone,L.name||"Customer",k.brand,k.model,k.id,k.customerId),L.email&&typeof St<"u"&&St.sendEmail&&await St.sendEmail({to:L.email,subject:"Your Device is Ready for Pickup",content:`Dear ${L.name},

Your device (${k.brand} ${k.model}, SN: ${k.serialNumber}) is ready for pickup.

Thank you.`}))}return await ag.logDeviceStatusChange(T,o.id,o.role,k.status,x,R),!0}catch($){return console.error("Background status update failed:",$),t(M=>M.map(L=>L.id===T?k:L)),ge.error("Failed to update status"),!1}})().catch($=>{console.error("Background processing error:",$)}),!0},d=async T=>(await Ad(T),t(x=>x.filter(R=>R.id!==T)),!0),u=async(T,x,R)=>{if(!o||!e.find(O=>O.id===T))return!1;const P={assignedTo:x,updatedAt:new Date().toISOString()};try{const O=await Un(T,P);return O?(t(N=>N.map($=>$.id===T?{...$,...P,...O,assignedTo:O.assigned_to}:$)),!0):!1}catch(O){return console.error("[assignToTechnician] Error updating device:",O),!1}},h=async(T,x)=>{if(!o)return!1;const R={id:crypto.randomUUID(),content:x,createdBy:o.id,createdAt:new Date().toISOString()};t(k=>k.map(P=>P.id===T?{...P,remarks:[...P.remarks,R],updatedAt:new Date().toISOString()}:P));try{const{error:k}=await w.from("device_remarks").insert({id:R.id,device_id:T,content:x,created_by:o.id,created_at:R.createdAt});if(k)return console.error("Failed to insert remark into database:",k),!1}catch(k){return console.error("Error inserting remark into database:",k),!1}try{await cs.playRemarkSound()}catch(k){console.warn("Could not play remark sound:",k)}return!0},g=async T=>{const x=e.find(R=>R.id===T);if(x)return x;try{const{data:R,error:k}=await w.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          expected_return_date,
          created_at,
          updated_at,
          estimated_hours,
          warranty_start,
          warranty_end,
          warranty_status,
          repair_count,
          last_return_date
        `).eq("id",T).single();if(k)return console.error("Error fetching device from database:",k),null;if(R){const[P,O,N]=await Promise.all([w.from("device_remarks").select("*").eq("device_id",T).order("created_at",{ascending:!1}),w.from("device_transitions").select("*").eq("device_id",T).order("created_at",{ascending:!1}),w.from("device_ratings").select("*").eq("device_id",T).order("created_at",{ascending:!1})]);return{...R,serialNumber:R.serial_number,issueDescription:R.issue_description,customerId:R.customer_id,assignedTo:R.assigned_to,expectedReturnDate:R.expected_return_date,customerName:"",phoneNumber:"",remarks:(P.data||[]).map(M=>({id:M.id,content:M.content,createdBy:M.created_by,createdAt:M.created_at})),transitions:(O.data||[]).map(M=>({id:M.id,fromStatus:M.from_status,toStatus:M.to_status,performedBy:M.performed_by,timestamp:M.created_at,signature:M.signature||""})),ratings:(N.data||[]).map(M=>({id:M.id,deviceId:M.device_id,technicianId:M.technician_id,score:M.score||5,comment:M.comment,createdAt:M.created_at})),createdAt:R.created_at,updatedAt:R.updated_at}}return null}catch(R){return console.error("Error fetching device from database:",R),null}},p=T=>e.filter(x=>x.status===T),m=T=>(o==null?void 0:o.role)==="technician"&&o.id===T?e:e.filter(x=>x.assignedTo===T),_=async(T,x,R,k)=>{if(!o)return!1;const P={id:`rating-${Date.now()}`,deviceId:T,technicianId:x,score:R,comment:k,createdAt:new Date().toISOString()};return!!await Cd(P)},b=()=>0,S=()=>{const T=new Date,x=T.getFullYear(),R=String(T.getMonth()+1).padStart(2,"0"),k=String(T.getDate()).padStart(2,"0"),P=`${x}-${R}-${k}`;return e.filter(O=>O.expectedReturnDate===P)},v=()=>{const T=new Date;return e.filter(x=>{if(x.status==="done"||x.status==="failed"||!x.expectedReturnDate)return!1;const R=new Date(x.expectedReturnDate),k=new Date(T.getFullYear(),T.getMonth(),T.getDate());if(R.getTime()===k.getTime()){const O=new Date(x.createdAt),N=new Date(T.getTime()-24*60*60*1e3);return O<N}else{const O=new Date(x.createdAt),N=Math.ceil((R.getTime()-O.getTime())/(60*60*1e3)),$=Math.max(N-4,24),M=new Date(O.getTime()+$*60*60*1e3);return T>M}})},C=T=>{if(T.status==="done"||T.status==="failed")return{isOverdue:!1,overdueTime:null,status:"completed"};if(!T.expectedReturnDate)return{isOverdue:!1,overdueTime:null,status:"no-due-date"};const x=new Date,R=new Date(T.expectedReturnDate),k=new Date(x.getFullYear(),x.getMonth(),x.getDate());if(R.getTime()===k.getTime()){const O=new Date(T.createdAt),N=new Date(x.getTime()-24*60*60*1e3);if(O<N){const M=x.getTime()-N.getTime();return{isOverdue:!0,overdueTime:`${Math.floor(M/(1e3*60*60))}h overdue`,status:"overdue"}}else return{isOverdue:!1,overdueTime:null,status:"due-today"}}else{const O=new Date(T.createdAt),N=Math.ceil((R.getTime()-O.getTime())/(60*60*1e3)),$=Math.max(N-4,24),M=new Date(O.getTime()+$*60*60*1e3);if(x>M){const B=x.getTime()-M.getTime(),U=Math.floor(B/(1e3*60*60*24)),W=Math.floor(B%(1e3*60*60*24)/(1e3*60*60));let H="";return U>0?H=`${U}d ${W}h overdue`:H=`${W}h overdue`,{isOverdue:!0,overdueTime:H,status:"overdue"}}else{const B=R.getTime()-x.getTime(),U=Math.floor(B/(1e3*60*60*24)),W=Math.floor(B%(1e3*60*60*24)/(1e3*60*60));let H="";return U>0?H=`${U}d ${W}h remaining`:W>0?H=`${W}h remaining`:H="Due soon",{isOverdue:!1,overdueTime:H,status:"on-time"}}}};return f.jsx(Ic.Provider,{value:{devices:e,loading:r,addDevice:c,updateDeviceStatus:l,assignToTechnician:u,addRemark:h,getDeviceById:g,getDevicesByStatus:p,getDevicesByTechnician:m,addRating:_,getTechnicianRating:b,deleteDevice:d,getDevicesDueToday:S,getOverdueDevices:v,getDeviceOverdueStatus:C},children:s})}),ao=s=>{let e;const t=new Set,r=(d,u)=>{const h=typeof d=="function"?d(e):d;if(!Object.is(h,e)){const g=e;e=u??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(p=>p(e,g))}},a=()=>e,c={setState:r,getState:a,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d)),destroy:()=>{t.clear()}},l=e=s(r,a,c);return c},cg=s=>s?ao(s):ao;var Cc={exports:{}},Dc={},Tc={exports:{}},Rc={};var nr=D;function lg(s,e){return s===e&&(s!==0||1/s===1/e)||s!==s&&e!==e}var ug=typeof Object.is=="function"?Object.is:lg,dg=nr.useState,hg=nr.useEffect,mg=nr.useLayoutEffect,pg=nr.useDebugValue;function fg(s,e){var t=e(),r=dg({inst:{value:t,getSnapshot:e}}),a=r[0].inst,n=r[1];return mg(function(){a.value=t,a.getSnapshot=e,Js(a)&&n({inst:a})},[s,t,e]),hg(function(){return Js(a)&&n({inst:a}),s(function(){Js(a)&&n({inst:a})})},[s]),pg(t),t}function Js(s){var e=s.getSnapshot;s=s.value;try{var t=e();return!ug(s,t)}catch{return!0}}function gg(s,e){return e()}var _g=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?gg:fg;Rc.useSyncExternalStore=nr.useSyncExternalStore!==void 0?nr.useSyncExternalStore:_g;Tc.exports=Rc;var yg=Tc.exports;var Ls=D,bg=yg;function wg(s,e){return s===e&&(s!==0||1/s===1/e)||s!==s&&e!==e}var vg=typeof Object.is=="function"?Object.is:wg,Sg=bg.useSyncExternalStore,Eg=Ls.useRef,xg=Ls.useEffect,Pg=Ls.useMemo,Ag=Ls.useDebugValue;Dc.useSyncExternalStoreWithSelector=function(s,e,t,r,a){var n=Eg(null);if(n.current===null){var o={hasValue:!1,value:null};n.current=o}else o=n.current;n=Pg(function(){function c(g){if(!l){if(l=!0,d=g,g=r(g),a!==void 0&&o.hasValue){var p=o.value;if(a(p,g))return u=p}return u=g}if(p=u,vg(d,g))return p;var m=r(g);return a!==void 0&&a(p,m)?(d=g,p):(d=g,u=m)}var l=!1,d,u,h=t===void 0?null:t;return[function(){return c(e())},h===null?void 0:function(){return c(h())}]},[e,t,r,a]);var i=Sg(s,n[0],n[1]);return xg(function(){o.hasValue=!0,o.value=i},[i]),Ag(i),i};Cc.exports=Dc;var kg=Cc.exports;const Ig=Ao(kg),{useDebugValue:Cg}=er,{useSyncExternalStoreWithSelector:Dg}=Ig;const Tg=s=>s;function Rg(s,e=Tg,t){const r=Dg(s.subscribe,s.getState,s.getServerState||s.getInitialState,e,t);return Cg(r),r}const no=s=>{const e=typeof s=="function"?cg(s):s,t=(r,a)=>Rg(e,r,a);return Object.assign(t,e),t},Oc=s=>s?no(s):no,Ia=new Map,Xr=s=>{const e=Ia.get(s);return e?Object.fromEntries(Object.entries(e.stores).map(([t,r])=>[t,r.getState()])):{}},Og=(s,e,t)=>{if(s===void 0)return{type:"untracked",connection:e.connect(t)};const r=Ia.get(t.name);if(r)return{type:"tracked",store:s,...r};const a={connection:e.connect(t),stores:{}};return Ia.set(t.name,a),{type:"tracked",store:s,...a}},Ng=(s,e={})=>(t,r,a)=>{const{enabled:n,anonymousActionType:o,store:i,...c}=e;let l;try{l=(n??!1)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch{}if(!l)return s(t,r,a);const{connection:d,...u}=Og(i,l,c);let h=!0;a.setState=(m,_,b)=>{const S=t(m,_);if(!h)return S;const v=b===void 0?{type:o||"anonymous"}:typeof b=="string"?{type:b}:b;return i===void 0?(d==null||d.send(v,r()),S):(d==null||d.send({...v,type:`${i}/${v.type}`},{...Xr(c.name),[i]:a.getState()}),S)};const g=(...m)=>{const _=h;h=!1,t(...m),h=_},p=s(a.setState,r,a);if(u.type==="untracked"?d==null||d.init(p):(u.stores[u.store]=a,d==null||d.init(Object.fromEntries(Object.entries(u.stores).map(([m,_])=>[m,m===u.store?p:_.getState()])))),a.dispatchFromDevtools&&typeof a.dispatch=="function"){let m=!1;const _=a.dispatch;a.dispatch=(...b)=>{_(...b)}}return d.subscribe(m=>{var _;switch(m.type){case"ACTION":if(typeof m.payload!="string"){console.error("[zustand devtools middleware] Unsupported action format");return}return Ys(m.payload,b=>{if(b.type==="__setState"){if(i===void 0){g(b.state);return}Object.keys(b.state).length!==1&&console.error(`
                    [zustand devtools middleware] Unsupported __setState action format. 
                    When using 'store' option in devtools(), the 'state' should have only one key, which is a value of 'store' that was passed in devtools(),
                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }
                    `);const S=b.state[i];if(S==null)return;JSON.stringify(a.getState())!==JSON.stringify(S)&&g(S);return}a.dispatchFromDevtools&&typeof a.dispatch=="function"&&a.dispatch(b)});case"DISPATCH":switch(m.payload.type){case"RESET":return g(p),i===void 0?d==null?void 0:d.init(a.getState()):d==null?void 0:d.init(Xr(c.name));case"COMMIT":if(i===void 0){d==null||d.init(a.getState());return}return d==null?void 0:d.init(Xr(c.name));case"ROLLBACK":return Ys(m.state,b=>{if(i===void 0){g(b),d==null||d.init(a.getState());return}g(b[i]),d==null||d.init(Xr(c.name))});case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return Ys(m.state,b=>{if(i===void 0){g(b);return}JSON.stringify(a.getState())!==JSON.stringify(b[i])&&g(b[i])});case"IMPORT_STATE":{const{nextLiftedState:b}=m.payload,S=(_=b.computedStates.slice(-1)[0])==null?void 0:_.state;if(!S)return;g(i===void 0?S:S[i]),d==null||d.send(null,b);return}case"PAUSE_RECORDING":return h=!h}return}}),p},Nc=Ng,Ys=(s,e)=>{let t;try{t=JSON.parse(s)}catch(r){console.error("[zustand devtools middleware] Could not parse the received json",r)}t!==void 0&&e(t)},Lg=s=>(e,t,r)=>{const a=r.subscribe;return r.subscribe=(o,i,c)=>{let l=o;if(i){const d=(c==null?void 0:c.equalityFn)||Object.is;let u=o(r.getState());l=h=>{const g=o(h);if(!d(u,g)){const p=u;i(u=g,p)}},c!=null&&c.fireImmediately&&i(u,u)}return a(l)},s(e,t,r)},Ug=Lg;function jg(s,e){let t;try{t=s()}catch{return}return{getItem:a=>{var n;const o=c=>c===null?null:JSON.parse(c,e==null?void 0:e.reviver),i=(n=t.getItem(a))!=null?n:null;return i instanceof Promise?i.then(o):o(i)},setItem:(a,n)=>t.setItem(a,JSON.stringify(n,e==null?void 0:e.replacer)),removeItem:a=>t.removeItem(a)}}const Ir=s=>e=>{try{const t=s(e);return t instanceof Promise?t:{then(r){return Ir(r)(t)},catch(r){return this}}}catch(t){return{then(r){return this},catch(r){return Ir(r)(t)}}}},$g=(s,e)=>(t,r,a)=>{let n={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:_=>_,version:0,merge:(_,b)=>({...b,..._}),...e},o=!1;const i=new Set,c=new Set;let l;try{l=n.getStorage()}catch{}if(!l)return s((..._)=>{console.warn(`[zustand persist middleware] Unable to update item '${n.name}', the given storage is currently unavailable.`),t(..._)},r,a);const d=Ir(n.serialize),u=()=>{const _=n.partialize({...r()});let b;const S=d({state:_,version:n.version}).then(v=>l.setItem(n.name,v)).catch(v=>{b=v});if(b)throw b;return S},h=a.setState;a.setState=(_,b)=>{h(_,b),u()};const g=s((..._)=>{t(..._),u()},r,a);let p;const m=()=>{var _;if(!l)return;o=!1,i.forEach(S=>S(r()));const b=((_=n.onRehydrateStorage)==null?void 0:_.call(n,r()))||void 0;return Ir(l.getItem.bind(l))(n.name).then(S=>{if(S)return n.deserialize(S)}).then(S=>{if(S)if(typeof S.version=="number"&&S.version!==n.version){if(n.migrate)return n.migrate(S.state,S.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return S.state}).then(S=>{var v;return p=n.merge(S,(v=r())!=null?v:g),t(p,!0),u()}).then(()=>{b==null||b(p,void 0),o=!0,c.forEach(S=>S(p))}).catch(S=>{b==null||b(void 0,S)})};return a.persist={setOptions:_=>{n={...n,..._},_.getStorage&&(l=_.getStorage())},clearStorage:()=>{l==null||l.removeItem(n.name)},getOptions:()=>n,rehydrate:()=>m(),hasHydrated:()=>o,onHydrate:_=>(i.add(_),()=>{i.delete(_)}),onFinishHydration:_=>(c.add(_),()=>{c.delete(_)})},m(),p||g},Mg=(s,e)=>(t,r,a)=>{let n={storage:jg(()=>localStorage),partialize:m=>m,version:0,merge:(m,_)=>({..._,...m}),...e},o=!1;const i=new Set,c=new Set;let l=n.storage;if(!l)return s((...m)=>{console.warn(`[zustand persist middleware] Unable to update item '${n.name}', the given storage is currently unavailable.`),t(...m)},r,a);const d=()=>{const m=n.partialize({...r()});return l.setItem(n.name,{state:m,version:n.version})},u=a.setState;a.setState=(m,_)=>{u(m,_),d()};const h=s((...m)=>{t(...m),d()},r,a);a.getInitialState=()=>h;let g;const p=()=>{var m,_;if(!l)return;o=!1,i.forEach(S=>{var v;return S((v=r())!=null?v:h)});const b=((_=n.onRehydrateStorage)==null?void 0:_.call(n,(m=r())!=null?m:h))||void 0;return Ir(l.getItem.bind(l))(n.name).then(S=>{if(S)if(typeof S.version=="number"&&S.version!==n.version){if(n.migrate)return[!0,n.migrate(S.state,S.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,S.state];return[!1,void 0]}).then(S=>{var v;const[C,T]=S;if(g=n.merge(T,(v=r())!=null?v:h),t(g,!0),C)return d()}).then(()=>{b==null||b(g,void 0),g=r(),o=!0,c.forEach(S=>S(g))}).catch(S=>{b==null||b(void 0,S)})};return a.persist={setOptions:m=>{n={...n,...m},m.storage&&(l=m.storage)},clearStorage:()=>{l==null||l.removeItem(n.name)},getOptions:()=>n,rehydrate:()=>p(),hasHydrated:()=>o,onHydrate:m=>(i.add(m),()=>{i.delete(m)}),onFinishHydration:m=>(c.add(m),()=>{c.delete(m)})},n.skipHydration||p(),g||h},qg=(s,e)=>"getStorage"in e||"serialize"in e||"deserialize"in e?$g(s,e):Mg(s,e),Bg=qg,Oe=()=>({timestamp:Date.now(),isStale:!1,lastUpdated:new Date().toISOString()}),Ut=Oc()(Nc(Bg((s,e)=>({customers:[],products:[],categories:[],suppliers:[],branches:[],users:[],devices:[],sales:[],settings:null,adminSettings:[],parentVariants:[],childVariants:[],employees:[],paymentMethods:[],paymentAccounts:[],attendanceRecords:[],purchaseOrders:[],stockMovements:[],cache:{customers:Oe(),products:Oe(),categories:Oe(),suppliers:Oe(),branches:Oe(),users:Oe(),devices:Oe(),sales:Oe(),settings:Oe(),adminSettings:Oe(),parentVariants:Oe(),childVariants:Oe(),employees:Oe(),paymentMethods:Oe(),paymentAccounts:Oe(),attendanceRecords:Oe(),purchaseOrders:Oe(),stockMovements:Oe()},isPreloading:!1,preloadProgress:0,preloadStatus:"Not started",isLoaded:!1,errors:{},CACHE_DURATION:15*60*1e3,PRELOAD_BATCH_SIZE:100,setCustomers:t=>{s({customers:t}),e().updateCacheTimestamp("customers")},setProducts:t=>{s({products:t}),e().updateCacheTimestamp("products")},setCategories:t=>{s({categories:t}),e().updateCacheTimestamp("categories")},setSuppliers:t=>{s({suppliers:t}),e().updateCacheTimestamp("suppliers")},setBranches:t=>{s({branches:t}),e().updateCacheTimestamp("branches")},setUsers:t=>{s({users:t}),e().updateCacheTimestamp("users")},setDevices:t=>{s({devices:t}),e().updateCacheTimestamp("devices")},setSales:t=>{s({sales:t}),e().updateCacheTimestamp("sales")},setSettings:t=>{s({settings:t}),e().updateCacheTimestamp("settings")},setAdminSettings:t=>{s({adminSettings:t}),e().updateCacheTimestamp("adminSettings")},setParentVariants:t=>{s({parentVariants:t}),e().updateCacheTimestamp("parentVariants")},setChildVariants:t=>{s({childVariants:t}),e().updateCacheTimestamp("childVariants")},setEmployees:t=>{s({employees:t}),e().updateCacheTimestamp("employees")},setPaymentMethods:t=>{s({paymentMethods:t}),e().updateCacheTimestamp("paymentMethods")},setPaymentAccounts:t=>{s({paymentAccounts:t}),e().updateCacheTimestamp("paymentAccounts")},setAttendanceRecords:t=>{s({attendanceRecords:t}),e().updateCacheTimestamp("attendanceRecords")},setPurchaseOrders:t=>{s({purchaseOrders:t}),e().updateCacheTimestamp("purchaseOrders")},setStockMovements:t=>{s({stockMovements:t}),e().updateCacheTimestamp("stockMovements")},setPreloadProgress:(t,r)=>{s({preloadProgress:t,preloadStatus:r})},setPreloading:t=>{s({isPreloading:t})},markAsLoaded:()=>{s({isLoaded:!0,isPreloading:!1,preloadProgress:100})},isCacheValid:t=>{const r=e(),a=r.cache[t];return!a||a.isStale?!1:Date.now()-a.timestamp<r.CACHE_DURATION},invalidateCache:t=>{s(r=>({cache:{...r.cache,[t]:{...r.cache[t],isStale:!0}}}))},invalidateAllCache:()=>{const r={...e().cache};Object.keys(r).forEach(a=>{r[a]={...r[a],isStale:!0}}),s({cache:r})},updateCacheTimestamp:t=>{s(r=>({cache:{...r.cache,[t]:{timestamp:Date.now(),isStale:!1,lastUpdated:new Date().toISOString()}}}))},setError:(t,r)=>{s(a=>({errors:{...a.errors,[t]:r}}))},clearError:t=>{s(r=>{const a={...r.errors};return delete a[t],{errors:a}})},clearAllErrors:()=>{s({errors:{}})},getCustomers:()=>{const t=e();return t.isCacheValid("customers")||console.warn(" Customers cache is stale"),t.customers},getProducts:()=>{const t=e();return t.isCacheValid("products")||console.warn(" Products cache is stale"),t.products},getCategories:()=>{const t=e();return t.isCacheValid("categories")||console.warn(" Categories cache is stale"),t.categories},getSuppliers:()=>{const t=e();return t.isCacheValid("suppliers")||console.warn(" Suppliers cache is stale"),t.suppliers},getBranches:()=>{const t=e();return t.isCacheValid("branches")||console.warn(" Branches cache is stale"),t.branches},getParentVariants:()=>{const t=e();return t.isCacheValid("parentVariants")||console.warn(" Parent variants cache is stale"),t.parentVariants},getChildVariants:()=>{const t=e();return t.isCacheValid("childVariants")||console.warn(" Child variants cache is stale"),t.childVariants},getEmployees:()=>{const t=e();return t.isCacheValid("employees")||console.warn(" Employees cache is stale"),t.employees},getPaymentMethods:()=>{const t=e();return t.isCacheValid("paymentMethods")||console.warn(" Payment methods cache is stale"),t.paymentMethods},getAttendanceRecords:()=>{const t=e();return t.isCacheValid("attendanceRecords")||console.warn(" Attendance records cache is stale"),t.attendanceRecords},clearAllData:()=>{s({customers:[],products:[],categories:[],suppliers:[],branches:[],users:[],devices:[],sales:[],settings:null,adminSettings:[],parentVariants:[],childVariants:[],employees:[],paymentMethods:[],paymentAccounts:[],attendanceRecords:[],purchaseOrders:[],stockMovements:[],isLoaded:!1,preloadProgress:0,preloadStatus:"Not started",errors:{}}),e().invalidateAllCache()},getPreloadSummary:()=>{var r,a,n,o,i,c,l,d,u,h,g,p,m;const t=e();return{isLoaded:t.isLoaded,progress:t.preloadProgress,status:t.preloadStatus,dataCounts:{customers:((r=t.customers)==null?void 0:r.length)||0,products:((a=t.products)==null?void 0:a.length)||0,categories:((n=t.categories)==null?void 0:n.length)||0,suppliers:((o=t.suppliers)==null?void 0:o.length)||0,branches:((i=t.branches)==null?void 0:i.length)||0,users:((c=t.users)==null?void 0:c.length)||0,devices:((l=t.devices)==null?void 0:l.length)||0,sales:((d=t.sales)==null?void 0:d.length)||0,parentVariants:((u=t.parentVariants)==null?void 0:u.length)||0,childVariants:((h=t.childVariants)==null?void 0:h.length)||0,employees:((g=t.employees)==null?void 0:g.length)||0,paymentMethods:((p=t.paymentMethods)==null?void 0:p.length)||0,attendanceRecords:((m=t.attendanceRecords)==null?void 0:m.length)||0},cacheStatus:Object.keys(t.cache).map(_=>({dataType:_,valid:t.isCacheValid(_),age:Date.now()-t.cache[_].timestamp,lastUpdated:t.cache[_].lastUpdated})),errors:t.errors}}}),{name:"app-data-cache",partialize:s=>({cache:s.cache,isLoaded:s.isLoaded})}),{name:"DataStore"})),$0=()=>Ut(s=>s.products),M0=()=>Ut(s=>s.employees),q0=()=>Ut(s=>s.paymentMethods),B0=()=>Ut(s=>s.paymentAccounts),Fg=()=>Ut(s=>({isPreloading:s.isPreloading,progress:s.preloadProgress,status:s.preloadStatus,isLoaded:s.isLoaded})),qt=new Map,zg=5*60*1e3;function Vg(s={}){const{autoFetch:e=!0,simple:t=!1,light:r=!1,cacheKey:a="default"}=s,n=Ut(),[o,i]=D.useState([]),[c,l]=D.useState(!1),[d,u]=D.useState(null),[h,g]=D.useState({online:navigator.onLine,quality:"unknown",message:"Checking connection..."}),p=D.useRef(!0),m=D.useRef(null);D.useEffect(()=>{const v=()=>{const R=Bd();g({online:navigator.onLine,quality:R.quality,message:R.message})};v();const C=()=>v(),T=()=>v();window.addEventListener("online",C),window.addEventListener("offline",T);const x=setInterval(v,3e4);return()=>{window.removeEventListener("online",C),window.removeEventListener("offline",T),clearInterval(x)}},[]),D.useEffect(()=>(p.current=!0,()=>{p.current=!1,m.current&&m.current.abort()}),[]);const _=async(v=!1)=>{if(!p.current)return;const C=`${a}_${r?"light":t?"simple":"full"}`;if(!v&&n.customers.length>0){console.log(" Using preloaded customers data"),i(n.customers),l(!1),u(null),qt.set(C,{data:n.customers,timestamp:Date.now()});return}if(!v){const x=qt.get(C);if(x&&Date.now()-x.timestamp<zg){i(x.data),l(!1),u(null);return}if(x!=null&&x.promise){l(!0);try{const R=await x.promise;p.current&&(i(R),l(!1),u(null))}catch(R){p.current&&(u(R instanceof Error?R.message:"Failed to fetch customers"),l(!1))}return}}const T=async()=>Vi(async()=>{let x;try{l(!0),u(null),m.current=new AbortController,x=setTimeout(()=>{m.current&&m.current.abort()},12e4);const R=r?Vd():t?Gd():Fd();qt.set(C,{data:[],timestamp:Date.now(),promise:R});const k=await R;return x&&clearTimeout(x),qt.set(C,{data:k,timestamp:Date.now()}),p.current&&(i(k),l(!1),u(null)),k}catch(R){x&&clearTimeout(x);const k=R instanceof Error?R.message:"Failed to fetch customers";if((k.includes("503")||k.includes("Service Unavailable"))&&retryCount<maxRetries){const P=baseDelay*Math.pow(2,retryCount);return p.current&&u(`Database temporarily unavailable. Retrying in ${Math.round(P/1e3)} seconds...`),await new Promise(O=>setTimeout(O,P)),T(retryCount+1)}throw p.current&&(console.error(" Error fetching customers:",k),(k.includes("QUIC_PROTOCOL_ERROR")||k.includes("net::ERR_QUIC_PROTOCOL_ERROR"))&&(console.error(" QUIC Protocol Error detected. This may be due to:"),console.error("   - Network instability or poor connection quality"),console.error("   - Firewall or proxy interference"),console.error("   - Browser network stack issues"),console.error("   - Supabase server connectivity problems"),console.error("   - DNS resolution issues")),(k.includes("timeout")||k.includes("Request timeout"))&&(console.error(" Request timeout detected. This may be due to:"),console.error("   - Slow network connection"),console.error("   - Large dataset being fetched"),console.error("   - Server overload"),console.error("   - Network congestion")),k.includes("503")||k.includes("Service Unavailable")?(console.error(" 503 Service Unavailable detected. This indicates:"),console.error("   - Supabase service is temporarily down"),console.error("   - Database maintenance in progress"),console.error("   - Service quota exceeded"),console.error("   - Network connectivity issues"),u("Database service is temporarily unavailable. Please try again in a few minutes.")):u(k),l(!1)),qt.delete(C),R}finally{x&&clearTimeout(x),m.current=null}});try{await T()}catch{}},b=async()=>{await _(!0)},S=()=>{qt.clear(),Kd()};return D.useEffect(()=>{e&&_()},[e,t,r,a]),{customers:o,loading:c,error:d,refetch:b,clearCache:S,networkStatus:h}}const Lc=D.createContext(void 0),Gg=()=>{const s=D.useContext(Lc);if(!s)throw new Error("useCustomers must be used within a CustomersProvider");return s};function Wg(s){return!s||!s.id||!s.notes?0:s.notes.filter(e=>e.content&&e.content.toLowerCase().includes("checked in")).length}function Hg(s){return s?s.some(e=>e.content&&(e.content.toLowerCase().includes("complaint")||e.content.toLowerCase().includes("complain"))):!1}const Qg=({children:s})=>{const e=D.useContext(Nr),t=(e==null?void 0:e.currentUser)||null,{customers:r,loading:a,error:n,refetch:o,clearCache:i}=Vg({light:!0,autoFetch:!!t,cacheKey:"customers-context"}),c=async()=>{await o()},l=async S=>{var v;try{console.log(" CustomersContext.addCustomer: Starting customer creation..."),console.log(" Customer data received:",{name:S.name,phone:S.phone,email:S.email,gender:S.gender,city:S.city,hasNotes:!!S.notes});const C=t||{id:"system",email:"system@neon.direct",user_metadata:{name:"System User"}};t?console.log(" User authenticated:",t.id):console.warn(" No authenticated user, using system user for customer creation");const T=crypto.randomUUID(),x=new Date().toISOString();console.log(" Generated customer ID:",T);const R={id:T,name:S.name,email:S.email||"",phone:S.phone,gender:S.gender||"other",city:S.city||"",joinedDate:x,loyaltyLevel:"interested",colorTag:"new",referredBy:S.referredBy||void 0,referrals:[],totalSpent:0,points:0,lastVisit:x,isActive:!0,referralSource:S.referralSource||void 0,birthMonth:S.birthMonth||void 0,birthDay:S.birthDay||void 0,initialNotes:typeof S.notes=="string"?S.notes:"",notes:[],promoHistory:[],payments:[],devices:[],createdBy:C.id};console.log(" Prepared customer object for database:",{id:R.id,name:R.name,phone:R.phone,loyaltyLevel:R.loyaltyLevel,colorTag:R.colorTag,points:R.points}),console.log(" Calling addCustomerToDb...");const k=await Qd(R);if(!k)throw console.error(" CustomersContext.addCustomer: addCustomerToDb returned null/undefined"),new Error("Failed to add customer to database - no data returned");console.log(" Customer added to database successfully:",k.id);try{console.log(" Adding welcome note...");const P="Welcome! 10 points awarded for new customer registration.",O={id:crypto.randomUUID(),note:P,created_by:C.id,created_at:new Date().toISOString(),customer_id:T},{data:N,error:$}=await w.from("customer_notes").insert(O);$?console.error("  Failed to add welcome note:",{error:$.message,code:$.code,details:$.details,hint:$.hint}):console.log(" Welcome note added successfully")}catch(P){console.error("  Exception while adding welcome note:",{message:P==null?void 0:P.message,stack:P==null?void 0:P.stack})}return console.log(" CustomersContext.addCustomer: Customer creation completed successfully!"),{...k,notes:k.notes||[],promoHistory:k.promoHistory||[],payments:k.payments||[],devices:k.devices||[]}}catch(C){throw console.error(""),console.error(" CUSTOMER CREATION FAILED"),console.error(""),console.error("Error Type:",((v=C==null?void 0:C.constructor)==null?void 0:v.name)||"Unknown"),console.error("Error Message:",(C==null?void 0:C.message)||"No message"),console.error("Error Code:",(C==null?void 0:C.code)||"No code"),console.error("Error Details:",(C==null?void 0:C.details)||"No details"),console.error("Error Hint:",(C==null?void 0:C.hint)||"No hint"),console.error("Full Error Object:",C),console.error("Stack Trace:",(C==null?void 0:C.stack)||"No stack trace"),console.error(""),C}},d=async(S,v)=>{try{console.log(" CustomersContext: Starting customer update for ID:",S),console.log(" CustomersContext: Updates received:",v);const C=t||{id:"system",email:"system@neon.direct",user_metadata:{name:"System User"}};t||console.warn(" No authenticated user, using system user for customer update");const T=r.find(U=>U.id===S);let x=(T==null?void 0:T.colorTag)||"new",R=(T==null?void 0:T.isActive)??!0;const k=v.notes||(T==null?void 0:T.notes)||[];Hg(k)?x="complainer":Wg({...T,...v,notes:k,id:S})>=10?x="vip":x="new";const P=v.lastVisit||(T==null?void 0:T.lastVisit);if(P){const U=new Date(P).getTime();Date.now()-U>365*24*60*60*1e3?R=!1:R=!0}const O={...v,colorTag:x,isActive:R};console.log(" CustomersContext: Final update data:",O);const N=await _a(S,O);if(!N)return!1;const $=Date.now(),M=new Date(N.lastVisit).getTime(),L=$-M<90*24*60*60*1e3;let B=N;if(N.isActive!==L){const U=await _a(S,{isActive:L});B=U?{...U,notes:U.notes||[],promoHistory:U.promoHistory||[],payments:U.payments||[],devices:U.devices||[]}:{...N,notes:N.notes||[],promoHistory:N.promoHistory||[],payments:N.payments||[],devices:N.devices||[]}}else B={...N,notes:N.notes||[],promoHistory:N.promoHistory||[],payments:N.payments||[],devices:N.devices||[]};return!0}catch(C){return console.error("Error updating customer:",C),!1}},u=async S=>{try{const v=t||{id:"system",email:"system@neon.direct",user_metadata:{name:"System User"}};return console.log("markCustomerAsRead called but not implemented (no is_read column in schema)"),!0}catch(v){return console.error("Error marking customer as read:",v),!1}},h=async(S,v)=>{const C=t||{id:"system",email:"system@neon.direct",user_metadata:{name:"System User"}},T={id:`note-${Date.now()}`,content:v,createdBy:C.id,createdAt:new Date().toISOString()};return!!await kd(T,S)},g=async(S,v)=>{const C={...v,id:`promo-${Date.now()}`,sentAt:new Date().toISOString(),status:"sent"};return!!await Id(C,S)},p=(S,v,C)=>(h(S,`Added ${v} points - ${C}`),!0),m=S=>r.find(v=>v.id===S),_=S=>r.filter(v=>v.loyaltyLevel===S),b=S=>{const v=new Date;return v.setDate(v.getDate()-S),r.filter(C=>new Date(C.lastVisit)<v)};return f.jsx(Lc.Provider,{value:{customers:r,loading:a,error:n,refreshCustomers:c,addCustomer:l,updateCustomer:d,markCustomerAsRead:u,addNote:h,sendPromo:g,addPoints:p,getCustomerById:m,getCustomersByLoyalty:_,getInactiveCustomers:b,clearCache:i},children:s})};async function oo(s){var e,t;try{const r=new Date().toISOString().split("T")[0],{data:a,error:n}=await w.from("user_daily_goals").select("*").eq("user_id",s).eq("date",r).eq("is_active",!0).order("goal_type");return n?n.code==="42P01"||(e=n.message)!=null&&e.includes("does not exist")?(console.warn("user_daily_goals table does not exist yet"),[]):n.code==="406"||(t=n.message)!=null&&t.includes("Not Acceptable")?(console.warn("RLS policy issue with user_daily_goals table, returning empty array"),[]):(console.error("Error fetching user daily goals:",n),[]):a||[]}catch(r){return console.error("Unexpected error fetching user daily goals:",r),[]}}async function Kg(s,e){var t,r;try{const a=new Date().toISOString().split("T")[0],{data:n,error:o}=await w.from("user_daily_goals").select("*").eq("user_id",s).eq("goal_type",e).eq("date",a).eq("is_active",!0).single();return o?o.code==="42P01"||(t=o.message)!=null&&t.includes("does not exist")?(console.warn("user_daily_goals table does not exist yet"),null):o.code==="PGRST116"?null:o.code==="406"||(r=o.message)!=null&&r.includes("Not Acceptable")?(console.warn("RLS policy issue with user_daily_goals table, returning null"),null):(console.error("Error fetching user daily goal:",o),null):n}catch(a){return console.error("Unexpected error fetching user daily goal:",a),null}}async function Uc(s){try{const e=s.date||new Date().toISOString().split("T")[0],{data:t}=await w.from("user_daily_goals").select("*").eq("user_id",s.user_id).eq("goal_type",s.goal_type).eq("date",e).eq("is_active",!0).single();if(t){const{data:o,error:i}=await w.from("user_daily_goals").update({goal_value:s.goal_value}).eq("id",t.id).select().single();return i?(console.error("Error updating existing user daily goal:",i),null):o}const r={...s,date:s.date||new Date().toISOString().split("T")[0]},{data:a,error:n}=await w.from("user_daily_goals").insert(r).select().single();return n?(console.error("Error creating user daily goal:",n),null):a}catch(e){return console.error("Unexpected error creating user daily goal:",e),null}}async function Jg(s,e){try{const{data:t,error:r}=await w.from("user_daily_goals").update(e).eq("id",s).select().single();return r?(console.error("Error updating user daily goal:",r),null):t}catch(t){return console.error("Unexpected error updating user daily goal:",t),null}}async function Yg(s){try{const{error:e}=await w.from("user_daily_goals").update({is_active:!1}).eq("id",s);return e?(console.error("Error deleting user daily goal:",e),!1):!0}catch(e){return console.error("Unexpected error deleting user daily goal:",e),!1}}async function Xg(s,e){try{const t=await oo(s);if(t.length>0)return t;const r=[];e==="customer-care"?r.push({user_id:s,goal_type:"new_customers",goal_value:5},{user_id:s,goal_type:"checkins",goal_value:10}):e==="technician"?r.push({user_id:s,goal_type:"devices_processed",goal_value:8},{user_id:s,goal_type:"repairs_completed",goal_value:6}):r.push({user_id:s,goal_type:"new_customers",goal_value:3},{user_id:s,goal_type:"devices_processed",goal_value:5});const a=[];for(const n of r)try{const o=await Uc(n);o&&a.push(o)}catch(o){console.warn("Error creating goal:",o)}return a.length===0?await oo(s):a}catch(t){return console.error("Error getting or creating default goals:",t),[]}}async function Zg(s,e,t){try{const r=await Kg(s,e);if(!r)return{current:0,goal:5,progress:0};const a=new Date().toISOString().slice(0,10);let n=0;try{switch(e){case"new_customers":const{count:i}=await w.from("customers").select("id",{count:"exact",head:!0}).gte("created_at",`${a}T00:00:00`).lt("created_at",`${a}T23:59:59`);n=i||0;break;case"devices_processed":if(!s){n=0;break}const{count:c}=await w.from("devices").select("id",{count:"exact",head:!0}).eq("assigned_to",s).gte("created_at",`${a}T00:00:00`).lt("created_at",`${a}T23:59:59`);n=c||0;break;case"checkins":const{count:l}=await w.from("customer_checkins").select("id",{count:"exact",head:!0}).eq("staff_id",s).gte("checkin_at",a);n=l||0;break;case"repairs_completed":if(!s){n=0;break}const{count:d}=await w.from("devices").select("id",{count:"exact",head:!0}).eq("assigned_to",s).eq("status","done").gte("updated_at",`${a}T00:00:00`).lt("updated_at",`${a}T23:59:59`);n=d||0;break}}catch(i){console.error("Error calculating progress:",i),n=0}const o=Math.min(100,Math.round(n/r.goal_value*100));return{current:n,goal:r.goal_value,progress:o}}catch(r){return console.error("Error getting user goal progress:",r),{current:0,goal:5,progress:0}}}const e_=D.createContext(void 0),t_=({children:s})=>{const[e,t]=D.useState([]),[r,a]=D.useState(!0),[n,o]=D.useState(null),[i,c]=D.useState(null),l=D.useContext(Nr),d=(l==null?void 0:l.currentUser)||null,u=D.useCallback(async()=>{var S,v;try{const{data:C,error:T}=await w.from("user_daily_goals").select("id").limit(1);if(T){if(T.code==="42P01"||(S=T.message)!=null&&S.includes("does not exist"))return console.warn("user_daily_goals table does not exist"),c(!1),!1;if(T.code==="406"||(v=T.message)!=null&&v.includes("Not Acceptable"))return console.warn("RLS policy issue with user_daily_goals table"),c(!1),!1}return c(!0),!0}catch(C){return console.error("Error checking if user_daily_goals table exists:",C),c(!1),!1}},[]),h=D.useCallback(async()=>{if(!(d!=null&&d.id)){t([]),a(!1);return}try{if(a(!0),o(null),!await u()){console.log("user_daily_goals table not available, skipping goals loading"),t([]),a(!1);return}const v=await Xg(d.id,d.role);t(v)}catch(S){console.error("Error refreshing user goals:",S),o("Failed to load user goals"),t([])}finally{a(!1)}},[d==null?void 0:d.id,d==null?void 0:d.role,u]),g=D.useCallback(async S=>{if(!(d!=null&&d.id)||!i)return{current:0,goal:5,progress:0};try{return await Zg(d.id,S,d)}catch(v){return console.error("Error getting goal progress:",v),{current:0,goal:5,progress:0}}},[d==null?void 0:d.id,d,i]),p=D.useCallback(async(S,v)=>{if(!i)return console.warn("Cannot update goal: user_daily_goals table not available"),!1;try{const C=await Jg(S,v);return C?(t(T=>T.map(x=>x.id===S?C:x)),!0):!1}catch(C){return console.error("Error updating goal:",C),!1}},[i]),m=D.useCallback(async S=>{if(!(d!=null&&d.id)||!i)return!1;try{const v=await Uc({user_id:d.id,...S});return v?(t(C=>[...C,v]),!0):!1}catch(v){return console.error("Error creating goal:",v),!1}},[d==null?void 0:d.id,i]),_=D.useCallback(async S=>{if(!i)return console.warn("Cannot delete goal: user_daily_goals table not available"),!1;try{return await Yg(S)?(t(C=>C.filter(T=>T.id!==S)),!0):!1}catch(v){return console.error("Error deleting goal:",v),!1}},[i]);D.useEffect(()=>{h()},[h]);const b={userGoals:e,loading:r,error:n,refreshGoals:h,getGoalProgress:g,updateGoal:p,createGoal:m,deleteGoal:_};return f.jsx(e_.Provider,{value:b,children:s})};class r_{constructor(){this.cache=new Map,this.pendingRequests=new Map,this.DEFAULT_CACHE_TIME=5e3}async query(e,t,r=this.DEFAULT_CACHE_TIME){const a=this.cache.get(e);if(a&&Date.now()-a.timestamp<r)return a.data;const n=this.pendingRequests.get(e);if(n)return n;const o=t().then(i=>(this.cache.set(e,{data:i,timestamp:Date.now()}),this.pendingRequests.delete(e),i)).catch(i=>{throw this.pendingRequests.delete(e),i});return this.pendingRequests.set(e,o),o}clearCache(e){e?this.cache.delete(e):this.cache.clear()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheKeys:Array.from(this.cache.keys())}}cleanupExpiredCache(e=6e4){const t=Date.now();for(const[r,a]of this.cache.entries())t-a.timestamp>e&&this.cache.delete(r)}}const un=new r_;async function wt(s,e,t){return un.query(s,e,t)}typeof window<"u"&&setInterval(()=>{un.cleanupExpiredCache()},6e4);async function s_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("products",e);let r;t==="isolated"?r=w.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("lats_products").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("lats_products").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("lats_products").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} products visible (only from this branch). Database has ${o} products from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No products found for this branch yet. Database has ${o} products from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} products visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total products visible (${c.currentBranch} from this branch, ${c.otherBranches} from others)`),{feature:"Products",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Products",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing products: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function a_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("customers",e);let r;t==="isolated"?r=w.from("customers").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("customers").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("customers").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("customers").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("customers").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} customers visible (only from this branch). Database has ${o} customers from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No customers found for this branch yet. Database has ${o} customers from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} customers visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total customers visible`),{feature:"Customers",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Customers",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing customers: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function n_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("inventory",e);let r;t==="isolated"?r=w.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",s).gt("stock_quantity",0):r=w.from("lats_products").select("*",{count:"exact",head:!0}).gt("stock_quantity",0);const{count:a}=await r,{count:n}=await w.from("lats_products").select("*",{count:"exact",head:!0}).eq("branch_id",s).gt("stock_quantity",0),{count:o}=await w.from("lats_products").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null).gt("stock_quantity",0),{count:i}=await w.from("lats_products").select("*",{count:"exact",head:!0}).gt("stock_quantity",0),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} inventory items visible (only from this branch). Database has ${o} items from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No inventory found for this branch yet. Database has ${o} items from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} inventory items visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total inventory items visible`),{feature:"Inventory",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Inventory",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing inventory: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function o_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("suppliers",e);let r;t==="isolated"?r=w.from("lats_suppliers").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("lats_suppliers").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("lats_suppliers").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("lats_suppliers").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("lats_suppliers").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} suppliers visible (only from this branch). Database has ${o} suppliers from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No suppliers found for this branch yet. Database has ${o} suppliers from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} suppliers visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total suppliers visible`),{feature:"Suppliers",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Suppliers",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing suppliers: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function i_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("categories",e);let r;t==="isolated"?r=w.from("lats_categories").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("lats_categories").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("lats_categories").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("lats_categories").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("lats_categories").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} categories visible (only from this branch). Database has ${o} categories from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No categories found for this branch yet. Database has ${o} categories from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} categories visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total categories visible`),{feature:"Categories",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Categories",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing categories: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function c_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("gift_cards",e);let r;t==="isolated"?r=w.from("gift_cards").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("gift_cards").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("gift_cards").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("gift_cards").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("gift_cards").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} gift cards visible (only from this branch). Database has ${o} gift cards from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No gift cards found for this branch yet. Database has ${o} gift cards from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} gift cards visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total gift cards visible`),{feature:"Gift Cards",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Gift Cards",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing gift cards: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function l_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("quality_checks",e);let r;t==="isolated"?r=w.from("quality_checks").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("quality_checks").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("quality_checks").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("quality_checks").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("quality_checks").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} quality checks visible (only from this branch). Database has ${o} quality checks from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No quality checks found for this branch yet. Database has ${o} quality checks from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} quality checks visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total quality checks visible`),{feature:"Quality Checks",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Quality Checks",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing quality checks: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function u_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("recurring_expenses",e);let r;t==="isolated"?r=w.from("recurring_expenses").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("recurring_expenses").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("recurring_expenses").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("recurring_expenses").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("recurring_expenses").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} recurring expenses visible (only from this branch). Database has ${o} recurring expenses from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No recurring expenses found for this branch yet. Database has ${o} recurring expenses from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} recurring expenses visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total recurring expenses visible`),{feature:"Recurring Expenses",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Recurring Expenses",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing recurring expenses: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function d_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("communications",e);let r;t==="isolated"?r=w.from("sms_logs").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("sms_logs").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("sms_logs").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("sms_logs").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("sms_logs").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} communications visible (only from this branch). Database has ${o} communications from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No communications found for this branch yet. Database has ${o} communications from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} communications visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total communications visible`),{feature:"Communications",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Communications",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing communications: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function h_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("reports",e);let r;t==="isolated"?r=w.from("daily_reports").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("daily_reports").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("daily_reports").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("daily_reports").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("daily_reports").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} reports visible (only from this branch). Database has ${o} reports from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No reports found for this branch yet. Database has ${o} reports from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} reports visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total reports visible`),{feature:"Reports",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Reports",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing reports: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function m_(s){try{const e=await Te(s);if(!e)throw new Error("Branch not found");const t=rt("finance_transfers",e);let r;t==="isolated"?r=w.from("finance_transfers").select("*",{count:"exact",head:!0}).eq("branch_id",s):r=w.from("finance_transfers").select("*",{count:"exact",head:!0});const{count:a}=await r,{count:n}=await w.from("finance_transfers").select("*",{count:"exact",head:!0}).eq("branch_id",s),{count:o}=await w.from("finance_transfers").select("*",{count:"exact",head:!0}).neq("branch_id",s).not("branch_id","is",null),{count:i}=await w.from("finance_transfers").select("*",{count:"exact",head:!0}),c={currentBranch:n||0,otherBranches:o||0,shared:0,total:i||0};let l="unknown",d=!0,u="";return t==="isolated"?a===n&&n>0?(l="isolated",d=!0,u=` Isolation working: ${a} finance transfers visible (only from this branch). Database has ${o} transfers from other branches (correctly hidden)`):a===0&&n===0?(l="isolated",d=!0,u=` No finance transfers found for this branch yet. Database has ${o} transfers from other branches (correctly hidden)`):(l="shared",d=!1,u=` Isolation FAILED: ${a} finance transfers visible but should only be ${n}`):(l="shared",d=!0,u=` Sharing working: ${a} total finance transfers visible`),{feature:"Finance Transfers",passed:d,expected:t,actual:l,details:u,dataCount:c,timestamp:new Date().toISOString()}}catch(e){return{feature:"Finance Transfers",passed:!1,expected:"unknown",actual:"unknown",details:` Error testing finance transfers: ${e.message}`,dataCount:{currentBranch:0,otherBranches:0,shared:0,total:0},timestamp:new Date().toISOString()}}}async function p_(s){const e=s||Ue();if(!e)throw new Error("No branch selected. Please select a branch first.");const t=await Te(e);if(!t)throw new Error("Branch not found");const r=[],a=await s_(e);r.push(a);const n=await a_(e);r.push(n);const o=await n_(e);r.push(o);const i=await o_(e);r.push(i);const c=await i_(e);r.push(c);const l=await c_(e);r.push(l);const d=await l_(e);r.push(d);const u=await u_(e);r.push(u);const h=await d_(e);r.push(h);const g=await h_(e);r.push(g);const p=await m_(e);r.push(p);const m=r.filter(S=>S.passed).length,_=r.filter(S=>!S.passed).length,b=r.filter(S=>S.details.includes("")).length;return{branchId:e,branchName:t.name,isolationMode:t.data_isolation_mode,settings:{share_products:t.share_products,share_customers:t.share_customers,share_inventory:t.share_inventory,share_suppliers:t.share_suppliers,share_categories:t.share_categories,share_employees:t.share_employees,share_payments:t.share_payments,share_accounts:t.share_accounts,share_gift_cards:t.share_gift_cards,share_quality_checks:t.share_quality_checks,share_recurring_expenses:t.share_recurring_expenses,share_communications:t.share_communications,share_reports:t.share_reports,share_finance_transfers:t.share_finance_transfers},testResults:r,summary:{totalTests:r.length,passed:m,failed:_,warnings:b}}}function rt(s,e){return e.data_isolation_mode==="shared"?"shared":e.data_isolation_mode==="isolated"?"isolated":{products:e.share_products,customers:e.share_customers,inventory:e.share_inventory,suppliers:e.share_suppliers,categories:e.share_categories,employees:e.share_employees,gift_cards:e.share_gift_cards,quality_checks:e.share_quality_checks,recurring_expenses:e.share_recurring_expenses,communications:e.share_communications,reports:e.share_reports,finance_transfers:e.share_finance_transfers}[s]?"shared":"isolated"}function f_(){localStorage.setItem("branch_isolation_debug","true")}function g_(){localStorage.removeItem("branch_isolation_debug")}function __(){return localStorage.getItem("branch_isolation_debug")==="true"}function Bt(s,e,t,r){__()}async function y_(){try{return await p_()}catch(s){throw console.error(" Test failed:",s.message),s}}typeof window<"u"&&(window.testBranchIsolation=y_,window.enableBranchDebug=f_,window.disableBranchDebug=g_);const F0={country:"Tanzania",is_main:!1,is_active:!0,opening_time:"09:00:00",closing_time:"18:00:00",inventory_sync_enabled:!0,pricing_model:"centralized",data_isolation_mode:"shared",share_products:!0,share_inventory:!1,share_customers:!0,share_suppliers:!0,share_categories:!0,share_employees:!1,share_accounts:!0,share_sales:!1,share_purchase_orders:!1,share_devices:!1,share_payments:!1,share_appointments:!1,share_reminders:!1,share_expenses:!1,share_trade_ins:!1,share_special_orders:!1,share_attendance:!1,share_loyalty_points:!1,share_gift_cards:!0,share_quality_checks:!1,share_recurring_expenses:!1,share_communications:!1,share_reports:!1,share_finance_transfers:!1,allow_stock_transfer:!0,auto_sync_products:!0,auto_sync_prices:!0,require_approval_for_transfers:!1,can_view_other_branches:!1,can_transfer_to_branches:[]},b_={products:"share_products",inventory:"share_inventory",customers:"share_customers",suppliers:"share_suppliers",categories:"share_categories",employees:"share_employees",accounts:"share_accounts",sales:"share_sales",purchase_orders:"share_purchase_orders",devices:"share_devices",payments:"share_payments",appointments:"share_appointments",reminders:"share_reminders",expenses:"share_expenses",trade_ins:"share_trade_ins",special_orders:"share_special_orders",attendance:"share_attendance",loyalty_points:"share_loyalty_points",gift_cards:"share_gift_cards",quality_checks:"share_quality_checks",recurring_expenses:"share_recurring_expenses",communications:"share_communications",reports:"share_reports",finance_transfers:"share_finance_transfers"},z0={data_isolation_mode:{allowedValues:["shared","isolated","hybrid"],check:s=>["shared","isolated","hybrid"].includes(s)},pricing_model:{allowedValues:["centralized","location-specific"],check:s=>["centralized","location-specific"].includes(s)}},ms=new Map;let Ca=0;const w_=6e4,Ue=()=>localStorage.getItem("current_branch_id"),v_=()=>{ms.clear(),Ca=0},Te=async s=>{try{const e=Date.now();if(e-Ca<w_&&ms.has(s))return ms.get(s);const{data:t,error:r}=await w.from("store_locations").select("*").eq("id",s).single();if(r){if(r.code==="PGRST116")return console.log(" No branch settings found for branch:",s),null;throw r}return ms.set(s,t),Ca=e,t}catch(e){return(e==null?void 0:e.code)!=="PGRST116"&&console.error("Error fetching branch settings:",e),null}},Br=async s=>{const e=Ue();if(!e)return!0;try{const t=await Te(e);if(!t||t.data_isolation_mode==="shared")return!0;if(t.data_isolation_mode==="isolated")return!1;const r=b_[s];return r&&r in t?t[r]:!0}catch(t){return console.error("Error checking data sharing:",t),!0}},Ct=async(s,e)=>{const t=Ue();if(!t)return console.log(" No branch filter applied (no branch selected)"),Bt(),s;const r=await Te(t),a=await Br(e);return(r==null?void 0:r.data_isolation_mode)==="shared"?(console.log(` No branch filter applied (${e} shared in shared mode)`),Bt(),s):(r==null?void 0:r.data_isolation_mode)==="isolated"?(console.log(` ISOLATED MODE: Filtering ${e} by branch ${t} (ignoring is_shared flag)`),Bt(),s.eq("branch_id",t)):(r==null?void 0:r.data_isolation_mode)==="hybrid"?a?(console.log(` HYBRID SHARED: ${e} - branch ${t} + shared data`),Bt(),s.or(`branch_id.eq.${t},is_shared.eq.true,branch_id.is.null`)):(console.log(` HYBRID NOT SHARED: ${e} - only branch ${t}`),Bt(),s.eq("branch_id",t)):(console.log(` DEFAULT: Filtering ${e} by branch ${t}`),Bt(e,s,(r==null?void 0:r.data_isolation_mode)||"isolated"),s.eq("branch_id",t))},jc=async(s,e,t)=>{const r=Ue(),a=await Br(t),n={...e,branch_id:a?null:r,is_shared:a};console.log(` Creating ${t} with branch settings:`,{branch_id:n.branch_id,is_shared:n.is_shared});const{data:o,error:i}=await w.from(s).insert([n]).select("*, branch_id, is_shared").single();if(i)throw console.error(` Error creating ${t}:`,i),i;return o&&console.log(` Created ${t} with branch_id=${o.branch_id||"NULL"}, is_shared=${o.is_shared}`),o},$c=async s=>{const e=Ue(),t={...s,branch_id:e||null};console.log(" Creating sale for branch:",e);const{data:r,error:a}=await w.from("lats_sales").insert([t]).select().single();if(a)throw a;return r},Mc=async()=>{let s=w.from("lats_products").select(`
      *,
      category:lats_categories!category_id(*),
      variants:lats_product_variants!product_id(*)
    `).eq("is_active",!0);const e=Ue();if(!e)return(await s).data||[];const t=await Te(e),r=await Br("products");(t==null?void 0:t.data_isolation_mode)==="shared"||((t==null?void 0:t.data_isolation_mode)==="isolated"?s=s.eq("branch_id",e):(t==null?void 0:t.data_isolation_mode)==="hybrid"?r?s=s.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`):s=s.eq("branch_id",e):s=s.or(`branch_id.eq.${e},branch_id.is.null`));const{data:a,error:n}=await s;if(n)throw n;return a||[]},qc=async(s,e)=>{const t=Ue();let r=w.from("lats_sales").select("*");t&&(r=r.eq("branch_id",t),console.log(` Filtering sales by branch: ${t}`)),s&&(r=r.gte("created_at",s)),e&&(r=r.lte("created_at",e));const{data:a,error:n}=await r.order("created_at",{ascending:!1});if(n)throw n;return a},S_={getCurrentBranchId:Ue,getBranchSettings:Te,isDataShared:Br,addBranchFilter:Ct,createWithBranch:jc,createSaleWithBranch:$c,getBranchProducts:Mc,getBranchSales:qc},dn=Object.freeze(Object.defineProperty({__proto__:null,addBranchFilter:Ct,clearBranchCache:v_,createSaleWithBranch:$c,createWithBranch:jc,default:S_,getBranchProducts:Mc,getBranchSales:qc,getBranchSettings:Te,getCurrentBranchId:Ue,isDataShared:Br},Symbol.toStringTag,{value:"Module"}));async function V0(s=5e3){const e=Ue();return wt(`device-stats-${e||"all"}`,async()=>{let t=w.from("devices").select("status, estimated_completion_date, created_at");e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;return r||[]},s)}async function G0(s=5e3){const e=Ue();return wt(`customer-stats-${e||"all"}`,async()=>{let t=w.from("customers").select("id, joined_date, is_active");e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;return r||[]},s)}async function W0(s=5e3){const e=Ue();return wt(`payment-stats-${e||"all"}`,async()=>{let t=w.from("customer_payments").select("amount, payment_date, status");e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;return r||[]},s)}async function H0(s=5e3){const e=Ue();return wt(`inventory-stats-${e||"all"}`,async()=>{let t=w.from("lats_products").select("id, name, is_active, branch_id, is_shared").eq("is_active",!0),r=null;if(e)try{const{data:u}=await w.from("store_locations").select("data_isolation_mode, share_products").eq("id",e).single();r=u}catch{console.warn(" [fetchInventoryStats] Could not fetch branch settings")}e&&r?r.data_isolation_mode==="isolated"?t=t.eq("branch_id",e):r.data_isolation_mode==="shared"||r.data_isolation_mode==="hybrid"&&(r.share_products?t=t.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`):t=t.eq("branch_id",e)):e&&(t=t.or(`branch_id.eq.${e},branch_id.is.null`));const{data:a,error:n}=await t;if(n)throw n;const o=(a||[]).map(u=>u.id);if(o.length===0)return[];let i=w.from("lats_product_variants").select("id, product_id, quantity, cost_price, unit_price, selling_price, min_quantity, branch_id, is_shared").in("product_id",o),c=null;if(e)try{const{data:u}=await w.from("store_locations").select("data_isolation_mode, share_inventory").eq("id",e).single();c=u}catch{console.warn(" [fetchInventoryStats] Could not fetch branch settings")}e&&c?c.data_isolation_mode==="isolated"?i=i.eq("branch_id",e):c.data_isolation_mode==="shared"||c.data_isolation_mode==="hybrid"&&(c.share_inventory?i=i.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`):i=i.eq("branch_id",e)):e&&(i=i.or(`branch_id.eq.${e},branch_id.is.null`));const{data:l,error:d}=await i;if(d)throw d;return console.log(" fetchInventoryStats result:",{branch:e||"all",productsCount:(a==null?void 0:a.length)||0,variantsCount:(l==null?void 0:l.length)||0}),l||[]},s)}async function E_(s=3e4){const e=Ue(),t=`payment-methods-${e||"all"}`;return wt(t,async()=>{const{addBranchFilter:r}=await z(()=>Promise.resolve().then(()=>dn),void 0),a=w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("is_active",!0).eq("is_payment_method",!0).order("name",{ascending:!0});console.log(` [fetchPaymentMethods] Current branch ID: ${e||"none"}`);const n=await r(a,"accounts"),{data:o,error:i}=await n;if(i)throw console.error(" Error fetching payment methods:",i),console.error("   Error details:",JSON.stringify(i,null,2)),i;return console.log(` [fetchPaymentMethods] Query returned ${(o==null?void 0:o.length)||0} accounts for branch ${e||"none"}`),o&&o.length>0&&console.log(` Fetched ${o.length} payment methods with branch filtering`),(o||[]).map(l=>({...l,payment_icon:l.icon||l.payment_icon,payment_color:l.color||l.payment_color,payment_description:l.description||l.payment_description,balance:typeof l.balance=="string"?parseFloat(l.balance)||0:l.balance||0}))},s)}function Q0(s){un.clearCache(s)}async function x_(s=5e3){const e=Ue();return wt(`customer-payments-${e||"all"}`,async()=>{let t=w.from("customer_payments").select("*").order("payment_date",{ascending:!1});e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;return r||[]},s)}async function P_(s=5e3){return wt("lats-sales",async()=>{console.log("%c","color: #9900cc; font-weight: bold;"),console.log("%c FETCHING SALES","background: #9900cc; color: white; font-size: 14px; padding: 3px;");const e=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null,t={"24cd45b8-1ce1-486a-b055-29d169c3a8ea":"Main Store","115e0e51-d0d6-437b-9fda-dfe11241b167":"ARUSHA","d4603b1e-6bb7-414d-91b6-ca1a4938b441":"Airport Branch"};console.log("%c Current Branch:","color: #9900cc; font-weight: bold;",e),console.log("%c Branch Name:","color: #9900cc; font-weight: bold;",t[e]||"UNKNOWN");let r=w.from("lats_sales").select("*").order("created_at",{ascending:!1});e?(console.log("%c APPLYING BRANCH FILTER TO SALES!","background: #ff0000; color: white; font-weight: bold; padding: 3px;"),console.log("%c   Filter: branch_id = "+e,"color: #ff0000;"),r=r.eq("branch_id",e)):console.log("%c NO BRANCH FILTER - SHOWING ALL SALES!","background: #ff9900; color: black; font-weight: bold; padding: 3px;");const{data:a,error:n}=await r;if(n)throw console.error("%c SALES QUERY FAILED!","background: #ff0000; color: white; padding: 3px;"),console.error("Error:",n),n;return console.log("%c SALES RETURNED:","background: #00cc00; color: white; font-weight: bold; padding: 3px;",(a==null?void 0:a.length)||0),a&&a.length>0&&(console.log("%c SAMPLE SALES (first 3):","color: #9900cc; font-weight: bold;"),a.slice(0,3).forEach((o,i)=>{console.log(`   ${i+1}. ${o.sale_number} - ${o.total_amount} TZS (${t[o.branch_id]||"Unknown Branch"})`)})),console.log("%c","color: #9900cc; font-weight: bold;"),a||[]},s)}async function A_(s,e=5e3){const t=`customers-by-ids-${s.sort().join(",")}`;return wt(t,async()=>{const{data:r,error:a}=await w.from("customers").select("id, name").in("id",s);if(a)throw a;return r||[]},e)}const k_=D.createContext(void 0),I_=({children:s})=>{const[e,t]=D.useState([]),[r,a]=D.useState(!0),n=async()=>{a(!0);try{const{data:{user:h},error:g}=await w.auth.getUser();if(g||!h){console.debug("User not authenticated, skipping payment fetch"),t([]),a(!1);return}let p=[],m=null;try{p=await x_()}catch(v){m=v,console.error("Error fetching customer payments:",m);const C=(m==null?void 0:m.message)||"";C.includes('relation "public.customer_payments" does not exist')&&console.warn("customer_payments table does not exist. Please run the SQL migration in Supabase dashboard."),(C.includes("JWT")||C.includes("auth"))&&console.warn("Authentication error. Please log in again.")}let _=[],b=null;try{console.log(" Using deduplicated POS sales query...");try{_=await P_(),b=null,console.log(` Loaded ${_.length} POS sales (deduplicated query)`)}catch(v){console.error("POS sales query failed:",v),_=[],b=v}}catch(v){console.error("Unexpected error fetching POS sales:",v),_=[],b=v}const S=[];if(!m&&p){const v=[...new Set(p.map(k=>k.device_id).filter(Boolean))],C=[...new Set(p.map(k=>k.customer_id).filter(Boolean))];let T={};if(v.length>0){const{data:k}=await w.from("devices").select("id, brand, model").in("id",v);k&&(T=Object.fromEntries(k.map(P=>[P.id,P])))}let x={};if(C.length>0)try{const k=await A_(C);x=Object.fromEntries(k.map(P=>[P.id,P]))}catch(k){console.error("Error fetching customers:",k)}const R=p.map(k=>{const P=T[k.device_id],O=x[k.customer_id];return{id:k.id,customer_id:k.customer_id,amount:k.amount,currency:k.currency||"TZS",method:k.method,device_id:k.device_id,payment_date:k.payment_date,payment_type:k.payment_type,status:k.status,created_by:k.created_by,created_at:k.created_at,device_name:P?`${P.brand||""} ${P.model||""}`.trim():void 0,customer_name:(O==null?void 0:O.name)||void 0,source:"device_payment",repairType:k.repair_type,diagnosis:k.diagnosis,deviceBrand:P==null?void 0:P.brand,deviceModel:P==null?void 0:P.model}});S.push(...R)}if(!b&&_){const v=_.map(C=>{var T;return{id:C.id,customer_id:C.customer_id,amount:C.total_amount,currency:C.currency||"TZS",method:C.payment_method,device_id:null,payment_date:C.created_at,payment_type:"payment",status:C.status==="completed"?"completed":C.status==="pending"?"pending":"failed",created_by:C.created_by,created_at:C.created_at,device_name:void 0,customer_name:((T=C.customers)==null?void 0:T.name)||C.customer_name||void 0,source:"pos_sale",orderId:C.id,orderStatus:C.status,totalAmount:C.total_amount,discountAmount:0,taxAmount:0,shippingCost:0,amountPaid:C.total_amount,balanceDue:0,customerType:"retail",deliveryMethod:"pickup",deliveryAddress:"",deliveryCity:"",deliveryNotes:""}});S.push(...v)}S.sort((v,C)=>{const T=new Date(v.payment_date||v.created_at);return new Date(C.payment_date||C.created_at).getTime()-T.getTime()}),t(S)}catch(h){console.error("Error fetching payments:",h)}finally{a(!1)}},o=h=>e.filter(g=>g.source===h),i=h=>e.filter(g=>g.status===h),c=(h,g)=>{const p=new Date(h),m=new Date(g);return e.filter(_=>{const b=new Date(_.payment_date||_.created_at);return b>=p&&b<=m})},l=(h,g)=>{const p=g.currency,m=g.exchange_rate;if(!p||p==="TZS")return h;const _=m&&m>1?m:p==="USD"?2500:p==="EUR"?2700:p==="GBP"?3200:1;return h*_},d=()=>e.filter(h=>h.status==="completed").reduce((h,g)=>{const p=Number(g.amount)||0;return h+l(p,g)},0),u=()=>{const h=o("device_payment").filter(m=>m.status==="completed").reduce((m,_)=>{const b=Number(_.amount)||0;return m+l(b,_)},0),g=o("pos_sale").filter(m=>m.status==="completed").reduce((m,_)=>{const b=Number(_.amount)||0;return m+l(b,_)},0),p=o("repair_payment").filter(m=>m.status==="completed").reduce((m,_)=>{const b=Number(_.amount)||0;return m+l(b,_)},0);return{devicePayments:h,posSales:g,repairPayments:p,total:h+g+p}};return D.useEffect(()=>{n();let h;const{data:{subscription:g}}=w.auth.onAuthStateChange((p,m)=>{var _;console.log("Auth state changed:",p,(_=m==null?void 0:m.user)==null?void 0:_.id),h&&clearTimeout(h),h=setTimeout(()=>{p==="SIGNED_IN"&&m?n():p==="SIGNED_OUT"&&(t([]),a(!1))},100)});return()=>{h&&clearTimeout(h),g.unsubscribe()}},[]),f.jsx(k_.Provider,{value:{payments:e,loading:r,refreshPayments:n,getPaymentsBySource:o,getPaymentsByStatus:i,getPaymentsByDateRange:c,getTotalRevenue:d,getRevenueBySource:u},children:s})},Bc=D.createContext(void 0),C_=({children:s})=>{const[e,t]=D.useState(()=>localStorage.getItem("app-theme")||"light"),r=n=>{t(n),localStorage.setItem("app-theme",n),document.body.className=document.body.className.replace(/theme-\w+/g,""),document.body.classList.add(`theme-${n}`)},a=e==="dark"||e==="dark-cards";return D.useEffect(()=>{document.body.className=document.body.className.replace(/theme-\w+/g,""),document.body.classList.add(`theme-${e}`)},[e]),f.jsx(Bc.Provider,{value:{theme:e,setTheme:r,isDark:a},children:s})},K0=()=>{const s=D.useContext(Bc);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s},Fc=D.createContext(void 0),zc=()=>{const s=D.useContext(Fc);if(!s)throw new Error("useLoading must be used within a LoadingProvider");return s},D_=({children:s})=>{const[e,t]=D.useState([]),r=D.useCallback(u=>{const h=`${u}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,g={id:h,title:u,status:"pending",progress:0,timestamp:Date.now()};return t(p=>[...p,g]),h},[]),a=D.useCallback((u,h)=>{t(g=>g.map(p=>p.id===u?{...p,...h}:p))},[]),n=D.useCallback(u=>{t(h=>h.filter(g=>g.id!==u))},[]),o=D.useCallback(u=>{t(h=>h.map(g=>g.id===u&&g.status==="pending"?{...g,status:"failed",error:"Cancelled by user"}:g))},[]),i=D.useCallback(()=>{t(u=>u.filter(h=>h.status!=="completed"&&h.status!=="failed"))},[]),c=D.useCallback(()=>{t([])},[]),l=e.length>0,d={jobs:e,addJob:r,updateJob:a,removeJob:n,cancelJob:o,clearCompletedJobs:i,clearAllJobs:c,isVisible:l};return f.jsx(Fc.Provider,{value:d,children:s})},T_={business_name:"inauzwa",business_address:"",business_phone:"",business_email:"",business_website:"",business_logo:null,theme:"light",language:"en",currency:"TZS",timezone:"Africa/Dar_es_Salaam",date_format:"DD/MM/YYYY",time_format:"24",font_size:"medium",show_product_images:!0,show_stock_levels:!0,show_prices:!0,show_barcodes:!0,products_per_page:20,auto_complete_search:!0,confirm_delete:!0,show_confirmations:!0,enable_sound_effects:!0,sound_volume:.5,enable_click_sounds:!0,enable_cart_sounds:!0,enable_payment_sounds:!0,enable_delete_sounds:!0,enable_animations:!0,enable_caching:!0,cache_duration:300,enable_lazy_loading:!0,max_search_results:50,enable_tax:!1,tax_rate:16,day_closing_passcode:"1234"},R_={enable_dynamic_pricing:!0,enable_loyalty_pricing:!0,enable_bulk_pricing:!0,enable_time_based_pricing:!1,enable_customer_pricing:!1,enable_special_events:!1,loyalty_discount_percent:5,loyalty_points_threshold:1e3,loyalty_max_discount:20,bulk_discount_enabled:!0,bulk_discount_threshold:10,bulk_discount_percent:10,time_based_discount_enabled:!1,time_based_start_time:"18:00",time_based_end_time:"22:00",time_based_discount_percent:15,customer_pricing_enabled:!1,vip_customer_discount:10,regular_customer_discount:5,special_events_enabled:!1,special_event_discount_percent:20},O_={receipt_template:"standard",receipt_width:80,receipt_font_size:12,show_business_logo:!0,show_business_name:!0,show_business_address:!0,show_business_phone:!0,show_business_email:!1,show_business_website:!1,show_transaction_id:!0,show_date_time:!0,show_cashier_name:!0,show_customer_name:!0,show_customer_phone:!1,show_product_names:!0,show_product_skus:!1,show_product_barcodes:!1,show_quantities:!0,show_unit_prices:!0,show_discounts:!0,show_subtotal:!0,show_tax:!0,show_discount_total:!0,show_grand_total:!0,show_payment_method:!0,show_change_amount:!0,auto_print_receipt:!1,print_duplicate_receipt:!1,enable_email_receipt:!1,enable_sms_receipt:!1,enable_receipt_numbering:!0,receipt_number_prefix:"RCP",receipt_number_start:1,receipt_number_format:"RCP-{YEAR}-{NUMBER}",show_footer_message:!0,footer_message:"Thank you for your business!",show_return_policy:!1,return_policy_text:"Returns accepted within 7 days with receipt",enable_whatsapp_pdf:!0,whatsapp_pdf_auto_send:!1,whatsapp_pdf_show_preview:!0,whatsapp_pdf_format:"a4",whatsapp_pdf_quality:"standard",whatsapp_pdf_include_logo:!0,whatsapp_pdf_include_images:!1,whatsapp_pdf_include_qr:!0,whatsapp_pdf_include_barcode:!1,whatsapp_pdf_message:"Thank you for your purchase! Please find your receipt attached.",enable_email_pdf:!0,enable_print_pdf:!0,enable_download_pdf:!0,show_share_button:!0},N_={enable_barcode_scanner:!0,enable_camera_scanner:!0,enable_keyboard_input:!0,enable_manual_entry:!0,auto_add_to_cart:!0,auto_focus_search:!0,play_sound_on_scan:!0,vibrate_on_scan:!0,show_scan_feedback:!0,show_invalid_barcode_alert:!0,allow_unknown_products:!1,prompt_for_unknown_products:!0,retry_on_error:!0,max_retry_attempts:3,scanner_connection_type:"usb",scanner_timeout:5e3,support_ean13:!0,support_ean8:!0,support_upc_a:!0,support_upc_e:!0,support_code128:!0,support_code39:!0,support_qr_code:!1,support_data_matrix:!1,enable_continuous_scanning:!1,scan_delay:100,enable_scan_history:!0,max_scan_history:100},L_={enable_delivery:!0,default_delivery_fee:2e3,free_delivery_threshold:5e4,max_delivery_distance:20,enable_delivery_areas:!0,delivery_areas:["City Center","Suburbs","Outskirts"],area_delivery_fees:{"City Center":1500,Suburbs:2500,Outskirts:3500},area_delivery_times:{"City Center":30,Suburbs:60,Outskirts:90},enable_delivery_hours:!0,delivery_start_time:"08:00",delivery_end_time:"20:00",enable_same_day_delivery:!0,enable_next_day_delivery:!0,delivery_time_slots:["Morning","Afternoon","Evening"],notify_customer_on_delivery:!0,notify_driver_on_assignment:!0,enable_sms_notifications:!0,enable_email_notifications:!1,enable_driver_assignment:!0,driver_commission:15,require_signature:!0,enable_driver_tracking:!0,enable_scheduled_delivery:!1,enable_partial_delivery:!1,require_advance_payment:!1,advance_payment_percent:50},U_={enable_product_search:!0,enable_customer_search:!0,enable_sales_search:!0,search_by_name:!0,search_by_barcode:!0,search_by_sku:!0,search_by_category:!0,search_by_supplier:!0,search_by_description:!1,search_by_tags:!1,enable_fuzzy_search:!0,enable_autocomplete:!0,min_search_length:2,max_search_results:50,search_timeout:3e3,search_debounce_time:300,enable_search_history:!0,max_search_history:20,enable_recent_searches:!0,enable_popular_searches:!0,enable_search_suggestions:!0},j_={enable_performance_mode:!1,enable_caching:!0,cache_size:100,enable_lazy_loading:!0,max_concurrent_requests:10,enable_database_optimization:!0,enable_auto_backup:!0,backup_frequency:"daily",enable_data_compression:!0,enable_query_optimization:!0,enable_two_factor_auth:!1,enable_session_timeout:!0,session_timeout_minutes:30,enable_audit_logging:!0,enable_encryption:!0,enable_api_access:!1,enable_webhooks:!1,enable_third_party_integrations:!1,enable_data_sync:!1,sync_interval:60,enable_debug_mode:!1,enable_error_reporting:!0,enable_performance_monitoring:!0,enable_logging:!0,log_level:"info",enable_experimental_features:!1,enable_beta_features:!1,enable_custom_scripts:!1,enable_plugin_system:!1,enable_auto_updates:!0};function jt(s,e){const[t,r]=D.useState(e),[a,n]=D.useState(!0),[o,i]=D.useState(!1),[c,l]=D.useState(null);let d=!1;try{const m=Lt();d=(m==null?void 0:m.isAuthenticated)||!1}catch{d=!1}const u=D.useCallback(async()=>{var m,_;try{n(!0),l(null);const S={general:"loadGeneralSettings",pricing:"loadDynamicPricingSettings",receipt:"loadReceiptSettings",scanner:"loadBarcodeScannerSettings",delivery:"loadDeliverySettings",search:"loadSearchFilterSettings",permissions:"loadUserPermissionsSettings",loyalty:"loadLoyaltyCustomerSettings",analytics:"loadAnalyticsReportingSettings",notifications:"loadNotificationSettings",advanced:"loadAdvancedSettings"}[s];let v=0;const C=3;let T=null;for(;v<C;)try{T=await is[S]();break}catch(x){if(v++,((m=x.message)!=null&&m.includes("not authenticated")||(_=x.message)!=null&&_.includes("Auth session missing"))&&v<C){await new Promise(R=>setTimeout(R,1e3));continue}throw x}T?(Math.random()<.1&&console.log(` Loaded ${s} settings:`,T),r(T),window.dispatchEvent(new CustomEvent("posSettingsLoaded",{detail:{type:s,settings:T}}))):(console.log(`No ${s} settings found, using defaults`),r(e))}catch(b){console.error(`Error loading ${s} settings:`,b),l(`Failed to load ${s} settings`),r(e)}finally{n(!1)}},[s,e]),h=D.useCallback(async m=>{try{i(!0),l(null);const b={general:"saveGeneralSettings",pricing:"saveDynamicPricingSettings",receipt:"saveReceiptSettings",scanner:"saveBarcodeScannerSettings",delivery:"saveDeliverySettings",search:"saveSearchFilterSettings",permissions:"saveUserPermissionsSettings",loyalty:"saveLoyaltyCustomerSettings",analytics:"saveAnalyticsReportingSettings",notifications:"saveNotificationSettings",advanced:"saveAdvancedSettings"}[s],S=await is[b](m);if(S)return r(S),console.log(` ${s} settings saved successfully:`,S),ge.success(`${s.charAt(0).toUpperCase()+s.slice(1)} settings saved successfully`),window.dispatchEvent(new CustomEvent("settingsSaved",{detail:{type:s,settings:S}})),await u(),!0;throw console.error(` Save returned null/undefined for ${s}`),new Error("Failed to save settings")}catch(_){return console.error(` Error saving ${s} settings:`,_),console.error(" Error details:",{message:_.message,stack:_.stack,name:_.name}),l(`Failed to save ${s} settings`),ge.error(`Failed to save ${s} settings`),!1}finally{i(!1)}},[s,u]),g=D.useCallback(async m=>{try{i(!0),l(null);const b={general:"updateGeneralSettings",pricing:"updateDynamicPricingSettings",receipt:"updateReceiptSettings",scanner:"updateBarcodeScannerSettings",delivery:"updateDeliverySettings",search:"updateSearchFilterSettings",permissions:"updateUserPermissionsSettings",loyalty:"updateLoyaltyCustomerSettings",analytics:"updateAnalyticsReportingSettings",notifications:"updateNotificationSettings",advanced:"updateAdvancedSettings"}[s],S=await is[b](m);if(S)return r(S),ge.success(`${s.charAt(0).toUpperCase()+s.slice(1)} settings updated successfully`),await u(),!0;throw new Error("Failed to update settings")}catch(_){return console.error(`Error updating ${s} settings:`,_),l(`Failed to update ${s} settings`),ge.error(`Failed to update ${s} settings`),!1}finally{i(!1)}},[s,u]),p=D.useCallback(async()=>{try{return i(!0),l(null),r(e),ge.success(`${s.charAt(0).toUpperCase()+s.slice(1)} settings reset to defaults`),!0}catch(m){return console.error(`Error resetting ${s} settings:`,m),l(`Failed to reset ${s} settings`),ge.error(`Failed to reset ${s} settings`),!1}finally{i(!1)}},[s,e]);return D.useEffect(()=>{d?u():(r(e),n(!1))},[d,u,e]),{settings:t,setSettings:r,loading:a,saving:o,error:c,loadSettings:u,saveSettings:h,updateSettings:g,resetSettings:p,refreshSettings:u}}const $_=()=>jt("general",T_),J0=()=>jt("pricing",R_),Y0=()=>jt("receipt",O_),X0=()=>jt("scanner",N_),Z0=()=>jt("delivery",L_),eS=()=>jt("search",U_),tS=()=>jt("advanced",j_),M_={"common.save":"Save","common.cancel":"Cancel","common.delete":"Delete","common.edit":"Edit","common.add":"Add","common.search":"Search","common.filter":"Filter","common.clear":"Clear","common.loading":"Loading...","common.error":"Error","common.success":"Success","common.warning":"Warning","common.info":"Info","common.yes":"Yes","common.no":"No","common.ok":"OK","common.close":"Close","common.back":"Back","common.next":"Next","common.previous":"Previous","common.submit":"Submit","common.reset":"Reset","common.refresh":"Refresh","common.export":"Export","common.import":"Import","common.download":"Download","common.upload":"Upload","common.print":"Print","common.copy":"Copy","common.paste":"Paste","common.select":"Select","common.selectAll":"Select All","common.deselectAll":"Deselect All","common.actions":"Actions","common.status":"Status","common.date":"Date","common.time":"Time","common.quantity":"Quantity","common.price":"Price","common.total":"Total","common.subtotal":"Subtotal","common.tax":"Tax","common.discount":"Discount","common.amount":"Amount","common.currency":"Currency","common.percentage":"Percentage","common.unit":"Unit","common.units":"Units","common.item":"Item","common.items":"Items","common.product":"Product","common.products":"Products","common.category":"Category","common.categories":"Categories","common.supplier":"Supplier","common.suppliers":"Suppliers","common.customer":"Customer","common.customers":"Customers","common.order":"Order","common.orders":"Orders","common.sale":"Sale","common.sales":"Sales","common.invoice":"Invoice","common.invoices":"Invoices","common.receipt":"Receipt","common.receipts":"Receipts","common.payment":"Payment","common.payments":"Payments","common.stock":"Stock","common.inventory":"Inventory","common.warehouse":"Warehouse","common.warehouses":"Warehouses","common.location":"Location","common.locations":"Locations","common.sku":"SKU","common.barcode":"Barcode","common.description":"Description","common.notes":"Notes","common.remarks":"Remarks","common.reason":"Reason","common.reference":"Reference","common.created":"Created","common.updated":"Updated","common.createdBy":"Created By","common.updatedBy":"Updated By","common.createdAt":"Created At","common.updatedAt":"Updated At","common.active":"Active","common.inactive":"Inactive","common.enabled":"Enabled","common.disabled":"Disabled","common.visible":"Visible","common.hidden":"Hidden","common.public":"Public","common.private":"Private","common.draft":"Draft","common.published":"Published","common.archived":"Archived","common.deleted":"Deleted","common.pending":"Pending","common.approved":"Approved","common.rejected":"Rejected","common.completed":"Completed","common.cancelled":"Cancelled","common.failed":"Failed","common.successful":"Successful","common.unsuccessful":"Unsuccessful","common.available":"Available","common.unavailable":"Unavailable","common.inStock":"In Stock","common.outOfStock":"Out of Stock","common.lowStock":"Low Stock","common.overStock":"Over Stock","common.zeroStock":"Zero Stock","common.negativeStock":"Negative Stock","common.positiveStock":"Positive Stock","common.stockLevel":"Stock Level","common.minimumStock":"Minimum Stock","common.maximumStock":"Maximum Stock","common.reorderPoint":"Reorder Point","common.reorderQuantity":"Reorder Quantity","common.leadTime":"Lead Time","common.supplierLeadTime":"Supplier Lead Time","common.customerLeadTime":"Customer Lead Time","common.processingTime":"Processing Time","common.deliveryTime":"Delivery Time","common.shippingTime":"Shipping Time","common.returnTime":"Return Time","common.refundTime":"Refund Time","common.exchangeTime":"Exchange Time","common.warrantyTime":"Warranty Time","common.guaranteeTime":"Guarantee Time","common.expiryTime":"Expiry Time","common.validityTime":"Validity Time","common.effectiveTime":"Effective Time","common.expirationTime":"Expiration Time","common.startTime":"Start Time","common.endTime":"End Time","common.beginTime":"Begin Time","common.finishTime":"Finish Time","common.openTime":"Open Time","common.closeTime":"Close Time","common.businessHours":"Business Hours","common.workingHours":"Working Hours","common.officeHours":"Office Hours","common.storeHours":"Store Hours","common.serviceHours":"Service Hours","common.supportHours":"Support Hours","common.helpHours":"Help Hours","common.contactHours":"Contact Hours","common.availability":"Availability","common.availableFrom":"Available From","common.availableTo":"Available To","common.availableUntil":"Available Until","common.availableSince":"Available Since","common.availableFor":"Available For","common.availableIn":"Available In","common.availableAt":"Available At","common.availableOn":"Available On","common.availableBy":"Available By","common.availableThrough":"Available Through","common.availableVia":"Available Via","common.availableWith":"Available With","common.availableWithout":"Available Without","common.availableWithin":"Available Within","common.availableOutside":"Available Outside","common.availableInside":"Available Inside","common.availableAbove":"Available Above","common.availableBelow":"Available Below","common.availableBefore":"Available Before","common.availableAfter":"Available After","common.availableDuring":"Available During","common.availableBetween":"Available Between","common.availableAmong":"Available Among","common.availableAmongst":"Available Amongst","common.availableAcross":"Available Across","common.availableAlong":"Available Along","common.availableAround":"Available Around","common.availableAbout":"Available About","common.availableAgainst":"Available Against","common.availableAlongside":"Available Alongside","common.availableAmid":"Available Amid","common.availableAmidst":"Available Amidst","common.availableAs":"Available As","common.availableBehind":"Available Behind","common.availableBeneath":"Available Beneath","common.availableBeside":"Available Beside","common.availableBesides":"Available Besides","common.availableBeyond":"Available Beyond","common.availableConcerning":"Available Concerning","common.availableConsidering":"Available Considering","common.availableDespite":"Available Despite","common.availableDown":"Available Down","common.availableExcept":"Available Except","common.availableInto":"Available Into","common.availableLike":"Available Like","common.availableMinus":"Available Minus","common.availableNear":"Available Near","common.availableOf":"Available Of","common.availableOff":"Available Off","common.availableOnto":"Available Onto","common.availableOut":"Available Out","common.availableOver":"Available Over","common.availablePast":"Available Past","common.availablePer":"Available Per","common.availablePlus":"Available Plus","common.availableRegarding":"Available Regarding","common.availableRound":"Available Round","common.availableSave":"Available Save","common.availableThan":"Available Than","common.availableThroughout":"Available Throughout","common.availableToward":"Available Toward","common.availableTowards":"Available Towards","common.availableUnder":"Available Under","common.availableUnderneath":"Available Underneath","common.availableUnlike":"Available Unlike","common.availableUp":"Available Up","common.availableUpon":"Available Upon","common.availableVersus":"Available Versus","common.availableWorth":"Available Worth","settings.title":"Settings","settings.posSettings":"POS Settings","settings.configure":"Configure your point of sale system","settings.searchSettings":"Search settings...","settings.noSettingsFound":"No settings found matching","settings.saveSettings":"Save Settings","settings.saving":"Saving...","settings.general":"General","settings.pricing":"Pricing & Discounts","settings.receipt":"Receipts","settings.notifications":"Notifications","settings.features":"Features","settings.permissions":"Users & Permissions","general.businessInfo":"Business Information","general.businessInfoHelp":"Enter your business details that will appear on receipts, invoices, and other documents.","general.businessName":"Business Name","general.businessPhone":"Business Phone","general.businessEmail":"Business Email","general.businessWebsite":"Business Website","general.businessAddress":"Business Address","general.uploadLogo":"Upload Logo","general.changeLogo":"Change","general.uploading":"Uploading...","interface.title":"Interface Settings","interface.help":"Control the visual appearance and language settings of your POS system.","interface.theme":"Theme","interface.light":"Light","interface.dark":"Dark","interface.auto":"Auto","interface.language":"Language","interface.english":"English","interface.swahili":"Swahili","interface.french":"French","interface.fontSize":"Font Size","interface.tiny":"Tiny","interface.extraSmall":"Extra Small","interface.small":"Small","interface.medium":"Medium","interface.large":"Large","interface.currency":"Currency","interface.dateFormat":"Date Format","interface.timeFormat":"Time Format","interface.12hour":"12-hour","interface.24hour":"24-hour"},q_={"common.save":"Save","common.cancel":"Cancel","common.delete":"Delete","common.edit":"Edit","common.add":"Ongeza","common.search":"Tafuta","common.filter":"Filter","common.clear":"Clear","common.loading":"Inapakia...","common.error":"Kuna tatizo","common.success":"Imefanikiwa","common.warning":"Angalia","common.info":"Info","common.yes":"Ndiyo","common.no":"Hapana","common.ok":"Sawa","common.close":"Funga","common.back":"Rudi","common.next":"Next","common.previous":"Previous","common.submit":"Submit","common.reset":"Reset","common.refresh":"Refresh","common.export":"Export","common.import":"Import","common.download":"Download","common.upload":"Upload","common.print":"Print","common.copy":"Copy","common.paste":"Paste","common.select":"Chagua","common.selectAll":"Chagua Zote","common.deselectAll":"Ondoa Zote","common.actions":"Actions","common.status":"Status","common.date":"Tarehe","common.time":"Saa","common.quantity":"Idadi","common.price":"Bei","common.total":"Jumla","common.subtotal":"Jumla Ndogo","common.tax":"Tax","common.discount":"Discount","common.amount":"Kiasi","common.currency":"Currency","common.percentage":"Percent","common.unit":"Unit","common.units":"Units","common.item":"Item","common.items":"Items","common.product":"Bidhaa","common.products":"Bidhaa","common.category":"Category","common.categories":"Categories","common.supplier":"Supplier","common.suppliers":"Suppliers","common.customer":"Customer","common.customers":"Customers","common.order":"Order","common.orders":"Orders","common.sale":"Sale","common.sales":"Sales","common.invoice":"Invoice","common.invoices":"Invoices","common.receipt":"Receipt","common.receipts":"Receipts","common.payment":"Payment","common.payments":"Payments","common.stock":"Stock","common.inventory":"Inventory","common.warehouse":"Store","common.warehouses":"Stores","common.location":"Mahali","common.locations":"Mahali","common.sku":"SKU","common.barcode":"Barcode","common.description":"Maelezo","common.notes":"Notes","common.remarks":"Remarks","common.reason":"Sababu","common.reference":"Marejeleo","common.created":"Iliundwa","common.updated":"Iliyosasishwa","common.createdBy":"Iliundwa na","common.updatedBy":"Iliyosasishwa na","common.createdAt":"Iliundwa saa","common.updatedAt":"Iliyosasishwa saa","common.active":"Inatumika","common.inactive":"Haifanyi kazi","common.enabled":"Imeamilishwa","common.disabled":"Imezuiwa","common.visible":"Inaonekana","common.hidden":"Imejificha","common.public":"Ya umma","common.private":"Ya kibinafsi","common.draft":"Rasimu","common.published":"Imechapishwa","common.archived":"Imehifadhiwa","common.deleted":"Imeondolewa","common.pending":"Inasubiri","common.approved":"Imekubaliwa","common.rejected":"Imekataliwa","common.completed":"Imekamilika","common.cancelled":"Imeghairiwa","common.failed":"Imeshindwa","common.successful":"Imefanikiwa","common.unsuccessful":"Haijafanikiwa","common.available":"Inapatikana","common.unavailable":"Haipatikani","common.inStock":"Iko kwenye hifadhi","common.outOfStock":"Haiko kwenye hifadhi","common.lowStock":"Hifadhi ndogo","common.overStock":"Hifadhi kubwa","common.zeroStock":"Hifadhi sifuri","common.negativeStock":"Hifadhi hasi","common.positiveStock":"Hifadhi chanya","common.stockLevel":"Kiwango cha hifadhi","common.minimumStock":"Hifadhi ya chini","common.maximumStock":"Hifadhi ya juu","common.reorderPoint":"Hatua ya kuagiza tena","common.reorderQuantity":"Kiasi cha kuagiza tena","common.leadTime":"Muda wa kuongoza","common.supplierLeadTime":"Muda wa kuongoza wa mtoaji","common.customerLeadTime":"Muda wa kuongoza wa mteja","common.processingTime":"Muda wa kusindika","common.deliveryTime":"Muda wa kusambaza","common.shippingTime":"Muda wa kusafirisha","common.returnTime":"Muda wa kurudi","common.refundTime":"Muda wa kurudisha pesa","common.exchangeTime":"Muda wa kubadilisha","common.warrantyTime":"Muda wa dhamana","common.guaranteeTime":"Muda wa uhakikisho","common.expiryTime":"Muda wa kumalizika","common.validityTime":"Muda wa uhalali","common.effectiveTime":"Muda wa kufanya kazi","common.expirationTime":"Muda wa kumalizika","common.startTime":"Muda wa kuanza","common.endTime":"Muda wa kumaliza","common.beginTime":"Muda wa kuanza","common.finishTime":"Muda wa kumaliza","common.openTime":"Muda wa kufungua","common.closeTime":"Muda wa kufunga","common.businessHours":"Masaa ya biashara","common.workingHours":"Masaa ya kufanya kazi","common.officeHours":"Masaa ya ofisi","common.storeHours":"Masaa ya duka","common.serviceHours":"Masaa ya huduma","common.supportHours":"Masaa ya msaada","common.helpHours":"Masaa ya msaada","common.contactHours":"Masaa ya mawasiliano","common.availability":"Upatikanaji","common.availableFrom":"Inapatikana kutoka","common.availableTo":"Inapatikana hadi","common.availableUntil":"Inapatikana hadi","common.availableSince":"Inapatikana tangu","common.availableFor":"Inapatikana kwa","common.availableIn":"Inapatikana katika","common.availableAt":"Inapatikana saa","common.availableOn":"Inapatikana kwenye","common.availableBy":"Inapatikana na","common.availableThrough":"Inapatikana kupitia","common.availableVia":"Inapatikana kupitia","common.availableWith":"Inapatikana na","common.availableWithout":"Inapatikana bila","common.availableWithin":"Inapatikana ndani ya","common.availableOutside":"Inapatikana nje ya","common.availableInside":"Inapatikana ndani ya","common.availableAbove":"Inapatikana juu ya","common.availableBelow":"Inapatikana chini ya","common.availableBefore":"Inapatikana kabla ya","common.availableAfter":"Inapatikana baada ya","common.availableDuring":"Inapatikana wakati wa","common.availableBetween":"Inapatikana kati ya","common.availableAmong":"Inapatikana miongoni mwa","common.availableAmongst":"Inapatikana miongoni mwa","common.availableAcross":"Inapatikana kote","common.availableAlong":"Inapatikana pamoja na","common.availableAround":"Inapatikana karibu na","common.availableAbout":"Inapatikana kuhusu","common.availableAgainst":"Inapatikana dhidi ya","common.availableAlongside":"Inapatikana pamoja na","common.availableAmid":"Inapatikana kati ya","common.availableAmidst":"Inapatikana kati ya","common.availableAs":"Inapatikana kama","common.availableBehind":"Inapatikana nyuma ya","common.availableBeneath":"Inapatikana chini ya","common.availableBeside":"Inapatikana kando ya","common.availableBesides":"Inapatikana kando ya","common.availableBeyond":"Inapatikana zaidi ya","common.availableConcerning":"Inapatikana kuhusu","common.availableConsidering":"Inapatikana kwa kuzingatia","common.availableDespite":"Inapatikana licha ya","common.availableDown":"Inapatikana chini","common.availableExcept":"Inapatikana isipokuwa","common.availableInto":"Inapatikana ndani ya","common.availableLike":"Inapatikana kama","common.availableMinus":"Inapatikana toa","common.availableNear":"Inapatikana karibu na","common.availableOf":"Inapatikana ya","common.availableOff":"Inapatikana mbali na","common.availableOnto":"Inapatikana kwenye","common.availableOut":"Inapatikana nje","common.availableOver":"Inapatikana juu ya","common.availablePast":"Inapatikana zaidi ya","common.availablePer":"Inapatikana kwa","common.availablePlus":"Inapatikana pamoja na","common.availableRegarding":"Inapatikana kuhusu","common.availableRound":"Inapatikana kuzunguka","common.availableSave":"Inapatikana isipokuwa","common.availableThan":"Inapatikana kuliko","common.availableThroughout":"Inapatikana kote","common.availableToward":"Inapatikana kuelekea","common.availableTowards":"Inapatikana kuelekea","common.availableUnder":"Inapatikana chini ya","common.availableUnderneath":"Inapatikana chini ya","common.availableUnlike":"Inapatikana tofauti na","common.availableUp":"Inapatikana juu","common.availableUpon":"Inapatikana juu ya","common.availableVersus":"Inapatikana dhidi ya","common.availableWorth":"Inapatikana thamani ya","settings.title":"Settings","settings.posSettings":"POS Settings","settings.configure":"Weka settings za duka lako","settings.searchSettings":"Tafuta settings...","settings.noSettingsFound":"Hakuna settings","settings.saveSettings":"Save","settings.saving":"Inahifadhi...","settings.general":"General","settings.pricing":"Bei na Discounts","settings.receipt":"Receipt","settings.notifications":"Notifications","settings.features":"Features","settings.permissions":"Users na Permissions","general.businessInfo":"Taarifa za Duka","general.businessInfoHelp":"Weka jina la duka na taarifa zote hapa.","general.businessName":"Jina la Duka","general.businessPhone":"Namba ya Simu","general.businessEmail":"Email","general.businessWebsite":"Website","general.businessAddress":"Address ya Duka","general.uploadLogo":"Weka Logo","general.changeLogo":"Badilisha","general.uploading":"Inapakia...","interface.title":"Display Settings","interface.help":"Badilisha muonekano wa screen yako.","interface.theme":"Rangi","interface.light":"Mwangaza","interface.dark":"Dark","interface.auto":"Auto","interface.language":"Lugha","interface.english":"English","interface.swahili":"Swahili","interface.french":"French","interface.fontSize":"Size ya Maneno","interface.tiny":"Ndogo Sana","interface.extraSmall":"Ndogo Kidogo","interface.small":"Ndogo","interface.medium":"Wastani","interface.large":"Kubwa","interface.currency":"Currency","interface.dateFormat":"Format ya Tarehe","interface.timeFormat":"Format ya Saa","interface.12hour":"12 Saa","interface.24hour":"24 Saa","features.delivery":"Delivery","features.loyalty":"Loyalty Program","features.customerProfiles":"Customer Profiles","features.paymentTracking":"Payment Tracking","features.dynamicPricing":"Dynamic Pricing","features.enable":"Enable","features.disable":"Disable","receipt.template":"Receipt Template","receipt.logo":"Logo","receipt.showLogo":"Show Logo","receipt.businessInfo":"Business Info","receipt.items":"Items","receipt.totals":"Totals","receipt.footerMessage":"Footer Message","receipt.autoprint":"Auto Print","notifications.whatsapp":"WhatsApp","notifications.sms":"SMS","notifications.email":"Email","notifications.autoSend":"Auto Send","notifications.enabled":"Enabled","notifications.message":"Message","notifications.template":"Template"},io={en:M_,sw:q_};let _s="en";const Da=new Set;function co(s){_s!==s&&(_s=s,Da.forEach(e=>e()))}function rS(){return _s}function sS(s){return Da.add(s),()=>{Da.delete(s)}}function aS(s,e){let a=(io[_s]||io.en)[s]||s;return e&&Object.entries(e).forEach(([n,o])=>{a=a.replace(new RegExp(`{${n}}`,"g"),String(o))}),a}const Xs=D.createContext(void 0),B_=({children:s})=>{let e;try{e=Lt()}catch(P){return console.warn("Auth context not available yet:",P),f.jsx(Xs.Provider,{value:{settings:null,loading:!1,error:null,applyTheme:()=>{},applyLanguage:()=>{},applyCurrency:()=>{},applyTimezone:()=>{},formatCurrency:O=>`$${O.toFixed(2)}`,formatDate:O=>O.toLocaleDateString(),formatTime:O=>O.toLocaleTimeString(),showProductImages:!0,showStockLevels:!0,showPrices:!0,showBarcodes:!0,productsPerPage:20,productsPerRow:4,autoCompleteSearch:!0,confirmDelete:!0,showConfirmations:!0,enableSoundEffects:!0,enableAnimations:!0,refreshSettings:async()=>{}},children:s})}const{isAuthenticated:t}=e,{settings:r,loading:a,error:n,saveSettings:o,updateSettings:i,loadSettings:c,refreshSettings:l}=$_(),[d,u]=D.useState(null),h=P=>{const O=document.documentElement;if(P==="auto"){const N=window.matchMedia("(prefers-color-scheme: dark)").matches;O.classList.toggle("dark",N)}else O.classList.toggle("dark",P==="dark");localStorage.setItem("theme",P)},g=P=>{document.documentElement.lang=P,localStorage.setItem("language",P),co(P),console.log(` Language changed to: ${P==="sw"?"Swahili":P==="fr"?"French":"English"}`)},p=P=>{localStorage.setItem("currency",P)},m=P=>{localStorage.setItem("timezone",P)},_=P=>{const O=document.documentElement;switch(P){case"tiny":O.style.fontSize="11px";break;case"extra-small":O.style.fontSize="12px";break;case"small":O.style.fontSize="14px";break;case"medium":O.style.fontSize="16px";break;case"large":O.style.fontSize="18px";break}localStorage.setItem("fontSize",P)},b=P=>{const O=document.documentElement;O.style.setProperty("--show-product-images",P.show_product_images?"block":"none"),O.style.setProperty("--show-stock-levels",P.show_stock_levels?"block":"none"),O.style.setProperty("--show-prices",P.show_prices?"block":"none"),O.style.setProperty("--show-barcodes",P.show_barcodes?"block":"none")},S=P=>{const O=document.documentElement;localStorage.setItem("autoCompleteSearch",P.auto_complete_search.toString()),localStorage.setItem("confirmDelete",P.confirm_delete.toString()),localStorage.setItem("showConfirmations",P.show_confirmations.toString()),localStorage.setItem("enableSoundEffects",P.enable_sound_effects.toString()),localStorage.setItem("enableAnimations",P.enable_animations.toString()),O.setAttribute("data-enable-animations",P.enable_animations.toString()),O.setAttribute("data-enable-sounds",P.enable_sound_effects.toString()),O.setAttribute("data-auto-complete",P.auto_complete_search.toString()),O.setAttribute("data-confirm-delete",P.confirm_delete.toString()),O.setAttribute("data-show-confirmations",P.show_confirmations.toString()),P.enable_animations?document.body.classList.remove("animations-disabled"):document.body.classList.add("animations-disabled")},v=P=>{localStorage.setItem("enableCaching",P.enable_caching.toString()),localStorage.setItem("cacheDuration",P.cache_duration.toString()),localStorage.setItem("enableLazyLoading",P.enable_lazy_loading.toString()),localStorage.setItem("maxSearchResults",P.max_search_results.toString())},C=P=>{h(P.theme),g(P.language),p(P.currency),m(P.timezone),P.font_size&&_(P.font_size),b(P),S(P),v(P)};if(D.useEffect(()=>{r&&(u(r),C(r))},[r]),D.useEffect(()=>{const P=localStorage.getItem("fontSize");P&&_(P);const O=localStorage.getItem("language");O&&(co(O),console.log(` Initialized language from localStorage: ${O==="sw"?"Swahili":O==="fr"?"French":"English"}`))},[]),D.useEffect(()=>{const P=$=>{$.detail.type==="general"&&(console.log(" Settings updated event received, reloading..."),c())},O=$=>{$.detail.type==="general"&&(console.log(" General settings saved event received:",$.detail.settings),$.detail.settings&&(u($.detail.settings),C($.detail.settings)))},N=$=>{$.detail.type==="general"&&(console.log(" General settings loaded event received:",$.detail.settings),$.detail.settings&&(u($.detail.settings),C($.detail.settings)))};return window.addEventListener("settingsUpdated",P),window.addEventListener("settingsSaved",O),window.addEventListener("posSettingsLoaded",N),()=>{window.removeEventListener("settingsUpdated",P),window.removeEventListener("settingsSaved",O),window.removeEventListener("posSettingsLoaded",N)}},[c]),!t)return f.jsx(Xs.Provider,{value:{settings:null,loading:!0,error:null,applyTheme:()=>{},applyLanguage:()=>{},applyCurrency:()=>{},applyTimezone:()=>{},formatCurrency:P=>P.toString(),formatDate:P=>P.toLocaleDateString(),formatTime:P=>P.toLocaleTimeString(),showProductImages:!0,showStockLevels:!0,showPrices:!0,showBarcodes:!0,productsPerPage:20,productsPerRow:4,autoCompleteSearch:!0,confirmDelete:!0,showConfirmations:!0,enableSoundEffects:!0,enableAnimations:!0,refreshSettings:async()=>{}},children:s});const k={settings:d,loading:a,error:n,applyTheme:h,applyLanguage:g,applyCurrency:p,applyTimezone:m,formatCurrency:P=>{const O=(d==null?void 0:d.currency)||"TZS",N=(d==null?void 0:d.language)==="sw"?"sw-TZ":"en-TZ";return new Intl.NumberFormat(N,{style:"currency",currency:O,minimumFractionDigits:0,maximumFractionDigits:0}).format(P)},formatDate:P=>{d!=null&&d.date_format;const O=(d==null?void 0:d.language)==="sw"?"sw-TZ":"en-TZ",N={year:"numeric",month:"2-digit",day:"2-digit"};return new Intl.DateTimeFormat(O,N).format(P)},formatTime:P=>{const O=(d==null?void 0:d.time_format)||"24",N=(d==null?void 0:d.language)==="sw"?"sw-TZ":"en-TZ",$={hour:"2-digit",minute:"2-digit",hour12:O==="12"};return new Intl.DateTimeFormat(N,$).format(P)},showProductImages:(d==null?void 0:d.show_product_images)??!0,showStockLevels:(d==null?void 0:d.show_stock_levels)??!0,showPrices:(d==null?void 0:d.show_prices)??!0,showBarcodes:(d==null?void 0:d.show_barcodes)??!0,productsPerPage:(d==null?void 0:d.products_per_page)??20,productsPerRow:(d==null?void 0:d.products_per_row)??4,autoCompleteSearch:(d==null?void 0:d.auto_complete_search)??!0,confirmDelete:(d==null?void 0:d.confirm_delete)??!0,showConfirmations:(d==null?void 0:d.show_confirmations)??!0,enableSoundEffects:(d==null?void 0:d.enable_sound_effects)??!0,enableAnimations:(d==null?void 0:d.enable_animations)??!0,refreshSettings:l};return f.jsx(Xs.Provider,{value:k,children:s})};function Ft(s){return{...s,payment_icon:s.icon||s.payment_icon,payment_color:s.color||s.payment_color,payment_description:s.description||s.payment_description,balance:typeof s.balance=="string"?parseFloat(s.balance)||0:s.balance||0}}class F_{constructor(){this.supabase=w}async getPaymentMethods(){try{console.log(" FinanceAccountService: Fetching payment methods (deduplicated)..."),console.log(" FinanceAccountService: Supabase client:",!!w);const e=await E_();return console.log(" FinanceAccountService: Query result:",{data:(e==null?void 0:e.length)||0}),console.log(" FinanceAccountService: Fetched payment methods:",(e==null?void 0:e.length)||0),e&&e.length>0&&console.log(" FinanceAccountService: First method:",{id:e[0].id,name:e[0].name,type:e[0].type}),(e||[]).map(Ft)}catch(e){return console.error(" Exception fetching payment methods:",e),[]}}async getActiveFinanceAccounts(){try{const e=w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("is_active",!0).order("name"),t=await Ct(e,"accounts"),{data:r,error:a}=await t;if(a)throw a;return r&&r.length>0&&console.log(` Fetched ${r.length} finance accounts with branch filtering`),(r||[]).map(Ft)}catch(e){return console.error("Error fetching finance accounts:",e),[]}}async getFinanceAccountsByType(e){try{const t=w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("type",e).eq("is_active",!0).order("name"),r=await Ct(t,"accounts"),{data:a,error:n}=await r;if(n)throw n;return(a||[]).map(Ft)}catch(t){return console.error("Error fetching finance accounts by type:",t),[]}}async getFinanceAccountById(e){try{const{data:t,error:r}=await w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("id",e).eq("is_active",!0).single();if(r)throw r;return t?(console.log(` Fetched account ${t.name}: branch_id=${t.branch_id||"NULL (shared)"}, is_shared=${t.is_shared}`),Ft(t)):null}catch(t){return console.error("Error fetching finance account by ID:",t),null}}async getFinanceAccountsWithStats(){try{const{data:e,error:t}=await w.from("finance_accounts").select(`
          *,
          payment_transactions(
            id
          )
        `).eq("is_active",!0).order("name");if(t)throw t;return(e==null?void 0:e.map(a=>{var n,o;return{...a,transaction_count:((n=a.payment_transactions)==null?void 0:n.length)||0,total_transactions:((o=a.payment_transactions)==null?void 0:o.length)||0}}))||[]}catch(e){return console.error("Error fetching finance accounts with stats:",e),[]}}async getDefaultPaymentMethod(){try{const{data:e,error:t}=await w.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0).eq("type","cash").order("created_at",{ascending:!0}).limit(1).single();if(t)throw t;return e}catch(e){return console.error("Error fetching default payment method:",e),null}}async getPOSPaymentMethods(){try{const e=w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("is_active",!0).eq("is_payment_method",!0).in("type",["cash","mobile_money","credit_card"]).order("name"),t=await Ct(e,"accounts"),{data:r,error:a}=await t;if(a)throw a;return(r||[]).map(Ft)}catch(e){return console.error("Error fetching POS payment methods:",e),[]}}async getFinancePaymentMethods(){try{const e=w.from("finance_accounts").select("id, name, type, balance, account_number, bank_name, currency, is_active, is_payment_method, icon, color, description, requires_reference, requires_account_number, notes, branch_id, is_shared, created_at, updated_at").eq("is_active",!0).eq("is_payment_method",!0).in("type",["bank","savings","investment"]).order("name"),t=await Ct(e,"accounts"),{data:r,error:a}=await t;if(a)throw a;return(r||[]).map(Ft)}catch(e){return console.error("Error fetching finance payment methods:",e),[]}}async createFinanceAccount(e){try{const{data:t,error:r}=await w.from("finance_accounts").insert([e]).select().single();if(r)throw r;return t}catch(t){return console.error("Error creating finance account:",t),null}}async testUpdateField(e,t,r){try{console.log(` Testing update of field '${t}' with value:`,r);const{data:a,error:n}=await w.from("finance_accounts").update({[t]:r}).eq("id",e).select("*").single();return n?(console.error(` Error updating field '${t}':`,n),null):(console.log(` Successfully updated field '${t}'`),a)}catch(a){return console.error(` Exception updating field '${t}':`,a),null}}async updateFinanceAccount(e,t){var r,a,n,o,i;try{console.log(" Updating finance account:",{id:e,updates:t});const{data:{user:c},error:l}=await w.auth.getUser();console.log(" Authentication status:",{user:c?{id:c.id,email:c.email}:null,authError:l==null?void 0:l.message}),console.log(" Supabase request details:",{table:"finance_accounts",operation:"update",id:e,updates:JSON.stringify(t,null,2)}),console.log(" Attempting update with data:",JSON.stringify(t,null,2));const{data:d,error:u}=await w.from("finance_accounts").update(t).eq("id",e).select("*").single();if(u)throw console.error(" Supabase error updating finance account:",u),console.error(" Error details:",{message:u.message,details:u.details,hint:u.hint,code:u.code}),console.error(" Request data that caused error:",t),console.error(" Full error object:",JSON.stringify(u,null,2)),(r=u.message)!=null&&r.includes("column")&&console.error(" Column-related error - check if all columns exist"),(a=u.message)!=null&&a.includes("type")&&console.error(" Data type error - check field types"),(n=u.message)!=null&&n.includes("constraint")&&console.error(" Constraint error - check field values"),((o=u.message)!=null&&o.includes("permission")||(i=u.message)!=null&&i.includes("policy"))&&console.error(" Permission/RLS error - check user permissions"),u;return console.log(" Successfully updated finance account:",d),d}catch(c){console.error(" Error updating finance account:",c),c instanceof Error&&console.error(" Error details:",{name:c.name,message:c.message,stack:c.stack});try{const l=JSON.parse(c.message);console.error(" Parsed error:",l)}catch{console.error(" Raw error message:",c.message)}return null}}async deleteFinanceAccount(e){try{const{error:t}=await w.from("finance_accounts").delete().eq("id",e);if(t)throw t;return!0}catch(t){return console.error("Error deleting finance account:",t),!1}}async getFinanceAccountStats(){try{const e=await this.getActiveFinanceAccounts();return{total:e.length,byType:e.reduce((r,a)=>(r[a.type]=(r[a.type]||0)+1,r),{}),active:e.filter(r=>r.is_active).length,totalBalance:e.reduce((r,a)=>r+Number(a.balance),0),paymentMethods:e.filter(r=>r.is_payment_method).length}}catch(e){return console.error("Error getting finance account stats:",e),{total:0,byType:{},active:0,totalBalance:0,paymentMethods:0}}}getIconForAccountType(e){switch(e){case"bank":return"building";case"cash":return"dollar-sign";case"mobile_money":return"smartphone";case"credit_card":return"credit-card";case"savings":return"piggy-bank";case"investment":return"trending-up";default:return"credit-card"}}getColorForAccountType(e){switch(e){case"bank":return"#059669";case"cash":return"#10B981";case"mobile_money":return"#DC2626";case"credit_card":return"#3B82F6";case"savings":return"#F59E0B";case"investment":return"#10B981";default:return"#3B82F6"}}}async function z_(s){try{const{data:e,error:t}=await w.from("finance_accounts").select("*").eq("id",s).eq("is_active",!0).single();return t||!e?(console.error("Error fetching account balance before storage:",t),{balance:0,accountData:null,isValid:!1}):{balance:Number(e.balance)||0,accountData:e,isValid:!0}}catch(e){return console.error("Exception fetching account balance before storage:",e),{balance:0,accountData:null,isValid:!1}}}function V_(s,e,t="payment"){const r=Math.abs(e);return e>0?{isValid:!0,newBalance:Math.max(0,s+e)}:r>s?{isValid:!1,newBalance:0,warning:`Transaction amount (${r}) exceeds available balance (${s}). Balance will be set to 0.`}:{isValid:!0,newBalance:Math.max(0,s-r)}}const Ta=new F_,nS=Object.freeze(Object.defineProperty({__proto__:null,financeAccountService:Ta,getAccountBalanceBeforeStorage:z_,validateBalanceBeforeTransaction:V_},Symbol.toStringTag,{value:"Module"})),Vc=D.createContext(void 0),oS=()=>{const s=D.useContext(Vc);return s||(console.warn(" usePaymentMethodsContext called outside PaymentMethodsProvider, using defaults"),{paymentMethods:[],loading:!1,error:null,refreshPaymentMethods:async()=>{},getPaymentMethodById:()=>{},getPaymentMethodsByType:()=>[]})},G_=({children:s})=>{const[e,t]=D.useState([]),[r,a]=D.useState(!0),[n,o]=D.useState(null),[i,c]=D.useState(!1),l=D.useCallback(async()=>{var g,p,m,_;try{a(!0),o(null),console.log(" PaymentMethodsContext: Starting to load payment methods...");const b=await Ta.getPaymentMethods();console.log(" PaymentMethodsContext: Loaded payment methods:",b),t(b),console.log(" Payment methods refreshed:",b.length)}catch(b){const S=(g=b==null?void 0:b.message)!=null&&g.includes("ERR_CONNECTION_CLOSED")||(p=b==null?void 0:b.message)!=null&&p.includes("Failed to fetch")?"Connection issue. Using cached data.":"Failed to fetch payment methods";o(S),console.error("Error refreshing payment methods:",b),!((m=b==null?void 0:b.message)!=null&&m.includes("ERR_CONNECTION_CLOSED"))&&!((_=b==null?void 0:b.message)!=null&&_.includes("Failed to fetch"))&&t([])}finally{a(!1)}},[]),d=D.useCallback(g=>e.find(p=>p.id===g),[e]),u=D.useCallback(g=>e.filter(p=>p.type===g),[e]);D.useEffect(()=>{console.log(" PaymentMethodsContext: Starting initial load..."),l()},[l]),D.useEffect(()=>{let g,p,m=0;const _=3,b=5e3;let S=!1,v=!1,C=0;const T=3e3;let x;const R=()=>{if(i){console.log(" Payment methods: Subscription disabled, skipping setup");return}const P=Date.now();if(v||P-C<T){console.log(" Payment methods: Connection cooldown active, skipping setup");return}try{if(v=!0,C=P,g)try{g.unsubscribe()}catch(O){console.warn("Warning during channel unsubscribe:",O)}g=Ta.supabase.channel("payment_methods_changes").on("postgres_changes",{event:"*",schema:"public",table:"finance_accounts",filter:"is_payment_method=eq.true"},O=>{console.log(" Payment methods changed:",O.eventType),clearTimeout(x),x=setTimeout(()=>{l()},2e3)}).subscribe(O=>{if(console.log(" Payment methods subscription status:",O),v=!1,O==="SUBSCRIBED")m=0,S=!0,console.log(" Payment methods subscription established successfully");else if(O==="CLOSED"||O==="CHANNEL_ERROR")if(S=!1,console.warn(` Payment methods subscription ${O.toLowerCase()}`),m<_){m++;const N=Math.min(b*Math.pow(1.5,m-1),3e4);console.log(` Attempting reconnection ${m}/${_} in ${N/1e3}s...`),setTimeout(()=>{!S&&!v&&R()},N)}else console.error(" Max reconnection attempts reached, disabling payment methods subscription"),c(!0),ge.error("Payment methods subscription disabled. Data will refresh manually.")})}catch(O){if(console.error(" Error setting up payment methods subscription:",O),S=!1,v=!1,m<_){m++;const N=Math.min(b*Math.pow(1.5,m-1),3e4);setTimeout(()=>{!S&&!v&&R()},N)}else console.error(" Max reconnection attempts reached, disabling payment methods subscription"),c(!0)}},k=setTimeout(()=>{R()},2e3);return()=>{if(clearTimeout(k),clearTimeout(p),clearTimeout(x),S=!1,v=!1,g)try{g.unsubscribe()}catch(P){console.warn("Warning during cleanup unsubscribe:",P)}}},[l,i]);const h={paymentMethods:e,loading:r,error:n,refreshPaymentMethods:l,getPaymentMethodById:d,getPaymentMethodsByType:u};return f.jsx(Vc.Provider,{value:h,children:s})},Gc=D.createContext(void 0),Wc=()=>{const s=D.useContext(Gc);if(!s)throw new Error("useError must be used within an ErrorProvider");return s},W_=({children:s,maxErrors:e=50})=>{const[t,r]=D.useState([]),[a,n]=D.useState(null),[o,i]=D.useState(!1),[c,l]=D.useState(!1),d=D.useCallback(m=>{var v;const _=`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,b={id:_,title:m.title||"An error occurred",message:m.message||"An unexpected error occurred",code:m.code,type:m.type||"unknown",severity:m.severity||"medium",timestamp:new Date,context:m.context,stack:m.stack,fixSuggestions:m.fixSuggestions||[],technicalDetails:m.technicalDetails,affectedFeature:m.affectedFeature};r(C=>[b,...C].slice(0,e)),n(b),(b.severity==="high"||b.severity==="critical")&&i(!0);const S=`${b.title}: ${b.message}`;return b.severity==="critical"?ge.error(S,{duration:6e3}):b.severity==="high"?ge.error(S,{duration:4e3}):b.severity==="medium"?ge.error(S,{duration:3e3}):ge(S,{duration:2e3}),console.group(` ${b.severity.toUpperCase()} Error: ${b.title}`),console.error("Message:",b.message),console.error("Type:",b.type),console.error("Code:",b.code),console.error("Context:",b.context),b.technicalDetails&&console.error("Technical Details:",b.technicalDetails),b.stack&&console.error("Stack:",b.stack),(v=b.fixSuggestions)!=null&&v.length&&console.info(" Fix Suggestions:",b.fixSuggestions),console.groupEnd(),_},[e]),u=D.useCallback(m=>{r(_=>_.filter(b=>b.id!==m)),n(_=>(_==null?void 0:_.id)===m?null:_)},[]),h=D.useCallback(()=>{r([]),n(null),i(!1)},[]),g=D.useCallback(m=>t.filter(_=>_.type===m),[t]),p={errors:t,currentError:a,addError:d,removeError:u,clearErrors:h,getErrorsByType:g,showErrorPanel:o,setShowErrorPanel:i,showDiagnostics:c,setShowDiagnostics:l};return f.jsx(Gc.Provider,{value:p,children:s})},Hc=D.createContext(void 0),iS=()=>{const s=D.useContext(Hc);if(!s)throw new Error("useGlobalSearchModal must be used within a GlobalSearchProvider");return s},H_=({children:s})=>{const[e,t]=D.useState(!1),[r,a]=D.useState(""),n=D.useCallback((i="")=>{a(i),t(!0)},[]),o=D.useCallback(()=>{t(!1),a("")},[]);return f.jsx(Hc.Provider,{value:{isOpen:e,initialQuery:r,openSearch:n,closeSearch:o},children:s})},Q_=({error:s,onClose:e,onRetry:t})=>{const{currentError:r,removeError:a,setShowErrorPanel:n}=Wc(),[o,i]=D.useState(0),[c,l]=D.useState(!1),d=s||r;if(!d)return null;const u=()=>{e?e():(n(!1),a(d.id))},h=(_,b="text")=>{navigator.clipboard.writeText(_),ge.success(`${b} copied to clipboard!`)},g=_=>{switch(_){case"critical":return"border-red-500 bg-red-50";case"high":return"border-orange-500 bg-orange-50";case"medium":return"border-yellow-500 bg-yellow-50";case"low":return"border-blue-500 bg-blue-50";default:return"border-gray-500 bg-gray-50"}},p=_=>{switch(_){case"critical":return f.jsx(Jt,{className:"w-6 h-6 text-red-600"});case"high":return f.jsx(Dl,{className:"w-6 h-6 text-orange-600"});case"medium":return f.jsx(Jt,{className:"w-6 h-6 text-yellow-600"});case"low":return f.jsx(Cl,{className:"w-6 h-6 text-blue-600"});default:return f.jsx(Jt,{className:"w-6 h-6 text-gray-600"})}},m=_=>({database:"Database Error",network:"Network Error",validation:"Validation Error",auth:"Authentication Error",api:"API Error",unknown:"Error"})[_]||"Error";return f.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200",children:f.jsxs("div",{className:`
          relative w-full max-w-3xl max-h-[90vh] overflow-hidden
          bg-white rounded-2xl shadow-2xl border-2 
          ${g(d.severity)}
          animate-in slide-in-from-bottom duration-300
        `,children:[f.jsx("div",{className:"sticky top-0 z-10 bg-white border-b px-6 py-4",children:f.jsxs("div",{className:"flex items-start justify-between gap-4",children:[f.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[p(d.severity),f.jsxs("div",{className:"flex-1",children:[f.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[f.jsx("h2",{className:"text-xl font-bold text-gray-900",children:d.title}),d.code&&f.jsx("span",{className:"px-2 py-0.5 text-xs font-mono font-semibold bg-gray-200 text-gray-700 rounded",children:d.code})]}),f.jsx("p",{className:"text-sm text-gray-600",children:m(d.type)})]})]}),f.jsx("button",{onClick:u,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Close",children:f.jsx(Co,{className:"w-5 h-5 text-gray-500"})})]})}),f.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-140px)] px-6 py-6",children:[f.jsxs("div",{className:"mb-6 p-4 bg-white rounded-lg border border-gray-200 shadow-sm",children:[f.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-2",children:"What happened?"}),f.jsx("p",{className:"text-gray-900",children:d.message}),d.context&&f.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[f.jsx("span",{className:"font-medium",children:"Context:"})," ",d.context]})]}),d.fixSuggestions&&d.fixSuggestions.length>0&&f.jsxs("div",{className:"mb-6",children:[f.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-3 flex items-center gap-2",children:[f.jsx(Al,{className:"w-5 h-5 text-yellow-500"}),"How to fix this"]}),f.jsx("div",{className:"space-y-3",children:d.fixSuggestions.map((_,b)=>f.jsx(K_,{suggestion:_,index:b,isExpanded:o===b,onToggle:()=>i(o===b?null:b)},b))})]}),d.technicalDetails&&f.jsxs("div",{className:"mb-4",children:[f.jsxs("button",{onClick:()=>l(!c),className:"flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-gray-900 transition-colors",children:[f.jsx(aa,{className:"w-4 h-4"}),"Technical Details",c?f.jsx(Do,{className:"w-4 h-4"}):f.jsx(na,{className:"w-4 h-4"})]}),c&&f.jsxs("div",{className:"mt-3 p-4 bg-gray-900 rounded-lg overflow-x-auto",children:[f.jsx("pre",{className:"text-xs text-gray-100 font-mono",children:JSON.stringify(d.technicalDetails,null,2)}),f.jsxs("button",{onClick:()=>h(JSON.stringify(d.technicalDetails,null,2),"Technical details"),className:"mt-2 px-3 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-white rounded flex items-center gap-1",children:[f.jsx(To,{className:"w-3 h-3"}),"Copy"]})]})]}),d.stack&&f.jsx("div",{className:"mb-4",children:f.jsxs("details",{className:"group",children:[f.jsxs("summary",{className:"cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900 flex items-center gap-2",children:[f.jsx(aa,{className:"w-4 h-4"}),"Stack Trace",f.jsx(na,{className:"w-4 h-4 group-open:rotate-180 transition-transform"})]}),f.jsx("div",{className:"mt-3 p-4 bg-gray-900 rounded-lg overflow-x-auto",children:f.jsx("pre",{className:"text-xs text-gray-100 font-mono whitespace-pre-wrap",children:d.stack})})]})}),f.jsxs("div",{className:"text-xs text-gray-500",children:["Error occurred at: ",new Date(d.timestamp).toLocaleString()]})]}),f.jsxs("div",{className:"sticky bottom-0 z-10 bg-white border-t px-6 py-4 flex gap-3",children:[t&&f.jsxs("button",{onClick:()=>{t(),u()},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center gap-2 transition-colors",children:[f.jsx(tr,{className:"w-4 h-4"}),"Retry"]}),f.jsx("button",{onClick:u,className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors",children:"Close"}),f.jsxs("a",{href:"https://www.postgresql.org/docs/current/errcodes-appendix.html",target:"_blank",rel:"noopener noreferrer",className:"ml-auto px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center gap-2 transition-colors",children:[f.jsx(kl,{className:"w-4 h-4"}),"PostgreSQL Docs"]})]})]})})},K_=({suggestion:s,index:e,isExpanded:t,onToggle:r})=>{const[a,n]=D.useState(!1),o=async()=>{if(s.onAutoFix){n(!0);try{await s.onAutoFix(),ge.success("Auto-fix applied successfully!")}catch{ge.error("Auto-fix failed. Please apply manually.")}finally{n(!1)}}},i=c=>{navigator.clipboard.writeText(c),ge.success("SQL copied to clipboard!")};return f.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow",children:[f.jsxs("button",{onClick:r,className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[f.jsxs("div",{className:"flex items-center gap-3 text-left",children:[f.jsx("span",{className:"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-sm font-bold",children:e+1}),f.jsxs("div",{children:[f.jsx("h4",{className:"font-semibold text-gray-900",children:s.title}),f.jsx("p",{className:"text-sm text-gray-600",children:s.description})]})]}),f.jsxs("div",{className:"flex items-center gap-2",children:[s.autoFixAvailable&&f.jsx("span",{className:"px-2 py-1 text-xs bg-green-100 text-green-700 rounded font-medium",children:"Auto-fix"}),t?f.jsx(Do,{className:"w-5 h-5 text-gray-400"}):f.jsx(na,{className:"w-5 h-5 text-gray-400"})]})]}),t&&f.jsxs("div",{className:"px-4 py-4 border-t border-gray-100 bg-gray-50",children:[f.jsxs("div",{className:"mb-4",children:[f.jsxs("h5",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[f.jsx(Il,{className:"w-4 h-4"}),"Steps to fix:"]}),f.jsx("ol",{className:"space-y-2",children:s.steps.map((c,l)=>f.jsxs("li",{className:"flex gap-2 text-sm text-gray-700",children:[f.jsx("span",{className:"flex-shrink-0 w-5 h-5 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-bold",children:l+1}),f.jsx("span",{children:c})]},l))})]}),s.sqlFix&&f.jsxs("div",{className:"mb-4",children:[f.jsxs("h5",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[f.jsx(aa,{className:"w-4 h-4"}),"SQL Fix:"]}),f.jsxs("div",{className:"relative",children:[f.jsx("pre",{className:"p-3 bg-gray-900 text-gray-100 rounded-lg text-xs font-mono overflow-x-auto",children:s.sqlFix}),f.jsx("button",{onClick:()=>i(s.sqlFix),className:"absolute top-2 right-2 p-2 bg-gray-800 hover:bg-gray-700 rounded text-white transition-colors",title:"Copy SQL",children:f.jsx(To,{className:"w-3 h-3"})})]})]}),s.autoFixAvailable&&s.onAutoFix&&f.jsx("button",{onClick:o,disabled:a,className:"w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors",children:a?f.jsxs(f.Fragment,{children:[f.jsx(tr,{className:"w-4 h-4 animate-spin"}),"Applying fix..."]}):f.jsxs(f.Fragment,{children:[f.jsx(Ro,{className:"w-4 h-4"}),"Apply Auto-fix"]})})]})]})},J_=()=>{const{showErrorPanel:s,currentError:e}=Wc();return f.jsx(f.Fragment,{children:s&&e&&f.jsx(Q_,{})})};async function Y_(s,e){try{const{count:t}=await w.from(s).select("*",{count:"exact",head:!0}),{count:r}=await w.from(s).select("*",{count:"exact",head:!0}).eq("branch_id",e),{count:a}=await w.from(s).select("*",{count:"exact",head:!0}).neq("branch_id",e).not("branch_id","is",null),{count:n}=await w.from(s).select("*",{count:"exact",head:!0}).is("branch_id",null),{data:o}=await w.from(s).select("id, branch_id, name, created_at").neq("branch_id",e).not("branch_id","is",null).limit(100);return{table:s,totalRecords:t||0,currentBranchRecords:r||0,otherBranchRecords:a||0,unassignedRecords:n||0,recordsToCleanup:o||[]}}catch(t){return console.error(` Error analyzing ${s}:`,t.message),{table:s,totalRecords:0,currentBranchRecords:0,otherBranchRecords:0,unassignedRecords:0,recordsToCleanup:[]}}}async function X_(){const s=Ue();if(!s)throw new Error("No branch selected. Please select a branch first.");const e=await Te(s);if(!e)throw new Error("Branch settings not found");const t=["lats_products","customers","lats_suppliers","lats_categories"],r=[];for(const n of t){const o=await Y_(n,s);r.push(o)}const a=r.reduce((n,o)=>n+o.otherBranchRecords,0);return r.reduce((n,o)=>n+o.unassignedRecords,0),a>0&&e.data_isolation_mode,r}async function Z_(s,e,t){const r=[];let a=0;try{const{data:n,error:o}=await w.from(s).select("id, branch_id").neq("branch_id",e).not("branch_id","is",null);if(o)return r.push(`Failed to fetch records: ${o.message}`),{success:!1,affected:0,errors:r};if(!n||n.length===0)return{success:!0,affected:0,errors:[]};if(t.dryRun)return{success:!0,affected:n.length,errors:[]};if(t.action==="delete"){const i=n.map(l=>l.id),{error:c}=await w.from(s).delete().in("id",i);if(c)return r.push(`Failed to delete records: ${c.message}`),{success:!1,affected:0,errors:r};a=i.length}else if(t.action==="reassign"){const i=n.map(l=>l.id),{error:c}=await w.from(s).update({branch_id:e}).in("id",i);if(c)return r.push(`Failed to reassign records: ${c.message}`),{success:!1,affected:0,errors:r};a=i.length}return{success:!0,affected:a,errors:[]}}catch(n){return r.push(`Exception: ${n.message}`),{success:!1,affected:0,errors:r}}}async function ey(s){const e=Ue();if(!e)throw new Error("No branch selected. Please select a branch first.");const t=await Te(e);if(!t)throw new Error("Branch settings not found");if(t.data_isolation_mode!=="isolated"&&console.warn("  Branch is not in ISOLATED mode. Cleanup may not be necessary."),s.confirmationRequired&&!s.dryRun)return;const r=["lats_products","customers","lats_suppliers","lats_categories"];let a=0;const n=[];for(const o of r){const i=await Z_(o,e,s);a+=i.affected,n.push(...i.errors)}n.length>0&&n.forEach(o=>console.error(`   - ${o}`))}typeof window<"u"&&(window.analyzeBranchData=X_,window.cleanupBranchData=ey);const ty="pos-error-logs",ry=1,Ke="error_logs",lo=1e4,sy=90;class ay{constructor(){this.db=null,this.originalConsoleError=console.error.bind(console)}async init(){return this.db?this.db:(this.db=await Ka(ty,ry,{upgrade(e){if(!e.objectStoreNames.contains(Ke)){const t=e.createObjectStore(Ke,{keyPath:"id",autoIncrement:!0});t.createIndex("timestamp","timestamp"),t.createIndex("module","module"),t.createIndex("errorType","errorType"),t.createIndex("severity","severity"),t.createIndex("resolved","resolved"),t.createIndex("userId","userId")}}}),console.log(" [ErrorLogger] Error log database initialized"),this.db)}async logError(e){try{const t=await this.init(),r={...e,timestamp:new Date().toISOString(),resolved:!1},a=await t.add(Ke,r),n=this.getSeverityEmoji(e.severity);return console.log(`${n} [ErrorLogger] ${e.module}.${e.function}:`,e.errorMessage,{type:e.errorType,severity:e.severity,operation:e.operation,context:e.operationContext}),this.cleanupOldLogs().catch(o=>console.warn(" [ErrorLogger] Cleanup failed:",o)),a}catch(t){console.log(" [ErrorLogger] Failed to log error:",t),console.log("Original error:",e);return}}async logCacheError(e,t,r,a,n){const o=r instanceof Error?r.message:String(r),i=r instanceof Error?r.stack:void 0;let c="unknown";o.includes("network")||o.includes("fetch")?c="network":o.includes("quota")||o.includes("storage")?c="storage":o.includes("sync")?c="sync":o.includes("validation")||o.includes("invalid")?c="validation":c="logical";let l="medium";o.includes("critical")||o.includes("fatal")?l="critical":o.includes("quota exceeded")||o.includes("sync failed")?l="high":(o.includes("warning")||o.includes("retry"))&&(l="low");const d=localStorage.getItem("userId")||void 0,u=localStorage.getItem("userName")||void 0,h=localStorage.getItem("userRole")||void 0,g=localStorage.getItem("selectedBranch")||void 0,p=localStorage.getItem("selectedBranchName")||void 0;return this.logError({module:e,function:t,errorType:c,errorMessage:o,errorStack:i,operation:a,operationContext:n,userId:d,userName:u,userRole:h,branchId:g,branchName:p,isOnline:navigator.onLine,severity:l})}async getLogs(e){try{let r=await(await this.init()).getAll(Ke);return e&&(e.module&&(r=r.filter(a=>a.module===e.module)),e.errorType&&(r=r.filter(a=>a.errorType===e.errorType)),e.severity&&(r=r.filter(a=>a.severity===e.severity)),e.resolved!==void 0&&(r=r.filter(a=>a.resolved===e.resolved)),e.userId&&(r=r.filter(a=>a.userId===e.userId)),e.startDate&&(r=r.filter(a=>a.timestamp>=e.startDate)),e.endDate&&(r=r.filter(a=>a.timestamp<=e.endDate)),e.limit&&(r=r.slice(0,e.limit))),r.sort((a,n)=>new Date(n.timestamp).getTime()-new Date(a.timestamp).getTime()),r}catch(t){return console.error(" [ErrorLogger] Failed to get logs:",t),[]}}async getLog(e){try{return await(await this.init()).get(Ke,e)}catch(t){console.error(" [ErrorLogger] Failed to get log:",t);return}}async markResolved(e,t,r){try{const a=await this.init(),n=await a.get(Ke,e);if(!n)return console.warn(" [ErrorLogger] Log not found:",e),!1;const o={...n,resolved:!0,resolvedAt:new Date().toISOString(),resolvedBy:t,notes:r};return await a.put(Ke,o),console.log(" [ErrorLogger] Log marked as resolved:",e),!0}catch(a){return console.error(" [ErrorLogger] Failed to mark log as resolved:",a),!1}}async deleteLog(e){try{return await(await this.init()).delete(Ke,e),console.log(" [ErrorLogger] Log deleted:",e),!0}catch(t){return console.error(" [ErrorLogger] Failed to delete log:",t),!1}}async clearAllLogs(){try{return await(await this.init()).clear(Ke),console.log(" [ErrorLogger] All logs cleared"),!0}catch(e){return console.error(" [ErrorLogger] Failed to clear logs:",e),!1}}async getStats(){try{const e=await this.getLogs(),t=Date.now(),r=24*60*60*1e3,a=7*r,n={total:e.length,unresolved:e.filter(o=>!o.resolved).length,resolved:e.filter(o=>o.resolved).length,byModule:{},byType:{},bySeverity:{},last24Hours:e.filter(o=>t-new Date(o.timestamp).getTime()<r).length,last7Days:e.filter(o=>t-new Date(o.timestamp).getTime()<a).length};return e.forEach(o=>{n.byModule[o.module]=(n.byModule[o.module]||0)+1,n.byType[o.errorType]=(n.byType[o.errorType]||0)+1,n.bySeverity[o.severity]=(n.bySeverity[o.severity]||0)+1}),n}catch(e){return console.error(" [ErrorLogger] Failed to get stats:",e),{total:0,unresolved:0,resolved:0,byModule:{},byType:{},bySeverity:{},last24Hours:0,last7Days:0}}}async exportLogs(e){const t=await this.getLogs(e);return JSON.stringify(t,null,2)}async exportLogsCSV(e){const t=await this.getLogs(e);if(t.length===0)return"No logs to export";const r=["ID","Timestamp","Module","Function","Error Type","Severity","Error Message","Operation","User ID","User Name","User Role","Branch ID","Branch Name","Is Online","Resolved","Resolved At","Resolved By","Notes"],a=t.map(n=>[n.id,n.timestamp,n.module,n.function,n.errorType,n.severity,`"${n.errorMessage.replace(/"/g,'""')}"`,n.operation,n.userId||"",n.userName||"",n.userRole||"",n.branchId||"",n.branchName||"",n.isOnline?"Yes":"No",n.resolved?"Yes":"No",n.resolvedAt||"",n.resolvedBy||"",n.notes?`"${n.notes.replace(/"/g,'""')}"`:""]);return[r,...a].map(n=>n.join(",")).join(`
`)}async cleanupOldLogs(){try{const e=await this.init(),t=await e.getAll(Ke),r=new Date;r.setDate(r.getDate()-sy);const a=r.toISOString();let n=0;for(const o of t)o.timestamp<a&&o.id&&(await e.delete(Ke,o.id),n++);if(t.length>lo){const i=t.sort((c,l)=>new Date(c.timestamp).getTime()-new Date(l.timestamp).getTime()).slice(0,t.length-lo);for(const c of i)c.id&&(await e.delete(Ke,c.id),n++)}n>0&&console.log(` [ErrorLogger] Cleaned up ${n} old logs`)}catch(e){console.warn(" [ErrorLogger] Failed to cleanup old logs:",e)}}getSeverityEmoji(e){switch(e){case"critical":return"";case"high":return"";case"medium":return"";case"low":return"";default:return""}}}const Et=new ay;class ny{constructor(){this.autoDownloadEnabled=!1,this.downloadPath="error-logs",this.minSeverityForAutoDownload="high"}configure(e){e.autoDownload!==void 0&&(this.autoDownloadEnabled=e.autoDownload),e.minSeverity!==void 0&&(this.minSeverityForAutoDownload=e.minSeverity)}async exportError(e,t={}){try{const r=t.severity||"medium",a=t.autoDownload===!0,n=this.buildErrorData(e,{severity:r,module:t.module,function:t.function,operation:t.operation,context:t.context});a?(console.warn(" [ErrorExporter] Manual download requested - downloading error file"),this.downloadJSON(n)):console.log(` [ErrorExporter] Error cached (no download): ${n.timestamp}`),this.saveToLocalStorage(n),console.log(` Error cached: ${n.timestamp}`,n)}catch(r){console.error("Failed to export error:",r),this.fallbackExport(e)}}buildErrorData(e,t){const r=new Date().toISOString();let a="Unknown error",n,o="UnknownError";if(e instanceof Error)a=e.message,n=e.stack,o=e.name;else if(typeof e=="string")a=e,o="StringError";else if(e&&typeof e=="object")try{a=JSON.stringify(e),o="ObjectError"}catch{a=String(e)}const i={timestamp:r,errorType:o,severity:t.severity,message:a,stack:n,module:t.module,function:t.function,operation:t.operation,context:t.context,userAgent:navigator.userAgent,url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},online:navigator.onLine,localStorage:this.checkLocalStorage()};if("memory"in performance){const c=performance.memory;i.memoryInfo={usedJSHeapSize:c.usedJSHeapSize,totalJSHeapSize:c.totalJSHeapSize,jsHeapSizeLimit:c.jsHeapSizeLimit}}return i}checkLocalStorage(){try{const e="__ls_test__";return localStorage.setItem(e,"test"),localStorage.removeItem(e),{available:!0,quotaExceeded:!1}}catch(e){return{available:!1,quotaExceeded:e instanceof DOMException&&(e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED")}}}downloadJSON(e){try{const t=new Date(e.timestamp),r=`error-${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${String(t.getHours()).padStart(2,"0")}${String(t.getMinutes()).padStart(2,"0")}${String(t.getSeconds()).padStart(2,"0")}-${e.errorType}-${e.severity}.json`,a=JSON.stringify(e,null,2),n=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=r,i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(o)},100),console.log(` Error downloaded: ${r}`)}catch(t){console.error("Failed to download error JSON:",t)}}saveToLocalStorage(e){try{const t=`error_log_${e.timestamp}`;localStorage.setItem(t,JSON.stringify(e)),this.cleanupOldErrors()}catch(t){console.warn("Failed to save error to localStorage:",t)}}cleanupOldErrors(){try{const e=Object.keys(localStorage).filter(t=>t.startsWith("error_log_")).sort().reverse();e.length>50&&e.slice(50).forEach(t=>{localStorage.removeItem(t)})}catch(e){console.warn("Failed to cleanup old errors:",e)}}fallbackExport(e){try{const t={timestamp:new Date().toISOString(),error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0};console.error("FALLBACK ERROR EXPORT:",t)}catch{console.error("CRITICAL: Failed to export error at all")}}shouldAutoDownload(e){if(!this.autoDownloadEnabled)return!1;const t={low:0,medium:1,high:2,critical:3};return t[e]>=t[this.minSeverityForAutoDownload]}exportAllSavedErrors(){try{const e=Object.keys(localStorage).filter(c=>c.startsWith("error_log_")).sort();if(e.length===0){console.log("No saved errors found");return}const t=e.map(c=>{try{return JSON.parse(localStorage.getItem(c)||"{}")}catch{return null}}).filter(c=>c!==null),r=`all-errors-${new Date().toISOString().split("T")[0]}.json`,a=JSON.stringify(t,null,2),n=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=r,i.style.display="none",document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(o)},100),console.log(` Exported ${t.length} errors to ${r}`)}catch(e){console.error("Failed to export all errors:",e)}}clearSavedErrors(){try{const e=Object.keys(localStorage).filter(t=>t.startsWith("error_log_"));e.forEach(t=>{localStorage.removeItem(t)}),console.log(` Cleared ${e.length} saved errors`)}catch(e){console.error("Failed to clear saved errors:",e)}}getSavedErrorCount(){try{return Object.keys(localStorage).filter(e=>e.startsWith("error_log_")).length}catch{return 0}}}const Zt=new ny;typeof window<"u"&&(window.errorExporter=Zt);class oy{constructor(){this.isInitialized=!1,this.errorCount=0,this.maxErrorsPerMinute=50,this.errorTimestamps=[],this.isLogging=!1,this.originalConsoleError=console.error.bind(console)}init(){if(this.isInitialized){console.warn(" [GlobalErrorHandler] Already initialized");return}console.log(" [GlobalErrorHandler] Initializing global error handlers..."),this.setupPromiseRejectionHandler(),this.setupWindowErrorHandler(),this.setupConsoleErrorInterceptor(),this.setupNetworkErrorHandler(),this.isInitialized=!0,console.log(" [GlobalErrorHandler] Global error handlers initialized")}setupPromiseRejectionHandler(){window.addEventListener("unhandledrejection",e=>{var n,o;e.preventDefault();const t=e.reason,r=t instanceof Error?t.message:String(t),a=r.toLowerCase().includes("cache")||r.toLowerCase().includes("indexed")||r.toLowerCase().includes("storage")||r.toLowerCase().includes("quota");this.shouldLogError()&&(Et.logCacheError("globalErrorHandler","unhandledPromiseRejection",t,"promise_rejection",{type:"unhandled_promise_rejection",isCacheError:a,promise:(n=e.promise)==null?void 0:n.toString()}).catch(i=>{this.originalConsoleError("Failed to log unhandled rejection:",i)}),Zt.exportError(t,{severity:"high",module:"globalErrorHandler",function:"unhandledPromiseRejection",operation:"promise_rejection",context:{isCacheError:a,promise:(o=e.promise)==null?void 0:o.toString()}}).catch(i=>{this.originalConsoleError("Failed to cache error:",i)})),this.originalConsoleError(" Unhandled Promise Rejection:",t)})}setupWindowErrorHandler(){window.addEventListener("error",e=>{const t=e.error||new Error(e.message),r=e.message||t.message;if(this.isExternalError(e))return;const a=r.toLowerCase().includes("cache")||r.toLowerCase().includes("indexed")||r.toLowerCase().includes("storage")||r.toLowerCase().includes("quota")||r.toLowerCase().includes("sync");this.shouldLogError()&&a&&(Et.logCacheError("globalErrorHandler","windowError",t,"runtime_error",{type:"window_error",filename:e.filename,lineno:e.lineno,colno:e.colno,isCacheError:a}).catch(n=>{this.originalConsoleError("Failed to log window error:",n)}),Zt.exportError(t,{severity:"high",module:"globalErrorHandler",function:"windowError",operation:"runtime_error",context:{filename:e.filename,lineno:e.lineno,colno:e.colno,isCacheError:a}}).catch(n=>{this.originalConsoleError("Failed to cache error:",n)}))})}setupConsoleErrorInterceptor(){console.error=(...e)=>{if(this.originalConsoleError(...e),this.isLogging)return;const t=e[0];if(typeof t=="string"&&t.includes("[ErrorLogger]"))return;let r="",a=null;t instanceof Error?(a=t,r=t.message):typeof t=="string"?(r=t,a=new Error(r)):(r=JSON.stringify(t),a=new Error(r));const n=e.map(h=>{if(h instanceof Error)return h.message;if(typeof h=="object")try{return JSON.stringify(h)}catch{return String(h)}return String(h)}).join(" "),o=r.includes("The above error occurred")&&r.includes("component tree from scratch"),i=["cache","indexed","quota"],c=["localstorage","sessionstorage","indexeddb","storage api","storage quota"],l=["sync","offline"],d=n.toLowerCase(),u=(i.some(h=>d.includes(h))||c.some(h=>d.includes(h))||l.some(h=>d.includes(h)))&&!(d.includes("storageprovider")||d.includes("storagecontext")||d.includes("storagelocation"));o&&!u||this.shouldLogError()&&u&&a&&(this.isLogging=!0,Et.logCacheError("globalErrorHandler","consoleError",a,"console_error",{type:"console_error",arguments:e.slice(1).map(h=>typeof h=="object"?JSON.stringify(h):String(h)),isCacheRelated:u,fullMessage:n.substring(0,500)}).catch(h=>{this.originalConsoleError("Failed to log console error:",h)}).finally(()=>{this.isLogging=!1}),Zt.exportError(a,{severity:"medium",module:"globalErrorHandler",function:"consoleError",operation:"console_error",context:{arguments:e.slice(1).map(h=>typeof h=="object"?JSON.stringify(h):String(h)),isCacheRelated:u,fullMessage:n.substring(0,500)}}).catch(h=>{this.originalConsoleError("Failed to cache error:",h)}))}}setupNetworkErrorHandler(){const e=window.fetch;window.fetch=async(...t)=>{try{const r=await e(...t);if(!r.ok&&this.shouldLogError()){const a=typeof t[0]=="string"?t[0]:t[0].url,n=a.includes("cache")||a.includes("sync")||a.includes("offline");n&&Et.logCacheError("globalErrorHandler","fetchError",new Error(`HTTP ${r.status}: ${r.statusText}`),"network_error",{type:"fetch_error",url:a,status:r.status,statusText:r.statusText,isCacheRelated:n}).catch(o=>{this.originalConsoleError("Failed to log fetch error:",o)})}return r}catch(r){const a=typeof t[0]=="string"?t[0]:t[0].url,n=typeof a=="string"&&(a.includes("/media/")||a.includes(".jpg")||a.includes(".jpeg")||a.includes(".png")||a.includes(".gif")||a.includes(".webp")||a.includes("wasenderapi.com/media")),o=r instanceof TypeError&&(r.message.includes("Failed to fetch")||r.message.includes("CORS")||r.message.includes("network"));if(n&&o)throw r;if(this.shouldLogError()){const i=a.includes("cache")||a.includes("sync")||a.includes("offline");i&&Et.logCacheError("globalErrorHandler","fetchException",r,"network_error",{type:"fetch_exception",url:a,isCacheRelated:i}).catch(c=>{this.originalConsoleError("Failed to log fetch exception:",c)})}throw r}}}shouldLogError(){const e=Date.now(),t=e-6e4;return this.errorTimestamps=this.errorTimestamps.filter(r=>r>t),this.errorTimestamps.length>=this.maxErrorsPerMinute?(this.errorCount%10===0&&this.originalConsoleError(` [GlobalErrorHandler] Rate limit exceeded (${this.maxErrorsPerMinute}/min). Some errors not logged.`),this.errorCount++,!1):(this.errorTimestamps.push(e),this.errorCount++,!0)}isExternalError(e){if(!e.filename||e.filename.includes("extension://"))return!0;const t=window.location.origin;try{if(new URL(e.filename).origin!==t)return!0}catch{return!1}return!1}async logError(e,t,r,a,n){this.shouldLogError()&&await Et.logCacheError(e,t,r,a,n)}getStats(){const t=Date.now()-6e4,r=this.errorTimestamps.filter(a=>a>t).length;return{totalErrors:this.errorCount,errorsLastMinute:r,isRateLimited:r>=this.maxErrorsPerMinute}}reset(){this.errorCount=0,this.errorTimestamps=[],console.log(" [GlobalErrorHandler] Error counter reset")}cleanup(){this.isInitialized&&(console.error=this.originalConsoleError,this.isInitialized=!1,console.log(" [GlobalErrorHandler] Cleaned up global error handlers"))}}const uo=new oy,iy=async(s,e)=>{await Et.logCacheError("reactErrorBoundary","componentError",s,"react_error",{componentStack:e.componentStack,type:"react_component_error"})};class cy extends D.Component{constructor(e){super(e),this.handleReset=()=>{this.setState({hasError:!1,error:null,errorInfo:null})},this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error(" [GlobalErrorBoundary] Caught error:",e,t),iy(e,t).catch(r=>{console.error("Failed to log React error:",r)}),Zt.exportError(e,{severity:"critical",module:"ReactErrorBoundary",function:"componentDidCatch",operation:"component_render",context:{componentStack:t.componentStack}}).catch(r=>{console.error("Failed to cache React error:",r)}),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:f.jsxs("div",{className:"max-w-md w-full bg-white rounded-lg shadow-lg p-6",children:[f.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[f.jsx("div",{className:"p-2 bg-red-100 rounded-full",children:f.jsx(Jt,{className:"w-6 h-6 text-red-600"})}),f.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Something went wrong"})]}),f.jsx("p",{className:"text-gray-600 mb-4",children:"An unexpected error occurred. The error has been logged and our team will look into it."}),this.state.error&&f.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded border border-gray-200",children:[f.jsx("p",{className:"text-sm font-medium text-gray-700 mb-1",children:"Error Details:"}),f.jsx("p",{className:"text-xs text-gray-600 font-mono",children:this.state.error.message})]}),f.jsx("div",{className:"flex flex-col gap-2 mb-3",children:f.jsxs("button",{onClick:()=>{var e;this.state.error&&(Zt.exportError(this.state.error,{severity:"critical",module:"ReactErrorBoundary",function:"manualDownload",operation:"component_render",context:{componentStack:(e=this.state.errorInfo)==null?void 0:e.componentStack},autoDownload:!0}),alert("Error details downloaded!"))},className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 font-semibold",children:[f.jsx(Tl,{className:"w-4 h-4"}),"Download Error Details"]})}),f.jsxs("div",{className:"flex gap-3",children:[f.jsxs("button",{onClick:this.handleReset,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2",children:[f.jsx(tr,{className:"w-4 h-4"}),"Try Again"]}),f.jsxs("button",{onClick:()=>window.location.href="/",className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center gap-2",children:[f.jsx(Oo,{className:"w-4 h-4"}),"Go Home"]})]}),!1]})}):this.props.children}}function Qc(){var t;let s=0,e=0;try{const r=Object.keys(localStorage);for(const a of r)if(a.startsWith("error_log_")||a.startsWith("error-")||a.includes("ErrorLog")||a.includes("error_export"))try{const n=((t=localStorage.getItem(a))==null?void 0:t.length)||0;localStorage.removeItem(a),s++,e+=n}catch(n){console.warn(`Failed to remove ${a}:`,n)}return console.log(` Cleared ${s} error log entries, freed ~${(e/1024).toFixed(2)} KB`),{cleared:s,freedSpace:e}}catch(r){return console.error("Failed to clear error logs:",r),{cleared:s,freedSpace:e}}}function ly(){confirm("This will clear ALL localStorage data. Are you sure? This cannot be undone.")&&(localStorage.clear(),console.log(" All localStorage cleared"),alert("localStorage cleared. Please refresh the page."))}function Ra(){let s=0,e=0;const t=[],r=Object.keys(localStorage);for(const a of r){const n=localStorage.getItem(a);if(n){const o=n.length;s+=o,t.push({key:a,size:o,sizeKB:(o/1024).toFixed(2)}),(a.startsWith("error_log_")||a.startsWith("error-"))&&e++}}return t.sort((a,n)=>n.size-a.size),{used:s,usedKB:(s/1024).toFixed(2),usedMB:(s/1024/1024).toFixed(2),itemCount:r.length,errorLogCount:e,largestItems:t.slice(0,10)}}typeof window<"u"&&(window.clearErrorLogs=Qc,window.clearAllStorage=ly,window.getStorageInfo=Ra,console.log(`
 Storage Cleanup Utilities Available:
  - clearErrorLogs() - Clear error logs from localStorage
  - getStorageInfo() - View storage usage
  - clearAllStorage() - Clear ALL localStorage (use with caution)
  `));function Kc(){console.log(" EMERGENCY CLEANUP INITIATED...");try{const s=Ra();console.log(` Before cleanup: ${s.usedMB} MB used, ${s.errorLogCount} error logs`);const e=Qc();console.log(` Cleanup complete: Cleared ${e.cleared} items, freed ${(e.freedSpace/1024).toFixed(2)} KB`);const t=Ra();console.log(` After cleanup: ${t.usedMB} MB used, ${t.errorLogCount} error logs`),console.log(" Emergency cleanup successful! Please refresh the page.")}catch(s){console.error(" Emergency cleanup failed:",s),console.log(" Try manual cleanup: Open DevTools  Application  Local Storage  Clear")}}function uy(){const s=Storage.prototype.setItem;Storage.prototype.setItem=function(e,t){try{s.call(this,e,t)}catch(r){if(r instanceof Error&&r.name==="QuotaExceededError"){console.error(" QUOTA EXCEEDED! Running emergency cleanup..."),Kc();try{s.call(this,e,t),console.log(" Storage operation succeeded after cleanup")}catch(a){throw console.error(" Storage still full after cleanup. Manual intervention required."),a}}else throw r}},console.log(" Emergency storage handler installed")}typeof window<"u"&&(uy(),window.emergencyCleanup=Kc,console.log(" Emergency cleanup utility loaded. Call emergencyCleanup() if needed."));const dy=({isVisible:s,jobs:e=[],onCancel:t,className:r=""})=>{const[a,n]=D.useState(!1);if(D.useEffect(()=>{if(e.length>0&&e.every(l=>l.status==="completed")){const l=setTimeout(()=>{n(!0)},1500);return()=>clearTimeout(l)}else n(!1)},[e]),D.useEffect(()=>{e.some(l=>l.status==="pending"||l.status==="processing")&&n(!1)},[e]),!s||a)return null;const o=e.some(l=>l.status==="failed"),i=e.length>0&&e.every(l=>l.status==="completed"),c=e.some(l=>l.status==="processing"||l.status==="pending");return f.jsxs(f.Fragment,{children:[f.jsx("div",{className:"fixed inset-0 z-[9998] pointer-events-none"}),f.jsx("div",{className:`fixed top-4 right-4 z-[9999] pointer-events-auto animate-in fade-in duration-200 ${r}`,title:e.length>0?`${e.length} operation${e.length!==1?"s":""} running`:"Loading",children:f.jsxs("div",{className:"relative",children:[f.jsx("div",{className:"w-12 h-12 rounded-full bg-white/95 backdrop-blur-md shadow-lg border border-gray-200/50 flex items-center justify-center",children:o?f.jsx(Rl,{className:"w-6 h-6 text-red-500 animate-in zoom-in duration-200"}):i?f.jsx(Ro,{className:"w-6 h-6 text-green-500 animate-in zoom-in duration-200"}):f.jsx(Ol,{className:"w-6 h-6 text-blue-500 animate-spin"})}),c&&f.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-blue-500/30 animate-ping"}),i&&f.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-green-500/50 animate-ping"}),o&&f.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-red-500/50 animate-ping"})]})}),f.jsx("style",{children:`
        @keyframes zoom-in {
          0% {
            transform: scale(0);
            opacity: 0;
          }
          50% {
            transform: scale(1.1);
          }
          100% {
            transform: scale(1);
            opacity: 1;
          }
        }
        
        .animate-in.zoom-in {
          animation: zoom-in 0.3s ease-out;
        }
        
        @keyframes fade-in {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
        
        .animate-in.fade-in {
          animation: fade-in 0.2s ease-out;
        }
      `})]})},Y=({message:s="Loading page...",size:e="md",className:t=""})=>f.jsx("div",{className:`min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 ${t}`,children:f.jsxs("div",{className:"animate-pulse",children:[f.jsx("div",{className:"bg-white border-b border-gray-200",children:f.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:f.jsxs("div",{className:"flex justify-between items-center h-16",children:[f.jsxs("div",{className:"flex items-center gap-4",children:[f.jsx("div",{className:"h-8 w-32 bg-gray-200 rounded"}),f.jsx("div",{className:"h-6 w-24 bg-gray-200 rounded"})]}),f.jsxs("div",{className:"flex items-center gap-3",children:[f.jsx("div",{className:"h-8 w-8 bg-gray-200 rounded-full"}),f.jsx("div",{className:"h-8 w-8 bg-gray-200 rounded-full"}),f.jsx("div",{className:"h-8 w-24 bg-gray-200 rounded"})]})]})})}),f.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[f.jsxs("div",{className:"mb-6",children:[f.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded mb-2"}),f.jsx("div",{className:"h-4 w-64 bg-gray-200 rounded"})]}),f.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[1,2,3,4].map(r=>f.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[f.jsx("div",{className:"h-4 w-20 bg-gray-200 rounded mb-3"}),f.jsx("div",{className:"h-8 w-24 bg-gray-200 rounded mb-2"}),f.jsx("div",{className:"h-3 w-16 bg-gray-200 rounded"})]},r))}),f.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[f.jsxs("div",{className:"lg:col-span-2 bg-white rounded-lg border border-gray-200 p-6",children:[f.jsx("div",{className:"h-6 w-32 bg-gray-200 rounded mb-4"}),f.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(r=>f.jsxs("div",{className:"flex gap-4 items-center",children:[f.jsx("div",{className:"h-16 w-16 bg-gray-200 rounded"}),f.jsxs("div",{className:"flex-1 space-y-2",children:[f.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded"}),f.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded"})]})]},r))})]}),f.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[f.jsx("div",{className:"h-6 w-24 bg-gray-200 rounded mb-4"}),f.jsx("div",{className:"space-y-3",children:[1,2,3].map(r=>f.jsx("div",{className:"h-12 bg-gray-200 rounded"},r))})]})]})]})]})}),Ht=({children:s,onClick:e,type:t="button",variant:r="primary",size:a="md",disabled:n=!1,className:o="",icon:i,loading:c=!1})=>{const l="flex items-center justify-center gap-2 backdrop-blur-md rounded-lg border transition-all duration-300",d={primary:"bg-gradient-to-r from-blue-500/80 to-indigo-500/80 hover:from-blue-600/90 hover:to-indigo-600/90 text-white border-white/20",secondary:"bg-gradient-to-r from-purple-500/80 to-pink-500/80 hover:from-purple-600/90 hover:to-pink-600/90 text-white border-white/20",success:"bg-gradient-to-r from-emerald-500/80 to-green-500/80 hover:from-emerald-600/90 hover:to-green-600/90 text-white border-white/20",danger:"bg-gradient-to-r from-rose-500/80 to-red-500/80 hover:from-rose-600/90 hover:to-red-600/90 text-white border-white/20",warning:"bg-gradient-to-r from-amber-500/80 to-orange-500/80 hover:from-amber-600/90 hover:to-orange-600/90 text-white border-white/20",outline:"bg-transparent border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400",ghost:"bg-transparent text-gray-700 hover:bg-gray-100/50 border-transparent"},u={sm:"py-1 px-3 text-sm",md:"py-2 px-4 text-base",lg:"py-3 px-6 text-lg font-medium"},h=n||c?"opacity-50 cursor-not-allowed":"hover:shadow-lg active:scale-[0.98] focus:ring-2 focus:ring-white/30 hover:border-white/40 backdrop-blur-xl";return f.jsx("button",{type:t,onClick:e,disabled:n||c,className:`
        ${l}
        ${d[r]}
        ${u[a]}
        ${h}
        ${o}
      `,children:c?f.jsxs(f.Fragment,{children:[f.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[f.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),f.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Loading..."]}):f.jsxs(f.Fragment,{children:[i&&f.jsx("span",{className:"mr-1",children:i}),s]})})},Jc=({children:s,className:e="",onClick:t})=>f.jsx("div",{className:`
        backdrop-blur-xl rounded-xl 
        border shadow-lg 
        p-6 sm:p-8 transition-all duration-300 
        hover:shadow-xl
        ${t?"cursor-pointer active:scale-[0.98]":""}
        ${e}
      `,style:{backgroundColor:"var(--card-bg, rgba(255, 255, 255, 0.7))",borderColor:"var(--card-border, rgba(255, 255, 255, 0.3))",boxShadow:"var(--card-shadow, 0 4px 6px -1px rgba(0, 0, 0, 0.1))"},onClick:t,children:s});class Zr extends er.Component{constructor(e){super(e),this.handleRetry=()=>{const{maxRetries:t=3}=this.props,{retryCount:r}=this.state;r<t?(console.log(` Retrying... Attempt ${r+1} of ${t}`),this.setState({hasError:!1,error:null,errorInfo:null,retryCount:r+1})):console.error(" Max retries exceeded")},this.handleGoHome=()=>{window.location.href="/dashboard"},this.handleGoBack=()=>{window.history.back()},this.handleRefreshPage=()=>{window.location.reload()},this.handleReactRefreshError=()=>{console.log(" Handling React refresh error, reloading page..."),typeof window<"u"&&(sessionStorage.clear(),localStorage.removeItem("pos_setup_complete"),window.location.reload())},this.state={hasError:!1,error:null,errorInfo:null,retryCount:0}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error(" [ErrorBoundary] ACTUAL ERROR:",e.name,"-",e.message),console.error(" [ErrorBoundary] Error stack:",e.stack),this.setState({errorInfo:t}),this.props.onError&&this.props.onError(e,t),console.group(" Error Details"),console.error("Error Type:",e.name),console.error("Error Message:",e.message),console.error("Error Stack:",e.stack),console.error("Error Info:",t),console.error("Component Stack:",t.componentStack),console.groupEnd(),(e.message.includes("React Refresh")||e.message.includes("@react-refresh")||t.componentStack.includes("React Refresh"))&&console.log(" Detected React refresh error, attempting to recover...")}render(){var c,l,d;const{hasError:e,error:t,errorInfo:r,retryCount:a}=this.state,{children:n,fallback:o,maxRetries:i=3}=this.props;if(e){if(o)return er.createElement(o,{error:t,errorInfo:r,retry:this.handleRetry});const u=((c=t==null?void 0:t.message)==null?void 0:c.includes("React Refresh"))||((l=t==null?void 0:t.message)==null?void 0:l.includes("@react-refresh"))||((d=r==null?void 0:r.componentStack)==null?void 0:d.includes("React Refresh"));return f.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4",children:f.jsx(Jc,{className:"max-w-2xl w-full p-8",children:f.jsxs("div",{className:"text-center space-y-6",children:[f.jsx("div",{className:"flex justify-center",children:f.jsx("div",{className:"p-4 bg-red-100 rounded-full",children:f.jsx(Jt,{className:"w-12 h-12 text-red-600"})})}),f.jsxs("div",{children:[f.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:u?"Development Refresh Error":"Something went wrong"}),f.jsx("p",{className:"text-gray-600",children:u?"A refresh error occurred. This is usually temporary and can be resolved by refreshing the page.":"An unexpected error occurred. We're sorry for the inconvenience."}),u&&!1]}),t&&f.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-left",children:[f.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"Error Details:"}),f.jsx("p",{className:"text-sm text-red-600 font-mono mb-2",children:t.message}),r&&f.jsxs("details",{className:"text-sm text-gray-600",children:[f.jsx("summary",{className:"cursor-pointer hover:text-gray-800 mb-2",children:"Show technical details"}),f.jsx("pre",{className:"bg-gray-100 p-3 rounded text-xs overflow-auto max-h-32",children:r.componentStack})]})]}),a>0&&f.jsxs("div",{className:"text-sm text-gray-500",children:["Retry attempt ",a," of ",i]}),f.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[u?f.jsx(Ht,{onClick:this.handleRefreshPage,icon:f.jsx(tr,{className:"w-4 h-4"}),className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Refresh Page"}):f.jsx(Ht,{onClick:this.handleRetry,disabled:a>=i,icon:f.jsx(tr,{className:"w-4 h-4"}),className:"bg-blue-600 hover:bg-blue-700 text-white",children:a>=i?"Max Retries Reached":"Try Again"}),f.jsx(Ht,{onClick:this.handleGoBack,variant:"secondary",icon:f.jsx(Nl,{className:"w-4 h-4"}),children:"Go Back"}),f.jsx(Ht,{onClick:this.handleGoHome,variant:"secondary",icon:f.jsx(Oo,{className:"w-4 h-4"}),children:"Go Home"})]}),f.jsx("div",{className:"text-xs text-gray-500",children:"If this problem persists, please contact support with the error details above."})]})})})}return n}}class hy extends D.Component{constructor(e){super(e),this.handleRetry=()=>{this.setState({hasError:!1,error:void 0}),this.props.onRetry&&this.props.onRetry()},this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Dynamic import error:",e,t)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:f.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:f.jsxs(Jc,{className:"max-w-md w-full text-center",children:[f.jsx(Jt,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),f.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Module Loading Error"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"Failed to load the requested page. This might be a temporary issue."}),f.jsxs("div",{className:"space-y-2",children:[f.jsx(Ht,{onClick:this.handleRetry,icon:f.jsx(tr,{size:18}),className:"w-full",children:"Try Again"}),f.jsx(Ht,{onClick:()=>window.location.reload(),variant:"outline",className:"w-full",children:"Reload Page"})]}),!1]})}):this.props.children}}class Fr{static sanitizeImageUrl(e,t){if(!e||typeof e!="string")return this.createFallbackResult(0,"fallback");const r=e.length;if(r>this.MAX_SAFE_URL_LENGTH)return console.warn(" Image URL too long, using fallback to prevent 431 error:",{originalLength:r,maxSafeLength:this.MAX_SAFE_URL_LENGTH,urlPreview:e.substring(0,100)+"..."}),this.createFallbackResult(r,"fallback");if(e.startsWith("data:")){if(r>this.MAX_SAFE_DATA_URL_LENGTH)return console.warn(" Data URL too large, using fallback to prevent performance issues:",{originalLength:r,maxSafeLength:this.MAX_SAFE_DATA_URL_LENGTH}),this.createFallbackResult(r,"fallback");if(this.hasBase64InPath(e))return console.warn(" Base64 data detected in URL path, using fallback to prevent 431 error"),this.createFallbackResult(r,"fallback");const a=e.split(",")[1];return a&&a.length>1e5?(console.warn(" Base64 data too large, using fallback to prevent 431 error:",{base64Length:a.length}),this.createFallbackResult(r,"fallback")):{url:e,isSanitized:!1,originalLength:r,sanitizedLength:r,method:"original"}}return this.hasProblematicPatterns(e)?(console.warn(" Problematic URL pattern detected, using fallback"),this.createFallbackResult(r,"fallback")):this.hasBase64InUrlPath(e)?(console.warn(" Base64 data detected in URL path, using fallback to prevent 431 error"),this.createFallbackResult(r,"fallback")):{url:e,isSanitized:!1,originalLength:r,sanitizedLength:r,method:"original"}}static hasBase64InPath(e){try{const r=new URL(e,window.location.origin).pathname;return/[A-Za-z0-9+/]{100,}={0,2}/.test(r)}catch{return/[A-Za-z0-9+/]{100,}={0,2}/.test(e)}}static hasBase64InUrlPath(e){return this.hasBase64InPath(e)}static hasProblematicPatterns(e){const t=/%[0-9A-Fa-f]{2,}/g,r=e.match(t);return!!(r&&r.join("").length>this.MAX_SAFE_BASE64_IN_PATH||e.includes("data:image/")&&e.includes(","))}static createFallbackResult(e,t){const r=this.generatePlaceholderUrl();return{url:r,isSanitized:!0,originalLength:e,sanitizedLength:r.length,method:t}}static generatePlaceholderUrl(){return`data:image/svg+xml;base64,${btoa(`
      <svg width="300" height="300" xmlns="http://www.w3.org/2000/svg">
        <rect width="100%" height="100%" fill="#f3f4f6"/>
        <text x="50%" y="50%" font-family="Arial, sans-serif" font-size="14" 
              fill="#6b7280" text-anchor="middle" dy=".3em">
          Product Image
        </text>
      </svg>
    `)}`}static isUrlSafe(e){return!this.sanitizeImageUrl(e).isSanitized}static getUrlStats(e){const t=e.startsWith("data:"),r=this.hasBase64InPath(e),a=e.length>this.MAX_SAFE_URL_LENGTH,n=!a&&!r;return{length:e.length,isTooLong:a,isDataUrl:t,hasBase64InPath:r,isSafe:n}}static emergencyCleanup(e){return!e||typeof e!="string"?this.generatePlaceholderUrl():e.length>2e3?(console.error(" Emergency cleanup: URL extremely long, using fallback"),this.generatePlaceholderUrl()):this.hasBase64InPath(e)?(console.error(" Emergency cleanup: Base64 in path detected, using fallback"),this.generatePlaceholderUrl()):e}}Fr.MAX_SAFE_URL_LENGTH=2e3;Fr.MAX_SAFE_DATA_URL_LENGTH=8e3;Fr.MAX_SAFE_BASE64_IN_PATH=500;class Us{static validateUrl(e){if(!e||typeof e!="string")return{isValid:!1,reason:"Invalid URL format",originalLength:0};const t=e.length;if(t>this.MAX_SAFE_URL_LENGTH)return{isValid:!1,reason:"URL too long for HTTP headers",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length};for(const r of this.PROBLEMATIC_PATTERNS)if(r.test(e))return{isValid:!1,reason:"URL contains problematic patterns (Base64 data)",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length};try{if(new URL(e,window.location.origin).pathname.length>this.MAX_SAFE_PATH_LENGTH)return{isValid:!1,reason:"URL path too long",originalLength:t,sanitizedUrl:this.generateSafeUrl(),sanitizedLength:this.generateSafeUrl().length}}catch{return{isValid:!1,reason:"Invalid URL format",originalLength:t}}return{isValid:!0,originalLength:t}}static validateImageUrl(e){const t=Fr.sanitizeImageUrl(e);return{isValid:!t.isSanitized,sanitizedUrl:t.url,originalLength:t.originalLength,sanitizedLength:t.sanitizedLength,reason:t.isSanitized?"Image URL sanitized to prevent 431 error":void 0}}static isUrlSafeForNavigation(e){return this.validateUrl(e).isValid}static isUrlSafeForImages(e){return this.validateImageUrl(e).isValid}static generateSafeUrl(){return"/lats/unified-inventory"}static logUrlValidationIssue(e,t){t.isValid||console.warn(" URL Validation Issue:",{reason:t.reason,originalLength:t.originalLength,sanitizedLength:t.sanitizedLength,urlPreview:e.substring(0,100)+(e.length>100?"...":""),sanitizedUrl:t.sanitizedUrl})}static emergencyUrlCleanup(e){const t=this.validateUrl(e);return!t.isValid&&t.sanitizedUrl?(console.error(" Emergency URL cleanup applied:",{originalLength:t.originalLength,reason:t.reason}),t.sanitizedUrl):e}static getUrlStats(e){const t=[];let r=0,a=!1;try{r=new URL(e,window.location.origin).pathname.length}catch{t.push("Invalid URL format")}e.length>this.MAX_SAFE_URL_LENGTH&&t.push("URL too long"),r>this.MAX_SAFE_PATH_LENGTH&&t.push("Path too long");for(const n of this.PROBLEMATIC_PATTERNS)if(n.test(e)){a=!0,t.push("Contains problematic patterns");break}return{length:e.length,pathLength:r,hasProblematicPatterns:a,isTooLong:e.length>this.MAX_SAFE_URL_LENGTH,isSafe:t.length===0,issues:t}}}Us.MAX_SAFE_URL_LENGTH=1500;Us.MAX_SAFE_PATH_LENGTH=1e3;Us.PROBLEMATIC_PATTERNS=[/data:image\/[^;]+;base64,/,/%[0-9A-Fa-f]{2,}/g,/[A-Za-z0-9+/]{100,}={0,2}/];const my=({children:s,fallbackPath:e="/lats/unified-inventory",enableImageUrlValidation:t=!0,enableUrlLogging:r=!1})=>{const a=ko(),n=Io(),[o,i]=D.useState(!0),[c,l]=D.useState(null);return D.useEffect(()=>{(()=>{const u=a.pathname+a.search;r&&console.log(" Validating URL:",{pathname:a.pathname,search:a.search,fullUrl:u,length:u.length});const h=Us.validateUrl(u);if(!h.isValid){console.warn(" URL validation failed:",{reason:h.reason,originalLength:h.originalLength,sanitizedUrl:h.sanitizedUrl}),l({isValid:!1,sanitizedUrl:h.sanitizedUrl,reason:h.reason}),h.sanitizedUrl?n(h.sanitizedUrl,{replace:!0}):n(e,{replace:!0});return}if(t){const g=py(a.pathname);if(!g.isValid){console.warn(" Image URL validation failed:",{reason:g.reason,sanitizedUrl:g.sanitizedUrl}),l({isValid:!1,sanitizedUrl:g.sanitizedUrl,reason:g.reason}),g.sanitizedUrl?n(g.sanitizedUrl,{replace:!0}):n(e,{replace:!0});return}}l({isValid:!0}),i(!1)})()},[a.pathname,a.search,n,e,t,r]),o?f.jsx("div",{className:"flex items-center justify-center min-h-screen",children:f.jsxs("div",{className:"text-center",children:[f.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),f.jsx("p",{className:"text-gray-600",children:"Validating URL..."})]})}):c&&!c.isValid?f.jsx("div",{className:"flex items-center justify-center min-h-screen",children:f.jsxs("div",{className:"text-center max-w-md mx-auto p-6 bg-white rounded-lg shadow-lg",children:[f.jsx("div",{className:"text-red-500 text-6xl mb-4",children:""}),f.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"URL Too Large"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"The URL you're trying to access is too large and could cause server errors."}),f.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Reason: ",c.reason]}),f.jsx("button",{onClick:()=>n(e),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",children:"Go to Safe Page"})]})}):f.jsx(f.Fragment,{children:s})};function py(s){const e=/\/lats\/products\/([^\/]+)/,t=s.match(e);if(t){const r=t[1];if(/[A-Za-z0-9+/]{100,}={0,2}/.test(r))return{isValid:!1,sanitizedUrl:"/lats/unified-inventory",reason:"Product ID contains Base64 data"};if(r.length>100)return{isValid:!1,sanitizedUrl:"/lats/unified-inventory",reason:"Product ID too long"}}return{isValid:!0}}var or;(function(s){s.Unimplemented="UNIMPLEMENTED",s.Unavailable="UNAVAILABLE"})(or||(or={}));class Zs extends Error{constructor(e,t,r){super(e),this.message=e,this.code=t,this.data=r}}const fy=s=>{var e,t;return s!=null&&s.androidBridge?"android":!((t=(e=s==null?void 0:s.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||t===void 0)&&t.bridge?"ios":"web"},gy=s=>{const e=s.CapacitorCustomPlatform||null,t=s.Capacitor||{},r=t.Plugins=t.Plugins||{},a=()=>e!==null?e.name:fy(s),n=()=>a()!=="web",o=u=>{const h=l.get(u);return!!(h!=null&&h.platforms.has(a())||i(u))},i=u=>{var h;return(h=t.PluginHeaders)===null||h===void 0?void 0:h.find(g=>g.name===u)},c=u=>s.console.error(u),l=new Map,d=(u,h={})=>{const g=l.get(u);if(g)return console.warn(`Capacitor plugin "${u}" already registered. Cannot register plugins twice.`),g.proxy;const p=a(),m=i(u);let _;const b=async()=>(!_&&p in h?_=typeof h[p]=="function"?_=await h[p]():_=h[p]:e!==null&&!_&&"web"in h&&(_=typeof h.web=="function"?_=await h.web():_=h.web),_),S=(k,P)=>{var O,N;if(m){const $=m==null?void 0:m.methods.find(M=>P===M.name);if($)return $.rtype==="promise"?M=>t.nativePromise(u,P.toString(),M):(M,L)=>t.nativeCallback(u,P.toString(),M,L);if(k)return(O=k[P])===null||O===void 0?void 0:O.bind(k)}else{if(k)return(N=k[P])===null||N===void 0?void 0:N.bind(k);throw new Zs(`"${u}" plugin is not implemented on ${p}`,or.Unimplemented)}},v=k=>{let P;const O=(...N)=>{const $=b().then(M=>{const L=S(M,k);if(L){const B=L(...N);return P=B==null?void 0:B.remove,B}else throw new Zs(`"${u}.${k}()" is not implemented on ${p}`,or.Unimplemented)});return k==="addListener"&&($.remove=async()=>P()),$};return O.toString=()=>`${k.toString()}() { [capacitor code] }`,Object.defineProperty(O,"name",{value:k,writable:!1,configurable:!1}),O},C=v("addListener"),T=v("removeListener"),x=(k,P)=>{const O=C({eventName:k},P),N=async()=>{const M=await O;T({eventName:k,callbackId:M},P)},$=new Promise(M=>O.then(()=>M({remove:N})));return $.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await N()},$},R=new Proxy({},{get(k,P){switch(P){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return m?x:C;case"removeListener":return T;default:return v(P)}}});return r[u]=R,l.set(u,{name:u,proxy:R,platforms:new Set([...Object.keys(h),...m?[p]:[]])}),R};return t.convertFileSrc||(t.convertFileSrc=u=>u),t.getPlatform=a,t.handleError=c,t.isNativePlatform=n,t.isPluginAvailable=o,t.registerPlugin=d,t.Exception=Zs,t.DEBUG=!!t.DEBUG,t.isLoggingEnabled=!!t.isLoggingEnabled,t},_y=s=>s.Capacitor=gy(s),mt=_y(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),Yc=mt.registerPlugin;class Xc{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let r=!1;this.listeners[e]||(this.listeners[e]=[],r=!0),this.listeners[e].push(t);const n=this.windowListeners[e];n&&!n.registered&&this.addWindowListener(n),r&&this.sendRetainedArgumentsForEvent(e);const o=async()=>this.removeListener(e,t);return Promise.resolve({remove:o})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,r){const a=this.listeners[e];if(!a){if(r){let n=this.retainedEventArguments[e];n||(n=[]),n.push(t),this.retainedEventArguments[e]=n}return}a.forEach(n=>n(t))}hasListeners(e){var t;return!!(!((t=this.listeners[e])===null||t===void 0)&&t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:r=>{this.notifyListeners(t,r)}}}unimplemented(e="not implemented"){return new mt.Exception(e,or.Unimplemented)}unavailable(e="not available"){return new mt.Exception(e,or.Unavailable)}async removeListener(e,t){const r=this.listeners[e];if(!r)return;const a=r.indexOf(t);this.listeners[e].splice(a,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(r=>{this.notifyListeners(e,r)}))}}const ho=s=>encodeURIComponent(s).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),mo=s=>s.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class yy extends Xc{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(r=>{if(r.length<=0)return;let[a,n]=r.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=mo(a).trim(),n=mo(n).trim(),t[a]=n}),t}async setCookie(e){try{const t=ho(e.key),r=ho(e.value),a=`; expires=${(e.expires||"").replace("expires=","")}`,n=(e.path||"/").replace("path=",""),o=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${r||""}${a}; path=${n}; ${o};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}Yc("CapacitorCookies",{web:()=>new yy});const by=async s=>new Promise((e,t)=>{const r=new FileReader;r.onload=()=>{const a=r.result;e(a.indexOf(",")>=0?a.split(",")[1]:a)},r.onerror=a=>t(a),r.readAsDataURL(s)}),wy=(s={})=>{const e=Object.keys(s);return Object.keys(s).map(a=>a.toLocaleLowerCase()).reduce((a,n,o)=>(a[n]=s[e[o]],a),{})},vy=(s,e=!0)=>s?Object.entries(s).reduce((r,a)=>{const[n,o]=a;let i,c;return Array.isArray(o)?(c="",o.forEach(l=>{i=e?encodeURIComponent(l):l,c+=`${n}=${i}&`}),c.slice(0,-1)):(i=e?encodeURIComponent(o):o,c=`${n}=${i}`),`${r}&${c}`},"").substr(1):null,Sy=(s,e={})=>{const t=Object.assign({method:s.method||"GET",headers:s.headers},e),a=wy(s.headers)["content-type"]||"";if(typeof s.data=="string")t.body=s.data;else if(a.includes("application/x-www-form-urlencoded")){const n=new URLSearchParams;for(const[o,i]of Object.entries(s.data||{}))n.set(o,i);t.body=n.toString()}else if(a.includes("multipart/form-data")||s.data instanceof FormData){const n=new FormData;if(s.data instanceof FormData)s.data.forEach((i,c)=>{n.append(c,i)});else for(const i of Object.keys(s.data))n.append(i,s.data[i]);t.body=n;const o=new Headers(t.headers);o.delete("content-type"),t.headers=o}else(a.includes("application/json")||typeof s.data=="object")&&(t.body=JSON.stringify(s.data));return t};class Ey extends Xc{async request(e){const t=Sy(e,e.webFetchExtra),r=vy(e.params,e.shouldEncodeUrlParams),a=r?`${e.url}?${r}`:e.url,n=await fetch(a,t),o=n.headers.get("content-type")||"";let{responseType:i="text"}=n.ok?e:{};o.includes("application/json")&&(i="json");let c,l;switch(i){case"arraybuffer":case"blob":l=await n.blob(),c=await by(l);break;case"json":c=await n.json();break;case"document":case"text":default:c=await n.text()}const d={};return n.headers.forEach((u,h)=>{d[h]=u}),{data:c,headers:d,status:n.status,url:n.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}Yc("CapacitorHttp",{web:()=>new Ey});class xy{static isNativeApp(){return mt.isNativePlatform()}static isWeb(){return!mt.isNativePlatform()}static getPlatform(){return mt.getPlatform()}static isAndroid(){return mt.getPlatform()==="android"}static isIOS(){return mt.getPlatform()==="ios"}static getPlatformInfo(){return{isNative:this.isNativeApp(),isWeb:this.isWeb(),isAndroid:this.isAndroid(),isIOS:this.isIOS(),platform:this.getPlatform()}}static logPlatformInfo(){const e=this.getPlatformInfo();return console.log(" [Platform Detection]",e),e}}const hn=()=>xy.isNativeApp(),Py=({children:s})=>{const e=hn(),t=!1,r=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes("localhost"),a=e||t||r;return er.useEffect(()=>{console.log(" [NativeOnlyRoute] Access check:",{isNative:e,isDevelopment:t,isLocalhost:r,allowAccess:a,hostname:window.location.hostname,currentPath:window.location.pathname})},[e,t,r,a]),a?f.jsx(f.Fragment,{children:s}):(console.warn(" [NativeOnlyRoute] Access denied: Not in native app or development. Redirecting to dashboard."),f.jsx(it,{to:"/dashboard",replace:!0}))},Ay=({children:s})=>{const e=Io(),t=ko(),r=hn();return D.useEffect(()=>{if(r){const a=t.pathname;a.startsWith("/mobile")||(console.log(" [MobileOnlyRedirect] APK detected, redirecting from",a,"to /mobile/dashboard"),e("/mobile/dashboard",{replace:!0}))}},[r,t.pathname,e]),f.jsx(f.Fragment,{children:s})},po=()=>{const s=hn(),e=s?"/mobile/dashboard":"/dashboard";return console.log(" [DefaultRedirect] Platform:",s?"Native APK":"Web Browser"," Redirecting to:",e),console.log(" [DefaultRedirect] In development, you can manually access /mobile routes"),f.jsx(it,{to:e,replace:!0})},Oa=({size:s="md",message:e,fullscreen:t=!1,transparent:r=!0})=>t?f.jsxs("div",{className:`min-h-screen ${r?"bg-gradient-to-br from-gray-50 to-gray-100":"bg-gradient-to-br from-blue-50 to-indigo-100"}`,children:[f.jsxs("div",{className:"animate-pulse",children:[f.jsx("div",{className:"bg-white border-b border-gray-200",children:f.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:f.jsxs("div",{className:"flex justify-between items-center h-16",children:[f.jsxs("div",{className:"flex items-center gap-4",children:[f.jsx("div",{className:"h-8 w-32 bg-gray-200 rounded"}),f.jsx("div",{className:"h-6 w-24 bg-gray-200 rounded"})]}),f.jsxs("div",{className:"flex items-center gap-3",children:[f.jsx("div",{className:"h-8 w-8 bg-gray-200 rounded-full"}),f.jsx("div",{className:"h-8 w-8 bg-gray-200 rounded-full"}),f.jsx("div",{className:"h-8 w-24 bg-gray-200 rounded"})]})]})})}),f.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[f.jsxs("div",{className:"mb-6",children:[f.jsx("div",{className:"h-8 w-48 bg-gray-200 rounded mb-2"}),f.jsx("div",{className:"h-4 w-64 bg-gray-200 rounded"})]}),f.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8",children:[1,2,3].map(a=>f.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[f.jsx("div",{className:"h-6 w-3/4 bg-gray-200 rounded mb-4"}),f.jsx("div",{className:"h-16 w-full bg-gray-200 rounded mb-4"}),f.jsx("div",{className:"h-4 w-1/2 bg-gray-200 rounded"})]},a))}),f.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[f.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:f.jsx("div",{className:"h-6 w-32 bg-gray-200 rounded"})}),f.jsx("div",{className:"divide-y divide-gray-200",children:[1,2,3,4,5].map(a=>f.jsxs("div",{className:"px-6 py-4 flex gap-4",children:[f.jsx("div",{className:"h-4 w-1/4 bg-gray-200 rounded"}),f.jsx("div",{className:"h-4 w-1/3 bg-gray-200 rounded"}),f.jsx("div",{className:"h-4 w-1/4 bg-gray-200 rounded"}),f.jsx("div",{className:"h-4 w-1/6 bg-gray-200 rounded"})]},a))})]})]})]}),e&&f.jsx("div",{className:"fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-lg shadow-lg border border-gray-200",children:f.jsx("p",{className:"text-sm text-gray-600",children:e})})]}):f.jsxs("div",{className:"animate-pulse space-y-4 py-8",children:[f.jsx("div",{className:"h-8 w-3/4 bg-gray-200 rounded"}),f.jsx("div",{className:"h-4 w-full bg-gray-200 rounded"}),f.jsx("div",{className:"h-4 w-5/6 bg-gray-200 rounded"}),f.jsxs("div",{className:"grid grid-cols-3 gap-4 pt-4",children:[f.jsx("div",{className:"h-24 bg-gray-200 rounded"}),f.jsx("div",{className:"h-24 bg-gray-200 rounded"}),f.jsx("div",{className:"h-24 bg-gray-200 rounded"})]})]}),Zc=async()=>{try{console.log(" Fetching suppliers with statistics from database...");const{addBranchFilter:s}=await z(()=>Promise.resolve().then(()=>dn),void 0);let e=w.from("lats_suppliers").select("*").order("name");const t=await s(e,"suppliers"),{data:r,error:a}=await t;if(a)throw console.error(" Error fetching suppliers:",a),new Error(`Failed to fetch suppliers: ${a.message}`);console.log(` Total suppliers in database: ${(r==null?void 0:r.length)||0}`);const n=(r||[]).filter(d=>d.is_active!==!1&&d.is_trade_in_customer!==!0),o=(r||[]).length-n.length;console.log(` Active suppliers: ${n.length}`),o>0&&console.log(`  Inactive/Trade-in suppliers filtered out: ${o}`);const{data:i,error:c}=await w.from("lats_purchase_orders").select("supplier_id, total_amount, order_date, status");c&&console.warn(" Could not fetch order statistics:",c);const l=n.map(d=>{const u=(i||[]).filter(m=>m.supplier_id===d.id),h=u.length,g=u.reduce((m,_)=>{const b=parseFloat(_.total_amount)||0;return m+b},0),p=u.length>0?u.map(m=>new Date(m.order_date)).sort((m,_)=>_.getTime()-m.getTime())[0].toISOString():void 0;return{...d,ordersCount:h,totalSpent:g,lastOrderDate:p}});return console.log(` Suppliers with statistics: ${l.length}`),console.log(` Total orders found: ${(i==null?void 0:i.length)||0}`),l.length===0&&(console.warn(" WARNING: No active suppliers found! Check if suppliers table is empty or all suppliers are inactive."),console.warn(" TIP: Run this SQL to check: SELECT name, is_active, is_trade_in_customer FROM lats_suppliers;")),l}catch(s){throw console.error(" Error in getActiveSuppliers:",s),s}},ky=async()=>{try{const{addBranchFilter:s}=await z(()=>Promise.resolve().then(()=>dn),void 0);let e=w.from("lats_suppliers").select("*").order("name");const t=await s(e,"suppliers"),{data:r,error:a}=await t;if(a)throw console.error("Error fetching all suppliers:",a),new Error("Failed to fetch suppliers");return(r||[]).filter(n=>n.is_trade_in_customer!==!0)}catch(s){throw console.error("Error in getAllSuppliers:",s),s}},Iy=async s=>{try{const e={...s};e.is_active=!0,e.branch_id=null,e.is_shared=!0,Object.keys(e).forEach(a=>{e[a]===void 0&&delete e[a]});const{data:t,error:r}=await w.from("lats_suppliers").insert(e).select().single();if(r)throw console.error(" Error creating supplier:",r.message),new Error(`Failed to create supplier: ${r.message}`);return t}catch(e){throw console.error(" Error in createSupplier:",e),e}},Cy=async(s,e)=>{try{const t={...e};Object.keys(t).forEach(n=>{t[n]===void 0&&delete t[n]});const{data:r,error:a}=await w.from("lats_suppliers").update(t).eq("id",s).select().single();if(a)throw console.error(" Error updating supplier:",a.message),new Error(`Failed to update supplier: ${a.message}`);return r}catch(t){throw console.error(" Error in updateSupplier:",t),t}},cS=async s=>{try{const{data:e,error:t}=await w.from("lats_purchase_orders").select("id").eq("supplier_id",s).limit(1);if(t)throw console.error(" Error checking purchase orders:",t),new Error(`Failed to check supplier references: ${t.message}`);if(e&&e.length>0)throw new Error("Cannot delete supplier: This supplier has associated purchase orders. Please delete or reassign the purchase orders first.");const{data:r,error:a}=await w.from("lats_products").select("id").eq("supplier_id",s).limit(1);if(a)throw console.error(" Error checking products:",a),new Error(`Failed to check supplier references: ${a.message}`);if(r&&r.length>0)throw new Error("Cannot delete supplier: This supplier has associated products. Please delete or reassign the products first.");const{error:n}=await w.from("lats_suppliers").delete().eq("id",s);if(n)throw console.error(" Error deleting supplier:",n),new Error(`Failed to delete supplier: ${n.message}`)}catch(e){throw console.error(" Error in deleteSupplier:",e),e}},Dy=async s=>{try{const{data:e,error:t}=await w.from("lats_suppliers").select("*").or(`name.ilike.%${s}%,contact_person.ilike.%${s}%`).order("name");if(t)throw console.error("Error searching suppliers:",t),new Error("Failed to search suppliers");return(e||[]).filter(r=>r.is_active!==!1&&r.is_trade_in_customer!==!0)}catch(e){throw console.error("Error in searchSuppliers:",e),e}},Ty=D.createContext(void 0),Ry=({children:s})=>{const[e,t]=D.useState([]),[r,a]=D.useState(!0),[n,o]=D.useState(null),i=async()=>{try{a(!0),o(null);const g=await Zc();t(g)}catch(g){o(g.message||"Failed to fetch suppliers"),ge.error("Failed to load suppliers"),console.error("Error fetching suppliers:",g)}finally{a(!1)}},c=async g=>{try{return g.trim().length<2?e:await Dy(g)}catch(p){return console.error("Error searching suppliers:",p),e.filter(m=>{var _;return m.name.toLowerCase().includes(g.toLowerCase())||((_=m.contact_person)==null?void 0:_.toLowerCase().includes(g.toLowerCase()))})}},l=async g=>{try{return await l(g)}catch(p){return console.error("Error fetching suppliers by country:",p),e.filter(m=>m.country===g)}},d=g=>e.find(p=>p.id===g),u=g=>e.find(p=>p.name.toLowerCase()===g.toLowerCase());D.useEffect(()=>{i()},[]);const h={suppliers:e,loading:r,error:n,refreshSuppliers:i,searchSuppliersByName:c,getSuppliersByCountry:l,getSupplierById:d,getSupplierByName:u};return f.jsx(Ty.Provider,{value:h,children:s})},Oy=async()=>{var s;try{const{data:e,error:t}=await w.from("settings").select("*").limit(1);return t&&!((s=t.message)!=null&&s.includes("does not exist"))?(console.warn(" Database connection issue:",t.message),{success:!1,error:t}):({}.VITE_DEBUG&&console.log(" Database connected"),{success:!0,data:e})}catch(e){return console.error(" Database error:",e),{success:!1,error:e}}},Ny={handoverReminderHours:24,checkIntervalMinutes:30};class Ly{constructor(e={}){this.intervalId=null,this.isRunning=!1,this.lastCheckTime=0,this.CHECK_COOLDOWN=5*60*1e3,this.config={...Ny,...e}}start(){if(this.isRunning||this.intervalId){console.log(" [ReminderService] Already running, skipping duplicate start");return}this.isRunning=!0,this.intervalId=setInterval(()=>{this.checkOverdueHandovers()},this.config.checkIntervalMinutes*60*1e3),this.checkOverdueHandovers()}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,this.isRunning=!1)}async checkOverdueHandovers(){const e=Date.now();if(e-this.lastCheckTime<this.CHECK_COOLDOWN){console.log(` [ReminderService] Skipping check - cooldown active (${Math.round((this.CHECK_COOLDOWN-(e-this.lastCheckTime))/1e3)}s remaining)`);return}this.lastCheckTime=e;try{const t=new Date;t.setHours(t.getHours()-this.config.handoverReminderHours);const{data:r,error:a}=await w.from("devices").select("id, serial_number, brand, model, status, updated_at, customer_id").eq("status","repair-complete").lt("updated_at",t.toISOString());if(a){console.error("Error checking overdue handovers:",a);return}if(r&&r.length>0){const n=[...new Set(r.map(c=>c.customer_id).filter(Boolean))];let o={};if(n.length>0){const{data:c}=await w.from("customers").select("id, name, phone, email").in("id",n);c&&(o=Object.fromEntries(c.map(l=>[l.id,l])))}const i=r.map(c=>({...c,customers:o[c.customer_id]}));await this.sendHandoverReminders(i)}}catch(t){console.error("Error in checkOverdueHandovers:",t)}}async sendHandoverReminders(e){try{const t=await this.getCustomerCareEmails();if(t.length===0){console.warn("No customer care emails found for handover reminders");return}const r=e.map(n=>{var o;return`${n.brand} ${n.model} (${n.serial_number}) - Customer: ${((o=n.customers)==null?void 0:o.name)||"Unknown"}`}).join(`
`),a=`
        <h2>Overdue Device Handovers</h2>
        <p>The following devices have been marked as "repair-complete" for more than ${this.config.handoverReminderHours} hours and require customer handover:</p>
        <ul>
          ${e.map(n=>{var o;return`<li><strong>${n.brand} ${n.model}</strong> (${n.serial_number})<br>
             Customer: ${((o=n.customers)==null?void 0:o.name)||"Unknown"}<br>
             Status since: ${new Date(n.updated_at).toLocaleString()}</li>`}).join("")}
        </ul>
        <p>Please contact customers to arrange pickup or delivery.</p>
      `;await St.sendEmail({to:t.join(","),subject:`Overdue Device Handovers - ${e.length} devices`,content:a}),console.log(`Sent handover reminders for ${e.length} devices`)}catch(t){console.error("Error sending handover reminders:",t)}}async getCustomerCareEmails(){try{const{data:e,error:t}=await w.from("users").select("email").eq("role","customer-care");return t?(console.error("Error fetching customer care emails:",t),[]):(e==null?void 0:e.map(r=>r.email))||[]}catch(e){return console.error("Error getting customer care emails:",e),[]}}async manualCheck(){await this.checkOverdueHandovers()}}const fo=new Ly,Uy="clean-app-offline-sync",Cr="pending-actions";async function mn(){return Ka(Uy,1,{upgrade(s){s.objectStoreNames.contains(Cr)||s.createObjectStore(Cr,{keyPath:"id",autoIncrement:!0})}})}async function lS(s){await(await mn()).add(Cr,{...s,timestamp:Date.now()})}async function jy(){return(await mn()).getAll(Cr)}async function $y(){const e=(await mn()).transaction(Cr,"readwrite");await e.store.clear(),await e.done}const el=()=>{const{addJob:s,updateJob:e,removeJob:t}=zc(),r=D.useCallback(c=>{const l=s(c);return e(l,{status:"processing",progress:0}),l},[s,e]),a=D.useCallback((c,l)=>{e(c,{status:"processing",progress:Math.min(100,Math.max(0,l))})},[e]),n=D.useCallback(c=>{e(c,{status:"completed",progress:100}),setTimeout(()=>{t(c)},2e3)},[e,t]),o=D.useCallback((c,l)=>{e(c,{status:"failed",error:l}),setTimeout(()=>{t(c)},5e3)},[e,t]),i=D.useCallback(async(c,l)=>{const d=r(c);try{const u=await l(h=>a(d,h));return n(d),u}catch(u){throw o(d,(u==null?void 0:u.message)||"Operation failed"),u}},[r,a,n,o]);return{startLoading:r,updateProgress:a,completeLoading:n,failLoading:o,withLoading:i}},My=()=>{const{isPreloading:s,progress:e,status:t}=Fg(),{startLoading:r,updateProgress:a,completeLoading:n}=el(),o=D.useRef(null);return D.useEffect(()=>{s&&!o.current&&(o.current=r("Loading your data...")),o.current&&(a(o.current,e),!s&&e>=100&&(n(o.current),o.current=null))},[s,e,r,a,n]),null};class qy{constructor(){this.errors=[],this.maxErrors=1e3,this.isDevelopment=!1}log(e,t,r,a,n={}){const o={id:this.generateId(),level:e,category:t,message:r,error:a,context:{...n,timestamp:new Date},timestamp:new Date,stack:a==null?void 0:a.stack};this.errors.unshift(o),this.errors.length>this.maxErrors&&(this.errors=this.errors.slice(0,this.maxErrors)),this.logToConsole(o),(!this.isDevelopment&&e==="error"||e==="critical")&&this.sendToExternalService(o),e==="critical"&&this.showCriticalErrorNotification(o)}logDatabase(e,t,r={}){this.log("error","database",e,t,r)}logNetwork(e,t,r={}){this.log("error","network",e,t,r)}logValidation(e,t,r={}){this.log("warn","validation",e,t,r)}logAuth(e,t,r={}){this.log("error","authentication",e,t,r)}logBusiness(e,t,r={}){this.log("error","business_logic",e,t,r)}logUI(e,t,r={}){this.log("warn","ui",e,t,r)}logDebug(e,t={}){this.isDevelopment&&this.log("debug","unknown",e,void 0,t)}logInfo(e,t={}){this.log("info","unknown",e,void 0,t)}logWarning(e,t={}){this.log("warn","unknown",e,void 0,t)}getRecentErrors(e=50){return this.errors.slice(0,e)}getErrorsByCategory(e){return this.errors.filter(t=>t.category===e)}clearErrors(){this.errors=[]}getErrorStats(){const e={debug:0,info:0,warn:0,error:0,critical:0},t={database:0,network:0,validation:0,authentication:0,business_logic:0,ui:0,unknown:0};return this.errors.forEach(r=>{e[r.level]++,t[r.category]++}),{total:this.errors.length,byLevel:e,byCategory:t,recent:this.errors.slice(0,10)}}generateId(){return`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}logToConsole(e){const{level:t,category:r,message:a,error:n,context:o}=e,i=e.timestamp.toISOString(),c=o.component?`[${o.component}]`:"",l=o.action?`(${o.action})`:"",d=`[${i}] [${t.toUpperCase()}] [${r.toUpperCase()}] ${c} ${l} ${a}`;switch(t){case"debug":console.debug(d,n);break;case"info":console.info(d,n);break;case"warn":console.warn(d,n);break;case"error":console.error(d,n);break;case"critical":console.error(` CRITICAL: ${d}`,n);break}}sendToExternalService(e){this.isDevelopment&&console.log(" Would send to external service:",e)}showCriticalErrorNotification(e){this.isDevelopment&&console.error(" CRITICAL ERROR - User notification should be shown:",e.message)}}const De=new qy;De.log.bind(De);const ea=De.logDatabase.bind(De);De.logNetwork.bind(De);De.logValidation.bind(De);De.logAuth.bind(De);De.logBusiness.bind(De);De.logUI.bind(De);De.logDebug.bind(De);De.logInfo.bind(De);De.logWarning.bind(De);class dt{static isDevelopment(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}static validateFile(e){return e?this.ALLOWED_TYPES.includes(e.type)?e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File too large. Maximum size: ${this.MAX_FILE_SIZE/(1024*1024)}MB`}:{valid:!0}:{valid:!1,error:`Invalid file type. Allowed: ${this.ALLOWED_TYPES.join(", ")}`}:{valid:!1,error:"No file provided"}}static generateSafeFileName(e,t){var i;const r=Date.now(),a=Math.random().toString(36).substring(2,15),n=e.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase(),o=((i=t.split(".").pop())==null?void 0:i.toLowerCase())||"jpg";return`${n}_${r}_${a}.${o}`}static async fileToBase64(e){return new Promise((t,r)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=n=>r(n),a.readAsDataURL(e)})}static async uploadProductImage(e,t,r,a="gallery"){try{if(console.log(" uploadProductImage: Starting upload process"),!e)return console.error(" No file provided"),{success:!1,error:"No file provided"};if(!t)return console.error(" Product name is required"),{success:!1,error:"Product name is required"};if(!r)return console.error(" Product ID is required"),{success:!1,error:"Product ID is required"};console.log(" Input validation passed");const n=this.validateFile(e);if(!n.valid)return console.error(" File validation failed:",n.error),{success:!1,error:n.error};console.log(" File validation passed");let o="system";try{const{data:{user:_},error:b}=await w.auth.getUser();if(_&&!b)o=_.id,console.log(" Using Supabase user:",o);else{const S=localStorage.getItem("user");S?(o=JSON.parse(S).id||"system",console.log(" Using localStorage user:",o)):console.log(" Using system user (no auth required)")}}catch{console.log(" Auth check failed, using system user")}if(console.log(" Authentication passed (userId:",o,")"),this.isDevelopment()){console.log(" Using development mode (base64)");const _=await this.fileToBase64(e),b=this.generateSafeFileName(t,e.name);return{success:!0,url:_,fileName:b,isDevelopment:!0}}console.log(" Using production mode (local storage)"),console.log(" Uploading product image to local storage:",{fileName:e.name,fileSize:e.size,fileType:e.type,productName:t,productId:r,imageType:a});const i=this.generateSafeFileName(t,e.name),c=`${this.BASE_UPLOAD_PATH}/${i}`,l=`${this.BASE_THUMBNAIL_PATH}/${i}`,d=`${this.BASE_URL_PATH}/${i}`,u=`${this.BASE_THUMBNAIL_URL_PATH}/${i}`;console.log(" Generated paths:",{safeFileName:i,filePath:c,thumbnailPath:l,publicUrl:d,thumbnailUrl:u});const h=new FormData;h.append("file",e),h.append("product_id",r),h.append("product_name",t),h.append("file_path",c),h.append("image_type",a),console.log(" FormData prepared:",{product_id:r,product_name:t,file_path:c,image_type:a});const g="/server-product-upload-handler.php";console.log(" Making request to:",g);const p=await fetch(g,{method:"POST",body:h});if(console.log(" Response received:",{status:p.status,statusText:p.statusText,ok:p.ok}),!p.ok){const _=await p.text();throw console.error(" HTTP error:",_),new Error(`Upload failed: ${p.status} ${p.statusText} - ${_}`)}const m=await p.json();return console.log(" Response JSON:",m),m.success?(console.log(" Product image uploaded successfully:",m.url),{success:!0,url:m.url||d,thumbnailUrl:m.thumbnail_url||u}):(console.error(" Upload failed:",m.error),{success:!1,error:m.error||"Upload failed"})}catch(n){return console.error(" Error uploading product image:",n),console.error(" Error details:",{message:n.message,stack:n.stack,name:n.name}),{success:!1,error:n.message||"Upload failed"}}}static async uploadMultipleProductImages(e,t,r){const a=[];for(let n=0;n<e.length;n++){const o=e[n],i=n===0?"main":"gallery";console.log(` Uploading product image ${n+1}/${e.length}: ${o.name}`);const c=await this.uploadProductImage(o,t,r,i);a.push(c),c.success||console.error(` Failed to upload ${o.name}:`,c.error)}return a}static async getProductImages(e){try{if(e.startsWith("temp-product-")||e.startsWith("test-product-")||e.startsWith("temp-sparepart-"))return[];const{data:t,error:r}=await w.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1});return r?(console.error(" Failed to fetch product images:",r),[]):t.map(a=>({id:a.id,url:a.image_url,thumbnailUrl:a.thumbnail_url,localPath:a.local_path||"",fileName:a.file_name,fileSize:a.file_size,mimeType:a.mime_type||"image/jpeg",uploadedAt:a.created_at,isPrimary:a.is_primary}))}catch(t){return console.error(" Error fetching product images:",t),[]}}static async deleteProductImage(e){try{const{data:t,error:r}=await w.from("product_images").select("*").eq("id",e).single();if(r||!t)return{success:!1,error:"Image not found"};const a=await fetch("/server-product-upload-handler.php",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:t.image_url})});if(!a.ok){const o=await a.text();return console.error(" Server delete failed:",o),{success:!1,error:"Failed to delete from server"}}const{error:n}=await w.from("product_images").delete().eq("id",e);return n?(console.error(" Database delete failed:",n),{success:!1,error:"Failed to delete database record"}):(console.log(" Product image deleted successfully:",e),{success:!0})}catch(t){return console.error(" Error deleting product image:",t),{success:!1,error:t.message||"Delete failed"}}}static async setPrimaryImage(e){try{const{error:t}=await w.from("product_images").update({is_primary:!0}).eq("id",e);return t?(console.error(" Failed to set primary image:",t),{success:!1,error:t.message}):(console.log(" Primary image set successfully:",e),{success:!0})}catch(t){return console.error(" Error setting primary image:",t),{success:!1,error:t.message||"Failed to set primary image"}}}}dt.MAX_FILE_SIZE=10*1024*1024;dt.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif"];dt.BASE_UPLOAD_PATH="/public/uploads/products";dt.BASE_THUMBNAIL_PATH="/public/uploads/thumbnails";dt.BASE_URL_PATH="/uploads/products";dt.BASE_THUMBNAIL_URL_PATH="/uploads/thumbnails";class Ar{static async compressImage(e,t={}){const r={...this.DEFAULT_OPTIONS,...t};return new Promise((a,n)=>{const o=document.createElement("canvas"),i=o.getContext("2d");if(!i){n(new Error("Canvas context not available"));return}const c=new Image;c.onload=()=>{try{const{width:l,height:d}=this.calculateDimensions(c.width,c.height,r.maxWidth,r.maxHeight,r.maintainAspectRatio);o.width=l,o.height=d,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(c,0,0,l,d);const u=this.getMimeType(r.format);o.toBlob(h=>{if(h){const g=e.size/h.size;a({blob:h,width:l,height:d,size:h.size,format:r.format,compressionRatio:g})}else n(new Error("Failed to create compressed image"))},u,r.quality)}catch(l){n(l)}},c.onerror=()=>{n(new Error("Failed to load image"))},c.src=URL.createObjectURL(e)})}static async generateOptimalThumbnail(e,t="SMALL"){const r=this.THUMBNAIL_SPECS[t];try{const a=await this.compressImage(e,{maxWidth:r.width,maxHeight:r.height,quality:r.quality,format:"webp",maintainAspectRatio:!1});if(a.size<=r.maxSizeKB*1024)return console.log(` Optimal ${t} thumbnail generated (WebP):`,{size:`${(a.size/1024).toFixed(1)}KB`,dimensions:`${a.width}x${a.height}`,compressionRatio:a.compressionRatio.toFixed(2)}),a;const n=Math.max(.5,r.quality-.1),o=await this.compressImage(e,{maxWidth:r.width,maxHeight:r.height,quality:n,format:"webp",maintainAspectRatio:!1});if(o.size<=r.maxSizeKB*1024)return console.log(` Optimal ${t} thumbnail generated (WebP, reduced quality):`,{size:`${(o.size/1024).toFixed(1)}KB`,dimensions:`${o.width}x${o.height}`,compressionRatio:o.compressionRatio.toFixed(2)}),o}catch(a){console.warn(" WebP generation failed, falling back to JPEG:",a)}try{const a=await this.compressImage(e,{maxWidth:r.width,maxHeight:r.height,quality:r.quality,format:"jpeg",maintainAspectRatio:!1});if(a.size>r.maxSizeKB*1024){const n=Math.max(.4,r.quality-.2),o=await this.compressImage(e,{maxWidth:r.width,maxHeight:r.height,quality:n,format:"jpeg",maintainAspectRatio:!1});return console.log(` Optimal ${t} thumbnail generated (JPEG, reduced quality):`,{size:`${(o.size/1024).toFixed(1)}KB`,dimensions:`${o.width}x${o.height}`,compressionRatio:o.compressionRatio.toFixed(2)}),o}return console.log(` Optimal ${t} thumbnail generated (JPEG):`,{size:`${(a.size/1024).toFixed(1)}KB`,dimensions:`${a.width}x${a.height}`,compressionRatio:a.compressionRatio.toFixed(2)}),a}catch(a){throw console.error(" JPEG fallback also failed:",a),new Error("Failed to generate optimal thumbnail in any format")}}static async generateThumbnailSet(e){const[t,r,a]=await Promise.all([this.generateOptimalThumbnail(e,"SMALL"),this.generateOptimalThumbnail(e,"MEDIUM"),this.generateOptimalThumbnail(e,"LARGE")]);return{small:t,medium:r,large:a}}static async uploadCompressedThumbnail(e,t,r,a="product-images"){try{const n=Date.now(),o=Math.random().toString(36).substring(2,15),i=this.getFileExtension(e.format),c=`thumb_${n}_${o}.${i}`,l=`${t}/thumbnails/${c}`;console.log(" Uploading compressed thumbnail:",{originalFile:r,thumbnailFile:c,originalSize:e.size,compressionRatio:e.compressionRatio.toFixed(2),format:e.format});const{data:d,error:u}=await w.storage.from(a).upload(l,e.blob,{cacheControl:"31536000",upsert:!1,contentType:this.getMimeType(e.format)});if(console.log(" DEBUG: Thumbnail upload response:",{data:d,error:u}),u)return console.error(" Thumbnail upload failed:",u),console.error(" Upload error details:",{message:u.message,statusCode:u.statusCode,details:u}),null;if(!d)return console.error(" Thumbnail upload succeeded but no data returned"),null;console.log(" DEBUG: Upload successful, uploaded path:",d.path);const{data:h}=w.storage.from(a).getPublicUrl(d.path);return console.log(" DEBUG: getPublicUrl response:",{urlData:h}),!h||!h.publicUrl?(console.error(" Failed to get public URL for thumbnail"),null):(console.log(" Compressed thumbnail uploaded successfully:",{url:h.publicUrl,size:e.size,compressionRatio:e.compressionRatio.toFixed(2)}),h.publicUrl)}catch(n){return console.error(" Thumbnail upload error:",n),null}}static calculateDimensions(e,t,r,a,n){if(!n)return{width:r,height:a};const o=e/t;let i=r,c=a;return o>1?(c=i/o,c>a&&(c=a,i=c*o)):(i=c*o,i>r&&(i=r,c=i/o)),{width:Math.round(i),height:Math.round(c)}}static getOptimalFormat(e){const t=document.createElement("canvas");return t.getContext("2d")&&(t.width=1,t.height=1,t.toDataURL("image/webp").startsWith("data:image/webp"))?"webp":e.includes("png")||e.includes("transparent")?"png":"jpeg"}static isWebPSupported(){const e=document.createElement("canvas");return e.getContext("2d")?(e.width=1,e.height=1,e.toDataURL("image/webp").startsWith("data:image/webp")):!1}static getFileExtension(e){switch(e.toLowerCase()){case"webp":return"webp";case"jpeg":case"jpg":return"jpg";case"png":return"png";default:return"jpg"}}static getMimeType(e){switch(e.toLowerCase()){case"webp":return"image/webp";case"jpeg":case"jpg":return"image/jpeg";case"png":return"image/png";default:return"image/jpeg"}}static formatFileSize(e){if(e===0)return"0 B";const t=1024,r=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return`${parseFloat((e/Math.pow(t,a)).toFixed(2))} ${r[a]}`}static getCompressionStats(e,t){const r=e-t,a=(r/e*100).toFixed(1);return{originalSize:this.formatFileSize(e),compressedSize:this.formatFileSize(t),savings:this.formatFileSize(r),savingsPercent:a,compressionRatio:(e/t).toFixed(2)}}}Ar.DEFAULT_OPTIONS={maxWidth:300,maxHeight:300,quality:.8,format:"webp",maintainAspectRatio:!0};Ar.THUMBNAIL_SPECS={SMALL:{width:150,height:150,quality:.85,maxSizeKB:50},MEDIUM:{width:200,height:200,quality:.8,maxSizeKB:80},LARGE:{width:300,height:300,quality:.75,maxSizeKB:120}};class bt{static getDevImages(e){return this.devImageStorage.get(e)||[]}static clearImageCache(e){e?(this.imageCache.delete(e),console.log(" EnhancedImageUploadService: Cleared image cache for product:",e)):(this.imageCache.clear(),console.log(" EnhancedImageUploadService: Cleared all image cache"))}static clearDevImages(e){this.devImageStorage.delete(e)}static async diagnoseUploadEnvironment(){const e=[],t=navigator.onLine;t||e.push("No internet connection");let r=!1;try{const{data:o,error:i}=await w.from("devices").select("id").limit(1);r=!i,i&&e.push(`Supabase connection failed: ${i.message}`)}catch(o){e.push(`Supabase connection error: ${o.message}`)}let a=!1;try{const{data:o,error:i}=await w.storage.from("product-images").list("",{limit:1});a=!i,i&&e.push(`Storage access failed: ${i.message}`)}catch(o){e.push(`Storage access error: ${o.message}`)}return{networkStatus:t,supabaseConnection:r,storageAccess:a,fileSizeLimit:!0,issues:e}}static async convertPngToWhiteBackground(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>{try{const n=document.createElement("canvas");n.width=a.width,n.height=a.height;const o=n.getContext("2d");if(!o){r(new Error("Failed to get canvas context"));return}o.fillStyle="#FFFFFF",o.fillRect(0,0,n.width,n.height),o.drawImage(a,0,0),n.toBlob(i=>{if(!i){r(new Error("Failed to convert canvas to blob"));return}const c=new File([i],e.name,{type:"image/png",lastModified:Date.now()});t(c)},"image/png",.95)}catch(n){r(n)}},a.onerror=()=>{r(new Error("Failed to load image"))},a.src=URL.createObjectURL(e)})}static async uploadImage(e,t,r,a={}){var n;try{if(!e)return{success:!1,error:"No file provided"};if(!t)return{success:!1,error:"Product ID is required"};if(!r)return{success:!1,error:"User ID is required"};let o=e;if(e.type==="image/png"){console.log(" Converting PNG transparent background to white...");try{o=await this.convertPngToWhiteBackground(e),console.log(" PNG background converted to white successfully")}catch(M){console.warn(" Failed to convert PNG background, using original file:",M)}}const{bucket:i="product-images",maxFileSize:c=this.DEFAULT_MAX_FILE_SIZE,allowedTypes:l=this.DEFAULT_ALLOWED_TYPES,generateThumbnail:d=!0,thumbnailSize:u={width:300,height:300},isPrimary:h=!1}=a,g=this.validateFile(o,c,l);if(!g.valid)return{success:!1,error:g.error};let p=r&&r!=="system"?r:null;try{const{data:{user:M},error:L}=await w.auth.getUser();if(M&&!L)p=M.id,console.log(" Using Supabase user:",p);else{const B=localStorage.getItem("user");if(B){const U=JSON.parse(B);p=U.id&&U.id!=="system"?U.id:null,console.log(" Using localStorage user:",p)}else console.log(" Using null for system user (no auth)")}}catch{console.log(" Auth check failed, using null for system user")}const m=Date.now(),_=Math.random().toString(36).substring(2,15),b=((n=e.name.split(".").pop())==null?void 0:n.toLowerCase())||"jpg",S=`${m}_${_}.${b}`,v=`${t}/${S}`;console.log(" Uploading image:",{fileName:e.name,fileSize:o.size,fileType:o.type,bucket:i,path:v});const C=async()=>{const M=w.storage.from(i).upload(v,o,{cacheControl:"3600",upsert:!1,contentType:o.type}),L=new Promise((B,U)=>{setTimeout(()=>U(new Error("Upload timeout after 30 seconds")),3e4)});return Promise.race([M,L])};console.log(" Starting upload with 30-second timeout...");const{data:T,error:x}=await C();if(console.log(" Upload completed:",{uploadData:T,uploadError:x}),x){if(console.error(" Upload failed:",x),console.error(" Upload error details:",{message:x.message,statusCode:x.statusCode,error:x.error,details:x.details}),t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-")){console.log(" Attempting local fallback for temporary product...");try{const M=URL.createObjectURL(o),L={id:`local-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,url:M,thumbnailUrl:M,fileName:e.name,fileSize:o.size,mimeType:o.type,isPrimary:h,uploadedAt:new Date().toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(L),console.log(" Local fallback successful:",L),{success:!0,image:L}}catch(M){console.error(" Local fallback also failed:",M)}}return{success:!1,error:this.getErrorMessage(x)}}console.log(" File uploaded successfully to storage");const{data:R}=w.storage.from(i).getPublicUrl(v),k=await this.getImageDimensions(o);let P;if(d&&o.type!=="image/svg+xml")try{console.log(" Generating optimal thumbnail with recommended specifications...");const M=await Ar.generateOptimalThumbnail(o,"SMALL"),L=Ar.getCompressionStats(o.size,M.size);console.log(" Optimal thumbnail stats:",{original:L.originalSize,compressed:L.compressedSize,savings:`${L.savings} (${L.savingsPercent}%)`,ratio:L.compressionRatio,dimensions:`${M.width}x${M.height}`,format:M.format}),P=await Ar.uploadCompressedThumbnail(M,t,e.name,i),P?console.log(" Optimal thumbnail uploaded successfully"):console.warn(" Failed to upload optimal thumbnail, continuing without thumbnail")}catch(M){console.error(" Optimal thumbnail generation failed:",M)}if(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-")){console.log(" Skipping database record for temporary product:",t);const M={id:`temp-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,url:R.publicUrl,thumbnailUrl:P,fileName:e.name,fileSize:o.size,mimeType:o.type,width:k==null?void 0:k.width,height:k==null?void 0:k.height,isPrimary:h,uploadedAt:new Date().toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(M),console.log(" Image uploaded successfully (temporary product):",M),console.log(" Stored in dev storage for product:",t),console.log(" Total dev images for this product:",this.devImageStorage.get(t).length),console.log(" All dev storage keys:",Array.from(this.devImageStorage.keys())),console.log(" Dev storage size:",this.devImageStorage.size),{success:!0,image:M}}const{data:O,error:N}=await w.from("product_images").insert({product_id:t,image_url:R.publicUrl,thumbnail_url:P,file_name:e.name,file_size:o.size,is_primary:h,uploaded_by:r}).select().single();if(N)return console.error(" Database insert failed:",N),await w.storage.from(i).remove([v]),{success:!1,error:`Upload succeeded but database record failed: ${N.message}`};const $={id:O.id,url:R.publicUrl,thumbnailUrl:P,fileName:e.name,fileSize:o.size,mimeType:o.type,width:k==null?void 0:k.width,height:k==null?void 0:k.height,isPrimary:h,uploadedAt:O.created_at};return console.log(" Image uploaded successfully:",$),{success:!0,image:$}}catch(o){return console.error(" Upload error:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error occurred"}}}static async uploadMultipleImages(e,t,r,a={}){const n=[];for(let o=0;o<e.length;o++){const i=e[o],c=o===0,l=await this.uploadImage(i,t,r,{...a,isPrimary:c});n.push(l),o<e.length-1&&await new Promise(d=>setTimeout(d,100))}return n}static async deleteImage(e,t="product-images",r){try{if(r&&(r.startsWith("temp-product-")||r.startsWith("test-product-")||r.startsWith("temp-sparepart-"))){console.log(" Deleting image for temporary product:",r,"imageId:",e);const h=this.devImageStorage.get(r)||[];if(!h.find(m=>m.id===e))return console.error(" Image not found in development storage:",e),{success:!1,error:"Image not found"};const p=h.filter(m=>m.id!==e);return this.devImageStorage.set(r,p),console.log(" Image deleted from development storage:",e),{success:!0}}const{data:a,error:n}=await w.from("product_images").select("*").eq("id",e).single();if(n||!a)return{success:!1,error:"Image not found"};const o=a.image_url.split("/"),i=o[o.length-1],l=`${o[o.length-2]}/${i}`,{error:d}=await w.storage.from(t).remove([l]);if(d)return console.error(" Storage delete failed:",d),{success:!1,error:this.getErrorMessage(d)};const{error:u}=await w.from("product_images").delete().eq("id",e);return u?(console.error(" Database delete failed:",u),{success:!1,error:this.getErrorMessage(u)}):(console.log(" Image deleted successfully:",e),{success:!0})}catch(a){return console.error(" Delete error:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}static async setPrimaryImage(e,t){try{if(t&&(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-"))){console.log(" Setting primary image for temporary product:",t,"imageId:",e);const n=this.devImageStorage.get(t)||[];n.forEach(i=>{i.isPrimary=!1});const o=n.find(i=>i.id===e);return o?(o.isPrimary=!0,console.log(" Primary image set successfully for temporary product:",e),{success:!0}):(console.error(" Image not found in development storage:",e),{success:!1,error:"Image not found"})}const{data:r,error:a}=await w.from("product_images").update({is_primary:!0}).eq("id",e).select().single();return a?(console.error(" Set primary failed:",a),{success:!1,error:this.getErrorMessage(a)}):(console.log(" Primary image set successfully:",e),{success:!0})}catch(r){return console.error(" Set primary error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}static async getProductImages(e){try{const{data:t,error:r}=await w.from("product_images").select("*").eq("product_id",e).order("is_primary",{ascending:!1});return r?(console.error(" Get images failed:",r),[]):t.map(a=>({id:a.id,url:a.image_url,thumbnailUrl:a.thumbnail_url,fileName:a.file_name,fileSize:a.file_size,mimeType:a.mime_type,width:a.width,height:a.height,isPrimary:a.is_primary,uploadedAt:a.created_at}))}catch(t){return console.error(" Get images error:",t),[]}}static validateFile(e,t,r){return e.size>t?{valid:!1,error:`File size exceeds maximum allowed size of ${Math.round(t/1024/1024)}MB`}:r.includes(e.type)?{valid:!0}:{valid:!1,error:`File type ${e.type} is not allowed. Allowed types: ${r.join(", ")}`}}static async getImageDimensions(e){return new Promise(t=>{if(e.type==="image/svg+xml"){t(null);return}const r=new Image;r.onload=()=>{t({width:r.width,height:r.height})},r.onerror=()=>{t(null)},r.src=URL.createObjectURL(e)})}static getErrorMessage(e){return typeof e=="string"?e:e!=null&&e.message?e.message:e!=null&&e.error_description?e.error_description:"Unknown error occurred"}static async updateProductImages(e,t){try{console.log(" EnhancedImageUploadService: Updating product images from temp ID to real ID:",{tempProductId:e,realProductId:t});const{data:{user:r},error:a}=await w.auth.getUser();if(a||!r)return console.error(" Failed to get authenticated user:",a),{success:!1,error:"Authentication required"};const n=this.getDevImages(e);if(console.log(" EnhancedImageUploadService: Checking dev storage for:",e),console.log(" EnhancedImageUploadService: All dev storage keys:",Array.from(this.devImageStorage.keys())),console.log(" EnhancedImageUploadService: Dev storage size:",this.devImageStorage.size),console.log(" EnhancedImageUploadService: Found dev images:",(n==null?void 0:n.length)||0),n&&n.length>0){console.log(" EnhancedImageUploadService: Found development mode images:",n.length);const o=n.map((l,d)=>({product_id:t,image_url:l.url,thumbnail_url:l.thumbnailUrl,file_name:l.fileName,file_size:l.fileSize,is_primary:d===0,uploaded_by:r.id})),{data:i,error:c}=await w.from("product_images").insert(o).select();return c?(console.error(" Failed to insert development mode image records:",c),{success:!1,error:c.message}):(console.log(" EnhancedImageUploadService: Successfully created development mode image records:",{tempProductId:e,realProductId:t,createdCount:(i==null?void 0:i.length)||0}),this.clearDevImages(e),this.clearImageCache(t),{success:!0})}return console.log(" EnhancedImageUploadService: No development mode images found for:",e),{success:!0}}catch(r){return console.error(" EnhancedImageUploadService: Error updating product images:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}static async testBucketAccess(e="product-images"){try{const{data:t,error:r}=await w.storage.from(e).list("",{limit:1});return r?{success:!1,error:this.getErrorMessage(r)}:{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}}bt.DEFAULT_MAX_FILE_SIZE=10*1024*1024;bt.DEFAULT_ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif","image/svg+xml"];bt.devImageStorage=new Map;bt.imageCache=new Map;bt.CACHE_DURATION=5*60*1e3;const By=Object.freeze(Object.defineProperty({__proto__:null,EnhancedImageUploadService:bt},Symbol.toStringTag,{value:"Module"})),zt=w;class ur{static async convertPngToWhiteBackground(e){return new Promise((t,r)=>{const a=new Image;a.onload=()=>{try{const n=document.createElement("canvas");n.width=a.width,n.height=a.height;const o=n.getContext("2d");if(!o){r(new Error("Failed to get canvas context"));return}o.fillStyle="#FFFFFF",o.fillRect(0,0,n.width,n.height),o.drawImage(a,0,0),n.toBlob(i=>{if(!i){r(new Error("Failed to convert canvas to blob"));return}const c=new File([i],e.name,{type:"image/png",lastModified:Date.now()});t(c)},"image/png",.95)}catch(n){r(n)}},a.onerror=()=>{r(new Error("Failed to load image"))},a.src=URL.createObjectURL(e)})}static async uploadImage(e,t,r,a=!1){try{console.log(" DEBUG: ImageUploadService.uploadImage called"),console.log(" DEBUG: Parameters:",{productId:t,userId:r,isPrimary:a}),console.log(" DEBUG: File info:",{name:e.name,size:e.size,type:e.type});let n=e;if(e.type==="image/png"){console.log(" Converting PNG transparent background to white...");try{n=await this.convertPngToWhiteBackground(e),console.log(" PNG background converted to white successfully")}catch(h){console.warn(" Failed to convert PNG background, using original file:",h)}}if(!e)return console.error(" DEBUG: No file provided"),{success:!1,error:"No file provided"};if(!t)return console.error(" DEBUG: Product ID is required"),{success:!1,error:"Product ID is required"};if(!r)return console.error(" DEBUG: User ID is required"),{success:!1,error:"User ID is required"};console.log(" DEBUG: Input validation passed");const o=this.validateFile(n);if(!o.valid)return console.error(" DEBUG: File validation failed:",o.error),{success:!1,error:o.error};console.log(" DEBUG: File validation passed"),console.log(" DEBUG: Checking authentication...");let i=r&&r!=="system"?r:null;try{const{data:{user:h},error:g}=await zt.auth.getUser();if(h&&!g)i=h.id,console.log(" Using Supabase user:",i);else{const p=localStorage.getItem("user");if(p){const m=JSON.parse(p);i=m.id&&m.id!=="system"?m.id:null,console.log(" Using localStorage user:",i)}else console.log(" Using null for system user (no auth)")}}catch{console.log(" Auth check failed, using null for system user")}console.log(" DEBUG: Authentication successful, user:",i),console.log(" Using local storage service for product images");const c="product",l=await dt.uploadProductImage(n,c,t,a?"main":"gallery");if(!l.success)return console.error(" Local storage upload failed:",l.error),{success:!1,error:l.error};if(t.startsWith("temp-product-")||t.startsWith("test-product-")||t.startsWith("temp-sparepart-")){console.log(" DEBUG: Uploading to storage only for temporary product:",t);const h={id:`temp-${Date.now()}-${crypto.randomUUID().replace(/-/g,"").substring(0,8)}`,url:l.url||"",fileName:e.name,fileSize:n.size,mimeType:n.type,isPrimary:a,uploadedAt:new Date().toISOString()};return this.devImageStorage.has(t)||this.devImageStorage.set(t,[]),this.devImageStorage.get(t).push(h),console.log(" DEBUG: Image uploaded to storage (temporary):",h),console.log(" DEBUG: Stored in dev storage for product:",t),{success:!0,image:h}}return console.log(" DEBUG: Image uploaded successfully via local storage"),{success:!0,image:(await this.getProductImages(t)).find(h=>h.fileName===e.name)||{id:`temp-${Date.now()}`,url:l.url||"",fileName:e.name,fileSize:n.size,mimeType:n.type,isPrimary:a,uploadedAt:new Date().toISOString()}}}catch(n){return console.error(" DEBUG: Upload error:",n),console.error(" DEBUG: Error type:",typeof n),console.error(" DEBUG: Error message:",n instanceof Error?n.message:"Unknown error"),console.error(" DEBUG: Error stack:",n instanceof Error?n.stack:"No stack trace"),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}}static async uploadMultipleImages(e,t,r){const a=[];for(let n=0;n<e.length;n++){const o=e[n],i=n===0;console.log(` Uploading image ${n+1}/${e.length}: ${o.name}`);const c=await this.uploadImage(o,t,r,i);a.push(c),c.success||console.error(` Failed to upload ${o.name}:`,c.error)}return a}static async deleteImage(e){try{const t=await dt.deleteProductImage(e);return t.success?(console.log(" Image deleted successfully:",e),{success:!0}):(console.error(" Delete failed:",t.error),{success:!1,error:t.error})}catch(t){return console.error(" Delete error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}static async updateProductImages(e,t){var r;try{console.log(" Updating product images from temp ID to real ID:",{tempProductId:e,realProductId:t});const{data:{user:a},error:n}=await zt.auth.getUser();if(n||!a)return console.error(" Failed to get authenticated user:",n),{success:!1,error:"Authentication required"};const o=this.devImageStorage.get(e),i=bt.getDevImages(e);console.log(" ImageUploadService: Checking dev storage for:",e),console.log(" ImageUploadService: All dev storage keys:",Array.from(this.devImageStorage.keys())),console.log(" ImageUploadService: Dev storage size:",this.devImageStorage.size),console.log(" ImageUploadService: Regular service images:",(o==null?void 0:o.length)||0),console.log(" ImageUploadService: Enhanced service images:",(i==null?void 0:i.length)||0);const c=[...o||[],...i||[]];if(c.length>0){console.log(" Found development mode images:",c.length),console.log(" Regular service images:",(o==null?void 0:o.length)||0),console.log(" Enhanced service images:",(i==null?void 0:i.length)||0);const b=c.map((C,T)=>({product_id:t,image_url:C.url,file_name:C.fileName,file_size:C.fileSize,is_primary:T===0,uploaded_by:a.id})),{data:S,error:v}=await zt.from("product_images").insert(b).select();return v?(console.error(" Failed to insert development mode image records:",v),{success:!1,error:v.message}):(console.log(" Successfully created development mode image records:",{tempProductId:e,realProductId:t,createdCount:(S==null?void 0:S.length)||0}),this.devImageStorage.delete(e),bt.clearDevImages(e),this.clearImageCache(t),{success:!0})}console.log(" No development mode images found, checking for recent uploads...");const{data:l,error:d}=await zt.storage.from("product-images").list("temp",{limit:100,offset:0});if(d)return console.error(" Failed to list storage files:",d),{success:!1,error:d.message};if(!l||l.length===0)return console.log(" No storage files found in temp directory"),{success:!0};console.log(" Found storage files in temp directory:",l);const u=e.replace("temp-product-","");console.log(" Looking for files with timestamp:",u);const h=[];let g=!1,p=!1;for(const b of l){if(!b.name.match(/\.(jpg|jpeg|png|gif|webp)$/i))continue;const S=b.name.split("_");if(S.length<2){console.log(" Skipping file with invalid format:",b.name);continue}const v=S[1];if(v!==u){console.log(" Skipping file with different timestamp:",b.name,"expected:",u,"got:",v);continue}console.log(" Found matching file:",b.name),p=!0;const C=`temp/${b.name}`,{data:T}=zt.storage.from("product-images").getPublicUrl(C),x={product_id:t,image_url:T.publicUrl,file_name:b.name,file_size:((r=b.metadata)==null?void 0:r.size)||0,is_primary:!g,uploaded_by:a.id};g||(g=!0),h.push(x)}if(!p)return console.log(" No matching files found for timestamp:",u),console.log(" This might be a development mode issue where images were not properly stored"),console.log(" Available files:",l.map(b=>b.name)),{success:!0};if(h.length===0)return console.log(" No valid image files found"),{success:!0};const{data:m,error:_}=await zt.from("product_images").insert(h).select();return _?(console.error(" Failed to insert image records:",_),{success:!1,error:_.message}):(console.log(" Successfully created image records:",{tempProductId:e,realProductId:t,createdCount:(m==null?void 0:m.length)||0}),this.clearImageCache(t),{success:!0})}catch(a){return console.error(" Error updating product images:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}static async getProductImages(e){try{if(e.startsWith("temp-product-")||e.startsWith("test-product-")||e.startsWith("temp-sparepart-")){console.log(" Getting images from development storage for temporary product:",e);const{EnhancedImageUploadService:n}=await z(()=>Promise.resolve().then(()=>By),void 0),o=n.getDevImages(e);return console.log(" Development storage images for product:",e,"count:",o.length),o}const t=this.imageCache.get(e);if(t&&Date.now()-t.timestamp<this.CACHE_DURATION)return console.log(" Returning cached images for product:",e),t.images;const a=(await dt.getProductImages(e)).map(n=>({id:n.id,url:n.url,thumbnailUrl:n.thumbnailUrl,fileName:n.fileName,fileSize:n.fileSize,mimeType:n.mimeType,isPrimary:n.isPrimary,uploadedAt:n.uploadedAt}));return this.imageCache.set(e,{images:a,timestamp:Date.now()}),console.log(" Cached images for product:",e,"count:",a.length),a}catch(t){return console.error(" Get images error:",t),[]}}static clearImageCache(e){e?(this.imageCache.delete(e),console.log(" Cleared image cache for product:",e)):(this.imageCache.clear(),console.log(" Cleared all image cache"))}static validateFile(e){return e.size>this.MAX_FILE_SIZE?{valid:!1,error:`File size ${(()=>(e.size/1024/1024).toFixed(2).replace(/\.00$/,"").replace(/\.0$/,""))()}MB exceeds limit of ${(()=>(this.MAX_FILE_SIZE/1024/1024).toFixed(2).replace(/\.00$/,"").replace(/\.0$/,""))()}MB`}:this.ALLOWED_TYPES.includes(e.type)?e.type.startsWith("image/")?{valid:!0}:{valid:!1,error:"File must be an image"}:{valid:!1,error:`File type ${e.type} is not allowed. Allowed types: ${this.ALLOWED_TYPES.join(", ")}`}}static getErrorMessage(e){const t=e.message||"Unknown error",r=e.statusCode||e.status;return console.error(" DEBUG: Error details:",{message:t,statusCode:r,error:e.error,details:e.details,name:e.name}),r===400?t.includes("duplicate")?"File with this name already exists. Please rename the file.":t.includes("size")?"File size is too large. Please use a smaller image.":t.includes("type")||t.includes("mime")?"File type not supported. Please use JPEG, PNG, or WebP.":t.includes("bucket")?"Storage bucket not found. Please contact support.":`Upload failed (400): ${t}`:r===401?"Authentication failed. Please log in again.":r===403?"Permission denied. Please check your account access.":r===404?"Storage bucket not found. Please contact support.":r===413?"File size is too large. Please use a smaller image.":t.includes("permission")?"Permission denied. Please check your account access.":t.includes("bucket")?"Storage bucket not found. Please contact support.":`Upload failed: ${t}`}}ur.devImageStorage=new Map;ur.imageCache=new Map;ur.CACHE_DURATION=5*60*1e3;ur.MAX_FILE_SIZE=10*1024*1024;ur.ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp","image/gif"];class Fy{constructor(){this.pendingRequests=new Map,this.REQUEST_TIMEOUT=9e4}async deduplicate(e,t,r){const a=(r==null?void 0:r.timeout)||this.REQUEST_TIMEOUT,n=(r==null?void 0:r.forceRefresh)||!1;this.cleanupExpiredRequests();const o=this.pendingRequests.get(e);if(o&&!n)return console.log(` [Dedup] Reusing in-progress request: ${e}`),o.promise;console.log(` [Dedup] Starting new request: ${e}`);const i=t();this.pendingRequests.set(e,{promise:i,timestamp:Date.now()});let c=null;try{const l=new Promise((u,h)=>{c=setTimeout(()=>{this.pendingRequests.delete(e),h(new Error(`Request timeout: ${e}`))},a)}),d=await Promise.race([i,l]);return c&&clearTimeout(c),d}catch(l){throw c&&clearTimeout(c),this.pendingRequests.delete(e),l}finally{c&&clearTimeout(c),this.pendingRequests.delete(e)}}clear(e){this.pendingRequests.delete(e)}clearAll(){this.pendingRequests.clear()}cleanupExpiredRequests(){const e=Date.now();for(const[t,r]of this.pendingRequests.entries())e-r.timestamp>this.REQUEST_TIMEOUT&&(console.warn(` [Dedup] Removing expired request: ${t}`),this.pendingRequests.delete(t))}getStats(){return{pendingCount:this.pendingRequests.size,keys:Array.from(this.pendingRequests.keys())}}}const tl=new Fy;async function pn(s,e,t){return tl.deduplicate(s,e,t)}const uS=Object.freeze(Object.defineProperty({__proto__:null,deduplicateRequest:pn,requestDeduplicator:tl},Symbol.toStringTag,{value:"Module"}));class zy{constructor(){this.cache=new Map,this.DEFAULT_TTL=5*60*1e3,this.MAX_CACHE_SIZE=100}async get(e,t,r){const a=(r==null?void 0:r.ttl)||this.DEFAULT_TTL,n=(r==null?void 0:r.staleWhileRevalidate)||!1;this.cleanupExpired();const o=this.cache.get(e),i=Date.now();if(o){if(o.expiresAt>i)return console.log(` [Cache] HIT (fresh): ${e}`),o.data;if(n)return console.log(` [Cache] HIT (stale): ${e} - revalidating in background`),this.revalidateInBackground(e,t,a),o.data}return console.log(` [Cache] MISS: ${e}`),this.fetchAndCache(e,t,a)}async fetchAndCache(e,t,r){const a=await t();return this.set(e,a,r),a}set(e,t,r){const a=Date.now(),n=r||this.DEFAULT_TTL;if(this.cache.size>=this.MAX_CACHE_SIZE&&!this.cache.has(e)){const o=this.getOldestKey();o&&this.cache.delete(o)}this.cache.set(e,{data:t,timestamp:a,expiresAt:a+n}),console.log(` [Cache] SET: ${e} (TTL: ${n}ms)`)}invalidate(e){this.cache.delete(e),console.log(` [Cache] INVALIDATE: ${e}`)}invalidatePattern(e){const t=typeof e=="string"?new RegExp(e):e;let r=0;for(const a of this.cache.keys())t.test(a)&&(this.cache.delete(a),r++);console.log(` [Cache] INVALIDATE PATTERN: ${e} (${r} entries)`)}clear(){const e=this.cache.size;this.cache.clear(),console.log(` [Cache] CLEAR ALL (${e} entries)`)}async revalidateInBackground(e,t,r){try{const a=await t();this.set(e,a,r),console.log(` [Cache] REVALIDATED: ${e}`)}catch(a){console.error(` [Cache] REVALIDATION FAILED: ${e}`,a)}}cleanupExpired(){const e=Date.now();let t=0;for(const[r,a]of this.cache.entries())a.expiresAt<e&&(this.cache.delete(r),t++);t>0&&console.log(` [Cache] CLEANUP: Removed ${t} expired entries`)}getOldestKey(){let e=null,t=1/0;for(const[r,a]of this.cache.entries())a.timestamp<t&&(t=a.timestamp,e=r);return e}getStats(){const e=Date.now(),t=Array.from(this.cache.entries()).map(([r,a])=>({key:r,age:e-a.timestamp,ttl:a.expiresAt-e}));return{size:this.cache.size,maxSize:this.MAX_CACHE_SIZE,hitRate:0,entries:t}}}const zr=new zy;async function fn(s,e,t){return zr.get(s,e,t)}function Vy(s){zr.invalidate(s)}function gn(s){zr.invalidatePattern(s)}function Gy(){zr.clear()}const dS=Object.freeze(Object.defineProperty({__proto__:null,clearCache:Gy,getCachedQuery:fn,invalidateCache:Vy,invalidateCachePattern:gn,queryCache:zr},Symbol.toStringTag,{value:"Module"}));function ta(s="Image",e=300,t=300){const r=`
    <svg width="${e}" height="${t}" viewBox="0 0 ${e} ${t}" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="${e}" height="${t}" fill="#F3F4F6"/>
      <text x="${e/2}" y="${t/2}" font-family="Arial, sans-serif" font-size="16" fill="#6B6B6B" text-anchor="middle" dy=".3em">${s}</text>
    </svg>
  `;return`data:image/svg+xml;base64,${btoa(r)}`}function ra(s="product",e){switch(s){case"thumbnail":return ta("Thumbnail",100,100);case"avatar":return ta(e||"U",40,40);case"product":default:return ta(e||"Product Image",300,300)}}function go(s){return s&&typeof s=="string"&&s.startsWith("data:")}function es(s,e){const t=Fr.sanitizeImageUrl(s,e);return t.isSanitized&&console.warn(" processImageUrl: URL sanitized to prevent 431 error:",{method:t.method,originalLength:t.originalLength,sanitizedLength:t.sanitizedLength}),t.url}function Wy(s){return Array.isArray(s)?s.map(e=>(e&&typeof e=="object"&&(e.image_url&&(e.image_url=es(e.image_url,e.file_name)),e.thumbnail_url&&(e.thumbnail_url=es(e.thumbnail_url,e.file_name)),e.url&&(e.url=es(e.url,e.fileName)),e.thumbnailUrl&&(e.thumbnailUrl=es(e.thumbnailUrl,e.fileName))),e)):[]}function ft(s){return!s||typeof s!="string"?ra("product"):go(s)&&s.length>8e3?(console.warn(` Replacing large base64 image (${Math.round(s.length/1024)}KB) with placeholder to prevent HTTP 431 errors`),ra("product")):!go(s)&&s.length>2e3?(console.error(" Emergency URL cleanup: URL extremely long, using fallback"),ra("product")):s}async function Hy(s,e){try{const{images:t,...r}=s,a=localStorage.getItem("current_branch_id"),n={name:r.name,description:r.description,sku:r.sku,category_id:r.categoryId,is_active:r.isActive??!0,total_quantity:0,total_value:0,branch_id:a};r.costPrice!==void 0&&(n.cost_price=r.costPrice),(r.sellingPrice!==void 0||r.price!==void 0)&&(n.selling_price=r.sellingPrice??r.price),(r.quantity!==void 0||r.stockQuantity!==void 0)&&(n.stock_quantity=r.quantity??r.stockQuantity),(r.minQuantity!==void 0||r.minStockLevel!==void 0)&&(n.min_stock_level=r.minQuantity??r.minStockLevel),r.storageRoomId&&(n.storage_room_id=r.storageRoomId),r.shelfId&&(n.shelf_id=r.shelfId),r.barcode&&(n.barcode=r.barcode),r.shortDescription&&(n.metadata||(n.metadata={}),n.metadata.shortDescription=r.shortDescription),r.maxStockLevel!==void 0&&(n.max_stock_level=r.maxStockLevel),r.internalNotes&&(n.attributes||(n.attributes={}),n.attributes.internalNotes=r.internalNotes),r.attributes&&(n.attributes={...n.attributes,...r.attributes}),r.specification&&(n.specification=r.specification,n.attributes||(n.attributes={}),n.attributes.specification=r.specification);const o=r.variants&&r.variants.length>0;n.metadata={...r.metadata||{},skip_default_variant:o,useVariants:o,variantCount:o?r.variants.length:0},r.supplierId&&(n.supplier_id=r.supplierId);const{data:i,error:c}=await w.from("lats_products").insert(n).select().single();if(c){if(console.error("Product creation error:",c),console.error("Product data being inserted:",n),c.code==="23505"){const d=c.message||"Duplicate key violation";if(d.includes("sku")||d.includes("SKU")){const u=new Error(`Product with SKU "${n.sku}" already exists. Please use a unique SKU or update the existing product.`);throw u.code=c.code,u}}throw c}if(r.variants&&r.variants.length>0){const d=a&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)?a:null,u=new Set,{generateSKU:h}=await z(()=>import("./skuUtils-60e0a165.js"),[]),g=async(R,k)=>{let P=R||"",O=0;const N=20;if(P&&!u.has(P)){const{data:M}=await w.from("lats_product_variants").select("sku").eq("sku",P).maybeSingle();if(!M)return u.add(P),P}for(;O<N;){const M=Date.now(),L=Math.random().toString(36).substring(2,9).toUpperCase(),B=Math.random().toString(36).substring(2,9).toUpperCase();if(P=`SKU-${M}-${k}-${L}-${B}`,!u.has(P)){const{data:U}=await w.from("lats_product_variants").select("sku").eq("sku",P).maybeSingle();if(!U)return u.add(P),P}O++}const $=`SKU-${Date.now()}-${k}-${Math.random().toString(36).substring(2,15).toUpperCase()}-${Math.random().toString(36).substring(2,15).toUpperCase()}`;return u.add($),$},p=[];for(let R=0;R<r.variants.length;R++){const k=r.variants[R],P=await g(k.sku,R);if(u.has(P)&&p.some(O=>O.sku===P)){console.error(` Duplicate SKU detected: ${P} - regenerating...`);const O=await g(void 0,R+1e3);p.push({...k,sku:O})}else p.push({...k,sku:P})}const m=new Set,_=[];if(p.forEach((R,k)=>{m.has(R.sku)?_.push(k):m.add(R.sku)}),_.length>0){console.warn(` Found ${_.length} duplicate SKUs in batch, regenerating...`);for(const R of _){const k=await g(void 0,R+2e3);p[R].sku=k}}console.log(` Generated ${p.length} unique variant SKUs:`,p.map(R=>R.sku));const b=new Set,S=[];for(let R=0;R<p.length;R++){const k=p[R];let P=k.sku;b.has(P)&&(console.warn(` Duplicate SKU detected at final check: ${P}, regenerating...`),P=await g(void 0,R+3e3)),b.add(P),S.push({...k,sku:P})}const v=S.map(R=>{const k=R.sku,P={product_id:i.id,sku:k,name:R.name,attributes:R.attributes||{},cost_price:R.costPrice??0,selling_price:R.sellingPrice??R.price??0,quantity:R.quantity??R.stockQuantity??0,min_quantity:R.minQuantity??R.minStockLevel??0,branch_id:d,is_shared:!1,sharing_mode:"isolated"};return P.visible_to_branches=null,R.variantType&&(P.variant_type=R.variantType),R.isParent!==void 0&&(P.is_parent=R.isParent),R.parentVariantId&&(P.parent_variant_id=R.parentVariantId),R.variantAttributes&&(P.variant_attributes=R.variantAttributes),R.isActive!==void 0&&(P.is_active=R.isActive),P}),C=v.map(R=>R.sku);if(new Set(C).size!==C.length){console.error(" CRITICAL: Duplicate SKUs detected in final insert array!",C);const R=C.filter((k,P)=>C.indexOf(k)!==P);throw new Error(`Duplicate SKUs found before insertion: ${R.join(", ")}`)}console.log(` Inserting ${v.length} variants with unique SKUs:`,C);const{error:x}=await w.from("lats_product_variants").insert(v);if(x)throw console.error("Variants creation error:",x),console.error("Variants data being inserted:",v),x;console.log(" Created",v.length,"variants for product"),await new Promise(R=>setTimeout(R,100))}else{console.log(" No variants provided - database trigger will auto-create default variant..."),await new Promise(h=>setTimeout(h,200));const{data:d,error:u}=await w.from("lats_product_variants").select("id, name, sku").eq("product_id",i.id);!u&&d&&d.length>0?console.log(" Default variant auto-created by trigger:",d[0]):console.warn(" No default variant created - this may cause issues")}if(t&&t.length>0)for(let d=0;d<t.length;d++){const u=t[d];if(u.image_url.startsWith("blob:"))continue;const{error:h}=await w.from("product_images").insert({product_id:i.id,image_url:u.image_url,thumbnail_url:u.thumbnail_url,file_name:u.file_name,file_size:u.file_size,is_primary:u.is_primary,uploaded_by:e});h&&console.error("Error inserting image:",h)}return await rl(i.id)}catch(t){throw console.error("Error creating product:",t),t}}async function rl(s){var d,u,h;if(!s||s==="undefined"||s==="null")throw new Error(`Invalid product ID: ${s}`);const{data:e,error:t}=await w.from("lats_products").select("*").eq("id",s).single();if(t)throw t;if(!e)throw new Error("Product not found");const[r,a,n,o,i]=await Promise.all([e.category_id?w.from("lats_categories").select("id, name").eq("id",e.category_id).single():Promise.resolve({data:null}),e.supplier_id?w.from("lats_suppliers").select("id, name, contact_person, email, phone, address").eq("id",e.supplier_id).single():Promise.resolve({data:null}),w.from("lats_product_variants").select("*").eq("product_id",s).is("parent_variant_id",null).order("created_at",{ascending:!0}),e.storage_room_id?w.from("storage_rooms").select("id, name").eq("id",e.storage_room_id).single():Promise.resolve({data:null}),e.shelf_id?w.from("shelves").select("id, name, code").eq("id",e.shelf_id).single():Promise.resolve({data:null})]);let c=[];try{c=await ur.getProductImages(s)}catch(g){(g==null?void 0:g.code)!=="42P01"&&console.warn("Failed to fetch product images:",g),c=[]}const l=await Promise.all((n.data||[]).map(async g=>{let p=g.quantity||0;if(g.is_parent||g.variant_type==="parent")try{const{data:m,error:_}=await w.from("lats_product_variants").select("quantity, is_active").eq("parent_variant_id",g.id).eq("variant_type","imei_child").eq("is_active",!0);if(!_&&m&&m.length>0){const b=m.reduce((S,v)=>S+(v.quantity||0),0);p=b>0?b:p}}catch(m){console.warn(`Could not calculate stock from children for variant ${g.id}:`,m)}return{id:g.id,productId:g.product_id,name:g.variant_name||g.name||"Unnamed Variant",sku:g.sku,attributes:g.attributes||{},variantAttributes:g.variant_attributes||{},variant_attributes:g.variant_attributes||{},price:g.selling_price,costPrice:g.cost_price,cost_price:g.cost_price,sellingPrice:g.selling_price,selling_price:g.selling_price,stockQuantity:p,quantity:p,minQuantity:g.min_quantity,minStockLevel:g.min_quantity,isPrimary:g.is_primary||!1,isActive:g.is_active,is_parent:g.is_parent||!1,variant_type:g.variant_type||"standard",createdAt:g.created_at,updatedAt:g.updated_at}}));return{id:e.id,name:e.name,description:e.description,sku:e.sku,categoryId:e.category_id,supplierId:e.supplier_id,isActive:e.is_active,totalQuantity:e.total_quantity,totalValue:e.total_value,createdAt:e.created_at,updatedAt:e.updated_at,images:c,variants:l,category:r.data?{id:r.data.id,name:r.data.name}:null,supplier:a.data?{id:a.data.id,name:a.data.name,contactPerson:a.data.contact_person,email:a.data.email,phone:a.data.phone,address:a.data.address}:null,storageRoomId:e.storage_room_id,storageRoomName:(d=o.data)==null?void 0:d.name,shelfId:e.shelf_id,shelfName:(u=i.data)==null?void 0:u.name,shelfCode:(h=i.data)==null?void 0:h.code,barcode:e.barcode,specification:e.specification,condition:e.condition,brand:e.brand,model:e.model,weight:e.weight,length:e.length,width:e.width,height:e.height,shippingClass:e.shipping_class,requiresSpecialHandling:e.requires_special_handling,shippingStatus:e.shipping_status,trackingNumber:e.tracking_number,expectedDelivery:e.expected_delivery,shippingAgent:e.shipping_agent,usdPrice:e.usd_price,eurPrice:e.eur_price,exchangeRate:e.exchange_rate,baseCurrency:e.base_currency,isDigital:e.is_digital,requiresShipping:e.requires_shipping,isFeatured:e.is_featured,tags:e.tags,metadata:e.metadata}}async function sl(s,e){const t=`products:${s}`;return pn(t,async()=>fn(t,()=>rl(s),{ttl:3*60*1e3,staleWhileRevalidate:!0}),{forceRefresh:e==null?void 0:e.forceRefresh,timeout:9e4})}async function Qy(){try{console.log(" [getProducts] Starting optimized product fetch...");const n=Date.now(),o=localStorage.getItem("current_branch_id");let i=null;if(o){const{data:G,error:de}=await w.from("store_locations").select("id, name, data_isolation_mode, share_products").eq("id",o).single();i=G,de&&console.warn(" Could not load branch settings:",de.message)}let c=w.from("lats_products").select("id, name, description, sku, barcode, category_id, supplier_id, cost_price, stock_quantity, min_stock_level, max_stock_level, is_active, image_url, brand, model, warranty_period, created_at, updated_at, specification, condition, selling_price, total_quantity, total_value, storage_room_id, shelf_id, branch_id, is_shared, sharing_mode, visible_to_branches").eq("is_active",!0).order("created_at",{ascending:!1});o&&i?i.data_isolation_mode==="isolated"?(c=c.eq("branch_id",o),console.log(` [getProducts] ISOLATED MODE - Only showing products from branch ${o}`)):i.data_isolation_mode==="shared"?console.log(" [getProducts] SHARED MODE - Showing all products"):i.data_isolation_mode==="hybrid"?i.share_products?console.log(" [getProducts] HYBRID MODE - Products are SHARED - Showing all products"):(c=c.eq("branch_id",o),console.log(` [getProducts] HYBRID MODE - Products are NOT SHARED - Only showing branch ${o}`)):c=c.or(`branch_id.eq.${o},branch_id.is.null`):o&&!i&&(c=c.or(`branch_id.eq.${o},branch_id.is.null`)),console.log(" [getProducts] Executing query with branch filter..."),console.log(`   Branch ID: ${o||"none"}`),console.log(`   Branch Mode: ${(i==null?void 0:i.data_isolation_mode)||"none"}`),(i==null?void 0:i.data_isolation_mode)==="isolated"?console.log(`   Filter: is_active = true AND branch_id = ${o} (ISOLATED - no shared products)`):(i==null?void 0:i.data_isolation_mode)==="shared"?console.log("   Filter: is_active = true (SHARED - all products)"):(i==null?void 0:i.data_isolation_mode)==="hybrid"?console.log(`   Filter: is_active = true${i.share_products?" (all products)":` AND branch_id = ${o}`}`):console.log(`   Filter: is_active = true${o?` AND (branch_id = ${o} OR branch_id IS NULL)`:""}`);const{data:l,error:d}=await c,u=Date.now()-n;if(console.log(` [getProducts] Query completed in ${u}ms`),console.log(` [getProducts] Returned ${(l==null?void 0:l.length)||0} products`),d&&(console.error(" [getProducts] Query error:",d),console.error("   Error message:",d.message),console.error("   Error details:",d.details),console.error("   Error hint:",d.hint)),l&&l.length>0){console.log(` [getProducts] First product: ${l[0].name} (branch_id=${l[0].branch_id||"NULL"}, is_shared=${l[0].is_shared})`);const G=l.reduce((de,be)=>{const ye=be.branch_id||"NULL";return de[ye]=(de[ye]||0)+1,de},{});console.log(" [getProducts] Products by branch:",G)}else console.warn(" [getProducts] No products returned! This might indicate a filtering issue."),console.warn("   Possible causes:"),console.warn("   1. All products are inactive (is_active = false)"),console.warn("   2. Branch filtering is excluding all products"),console.warn("   3. No products exist in database"),console.warn("    Tip: Check database directly to verify products exist");if(d)throw console.error("%c QUERY FAILED!","background: #ff0000; color: white; font-size: 14px; font-weight: bold; padding: 5px;"),console.error(" Error message:",d.message),console.error(" Error details:",{message:d.message,details:d.details,hint:d.hint,code:d.code}),new Error(`Failed to fetch products: ${d.message}`);const h=l||[],g=Array.from(new Map(h.map(G=>[G.id,G])).values());if(!g||g.length===0)return[];g.slice(0,3).forEach((G,de)=>{G&&G.name});const p=g.filter(G=>!G||!G.name?(console.warn(" Skipping null or invalid product:",G),!1):!0),m=[...new Set(p.map(G=>G.category_id).filter(Boolean))],_=[...new Set(p.map(G=>G.supplier_id).filter(Boolean))],b=p.map(G=>G.id).filter(Boolean);console.log(` [getProducts] Found ${m.length} unique categories and ${_.length} unique suppliers in products`);const S=Date.now(),v=m.length>0?w.from("lats_categories").select("id, name").in("id",m):Promise.resolve({data:[]}),C=w.from("lats_suppliers").select("id, name").eq("is_active",!0).order("name"),T=localStorage.getItem("current_branch_id");let x=w.from("lats_product_variants").select("id, product_id, name, variant_name, sku, attributes, variant_attributes, cost_price, selling_price, quantity, reserved_quantity, min_quantity, created_at, updated_at, branch_id, is_shared, is_parent, variant_type, parent_variant_id").in("product_id",b).is("parent_variant_id",null).eq("is_active",!0).order("name");T&&i?i.data_isolation_mode==="isolated"?(x=x.eq("branch_id",T),console.log(` [getProducts] ISOLATED MODE - Variants: Only showing from branch ${T}`)):i.data_isolation_mode==="shared"?console.log(" [getProducts] SHARED MODE - Variants: Showing all variants"):i.data_isolation_mode==="hybrid"&&(i.share_inventory?(x=x.or(`branch_id.eq.${T},is_shared.eq.true,branch_id.is.null`),console.log(` [getProducts] HYBRID MODE - Variants are SHARED - Showing branch ${T} + shared variants`)):(x=x.eq("branch_id",T),console.log(` [getProducts] HYBRID MODE - Variants are NOT SHARED - Only showing branch ${T}`))):T&&(x=x.or(`branch_id.eq.${T},branch_id.is.null`));const R=b.length>0?w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",b).order("is_primary",{ascending:!1}):Promise.resolve({data:[]}),[k,P,O,N]=await Promise.all([v,C,x,R]),$=Date.now()-S;console.log(` [getProducts] All data fetched in parallel: ${$}ms`),k.error&&console.error(" Error fetching categories:",k.error),P&&"error"in P&&P.error&&console.error(" Error fetching suppliers:",P.error),O.error&&console.error(" Error fetching variants:",O.error),N.error&&console.error(" Error fetching images:",N.error);const M=k.data||[],L=P.data||[];let B=O.data||[],U=(N.data||[]).map(G=>({...G,thumbnail_url:G.thumbnail_url||G.image_url}));if(console.log(` [getProducts] Fetched ${M.length} categories, ${L.length} suppliers, ${B.length} variants, ${U.length} images`),B.length>0){const G=B.filter(ye=>(ye.quantity||0)>0).length,de=B.filter(ye=>(ye.selling_price||0)>0).length;console.log(" [getProducts] Variant quality check:",{total:B.length,withStock:G,withoutStock:B.length-G,withPrice:de,withoutPrice:B.length-de,uniqueProducts:new Set(B.map(ye=>ye.product_id)).size});const be=B.slice(0,3);console.log(" [getProducts] Sample variants:",be.map(ye=>({id:ye.id,product_id:ye.product_id,name:ye.variant_name||ye.name,quantity:ye.quantity,selling_price:ye.selling_price,cost_price:ye.cost_price})))}else console.warn(" [getProducts] No variants fetched! This might indicate a problem with the variants query."),console.warn(" [getProducts] Product IDs that should have variants:",b.slice(0,10));const W=new Map;(M||[]).forEach(G=>{W.set(G.id,G)});const H=new Map;(L||[]).forEach(G=>{H.set(G.id,G)});const Q=new Map;B.forEach(G=>{Q.has(G.product_id)||Q.set(G.product_id,[]),Q.get(G.product_id).push(G)});const ce=p.filter(G=>Q.has(G.id)).length,X=p.length-ce;console.log(` [getProducts] Products with variants: ${ce} / ${p.length}`),X>0&&console.log(` [getProducts] ${X} products have NO variants in current branch - they will show with 0 stock but should still be visible`);const re=new Map;U&&U.length>0&&U.forEach(G=>{re.has(G.product_id)||re.set(G.product_id,[]),re.get(G.product_id).push(G)});const _e=new Map;try{const G=p.filter(de=>de.shelf_id).map(de=>de.shelf_id);if(G.length>0){let de=await w.from("lats_store_shelves").select("id, name, code").in("id",G);de.error&&de.error.code==="42P01"&&(de=await w.from("shelves").select("id, name, code").in("id",G)),de.data&&de.data.forEach(be=>{_e.set(be.id,be)})}}catch(G){console.warn("Could not fetch shelf data:",G);try{const de=p.filter(be=>be.shelf_id).map(be=>be.shelf_id);if(de.length>0){const{data:be}=await w.from("shelves").select("id, name, code").in("id",de);be&&be.forEach(ye=>{_e.set(ye.id,ye)})}}catch(de){console.warn("Could not fetch shelf data from alternative table:",de)}}const le=B.filter(G=>G.is_parent||G.variant_type==="parent").map(G=>G.id),ve=new Map;if(le.length>0)try{const{data:G,error:de}=await w.from("lats_product_variants").select("parent_variant_id, quantity, is_active").in("parent_variant_id",le).eq("variant_type","imei_child").eq("is_active",!0);!de&&G&&G.forEach(be=>{const ye=be.parent_variant_id,st=ve.get(ye)||0;ve.set(ye,st+(be.quantity||0))})}catch(G){console.warn("Could not fetch children stock for parent variants:",G)}const Pe=(p||[]).map((G,de)=>{var mr,Mt;const be=[],ye=re.get(G.id)||[];if(ye.forEach(he=>{if(he.is_primary){const ke=he.thumbnail_url||he.image_url;if(ke){const Be=ft(ke);be.includes(Be)||be.push(Be)}}}),ye.forEach(he=>{if(!he.is_primary){const ke=he.thumbnail_url||he.image_url;if(ke){const Be=ft(ke);be.includes(Be)||be.push(Be)}}}),be.length===0&&G.image_url){const he=ft(G.image_url);be.push(he)}const st=Q.get(G.id)||[],Qe=st[0];return st.length===0&&de<5,{id:G.id,name:G.name,description:G.description,sku:G.sku,barcode:G.barcode,specification:G.specification,images:be,image_url:be[0]||(G.image_url?ft(G.image_url):null),categoryId:G.category_id,supplierId:G.supplier_id,isActive:G.is_active,price:G.selling_price||(Qe==null?void 0:Qe.selling_price)||0,sellingPrice:G.selling_price||(Qe==null?void 0:Qe.selling_price)||0,costPrice:G.cost_price||(Qe==null?void 0:Qe.cost_price)||0,stockQuantity:G.stock_quantity||0,minStockLevel:G.min_stock_level||0,totalQuantity:G.total_quantity||0,totalValue:G.total_value||0,supplier:G.supplier_id?H.get(G.supplier_id):void 0,category:G.category_id?W.get(G.category_id):void 0,shelfId:G.shelf_id,storageRoomId:G.storage_room_id,shelfName:G.shelf_id?(mr=_e.get(G.shelf_id))==null?void 0:mr.name:void 0,shelfCode:G.shelf_id?(Mt=_e.get(G.shelf_id))==null?void 0:Mt.code:void 0,storageRoomName:void 0,createdAt:G.created_at,updatedAt:G.updated_at,variants:st.map(he=>{let ke=he.quantity||0;if(he.is_parent||he.variant_type==="parent"){const Be=ve.get(he.id);Be!==void 0&&Be>0&&(ke=Be)}return{id:he.id,productId:he.product_id,sku:he.sku,name:he.variant_name||he.name||"Unnamed",attributes:he.variant_attributes||he.attributes||{},costPrice:he.cost_price||0,sellingPrice:he.selling_price||0,price:he.selling_price||0,stockQuantity:ke,minStockLevel:he.min_quantity||0,quantity:ke,minQuantity:he.min_quantity||0,weight:null,dimensions:null,createdAt:he.created_at,updatedAt:he.updated_at}})}}),Xe=Pe.filter(G=>G.supplier).length,$e=Pe.filter(G=>!G.supplier&&G.supplierId).length,$t=Pe.filter(G=>!G.supplierId).length,dr=Pe.filter(G=>(G.price||G.sellingPrice||0)>0).length,Vr=Pe.filter(G=>G.category).length,hr=Pe.filter(G=>G.shelfName||G.shelfCode).length;return Pe.length>0,console.log(` [getProducts] Data quality stats:
      - Total products: ${Pe.length}
      - Products with price: ${dr}
      - Products with category: ${Vr}
      - Products with supplier: ${Xe}
      - Products with shelf: ${hr}
      - Products with supplier_id but no supplier object: ${$e}
      - Products with no supplier_id: ${$t}`),Pe}catch(n){throw console.error(" [latsProductApi] Exception in getProducts:",n),console.error(" [latsProductApi] Error stack:",n instanceof Error?n.stack:"No stack trace"),n instanceof Error?new Error(`getProducts failed: ${n.message}`):new Error("getProducts failed: Unknown error")}}async function al(s){const t=`products:${localStorage.getItem("current_branch_id")||"default"}`;if(s!=null&&s.forceRefresh){console.log(" [getProducts] Force refresh requested - clearing caches..."),gn("products:*");const{smartCache:r}=await z(()=>import("./enhancedCacheManager-afe341e0.js"),["assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"]);r.invalidateCache("products")}return pn(t,async()=>fn(t,()=>Qy(),{ttl:3*60*1e3,staleWhileRevalidate:!0}),{forceRefresh:s==null?void 0:s.forceRefresh,timeout:9e4})}async function Ky(s,e,t){try{gn("^products:");const{data:r,error:a}=await w.from("lats_products").select("id, name, branch_id").eq("id",s).single();if(a)throw console.error(" [API] Product does not exist:",a),new Error(`Product with ID ${s} not found`);if(!r)throw new Error(`Product with ID ${s} does not exist in database`);const{images:n,variants:o,...i}=e,c={updated_at:new Date().toISOString()};i.name!==void 0&&(c.name=i.name),i.description!==void 0&&(c.description=i.description),i.sku!==void 0&&(c.sku=i.sku),i.categoryId!==void 0&&(c.category_id=i.categoryId),i.supplierId!==void 0&&(c.supplier_id=i.supplierId),i.tags!==void 0&&(c.tags=Array.isArray(i.tags)&&i.tags.length>0?i.tags:null),i.isActive!==void 0&&(c.is_active=i.isActive),i.costPrice!==void 0&&(c.cost_price=i.costPrice),i.sellingPrice!==void 0&&(c.selling_price=i.sellingPrice),i.price!==void 0&&(c.selling_price=i.price),i.stockQuantity!==void 0&&(c.stock_quantity=i.stockQuantity),i.minStockLevel!==void 0&&(c.min_stock_level=i.minStockLevel),i.condition!==void 0&&(c.condition=i.condition),i.specification!==void 0&&(c.specification=i.specification);const{error:l}=await w.from("lats_products").update(c).eq("id",s);if(l)throw console.error(" [API] Product update error:",l),l;const{data:d,error:u}=await w.from("lats_products").select("*").eq("id",s).single();if(u||!d)return console.error(" [API] Failed to fetch updated product:",u),{id:s,name:c.name||r.name,description:c.description||"",sku:c.sku||"",categoryId:c.category_id||"",supplierId:c.supplier_id,tags:c.tags&&Array.isArray(c.tags)&&c.tags.length>0?c.tags:[],isActive:c.is_active??!0,isFeatured:!1,isDigital:!1,requiresShipping:!0,taxRate:0,totalQuantity:0,totalValue:0,createdAt:new Date().toISOString(),updatedAt:c.updated_at};if(o&&Array.isArray(o)){let h=null;d&&d.branch_id?h=d.branch_id:r&&r.branch_id?h=r.branch_id:h=localStorage.getItem("current_branch_id");const{data:g,error:p}=await w.from("lats_product_variants").select("id, sku, variant_name").eq("product_id",s);if(p)throw console.error(" [API] Failed to fetch existing variants:",p),p;const m=Array.isArray(g)?g:[],_=new Map(m.map(b=>[b.id,b]));for(let b=0;b<o.length;b++){const S=o[b];if(!S||!S.sku){console.warn(" Skipping invalid variant:",S);continue}const v={product_id:s,variant_name:S.name||"Default",variant_attributes:S.attributes||{},cost_price:S.costPrice||0,selling_price:S.sellingPrice||S.price||0,quantity:S.quantity??S.stockQuantity??0,min_quantity:S.minQuantity??S.minStockLevel??0},C=S.id?_.get(S.id):null;if((!C||C.sku!==S.sku)&&(v.sku=S.sku),S.id){const{error:T}=await w.from("lats_product_variants").update(v).eq("id",S.id);if(T)throw console.error(" Update by ID failed:",T),console.error(" Update error details:",JSON.stringify(T,null,2)),console.error(" Variant data that failed:",JSON.stringify(v,null,2)),console.error(" Existing variant:",C),T}else{const T=m.find(x=>x&&x.sku===S.sku);if(T&&T.id){const{error:x}=await w.from("lats_product_variants").update(v).eq("id",T.id);if(x)throw console.error(" Update by SKU failed:",x),console.error(" Update error details:",JSON.stringify(x,null,2)),console.error(" Variant data that failed:",JSON.stringify(v,null,2)),x}else{v.sku||(v.sku=S.sku),v.branch_id=h,h||console.warn(" [API] Creating variant without branch_id - this may cause issues");const{error:x}=await w.from("lats_product_variants").insert(v);if(x)throw console.error(" Insert failed:",x),console.error(" Insert error details:",JSON.stringify(x,null,2)),console.error(" Variant data that failed:",JSON.stringify(v,null,2)),x}}}if(m.length>o.length&&m.length>1){const b=o.map(v=>v==null?void 0:v.sku).filter(Boolean),S=m.filter(v=>v&&v.sku&&!b.includes(v.sku)).slice(0,Math.max(0,m.length-1));for(const v of S)if(v&&v.id){const{data:C,error:T}=await w.from("lats_stock_movements").select("id").eq("variant_id",v.id).limit(1);if(T){console.error(" Failed to check stock movements:",T);continue}if(C&&C.length>0)continue;const{error:x}=await w.from("lats_product_variants").delete().eq("id",v.id);if(x){if(x.code==="23503"){console.warn(` Cannot delete variant ${v.id} (${v.sku||v.variant_name}): referenced by other records`);continue}throw console.error(" Delete failed:",x),x}}}}if(!d||!d.id)throw new Error("Product update returned null or invalid product");return{id:d.id,name:d.name,description:d.description,sku:d.sku,categoryId:d.category_id,supplierId:d.supplier_id,tags:d.tags,isActive:d.is_active,isFeatured:d.is_featured,isDigital:d.is_digital,requiresShipping:d.requires_shipping,taxRate:d.tax_rate,totalQuantity:d.total_quantity,totalValue:d.total_value,createdAt:d.created_at,updatedAt:d.updated_at}}catch(r){throw console.error(" [API] Error updating product:",r),console.error(" [API] Product ID:",s),console.error(" [API] Product data:",e),console.error(" [API] Error stack:",r==null?void 0:r.stack),r}}async function Jy(s){const{data:e,error:t}=await w.from("lats_product_variants").select("id").eq("product_id",s);if(t)throw console.error("Error fetching variants:",t),t;const r=(e==null?void 0:e.map(l=>l.id))||[];if(r.length>0){const{error:l}=await w.from("lats_purchase_order_items").delete().in("variant_id",r);l&&console.error("Error deleting purchase order items (by variant):",l)}const{error:a}=await w.from("lats_purchase_order_items").delete().eq("product_id",s);if(a)throw console.error("Error deleting purchase order items (by product):",a),a;if(r.length>0){const{error:l}=await w.from("lats_stock_movements").delete().in("variant_id",r);l&&console.error("Error deleting stock movements:",l)}const{error:n}=await w.from("lats_stock_movements").delete().eq("product_id",s);if(n&&console.error("Error deleting stock movements (by product):",n),r.length>0){const{error:l}=await w.from("lats_product_variants").delete().in("id",r);if(l)throw console.error("Error deleting variants:",l),l}const{error:o}=await w.from("lats_sale_items").delete().eq("product_id",s);o&&console.error("Error deleting sale items:",o);const{error:i}=await w.from("auto_reorder_log").delete().eq("product_id",s);i&&console.error("Error deleting auto reorder log:",i);const{error:c}=await w.from("lats_products").delete().eq("id",s);if(c)throw c}const _o=Object.freeze(Object.defineProperty({__proto__:null,createProduct:Hy,deleteProduct:Jy,getProduct:sl,getProducts:al,updateProduct:Ky},Symbol.toStringTag,{value:"Module"})),nl=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select("*").order("name");if(e)throw e;return s||[]}catch(s){throw console.error("Error fetching categories:",s),s}},Yy=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select("*").eq("is_active",!0).order("sort_order").order("name");if(e)throw e;return s||[]}catch(s){throw console.error("Error fetching active categories:",s),s}},Xy=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select("*").eq("is_active",!0).order("sort_order").order("name");if(e)throw e;const t=s||[],r=["spare","parts","repair","replacement","component"],a=["screen replacement","battery replacement","charging port","logic board","motherboard","circuit board","flex cable","ribbon cable","charging cable","home button","power button","volume button","camera module","speaker module","microphone module","antenna module","vibration motor","charging dock","connector port","headphone jack","sim tray","battery connector"],n=t.filter(o=>{const i=o.name.toLowerCase(),c=(o.description||"").toLowerCase(),l=r.some(h=>i.includes(h)||c.includes(h)),d=a.some(h=>i.includes(h)||c.includes(h)),u=i.includes("spare")||i.includes(" part")||i.includes("parts")||i.includes("component")&&!i.includes("software");return!(l||d||u)});return console.log("Filtered categories (excluding spare parts):",n.length),n}catch(s){throw console.error("Error fetching active categories excluding spare parts:",s),s}},Zy=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select("*").is("parent_id",null).eq("is_active",!0).order("sort_order").order("name");if(e)throw e;return s||[]}catch(s){throw console.error("Error fetching root categories:",s),s}},eb=async s=>{try{const{data:e,error:t}=await w.from("lats_categories").select("*").eq("parent_id",s).eq("is_active",!0).order("sort_order").order("name");if(t)throw t;return e||[]}catch(e){throw console.error("Error fetching subcategories:",e),e}},tb=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select("*").eq("is_active",!0).order("sort_order").order("name");if(e)throw e;const t=s||[],r=new Map,a=[];return t.forEach(n=>{r.set(n.id,{...n,children:[]})}),t.forEach(n=>{if(n.parent_id){const o=r.get(n.parent_id);o&&(o.children=o.children||[],o.children.push(r.get(n.id)))}else a.push(r.get(n.id))}),a}catch(s){throw console.error("Error fetching category hierarchy:",s),s}},rb=async s=>{try{const e=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null,t={...s,...e&&{branch_id:e}},{data:r,error:a}=await w.from("lats_categories").insert([t]).select().single();if(a)throw a;return r}catch(e){throw console.error("Error creating category:",e),e}},sb=async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_categories").update({...e,updated_at:new Date().toISOString()}).eq("id",s).select().single();if(r)throw r;return t}catch(t){throw console.error("Error updating category:",t),t}},ab=async s=>{try{const{error:e}=await w.from("lats_categories").delete().eq("id",s);if(e)throw e}catch(e){throw console.error("Error deleting category:",e),e}},nb=async s=>{throw new Error("Restore functionality not available - categories are permanently deleted")},ob=async s=>{try{const{data:e,error:t}=await w.from("lats_categories").select("*").eq("id",s).single();if(t)throw t;return e}catch(e){throw console.error("Error fetching category by ID:",e),e}},ib=async s=>{try{const{data:e,error:t}=await w.from("lats_categories").select("*").eq("name",s).single();if(t)throw t;return e}catch(e){throw console.error("Error fetching category by name:",e),e}},cb=async s=>{try{const{data:e,error:t}=await w.from("lats_categories").select("*").or(`name.ilike.%${s}%,description.ilike.%${s}%`).order("name");if(t)throw t;return e||[]}catch(e){throw console.error("Error searching categories:",e),e}},lb=async()=>{try{const{data:s,error:e}=await w.from("lats_categories").select(`
        *,
        devices:lats_products!category_id(count)
      `).order("name");if(e)throw e;return(s||[]).map(t=>{var r,a;return{...t,device_count:((a=(r=t.devices)==null?void 0:r[0])==null?void 0:a.count)||0}})}catch(s){throw console.error("Error fetching categories with device count:",s),s}},hS=Object.freeze(Object.defineProperty({__proto__:null,createCategory:rb,deleteCategory:ab,getActiveCategories:Yy,getActiveCategoriesExcludingSpare:Xy,getCategories:nl,getCategoriesWithDeviceCount:lb,getCategoryById:ob,getCategoryByName:ib,getCategoryHierarchy:tb,getRootCategories:Zy,getSubcategories:eb,restoreCategory:nb,searchCategories:cb,updateCategory:sb},Symbol.toStringTag,{value:"Module"}));class Qt{constructor(){this.errorHistory=[]}static getInstance(){return Qt.instance||(Qt.instance=new Qt),Qt.instance}logError(e,t,r={},a){const o={context:{operation:e,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,...r},error:t,databaseError:a};this.errorHistory.push(o),this.errorHistory.length>100&&(this.errorHistory=this.errorHistory.slice(-100)),this.logToConsole(o),this.logToStorage(o)}logToConsole(e){const{context:t,error:r,databaseError:a}=e;console.group(` Purchase Order Error: ${t.operation}`),console.error("Error Details:",{message:r.message||"Unknown error",stack:r.stack,name:r.name,code:r.code}),a&&console.error("Database Error:",{code:a.code,message:a.message,details:a.details,hint:a.hint,table:a.table,column:a.column}),console.error("Context:",{operation:t.operation,timestamp:t.timestamp,purchaseOrderId:t.purchaseOrderId,productId:t.productId,variantId:t.variantId,supplierId:t.supplierId,userId:t.userId,url:t.url,additionalData:t.additionalData}),console.groupEnd()}logToStorage(e){try{const t=JSON.parse(localStorage.getItem("purchase_order_errors")||"[]");t.push(e);const r=t.slice(-50);localStorage.setItem("purchase_order_errors",JSON.stringify(r))}catch(t){console.warn("Failed to log error to localStorage:",t)}}getUserFriendlyMessage(e,t){var r,a,n,o,i,c,l,d;if(e.code)switch(e.code){case"PGRST301":return"Database connection error: Please check your internet connection and try again";case"PGRST116":return"Resource not found: The requested purchase order does not exist";case"23505":return"Duplicate entry: This purchase order already exists";case"23503":return"Invalid reference: The supplier or product does not exist";case"23502":return"Missing required information: Please fill in all required fields";default:return`Database error (${e.code}): ${e.message}`}return(r=e.message)!=null&&r.includes("Failed to fetch")||(a=e.message)!=null&&a.includes("ERR_CONNECTION_CLOSED")?"Network error: Please check your internet connection and try again":(n=e.message)!=null&&n.includes("timeout")?"Request timeout: The server is taking too long to respond":(o=e.message)!=null&&o.includes("permission")||(i=e.message)!=null&&i.includes("unauthorized")?"Permission denied: You do not have access to this resource":(c=e.message)!=null&&c.includes("not found")?`The requested ${t.operation.replace("get_","").replace("_"," ")} was not found`:(l=e.message)!=null&&l.includes("Invalid")||(d=e.message)!=null&&d.includes("validation")?e.message:e.message||"An unexpected error occurred. Please try again."}getErrorHistory(){return[...this.errorHistory]}clearErrorHistory(){this.errorHistory=[],localStorage.removeItem("purchase_order_errors")}exportErrors(){return JSON.stringify(this.errorHistory,null,2)}}const Er=(s,e,t={},r)=>{const a=Qt.getInstance();return a.logError(s,e,t,r),a.getUserFriendlyMessage(e,{...t,operation:s,timestamp:"",userAgent:"",url:""})},ub=(s,e="Product ID")=>{if(!s)return{isValid:!1,error:`${e} is required`};if(typeof s!="string")return{isValid:!1,error:`${e} must be a string, got ${typeof s}`};const t=s.trim();return t===""?{isValid:!1,error:`${e} cannot be empty or whitespace only`}:/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)?{isValid:!0}:{isValid:!1,error:`${e} has invalid format: "${t}". Expected UUID format.`}},db=async(s,e,t={})=>{try{console.log(` Starting ${e}...`);const r=await s();return console.log(` ${e} completed successfully`),{success:!0,data:r}}catch(r){const a=Er(e,r,t);return console.error(` ${e} failed:`,r),{success:!1,error:a}}};class hb{constructor(){this.handlers=new Map,this.globalHandlers=[]}subscribe(e,t){return this.handlers.has(e)||this.handlers.set(e,[]),this.handlers.get(e).push(t),()=>{const r=this.handlers.get(e);if(r){const a=r.indexOf(t);a>-1&&r.splice(a,1)}}}subscribeToAll(e){return this.globalHandlers.push(e),()=>{const t=this.globalHandlers.indexOf(e);t>-1&&this.globalHandlers.splice(t,1)}}emit(e,t,r){const a={type:e,data:t,timestamp:new Date().toISOString(),source:r},n=this.handlers.get(e);n&&n.forEach(o=>{try{o(a)}catch(i){console.error(`Error in event handler for ${e}:`,i)}}),this.globalHandlers.forEach(o=>{try{o(a)}catch(i){console.error("Error in global event handler:",i)}})}clear(){this.handlers.clear(),this.globalHandlers=[]}getHandlers(){const e={};return this.handlers.forEach((t,r)=>{e[r]=t.length}),e.global=this.globalHandlers.length,e}}const gt=new hb,mS=(s,e,t)=>{gt.emit("lats:stock.updated",{productId:s,variantId:e,quantity:t})},pS=s=>{gt.emit("lats:sale.completed",{sale:s})};class Dr{static async retryOperation(e,t,r=this.MAX_RETRIES,a){var n,o,i,c,l,d;try{console.log(` Starting ${t} (attempt ${this.MAX_RETRIES-r+1}/${this.MAX_RETRIES})`);const u=await e();return console.log(` ${t} completed successfully`),u}catch(u){const h={operation:t,attempt:this.MAX_RETRIES-r+1,maxRetries:this.MAX_RETRIES,errorCode:u==null?void 0:u.code,errorMessage:u==null?void 0:u.message,errorDetails:u==null?void 0:u.details,errorHint:u==null?void 0:u.hint,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href};console.error(` ${t} failed (attempt ${this.MAX_RETRIES-r+1}/${this.MAX_RETRIES}):`,{...h,fullError:u});const g=((n=u==null?void 0:u.message)==null?void 0:n.includes("ERR_CONNECTION_CLOSED"))||((o=u==null?void 0:u.message)==null?void 0:o.includes("Failed to fetch"))||((i=u==null?void 0:u.message)==null?void 0:i.includes("net::ERR_CONNECTION_CLOSED"))||(u==null?void 0:u.code)==="PGRST301"||(u==null?void 0:u.code)==="PGRST116"||(u==null?void 0:u.code)==="PGRST301",p=((c=u==null?void 0:u.code)==null?void 0:c.startsWith("PGRST"))||((l=u==null?void 0:u.code)==null?void 0:l.startsWith("42"))||((d=u==null?void 0:u.code)==null?void 0:d.startsWith("23"));if(console.warn(g?` Connection error detected: ${u.message}`:p?` Database error detected: Code ${u.code} - ${u.message}`:` Unknown error type: ${u.message}`),r>1){const _=this.RETRY_DELAY*(this.MAX_RETRIES-r+1);return console.log(` Retrying ${t} in ${_}ms...`),await new Promise(b=>setTimeout(b,_)),this.retryOperation(e,t,r-1,a)}if(a){console.log(` Attempting fallback operation for ${t}...`);try{const _=await a();return console.log(` Fallback operation for ${t} succeeded`),_}catch(_){console.error(` Fallback operation for ${t} also failed:`,_)}}if(g)return console.warn(` ${t} failed after ${this.MAX_RETRIES} attempts due to connection issues. Returning empty data.`),[];const m=new Error(`Purchase Order Service Error: ${t} failed after ${this.MAX_RETRIES} attempts. Original error: ${u.message}`);throw m.originalError=u,m.context=h,m}}static async getMessages(e){return this.retryOperation(async()=>{const{data:t,error:r}=await w.from("purchase_order_messages").select("*").eq("purchase_order_id",e).order("timestamp",{ascending:!1});if(r)throw console.error("Error fetching messages:",r),r;return(t||[]).map(a=>({id:a.id,purchaseOrderId:a.purchase_order_id,sender:a.sender,content:a.content,type:a.type,timestamp:a.timestamp}))},"get_messages")}static async sendMessage(e){return this.retryOperation(async()=>{const{error:t}=await w.from("purchase_order_messages").insert({purchase_order_id:e.purchaseOrderId,sender:e.sender,content:e.content,type:e.type,timestamp:new Date().toISOString()});if(t)throw console.error("Error sending message:",t),t;return!0},"send_message")}static async getPayments(e){return this.retryOperation(async()=>{console.log(` [PurchaseOrderService] getPayments called for PO: ${e}`);let t=w.from("purchase_order_payments").select("id, purchase_order_id, payment_method, amount, currency, status, reference, payment_date, created_at").eq("purchase_order_id",e).order("created_at",{ascending:!1}).limit(100);console.log(` [PurchaseOrderService] Built query for purchase_order_id: ${e}`);const r=await Ct(t,"payments");console.log(" [PurchaseOrderService] Applied branch filter for payments");const{data:a,error:n}=await r;if(n)throw console.error(" Error fetching payments:",n),n;console.log(` [PurchaseOrderService] Fetched ${(a==null?void 0:a.length)||0} payments for PO: ${e}`);const o=(a||[]).map(i=>({id:i.id,purchaseOrderId:i.purchase_order_id,method:i.payment_method,amount:i.amount,currency:i.currency,status:i.status,reference:i.reference,timestamp:i.payment_date||i.created_at}));return console.log(` [PurchaseOrderService] Mapped ${o.length} payments`),o},"get_payments")}static async getExpenses(e){return this.retryOperation(async()=>{const{data:t,error:r}=await w.from("account_transactions").select("id, transaction_type, amount, description, reference_number, created_at, metadata, account_id").eq("transaction_type","expense").contains("metadata",{purchase_order_id:e}).order("created_at",{ascending:!1}).limit(50);if(r)throw console.error("Error fetching expenses:",r),r;if(!t||t.length===0)return[];const a=t.map(c=>c.account_id).filter(Boolean),{data:n,error:o}=await w.from("finance_accounts").select("id, name, type, currency").in("id",a);o&&console.warn("Error fetching account data:",o);const i=new Map((n==null?void 0:n.map(c=>[c.id,c]))||[]);return t.map(c=>{var d;const l=i.get(c.account_id);return{id:c.id,purchaseOrderId:e,type:"expense",category:((d=c.metadata)==null?void 0:d.category)||"Other",description:c.description,amount:c.amount,currency:(l==null?void 0:l.currency)||"TZS",accountName:(l==null?void 0:l.name)||"Unknown Account",reference:c.reference_number,timestamp:c.created_at,metadata:c.metadata}})},"get_expenses")}static async addPayment(e){return this.retryOperation(async()=>{const{error:t}=await w.from("purchase_order_payments").insert({purchase_order_id:e.purchaseOrderId,payment_method:e.method,amount:e.amount,currency:e.currency,status:e.status,reference:e.reference,payment_date:new Date().toISOString()});if(t)throw console.error("Error adding payment:",t),t;return!0},"add_payment")}static async getAuditHistory(e){return this.retryOperation(async()=>{const{data:t,error:r}=await w.from("purchase_order_audit").select("*").eq("purchase_order_id",e).order("timestamp",{ascending:!1});if(r)throw console.error("Error fetching audit history:",r),r;return(t||[]).map(a=>({id:a.id,purchaseOrderId:a.purchase_order_id,action:a.action,user:a.user_id||a.created_by,details:a.details,timestamp:a.timestamp}))},"get_audit_history")}static async addAuditEntry(e){try{let t=e.user;if(!t||t.trim()===""){const{data:{user:o},error:i}=await w.auth.getUser();i?(console.warn("Error getting authenticated user for audit entry:",i),t="system"):o?t=o.id:(console.warn("No authenticated user found for audit entry"),t="system")}const r=typeof e.details=="string"?e.details:JSON.stringify(e.details),{data:a,error:n}=await w.rpc("log_purchase_order_audit",{p_purchase_order_id:e.purchaseOrderId,p_action:e.action,p_details:r,p_user_id:t});if(n){console.warn("Helper function failed, trying direct insert:",n);const{error:o}=await w.from("purchase_order_audit").insert({purchase_order_id:e.purchaseOrderId,action:e.action,user_id:t,created_by:t,details:r,timestamp:new Date().toISOString()});if(o)return console.error("Direct insert also failed:",o),!1}else console.log(" Audit entry added successfully with ID:",a);return!0}catch(t){return console.error("Error adding audit entry:",t),!1}}static async updateOrderStatus(e,t,r,a){return this.retryOperation(async()=>{const n={status:t,updated_at:new Date().toISOString(),...a};console.log(" Updating order status with data:",n);const{error:o}=await w.from("lats_purchase_orders").update(n).eq("id",e);if(o)throw console.error(" Error updating order status:",o),console.error(" Error details:",{message:o.message,details:o.details,hint:o.hint,code:o.code}),console.error(" Update data that caused the error:",n),o;return await this.addAuditEntry({purchaseOrderId:e,action:`Status changed to ${t}`,user:r,details:JSON.stringify({message:`Order status updated to ${t}`,previous_status:(a==null?void 0:a.previous_status)||"unknown",new_status:t})}),{success:!0,message:"Order status updated successfully"}},"update_order_status")}static async loadShippedItems(e){return db(async()=>{console.log(` Starting loadShippedItems for purchase order: ${e}`);const t=ub(e,"Purchase Order ID");if(!t.isValid)throw new Error(t.error);const r=e.trim();return console.log(` Processing purchase order ID: "${r}" (length: ${r.length})`),this.retryOperation(async()=>{var g,p;console.log(" Attempting main query without PostgREST joins...");const{data:a,error:n}=await w.from("lats_purchase_order_items").select("*").eq("purchase_order_id",r);if(n)throw Er("load_shipped_items_main_query",n,{purchaseOrderId:r,operation:"load_shipped_items"},{code:n.code,message:n.message,details:n.details,hint:n.hint,table:"lats_purchase_order_items"}),n;if(console.log(` Main query succeeded, found ${(a==null?void 0:a.length)||0} items`),!a||a.length===0)return[];const o=a.map(m=>m.product_id).filter(Boolean),i=a.map(m=>m.variant_id).filter(Boolean),[c,l]=await Promise.all([o.length>0?w.from("lats_products").select("id, name, sku, description").in("id",o):Promise.resolve({data:[],error:null}),i.length>0?w.from("lats_product_variants").select("id, name, variant_name, sku").in("id",i):Promise.resolve({data:[],error:null})]),d=new Map(((g=c.data)==null?void 0:g.map(m=>[m.id,m]))||[]),u=new Map(((p=l.data)==null?void 0:p.map(m=>[m.id,{...m,name:m.name||m.variant_name||"Unnamed"}]))||[]);if(o.length>0){const{data:m}=await w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",o).order("is_primary",{ascending:!1});m&&m.forEach(_=>{const b=d.get(_.product_id);if(b){b.images||(b.images=[]);const S={id:_.id,url:_.thumbnail_url||_.image_url,thumbnailUrl:_.thumbnail_url,isPrimary:_.is_primary||!1};_.is_primary?b.images.unshift(S):b.images.push(S)}})}const h=a.map((m,_)=>{const b=m.product_id?d.get(m.product_id):null,S=m.variant_id?u.get(m.variant_id):null;return console.log(` Processing item ${_+1}:`,{itemId:m.id,productId:m.product_id,variantId:m.variant_id,hasProduct:!!b,hasVariant:!!S}),m.product_id||(console.warn(` Item ${m.id} has no product_id`),Er("missing_product_id",new Error("Missing product_id"),{purchaseOrderId:r,productId:m.product_id,variantId:m.variant_id,itemId:m.id})),m.variant_id||(console.warn(` Item ${m.id} has no variant_id`),Er("missing_variant_id",new Error("Missing variant_id"),{purchaseOrderId:r,productId:m.product_id,variantId:m.variant_id,itemId:m.id})),{...m,product:b,variant:S,name:(b==null?void 0:b.name)||(S==null?void 0:S.name)||"Unknown Product",sku:(b==null?void 0:b.sku)||(S==null?void 0:S.sku)||"N/A",description:(b==null?void 0:b.description)||"",productName:(b==null?void 0:b.name)||"Unknown Product",variantName:(S==null?void 0:S.name)||"Default Variant"}});return console.log(` Successfully mapped ${h.length} items with product information`),h},"load_shipped_items",this.MAX_RETRIES,async()=>{console.log(" Attempting fallback query without joins...");const{data:a,error:n}=await w.from("lats_purchase_order_items").select("*").eq("purchase_order_id",r);if(n)throw Er("load_shipped_items_fallback_query",n,{purchaseOrderId:r,operation:"load_shipped_items_fallback"},{code:n.code,message:n.message,details:n.details,table:"lats_purchase_order_items"}),n;console.log(` Fallback query succeeded, found ${(a==null?void 0:a.length)||0} items (without product details)`);const o=(a||[]).map((i,c)=>(console.log(` Processing fallback item ${c+1}:`,{itemId:i.id,productId:i.product_id,variantId:i.variant_id}),{...i,name:`Product ID: ${i.product_id||"Unknown"}`,sku:`SKU-${i.product_id||"Unknown"}`,description:"Product details not available",productName:`Product ID: ${i.product_id||"Unknown"}`,variantName:`Variant ID: ${i.variant_id||"Unknown"}`,product:null,variant:null}));return console.log(` Fallback mapping completed for ${o.length} items`),o})},"load_shipped_items",{purchaseOrderId:e}).then(t=>{if(t.success)return t.data||[];throw new Error(t.error)})}static async updateShippedItem(e,t){return this.retryOperation(async()=>{const{error:r}=await w.from("lats_purchase_order_items").update(t).eq("id",e);if(r)throw console.error("Error updating shipped item:",r),r;return!0},"update_shipped_item")}static async markItemAsReceived(e,t,r){return this.retryOperation(async()=>{const{error:a}=await w.from("lats_purchase_order_items").update({quantity_received:t,notes:r||null,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw console.error("Error marking item as received:",a),a;return!0},"mark_item_received")}static async reportDamage(e,t){return this.retryOperation(async()=>{const{error:r}=await w.from("lats_purchase_order_items").update({damage_report:t,status:"damaged",updated_at:new Date().toISOString()}).eq("id",e);if(r)throw console.error("Error reporting damage:",r),r;return!0},"report_damage")}static async updateReceivedQuantities(e,t,r){try{if(!t||t.length===0)return{success:!1,message:"No items provided for update",updatedItems:0};const{data:a,error:n}=await w.from("lats_purchase_order_items").select("id, purchase_order_id, quantity_ordered, quantity_received").eq("purchase_order_id",e);if(n)return console.error("Error fetching existing items:",n),{success:!1,message:"Failed to fetch existing items",updatedItems:0};if(!a||a.length===0)return{success:!1,message:"No items found for this purchase order",updatedItems:0};const o=new Map(a.map(p=>[p.id,p])),i=[],c=[];for(const p of t){const m=o.get(p.id);if(!m){c.push(`Item ${p.id} not found in purchase order`);continue}if(p.receivedQuantity<0){c.push(`Item ${p.id}: Received quantity cannot be negative`);continue}const _=m.quantity_received||0,b=m.quantity_ordered-_;if(p.receivedQuantity>b){c.push(`Item ${p.id}: Received quantity (${p.receivedQuantity}) cannot exceed remaining quantity (${b})`);continue}i.push({id:p.id,receivedQuantity:p.receivedQuantity,alreadyReceived:_})}if(c.length>0)return{success:!1,message:`Validation errors: ${c.join("; ")}`,updatedItems:0};if(i.length===0)return{success:!1,message:"No valid items found for update",updatedItems:0};let l=0;const d=[];for(const p of i){const{error:m}=await w.from("lats_purchase_order_items").update({quantity_received:p.alreadyReceived+p.receivedQuantity,updated_at:new Date().toISOString()}).eq("id",p.id).eq("purchase_order_id",e);m?(console.error(`Error updating item ${p.id}:`,m),d.push(`Item ${p.id}: ${m.message}`)):l++}if(d.length>0){if(console.error("Some updates failed:",d),l===0)return{success:!1,message:`All updates failed: ${d.join("; ")}`,updatedItems:0};console.warn(`${l}/${i.length} items updated successfully`)}const{data:u,error:h}=await w.from("lats_purchase_order_items").select("id, quantity_received").eq("purchase_order_id",e).in("id",i.map(p=>p.id));if(h)return console.error("Error verifying updates:",h),{success:!1,message:"Update completed but verification failed",updatedItems:i.length};const g=(u==null?void 0:u.filter(p=>i.find(m=>m.id===p.id&&m.receivedQuantity===p.quantity_received)).length)||0;return await this.processSerialNumbers(e,t,r),await this.createInventoryAdjustments(e,t,r),{success:!0,message:`Successfully updated ${g} items`,updatedItems:g}}catch(a){return console.error("Error updating received quantities:",a),{success:!1,message:`Unexpected error: ${a instanceof Error?a.message:"Unknown error"}`,updatedItems:0}}}static async getPurchaseOrderItemsWithProducts(e){try{console.log(" [PurchaseOrderService] Fetching purchase order items for PO:",e);const{data:t,error:r}=await w.rpc("get_purchase_order_items_with_products",{purchase_order_id_param:e});if(r)return console.error(" Error fetching purchase order items:",r),{success:!1,message:"Failed to fetch purchase order items"};const a=(t||[]).map(n=>({id:n.id,productId:n.product_id,variantId:n.variant_id,quantity:n.quantity,costPrice:parseFloat(n.unit_cost.toString()),totalPrice:parseFloat(n.total_cost.toString()),receivedQuantity:n.received_quantity||0,notes:n.notes,createdAt:n.created_at,updatedAt:n.updated_at,product:{id:n.product_id,name:n.product_name,sku:n.product_sku},variant:{id:n.variant_id,name:n.variant_name,sku:n.variant_sku}}));return console.log(" [PurchaseOrderService] Purchase order items fetched:",{total:a.length}),{success:!0,data:a,message:`Found ${a.length} purchase order items`}}catch(t){return console.error(" [PurchaseOrderService] Error fetching purchase order items:",t),{success:!1,message:`Failed to fetch purchase order items: ${t instanceof Error?t.message:"Unknown error"}`}}}static async completePurchaseOrder(e,t,r){try{console.log(" [PurchaseOrderService] Completing purchase order:",e);const{data:a,error:n}=await w.rpc("complete_purchase_order",{purchase_order_id_param:e,user_id_param:t,completion_notes:r||"Purchase order completed"});if(n)throw n;console.log(" [PurchaseOrderService] Raw RPC response:",a);let o=a;return Array.isArray(o)&&(o=o[0]),o!=null&&o.complete_purchase_order&&(o=o.complete_purchase_order),console.log(" [PurchaseOrderService] Parsed result:",o),o&&!o.success?(console.error(" [PurchaseOrderService] Completion failed:",o),{success:!1,message:o.message||"Failed to complete purchase order",error_code:o.error_code,data:o}):(console.log(" [PurchaseOrderService] Purchase order completed successfully:",o),{success:!0,data:(o==null?void 0:o.data)||o,message:(o==null?void 0:o.message)||"Purchase order completed successfully"})}catch(a){return console.error(" [PurchaseOrderService] Error completing purchase order:",a),{success:!1,message:`Failed to complete purchase order: ${a instanceof Error?a.message:"Unknown error"}`,error_code:"NETWORK_ERROR"}}}static async checkCompletionStatus(e){try{console.log(" [PurchaseOrderService] Checking completion status for PO:",e);const{data:t,error:r}=await w.rpc("check_purchase_order_completion_status",{purchase_order_id_param:e});if(r)throw r;console.log(" [PurchaseOrderService] Raw status response:",t);let a=t;return Array.isArray(a)&&(a=a[0]),a!=null&&a.check_purchase_order_completion_status&&(a=a.check_purchase_order_completion_status),console.log(" [PurchaseOrderService] Parsed status:",a),{success:!0,data:(a==null?void 0:a.data)||a,message:(a==null?void 0:a.message)||"Completion status retrieved successfully"}}catch(t){return console.error(" [PurchaseOrderService] Error checking completion status:",t),{success:!1,message:`Failed to check completion status: ${t instanceof Error?t.message:"Unknown error"}`}}}static async fixReceivedQuantities(e,t){try{console.log(" [PurchaseOrderService] Fixing received quantities for PO:",e);const{data:r,error:a}=await w.rpc("fix_purchase_order_received_quantities",{purchase_order_id_param:e,user_id_param:t});if(a)throw a;return r&&!r.success?{success:!1,message:r.message||"Failed to fix received quantities"}:{success:!0,data:(r==null?void 0:r.data)||r,message:(r==null?void 0:r.message)||"Received quantities fixed successfully"}}catch(r){return console.error(" [PurchaseOrderService] Error fixing received quantities:",r),{success:!1,message:`Failed to fix received quantities: ${r instanceof Error?r.message:"Unknown error"}`}}}static async getReceivedItems(e){try{console.log(" [PurchaseOrderService] Fetching received items for PO:",e);try{const n=await this.retryOperation(async()=>{var c,l;const{data:o,error:i}=await w.rpc("get_received_items_for_po",{po_id:e});if(i)throw(c=i.message)!=null&&c.includes("function")||(l=i.message)!=null&&l.includes("does not exist")?new Error("RPC_FUNCTION_NOT_FOUND"):i;return o},"get_received_items_for_po");if(n&&n.length>=0){const o=n.map(i=>{var c;return{id:i.id,product_id:i.product_id,variant_id:i.variant_id,serial_number:i.serial_number,item_number:i.item_number,imei:i.imei,mac_address:i.mac_address,barcode:i.barcode,status:i.status,location:i.location,shelf:i.shelf,bin:i.bin,purchase_date:i.purchase_date,warranty_start:i.warranty_start,warranty_end:i.warranty_end,cost_price:Number(i.cost_price)||0,selling_price:Number(i.selling_price)||0,notes:i.notes,metadata:i.metadata,created_at:i.created_at,product:{id:i.product_id,name:i.product_name,sku:i.product_sku},variant:{id:i.variant_id,name:i.variant_name,sku:i.variant_sku},item_type:"inventory_item",received_quantity:1,has_serial:!!i.serial_number,batch_number:((c=i.metadata)==null?void 0:c.batch_number)||null}});return console.log(" [PurchaseOrderService] Received items fetched via RPC:",{total:o.length}),{success:!0,data:o,message:`Found ${o.length} received items`}}}catch(n){n.message==="RPC_FUNCTION_NOT_FOUND"?console.log(" RPC function not found, using fallback method"):console.warn(" RPC function error, falling back to direct queries:",n)}console.log(" [PurchaseOrderService] Using fallback method - direct queries");const t=[],r=await this.retryOperation(async()=>{var g,p;const{data:n,error:o}=await w.from("inventory_items").select("id, product_id, variant_id, serial_number, item_number, mac_address, barcode, status, location, shelf, bin, purchase_date, warranty_start, warranty_end, cost_price, selling_price, notes, metadata, created_at").contains("metadata",{purchase_order_id:e}).order("created_at",{ascending:!1});if(o)throw o;if(!n||n.length===0)return[];const i=n.map(m=>m.product_id).filter(Boolean),c=n.map(m=>m.variant_id).filter(Boolean),[l,d]=await Promise.all([i.length>0?w.from("lats_products").select("id, name, sku, category_id").in("id",i):Promise.resolve({data:[],error:null}),c.length>0?w.from("lats_product_variants").select("id, name, variant_name, sku").in("id",c):Promise.resolve({data:[],error:null})]),u=new Map(((g=l.data)==null?void 0:g.map(m=>[m.id,m]))||[]),h=new Map(((p=d.data)==null?void 0:p.map(m=>[m.id,{...m,name:m.name||m.variant_name||"Unnamed"}]))||[]);if(i.length>0){const{data:m}=await w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",i).order("is_primary",{ascending:!1});m&&m.forEach(_=>{const b=u.get(_.product_id);if(b){b.images||(b.images=[]);const S={id:_.id,url:_.thumbnail_url||_.image_url,thumbnailUrl:_.thumbnail_url,isPrimary:_.is_primary||!1};_.is_primary?b.images.unshift(S):b.images.push(S)}})}return n.map(m=>({...m,product:m.product_id?u.get(m.product_id):null,variant:m.variant_id?h.get(m.variant_id):null}))},"get_inventory_items");if(r){const n=r.map(o=>{var i,c,l,d;return{id:o.id,product_id:o.product_id,variant_id:o.variant_id,serial_number:o.serial_number,item_number:o.item_number,imei:o.imei,mac_address:o.mac_address,barcode:o.barcode,status:o.status,location:o.location,shelf:o.shelf,bin:o.bin,purchase_date:o.purchase_date,warranty_start:o.warranty_start,warranty_end:o.warranty_end,cost_price:Number(o.cost_price)||0,selling_price:Number(o.selling_price)||0,notes:o.notes,created_at:o.created_at,product:{id:o.product_id,name:((i=o.product)==null?void 0:i.name)||"Unknown Product",sku:((c=o.product)==null?void 0:c.sku)||""},variant:{id:o.variant_id,name:((l=o.variant)==null?void 0:l.name)||"",sku:((d=o.variant)==null?void 0:d.sku)||""},item_type:"inventory_item",received_quantity:1,has_serial:!0}});t.push(...n)}const a=await this.retryOperation(async()=>{var g,p;const{data:n,error:o}=await w.from("lats_inventory_adjustments").select("id, product_id, variant_id, quantity, cost_price, reason, adjustment_type, reference_id, created_at").eq("adjustment_type","receive").like("reason",`%purchase order ${e}%`).order("created_at",{ascending:!1});if(o)throw o;if(!n||n.length===0)return[];const i=n.map(m=>m.product_id).filter(Boolean),c=n.map(m=>m.variant_id).filter(Boolean),[l,d]=await Promise.all([i.length>0?w.from("lats_products").select("id, name, sku").in("id",i):Promise.resolve({data:[],error:null}),c.length>0?w.from("lats_product_variants").select("id, name, variant_name, sku").in("id",c):Promise.resolve({data:[],error:null})]),u=new Map(((g=l.data)==null?void 0:g.map(m=>[m.id,m]))||[]),h=new Map(((p=d.data)==null?void 0:p.map(m=>[m.id,{...m,name:m.name||m.variant_name||"Unnamed"}]))||[]);if(i.length>0){const{data:m}=await w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",i).order("is_primary",{ascending:!1});m&&m.forEach(_=>{const b=u.get(_.product_id);if(b){b.images||(b.images=[]);const S={id:_.id,url:_.thumbnail_url||_.image_url,thumbnailUrl:_.thumbnail_url,isPrimary:_.is_primary||!1};_.is_primary?b.images.unshift(S):b.images.push(S)}})}return n.map(m=>({...m,product:m.product_id?u.get(m.product_id):null,variant:m.variant_id?h.get(m.variant_id):null}))},"get_inventory_adjustments");if(a){const n=a.map(o=>{var i,c,l,d;return{id:o.id,product_id:o.product_id,variant_id:o.variant_id,serial_number:null,imei:null,mac_address:null,barcode:null,status:"received",location:null,shelf:null,bin:null,purchase_date:o.created_at,warranty_start:null,warranty_end:null,cost_price:o.cost_price,selling_price:null,notes:o.reason,created_at:o.created_at,product:{id:o.product_id,name:((i=o.product)==null?void 0:i.name)||"Unknown Product",sku:((c=o.product)==null?void 0:c.sku)||""},variant:{id:o.variant_id,name:((l=o.variant)==null?void 0:l.name)||"",sku:((d=o.variant)==null?void 0:d.sku)||""},item_type:"inventory_adjustment",received_quantity:o.quantity,has_serial:!1}});t.push(...n)}return t.sort((n,o)=>new Date(o.created_at).getTime()-new Date(n.created_at).getTime()),console.log(" [PurchaseOrderService] Received items fetched via fallback:",{total:t.length,inventoryItems:t.filter(n=>n.item_type==="inventory_item").length,adjustments:t.filter(n=>n.item_type==="inventory_adjustment").length}),{success:!0,data:t,message:`Found ${t.length} received items (${t.filter(n=>n.item_type==="inventory_item").length} inventory items, ${t.filter(n=>n.item_type==="inventory_adjustment").length} adjustments)`}}catch(t){return console.error(" [PurchaseOrderService] Error fetching received items:",t),{success:!1,message:`Failed to fetch received items: ${t instanceof Error?t.message:"Unknown error"}`}}}static async completeReceive(e,t,r){try{console.log(" [PurchaseOrderService] Starting completeReceive:",{purchaseOrderId:e,userId:t,receiveNotes:r});const{data:a,error:n}=await w.rpc("complete_purchase_order_receive",{purchase_order_id_param:e,user_id_param:t,receive_notes:r||null});if(console.log(" [PurchaseOrderService] RPC response:",{data:a,error:n}),n)return console.error(" [PurchaseOrderService] Error completing receive:",n),{success:!1,message:`Receive failed: ${n.message}`};if(a&&typeof a=="object"&&"success"in a&&!a.success)return console.error(" [PurchaseOrderService] Function returned failure:",a),{success:!1,message:a.message||"Receive operation failed"};const o=await this.getReceiveSummary(e);return gt.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:t,notes:r}),console.log(" [PurchaseOrderService] Complete receive event emitted"),{success:!0,message:"Purchase order received successfully",summary:o.success?o.data:null}}catch(a){return console.error(" [PurchaseOrderService] Error in completeReceive:",a),{success:!1,message:`Unexpected error: ${a instanceof Error?a.message:"Unknown error"}`}}}static async partialReceive(e,t,r,a){try{console.log(" [PurchaseOrderService] Starting partialReceive:",{purchaseOrderId:e,receivedItems:t,userId:r,receiveNotes:a});const n=t.map(l=>({item_id:l.item_id,quantity:l.quantity}));console.log(" [PurchaseOrderService] Calling partial_purchase_order_receive RPC with:",{purchase_order_id_param:e,received_items:n,user_id_param:r,receive_notes:a||null});const{data:o,error:i}=await w.rpc("partial_purchase_order_receive",{purchase_order_id_param:e,received_items:n,user_id_param:r,receive_notes:a||null});if(console.log(" [PurchaseOrderService] RPC response:",{data:o,error:i}),i)return console.error(" [PurchaseOrderService] Error in partialReceive:",i),{success:!1,message:`Partial receive failed: ${i.message}`};if(o&&typeof o=="object"&&"success"in o&&!o.success)return console.error(" [PurchaseOrderService] Function returned failure:",o),{success:!1,message:o.message||"Partial receive operation failed"};const c=await this.getReceiveSummary(e);return gt.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:r,notes:a}),console.log(" [PurchaseOrderService] Partial receive event emitted"),{success:!0,message:"Partial receive completed successfully",summary:c.success?c.data:null}}catch(n){return console.error(" [PurchaseOrderService] Error in partialReceive:",n),{success:!1,message:`Unexpected error: ${n instanceof Error?n.message:"Unknown error"}`}}}static async finalizeReceive(e,t,r,a,n){try{console.log(" [PurchaseOrderService] Starting finalizeReceive:",{purchaseOrderId:e,userId:r,isPartialReceive:a,receiveNotes:n});const{data:o,error:i}=await w.from("lats_purchase_orders").select("id, status, po_number").eq("id",e).single();if(i||!o)return console.error(" Error fetching PO:",i),{success:!1,message:"Purchase order not found"};const{data:c,error:l}=await w.from("lats_purchase_order_items").select("id, quantity_ordered, quantity_received, product_id, variant_id, unit_cost, product:lats_products(name), variant:lats_product_variants(name, quantity)").eq("purchase_order_id",e);if(l)return console.error(" Error fetching PO items:",l),{success:!1,message:"Failed to fetch purchase order items"};let d=0,u=0;const h=c.every(m=>m.quantity_received>=m.quantity_ordered);c.forEach(m=>{d+=m.quantity_ordered,u+=m.quantity_received||0});const g=h?"received":"partial_received";console.log(" Finalize receive calculations:",{totalOrdered:d,totalReceived:u,allReceived:h,newStatus:a&&!h?"partial_received":g});const{error:p}=await w.rpc("begin_transaction_if_not_exists");try{const m=a&&!h?"partial_received":g,{error:_}=await w.from("lats_purchase_orders").update({status:m,received_date:h?new Date().toISOString():null,updated_at:new Date().toISOString()}).eq("id",e);if(_)throw _;for(const C of c){const T=C.quantity_received||0,x=T-(t.get(C.id)||0);if(T>x&&C.variant_id){const R=T-x,{data:k,error:P}=await w.from("lats_product_variants").select("quantity").eq("id",C.variant_id).single();if(P){console.warn(`Warning: Could not get variant quantity for ${C.variant_id}:`,P);continue}const O=k.quantity||0,{error:N}=await w.from("lats_product_variants").update({quantity:O+R,updated_at:new Date().toISOString()}).eq("id",C.variant_id);if(N){console.warn(`Warning: Could not update variant quantity for ${C.variant_id}:`,N);continue}const{error:$}=await w.from("lats_stock_movements").insert({product_id:C.product_id,variant_id:C.variant_id,movement_type:"in",quantity:R,previous_quantity:O,new_quantity:O+R,reason:a?"Purchase Order Partial Receipt":"Purchase Order Receipt",reference:`PO-${o.order_number||o.po_number||e}`,notes:`Finalized receive: ${R} units${n?` - ${n}`:""}`,created_by:r,created_at:new Date().toISOString()});$&&console.warn(`Warning: Could not create stock movement for ${C.variant_id}:`,$)}}const{error:b}=await w.from("lats_purchase_order_audit_log").insert({purchase_order_id:e,action:a?"Partial Receive Finalized":"Receive Finalized",old_status:o.status,new_status:m,user_id:r,notes:n||`Finalized ${a?"partial":"complete"} receive`,created_at:new Date().toISOString()});b&&console.warn("Warning: Could not create audit log:",b);const{error:S}=await w.rpc("commit_transaction_if_exists");S&&console.warn("Warning: Could not commit transaction:",S);const v=await this.getReceiveSummary(e);return gt.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:r,notes:n}),console.log(" [PurchaseOrderService] Finalize receive completed successfully"),{success:!0,message:a&&!h?`Partial receive finalized! ${u}/${d} items received.`:"Receive finalized successfully!",summary:v.success?v.data:null}}catch(m){const{error:_}=await w.rpc("rollback_transaction_if_exists");throw _&&console.warn("Warning: Could not rollback transaction:",_),m}}catch(o){return console.error(" [PurchaseOrderService] Error in finalizeReceive:",o),{success:!1,message:`Unexpected error: ${o instanceof Error?o.message:"Unknown error"}`}}}static async processReturn(e,t,r,a,n,o){try{const{data:i,error:c}=await w.rpc("process_purchase_order_return",{purchase_order_id_param:e,item_id_param:t,return_type_param:r,return_quantity_param:a,return_reason_param:n,user_id_param:o});return c?(console.error("Error processing return:",c),{success:!1,message:`Return failed: ${c.message}`}):{success:!0,message:"Return processed successfully"}}catch(i){return console.error("Error in processReturn:",i),{success:!1,message:`Unexpected error: ${i instanceof Error?i.message:"Unknown error"}`}}}static async getReceiveSummary(e){try{const{data:t,error:r}=await w.rpc("get_purchase_order_receive_summary",{purchase_order_id_param:e});return r?(console.error("Error getting receive summary:",r),{success:!1,message:"Failed to get receive summary"}):{success:!0,data:(t==null?void 0:t[0])||null}}catch(t){return console.error("Error in getReceiveSummary:",t),{success:!1,message:`Unexpected error: ${t instanceof Error?t.message:"Unknown error"}`}}}static async getReturns(e){try{const{data:t,error:r}=await w.rpc("get_purchase_order_returns",{purchase_order_id_param:e});return r?(console.error("Error getting returns:",r),{success:!1,message:"Failed to get returns"}):{success:!0,data:t||[]}}catch(t){return console.error("Error in getReturns:",t),{success:!1,message:`Unexpected error: ${t instanceof Error?t.message:"Unknown error"}`}}}static async addQualityCheck(e,t,r){try{const{error:a}=await w.from("purchase_order_quality_checks").insert({purchase_order_id:e,item_id:t,passed:r.passed,notes:r.notes,checked_by:r.checkedBy,timestamp:new Date().toISOString()});if(a)throw a;return await this.addAuditEntry({purchaseOrderId:e,action:"Quality check",user:r.checkedBy,details:`Quality check ${r.passed?"passed":"failed"} for item ${t}`}),!0}catch(a){return console.error("Error adding quality check:",a),!1}}static async createInventoryAdjustments(e,t,r){try{const{data:a,error:n}=await w.from("lats_purchase_order_items").select("id, product_id, variant_id, unit_cost").eq("purchase_order_id",e).in("id",t.map(o=>o.id));if(n){console.error("Error fetching order items for inventory adjustments:",n);return}for(const o of t){if(o.serialNumbers&&o.serialNumbers.length>0||o.receivedQuantity<=0)continue;const i=a==null?void 0:a.find(d=>d.id===o.id);if(!i){console.warn(`Order item not found for received item ${o.id}`);continue}const c=[];for(let d=0;d<o.receivedQuantity;d++)c.push({product_id:i.product_id,variant_id:i.variant_id,status:"pending_pricing",purchase_order_id:e,cost_price:i.unit_cost||0,selling_price:null,notes:`Received from purchase order ${e} - bulk item ${d+1}`,metadata:{purchase_order_id:e,purchase_order_item_id:o.id,received_by:r,received_at:new Date().toISOString(),bulk_item:!0,bulk_index:d+1}});const{error:l}=await w.from("inventory_items").insert(c);if(l){console.error(`Error creating inventory items for order item ${o.id}:`,l);continue}console.log(` Created ${o.receivedQuantity} inventory items (pending pricing) for order item ${o.id}`)}}catch(a){console.error("Error creating inventory adjustments:",a)}}static async processSerialNumbers(e,t,r){try{const{data:a,error:n}=await w.from("lats_purchase_order_items").select(`
          id, 
          product_id, 
          variant_id, 
          unit_cost,
          product:lats_products(id, name, branch_id)
        `).eq("purchase_order_id",e).in("id",t.map(o=>o.id));if(n){console.error("Error fetching order items for serial numbers:",n);return}console.log(" Processing IMEI variants for received items...");for(const o of t){if(!o.serialNumbers||o.serialNumbers.length===0)continue;const i=a==null?void 0:a.find(d=>d.id===o.id);if(!i){console.warn(`Order item not found for received item ${o.id}`);continue}const c=i.product;if(!c){console.warn(`Product not found for order item ${o.id}`);continue}if(o.serialNumbers.some(d=>d.imei&&d.imei.trim()!=="")){console.log(` Using Parent-Child IMEI variant system for ${o.serialNumbers.length} devices`);const d=o.serialNumbers.filter(h=>h.imei&&h.imei.trim()!=="").map(h=>({imei:String(h.imei),serial_number:String(h.imei),mac_address:h.mac_address,condition:h.condition||"new",cost_price:h.cost_price||i.unit_cost||0,selling_price:h.selling_price??null,location:h.location,warranty_start:h.warranty_start,warranty_end:h.warranty_end,notes:h.notes||`Received from PO ${e}`,source:"purchase"}));if(d.length>0&&i.variant_id){const{addIMEIsToParentVariant:h,convertToParentVariant:g}=await z(()=>import("./imeiVariantService-4ce4b8b1.js"),["assets/imeiVariantService-4ce4b8b1.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);await g(i.variant_id),console.log(` Variant ${i.variant_id} marked as parent`);const p=await h(i.variant_id,d);p.success?(console.log(` Added ${p.created} IMEI children to parent variant ${i.variant_id}`),p.failed>0&&console.warn(` Failed to add ${p.failed} IMEIs:`,p.errors)):console.error(" Error adding IMEIs to parent variant:",p.errors)}else if(d.length>0&&!i.variant_id){console.warn(" No variant_id found in PO item. Creating parent variant...");const{createParentVariant:h,addIMEIsToParentVariant:g}=await z(()=>import("./imeiVariantService-4ce4b8b1.js"),["assets/imeiVariantService-4ce4b8b1.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]),p=await h({product_id:i.product_id,variant_name:"Default Variant",branch_id:c.branch_id,cost_price:d[0].cost_price,selling_price:d[0].selling_price});if(p.success&&p.data){const m=await g(p.data.id,d);m.success&&console.log(` Created parent variant and added ${m.created} IMEI children`)}}const u=o.serialNumbers.filter(h=>(!h.imei||h.imei.trim()==="")&&h.serial_number&&h.serial_number.trim()!=="");if(u.length>0){console.log(` ${u.length} items without IMEI, using legacy inventory_items`);try{await this.createLegacyInventoryItems(e,i,u,r)}catch(h){throw console.error(" Failed to create legacy inventory items for items without IMEI:",h),h}}}else{console.log(` Using legacy inventory_items for ${o.serialNumbers.length} items (no IMEI)`);try{await this.createLegacyInventoryItems(e,i,o.serialNumbers,r)}catch(h){throw console.error(" Failed to create legacy inventory items:",h),h}const d=o.serialNumbers.length,u=o.receivedQuantity;if(d<u){const h=u-d;console.log(` Received ${u} items but only ${d} serial numbers provided. Creating ${h} items without serial numbers.`);try{const g=[];for(let m=0;m<h;m++)g.push({product_id:i.product_id,variant_id:i.variant_id,status:"available",purchase_order_id:e,purchase_order_item_id:i.id,cost_price:i.unit_cost||0,selling_price:null,notes:`Received from purchase order ${e} - item without serial number ${m+1}`,metadata:{purchase_order_id:e,purchase_order_item_id:i.id,received_by:r,received_at:new Date().toISOString(),no_serial_number:!0,item_index:d+m+1}});const{error:p}=await w.from("inventory_items").insert(g);if(p)console.error("Error creating inventory items without serial numbers:",p);else if(console.log(` Created ${h} inventory items without serial numbers`),i.variant_id&&h>0)try{const{data:m,error:_}=await w.from("lats_product_variants").select("quantity").eq("id",i.variant_id).single();if(!_&&m){const b=m.quantity||0,{error:S}=await w.from("lats_product_variants").update({quantity:b+h,updated_at:new Date().toISOString()}).eq("id",i.variant_id);S||console.log(` Updated variant quantity: ${b} -> ${b+h} (+${h})`)}}catch(m){console.warn("Warning: Error updating variant quantity for items without serial numbers:",m)}}catch(g){console.error(" Failed to create inventory items without serial numbers:",g)}}}console.log(` Processed ${o.serialNumbers.length} items for order item ${o.id}`)}}catch(a){console.error("Error processing serial numbers:",a)}}static async createLegacyInventoryItems(e,t,r,a){var n;try{if(!r||r.length===0){console.log("No serial numbers to process");return}const o=r.filter(l=>{const d=l.serial_number&&l.serial_number.trim()!=="",u=l.imei&&l.imei.trim()!=="";return d||u});if(o.length===0){console.log("No serial numbers provided");return}console.log(` Creating ${o.length} inventory items with serial numbers (accepting all as-is)`);const i=o.map(l=>({product_id:t.product_id,variant_id:t.variant_id,serial_number:l.serial_number||null,imei:l.imei||null,mac_address:l.mac_address||null,barcode:l.barcode||null,status:"available",purchase_order_id:e,purchase_order_item_id:t.id,location:l.location||null,warranty_start:l.warranty_start||null,warranty_end:l.warranty_end||null,cost_price:l.cost_price||t.unit_cost||0,selling_price:l.selling_price||null,notes:l.notes||`Received from purchase order ${e}`,metadata:{purchase_order_id:e,purchase_order_item_id:t.id,received_by:a,received_at:new Date().toISOString(),warranty_months:l.warranty_months||12,system:"legacy"}})),{error:c}=await w.from("inventory_items").insert(i);if(c)if(console.error("Error inserting legacy inventory items:",c),c.code==="23505"&&((n=c.message)!=null&&n.includes("serial_number"))){console.warn(" Some serial numbers may be duplicates. Attempting to insert individually...");let l=0;for(const d of i)try{const{error:u}=await w.from("inventory_items").insert(d);u?console.warn(` Skipped duplicate/invalid serial number: ${d.serial_number}`,u):l++}catch(u){console.warn(` Error inserting item with serial ${d.serial_number}:`,u)}if(l===0)throw new Error("Failed to insert any inventory items. All serial numbers may be duplicates or invalid.");if(console.log(` Successfully inserted ${l} out of ${i.length} inventory items`),t.variant_id&&l>0)try{const{data:d,error:u}=await w.from("lats_product_variants").select("quantity").eq("id",t.variant_id).single();if(!u&&d){const h=d.quantity||0,{error:g}=await w.from("lats_product_variants").update({quantity:h+l,updated_at:new Date().toISOString()}).eq("id",t.variant_id);g||console.log(` Updated variant ${t.variant_id} quantity: ${h} -> ${h+l} (+${l})`)}}catch(d){console.warn("Warning: Error updating variant quantity:",d)}return}else throw c;if(t.variant_id&&o.length>0)try{const{data:l,error:d}=await w.from("lats_product_variants").select("quantity").eq("id",t.variant_id).single();if(d)console.warn(`Warning: Could not get variant quantity for ${t.variant_id}:`,d);else{const u=l.quantity||0,h=o.length,{error:g}=await w.from("lats_product_variants").update({quantity:u+h,updated_at:new Date().toISOString()}).eq("id",t.variant_id);g?console.warn(`Warning: Could not update variant quantity for ${t.variant_id}:`,g):console.log(` Updated variant ${t.variant_id} quantity: ${u} -> ${u+h} (+${h})`);try{const{error:p}=await w.from("lats_stock_movements").insert({product_id:t.product_id,variant_id:t.variant_id,movement_type:"in",quantity:h,previous_quantity:u,new_quantity:u+h,reason:"Purchase Order Receipt",reference:`PO-${e}`,notes:`Received ${h} units with serial numbers from PO ${e}`,created_by:a,created_at:new Date().toISOString()});p&&console.warn("Warning: Could not create stock movement:",p)}catch(p){console.warn("Warning: Error creating stock movement:",p)}}}catch(l){console.warn("Warning: Error updating variant quantity:",l)}console.log(` Successfully created ${o.length} legacy inventory items`)}catch(o){throw console.error("Error creating legacy inventory items:",o),o}}static async fixOrderStatusIfNeeded(e,t){var r;console.log(" [fixOrderStatusIfNeeded] Starting...",{purchaseOrderId:e,userId:t});try{console.log(" [fixOrderStatusIfNeeded] Querying order...");const{data:a,error:n}=await w.from("lats_purchase_orders").select(`
          id,
          status
        `).eq("id",e).single();if(console.log(" [fixOrderStatusIfNeeded] Order query result:",{order:a,orderError:n}),n)return console.error(" Error fetching order in fixOrderStatusIfNeeded:",{purchaseOrderId:e,error:n,code:n.code,message:n.message,details:n.details,hint:n.hint}),{success:!1,message:`Order query failed: ${n.message}`};if(!a)return console.log(" Order not found:",e),{success:!1,message:"Order not found"};const{data:o,error:i}=await w.from("lats_purchase_order_items").select("id, quantity_ordered, quantity_received").eq("purchase_order_id",e);if(i)return console.error(" Error fetching order items in fixOrderStatusIfNeeded:",{purchaseOrderId:e,error:i,code:i.code,message:i.message,details:i.details,hint:i.hint}),{success:!1,message:`Items query failed: ${i.message}`};if(!o||!Array.isArray(o)||o.length===0)return{success:!0,message:"Order has no items to check"};const c={...a,items:o},l=o.some(g=>g.quantity_received>0),d=o.some(g=>g.quantity_received>=g.quantity_ordered);let u=a.status,h=!1;if(a.status==="sent"&&l&&(u="received",h=!0),h){const{error:g}=await w.from("lats_purchase_orders").update({status:u}).eq("id",e);return g?(console.error(" Error updating order status in fixOrderStatusIfNeeded:",{purchaseOrderId:e,oldStatus:a.status,newStatus:u,error:g,code:g.code,message:g.message,details:g.details,hint:g.hint}),{success:!1,message:`Status update failed: ${g.message}`}):(console.log(` Order status updated from ${a.status} to ${u} for PO: ${e}`),{success:!0,message:`Order status updated to ${u}`,statusChanged:!0})}return{success:!0,message:"Order status is correct"}}catch(a){const n={purchaseOrderId:e,errorType:typeof a,errorMessage:a instanceof Error?a.message:"Unknown error",errorStack:a instanceof Error?a.stack:void 0,errorConstructorName:(r=a==null?void 0:a.constructor)==null?void 0:r.name,errorKeys:a?Object.keys(a):[]};try{a&&typeof a=="object"&&Object.assign(n,{errorStringified:JSON.stringify(a,null,2)})}catch{n.stringifyError="Could not stringify error"}console.error(" Exception in fixOrderStatusIfNeeded:",n);let o="Unknown error occurred";return a instanceof Error?o=a.message:a&&typeof a=="object"&&"message"in a?o=String(a.message):typeof a=="string"&&(o=a),{success:!1,message:`Failed to fix order status: ${o}`}}}static async getPurchaseOrderInventoryStats(e){try{return console.log("Getting inventory stats for PO:",e),{success:!0,data:{totalItems:0,receivedItems:0,pendingItems:0},message:"Inventory stats retrieved"}}catch(t){return console.error("Error getting inventory stats:",t),{success:!1,message:"Failed to get inventory stats"}}}static async updateInventoryItemStatus(e,t,r){try{return console.log("Updating inventory item status:",e,t),{success:!0,message:"Item status updated"}}catch(a){return console.error("Error updating inventory item status:",a),{success:!1,message:"Failed to update item status"}}}static async exportInventoryToCSV(e,t){try{return console.log("Exporting inventory to CSV for PO:",e),{success:!0,data:"csv-data-here",message:"Inventory exported to CSV"}}catch(r){return console.error("Error exporting inventory:",r),{success:!1,message:"Failed to export inventory"}}}static async areAllItemsFullyReceived(e){try{return console.log("Checking if all items are fully received for PO:",e),!1}catch(t){return console.error("Error checking if all items are fully received:",t),!1}}static async submitForApproval(e,t,r){try{const{data:a,error:n}=await w.rpc("submit_po_for_approval",{purchase_order_id_param:e,user_id_param:t,approval_notes:r});if(n)throw n;return{success:!0,message:"Purchase order sent to supplier"}}catch(a){return console.error("Error sending to supplier:",a),{success:!1,message:`Failed to send to supplier: ${a instanceof Error?a.message:"Unknown error"}`}}}static async markAsReceived(e,t,r){try{const{data:a,error:n}=await w.rpc("mark_po_as_received",{purchase_order_id_param:e,user_id_param:t,received_notes:r});if(n)throw n;return gt.emit("lats:purchase-order.received",{purchaseOrderId:e,userId:t,notes:r}),console.log(" [PurchaseOrderService] Purchase order received event emitted"),{success:!0,message:"Purchase order marked as received"}}catch(a){return console.error("Error marking as received:",a),{success:!1,message:`Failed to mark as received: ${a instanceof Error?a.message:"Unknown error"}`}}}static async approvePurchaseOrder(e,t,r){try{const{data:a,error:n}=await w.rpc("approve_po",{purchase_order_id_param:e,approver_id_param:t,approval_notes_param:r});if(n)throw n;return{success:!0,message:"Purchase order approved"}}catch(a){return console.error("Error approving purchase order:",a),{success:!1,message:`Failed to approve purchase order: ${a instanceof Error?a.message:"Unknown error"}`}}}static async getReceivedItemsForPricing(e){var t,r;try{const{data:a,error:n}=await w.from("inventory_items").select("id, product_id, variant_id, serial_number, cost_price, selling_price, location").eq("purchase_order_id",e).eq("status","pending_pricing");if(n)return console.error("Error fetching items for pricing:",n),[];if(!a||a.length===0)return[];const o=a.map(h=>h.product_id).filter(Boolean),i=a.map(h=>h.variant_id).filter(Boolean),[c,l]=await Promise.all([o.length>0?w.from("lats_products").select("id, name").in("id",o):Promise.resolve({data:[],error:null}),i.length>0?w.from("lats_product_variants").select("id, name, variant_name").in("id",i):Promise.resolve({data:[],error:null})]),d=new Map(((t=c.data)==null?void 0:t.map(h=>[h.id,h]))||[]),u=new Map(((r=l.data)==null?void 0:r.map(h=>[h.id,{...h,name:h.name||h.variant_name||"Unnamed"}]))||[]);return a.map(h=>{var g,p;return{inventory_item_id:h.id,product_name:h.product_id&&((g=d.get(h.product_id))==null?void 0:g.name)||"Unknown Product",variant_name:h.variant_id&&((p=u.get(h.variant_id))==null?void 0:p.name)||void 0,serial_number:h.serial_number||"",imei:h.imei,cost_price:h.cost_price||0,selling_price:h.selling_price,location:h.location}})}catch(a){return console.error("Error in getReceivedItemsForPricing:",a),[]}}static async updateItemsPrices(e,t){try{let r=0;for(const a of e){const{error:n}=await w.from("inventory_items").update({selling_price:a.selling_price,status:"available",updated_at:new Date().toISOString()}).eq("id",a.inventory_item_id);if(n){console.error(`Error updating item ${a.inventory_item_id}:`,n);continue}r++}return r===0?{success:!1,message:"Failed to update any items",updatedItems:0}:(window.dispatchEvent(new CustomEvent("inventory-updated")),{success:!0,message:`Successfully updated ${r} item(s) with prices`,updatedItems:r})}catch(r){return console.error("Error in updateItemsPrices:",r),{success:!1,message:`Failed to update prices: ${r instanceof Error?r.message:"Unknown error"}`,updatedItems:0}}}static async hasPendingPricingItems(e){try{const{data:t,error:r}=await w.from("inventory_items").select("id").eq("purchase_order_id",e).eq("status","pending_pricing").limit(1);return r?(console.error("Error checking pending pricing items:",r),!1):t&&t.length>0||!1}catch(t){return console.error("Error in hasPendingPricingItems:",t),!1}}static async rejectPurchaseOrder(e,t,r){try{const{data:a,error:n}=await w.rpc("reject_po",{purchase_order_id_param:e,approver_id_param:t,rejection_reason:r});if(n)throw n;return{success:!0,message:"Purchase order rejected"}}catch(a){return console.error("Error rejecting purchase order:",a),{success:!1,message:`Failed to reject purchase order: ${a instanceof Error?a.message:"Unknown error"}`}}}static async updatePaymentStatus(e){return this.retryOperation(async()=>{try{const{data:t,error:r}=await w.from("lats_purchase_orders").select("total_amount").eq("id",e).single();if(r||!t)throw new Error("Purchase order not found");const a=t.total_amount||0,{data:n,error:o}=await w.from("purchase_order_payments").select("amount").eq("purchase_order_id",e).eq("status","completed");if(o)throw o;const i=(n==null?void 0:n.reduce((d,u)=>d+(u.amount||0),0))||0;let c;i===0?c="unpaid":i>=a?c="paid":c="partial";const{error:l}=await w.from("lats_purchase_orders").update({total_paid:i,payment_status:c,updated_at:new Date().toISOString()}).eq("id",e);if(l)throw l;return console.log(` Updated PO ${e} payment status: ${c}, total paid: ${i}`),{success:!0,message:"Payment status updated successfully"}}catch(t){return console.error("Error updating payment status:",t),{success:!1,message:`Failed to update payment status: ${t instanceof Error?t.message:"Unknown error"}`}}},"update_payment_status")}}Dr.MAX_RETRIES=3;Dr.RETRY_DELAY=1e3;const mb=`
-- Purchase Order Messages Table
CREATE TABLE IF NOT EXISTS purchase_order_messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  purchase_order_id UUID NOT NULL REFERENCES lats_purchase_orders(id) ON DELETE CASCADE,
  sender TEXT NOT NULL,
  content TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('system', 'user', 'supplier')),
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Purchase Order Payments Table
CREATE TABLE IF NOT EXISTS purchase_order_payments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  purchase_order_id UUID NOT NULL REFERENCES lats_purchase_orders(id) ON DELETE CASCADE,
  method TEXT NOT NULL,
  amount DECIMAL(15,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'TZS',
  status TEXT NOT NULL CHECK (status IN ('pending', 'completed', 'failed')),
  reference TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Purchase Order Audit Table
CREATE TABLE IF NOT EXISTS purchase_order_audit (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  purchase_order_id UUID NOT NULL REFERENCES lats_purchase_orders(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  "user" TEXT NOT NULL,
  details TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Purchase Order Quality Checks Table
CREATE TABLE IF NOT EXISTS purchase_order_quality_checks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  purchase_order_id UUID NOT NULL REFERENCES lats_purchase_orders(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES lats_purchase_order_items(id) ON DELETE CASCADE,
  passed BOOLEAN NOT NULL,
  notes TEXT,
  checked_by TEXT NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add indexes for better performance
CREATE INDEX IF NOT EXISTS idx_purchase_order_messages_order_id ON purchase_order_messages(purchase_order_id);
CREATE INDEX IF NOT EXISTS idx_purchase_order_payments_order_id ON purchase_order_payments(purchase_order_id);
CREATE INDEX IF NOT EXISTS idx_purchase_order_audit_order_id ON purchase_order_audit(purchase_order_id);
CREATE INDEX IF NOT EXISTS idx_purchase_order_quality_checks_order_id ON purchase_order_quality_checks(purchase_order_id);
`,fS=Object.freeze(Object.defineProperty({__proto__:null,CREATE_TABLES_SQL:mb,PurchaseOrderService:Dr},Symbol.toStringTag,{value:"Module"})),Me=()=>localStorage.getItem("current_branch_id");let wr=null;const pb=6e4,Ge=async s=>{if(!s)return{data_isolation_mode:"shared",share_products:!0,share_customers:!0,share_inventory:!0,share_suppliers:!0,share_categories:!0,share_employees:!0,share_sales:!0,share_purchase_orders:!0,share_devices:!0,share_payments:!0,share_appointments:!0,share_reminders:!0,share_expenses:!0,share_trade_ins:!0,share_special_orders:!0,share_attendance:!0,share_loyalty_points:!0};const e=Date.now();if(wr&&wr.branchId===s&&e-wr.timestamp<pb)return wr.settings;try{const{data:t,error:r}=await w.from("store_locations").select(`
        data_isolation_mode, 
        share_products, 
        share_customers, 
        share_inventory, 
        share_suppliers, 
        share_categories, 
        share_employees,
        share_sales,
        share_purchase_orders,
        share_devices,
        share_payments,
        share_appointments,
        share_reminders,
        share_expenses,
        share_trade_ins,
        share_special_orders,
        share_attendance,
        share_loyalty_points
      `).eq("id",s).single();return r?(r.code==="PGRST116"?console.log(" No branch settings found, using defaults"):console.error(" Error fetching branch settings:",r),{data_isolation_mode:"isolated",share_products:!1,share_customers:!1,share_inventory:!1,share_suppliers:!1,share_categories:!1,share_employees:!1,share_sales:!1,share_purchase_orders:!1,share_devices:!1,share_payments:!1,share_appointments:!1,share_reminders:!1,share_expenses:!1,share_trade_ins:!1,share_special_orders:!1,share_attendance:!1,share_loyalty_points:!1}):(wr={branchId:s,settings:t,timestamp:e},t)}catch(t){return console.error(" Exception fetching branch settings:",t),{data_isolation_mode:"isolated",share_products:!1,share_customers:!1,share_inventory:!1,share_suppliers:!1,share_categories:!1,share_employees:!1,share_sales:!1,share_purchase_orders:!1,share_devices:!1,share_payments:!1,share_appointments:!1,share_reminders:!1,share_expenses:!1,share_trade_ins:!1,share_special_orders:!1,share_attendance:!1,share_loyalty_points:!1}}},We=(s,e)=>{const t=e.data_isolation_mode;return t==="shared"?!1:t==="isolated"?!0:t==="hybrid"?!{products:e.share_products??!1,inventory:e.share_inventory??!1,customers:e.share_customers??!1,suppliers:e.share_suppliers??!1,categories:e.share_categories??!1,employees:e.share_employees??!1,purchase_orders:e.share_purchase_orders??!1,sales:e.share_sales??!1,devices:e.share_devices??!1,payments:e.share_payments??!1,appointments:e.share_appointments??!1,reminders:e.share_reminders??!1,expenses:e.share_expenses??!1,trade_ins:e.share_trade_ins??!1,special_orders:e.share_special_orders??!1,attendance:e.share_attendance??!1,loyalty_points:e.share_loyalty_points??!1}[s]:!0},ol={getList:async(s,e)=>{try{let t=w.from(s).select("*");if(e!=null&&e.filter&&Object.entries(e.filter).forEach(([a,n])=>{t=t.eq(a,n)}),e!=null&&e.sort){const{field:a,order:n}=e.sort;t=t.order(a,{ascending:n==="ASC"})}if(e!=null&&e.pagination){const{page:a=1,perPage:n=10}=e.pagination,o=(a-1)*n,i=o+n-1;t=t.range(o,i)}return await t}catch(t){return console.error("Provider error:",t),{data:null,error:t}}},getOne:async(s,e)=>{try{return await w.from(s).select("*").eq("id",e).single()}catch(t){return console.error("Provider error:",t),{data:null,error:t}}},create:async(s,e)=>{try{return await w.from(s).insert(e)}catch(t){return console.error("Provider error:",t),{data:null,error:t}}},update:async(s,e,t)=>{try{return await w.from(s).update(t).eq("id",e)}catch(r){return console.error("Provider error:",r),{data:null,error:r}}},delete:async(s,e)=>{try{return await w.from(s).delete().eq("id",e)}catch(t){return console.error("Provider error:",t),{data:null,error:t}}},rpc:async(s,e)=>{try{return await w.rpc(s,e)}catch(t){return console.error("RPC error:",t),{data:null,error:t}}},getCategories:async()=>{try{return{ok:!0,data:await nl()||[]}}catch(s){return console.error(" [Provider] Error fetching categories:",s),{ok:!1,message:s instanceof Error?s.message:"Failed to fetch categories",data:[]}}},createCategory:async s=>{try{const e=Me(),{data:t,error:r}=await w.from("lats_categories").insert({name:s.name,description:s.description,color:s.color,icon:s.icon,parent_id:s.parentId,is_active:s.isActive??!0,branch_id:e}).select().single();if(r)throw r;return{ok:!0,data:{id:t.id,name:t.name,description:t.description,color:t.color,icon:t.icon,parentId:t.parent_id,isActive:t.is_active,createdAt:t.created_at,updatedAt:t.updated_at}}}catch(e){return console.error("Error creating category:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to create category"}}},updateCategory:async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_categories").update({name:e.name,description:e.description,color:e.color,icon:e.icon,parent_id:e.parentId,is_active:e.isActive}).eq("id",s).select().single();if(r)throw r;return{ok:!0,data:{id:t.id,name:t.name,description:t.description,color:t.color,icon:t.icon,parentId:t.parent_id,isActive:t.is_active,createdAt:t.created_at,updatedAt:t.updated_at}}}catch(t){return console.error("Error updating category:",t),{ok:!1,message:t instanceof Error?t.message:"Failed to update category"}}},deleteCategory:async s=>{try{const{error:e}=await w.from("lats_categories").delete().eq("id",s);if(e)throw e;return{ok:!0,data:null}}catch(e){return console.error("Error deleting category:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to delete category"}}},getSuppliers:async()=>{try{return{ok:!0,data:await ky()||[]}}catch(s){return console.error(" [Provider] Error fetching suppliers:",s),{ok:!1,message:s instanceof Error?s.message:"Failed to fetch suppliers",data:[]}}},createSupplier:async s=>{try{const{data:e,error:t}=await w.from("lats_suppliers").insert({name:s.name,contact_person:s.contactPerson,email:s.email,phone:s.phone,address:s.address,city:s.city,country:s.country,payment_terms:s.paymentTerms,is_active:s.isActive??!0,notes:s.notes,branch_id:null,is_shared:!0}).select().single();if(t)throw t;return{ok:!0,data:{id:e.id,name:e.name,contactPerson:e.contact_person,email:e.email,phone:e.phone,address:e.address,city:e.city,country:e.country,paymentTerms:e.payment_terms,isActive:e.is_active,notes:e.notes,createdAt:e.created_at,updatedAt:e.updated_at}}}catch(e){return console.error("Error creating supplier:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to create supplier"}}},updateSupplier:async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_suppliers").update({name:e.name,contact_person:e.contactPerson,email:e.email,phone:e.phone,address:e.address,city:e.city,country:e.country,payment_terms:e.paymentTerms,is_active:e.isActive,notes:e.notes}).eq("id",s).select().single();if(r)throw r;return{ok:!0,data:{id:t.id,name:t.name,contactPerson:t.contact_person,email:t.email,phone:t.phone,address:t.address,city:t.city,country:t.country,paymentTerms:t.payment_terms,isActive:t.is_active,notes:t.notes,createdAt:t.created_at,updatedAt:t.updated_at}}}catch(t){return console.error("Error updating supplier:",t),{ok:!1,message:t instanceof Error?t.message:"Failed to update supplier"}}},deleteSupplier:async s=>{try{const{data:e,error:t}=await w.from("lats_purchase_orders").select("id").eq("supplier_id",s).limit(1);if(t)return console.error("Error checking purchase orders:",t),{ok:!1,message:`Failed to check supplier references: ${t.message}`};if(e&&e.length>0)return{ok:!1,message:"Cannot delete supplier: This supplier has associated purchase orders. Please delete or reassign the purchase orders first."};const{data:r,error:a}=await w.from("lats_products").select("id").eq("supplier_id",s).limit(1);if(a)return console.error("Error checking products:",a),{ok:!1,message:`Failed to check supplier references: ${a.message}`};if(r&&r.length>0)return{ok:!1,message:"Cannot delete supplier: This supplier has associated products. Please delete or reassign the products first."};const{error:n}=await w.from("lats_suppliers").delete().eq("id",s);if(n)throw n;return{ok:!0,data:null}}catch(e){return console.error("Error deleting supplier:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to delete supplier"}}},getProducts:async s=>{try{const e=await al();return{ok:!0,data:{data:e||[],page:(s==null?void 0:s.page)||1,limit:(s==null?void 0:s.limit)||100,total:(e==null?void 0:e.length)||0,totalPages:1}}}catch(e){const t=e instanceof Error?e.message:"Failed to fetch products";return console.error(" [Provider] Error fetching products:",e),console.error(" [Provider] Error message:",t),console.error(" [Provider] Error stack:",e instanceof Error?e.stack:"No stack"),{ok:!1,message:t,data:{data:[],page:1,limit:100,total:0,totalPages:0}}}},getProduct:async s=>{try{return{ok:!0,data:await sl(s)}}catch(e){return console.error(" [Provider] Error fetching product:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to fetch product"}}},getProductVariants:async s=>{try{const e=Me();let t=null;if(e)try{const{data:i}=await w.from("store_locations").select("data_isolation_mode, share_inventory").eq("id",e).single();t=i}catch{console.warn(" [getProductVariants] Could not fetch branch settings")}let r=w.from("lats_product_variants").select("*").eq("product_id",s).is("parent_variant_id",null).eq("is_active",!0).order("variant_name");e&&t?t.data_isolation_mode==="isolated"?(r=r.eq("branch_id",e),console.log(` [getProductVariants] ISOLATED MODE - Variants: Only showing from branch ${e}`)):t.data_isolation_mode==="shared"?console.log(" [getProductVariants] SHARED MODE - Variants: Showing all variants"):t.data_isolation_mode==="hybrid"&&(t.share_inventory?(r=r.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`),console.log(` [getProductVariants] HYBRID MODE - Variants are SHARED - Showing branch ${e} + shared variants`)):(r=r.eq("branch_id",e),console.log(` [getProductVariants] HYBRID MODE - Variants are NOT SHARED - Only showing branch ${e}`))):e&&(r=r.or(`branch_id.eq.${e},branch_id.is.null`));const{data:a,error:n}=await r;if(n)throw n;return{ok:!0,data:await Promise.all((a||[]).map(async i=>{let c=i.quantity||0;if(i.is_parent||i.variant_type==="parent")try{let h=w.from("lats_product_variants").select("quantity, is_active, branch_id").eq("parent_variant_id",i.id).eq("variant_type","imei_child").eq("is_active",!0);e&&t?t.data_isolation_mode==="isolated"||t.data_isolation_mode==="hybrid"&&!t.share_inventory?h=h.eq("branch_id",e):t.data_isolation_mode==="hybrid"&&t.share_inventory&&(h=h.or(`branch_id.eq.${e},is_shared.eq.true,branch_id.is.null`)):e&&(h=h.or(`branch_id.eq.${e},branch_id.is.null`));const{data:g,error:p}=await h;!p&&g&&(c=g.reduce((m,_)=>m+(_.quantity||0),0))}catch(h){console.warn("Could not calculate stock from children:",h)}const l=h=>{if(!h)return{};if(typeof h=="string")try{return JSON.parse(h)}catch{return{}}return h||{}},d=l(i.variant_attributes),u=l(i.attributes);return{id:i.id,productId:i.product_id,name:i.variant_name||i.name||"Unnamed",sku:i.sku,attributes:u,variant_attributes:d,variantAttributes:d,price:i.selling_price||0,costPrice:i.cost_price||0,sellingPrice:i.selling_price||0,stockQuantity:c,minStockLevel:i.min_quantity||0,quantity:c,minQuantity:i.min_quantity||0,isParent:i.is_parent||!1,variantType:i.variant_type||"standard",createdAt:i.created_at,updatedAt:i.updated_at}}))}}catch(e){return console.error("Error fetching product variants:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to fetch product variants",data:[]}}},createProduct:async s=>{try{const{data:{user:e}}=await w.auth.getUser();if(!e)return console.error(" [Provider] No authenticated user"),{ok:!1,message:"User not authenticated"};const t={name:s.name,description:s.description,shortDescription:s.shortDescription,sku:s.sku,categoryId:s.categoryId||null,supplierId:s.supplierId||null,costPrice:s.costPrice,sellingPrice:s.sellingPrice??s.price,price:s.price??s.sellingPrice,quantity:s.quantity??s.stockQuantity,stockQuantity:s.stockQuantity??s.quantity,minQuantity:s.minQuantity??s.minStockLevel,minStockLevel:s.minStockLevel??s.minQuantity,barcode:s.barcode,storageRoomId:s.storageRoomId,shelfId:s.shelfId,attributes:s.attributes,isActive:s.isActive!==void 0?s.isActive:!0,metadata:{...s.metadata||{},skip_default_variant:s.variants&&s.variants.length>0,useVariants:s.variants&&s.variants.length>0,variantCount:s.variants?s.variants.length:0},variants:s.variants&&s.variants.length>0?s.variants.map(o=>({sku:o.sku,name:o.name||"Default",sellingPrice:o.sellingPrice??o.price??0,costPrice:o.costPrice??0,quantity:o.quantity??o.stockQuantity??0,minQuantity:o.minQuantity??o.minStockLevel??0,attributes:o.attributes||{}})):void 0,images:s.images||[]},{createProduct:r}=await z(()=>Promise.resolve().then(()=>_o),void 0),a=await r(t,e.id);if(!a||!a.id)return console.error(" [Provider] Product creation returned null or no ID - likely RLS policy issue"),{ok:!1,message:"Product creation failed - database returned no data. This may be an RLS policy issue."};const n=await ol.getProductVariants(a.id);return{ok:!0,data:{...a,variants:n.ok?n.data:[]},message:"Product created successfully"}}catch(e){console.error(" [Provider] Error creating product:",e),console.error(" [Provider] Error stack:",e==null?void 0:e.stack),console.error(" [Provider] Error details:",JSON.stringify(e,null,2));let t="Failed to create product";return e!=null&&e.message&&(t=e.message),(e==null?void 0:e.code)==="23505"?t="Duplicate SKU detected. Please use a unique SKU.":(e==null?void 0:e.code)==="23503"?t="Invalid reference: Category or Supplier does not exist.":(e==null?void 0:e.code)==="42703"&&(t="Database column mismatch. Please contact support."),{ok:!1,message:t,error:e}}},updateProduct:async(s,e)=>{try{const t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.sku!==void 0&&(t.sku=e.sku),e.barcode!==void 0&&(t.barcode=e.barcode),e.categoryId!==void 0&&(t.categoryId=e.categoryId),e.supplierId!==void 0&&(t.supplierId=e.supplierId),e.tags!==void 0&&(t.tags=Array.isArray(e.tags)&&e.tags.length>0?e.tags:null),e.isActive!==void 0&&(t.isActive=e.isActive),e.costPrice!==void 0&&(t.costPrice=e.costPrice),e.selling_price!==void 0?t.sellingPrice=e.selling_price:e.price!==void 0&&(t.sellingPrice=e.price),e.stockQuantity!==void 0&&(t.stockQuantity=e.stockQuantity),e.minStockLevel!==void 0&&(t.minStockLevel=e.minStockLevel),e.condition!==void 0&&(t.condition=e.condition),e.specification!==void 0&&(t.specification=e.specification),e.variants&&Array.isArray(e.variants)&&e.variants.length>0&&(t.variants=e.variants.map((n,o)=>({id:n==null?void 0:n.id,sku:n==null?void 0:n.sku,name:(n==null?void 0:n.name)||(n==null?void 0:n.variant_name)||"Default",attributes:(n==null?void 0:n.attributes)||{},costPrice:typeof(n==null?void 0:n.costPrice)=="number"?n.costPrice:(n==null?void 0:n.cost_price)??0,sellingPrice:typeof(n==null?void 0:n.sellingPrice)=="number"?n.sellingPrice:(n==null?void 0:n.selling_price)??(n==null?void 0:n.price)??0,quantity:typeof(n==null?void 0:n.quantity)=="number"?n.quantity:(n==null?void 0:n.stockQuantity)??0,minQuantity:typeof(n==null?void 0:n.minQuantity)=="number"?n.minQuantity:(n==null?void 0:n.minStockLevel)??0})));const{updateProduct:r}=await z(()=>Promise.resolve().then(()=>_o),void 0);return{ok:!0,data:await r(s,t,""),message:"Product updated successfully"}}catch(t){console.error(" [Provider] Error updating product:",t),console.error(" [Provider] Error stack:",t==null?void 0:t.stack),console.error(" [Provider] Error details:",JSON.stringify(t,null,2));let r="Failed to update product";return t!=null&&t.message&&(r=t.message),(t==null?void 0:t.code)==="23505"?r="Duplicate SKU detected. Each variant must have a unique SKU.":(t==null?void 0:t.code)==="23503"?r="Invalid reference: Category or Supplier does not exist.":(t==null?void 0:t.code)==="42703"&&(r="Database column mismatch. Please contact support."),{ok:!1,message:r}}},updateProductVariantCostPrice:async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_product_variants").update({cost_price:e}).eq("id",s).select().single();if(r)throw r;return{ok:!0,data:t}}catch(t){return console.error("Error updating variant cost price:",t),{ok:!1,message:t instanceof Error?t.message:"Failed to update variant cost price"}}},deleteProduct:async s=>{try{const{data:e,error:t}=await w.from("lats_product_variants").select("id").eq("product_id",s);if(t)throw console.error("Error fetching variants:",t),t;const r=(e==null?void 0:e.map(l=>l.id))||[];if(r.length>0){const{error:l}=await w.from("lats_purchase_order_items").delete().in("variant_id",r);l&&console.error("Error deleting purchase order items (by variant):",l)}const{error:a}=await w.from("lats_purchase_order_items").delete().eq("product_id",s);if(a)throw console.error("Error deleting purchase order items (by product):",a),a;if(r.length>0){const{error:l}=await w.from("lats_stock_movements").delete().in("variant_id",r);l&&console.error("Error deleting stock movements:",l)}const{error:n}=await w.from("lats_stock_movements").delete().eq("product_id",s);if(n&&console.error("Error deleting stock movements (by product):",n),r.length>0){const{error:l}=await w.from("lats_product_variants").delete().in("id",r);if(l)throw console.error("Error deleting variants:",l),l}const{error:o}=await w.from("lats_sale_items").delete().eq("product_id",s);o&&console.error("Error deleting sale items:",o);const{error:i}=await w.from("auto_reorder_log").delete().eq("product_id",s);i&&console.error("Error deleting auto reorder log:",i);const{error:c}=await w.from("lats_products").delete().eq("id",s);if(c)throw c;return{ok:!0,data:null}}catch(e){return console.error("Error deleting product:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to delete product"}}},searchProducts:async s=>{try{const{data:e,error:t}=await w.from("lats_products").select("*").or(`name.ilike.%${s}%,sku.ilike.%${s}%`).limit(20);if(t)throw t;if(!e||e.length===0)return{ok:!0,data:[]};const r=e.map(h=>h.id),a=[...new Set(e.map(h=>h.category_id).filter(Boolean))],n=[...new Set(e.map(h=>h.supplier_id).filter(Boolean))],{data:o}=r.length>0?await w.from("lats_product_variants").select("*").in("product_id",r):{data:[]},{data:i}=a.length>0?await w.from("lats_categories").select("id, name").in("id",a):{data:[]},{data:c}=n.length>0?await w.from("lats_suppliers").select("id, name").in("id",n):{data:[]},l=(o||[]).reduce((h,g)=>(h[g.product_id]||(h[g.product_id]=[]),h[g.product_id].push(g),h),{}),d=(i||[]).reduce((h,g)=>(h[g.id]=g,h),{}),u=(c||[]).reduce((h,g)=>(h[g.id]=g,h),{});return{ok:!0,data:e.map(h=>{var p,m,_,b;const g=l[h.id]||[];return{id:h.id,name:h.name,sku:h.sku,categoryId:h.category_id,categoryName:(p=d[h.category_id])==null?void 0:p.name,supplierId:h.supplier_id,supplierName:(m=u[h.supplier_id])==null?void 0:m.name,price:((_=g[0])==null?void 0:_.selling_price)||0,costPrice:((b=g[0])==null?void 0:b.cost_price)||0,totalQuantity:h.total_quantity,image_url:h.image_url,brand:h.brand,model:h.model,description:h.description,variants:g.map(S=>{const v=x=>{if(!x)return{};if(typeof x=="string")try{return JSON.parse(x)}catch{return{}}return x||{}},C=v(S.variant_attributes),T=v(S.attributes);return{id:S.id,name:S.name,sku:S.sku,sellingPrice:S.selling_price||0,selling_price:S.selling_price||0,costPrice:S.cost_price,cost_price:S.cost_price,stockQuantity:S.quantity,stock_quantity:S.quantity,quantity:S.quantity,barcode:S.barcode,variant_name:S.variant_name,variant_attributes:C,variantAttributes:C,attributes:T}})}})}}catch(e){return console.error("Error searching products:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to search products",data:[]}}},adjustStock:async(s,e,t,r,a)=>{try{const{data:n,error:o}=await w.from("lats_stock_movements").insert({product_id:s,variant_id:e,quantity:t,movement_type:t>0?"in":"out",reason:r,reference:a}).select().single();if(o)throw o;return{ok:!0,data:n}}catch(n){return console.error("Error adjusting stock:",n),{ok:!1,message:n instanceof Error?n.message:"Failed to adjust stock"}}},getStockMovements:async s=>{try{let e=w.from("lats_stock_movements").select("*").order("created_at",{ascending:!1});s&&(e=e.eq("product_id",s));const{data:t,error:r}=await e.limit(100);if(r)throw r;return{ok:!0,data:t||[]}}catch(e){return console.error("Error fetching stock movements:",e),{ok:!1,message:e instanceof Error?e.message:"Failed to fetch stock movements",data:[]}}},getPurchaseOrders:async()=>{try{const s=Me(),e=await Ge(s);let t=w.from("lats_purchase_orders").select("*").order("created_at",{ascending:!1});We("purchase_orders",e)&&s&&(t=t.eq("branch_id",s));const{data:r,error:a}=await t;if(a)return console.error(" Error fetching purchase orders:",a),{ok:!1,message:a.message,data:[]};const n=(r==null?void 0:r.map(u=>u.id))||[];let o=new Map;if(n.length>0){const{data:u,error:h}=await w.from("lats_purchase_order_items").select("purchase_order_id, id, product_id, variant_id, quantity_ordered, unit_cost, quantity_received").in("purchase_order_id",n);if(!h&&u){const g=[...new Set(u.map(b=>b.product_id).filter(Boolean))],p=[...new Set(u.map(b=>b.variant_id).filter(Boolean))],m=new Map,_=new Map;if(g.length>0){const{data:b}=await w.from("lats_products").select("id, name, sku").in("id",g);b&&b.forEach(v=>{m.set(v.id,v)});const{data:S}=await w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",g).order("is_primary",{ascending:!1});S&&S.forEach(v=>{const C=m.get(v.product_id);if(C){C.images||(C.images=[]);const T={id:v.id,url:v.thumbnail_url||v.image_url,thumbnailUrl:v.thumbnail_url,isPrimary:v.is_primary||!1};v.is_primary?C.images.unshift(T):C.images.push(T)}})}if(p.length>0){const{data:b}=await w.from("lats_product_variants").select("id, variant_name, sku").in("id",p);b&&b.forEach(S=>{_.set(S.id,S)})}u.forEach(b=>{const S=b.purchase_order_id,v=o.get(S)||{count:0,totalQuantity:0,items:[]};v.count+=1,v.totalQuantity+=b.quantity_ordered||0,v.items.push({id:b.id,productId:b.product_id,variantId:b.variant_id,quantity:b.quantity_ordered||0,costPrice:parseFloat(b.unit_cost)||0,totalPrice:(b.quantity_ordered||0)*(parseFloat(b.unit_cost)||0),receivedQuantity:b.quantity_received||0,product:m.get(b.product_id),variant:_.get(b.variant_id)}),o.set(S,v)})}}const i=new Map;if(n.length>0){const{data:u,error:h}=await w.from("purchase_order_payments").select("purchase_order_id, amount, status").in("purchase_order_id",n);!h&&u?u.forEach(g=>{if(g.status&&g.status!=="completed")return;const p=g.purchase_order_id,m=typeof g.amount=="string"?parseFloat(g.amount)||0:g.amount||0,_=i.get(p)||{count:0,total:0};_.count+=1,_.total+=m,i.set(p,_)}):h&&console.warn(" [getPurchaseOrders] Error fetching payments for counts:",h)}const c=new Map,l=[...new Set((r||[]).map(u=>u.supplier_id).filter(Boolean))];if(l.length>0){const{data:u,error:h}=await w.from("lats_suppliers").select("id, name, contact_person, email, phone").in("id",l);!h&&u?u.forEach(g=>{c.set(g.id,g)}):console.error(" [getPurchaseOrders] Error fetching suppliers:",h)}return{ok:!0,data:(r||[]).map(u=>{const h=o.get(u.id)||{count:0,totalQuantity:0,items:[]},g=i.get(u.id)||{count:0,total:0},p=typeof u.total_amount=="string"?parseFloat(u.total_amount)||0:u.total_amount||0,m=typeof u.total_paid=="string"?parseFloat(u.total_paid)||0:u.total_paid||0,_=typeof u.exchange_rate=="string"?parseFloat(u.exchange_rate)||void 0:u.exchange_rate,b=typeof u.total_amount_base_currency=="string"?parseFloat(u.total_amount_base_currency)||void 0:u.total_amount_base_currency,S=m>0?m:g.total||0,v=u.supplier_id?c.get(u.supplier_id):void 0;return{id:u.id,orderNumber:u.po_number,supplierId:u.supplier_id,status:u.status,totalAmount:p,currency:u.currency||"TZS",notes:u.notes,orderDate:u.order_date,expectedDeliveryDate:u.expected_delivery_date,receivedDate:u.received_date,createdAt:u.created_at,updatedAt:u.updated_at,createdBy:u.created_by,paymentStatus:u.payment_status,paymentTerms:u.payment_terms,totalPaid:S,paymentsCount:g.count,exchangeRate:_,exchangeRateSource:u.exchange_rate_source,totalAmountBaseCurrency:b,supplier:v,items:h.items||[]}})}}catch(s){return console.error(" Unexpected error fetching purchase orders:",s),{ok:!1,message:s.message||"Failed to fetch purchase orders",data:[]}}},getPurchaseOrder:async s=>{try{const{data:e,error:t}=await w.from("lats_purchase_orders").select("*").eq("id",s).single();if(t)return console.error(" Error fetching purchase order:",t),{ok:!1,message:t.message};let r=null;if(e.supplier_id){const{data:u,error:h}=await w.from("lats_suppliers").select("*").eq("id",e.supplier_id).single();!h&&u?r=u:console.error(" [Provider] Error fetching supplier:",h)}const{data:a,error:n}=await w.from("lats_purchase_order_items").select("*").eq("purchase_order_id",s);if(n)return console.error(" Error fetching purchase order items:",n),{ok:!1,message:n.message};const o=[...new Set((a||[]).map(u=>u.product_id).filter(Boolean))],i=[...new Set((a||[]).map(u=>u.variant_id).filter(Boolean))];let c=new Map,l=new Map;if(o.length>0){const{data:u}=await w.from("lats_products").select("*").in("id",o);u==null||u.forEach(g=>c.set(g.id,g));const{data:h}=await w.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",o).order("is_primary",{ascending:!1});h&&h.forEach(g=>{const p=c.get(g.product_id);if(p){p.images||(p.images=[]);const m={id:g.id,url:g.thumbnail_url||g.image_url,thumbnailUrl:g.thumbnail_url,isPrimary:g.is_primary||!1};g.is_primary?p.images.unshift(m):p.images.push(m)}})}if(i.length>0){const{data:u}=await w.from("lats_product_variants").select("*").in("id",i);u==null||u.forEach(h=>{l.set(h.id,{...h,name:h.variant_name||h.name||"Default Variant"})})}return{ok:!0,data:{id:e.id,orderNumber:e.po_number,supplierId:e.supplier_id,status:e.status,totalAmount:e.total_amount||0,currency:e.currency||"TZS",notes:e.notes,orderDate:e.order_date,expectedDeliveryDate:e.expected_delivery_date,receivedDate:e.received_date,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:e.created_by,paymentStatus:e.payment_status,paymentTerms:e.payment_terms,totalPaid:e.total_paid||0,exchangeRate:e.exchange_rate,exchangeRateSource:e.exchange_rate_source,totalAmountBaseCurrency:e.total_amount_base_currency,supplier:r?{id:r.id,name:r.name,contactPerson:r.contact_person,email:r.email,phone:r.phone,address:r.address,city:r.city,country:r.country,currency:r.currency,paymentTerms:r.payment_terms,isActive:r.is_active,notes:r.notes,createdAt:r.created_at,updatedAt:r.updated_at}:null,items:(a==null?void 0:a.map(u=>{const h=u.quantity_ordered||0,g=u.unit_cost||0,p=h*g;return{id:u.id,purchaseOrderId:u.purchase_order_id,productId:u.product_id,variantId:u.variant_id,quantity:h,quantityOrdered:h,receivedQuantity:u.quantity_received||0,costPrice:g,cost_price:g,unitCost:g,totalPrice:p,subtotal:p,status:u.status||"pending",notes:u.notes,createdAt:u.created_at,updatedAt:u.updated_at,product:c.get(u.product_id),variant:l.get(u.variant_id)}}))||[]}}}catch(e){return console.error(" Unexpected error fetching purchase order:",e),{ok:!1,message:e.message||"Failed to fetch purchase order"}}},createPurchaseOrder:async s=>{var e;try{const t=s.po_number||`PO-${Date.now()}`,r=s.items.reduce((g,p)=>g+p.quantity*p.costPrice,0),a=s.exchangeRate||1,n=r*a,o=Me(),i=await Ge(o),{data:c,error:l}=await w.from("lats_purchase_orders").insert({po_number:t,supplier_id:s.supplierId,status:s.status||"draft",total_amount:r,currency:s.currency||"TZS",payment_terms:s.paymentTerms||null,exchange_rate:a,base_currency:s.baseCurrency||"TZS",exchange_rate_source:s.exchangeRateSource||"manual",exchange_rate_date:s.exchangeRateDate||new Date().toISOString(),total_amount_base_currency:n,notes:s.notes||"",order_date:s.orderDate||new Date().toISOString(),expected_delivery_date:s.expectedDelivery||null,created_by:s.createdBy||null,branch_id:We("purchase_orders",i)?o:null}).select().single();if(l)return console.error(" Error creating purchase order:",l),{ok:!1,message:l.message};const d=s.items.map(g=>({purchase_order_id:c.id,product_id:g.productId,variant_id:g.variantId,quantity_ordered:g.quantity,quantity_received:0,unit_cost:g.costPrice,subtotal:g.quantity*g.costPrice})),{data:u,error:h}=await w.from("lats_purchase_order_items").insert(d).select();if(h)return console.error(" Error creating purchase order items:",h),console.error(" Error details:",{message:h.message,code:h.code,details:h.details,hint:h.hint}),console.error(" Items that failed:",JSON.stringify(d,null,2)),await w.from("lats_purchase_orders").delete().eq("id",c.id),{ok:!1,message:`Failed to create items: ${h.message}`};try{await Dr.addAuditEntry({purchaseOrderId:c.id,action:"Purchase Order Created",user:s.createdBy||"",details:`Purchase order ${t} created with ${d.length} items. Total: ${r}. Status: ${s.status||"draft"}`})}catch(g){console.warn(" Failed to log audit entry:",g)}return{ok:!0,data:{...c,items:u||d},message:"Purchase order created successfully"}}catch(t){return console.error(" Unexpected error creating purchase order:",t),console.error(" Full error object:",JSON.stringify(t,null,2)),console.error(" Error type:",typeof t,(e=t.constructor)==null?void 0:e.name),{ok:!1,message:t.message||t.toString()||"Failed to create purchase order"}}},updatePurchaseOrder:async(s,e)=>{try{const t={status:e.status,notes:e.notes,expected_delivery_date:e.expectedDelivery,updated_at:new Date().toISOString()};if(e.currency&&(t.currency=e.currency),e.paymentTerms&&(t.payment_terms=e.paymentTerms),e.exchangeRate&&(t.exchange_rate=e.exchangeRate),e.baseCurrency&&(t.base_currency=e.baseCurrency),e.exchangeRateSource&&(t.exchange_rate_source=e.exchangeRateSource),e.exchangeRateDate&&(t.exchange_rate_date=e.exchangeRateDate),e.items&&e.exchangeRate){const n=e.items.reduce((o,i)=>o+i.quantity*i.costPrice,0);t.total_amount=n,t.total_amount_base_currency=n*e.exchangeRate}const{data:r,error:a}=await w.from("lats_purchase_orders").update(t).eq("id",s).select().single();if(a)return console.error(" Error updating purchase order:",a),{ok:!1,message:a.message};try{const n=[];e.status&&n.push(`Status: ${e.status}`),e.notes&&n.push("Notes updated"),e.expectedDelivery&&n.push(`Expected delivery: ${e.expectedDelivery}`),e.currency&&n.push(`Currency: ${e.currency}`),e.exchangeRate&&n.push(`Exchange rate: ${e.exchangeRate}`),e.paymentTerms&&n.push(`Payment terms: ${e.paymentTerms}`),await Dr.addAuditEntry({purchaseOrderId:s,action:"Purchase Order Updated",user:e.updatedBy||"",details:`Purchase order updated. Changes: ${n.join(", ")}`})}catch(n){console.warn(" Failed to log audit entry:",n)}return{ok:!0,data:r,message:"Purchase order updated successfully"}}catch(t){return console.error(" Unexpected error updating purchase order:",t),{ok:!1,message:t.message||"Failed to update purchase order"}}},receivePurchaseOrder:async s=>{try{const{data:{user:e}}=await w.auth.getUser();if(!e)return{ok:!1,message:"User not authenticated"};const{data:t,error:r}=await w.rpc("complete_purchase_order_receive",{purchase_order_id_param:s,user_id_param:e.id,receive_notes:"Received via PO system"});if(r)return console.error(" Error receiving purchase order:",r),{ok:!1,message:r.message||"Failed to receive purchase order"};gt.emit("lats:purchase-order.received",{purchaseOrderId:s,userId:e.id,notes:"Received via PO system"});const{data:a,error:n}=await w.from("lats_purchase_orders").select("*").eq("id",s).single();if(n)return console.warn(" Could not fetch updated PO, but receive was successful"),{ok:!0,message:"Purchase order received successfully"};if(a&&a.supplier_id){const{data:o}=await w.from("lats_suppliers").select("*").eq("id",a.supplier_id).single();o&&(a.supplier=o)}return{ok:!0,data:a}}catch(e){return console.error(" Unexpected error receiving purchase order:",e),{ok:!1,message:e instanceof Error?e.message:"Unknown error occurred"}}},deletePurchaseOrder:async s=>({ok:!1,message:"Not implemented"}),getSpareParts:async()=>{try{const{data:s,error:e}=await w.from("lats_spare_parts").select("*").eq("is_active",!0).order("name",{ascending:!0});if(e)return console.error(" [DEBUG] getSpareParts: Database error:",e),{ok:!1,message:e.message||"Failed to fetch spare parts"};if(!s||s.length===0)return{ok:!0,data:[]};const t=[...new Set(s.map(h=>h.category_id).filter(Boolean))],r=[...new Set(s.map(h=>h.supplier_id).filter(Boolean))],a=s.map(h=>h.id),[n,o,i]=await Promise.all([t.length>0?w.from("lats_categories").select("id, name").in("id",t):Promise.resolve({data:[]}),r.length>0?w.from("lats_suppliers").select("id, name, email, phone").in("id",r):Promise.resolve({data:[]}),a.length>0?w.from("lats_spare_part_variants").select("*").in("spare_part_id",a):Promise.resolve({data:[]})]),c=(n.data||[]).reduce((h,g)=>(h[g.id]=g,h),{}),l=(o.data||[]).reduce((h,g)=>(h[g.id]=g,h),{}),d=(i.data||[]).reduce((h,g)=>(h[g.spare_part_id]||(h[g.spare_part_id]=[]),h[g.spare_part_id].push(g),h),{});return{ok:!0,data:s.map(h=>({...h,category:c[h.category_id],supplier:l[h.supplier_id],variants:d[h.id]||[]}))}}catch(s){return console.error(" [DEBUG] getSpareParts: Unexpected error:",s),{ok:!1,message:"Failed to fetch spare parts"}}},getSparePart:async s=>{try{const{data:e,error:t}=await w.from("lats_spare_parts").select("*").eq("id",s).single();if(t)return{ok:!1,message:t.message||"Failed to fetch spare part"};const[r,a,n]=await Promise.all([e.category_id?w.from("lats_categories").select("id, name").eq("id",e.category_id).single():Promise.resolve({data:null}),e.supplier_id?w.from("lats_suppliers").select("id, name, email, phone").eq("id",e.supplier_id).single():Promise.resolve({data:null}),w.from("lats_spare_part_variants").select("*").eq("spare_part_id",s)]);return{ok:!0,data:{...e,category:r.data,supplier:a.data,variants:n.data||[]}}}catch(e){return console.error("Error getting spare part:",e),{ok:!1,message:"Failed to fetch spare part"}}},createSparePart:async s=>{try{const{data:e,error:t}=await w.from("lats_spare_parts").insert(s).select().single();return t?{ok:!1,message:t.message||"Failed to create spare part"}:{ok:!0,data:e}}catch(e){return console.error("Error creating spare part:",e),{ok:!1,message:"Failed to create spare part"}}},updateSparePart:async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_spare_parts").update({...e,updated_at:new Date().toISOString()}).eq("id",s).select().single();return r?{ok:!1,message:r.message||"Failed to update spare part"}:{ok:!0,data:t}}catch(t){return console.error("Error updating spare part:",t),{ok:!1,message:"Failed to update spare part"}}},deleteSparePart:async s=>{try{const{error:e}=await w.from("lats_spare_parts").delete().eq("id",s);return e?{ok:!1,message:e.message||"Failed to delete spare part"}:{ok:!0}}catch(e){return console.error("Error deleting spare part:",e),{ok:!1,message:"Failed to delete spare part"}}},useSparePart:async s=>{try{const{data:{user:e}}=await w.auth.getUser();if(!e)return{ok:!1,message:"User not authenticated"};const{data:t,error:r}=await w.from("lats_spare_part_usage").insert({...s,used_by:e.id,created_at:new Date().toISOString()}).select().single();if(r)return{ok:!1,message:r.message||"Failed to record spare part usage"};const{error:a}=await w.from("lats_spare_parts").update({quantity:w.raw("quantity - ?",[s.quantity]),updated_at:new Date().toISOString()}).eq("id",s.spare_part_id);return a?(console.error("Error updating spare part quantity:",a),{ok:!1,message:"Failed to update spare part quantity"}):{ok:!0,data:t}}catch(e){return console.error("Error using spare part:",e),{ok:!1,message:"Failed to use spare part"}}},getSparePartUsage:async()=>{try{const{data:s,error:e}=await w.from("lats_spare_part_usage").select("*").order("created_at",{ascending:!1});if(e)return{ok:!1,message:e.message||"Failed to fetch spare part usage"};if(!s||s.length===0)return{ok:!0,data:[]};const t=[...new Set(s.map(l=>l.spare_part_id).filter(Boolean))],r=[...new Set(s.map(l=>l.device_id).filter(Boolean))],[a,n]=await Promise.all([t.length>0?w.from("lats_spare_parts").select("id, name, part_number").in("id",t):Promise.resolve({data:[]}),r.length>0?w.from("devices").select("id, device_name, customer_name").in("id",r):Promise.resolve({data:[]})]),o=(a.data||[]).reduce((l,d)=>(l[d.id]=d,l),{}),i=(n.data||[]).reduce((l,d)=>(l[d.id]=d,l),{});return{ok:!0,data:s.map(l=>({...l,spare_part:o[l.spare_part_id],device:i[l.device_id]}))}}catch(s){return console.error("Error getting spare part usage:",s),{ok:!1,message:"Failed to fetch spare part usage"}}},getCart:async()=>({ok:!0,data:null}),addToCart:async s=>({ok:!1,message:"Not implemented"}),updateCartItem:async(s,e)=>({ok:!1,message:"Not implemented"}),removeFromCart:async s=>({ok:!1,message:"Not implemented"}),clearCart:async()=>({ok:!0,data:null}),processSale:async s=>({ok:!1,message:"Not implemented"}),getSales:async()=>{try{const s=Me(),e=await Ge(s);let t=w.from("lats_sales").select(`
          id,
          sale_number,
          customer_id,
          customer_name,
          subtotal,
          total_amount,
          discount_amount,
          tax_amount,
          payment_method,
          payment_status,
          status,
          sold_by,
          user_id,
          notes,
          created_at,
          updated_at,
          branch_id
        `).order("created_at",{ascending:!1}).limit(500);We("sales",e)&&s&&(t=t.eq("branch_id",s));const{data:r,error:a}=await t;return a?(console.error(" [Provider] Error fetching sales:",a),{ok:!1,message:a.message,data:[]}):{ok:!0,data:r||[]}}catch(s){const e=s instanceof Error?s.message:"Failed to fetch sales";return console.error(" [Provider] Exception fetching sales:",s),{ok:!1,message:e,data:[]}}},getSale:async s=>({ok:!1,message:"Not implemented"}),getPOSSettings:async()=>({ok:!0,data:{}}),updatePOSSettings:async s=>({ok:!0,data:s}),getInventoryStats:async()=>({ok:!0,data:{}}),getSalesStats:async()=>({ok:!0,data:{}}),getLowStockItems:async()=>({ok:!0,data:[]}),getAllSaleItems:async()=>({ok:!0,data:[]}),getShippingAgents:async()=>({ok:!0,data:[]}),getShippingAgent:async s=>({ok:!1,message:"Not implemented"}),createShippingAgent:async s=>({ok:!1,message:"Not implemented"}),updateShippingAgent:async(s,e)=>({ok:!1,message:"Not implemented"}),deleteShippingAgent:async s=>({ok:!1,message:"Not implemented"}),toggleShippingAgentStatus:async s=>({ok:!1,message:"Not implemented"}),getShippingManagers:async()=>({ok:!0,data:[]}),getDevices:async()=>{try{const s=Me(),e=await Ge(s);let t=w.from("devices").select("*").order("created_at",{ascending:!1});We("devices",e)&&s&&(t=t.eq("branch_id",s));const{data:r,error:a}=await t;return a?(console.error(" Error fetching devices:",a),{ok:!1,message:a.message,data:[]}):{ok:!0,data:r||[]}}catch(s){return console.error(" Unexpected error fetching devices:",s),{ok:!1,message:s.message||"Failed to fetch devices",data:[]}}},getDevice:async s=>{try{const{data:e,error:t}=await w.from("devices").select("*").eq("id",s).single();return t?(console.error(" Error fetching device:",t),{ok:!1,message:t.message}):{ok:!0,data:e}}catch(e){return console.error(" Unexpected error fetching device:",e),{ok:!1,message:e.message||"Failed to fetch device"}}},createDevice:async s=>{try{const e=Me(),t=await Ge(e),r={...s,branch_id:We("devices",t)?e||"00000000-0000-0000-0000-000000000001":null},{data:a,error:n}=await w.from("devices").insert(r).select().single();return n?(console.error(" Error creating device:",n),{ok:!1,message:n.message}):{ok:!0,data:a}}catch(e){return console.error(" Unexpected error creating device:",e),{ok:!1,message:e.message||"Failed to create device"}}},updateDevice:async(s,e)=>{try{const{data:t,error:r}=await w.from("devices").update(e).eq("id",s).select().single();return r?(console.error(" Error updating device:",r),{ok:!1,message:r.message}):{ok:!0,data:t}}catch(t){return console.error(" Unexpected error updating device:",t),{ok:!1,message:t.message||"Failed to update device"}}},deleteDevice:async s=>{try{const{error:e}=await w.from("devices").delete().eq("id",s);return e?(console.error(" Error deleting device:",e),{ok:!1,message:e.message}):{ok:!0}}catch(e){return console.error(" Unexpected error deleting device:",e),{ok:!1,message:e.message||"Failed to delete device"}}},getRepairParts:async s=>{try{const e=Me(),t=await Ge(e);let r=w.from("repair_parts").select("*").eq("device_id",s);We("devices",t)&&e&&(r=r.eq("branch_id",e));const{data:a,error:n}=await r;return n?(console.error(" Error fetching repair parts:",n),{ok:!1,message:n.message,data:[]}):{ok:!0,data:a||[]}}catch(e){return console.error(" Unexpected error fetching repair parts:",e),{ok:!1,message:e.message||"Failed to fetch repair parts",data:[]}}},getCustomerPayments:async s=>{try{const e=Me();let t=w.from("customer_payments").select("*").order("payment_date",{ascending:!1});s!=null&&s.customer_id&&(t=t.eq("customer_id",s.customer_id)),s!=null&&s.device_id&&(t=t.eq("device_id",s.device_id));const r=await Ge(e);We("payments",r)&&e&&(t=t.eq("branch_id",e));const{data:a,error:n}=await t;return n?(console.error(" Error fetching customer payments:",n),{ok:!1,message:n.message,data:[]}):{ok:!0,data:a||[]}}catch(e){return console.error(" Unexpected error fetching customer payments:",e),{ok:!1,message:e.message||"Failed to fetch customer payments",data:[]}}},createCustomerPayment:async s=>{try{const e=Me(),t=await Ge(e),r={...s,branch_id:We("payments",t)?e||"00000000-0000-0000-0000-000000000001":null},{data:a,error:n}=await w.from("customer_payments").insert(r).select().single();return n?(console.error(" Error creating payment:",n),{ok:!1,message:n.message}):{ok:!0,data:a}}catch(e){return console.error(" Unexpected error creating payment:",e),{ok:!1,message:e.message||"Failed to create payment"}}},getDeviceStatistics:async()=>{var s,e,t,r;try{const a=Me(),n=await Ge(a);let o=w.from("devices");const i=h=>{let g=o.select("id",{count:"exact"});return We("devices",n)&&a&&(g=g.eq("branch_id",a)),h&&(g=g.eq("status",h)),g},[c,l,d,u]=await Promise.all([i(),i("pending"),i("in-progress"),i("completed")]);return{ok:!0,data:{total:((s=c.data)==null?void 0:s.length)||0,pending:((e=l.data)==null?void 0:e.length)||0,inProgress:((t=d.data)==null?void 0:t.length)||0,completed:((r=u.data)==null?void 0:r.length)||0}}}catch(a){return console.error(" Error fetching device statistics:",a),{ok:!1,message:a.message||"Failed to fetch device statistics",data:{total:0,pending:0,inProgress:0,completed:0}}}},getTechnicians:async()=>{try{const s=Me(),e=await Ge(s);let t=w.from("users").select("*").in("role",["technician","tech","admin","manager"]).eq("is_active",!0).order("full_name");We("employees",e)&&s&&(t=t.eq("branch_id",s));const{data:r,error:a}=await t;return a?(console.error(" Error fetching technicians:",a),{ok:!1,message:a.message,data:[]}):{ok:!0,data:r||[]}}catch(s){return console.error(" Unexpected error fetching technicians:",s),{ok:!1,message:s.message||"Failed to fetch technicians",data:[]}}},getUsers:async s=>{try{const e=Me(),t=await Ge(e);let r=w.from("users").select("*").eq("is_active",!0).order("full_name");s!=null&&s.role&&(r=r.eq("role",s.role)),We("employees",t)&&e&&(r=r.eq("branch_id",e));const{data:a,error:n}=await r;return n?(console.error(" Error fetching users:",n),{ok:!1,message:n.message,data:[]}):{ok:!0,data:a||[]}}catch(e){return console.error(" Unexpected error fetching users:",e),{ok:!1,message:e.message||"Failed to fetch users",data:[]}}},createUser:async s=>{try{const e=Me(),t=await Ge(e),r={...s,branch_id:We("employees",t)?e||"00000000-0000-0000-0000-000000000001":null},{data:a,error:n}=await w.from("users").insert(r).select().single();return n?(console.error(" Error creating user:",n),{ok:!1,message:n.message}):{ok:!0,data:a}}catch(e){return console.error(" Unexpected error creating user:",e),{ok:!1,message:e.message||"Failed to create user"}}},updateUser:async(s,e)=>{try{const{data:t,error:r}=await w.from("users").update(e).eq("id",s).select().single();return r?(console.error(" Error updating user:",r),{ok:!1,message:r.message}):{ok:!0,data:t}}catch(t){return console.error(" Unexpected error updating user:",t),{ok:!1,message:t.message||"Failed to update user"}}},deleteUser:async s=>{try{const{error:e}=await w.from("users").update({is_active:!1}).eq("id",s);return e?(console.error(" Error deactivating user:",e),{ok:!1,message:e.message}):{ok:!0}}catch(e){return console.error(" Unexpected error deactivating user:",e),{ok:!1,message:e.message||"Failed to deactivate user"}}},getUserStatistics:async()=>{try{const s=Me(),e=await Ge(s);let t=w.from("users").select("id, role",{count:"exact"}).eq("is_active",!0);We("employees",e)&&s&&(t=t.eq("branch_id",s));const{data:r,error:a}=await t;return a?(console.error(" Error fetching user statistics:",a),{ok:!1,message:a.message,data:{total:0,technicians:0,admins:0,managers:0,customerCare:0}}):{ok:!0,data:{total:(r==null?void 0:r.length)||0,technicians:(r==null?void 0:r.filter(o=>o.role==="technician"||o.role==="tech").length)||0,admins:(r==null?void 0:r.filter(o=>o.role==="admin").length)||0,managers:(r==null?void 0:r.filter(o=>o.role==="manager").length)||0,customerCare:(r==null?void 0:r.filter(o=>o.role==="customer-care").length)||0}}}catch(s){return console.error(" Error fetching user statistics:",s),{ok:!1,message:s.message||"Failed to fetch user statistics",data:{total:0,technicians:0,admins:0,managers:0,customerCare:0}}}}},xe=()=>ol;class fb{constructor(){this.enableLogging=!1}track(e,t){this.enableLogging&&console.log(`[Analytics] ${e}:`,t)}async getInventoryStats(){try{const{data:e,error:t}=await w.rpc("get_inventory_stats");return t?(console.error("Error fetching inventory stats:",t),null):e}catch(e){return console.error("Error in getInventoryStats:",e),null}}async getSalesStats(){try{const{data:e,error:t}=await w.rpc("get_sales_stats");return t?(console.error("Error fetching sales stats:",t),null):e}catch(e){return console.error("Error in getSalesStats:",e),null}}async getTopProducts(e=5){try{const{data:t,error:r}=await w.from("lats_sale_items").select(`
          quantity,
          total_price,
          product_id
        `).order("total_price",{ascending:!1}).limit(e);return r?(console.error("Error fetching top products:",r),[]):(t==null?void 0:t.map(a=>{var n;return{name:`Product ${((n=a.product_id)==null?void 0:n.slice(0,8))||"Unknown"}`,revenue:parseFloat(a.total_price)||0,units:a.quantity||0,margin:0}}))||[]}catch(t){return console.error("Error in getTopProducts:",t),[]}}async getTopCustomers(e=5){try{const{data:t,error:r}=await w.from("lats_sales").select(`
          total_amount,
          created_at
        `).eq("status","completed").order("total_amount",{ascending:!1}).limit(e);return r?(console.error("Error fetching top customers:",r),[]):(t==null?void 0:t.map(a=>({name:"Customer",revenue:parseFloat(a.total_amount)||0,orders:1,avgOrder:parseFloat(a.total_amount)||0})))||[]}catch(t){return console.error("Error in getTopCustomers:",t),[]}}async getProductCategoryPerformance(){try{const{data:e,error:t}=await w.from("lats_sale_items").select(`
          quantity,
          total_price,
          product_id
        `);if(t)return console.error("Error fetching product category performance:",t),[];const r=new Map;return e==null||e.forEach(a=>{var i;const n=`Category ${((i=a.product_id)==null?void 0:i.slice(0,8))||"Unknown"}`,o=r.get(n)||{category:n,revenue:0,units:0,margin:0};o.revenue+=parseFloat(a.total_price)||0,o.units+=a.quantity||0,r.set(n,o)}),Array.from(r.values())}catch(e){return console.error("Error in getProductCategoryPerformance:",e),[]}}async getMonthlyRevenueTrend(e=6){try{const{data:t,error:r}=await w.from("lats_sales").select("total_amount, created_at").eq("status","completed").gte("created_at",new Date(Date.now()-e*30*24*60*60*1e3).toISOString()).order("created_at");if(r)return console.error("Error fetching monthly revenue trend:",r),[];const a=new Map,n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return t==null||t.forEach(o=>{const i=new Date(o.created_at),c=`${n[i.getMonth()]} ${i.getFullYear()}`,l=a.get(c)||0;a.set(c,l+parseFloat(o.total_amount))}),Array.from(a.entries()).map(([o,i])=>({month:o,value:i,target:i*1.1}))}catch(t){return console.error("Error in getMonthlyRevenueTrend:",t),[]}}async getCustomerSegments(){try{const{data:e,error:t}=await w.from("lats_sales").select("total_amount, customer_id").eq("status","completed");if(t)return console.error("Error fetching customer segments:",t),[];const r=new Map;e==null||e.forEach(i=>{const c=i.customer_id||"walk-in",l=r.get(c)||0;r.set(c,l+parseFloat(i.total_amount))});const a=Array.from(r.entries()).sort(([,i],[,c])=>c-i),n=a.reduce((i,[,c])=>i+c,0),o=[{segment:"VIP Customers",count:0,revenue:0,percentage:0},{segment:"Regular Customers",count:0,revenue:0,percentage:0},{segment:"Walk-in Customers",count:0,revenue:0,percentage:0}];return a.forEach(([i,c],l)=>{i==="walk-in"?(o[2].count++,o[2].revenue+=c):l<Math.ceil(a.length*.2)?(o[0].count++,o[0].revenue+=c):(o[1].count++,o[1].revenue+=c)}),o.forEach(i=>{i.percentage=n>0?i.revenue/n*100:0}),o}catch(e){return console.error("Error in getCustomerSegments:",e),[]}}async generateBusinessInsights(){const e=[];try{const t=await this.getInventoryStats(),r=await this.getSalesStats();t&&(t.low_stock_items>0&&e.push({type:"warning",title:"Low Stock Alert",description:`${t.low_stock_items} items are running low on stock`,impact:"medium"}),t.out_of_stock_items>0&&e.push({type:"negative",title:"Out of Stock Items",description:`${t.out_of_stock_items} items are completely out of stock`,impact:"high"})),r&&(r.this_month_revenue>r.average_sale*10&&e.push({type:"positive",title:"Strong Monthly Performance",description:`Revenue this month is ${(r.this_month_revenue/(r.average_sale*10)*100).toFixed(1)}% above average`,impact:"high"}),r.today_revenue>0&&e.push({type:"positive",title:"Today's Sales",description:`Generated ${r.today_revenue.toLocaleString()} TZS in sales today`,impact:"medium"})),e.length===0&&e.push({type:"info",title:"System Ready",description:"Analytics system is connected and ready to provide insights",impact:"low"})}catch(t){console.error("Error generating business insights:",t),e.push({type:"info",title:"Analytics Loading",description:"Business insights are being calculated",impact:"low"})}return e}async getComprehensiveAnalytics(){try{const[e,t,r,a,n,o,i,c]=await Promise.all([this.getInventoryStats(),this.getSalesStats(),this.getTopProducts(),this.getTopCustomers(),this.getProductCategoryPerformance(),this.getMonthlyRevenueTrend(),this.getCustomerSegments(),this.generateBusinessInsights()]),l=(t==null?void 0:t.total_revenue)||0,d=new Date;d.setMonth(d.getMonth()-1);const u=new Date;u.setMonth(u.getMonth()-1),u.setDate(u.getDate()+30);const{data:h}=await w.from("lats_sales").select("total_amount").gte("created_at",d.toISOString()).lt("created_at",u.toISOString()).eq("status","completed"),g=(h==null?void 0:h.reduce(($,M)=>{const L=typeof M.total_amount=="number"?M.total_amount:parseFloat(M.total_amount)||0;return $+L},0))||0,p=g>0?(l-g)/g*100:0,{data:m}=await w.from("lats_sales").select("id, total_amount").gte("created_at",new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString()).eq("status","completed");let _=0;if(m&&m.length>0){const $=m.map(L=>L.id),{data:M}=await w.from("lats_sale_items").select("id, quantity, total_price, product_id, variant_id, cost_price").in("sale_id",$);M==null||M.forEach(L=>{const B=L.cost_price||0,U=L.total_price||0,W=L.quantity||1;_+=U-B*W})}const b=g*.3,S=b>0?(_-b)/b*100:0,v=i.reduce(($,M)=>$+M.count,0),C=v*.9,T=C>0?(v-C)/C*100:0,x=(t==null?void 0:t.total_sales)||0,R=x*.9,k=R>0?(x-R)/R*100:0,P=x>0?l/x:0,O=P*.95,N=O>0?(P-O)/O*100:0;return{kpis:{revenue:{current:l,previous:g,growth:p},profit:{current:_,previous:b,growth:S},customers:{current:v,previous:C,growth:T},orders:{current:x,previous:R,growth:k},avgOrderValue:{current:P,previous:O,growth:N},conversionRate:{current:await this.calculateConversionRate(),previous:await this.calculateConversionRate(!0),growth:0}},trends:{revenue:o,customers:await this.calculateCustomerTrends()},segments:{customerSegments:i,productCategories:n,geographicData:await this.calculateGeographicData()},performance:{topProducts:r,topCustomers:a},insights:c}}catch(e){return console.error("Error getting comprehensive analytics:",e),{kpis:{revenue:{current:0,previous:0,growth:0},profit:{current:0,previous:0,growth:0},customers:{current:0,previous:0,growth:0},orders:{current:0,previous:0,growth:0},avgOrderValue:{current:0,previous:0,growth:0},conversionRate:{current:0,previous:0,growth:0}},trends:{revenue:[],customers:[]},segments:{customerSegments:[],productCategories:[],geographicData:[]},performance:{topProducts:[],topCustomers:[]},insights:[{type:"info",title:"Data Loading",description:"Analytics data is being loaded from the database",impact:"low"}]}}}async calculateConversionRate(e=!1){try{const t=e?{gte:this.getPreviousMonthStart(),lt:this.getCurrentMonthStart()}:{gte:this.getCurrentMonthStart()},{data:r}=await w.from("customers").select("id").gte("last_visit",t.gte).lt("last_visit",t.lt),{data:a}=await w.from("customers").select("id").gte("last_purchase_date",t.gte).lt("last_purchase_date",t.lt),n=(r==null?void 0:r.length)||0,o=(a==null?void 0:a.length)||0;return n>0?o/n*100:0}catch(t){return console.error("Error calculating conversion rate:",t),0}}async calculateCustomerTrends(){try{const e=[],t=this.getLast12Months();for(const r of t){const{data:a}=await w.from("customers").select("id").gte("created_at",r.start).lt("created_at",r.end),{data:n}=await w.from("customers").select("id").gte("last_visit",r.start).lt("last_visit",r.end).lt("created_at",r.start);e.push({month:r.name,new:(a==null?void 0:a.length)||0,returning:(n==null?void 0:n.length)||0})}return e}catch(e){return console.error("Error calculating customer trends:",e),[]}}async calculateGeographicData(){try{const{data:e}=await w.from("customers").select("city, total_spent"),t=new Map;return e==null||e.forEach(r=>{const a=r.city||"Unknown",n=t.get(a)||{customers:0,revenue:0};t.set(a,{customers:n.customers+1,revenue:n.revenue+(r.total_spent||0)})}),Array.from(t.entries()).map(([r,a])=>({location:r,customers:a.customers,revenue:a.revenue})).sort((r,a)=>a.customers-r.customers)}catch(e){return console.error("Error calculating geographic data:",e),[]}}getCurrentMonthStart(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),1).toISOString()}getPreviousMonthStart(){const e=new Date;return new Date(e.getFullYear(),e.getMonth()-1,1).toISOString()}getLast12Months(){const e=[],t=new Date;for(let r=11;r>=0;r--){const a=new Date(t.getFullYear(),t.getMonth()-r,1),n=a.toISOString(),o=new Date(a.getFullYear(),a.getMonth()+1,1).toISOString();e.push({name:a.toLocaleDateString("en-US",{month:"short",year:"numeric"}),start:n,end:o})}return e}}const fe=new fb;function gb(s="Image",e=300,t=300){const r=`
    <svg width="${e}" height="${t}" viewBox="0 0 ${e} ${t}" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="${e}" height="${t}" fill="#F3F4F6"/>
      <text x="${e/2}" y="${t/2}" font-family="Arial, sans-serif" font-size="16" fill="#6B6B6B" text-anchor="middle" dy=".3em">${s}</text>
    </svg>
  `;return`data:image/svg+xml;base64,${btoa(r)}`}function _b(s){return!s||typeof s!="string"?!0:["via.placeholder.com","placehold.it","placehold.co","dummyimage.com","picsum.photos","lorempixel.com","loremflickr.com"].some(t=>s.toLowerCase().includes(t))}function yb(s){return Array.isArray(s)?s.map(e=>_b(e)?gb("Product Image",400,400):e):[]}function bb(s){if(!Array.isArray(s)||s.length===0)return[];const e=performance.now(),t=s.map(a=>{if(!a||typeof a!="object")return a;const n={...a},{category_id:o,supplier_id:i,brand_id:c,branch_id:l,is_shared:d,is_active:u,storage_room_id:h,shelf_id:g,shelf_name:p,shelf_code:m,selling_price:_,cost_price:b,stock_quantity:S,min_stock_level:v,created_at:C,updated_at:T,...x}=n,R={...x,...o!==void 0&&{categoryId:o},...i!==void 0&&{supplierId:i},...c!==void 0&&{brandId:c},...l!==void 0&&{branchId:l},...u!==void 0&&{isActive:u},...h!==void 0&&{storageRoomId:h},...g!==void 0&&{shelfId:g},...p!==void 0&&{shelfName:p},...m!==void 0&&{shelfCode:m},..._!==void 0&&{price:_},...b!==void 0&&{costPrice:b},...S!==void 0&&{stockQuantity:S},...v!==void 0&&{minStockLevel:v},...C!==void 0&&{createdAt:C},...T!==void 0&&{updatedAt:T}};return R.images&&Array.isArray(R.images)&&(R.images=yb(Wy(R.images))),n.image_url&&(R.image_url=ft(n.image_url)),R.variants&&Array.isArray(R.variants)&&(R.variants=R.variants.map(k=>{if(!k||typeof k!="object")return k;const{product_id:P,variant_name:O,selling_price:N,cost_price:$,...M}=k;return{...M,...P!==void 0&&{productId:P},...O!==void 0&&{name:O},...N!==void 0&&{price:N,sellingPrice:N},...$!==void 0&&{costPrice:$}}})),R}),r=performance.now()-e;return r>50&&console.log(` Processed ${s.length} products in ${r.toFixed(2)}ms`),t}function wb(s){return Array.isArray(s)?s.map((e,t)=>{const r={...e};return r.parent_id!==void 0&&(r.parentId=r.parent_id,delete r.parent_id),r.is_active!==void 0&&(r.isActive=r.is_active,delete r.is_active),r.sort_order!==void 0&&(r.sortOrder=r.sort_order,delete r.sort_order),r.created_at!==void 0&&(r.createdAt=r.created_at,delete r.created_at),r.updated_at!==void 0&&(r.updatedAt=r.updated_at,delete r.updated_at),r.image_url&&(r.image_url=ft(r.image_url)),r}):[]}function vb(s){return Array.isArray(s)?s.map(e=>{const t={...e};return t.logo_url&&(t.logo_url=ft(t.logo_url)),t}):[]}function yo(s){return wb(s||[])}function Sb(s){return bb(s||[])}function Eb(s){return vb(s||[])}function sa(s,e){if(!s)return console.warn(` ${e}: No data provided`),!1;if(!Array.isArray(s))return console.warn(` ${e}: Data is not an array`),!1;let t=!1,r=0;return s.forEach((a,n)=>{a&&typeof a=="object"&&Object.entries(a).forEach(([o,i])=>{typeof i=="string"&&i.length>2e3&&(console.debug(` ${e}[${n}].${o}: Long URL detected (${i.length} chars) - applying cleanup`),t=!0,(o.includes("image")||o.includes("url")||o.includes("logo"))&&(a[o]=ft(i),r++))})}),t&&console.info(` ${e}: Cleaned up ${r} long URL(s) to prevent HTTP 431 errors`),!0}const ts="1.0",bo=30*60*1e3,_n=class xt{saveProducts(e){try{const t={data:e,timestamp:Date.now(),version:ts};localStorage.setItem(xt.PRODUCTS_KEY,JSON.stringify(t))}catch(t){console.warn(" [Cache] Failed to save products:",t)}}getProducts(){try{const e=localStorage.getItem(xt.PRODUCTS_KEY);if(!e)return null;const t=JSON.parse(e);return t.version!==ts?(console.log(" [Cache] Cache version mismatch, clearing old cache"),this.clearProducts(),null):Date.now()-t.timestamp>bo?(this.clearProducts(),null):t.data}catch(e){return console.warn(" [Cache] Failed to read products cache:",e),null}}saveCategories(e){try{const t={data:e,timestamp:Date.now(),version:ts};localStorage.setItem(xt.CATEGORIES_KEY,JSON.stringify(t))}catch(t){console.warn(" [Cache] Failed to save categories:",t)}}getCategories(){try{const e=localStorage.getItem(xt.CATEGORIES_KEY);if(!e)return null;const t=JSON.parse(e);return t.version!==ts?(this.clearCategories(),null):Date.now()-t.timestamp>bo?(this.clearCategories(),null):t.data}catch(e){return console.warn(" [Cache] Failed to read categories cache:",e),null}}clearProducts(){localStorage.removeItem(xt.PRODUCTS_KEY)}clearCategories(){localStorage.removeItem(xt.CATEGORIES_KEY)}clearAll(){this.clearProducts(),this.clearCategories()}clearCache(){this.clearAll()}};_n.PRODUCTS_KEY="pos_products_cache";_n.CATEGORIES_KEY="pos_categories_cache";let xb=_n;const pt=new xb,gS=Object.freeze(Object.defineProperty({__proto__:null,productCacheService:pt},Symbol.toStringTag,{value:"Module"}));class Kt{constructor(){this.cache=null,this.CACHE_DURATION=5*60*1e3,this.loadingPromise=null}static getInstance(){return Kt.instance||(Kt.instance=new Kt),Kt.instance}isCacheValid(){return this.cache?Date.now()<this.cache.expiresAt:!1}clearCache(){this.cache=null}async getCategories(e=!1){if(!e&&this.isCacheValid())return this.cache.data;if(this.loadingPromise)return this.loadingPromise;this.loadingPromise=this.fetchCategoriesFromDatabase();try{return await this.loadingPromise}finally{this.loadingPromise=null}}async fetchCategoriesFromDatabase(){const e=performance.now();try{const t=w.from("lats_categories").select("*").order("name");console.log(" [CategoryService] Executing categories query with proper syntax");const{data:r,error:a}=await t;if(a)throw console.error(" Categories fetch error:",a),console.error(" Error details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;const n=r||[],o=performance.now();return console.log(` [CategoryService] Categories fetched successfully in ${(o-e).toFixed(2)}ms, count: ${n.length}`),this.cache={data:n,timestamp:Date.now(),expiresAt:Date.now()+this.CACHE_DURATION},n}catch(t){throw console.error(" Categories fetch exception:",t),t}}async getActiveCategories(e=!1){return(await this.getCategories(e)).filter(r=>r.isActive!==!1&&r.is_active!==!1)}async getActiveCategoriesExcludingSpare(e=!1){const t=await this.getCategories(e),r=["spare","parts","repair","replacement","component"],a=["screen replacement","battery replacement","charging port","logic board","motherboard","circuit board","flex cable","ribbon cable","charging cable","home button","power button","volume button","camera module","speaker module","microphone module","antenna module","vibration motor","charging dock","connector port","headphone jack","sim tray","battery connector"];return t.filter(o=>{if(o.isActive===!1||o.is_active===!1)return!1;const i=o.name.toLowerCase(),c=(o.description||"").toLowerCase(),l=r.some(h=>i.includes(h)||c.includes(h)),d=a.some(h=>i.includes(h)||c.includes(h)),u=i.includes("spare")||i.includes(" part")||i.includes("parts")||i.includes("component")&&!i.includes("software");return!(l||d||u)})}async getSparePartCategories(e=!1){const t=await this.getCategories(e),r=["spare","parts","components","accessories","repair","replacement","screen","battery","charger","cable","adapter","connector","button","speaker","microphone","camera","lens","antenna","circuit","board","chip","processor","memory","storage","keyboard","touchpad","hinge","case","cover","protector"];return t.filter(n=>{if(n.isActive===!1||n.is_active===!1)return!1;const o=n.name.toLowerCase(),i=(n.description||"").toLowerCase(),c=r.some(u=>o.includes(u)||i.includes(u)),l=n.parentId&&n.parentId.trim()!=="",d=o.includes("spare")||o.includes("part")||o.includes("component")||o.includes("accessory");return c||l||d})}async getCategoryById(e,t=!1){return(await this.getCategories(t)).find(a=>a.id===e)||null}async searchCategories(e,t=!1){const r=await this.getCategories(t),a=e.toLowerCase();return r.filter(n=>n.name.toLowerCase().includes(a)||n.description&&n.description.toLowerCase().includes(a))}invalidateCache(){this.clearCache()}async forceRefresh(){return this.clearCache(),await this.getCategories(!0)}async getCategoriesForProducts(e,t=!1){return e.length===0?[]:await this.getCategories(t)}async getCategoryStats(e=!1){const t=await this.getCategories(e),r=t.filter(o=>o.is_active!==!1).length,a=t.filter(o=>o.description&&o.description.trim()).length,n=new Set(t.map(o=>o.color).filter(Boolean)).size;return{total:t.length,active:r,inactive:t.length-r,withDescription:a,uniqueColors:n}}}const vr=Kt.getInstance(),js=s=>{console.log(" [DEBUG] ===== CONVERT FORM DATA START ====="),console.log(" [DEBUG] Input formData:",s),console.log(" [DEBUG] Input formData type:",typeof s),console.log(" [DEBUG] Input formData keys:",Object.keys(s||{}));const e={name:s.name,part_number:s.partNumber,category_id:s.categoryId,brand:s.brand,supplier_id:s.supplierId,condition:s.condition||"new",description:s.description,cost_price:s.costPrice,selling_price:s.sellingPrice,quantity:s.quantity,min_quantity:s.minQuantity,location:s.location,compatible_devices:s.compatibleDevices};if(s.storageRoomId&&(e.storage_room_id=s.storageRoomId),s.shelfId&&(e.shelf_id=s.shelfId),s.images){const t=s.images.map(r=>r.image_url||r.url).filter(Boolean);e.images=t}return s.partType&&(e.part_type=s.partType),s.primaryDeviceType&&(e.primary_device_type=s.primaryDeviceType),s.searchTags&&(e.search_tags=s.searchTags),console.log(" [DEBUG] Converted data:",e),console.log(" [DEBUG] Converted data keys:",Object.keys(e)),console.log(" [DEBUG] ===== CONVERT FORM DATA END ====="),e},il=async(s,e,t)=>{try{console.log(" [DEBUG] Saving spare part images to database:",{sparePartId:s,imageCount:e.length,userId:t});const r=e.map((o,i)=>({spare_part_id:s,image_url:o.image_url||o.url,thumbnail_url:o.thumbnail_url||o.thumbnailUrl||o.image_url||o.url,file_name:o.file_name||o.fileName||`spare-part-image-${i+1}`,file_size:o.file_size||o.fileSize||0,mime_type:o.mime_type||o.mimeType||"image/jpeg",is_primary:o.is_primary||o.isPrimary||i===0,uploaded_by:t}));console.log(" [DEBUG] Prepared image data:",r);const{data:a,error:n}=await w.from("spare_part_images").insert(r).select();if(n){if(console.error(" [DEBUG] Error saving images to spare_part_images:",n),n.code==="42501"){console.log(" [DEBUG] RLS error detected, trying product_images table...");const o=e.map((l,d)=>({product_id:s,image_url:l.image_url||l.url,thumbnail_url:l.thumbnail_url||l.thumbnailUrl||l.image_url||l.url,file_name:l.file_name||l.fileName||`spare-part-image-${d+1}`,file_size:l.file_size||l.fileSize||0,mime_type:l.mime_type||l.mimeType||"image/jpeg",is_primary:l.is_primary||l.isPrimary||d===0,uploaded_by:t})),{data:i,error:c}=await w.from("product_images").insert(o).select();if(c)throw console.error(" [DEBUG] Error saving images to product_images:",c),c;console.log(" [DEBUG] Images saved to product_images successfully:",i);return}throw n}console.log(" [DEBUG] Images saved to spare_part_images successfully:",a)}catch(r){throw console.error(" [DEBUG] Failed to save images to database:",r),r}},Pb=async s=>{try{console.log(" [DEBUG] Getting spare part images from database:",s);const{data:e,error:t}=await w.from("spare_part_images").select("*").eq("spare_part_id",s).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(!t&&e&&e.length>0)return console.log(" [DEBUG] Retrieved spare part images from spare_part_images:",e),e;console.log(" [DEBUG] No images in spare_part_images, trying product_images...");const{data:r,error:a}=await w.from("product_images").select("*").eq("product_id",s).order("is_primary",{ascending:!1}).order("created_at",{ascending:!0});if(!a&&r&&r.length>0)return console.log(" [DEBUG] Retrieved spare part images from product_images:",r),r;console.log(" [DEBUG] No images in image tables, checking main spare part record...");const{data:n,error:o}=await w.from("lats_spare_parts").select("images").eq("id",s).single();if(o)return console.error(" [DEBUG] Error getting spare part record:",o),[];if(n!=null&&n.images&&Array.isArray(n.images)&&n.images.length>0){const i=n.images.map((c,l)=>({id:`main-record-${l}`,spare_part_id:s,image_url:c,thumbnail_url:c,file_name:`image-${l+1}.jpg`,file_size:0,mime_type:"image/jpeg",is_primary:l===0,uploaded_by:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}));return console.log(" [DEBUG] Retrieved spare part images from main record:",i),i}return console.log(" [DEBUG] No images found in any location"),[]}catch(e){return console.error(" [DEBUG] Failed to get spare part images:",e),[]}},Ab=async(s={},e={field:"created_at",direction:"desc"},t=1,r=20)=>{var a;try{let n=w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name),
        variants:lats_spare_part_variants!spare_part_id(*)
      `);if(s.category_id&&(n=n.eq("category_id",s.category_id)),s.supplier_id&&(n=n.eq("supplier_id",s.supplier_id)),s.condition&&(n=n.eq("condition",s.condition)),s.brand&&(n=n.ilike("brand",`%${s.brand}%`)),s.is_active!==void 0&&(n=n.eq("is_active",s.is_active)),s.low_stock&&(n=n.lte("quantity",w.raw("min_quantity"))),s.out_of_stock&&(n=n.eq("quantity",0)),s.search){const{data:u,error:h}=await w.rpc("search_spare_parts_fn",{search_query:s.search,page_number:t,page_size:r});if(h)throw console.error("Error searching spare parts:",h),h;if(!u||u.length===0)return{data:[],message:"No spare parts found",ok:!0,total:0,page:t,limit:r};const g=((a=u[0])==null?void 0:a.total_count)||0,p=u.map(b=>b.id);n=n.in("id",p);const{data:m,error:_}=await n;if(_)throw _;return{data:m||[],message:"Spare parts retrieved successfully",ok:!0,total:g,page:t,limit:r}}n=n.order(e.field,{ascending:e.direction==="asc"});const o=(t-1)*r,i=o+r-1;n=n.range(o,i);const{data:c,error:l,count:d}=await n;if(l)throw l;return{data:c||[],message:"Spare parts retrieved successfully",ok:!0,total:d||0,page:t,limit:r}}catch(n){return console.error("Error fetching spare parts:",n),{data:[],message:n instanceof Error?n.message:"Failed to fetch spare parts",ok:!1,total:0,page:t,limit:r}}},kb=async()=>{try{const{data:s,error:e}=await w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name),
        variants:lats_spare_part_variants!spare_part_id(*)
      `).eq("is_active",!0).order("name",{ascending:!0});if(e)throw e;return{success:!0,data:s||[],message:"Spare parts retrieved successfully"}}catch(s){return console.error("Error fetching all spare parts:",s),{success:!1,data:null,message:s instanceof Error?s.message:"Failed to fetch spare parts"}}},Ib=async s=>{try{const{data:e,error:t}=await w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name),
        variants:lats_spare_part_variants!spare_part_id(*)
      `).eq("id",s).single();if(t)throw t;return{data:e,message:"Spare part retrieved successfully",ok:!0}}catch(e){return console.error("Error fetching spare part:",e),{data:null,message:e instanceof Error?e.message:"Failed to fetch spare part",ok:!1}}},yn=async s=>{var e,t;try{console.log(" [DEBUG] ===== CREATE SPARE PART API START ====="),console.log(" [DEBUG] Input sparePartData:",s),console.log(" [DEBUG] Input sparePartData type:",typeof s),console.log(" [DEBUG] Input sparePartData keys:",Object.keys(s||{}));const{data:{user:r}}=await w.auth.getUser();console.log(" [DEBUG] Current user:",r==null?void 0:r.id);const a=s.useVariants||!1,n=s.variants||[];console.log(" [DEBUG] Use variants:",a),console.log(" [DEBUG] Variants count:",n.length);const o=js(s);if(console.log(" [DEBUG] Converted databaseData:",o),console.log(" [DEBUG] DatabaseData keys:",Object.keys(o||{})),o.part_number){console.log(" [DEBUG] Checking for duplicate part number:",o.part_number);const{data:h,error:g}=await w.from("lats_spare_parts").select("id, name, part_number").eq("part_number",o.part_number).maybeSingle();if(g)throw console.error(" [DEBUG] Error checking for duplicate part number:",g),g;if(h)return console.log(" [DEBUG] Duplicate part number found:",h),{data:h,message:`DUPLICATE_PART_NUMBER: A spare part with part number "${o.part_number}" already exists (ID: ${h.id}, Name: "${h.name}"). Please use a different part number or update the existing part instead.`,ok:!1,errorType:"DUPLICATE_PART_NUMBER",existingPart:h};console.log(" [DEBUG] Part number is unique, proceeding with creation")}let i=0,c=0;a&&n.length>0?(i=n.reduce((h,g)=>h+(g.quantity||0),0),c=n.reduce((h,g)=>h+(g.quantity||0)*(g.selling_price||0),0)):(i=o.quantity||0,c=(o.quantity||0)*(o.selling_price||0));const l={...o,quantity:a?0:o.quantity,cost_price:a?0:o.cost_price,selling_price:a?0:o.selling_price,min_quantity:a?0:o.min_quantity,metadata:{useVariants:a,variantCount:a?n.length:0,totalQuantity:i,totalValue:c},created_by:r==null?void 0:r.id,updated_by:r==null?void 0:r.id};console.log(" [DEBUG] Final insert data:",l),console.log(" [DEBUG] Insert data keys:",Object.keys(l)),console.log(" [DEBUG] Executing Supabase insert...");const{data:d,error:u}=await w.from("lats_spare_parts").insert(l).select().single();if(console.log(" [DEBUG] Supabase response data:",d),console.log(" [DEBUG] Supabase response error:",u),u){if(console.error(" [DEBUG] Supabase error:",u),u.code==="23505"){const h=u.constraint||"unknown constraint";let g="field";return h.includes("part_number")?g="part number":h.includes("name")&&(g="name"),{data:null,message:`DUPLICATE_ERROR: A spare part with this ${g} already exists. Please use a different ${g}.`,ok:!1,errorType:"DUPLICATE_CONSTRAINT",constraint:h}}else{if(u.code==="23503")return{data:null,message:"FOREIGN_KEY_ERROR: The selected category or supplier does not exist. Please select valid options.",ok:!1,errorType:"FOREIGN_KEY_VIOLATION"};if(u.code==="23514")return{data:null,message:"VALIDATION_ERROR: Invalid data provided. Please check that condition is set to 'new', 'used', or 'refurbished'.",ok:!1,errorType:"CHECK_CONSTRAINT_VIOLATION"}}return{data:null,message:`DATABASE_ERROR: ${u.message||"Unknown database error occurred"}`,ok:!1,errorType:"DATABASE_ERROR",originalError:u}}if(console.log(" [DEBUG] Spare part created successfully:",d),s.images&&s.images.length>0&&(console.log(" [DEBUG] Saving images to product_images table..."),await il(d.id,s.images,r==null?void 0:r.id)),a&&n.length>0&&d){console.log(" [DEBUG] Creating variants for spare part:",d.id);const h=n.map(m=>({spare_part_id:d.id,name:m.name,sku:m.sku,cost_price:m.cost_price,selling_price:m.selling_price,quantity:m.quantity,min_quantity:m.min_quantity,variant_attributes:m.attributes||{},image_url:m.image_url||null,created_by:r==null?void 0:r.id,updated_by:r==null?void 0:r.id}));console.log(" [DEBUG] Variant data to insert:",h);const{data:g,error:p}=await w.from("lats_spare_part_variants").insert(h).select();p?console.error(" [DEBUG] Error creating variants:",p):console.log(" [DEBUG] Variants created successfully:",g)}return console.log(" [DEBUG] ===== CREATE SPARE PART API END ====="),{data:d,message:"Spare part created successfully",ok:!0}}catch(r){console.error(" [DEBUG] ===== CREATE SPARE PART API ERROR ====="),console.error(" [DEBUG] Error creating spare part:",r),console.error(" [DEBUG] Error message:",r==null?void 0:r.message),console.error(" [DEBUG] Error details:",r==null?void 0:r.details),console.error(" [DEBUG] Error hint:",r==null?void 0:r.hint),console.error(" [DEBUG] Error code:",r==null?void 0:r.code),r!=null&&r.response&&console.error(" [DEBUG] Error response:",r.response);let a="Failed to create spare part";return(r==null?void 0:r.code)==="23505"?(e=r==null?void 0:r.message)!=null&&e.includes("part_number")?a="A spare part with this part number already exists. Please use a different part number.":(t=r==null?void 0:r.message)!=null&&t.includes("name")?a="A spare part with this name already exists. Please use a different name.":a="A spare part with this information already exists. Please check for duplicates.":(r==null?void 0:r.code)==="23503"?a="Invalid reference. Please check that the category, supplier, or other referenced data exists.":(r==null?void 0:r.code)==="23514"?a="Invalid data provided. Please check all required fields and constraints.":r instanceof Error&&(a=r.message),{data:null,message:a,ok:!1}}},Cb=async(s,e)=>{try{console.log(" [DEBUG] ===== UPDATE SPARE PART API START ====="),console.log(" [DEBUG] Update ID:",s),console.log(" [DEBUG] Input sparePartData:",e),console.log(" [DEBUG] Input sparePartData type:",typeof e),console.log(" [DEBUG] Input sparePartData keys:",Object.keys(e||{}));const{data:{user:t}}=await w.auth.getUser();console.log(" [DEBUG] Current user:",t==null?void 0:t.id);const r=js(e);console.log(" [DEBUG] Converted databaseData:",r),console.log(" [DEBUG] DatabaseData keys:",Object.keys(r||{}));const a={...r,updated_by:t==null?void 0:t.id};console.log(" [DEBUG] Final update data:",a),console.log(" [DEBUG] Update data keys:",Object.keys(a)),console.log(" [DEBUG] Executing Supabase update...");const{data:n,error:o}=await w.from("lats_spare_parts").update(a).eq("id",s).select().single();if(console.log(" [DEBUG] Supabase response data:",n),console.log(" [DEBUG] Supabase response error:",o),o)throw console.error(" [DEBUG] Supabase error:",o),o;return console.log(" [DEBUG] Spare part updated successfully:",n),console.log(" [DEBUG] ===== UPDATE SPARE PART API END ====="),{data:n,message:"Spare part updated successfully",ok:!0}}catch(t){return console.error(" [DEBUG] ===== UPDATE SPARE PART API ERROR ====="),console.error(" [DEBUG] Error updating spare part:",t),console.error(" [DEBUG] Error message:",t==null?void 0:t.message),console.error(" [DEBUG] Error details:",t==null?void 0:t.details),console.error(" [DEBUG] Error hint:",t==null?void 0:t.hint),console.error(" [DEBUG] Error code:",t==null?void 0:t.code),t!=null&&t.response&&console.error(" [DEBUG] Error response:",t.response),{data:null,message:t instanceof Error?t.message:"Failed to update spare part",ok:!1}}},cl=async s=>{try{const{error:e}=await w.from("lats_spare_parts").delete().eq("id",s);if(e)throw e;return{message:"Spare part deleted successfully",ok:!0}}catch(e){return console.error("Error deleting spare part:",e),{message:e instanceof Error?e.message:"Failed to delete spare part",ok:!1}}},Db=async(s,e=1,t=20)=>{try{const r=(e-1)*t,a=r+t-1,{data:n,error:o,count:i}=await w.from("lats_spare_part_usage").select(`
        *,
        spare_part:lats_spare_parts(name, part_number)
      `).eq("spare_part_id",s).order("created_at",{ascending:!1}).range(r,a);if(o)throw o;return{data:n||[],message:"Usage history retrieved successfully",ok:!0,total:i||0,page:e,limit:t}}catch(r){return console.error("Error fetching spare part usage:",r),{data:[],message:r instanceof Error?r.message:"Failed to fetch usage history",ok:!1,total:0,page:e,limit:t}}},ll=async s=>{try{const{data:{user:e}}=await w.auth.getUser(),{data:t,error:r}=await w.from("lats_spare_part_usage").insert({...s,used_by:e==null?void 0:e.id}).select().single();if(r)throw r;const{error:a}=await w.from("lats_spare_parts").update({quantity:w.raw(`quantity - ${s.quantity_used}`),updated_by:e==null?void 0:e.id}).eq("id",s.spare_part_id);if(a)throw a;return{data:t,message:"Usage recorded successfully",ok:!0}}catch(e){return console.error("Error recording spare part usage:",e),{data:null,message:e instanceof Error?e.message:"Failed to record usage",ok:!1}}},Tb=async()=>{try{const{count:s}=await w.from("lats_spare_parts").select("id",{count:"exact",head:!0}),{data:e}=await w.from("lats_spare_parts").select("cost_price, quantity"),t=(e==null?void 0:e.reduce((i,c)=>i+c.cost_price*c.quantity,0))||0,{count:r}=await w.from("lats_spare_parts").select("id",{count:"exact",head:!0}).lte("quantity",w.raw("min_quantity")).gt("quantity",0),{count:a}=await w.from("lats_spare_parts").select("id",{count:"exact",head:!0}).eq("quantity",0),{count:n}=await w.from("lats_spare_parts").select("category_id",{count:"exact",head:!0}).not("category_id","is",null),{count:o}=await w.from("lats_spare_parts").select("supplier_id",{count:"exact",head:!0}).not("supplier_id","is",null);return{total_spare_parts:s||0,total_value:t,low_stock_count:r||0,out_of_stock_count:a||0,categories_count:n||0,suppliers_count:o||0}}catch(s){return console.error("Error fetching spare part stats:",s),{total_spare_parts:0,total_value:0,low_stock_count:0,out_of_stock_count:0,categories_count:0,suppliers_count:0}}},ul=async s=>{try{const{data:e,error:t}=await w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name)
      `).eq("part_number",s).maybeSingle();if(t)throw t;return e?{data:e,message:"Spare part found successfully",ok:!0}:{data:null,message:"No spare part found with this part number",ok:!1}}catch(e){return console.error("Error finding spare part by part number:",e),{data:null,message:e instanceof Error?e.message:"Failed to find spare part",ok:!1}}},dl=async s=>{try{console.log(" [DEBUG] ===== CREATE OR UPDATE SPARE PART API START ====="),console.log(" [DEBUG] Input sparePartData:",s);const{data:{user:e}}=await w.auth.getUser(),t=js(s);if(t.part_number){const a=await ul(t.part_number);if(a.ok&&a.data){console.log(" [DEBUG] Found existing part, updating instead of creating:",a.data.id);const n=await bn(a.data.id,s);return n.ok?{...n,message:`UPDATED_EXISTING: Spare part "${t.part_number}" was updated successfully. A spare part with this part number already existed (ID: ${a.data.id}, Previous Name: "${a.data.name}").`,operationType:"UPDATE_EXISTING",previousData:a.data}:{...n,message:`UPDATE_FAILED: Failed to update existing spare part "${t.part_number}" (ID: ${a.data.id}). ${n.message}`,operationType:"UPDATE_FAILED",existingPart:a.data}}}console.log(" [DEBUG] No existing part found, creating new one");const r=await yn(s);return r.ok?{...r,message:`CREATED_NEW: Spare part "${t.part_number}" was created successfully as a new record.`,operationType:"CREATE_NEW"}:{...r,message:`CREATE_FAILED: Failed to create new spare part "${t.part_number}". ${r.message}`,operationType:"CREATE_FAILED"}}catch(e){return console.error(" [DEBUG] Error in create or update spare part:",e),{data:null,message:e instanceof Error?e.message:"Failed to create or update spare part",ok:!1}}},Rb=async(s,e)=>{try{let t=w.from("lats_spare_parts").select("id, name, part_number").eq("part_number",s);e&&(t=t.neq("id",e));const{data:r,error:a}=await t.maybeSingle();if(a)throw a;return r?{exists:!0,message:`Part number "${s}" is already used by "${r.name}"`}:{exists:!1,message:"Part number is available"}}catch(t){return console.error("Error checking part number:",t),{exists:!1,message:"Unable to verify part number availability"}}},Ob=async s=>{try{const{data:e,error:t}=await w.rpc("search_spare_parts_fn",{search_query:s,page_number:1,page_size:10});if(t)throw console.error("Error searching spare parts via RPC:",t),t;if(!e||e.length===0)return[];const r=e.map(o=>o.id),{data:a,error:n}=await w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name),
        variants:lats_spare_part_variants!spare_part_id(*)
      `).in("id",r).eq("is_active",!0).order("name",{ascending:!0});if(n)throw n;return a||[]}catch(e){return console.error("Error searching spare parts:",e),[]}},Nb=async s=>{try{console.log(" [DEBUG] Searching spare parts with variants:",s);const{data:e,error:t}=await w.from("lats_spare_parts").select(`
        *,
        category:lats_categories!category_id(name),
        variants:lats_spare_part_variants!spare_part_id(*)
      `).or(`part_number.ilike.%${s}%,name.ilike.%${s}%,description.ilike.%${s}%`).eq("is_active",!0);t&&console.error("Error searching main spare parts:",t);const{data:r,error:a}=await w.from("lats_spare_part_variants").select(`
        *,
        spare_part:lats_spare_parts(
          *,
          category:lats_categories!category_id(name)
        )
      `).or(`name.ilike.%${s}%,sku.ilike.%${s}%`).eq("spare_part.is_active",!0);a&&console.error("Error searching variants:",a);const n=new Map;(e||[]).forEach(i=>{n.set(i.id,i)}),(r||[]).forEach(i=>{if(i.spare_part){const c=i.spare_part;if(n.has(c.id)){const l=n.get(c.id);l.variants||(l.variants=[]),l.variants.some(u=>u.id===i.id)||l.variants.push(i)}else c.variants=[i],n.set(c.id,c)}});const o=Array.from(n.values()).sort((i,c)=>i.name.localeCompare(c.name)).slice(0,20);return console.log(" [DEBUG] Search results count:",o.length),o}catch(e){return console.error("Error searching spare parts with variants:",e),[]}},hl=async s=>{try{console.log(" [DEBUG] Searching variants by attributes:",s);const{data:e,error:t}=await w.from("lats_spare_part_variants").select(`
        *,
        spare_part:lats_spare_parts(
          *,
          category:lats_categories!category_id(name)
        )
      `).eq("spare_part.is_active",!0);if(t)throw t;const r=(e||[]).filter(a=>{if(!a.variant_attributes)return!1;const n=a.variant_attributes,o=s.toLowerCase();return Object.entries(n).some(([i,c])=>i.toLowerCase().includes(o)||String(c).toLowerCase().includes(o))});return console.log(" [DEBUG] Found variants with matching attributes:",r.length),r}catch(e){return console.error("Error searching variants by attributes:",e),[]}},Lb=async s=>{try{const{data:{user:e}}=await w.auth.getUser();for(const t of s){const{error:r}=await w.from("lats_spare_parts").update({quantity:t.quantity,updated_by:e==null?void 0:e.id}).eq("id",t.id);if(r)throw r}return{message:"Quantities updated successfully",ok:!0}}catch(e){return console.error("Error bulk updating quantities:",e),{message:e instanceof Error?e.message:"Failed to update quantities",ok:!1}}},Ub=async s=>{try{const{data:e,error:t}=await w.from("lats_spare_part_variants").select("*").eq("spare_part_id",s).order("created_at",{ascending:!0});if(t)throw t;return e||[]}catch(e){return console.error("Error fetching spare part variants:",e),[]}},jb=async s=>{try{const{data:{user:e}}=await w.auth.getUser(),t={...s,created_by:e==null?void 0:e.id,updated_by:e==null?void 0:e.id},{data:r,error:a}=await w.from("lats_spare_part_variants").insert(t).select().single();if(a)throw a;return{data:r,message:"Variant created successfully",ok:!0}}catch(e){return console.error("Error creating spare part variant:",e),{data:null,message:e instanceof Error?e.message:"Failed to create variant",ok:!1}}},$b=async(s,e)=>{try{const{data:{user:t}}=await w.auth.getUser(),r={...e,updated_by:t==null?void 0:t.id},{data:a,error:n}=await w.from("lats_spare_part_variants").update(r).eq("id",s).select().single();if(n)throw n;return{data:a,message:"Variant updated successfully",ok:!0}}catch(t){return console.error("Error updating spare part variant:",t),{data:null,message:t instanceof Error?t.message:"Failed to update variant",ok:!1}}},Mb=async s=>{try{const{error:e}=await w.from("lats_spare_part_variants").delete().eq("id",s);if(e)throw e;return{message:"Variant deleted successfully",ok:!0}}catch(e){return console.error("Error deleting spare part variant:",e),{message:e instanceof Error?e.message:"Failed to delete variant",ok:!1}}},qb=async s=>{try{const{data:{user:e}}=await w.auth.getUser(),t=s.map(n=>({...n,created_by:e==null?void 0:e.id,updated_by:e==null?void 0:e.id})),{data:r,error:a}=await w.from("lats_spare_part_variants").insert(t).select();if(a)throw a;return{data:r||[],message:"Variants created successfully",ok:!0}}catch(e){return console.error("Error bulk creating spare part variants:",e),{data:null,message:e instanceof Error?e.message:"Failed to create variants",ok:!1}}},Bb=async s=>{try{console.log(" [DEBUG] Getting variants with filters:",s);let e=w.from("lats_spare_part_variants").select(`
        *,
        spare_part:lats_spare_parts(
          *,
          category:lats_categories!category_id(name)
        )
      `,{count:"exact"});s.sparePartId&&(e=e.eq("spare_part_id",s.sparePartId)),s.searchTerm&&(e=e.or(`name.ilike.%${s.searchTerm}%,sku.ilike.%${s.searchTerm}%`)),s.minPrice!==void 0&&(e=e.gte("selling_price",s.minPrice)),s.maxPrice!==void 0&&(e=e.lte("selling_price",s.maxPrice)),s.inStock!==void 0&&(s.inStock?e=e.gt("quantity",0):e=e.eq("quantity",0));const t=s.limit||20,r=s.offset||0;e=e.range(r,r+t-1),e=e.order("created_at",{ascending:!1});const{data:a,error:n,count:o}=await e;if(n)throw n;let i=a||[];return s.attributes&&Object.keys(s.attributes).length>0&&(i=i.filter(c=>c.variant_attributes?Object.entries(s.attributes).every(([l,d])=>{const u=c.variant_attributes[l];return typeof d=="string"?String(u).toLowerCase().includes(d.toLowerCase()):u===d}):!1)),console.log(" [DEBUG] Found variants:",i.length),{data:i,total:o||0,message:"Variants retrieved successfully",ok:!0}}catch(e){return console.error("Error getting variants with filters:",e),{data:[],total:0,message:e instanceof Error?e.message:"Failed to get variants",ok:!1}}},Fb=async s=>{try{let e=w.from("lats_spare_part_variants").select("selling_price, quantity, min_quantity");s&&(e=e.eq("spare_part_id",s));const{data:t,error:r}=await e;if(r)throw r;const a=t||[],n=a.length;if(n===0)return{totalVariants:0,totalValue:0,inStockVariants:0,outOfStockVariants:0,lowStockVariants:0,averagePrice:0,priceRange:{min:0,max:0}};const o=a.reduce((g,p)=>g+p.selling_price*p.quantity,0),i=a.filter(g=>g.quantity>0).length,c=a.filter(g=>g.quantity===0).length,l=a.filter(g=>g.quantity>0&&g.quantity<=g.min_quantity).length,d=a.map(g=>g.selling_price).filter(g=>g>0),u=d.length>0?d.reduce((g,p)=>g+p,0)/d.length:0,h=d.length>0?{min:Math.min(...d),max:Math.max(...d)}:{min:0,max:0};return{totalVariants:n,totalValue:o,inStockVariants:i,outOfStockVariants:c,lowStockVariants:l,averagePrice:u,priceRange:h}}catch(e){return console.error("Error getting variant stats:",e),{totalVariants:0,totalValue:0,inStockVariants:0,outOfStockVariants:0,lowStockVariants:0,averagePrice:0,priceRange:{min:0,max:0}}}},zb=async s=>{try{console.log(" [DEBUG] Comprehensive variant search:",s);const{data:e,error:t}=await w.from("lats_spare_part_variants").select(`
        *,
        spare_part:lats_spare_parts(
          *,
          category:lats_categories!category_id(name)
        )
      `).or(`name.ilike.%${s}%,sku.ilike.%${s}%`);t&&console.error("Error searching by name/SKU:",t);const r=await hl(s),{data:a,error:n}=await w.from("lats_spare_part_variants").select(`
        *,
        spare_part:lats_spare_parts(
          *,
          category:lats_categories!category_id(name)
        )
      `).ilike("spare_part.name",`%${s}%`);n&&console.error("Error searching by parent name:",n);const o=new Map;(e||[]).forEach(c=>{o.set(c.id,c)}),r.forEach(c=>{o.set(c.id,c)}),(a||[]).forEach(c=>{o.set(c.id,c)});const i=Array.from(o.values()).sort((c,l)=>c.name.localeCompare(l.name)).slice(0,50);return console.log(" [DEBUG] Comprehensive search results:",i.length),{data:i,message:"Variants found successfully",ok:!0}}catch(e){return console.error("Error in comprehensive variant search:",e),{data:[],message:e instanceof Error?e.message:"Failed to search variants",ok:!1}}},bn=async(s,e)=>{var t,r;try{console.log(" [DEBUG] ===== UPDATE SPARE PART WITH VARIANTS API START ====="),console.log(" [DEBUG] Update ID:",s),console.log(" [DEBUG] Input sparePartData:",e);const{data:{user:a}}=await w.auth.getUser(),n=e.useVariants||!1,o=e.variants||[];console.log(" [DEBUG] Use variants:",n),console.log(" [DEBUG] Variants count:",o.length);const i=js(e);let c=0,l=0;n&&o.length>0?(c=o.reduce((m,_)=>m+(_.quantity||0),0),l=o.reduce((m,_)=>m+(_.quantity||0)*(_.selling_price||0),0)):(c=i.quantity||0,l=(i.quantity||0)*(i.selling_price||0));const d={...i,quantity:n?0:i.quantity,cost_price:n?0:i.cost_price,selling_price:n?0:i.selling_price,min_quantity:n?0:i.min_quantity,metadata:{useVariants:n,variantCount:n?o.length:0,totalQuantity:c,totalValue:l},updated_by:a==null?void 0:a.id};if(console.log(" [DEBUG] Validating foreign key references..."),d.category_id){const{data:m}=await w.from("lats_categories").select("id").eq("id",d.category_id).single();if(m)console.log(" [DEBUG] Category ID is valid:",d.category_id);else throw console.error(" [DEBUG] Category ID does not exist:",d.category_id),new Error(`Category with ID ${d.category_id} does not exist`)}if(d.supplier_id){const{data:m}=await w.from("lats_suppliers").select("id").eq("id",d.supplier_id).single();if(m)console.log(" [DEBUG] Supplier ID is valid:",d.supplier_id);else throw console.error(" [DEBUG] Supplier ID does not exist:",d.supplier_id),new Error(`Supplier with ID ${d.supplier_id} does not exist`)}console.log(" [DEBUG] Executing Supabase update..."),console.log(" [DEBUG] Update data being sent:",d),console.log(" [DEBUG] Update ID:",s);const{data:u,error:h}=await w.from("lats_spare_parts").update(d).eq("id",s).select().single();if(console.log(" [DEBUG] Supabase update response:",{data:u,error:h}),h)throw console.error(" [DEBUG] Supabase update error:",h),h;console.log(" [DEBUG] Spare part updated successfully:",u),console.log(" [DEBUG] Verifying update by fetching record again...");const{data:g,error:p}=await w.from("lats_spare_parts").select("*").eq("id",s).single();if(p?console.error(" [DEBUG] Error verifying update:",p):console.log(" [DEBUG] Verified update data:",g),e.images&&e.images.length>0){console.log(" [DEBUG] Updating images in spare_part_images table...");try{await il(s,e.images,a==null?void 0:a.id),console.log(" [DEBUG] Images saved successfully, cleaning up old images...");const{error:m}=await w.from("spare_part_images").delete().eq("spare_part_id",s).neq("image_url",((t=e.images[0])==null?void 0:t.image_url)||((r=e.images[0])==null?void 0:r.url));m&&console.error(" [DEBUG] Error deleting old images:",m)}catch(m){console.error(" [DEBUG] Failed to update images, keeping existing ones:",m)}}if(n&&o.length>0){console.log(" [DEBUG] Updating variants for spare part:",s);const{error:m}=await w.from("lats_spare_part_variants").delete().eq("spare_part_id",s);m&&console.error(" [DEBUG] Error deleting existing variants:",m);const _=o.map(v=>({spare_part_id:s,name:v.name,sku:v.sku,cost_price:v.cost_price,selling_price:v.selling_price,quantity:v.quantity,min_quantity:v.min_quantity,variant_attributes:v.attributes||{},image_url:v.image_url||null,created_by:a==null?void 0:a.id,updated_by:a==null?void 0:a.id})),{data:b,error:S}=await w.from("lats_spare_part_variants").insert(_).select();S?console.error(" [DEBUG] Error creating variants:",S):console.log(" [DEBUG] Variants updated successfully:",b)}else{const{error:m}=await w.from("lats_spare_part_variants").delete().eq("spare_part_id",s);m&&console.error(" [DEBUG] Error deleting variants:",m)}return console.log(" [DEBUG] ===== UPDATE SPARE PART WITH VARIANTS API END ====="),{data:u,message:"Spare part updated successfully",ok:!0}}catch(a){return console.error(" [DEBUG] ===== UPDATE SPARE PART WITH VARIANTS API ERROR ====="),console.error(" [DEBUG] Error updating spare part:",a),{data:null,message:a instanceof Error?a.message:"Failed to update spare part",ok:!1}}},ml=async s=>{try{const{data:e,error:t}=await w.from("repair_parts").select(`
        *,
        spare_part:lats_spare_parts!spare_part_id(
          id,
          name,
          part_number,
          quantity,
          selling_price,
          cost_price,
          category_id,
          brand,
          description,
          condition,
          location,
          min_quantity,
          is_active,
          created_at,
          updated_at
        )
      `).eq("device_id",s).order("created_at",{ascending:!1});if(t){if(t.message.includes('relation "public.repair_parts" does not exist'))return console.warn("repair_parts table does not exist. Please run the migration to create it."),{data:[],message:"Repair parts table not found. Please contact administrator to set up the database.",ok:!0,total:0};throw t}return{data:e||[],message:"Repair parts retrieved successfully",ok:!0,total:(e==null?void 0:e.length)||0}}catch(e){return console.error("Error fetching repair parts:",e),{data:null,message:e instanceof Error?e.message:"Failed to fetch repair parts",ok:!1,total:0}}},Vb=async(s,e)=>{try{const{data:t,error:r}=await w.from("lats_spare_parts").select("quantity, name").eq("id",s).single();return r?{isValid:!1,availableStock:0,partName:"Unknown",error:`Failed to fetch spare part: ${r.message}`}:t?t.quantity<e?{isValid:!1,availableStock:t.quantity,partName:t.name,error:`Insufficient stock for ${t.name}. Available: ${t.quantity}, Needed: ${e}`}:{isValid:!0,availableStock:t.quantity,partName:t.name}:{isValid:!1,availableStock:0,partName:"Unknown",error:`Spare part not found: ${s}`}}catch(t){return{isValid:!1,availableStock:0,partName:"Unknown",error:t instanceof Error?t.message:"Unknown error"}}},Gb=async s=>{var e,t;try{const{data:{user:r}}=await w.auth.getUser();for(const u of s){const{data:h,error:g}=await w.from("lats_spare_parts").select("quantity, name").eq("id",u.spare_part_id).single();if(g)throw new Error(`Failed to fetch spare part: ${g.message}`);if(!h)throw new Error(`Spare part not found: ${u.spare_part_id}`);if(h.quantity<u.quantity_needed)throw new Error(`Insufficient stock for ${h.name}. Available: ${h.quantity}, Needed: ${u.quantity_needed}`)}const a=s.map(u=>({...u,created_by:r==null?void 0:r.id,updated_by:r==null?void 0:r.id})),{data:n,error:o}=await w.from("repair_parts").insert(a).select(`
        *,
        spare_part:lats_spare_parts!spare_part_id(
          id,
          name,
          part_number,
          quantity,
          selling_price,
          cost_price,
          category_id,
          brand,
          description,
          condition,
          location,
          min_quantity,
          is_active,
          created_at,
          updated_at
        )
      `);if(o)throw o;const i=[],c=[];let l=!1;const d=[];for(const u of s){const{data:h,error:g}=await w.from("lats_spare_parts").select("quantity").eq("id",u.spare_part_id).single();if(g){console.error("Error fetching current quantity:",g),d.push(`Failed to fetch stock for part ${u.spare_part_id}`),l=!0;continue}const{error:p}=await w.from("lats_spare_parts").update({quantity:h.quantity-u.quantity_needed,updated_at:new Date().toISOString()}).eq("id",u.spare_part_id);if(p){console.error("Error updating stock for spare part:",u.spare_part_id,p),d.push(`Failed to update stock for part ${u.spare_part_id}`),l=!0;continue}i.push({spare_part_id:u.spare_part_id,original_quantity:h.quantity});const{error:m}=await w.from("lats_spare_part_usage").insert({spare_part_id:u.spare_part_id,quantity:u.quantity_needed,device_id:u.device_id,reason:`Repair attachment - Device: ${u.device_id}`,notes:u.notes||"Spare part attached to device repair",used_by:r==null?void 0:r.id});if(m){console.error("Error recording usage for spare part:",u.spare_part_id,m),d.push(`Failed to record usage for part ${u.spare_part_id}`),l=!0;continue}c.push(u.spare_part_id)}if(l){console.warn("Some operations failed, attempting rollback...");for(const h of i){const{error:g}=await w.from("lats_spare_parts").update({quantity:h.original_quantity,updated_at:new Date().toISOString()}).eq("id",h.spare_part_id);g&&console.error("Failed to rollback stock for part:",h.spare_part_id,g)}for(const h of c){const{error:g}=await w.from("lats_spare_part_usage").delete().eq("spare_part_id",h).eq("device_id",(e=s[0])==null?void 0:e.device_id).eq("reason",`Repair attachment - Device: ${(t=s[0])==null?void 0:t.device_id}`);g&&console.error("Failed to rollback usage record for part:",h,g)}const u=(n==null?void 0:n.map(h=>h.id))||[];if(u.length>0){const{error:h}=await w.from("repair_parts").delete().in("id",u);h&&console.error("Failed to rollback repair parts:",h)}throw new Error(`Operation failed: ${d.join(", ")}. All changes have been rolled back.`)}return typeof window<"u"&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("lats:spare-parts-updated",{detail:{action:"stock-deducted",partsCount:(n==null?void 0:n.length)||0}})),{data:n||[],message:`${(n==null?void 0:n.length)||0} repair parts created and stock deducted successfully`,ok:!0,total:(n==null?void 0:n.length)||0}}catch(r){return console.error("Error creating repair parts:",r),{data:null,message:r instanceof Error?r.message:"Failed to create repair parts",ok:!1,total:0}}},Wb=async s=>{try{const{data:{user:e}}=await w.auth.getUser(),{data:t,error:r}=await w.from("lats_spare_parts").select("quantity, name").eq("id",s.spare_part_id).single();if(r)throw new Error(`Failed to fetch spare part: ${r.message}`);if(!t)throw new Error(`Spare part not found: ${s.spare_part_id}`);if(t.quantity<s.quantity_needed)throw new Error(`Insufficient stock for ${t.name}. Available: ${t.quantity}, Needed: ${s.quantity_needed}`);const{data:a,error:n}=await w.from("repair_parts").insert({...s,created_by:e==null?void 0:e.id,updated_by:e==null?void 0:e.id}).select(`
        *,
        spare_part:lats_spare_parts!spare_part_id(
          id,
          name,
          part_number,
          quantity,
          selling_price,
          cost_price,
          category_id,
          brand,
          description,
          condition,
          location,
          min_quantity,
          is_active,
          created_at,
          updated_at
        )
      `).single();if(n)throw n;const{error:o}=await w.from("lats_spare_parts").update({quantity:t.quantity-s.quantity_needed,updated_at:new Date().toISOString()}).eq("id",s.spare_part_id);o&&console.error("Error updating stock for spare part:",s.spare_part_id,o);const{error:i}=await w.from("lats_spare_part_usage").insert({spare_part_id:s.spare_part_id,quantity:s.quantity_needed,device_id:s.device_id,reason:`Repair attachment - Device: ${s.device_id}`,notes:s.notes||"Spare part attached to device repair",used_by:e==null?void 0:e.id});return i&&console.error("Error recording usage for spare part:",s.spare_part_id,i),typeof window<"u"&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("lats:spare-parts-updated",{detail:{action:"stock-deducted",partsCount:1}})),{data:a,message:"Repair part created and stock deducted successfully",ok:!0}}catch(e){return console.error("Error creating repair part:",e),{data:null,message:e instanceof Error?e.message:"Failed to create repair part",ok:!1}}},Hb=async s=>{try{const{data:{user:e}}=await w.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t,error:r}=await w.from("repair_parts").update({status:"accepted",updated_by:e.id}).in("id",s).select(`
        *,
        spare_part:lats_spare_parts!spare_part_id(
          id,
          name,
          part_number,
          quantity,
          selling_price,
          cost_price,
          category_id,
          brand,
          description,
          condition,
          location,
          min_quantity,
          is_active,
          created_at,
          updated_at
        )
      `);if(r)throw r;return{data:t||[],message:`${(t==null?void 0:t.length)||0} spare parts accepted successfully`,ok:!0}}catch(e){return console.error("Error accepting spare parts:",e),{data:null,message:e instanceof Error?e.message:"Failed to accept spare parts",ok:!1}}},Qb=async(s,e)=>{try{const{data:{user:t}}=await w.auth.getUser();if(!t)throw new Error("User not authenticated");const r={status:"needed",updated_by:t.id};e&&(r.notes=`Rejected by customer care: ${e}`);const{data:a,error:n}=await w.from("repair_parts").update(r).in("id",s).select(`
        *,
        spare_part:lats_spare_parts!spare_part_id(
          id,
          name,
          part_number,
          quantity,
          selling_price,
          cost_price,
          category_id,
          brand,
          description,
          condition,
          location,
          min_quantity,
          is_active,
          created_at,
          updated_at
        )
      `);if(n)throw n;return{data:a||[],message:`${(a==null?void 0:a.length)||0} spare parts rejected successfully`,ok:!0}}catch(t){return console.error("Error rejecting spare parts:",t),{data:null,message:t instanceof Error?t.message:"Failed to reject spare parts",ok:!1}}},Kb=async s=>{try{const e=await ml(s);if(!e.ok||!e.data)return{ready:!1,totalParts:0,readyParts:0,message:"Failed to fetch repair parts"};const t=e.data,r=t.length,a=t.filter(o=>o.status==="accepted"||o.status==="received"||o.status==="used").length,n=r>0&&a===r;return{ready:n,totalParts:r,readyParts:a,message:n?`All ${r} parts are ready`:`${a}/${r} parts are ready`}}catch(e){return console.error("Error checking spare parts readiness:",e),{ready:!1,totalParts:0,readyParts:0,message:"Error checking parts status"}}},_S=Object.freeze(Object.defineProperty({__proto__:null,acceptSpareParts:Hb,areAllSparePartsReady:Kb,bulkCreateSparePartVariants:qb,bulkUpdateQuantities:Lb,checkPartNumberExists:Rb,createOrUpdateSparePart:dl,createRepairPart:Wb,createRepairParts:Gb,createSparePart:yn,createSparePartVariant:jb,deleteSparePart:cl,deleteSparePartVariant:Mb,findSparePartByPartNumber:ul,getAllSpareParts:kb,getRepairParts:ml,getSparePart:Ib,getSparePartImages:Pb,getSparePartStats:Tb,getSparePartUsage:Db,getSparePartVariants:Ub,getSpareParts:Ab,getVariantStats:Fb,getVariantsWithFilters:Bb,recordSparePartUsage:ll,rejectSpareParts:Qb,searchSpareParts:Ob,searchSparePartsWithVariants:Nb,searchVariantsByAttributes:hl,searchVariantsComprehensive:zb,updateSparePart:Cb,updateSparePartVariant:$b,updateSparePartWithVariants:bn,validateStockAvailability:Vb},Symbol.toStringTag,{value:"Module"})),Tt=Oc()(Nc(Ug((s,e)=>({isLoading:!1,isCreating:!1,isUpdating:!1,isDeleting:!1,isDataLoading:!1,isCategoriesLoading:!1,isSuppliersLoading:!1,lastDataLoadTime:0,dataCache:{categories:null,suppliers:null,products:null,stockMovements:null,sales:null,spareParts:null},cacheTimestamp:0,CACHE_DURATION:15*60*1e3,categories:[],suppliers:[],products:[],sales:[],stockMovements:[],purchaseOrders:[],spareParts:[],sparePartUsage:[],searchTerm:"",selectedCategory:null,selectedSupplier:null,stockFilter:"all",currentPage:1,itemsPerPage:20,totalItems:0,selectedProducts:[],selectedPurchaseOrders:[],error:null,setLoading:t=>s({isLoading:t}),setError:t=>s({error:t}),clearError:()=>s({error:null}),setSearchTerm:t=>s({searchTerm:t,currentPage:1}),setSelectedCategory:t=>s({selectedCategory:t,currentPage:1}),setSelectedSupplier:t=>s({selectedSupplier:t,currentPage:1}),setStockFilter:t=>s({stockFilter:t,currentPage:1}),clearFilters:()=>s({searchTerm:"",selectedCategory:null,selectedSupplier:null,stockFilter:"all",currentPage:1}),setCurrentPage:t=>s({currentPage:t}),setItemsPerPage:t=>s({itemsPerPage:t,currentPage:1}),toggleProductSelection:t=>{const{selectedProducts:r}=e(),a=r.includes(t)?r.filter(n=>n!==t):[...r,t];s({selectedProducts:a})},selectAllProducts:()=>{const{getFilteredProducts:t}=e(),r=t().map(a=>a.id);s({selectedProducts:r})},deselectAllProducts:()=>s({selectedProducts:[]}),forceRefreshProducts:async()=>{console.log(" [useInventoryStore] Force refreshing products...");const t=e();s({dataCache:{...t.dataCache,products:null},cacheTimestamp:0,products:[],isDataLoading:!1,isLoading:!1}),await e().loadProducts({page:1,limit:200},!0),console.log(" [useInventoryStore] Products force refreshed")},togglePurchaseOrderSelection:t=>{const{selectedPurchaseOrders:r}=e(),a=r.includes(t)?r.filter(n=>n!==t):[...r,t];s({selectedPurchaseOrders:a})},selectAllPurchaseOrders:()=>{const{purchaseOrders:t}=e(),r=t.map(a=>a.id);s({selectedPurchaseOrders:r})},deselectAllPurchaseOrders:()=>s({selectedPurchaseOrders:[]}),isCacheValid:t=>{const r=e(),a=Date.now()-r.cacheTimestamp;return r.dataCache[t]!==null&&a<r.CACHE_DURATION},updateCache:(t,r)=>{const a=e();s({dataCache:{...a.dataCache,[t]:r},cacheTimestamp:Date.now()})},clearCache:t=>{const r=e();s(t?{dataCache:{...r.dataCache,[t]:null}}:{dataCache:{categories:null,suppliers:null,products:null,stockMovements:null,sales:null},cacheTimestamp:0})},invalidateCache:t=>{const r=e();s({dataCache:{...r.dataCache,[t]:null}})},loadCategories:async()=>{const t=e();if(t.isCacheValid("categories"),!t.isCategoriesLoading){s({isLoading:!0,isCategoriesLoading:!0,error:null});try{const r=await vr.getCategories();r.length>0&&sa(r,"Categories");const a=yo(r),n=e().categories;(!n||n.length!==a.length||n.some((i,c)=>!a[c]||i.id!==a[c].id||i.name!==a[c].name))&&(s({categories:a,lastDataLoadTime:Date.now(),error:null}),e().updateCache("categories",a),fe.track("categories_loaded",{count:a.length}))}catch(r){ea("Failed to load categories",r,{component:"useInventoryStore",action:"loadCategories"});const a=[{id:"sample-category",name:"Electronics",description:"Electronic devices and accessories",color:"#3B82F6",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:1,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-category-2",name:"Accessories",description:"Phone and device accessories",color:"#10B981",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:2,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-category-3",name:"Repair Parts",description:"Repair and replacement parts",color:"#F59E0B",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:3,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}];s({categories:a,error:"Using sample categories due to database connection issue"})}finally{s({isLoading:!1,isCategoriesLoading:!1})}}},loadSparePartCategories:async()=>{if(!e().isDataLoading){s({isLoading:!0,isDataLoading:!0,error:null});try{const r=await vr.getSparePartCategories();r.length>0&&sa(r,"Spare Part Categories");const a=yo(r),n=e().categories;(!n||n.length!==a.length||n.some((i,c)=>!a[c]||i.id!==a[c].id||i.name!==a[c].name))&&(s({categories:a,lastDataLoadTime:Date.now(),error:null}),fe.track("spare_part_categories_loaded",{count:a.length}))}catch(r){console.error("Spare part categories exception:",r),s({error:"Failed to load spare part categories"})}finally{s({isLoading:!1,isDataLoading:!1})}}},createCategory:async t=>{var r;s({isCreating:!0,error:null});try{const n=await xe().createCategory(t);return n.ok&&(e().invalidateCache("categories"),vr.invalidateCache(),fe.track("category_created",{categoryId:(r=n.data)==null?void 0:r.id})),n}catch(a){const n="Failed to create category";return s({error:n}),ea("Failed to create category",a,{component:"useInventoryStore",action:"createCategory"}),{ok:!1,message:n}}finally{s({isCreating:!1})}},updateCategory:async(t,r)=>{s({isUpdating:!0,error:null});try{const n=await xe().updateCategory(t,r);return n.ok&&(e().invalidateCache("categories"),vr.invalidateCache(),fe.track("category_updated",{categoryId:t})),n}catch(a){const n="Failed to update category";return s({error:n}),console.error("Error updating category:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},deleteCategory:async t=>{s({isDeleting:!0,error:null});try{const a=await xe().deleteCategory(t);return a.ok&&(e().invalidateCache("categories"),vr.invalidateCache(),fe.track("category_deleted",{categoryId:t})),a}catch(r){const a="Failed to delete category";return s({error:a}),console.error("Error deleting category:",r),{ok:!1,message:a}}finally{s({isDeleting:!1})}},loadSuppliers:async()=>{const t=e();if(t.isCacheValid("suppliers")){const o=t.dataCache.suppliers||[];console.log(` Using cached suppliers (${o.length} suppliers)`),s({suppliers:o});return}if(t.isSuppliersLoading){console.log(" Suppliers already loading, skipping...");return}console.log(" Starting supplier load..."),s({isSuppliersLoading:!0,error:null});const r=9e4;let a=0;const n=2;try{for(;a<=n;)try{const o=new Promise((l,d)=>setTimeout(()=>d(new Error("Supplier fetch timeout - database may be cold starting. Please wait and try again.")),r)),i=await Promise.race([Zc(),o]),c=Eb(i);console.log(` Suppliers loaded successfully: ${c.length} suppliers`),c.length===0?(console.error(" CRITICAL: No suppliers found!"),console.error(" FIX: Run MAKE-SUPPLIERS-WORK.sql in your database"),s({suppliers:[],error:"No suppliers found. Please run database setup."})):s({suppliers:c,lastDataLoadTime:Date.now(),error:null}),e().updateCache("suppliers",c),fe.track("suppliers_loaded",{count:c.length});break}catch(o){const i=(o==null?void 0:o.message)||String(o),c=i.includes("timeout")||i.includes("Timeout");if(c&&a<n){a++;const l=Math.min(5e3*a,15e3);console.warn(` Supplier fetch timeout (attempt ${a}/${n+1}). Retrying in ${l}ms...`),console.warn(" This may be a cold start - Neon databases can take 30-60 seconds to wake up."),await new Promise(d=>setTimeout(d,l));continue}console.error(" Suppliers exception:",o),c?(console.error(" Supplier fetch timed out after all retries. Database may be cold starting."),console.error(" Please wait 30-60 seconds and refresh the page.")):console.error(" FIX: Run MAKE-SUPPLIERS-WORK.sql in your database"),s({error:c?"Supplier fetch timed out. Database may be cold starting. Please wait and refresh.":"Failed to load suppliers. Check database connection.",suppliers:[]});break}}catch(o){const i=(o==null?void 0:o.message)||String(o);console.error(" Unexpected error in loadSuppliers:",o),s({error:i.includes("timeout")?"Supplier fetch timed out. Database may be cold starting. Please wait and refresh.":"Failed to load suppliers. Check database connection.",suppliers:[]})}finally{s({isSuppliersLoading:!1})}},createSupplier:async t=>{s({isCreating:!0,error:null});try{const r=await Iy(t);return await e().loadSuppliers(),fe.track("supplier_created",{supplierId:r.id}),{ok:!0,data:r}}catch(r){const a="Failed to create supplier";return s({error:a}),console.error("Error creating supplier:",r),{ok:!1,message:a}}finally{s({isCreating:!1})}},updateSupplier:async(t,r)=>{s({isUpdating:!0,error:null});try{const a=await Cy(t,r);return await e().loadSuppliers(),fe.track("supplier_updated",{supplierId:t}),{ok:!0,data:a}}catch(a){const n="Failed to update supplier";return s({error:n}),console.error("Error updating supplier:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},deleteSupplier:async t=>{s({isDeleting:!0,error:null});try{const a=await xe().deleteSupplier(t);return a.ok&&(await e().loadSuppliers(),fe.track("supplier_deleted",{supplierId:t})),a}catch(r){const a="Failed to delete supplier";return s({error:a}),console.error("Error deleting supplier:",r),{ok:!1,message:a}}finally{s({isDeleting:!1})}},loadProducts:async(t,r=!1)=>{var c,l,d,u,h,g,p;const a=e();if(a.isDataLoading&&!r){console.log(" [useInventoryStore] Products already loading, waiting for completion...");const m=3e4,_=Date.now();let b=0;const S=m/100;for(;b<S;){await new Promise(T=>setTimeout(T,100)),b++;const C=e();if(!C.isDataLoading){if(C.products.length>0){console.log(` [useInventoryStore] Products loaded by concurrent request: ${C.products.length}`);return}break}if(Date.now()-_>=m){console.warn(" [useInventoryStore] Timeout waiting for concurrent load, proceeding with new load");break}}if(e().products.length===0)console.log(" [useInventoryStore] Previous load completed but no products found, loading now..."),s({isDataLoading:!1});else return}console.log(" [useInventoryStore] Starting products load...",{filters:t});const n={page:1,limit:500,...t};if(!r){const m=pt.getProducts();if(m&&m.length>0){console.log(` [useInventoryStore] Using localStorage cache (${m.length} products) - INSTANT LOAD!`),s({products:m,isLoading:!1,isDataLoading:!1,error:null});const{childVariantsCacheService:_}=await z(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);_.preloadAllChildVariants(m).catch(b=>{console.warn(" Failed to preload child variants from cache (non-critical):",b)}),e().updateCache("products",m);try{const b=JSON.parse(localStorage.getItem("pos_products_cache")||"{}");Date.now()-(b.timestamp||0)>5*60*1e3&&(console.log(" [useInventoryStore] Cache is stale, refreshing in background..."),setTimeout(()=>{e().loadProducts(t,!0).catch(v=>{console.warn(" Background refresh failed (non-critical):",v)})},100))}catch{}return}}if(a.isCacheValid("products")&&!r){console.log(" [useInventoryStore] Using memory cache (valid for 10 min)");const m=a.dataCache.products||[];if(t){s({products:m,isLoading:!1,isDataLoading:!1});return}else{if(s({products:m,isLoading:!1,isDataLoading:!1}),m.length>0){const{childVariantsCacheService:_}=await z(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);_.preloadAllChildVariants(m).catch(b=>{console.warn(" Failed to preload child variants from memory cache (non-critical):",b)})}return}}console.log(" [useInventoryStore] No cache available, loading from database..."),console.log(" [useInventoryStore] PERFORMANCE WARNING: Loading from database instead of cache!"),console.log(" [useInventoryStore] Tip: Download full database in Settings > Offline Database for instant loads");const o=Date.now();s({isLoading:!0,error:null,isDataLoading:!0});const i=new Promise((m,_)=>{setTimeout(()=>_(new Error("Products loading timeout after 75 seconds. This may indicate a database connectivity issue.")),75e3)});try{const m=xe(),_=await Promise.race([m.getProducts(n),i]),b=Date.now()-o;if(b>1e4?console.warn(` [useInventoryStore] Slow database response (${b}ms) - possible cold start`):console.log(` [useInventoryStore] Products loaded in ${b}ms`),_.ok){const S=((c=_.data)==null?void 0:c.data)||_.data||[],v=Sb(S);v.length>0&&sa(v,"Products");const C={currentPage:((l=_.data)==null?void 0:l.page)||1,totalItems:((d=_.data)==null?void 0:d.total)||v.length,totalPages:((u=_.data)==null?void 0:u.totalPages)||1,itemsPerPage:((h=_.data)==null?void 0:h.limit)||500},T={supplier:0,category:0,variants:0,price:0,stock:0},x={productsWithVariants:0,productsWithoutVariants:0,totalVariants:0,variantsWithStock:0,variantsWithoutStock:0,variantsWithPrice:0,variantsWithoutPrice:0};v.forEach(k=>{var M,L;k.supplier||T.supplier++,k.category||T.category++,!k.variants||k.variants.length===0?(T.variants++,x.productsWithoutVariants++):(x.productsWithVariants++,x.totalVariants+=k.variants.length,k.variants.forEach(B=>{const U=B.quantity||B.stockQuantity||0,W=B.sellingPrice||B.price||0;U>0?x.variantsWithStock++:x.variantsWithoutStock++,W>0?x.variantsWithPrice++:x.variantsWithoutPrice++}));const P=k.price&&k.price>0,O=(M=k.variants)==null?void 0:M.some(B=>(B.sellingPrice||B.price||0)>0);!P&&!O&&T.price++;const N=k.totalQuantity||k.stockQuantity||0,$=((L=k.variants)==null?void 0:L.reduce((B,U)=>B+(U.quantity||U.stockQuantity||0),0))||0;N===0&&$===0&&T.stock++}),console.log(" [InventoryStore] DEBUG - Missing information in store:",{totalProducts:v.length,missingInfoCount:T,percentageMissing:{supplier:Math.round(T.supplier/v.length*100),category:Math.round(T.category/v.length*100),variants:Math.round(T.variants/v.length*100),price:Math.round(T.price/v.length*100),stock:Math.round(T.stock/v.length*100)}}),console.log(" [InventoryStore] Variant/Stock/Price Analysis:",{...x,averageVariantsPerProduct:x.productsWithVariants>0?Math.round(x.totalVariants/x.productsWithVariants*10)/10:0});const R=v.find(k=>k.variants&&k.variants.length>0);if(R?console.log(" [InventoryStore] Sample product with variants:",{id:R.id,name:R.name,variantCount:((g=R.variants)==null?void 0:g.length)||0,variants:((p=R.variants)==null?void 0:p.map(k=>({id:k.id,name:k.name,quantity:k.quantity,stockQuantity:k.stockQuantity,price:k.price,sellingPrice:k.sellingPrice,costPrice:k.costPrice})))||[]}):console.warn(" [InventoryStore] No products with variants found!"),s({products:v,...C,error:null}),!t){e().updateCache("products",v),pt.saveProducts(v);const{childVariantsCacheService:k}=await z(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);k.preloadAllChildVariants(v).catch(P=>{console.warn(" Failed to preload child variants (non-critical):",P)})}fe.track("products_loaded",{count:v.length,page:C.currentPage,total:C.totalItems})}else{const S=_.message||"Failed to load products";ea(`Provider returned error: ${S}`,void 0,{component:"useInventoryStore",action:"loadProducts",metadata:{message:_.message}}),s({error:S})}}catch(m){console.error("Exception in loadProducts:",m);const _=[{id:"sample-category",name:"Electronics",description:"Electronic devices and accessories",color:"#3B82F6",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:1,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-category-2",name:"Accessories",description:"Phone and device accessories",color:"#10B981",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:2,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-category-3",name:"Repair Parts",description:"Repair and replacement parts",color:"#F59E0B",icon:"",parent_id:null,isActive:!0,is_active:!0,sortOrder:3,metadata:{},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],b=[{id:"sample-1",name:"Sample iPhone 13",shortDescription:"Sample iPhone 13 for testing",sku:"IPH13-SAMPLE",categoryId:"sample-category",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:10,totalValue:5e4,price:5e4,costPrice:4e4,priceRange:"50000",condition:"new",internalNotes:"Sample product for testing",attributes:{color:"Black",storage:"128GB"},variants:[{id:"sample-variant-1",productId:"sample-1",sku:"IPH13-SAMPLE-BLK-128",name:"Black 128GB",attributes:{color:"Black",storage:"128GB"},costPrice:4e4,sellingPrice:5e4,quantity:10,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-2",name:"Sample Samsung Galaxy",shortDescription:"Sample Samsung Galaxy for testing",sku:"SAMSUNG-SAMPLE",categoryId:"sample-category-2",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:15,totalValue:45e3,price:45e3,costPrice:35e3,priceRange:"45000",condition:"new",internalNotes:"Sample product for testing",attributes:{color:"Blue",storage:"256GB"},variants:[{id:"sample-variant-2",productId:"sample-2",sku:"SAMSUNG-SAMPLE-BLU-256",name:"Blue 256GB",attributes:{color:"Blue",storage:"256GB"},costPrice:35e3,sellingPrice:45e3,quantity:15,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"sample-3",name:"Sample iPhone Screen",shortDescription:"Sample iPhone screen replacement",sku:"IPH-SCREEN-SAMPLE",categoryId:"sample-category-3",supplierId:"sample-supplier",images:[],isActive:!0,totalQuantity:5,totalValue:25e3,price:25e3,costPrice:2e4,priceRange:"25000",condition:"new",internalNotes:"Sample repair part for testing",attributes:{model:"iPhone 13",color:"Black"},variants:[{id:"sample-variant-3",productId:"sample-3",sku:"IPH-SCREEN-SAMPLE-BLK",name:"Black Screen",attributes:{model:"iPhone 13",color:"Black"},costPrice:2e4,sellingPrice:25e3,quantity:5,min_quantity:1,max_quantity:null,weight:null,dimensions:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}];s({products:b,categories:_,error:"Using sample products and categories due to database connection issue",isLoading:!1,isDataLoading:!1})}finally{s({isLoading:!1,isDataLoading:!1})}},loadProductVariants:async t=>{try{const a=await xe().getProductVariants(t);return a.ok?{ok:!0,data:a.data}:(console.error("Failed to load product variants:",a.message),{ok:!1,message:a.message})}catch(r){return console.error("Exception in loadProductVariants:",r),{ok:!1,message:"Failed to load product variants"}}},getProduct:async t=>{try{return await xe().getProduct(t)}catch(r){return console.error("Error getting product:",r),{ok:!1,message:"Failed to get product"}}},createProduct:async t=>{var r;s({isCreating:!0,error:null});try{const n=await xe().createProduct(t);return n.ok?(e().clearCache("products"),pt.clearProducts(),await e().loadProducts(null,!0),fe.track("product_created",{productId:(r=n.data)==null?void 0:r.id})):s({error:n.message||"Failed to create product"}),n}catch(a){const n="Failed to create product";return console.error("Exception in createProduct:",a),s({error:n}),{ok:!1,message:n}}finally{s({isCreating:!1})}},updateProduct:async(t,r)=>{s({isUpdating:!0,error:null});try{console.log(" [Store] updateProduct called with:",{id:t,product:r});const a=xe();console.log(" [Store] Provider obtained, calling updateProduct...");const n=await a.updateProduct(t,r);return console.log(" [Store] Provider response:",n),n.ok?(console.log(" [Store] Update successful, reloading products..."),e().clearCache("products"),pt.clearProducts(),await e().loadProducts(null,!0),fe.track("product_updated",{productId:t})):(console.error(" [Store] Update failed:",n.message),s({error:n.message||"Failed to update product"})),n}catch(a){const n="Failed to update product";return console.error(" [Store] Exception in updateProduct:",a),console.error(" [Store] Error message:",a==null?void 0:a.message),console.error(" [Store] Error stack:",a==null?void 0:a.stack),s({error:n}),{ok:!1,message:(a==null?void 0:a.message)||n}}finally{s({isUpdating:!1})}},updateProductInStore:t=>{const r=e(),a=r.products.findIndex(n=>n.id===t.id);if(a>=0){const n=[...r.products];n[a]=t,s({products:n,dataCache:{...r.dataCache,products:n}}),console.log(` [Store] Updated product ${t.id} in store without reloading all products`)}else s({products:[...r.products,t],dataCache:{...r.dataCache,products:[...r.products,t]}}),console.log(` [Store] Added product ${t.id} to store`)},deleteProduct:async t=>{s({isDeleting:!0,error:null});try{const a=await xe().deleteProduct(t);if(a.ok)e().clearCache("products"),pt.clearProducts(),await e().loadProducts(null,!0),fe.track("product_deleted",{productId:t});else throw new Error(a.message||"Failed to delete product")}catch(r){throw s({error:"Failed to delete product"}),console.error("Error deleting product:",r),r}finally{s({isDeleting:!1})}},searchProducts:async t=>{try{return await xe().searchProducts(t)}catch(r){return console.error("Error searching products:",r),{ok:!1,message:"Failed to search products",data:[]}}},loadStockMovements:async()=>{const t=e();if(t.isCacheValid("stockMovements")){s({stockMovements:t.dataCache.stockMovements||[]});return}s({isLoading:!0,error:null});try{const a=await xe().getStockMovements();if(a.ok){const n=a.data||[];s({stockMovements:n}),e().updateCache("stockMovements",n),fe.track("stock_movements_loaded",{count:n.length})}else s({error:a.message||"Failed to load stock movements"})}catch(r){s({error:"Failed to load stock movements"}),console.error("Error loading stock movements:",r)}finally{s({isLoading:!1})}},adjustStock:async(t,r,a,n)=>{s({isUpdating:!0,error:null});try{const i=await xe().adjustStock(t,r,a,n);return i.ok&&(await e().loadProducts(),await e().loadStockMovements(),fe.track("stock_adjusted",{productId:t,variantId:r,quantity:a,reason:n})),i}catch(o){const i="Failed to adjust stock";return s({error:i}),console.error("Error adjusting stock:",o),{ok:!1,message:i}}finally{s({isUpdating:!1})}},loadSales:async()=>{const t=e();if(t.isCacheValid("sales")){s({sales:t.dataCache.sales||[]});return}s({isLoading:!0,error:null});try{const a=await xe().getSales();if(a.ok){const n=a.data||[];s({sales:n}),e().updateCache("sales",n),fe.track("sales_loaded",{count:n.length})}else s({error:a.message||"Failed to load sales"})}catch(r){s({error:"Failed to load sales"}),console.error("Error loading sales:",r)}finally{s({isLoading:!1})}},getProductSales:async t=>{try{return await xe().getProductSales(t)}catch(r){return console.error("Error getting product sales:",r),{ok:!1,message:"Failed to get product sales",data:[]}}},getSoldQuantity:(t,r)=>e().sales.filter(n=>n.product_id===t&&n.variant_id===r).reduce((n,o)=>n+o.quantity,0),loadPurchaseOrders:async()=>{var r;const t=e();if(!(t.isLoading||t.isDataLoading)){s({isLoading:!0,isDataLoading:!0,error:null});try{const n=await xe().getPurchaseOrders();n.ok?(s({purchaseOrders:n.data||[]}),fe.track("purchase_orders_loaded",{count:((r=n.data)==null?void 0:r.length)||0})):s({error:n.message||"Failed to load purchase orders"})}catch(a){s({error:"Failed to load purchase orders"}),console.error("Error loading purchase orders:",a)}finally{s({isLoading:!1,isDataLoading:!1})}}},getPurchaseOrder:async t=>{try{if(!t)return console.error(" No purchase order ID provided"),{ok:!1,message:"Purchase order ID is required"};const a=await xe().getPurchaseOrder(t);return a.ok||console.error(" Provider error getting purchase order:",a.message),a}catch(r){return console.error(" Store error getting purchase order:",r),r instanceof Error?r.message.includes("network")||r.message.includes("fetch")?{ok:!1,message:"Network error: Please check your internet connection"}:r.message.includes("timeout")?{ok:!1,message:"Request timeout: Please try again"}:{ok:!1,message:`Error: ${r.message}`}:{ok:!1,message:"Failed to get purchase order: Unknown error occurred"}}},createPurchaseOrder:async t=>{var r;s({isCreating:!0,error:null});try{const n=await xe().createPurchaseOrder(t);return n.ok&&(await e().loadPurchaseOrders(),fe.track("purchase_order_created",{orderId:(r=n.data)==null?void 0:r.id})),n}catch(a){const n="Failed to create purchase order";return s({error:n}),console.error("Error creating purchase order:",a),{ok:!1,message:n}}finally{s({isCreating:!1})}},updatePurchaseOrder:async(t,r)=>{s({isUpdating:!0,error:null});try{const n=await xe().updatePurchaseOrder(t,r);return n.ok&&(await e().loadPurchaseOrders(),fe.track("purchase_order_updated",{orderId:t})),n}catch(a){const n="Failed to update purchase order";return s({error:n}),console.error("Error updating purchase order:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},receivePurchaseOrder:async t=>{s({isUpdating:!0,error:null});try{const a=await xe().receivePurchaseOrder(t);return a.ok&&(await e().loadPurchaseOrders(),await e().loadProducts(),fe.track("purchase_order_received",{orderId:t})),a}catch(r){const a="Failed to receive purchase order";return s({error:a}),console.error("Error receiving purchase order:",r),{ok:!1,message:a}}finally{s({isUpdating:!1})}},updatePurchaseOrderStatus:async(t,r)=>{s({isUpdating:!0,error:null});try{const n=await xe().updatePurchaseOrder(t,{status:r});return n.ok&&(await e().loadPurchaseOrders(),fe.track("purchase_order_status_updated",{orderId:t,status:r})),n}catch(a){const n="Failed to update purchase order status";return s({error:n}),console.error("Error updating purchase order status:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},approvePurchaseOrder:async t=>{var r;s({isUpdating:!0,error:null});try{const n=await xe().updatePurchaseOrder(t,{status:"sent",approvedAt:new Date().toISOString(),approvedBy:(r=e().currentUser)==null?void 0:r.id});return n.ok&&(await e().loadPurchaseOrders(),fe.track("purchase_order_approved",{orderId:t})),n}catch(a){const n="Failed to approve purchase order";return s({error:n}),console.error("Error approving purchase order:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},deletePurchaseOrder:async t=>{s({isDeleting:!0,error:null});try{const a=await xe().deletePurchaseOrder(t);return a.ok&&(await e().loadPurchaseOrders(),fe.track("purchase_order_deleted",{orderId:t})),a}catch(r){const a="Failed to delete purchase order";return s({error:a}),console.error("Error deleting purchase order:",r),{ok:!1,message:a}}finally{s({isDeleting:!1})}},loadSpareParts:async()=>{s({isLoading:!0,error:null});try{const r=await xe().getSpareParts();if(r.ok){const a=r.data||[];s({spareParts:a}),e().updateCache("spareParts",a),fe.track("spare_parts_loaded",{count:a.length})}else console.error(" [DEBUG] loadSpareParts: Failed to load spare parts:",r.message),s({error:r.message||"Failed to load spare parts"})}catch(t){console.error(" [DEBUG] loadSpareParts: Error loading spare parts:",t),s({error:"Failed to load spare parts"})}finally{s({isLoading:!1})}},getSparePart:async t=>{try{return await xe().getSparePart(t)}catch(r){return console.error("Error getting spare part:",r),{ok:!1,message:"Failed to get spare part"}}},createSparePart:async t=>{var r;s({isCreating:!0,error:null});try{const a=await yn(t);return a.ok&&(e().clearCache("spareParts"),await e().loadSpareParts(),fe.track("spare_part_created",{sparePartId:(r=a.data)==null?void 0:r.id})),a}catch(a){const n="Failed to create spare part";return s({error:n}),console.error("Error creating spare part:",a),{ok:!1,message:n}}finally{s({isCreating:!1})}},createOrUpdateSparePart:async t=>{var r;s({isCreating:!0,error:null});try{const a=await dl(t);return a.ok&&(e().clearCache("spareParts"),await e().loadSpareParts(),fe.track("spare_part_created_or_updated",{sparePartId:(r=a.data)==null?void 0:r.id})),a}catch(a){const n="Failed to create or update spare part";return s({error:n}),console.error("Error creating or updating spare part:",a),{ok:!1,message:n}}finally{s({isCreating:!1})}},updateSparePart:async(t,r)=>{s({isUpdating:!0,error:null});try{const a=await bn(t,r);return a.ok&&(e().clearCache("spareParts"),await e().loadSpareParts(),fe.track("spare_part_updated",{sparePartId:t})),a}catch(a){const n="Failed to update spare part";return s({error:n}),console.error("Error updating spare part:",a),{ok:!1,message:n}}finally{s({isUpdating:!1})}},deleteSparePart:async t=>{s({isDeleting:!0,error:null});try{const r=await cl(t);return r.ok&&(await e().loadSpareParts(),fe.track("spare_part_deleted",{sparePartId:t})),r}catch(r){const a="Failed to delete spare part";return s({error:a}),console.error("Error deleting spare part:",r),{ok:!1,message:a}}finally{s({isDeleting:!1})}},useSparePart:async(t,r,a,n)=>{s({isUpdating:!0,error:null});try{const i=await ll({spare_part_id:t,quantity_used:r,reason:a,notes:n});return i.ok&&(await e().loadSpareParts(),await e().loadSparePartUsage(),fe.track("spare_part_used",{sparePartId:t,quantity:r,reason:a})),i}catch(o){const i="Failed to use spare part";return s({error:i}),console.error("Error using spare part:",o),{ok:!1,message:i}}finally{s({isUpdating:!1})}},loadSparePartUsage:async()=>{var t;s({isLoading:!0,error:null});try{const a=await xe().getSparePartUsage();a.ok?(s({sparePartUsage:a.data||[]}),fe.track("spare_part_usage_loaded",{count:((t=a.data)==null?void 0:t.length)||0})):s({error:a.message||"Failed to load spare part usage"})}catch(r){s({error:"Failed to load spare part usage"}),console.error("Error loading spare part usage:",r)}finally{s({isLoading:!1})}},getFilteredProducts:()=>{const{products:t,searchTerm:r,selectedCategory:a,selectedSupplier:n,stockFilter:o}=e();return t.filter(i=>{var c,l;if(r){const d=r.toLowerCase();if(!(i.name.toLowerCase().includes(d)||i.description.toLowerCase().includes(d)||((c=i.variants)==null?void 0:c.some(h=>{var g;return(g=h.sku)==null?void 0:g.toLowerCase().includes(d)}))||!1))return!1}if(a&&i.categoryId!==a||n&&i.supplierId!==n)return!1;if(o!=="all"){const d=((l=i.variants)==null?void 0:l.reduce((u,h)=>u+(h.quantity||0),0))||0;switch(o){case"in-stock":if(d<=0)return!1;break;case"low-stock":if(d>10)return!1;break;case"out-of-stock":if(d>0)return!1;break}}return!0})},getLowStockProducts:()=>{const{products:t}=e();return t.filter(r=>{var n;const a=((n=r.variants)==null?void 0:n.reduce((o,i)=>o+(i.quantity||0),0))||0;return a>0&&a<=10})},getOutOfStockProducts:()=>{const{products:t}=e();return t.filter(r=>{var n;return(((n=r.variants)==null?void 0:n.reduce((o,i)=>o+(i.quantity||0),0))||0)<=0})},getProductById:t=>{const{products:r}=e();if(!t){console.error(" getProductById: No ID provided");return}if(typeof t=="object"){console.error(" getProductById: Object passed instead of string ID:",t);return}const a=String(t).trim();if(!a){console.error(" getProductById: Empty ID after sanitization");return}return r.find(n=>n.id===a)},getCategoryById:t=>{const{categories:r}=e();if(!t||typeof t=="object"){console.error(" getCategoryById: Invalid ID provided:",t);return}const a=String(t).trim();return r.find(n=>n.id===a)},getSupplierById:t=>{const{suppliers:r}=e();if(!t||typeof t=="object"){console.error(" getSupplierById: Invalid ID provided:",t);return}const a=String(t).trim();return r.find(n=>n.id===a)}})),{name:"lats-inventory-store",enabled:!1}));let wo=!1,Sr=null,rs=!1,vo=0;wo?console.log(" [DEBUG] Event subscription already initialized, skipping"):(wo=!0,console.log(" [DEBUG] Event subscription initialized"),gt.subscribeToAll(s=>{if(vo++,console.log(` [DEBUG] Event received #${vo}:`,s.type,{isProcessingEvent:rs,hasTimeout:!!Sr,timestamp:new Date().toISOString()}),rs){console.log(` [DEBUG] Skipping event ${s.type} - already processing`);return}const e=Tt.getState();if(console.log(` [DEBUG] Store state check for ${s.type}:`,{isDataLoading:e.isDataLoading,productsCount:e.products.length,cacheTimestamp:e.cacheTimestamp}),e.isDataLoading){console.log(` [DEBUG] Skipping event ${s.type} - data already loading`);return}Sr&&(console.log(` [DEBUG] Clearing pending timeout for ${s.type}`),clearTimeout(Sr)),console.log(` [DEBUG] Scheduling event processing for ${s.type} in 1 second`),Sr=setTimeout(()=>{console.log(` [DEBUG] Processing event ${s.type} now`),rs=!0;try{switch(s.type){case"lats:category.created":case"lats:category.updated":case"lats:category.deleted":e.isCacheValid("categories")||e.loadCategories().catch(()=>{});break;case"lats:supplier.created":case"lats:supplier.updated":case"lats:supplier.deleted":e.isCacheValid("suppliers")||e.loadSuppliers().catch(()=>{});break;case"lats:product.created":case"lats:product.updated":case"lats:product.deleted":e.forceRefreshProducts().catch(()=>{});break;case"lats:stock.updated":console.log(" [DEBUG] Handling stock.updated event"),e.isDataLoading?console.log(" [DEBUG] Skipping stock.updated - data already loading"):(console.log(" [DEBUG] Scheduling stock refresh in 3 seconds"),setTimeout(()=>{const t=Tt.getState();t.isDataLoading?console.log(" [DEBUG] Skipping stock refresh - data loading"):(console.log(" [DEBUG] Executing stock refresh now"),t.loadProducts().catch(r=>{console.warn(" [DEBUG] Stock refresh failed:",r)}),t.isCacheValid("stockMovements")||t.loadStockMovements().catch(r=>{console.warn(" [DEBUG] Stock movements reload failed:",r)}))},3e3));break;case"lats:purchase-order.created":case"lats:purchase-order.updated":case"lats:purchase-order.received":case"lats:purchase-order.deleted":break;case"lats:spare-part.created":case"lats:spare-part.updated":case"lats:spare-part.deleted":e.isCacheValid("spareParts")||e.loadSpareParts().catch(()=>{});break;case"lats:spare-part.used":e.isCacheValid("spareParts")||e.loadSpareParts().catch(()=>{}),e.isCacheValid("sparePartUsage")||e.loadSparePartUsage().catch(()=>{});break;case"lats:sale.completed":console.log(" [DEBUG] Handling sale.completed event"),setTimeout(()=>{const t=Tt.getState();console.log(" [DEBUG] Executing sale.completed reloads now"),t.isDataLoading||(console.log(" [DEBUG] Refreshing products after sale to update stock"),t.loadProducts({page:1,limit:200},!0).catch(r=>{console.warn(" [DEBUG] Products reload failed:",r)})),t.loadStockMovements().catch(r=>{console.warn(" [DEBUG] Stock movements reload failed:",r)}),t.loadSales().catch(r=>{console.warn(" [DEBUG] Sales reload failed:",r)})},1e3);break}}catch(t){console.error(` [DEBUG] Error processing event ${s.type}:`,t)}finally{console.log(` [DEBUG] Event ${s.type} processing complete`),rs=!1,Sr=null}},1e3)}),console.log(" [DEBUG] Event subscription setup complete"));const yS=Object.freeze(Object.defineProperty({__proto__:null,useInventoryStore:Tt},Symbol.toStringTag,{value:"Module"})),Jb=()=>{var c,l,d,u,h,g,p,m,_;const{isLoading:s,products:e}=Tt(),{startLoading:t,completeLoading:r}=el(),a=Ut(),n=D.useRef(null),o=D.useRef(!1),i=D.useRef(!1);return D.useEffect(()=>{s&&!n.current&&(n.current=t("Loading inventory data...")),!s&&n.current&&(r(n.current),n.current=null)},[s,t,r]),D.useEffect(()=>{e&&e.length>0?(async()=>{try{console.log(" [BackgroundDataLoader] Initializing/updating global cache service...");const{childVariantsCacheService:S}=await z(()=>import("./childVariantsCacheService-9368f4c7.js"),["assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]),v=e.filter(x=>x.variants&&Array.isArray(x.variants)&&x.variants.length>0);if(v.length===0){console.log(" [BackgroundDataLoader] No products with variants found, skipping child variants preload");return}console.log(` [BackgroundDataLoader] Found ${v.length} products with variants, preloading child variants...`);const C=S.getCacheStats();(!C.isValid||parseFloat(C.ageMinutes||"0")>10)&&(console.log(" [BackgroundDataLoader] Cache invalid or stale, forcing refresh..."),S.clearCache()),await S.preloadAllChildVariants(e),console.log(" [BackgroundDataLoader] Global cache service initialized/updated successfully"),o.current=!0}catch(S){console.warn(" [BackgroundDataLoader] Failed to initialize global cache service:",S)}})():e&&e.length===0&&(o.current=!1)},[e]),D.useEffect(()=>{(async()=>{const S=[];!i.current&&(!a.customers||a.customers.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("customers"),i.current=!0}catch(v){console.warn(" Failed to preload customers:",v)}})()),a.settings||S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("settings")}catch(v){console.warn(" Failed to preload settings:",v)}})()),(!a.adminSettings||a.adminSettings.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("admin_settings")}catch(v){console.warn(" Failed to preload admin settings:",v)}})()),(!a.purchaseOrders||a.purchaseOrders.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("purchase_orders")}catch(v){console.warn(" Failed to preload purchase orders:",v)}})()),(!a.stockMovements||a.stockMovements.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("stock_movements")}catch(v){console.warn(" Failed to preload stock movements:",v)}})()),(!a.sales||a.sales.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("sales")}catch(v){console.warn(" Failed to preload sales:",v)}})()),(!a.parentVariants||a.parentVariants.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("parent_variants")}catch(v){console.warn(" Failed to preload parent variants:",v)}})()),(!a.employees||a.employees.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("employees")}catch(v){console.warn(" Failed to preload employees:",v)}})()),(!a.paymentMethods||a.paymentMethods.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("payment_methods")}catch(v){console.warn(" Failed to preload payment methods:",v)}})()),(!a.attendanceRecords||a.attendanceRecords.length===0)&&S.push((async()=>{try{const{dataPreloadService:v}=await z(()=>import("./dataPreloadService-9ec6c84e.js"),["assets/dataPreloadService-9ec6c84e.js","assets/supabase-cf010ec4.js","assets/enhancedCacheManager-afe341e0.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"]);await v.refreshData("attendance_records")}catch(v){console.warn(" Failed to preload attendance records:",v)}})()),await Promise.all(S)})()},[((c=a.customers)==null?void 0:c.length)||0,a.settings,((l=a.adminSettings)==null?void 0:l.length)||0,((d=a.purchaseOrders)==null?void 0:d.length)||0,((u=a.stockMovements)==null?void 0:u.length)||0,((h=a.sales)==null?void 0:h.length)||0,((g=a.parentVariants)==null?void 0:g.length)||0,((p=a.employees)==null?void 0:p.length)||0,((m=a.paymentMethods)==null?void 0:m.length)||0,((_=a.attendanceRecords)==null?void 0:_.length)||0]),null},Yb=()=>{const{currentUser:s}=Lt(),{products:e,loadProducts:t}=Tt(),r=D.useRef(!1),a=D.useRef(!1),n=D.useRef(0),o=async(i=!1)=>{if(a.current){console.log(" [ProductPreloader] Background load already in progress, skipping");return}const c=Date.now();if(!i&&c-n.current<3e4){console.log(" [ProductPreloader] Throttled - too soon since last load");return}a.current=!0,n.current=c;try{console.log(" [ProductPreloader] Background loading products..."),await t({page:1,limit:500},i);const l=Tt.getState().products;console.log(` [ProductPreloader] Background load completed (${l.length} products)`)}catch(l){console.error(" [ProductPreloader] Background load failed:",l)}finally{a.current=!1}};return D.useEffect(()=>{if(!s){console.log(" [ProductPreloader] User not authenticated, skipping preload");return}const c=setTimeout(async()=>{try{console.log(" [ProductPreloader] Initializing product preload...");const l=pt.getProducts();l&&l.length>0?(console.log(` [ProductPreloader] Found ${l.length} cached products - instant display ready`),r.current=!0,setTimeout(()=>{o(!1)},2e3)):(console.log(" [ProductPreloader] No cache found, loading from database..."),await o(!1),r.current=!0)}catch(l){console.error(" [ProductPreloader] Failed to initialize products:",l)}},100);return()=>clearTimeout(c)},[s]),D.useEffect(()=>{e&&e.length>0&&(console.log(` [ProductPreloader] Persisting ${e.length} products to cache`),pt.saveProducts(e))},[e]),D.useEffect(()=>{if(!s)return;const i=setInterval(()=>{console.log(" [ProductPreloader] Periodic background refresh triggered"),o(!0)},15*60*1e3);return()=>clearInterval(i)},[s]),D.useEffect(()=>{if(!s)return;const i=()=>{document.visibilityState==="visible"&&Date.now()-n.current>6e4&&(console.log(" [ProductPreloader] App became visible - refreshing products in background"),o(!1))};return document.addEventListener("visibilitychange",i),()=>{document.removeEventListener("visibilitychange",i)}},[s]),D.useEffect(()=>{if(!s)return;const i=()=>{Date.now()-n.current>12e4&&(console.log(" [ProductPreloader] Window focused - refreshing products in background"),o(!1))};return window.addEventListener("focus",i),()=>{window.removeEventListener("focus",i)}},[s]),null};class Xb{async generatePlanNumber(){const{data:e,error:t}=await w.from("customer_installment_plans").select("plan_number").order("created_at",{ascending:!1}).limit(1);if(t)return console.error("Error fetching last plan number:",t),`INS-${Date.now().toString().slice(-6)}`;if(!e||e.length===0)return"INS-001";const a=e[0].plan_number.match(/INS-(\d+)/);return a?`INS-${(parseInt(a[1])+1).toString().padStart(3,"0")}`:`INS-${Date.now().toString().slice(-6)}`}calculateSchedule(e,t,r){const a=new Date(e);let n;switch(r){case"weekly":n=7;break;case"bi_weekly":n=14;break;case"monthly":n=30;break;default:n=30}const o=new Date(a);o.setDate(o.getDate()+n);const i=new Date(a);return i.setDate(i.getDate()+n*t),{nextPaymentDate:o.toISOString().split("T")[0],endDate:i.toISOString().split("T")[0]}}async getValidBranchId(e){if(!e){console.log(" [InstallmentService] No branch_id provided, will use default or NULL");return}const{data:t,error:r}=await w.from("lats_branches").select("id").eq("id",e).single();if(r||!t){console.warn(" [InstallmentService] Branch ID not found in lats_branches:",e),console.log(" [InstallmentService] Attempting to sync branch from store_locations...");const{data:a}=await w.from("store_locations").select("id, name, is_active, created_at, updated_at").eq("id",e).single();if(a){const{data:n,error:o}=await w.from("lats_branches").insert({id:a.id,name:a.name,is_active:a.is_active,created_at:a.created_at,updated_at:a.updated_at}).select("id").single();if(o){const{data:i}=await w.from("lats_branches").select("id").eq("id",e).single();return i?(console.log(" [InstallmentService] Branch found after sync attempt"),i.id):(console.error(" [InstallmentService] Failed to sync branch:",o),await this.getDefaultBranchId())}return console.log(" [InstallmentService] Branch synced successfully"),n.id}else return console.warn(" [InstallmentService] Branch not found in store_locations either"),await this.getDefaultBranchId()}return console.log(" [InstallmentService] Branch ID validated:",e),t.id}async getDefaultBranchId(){const{data:e}=await w.from("lats_branches").select("id").eq("is_active",!0).order("is_main",{ascending:!1}).limit(1).single();if(e)return console.log(" [InstallmentService] Using default branch:",e.id),e.id;const{data:t}=await w.from("lats_branches").select("id").eq("is_active",!0).limit(1).single();if(t)return console.log(" [InstallmentService] Using first active branch:",t.id),t.id;console.warn(" [InstallmentService] No active branches found, branch_id will be NULL")}async createInstallmentPlan(e,t,r){var a,n,o,i,c;console.log(" [InstallmentService] createInstallmentPlan called"),console.log(" [InstallmentService] Input:",JSON.stringify(e,null,2)),console.log(" [InstallmentService] User ID:",t),console.log(" [InstallmentService] Branch ID provided:",r);try{console.log(" [InstallmentService] Validating branch_id...");const l=await this.getValidBranchId(r);console.log(" [InstallmentService] Valid branch_id:",l),console.log(" [InstallmentService] Generating plan number...");const d=await this.generatePlanNumber();console.log(" [InstallmentService] Plan number generated:",d);const u=e.total_amount-e.down_payment,h=e.down_payment>0?e.number_of_installments-1:e.number_of_installments;let g=0,p=[];if(h>0){const x=u/h;let R=0;for(let P=0;P<h-1;P++){const O=Math.round(x*100)/100;p.push(O),R+=O}const k=Math.round((u-R)*100)/100;p.push(k),g=p[0]||x}const m=p.reduce((x,R)=>x+R,0),_=e.down_payment+m,b=Math.abs(_-e.total_amount);if(b>.001){const x=`Payment amounts don't balance! Total: ${e.total_amount}, Down Payment: ${e.down_payment}, Installments Total: ${m}, Total Payments: ${_}, Difference: ${b}`;return console.error(" [InstallmentService] Payment balance mismatch:",{totalAmount:e.total_amount,downPayment:e.down_payment,totalInstallments:m,totalPayments:_,difference:b,numberOfRemainingInstallments:h,balancedInstallmentAmounts:p}),{success:!1,error:x}}console.log(" [InstallmentService] Calculations:"),console.log("   - Total Amount:",e.total_amount),console.log("   - Down Payment:",e.down_payment),console.log("   - Amount Financed:",u),console.log("   - Number of Total Installments:",e.number_of_installments),console.log("   - Number of Remaining Installments:",h),console.log("   - Base Installment Amount:",u/h),console.log("   - Balanced Installment Amounts:",p),console.log("   - Installment Amount (stored):",g),console.log("   - Total Installment Amounts:",m),console.log("   - Total Payments:",_),console.log("   - Balance Difference:",b),console.log("   - Payment Balance Check:  PASSED");const S=this.calculateSchedule(e.start_date,e.number_of_installments,e.payment_frequency);console.log(" [InstallmentService] Schedule calculated:"),console.log("   - Start Date:",e.start_date),console.log("   - Next Payment Date:",S.nextPaymentDate),console.log("   - End Date:",S.endDate),console.log("   - Payment Frequency:",e.payment_frequency),console.log(" [InstallmentService] Creating installment plan in database...");const v={plan_number:d,customer_id:e.customer_id,sale_id:e.sale_id,total_amount:e.total_amount,down_payment:e.down_payment,amount_financed:u,installment_amount:g,number_of_installments:e.number_of_installments,payment_frequency:e.payment_frequency,start_date:e.start_date,next_payment_date:S.nextPaymentDate,end_date:S.endDate,balance_due:u,late_fee_amount:e.late_fee_amount||0,notes:e.notes,status:"active",created_by:t,branch_id:l};console.log(" [InstallmentService] Plan data to insert:",JSON.stringify(v,null,2));const{data:C,error:T}=await w.from("customer_installment_plans").insert(v).select().single();if(T)throw console.error(" [InstallmentService] Plan creation error:",T),T;if(console.log(" [InstallmentService] Plan created successfully:",C),console.log(" [InstallmentService] Plan ID:",C.id),e.down_payment>0){console.log(" [InstallmentService] Recording down payment as installment #1:",e.down_payment);const x=new Date(C.created_at||new Date().toISOString()).toISOString().split("T")[0],R={installment_plan_id:C.id,customer_id:e.customer_id,installment_number:1,amount:e.down_payment,payment_method:e.payment_method,due_date:x,account_id:e.account_id,reference_number:`${d}-DOWN`,notes:"Down payment (First Payment)",status:"paid",created_by:t};console.log(" [InstallmentService] Down payment data:",JSON.stringify(R,null,2));const{error:k}=await w.from("installment_payments").insert(R);k?console.error(" [InstallmentService] Error recording down payment:",k):console.log(" [InstallmentService] Down payment recorded successfully"),console.log(" [InstallmentService] Updating finance account:",e.account_id),await this.updateFinanceAccount(e.account_id,e.down_payment,`Down payment for installment plan ${d}`,`${d}-DOWN`,"installment_plan",C.id,r),console.log(" [InstallmentService] Finance account updated and transaction recorded")}else console.log(" [InstallmentService] No down payment to record");return console.log(" [InstallmentService] Sending plan created notification..."),await this.sendPlanCreatedNotification(C.id,t),console.log(" [InstallmentService] Notification sent"),console.log(" [InstallmentService] Installment plan creation completed successfully!"),{success:!0,plan:C}}catch(l){console.error(" [InstallmentService] Error creating installment plan:",l),console.error(" [InstallmentService] Error Details:",{message:l==null?void 0:l.message,code:l==null?void 0:l.code,status:l==null?void 0:l.status,name:l==null?void 0:l.name,hint:l==null?void 0:l.hint,details:l==null?void 0:l.details,input:{customerId:e.customer_id,totalAmount:e.total_amount,numberOfInstallments:e.number_of_installments,downPayment:e.down_payment}});let d="Failed to create installment plan.";return(a=l==null?void 0:l.message)!=null&&a.includes("Failed to fetch")||(n=l==null?void 0:l.message)!=null&&n.includes("NetworkError")||(o=l==null?void 0:l.message)!=null&&o.includes("timeout")||(l==null?void 0:l.code)==="NETWORK_ERROR"?d="Network error: Unable to connect to the database. Please check your internet connection and try again.":(l==null?void 0:l.code)==="23505"?d=`Duplicate entry: ${(l==null?void 0:l.hint)||"An installment plan with these details already exists."}`:(l==null?void 0:l.code)==="23502"?d=`Validation error: ${(l==null?void 0:l.hint)||"A required field is missing."}`:(l==null?void 0:l.code)==="23503"?d=`Reference error: ${(l==null?void 0:l.hint)||"Invalid customer or sale reference."}`:(l==null?void 0:l.code)==="23514"?d=`Validation error: ${(l==null?void 0:l.hint)||"Invalid data provided."}`:(l==null?void 0:l.code)==="42501"||(i=l==null?void 0:l.message)!=null&&i.includes("permission denied")?d="Permission denied: You do not have permission to create installment plans.":(c=l==null?void 0:l.code)!=null&&c.startsWith("23")?d=`Database error: ${(l==null?void 0:l.message)||"Invalid data provided."}`:l!=null&&l.message&&(d=l.message),{success:!1,error:d}}}async recordPayment(e,t){try{console.log(" [Installment Payment] Starting payment recording...",{input:e,userId:t});const r=await this.getInstallmentPlanById(e.installment_plan_id);if(!r)return console.error(" [Installment Payment] Plan not found:",e.installment_plan_id),{success:!1,error:"Installment plan not found"};console.log(" [Installment Payment] Plan details:",{planId:r.id,planNumber:r.plan_number,installmentsPaid:r.installments_paid,totalInstallments:r.number_of_installments,totalPaid:r.total_paid,balanceDue:r.balance_due,status:r.status});const{data:a,error:n}=await w.from("installment_payments").select("installment_number").eq("installment_plan_id",e.installment_plan_id).eq("status","paid");n&&console.error(" [Installment Payment] Error fetching existing payments:",n);const o=a?new Set(a.map($=>$.installment_number)):new Set;let i=1;for(let $=1;$<=r.number_of_installments;$++)if(!o.has($)){i=$;break}const c=new Set(a?a.filter($=>$.installment_number>0).map($=>$.installment_number):[]),l=c.size<r.number_of_installments;if(r.status==="cancelled")return console.error(" [Installment Payment] Plan is cancelled"),{success:!1,error:"This installment plan has been cancelled. Payments cannot be recorded."};if(r.status==="completed"&&!l){if(Number(r.balance_due||0)<=0)return console.error(" [Installment Payment] Plan is already completed with no balance"),{success:!1,error:"This installment plan is already completed. No further payments can be recorded."};console.warn(" [Installment Payment] Plan status is completed but balance exists. Allowing payment to fix inconsistency.")}const d=Number(r.balance_due||0),u=Number(e.amount||0);if(u<=0)return console.error(" [Installment Payment] Invalid payment amount:",u),{success:!1,error:"Payment amount must be greater than zero."};if(l&&d<=0)console.warn(" [Installment Payment] Balance is 0 or negative but unpaid installments exist. Allowing payment to fix data inconsistency:",{balanceDue:d,unpaidInstallments:r.number_of_installments-c.size,paymentAmount:u});else if(!l&&u>d&&d>0)return console.error(" [Installment Payment] Payment amount exceeds balance:",{paymentAmount:u,balanceDue:d}),{success:!1,error:`Payment amount (${this.formatCurrency(u)}) cannot exceed the remaining balance (${this.formatCurrency(d)}).`};if(!l)if(d>0)i=r.number_of_installments,console.log(" [Installment Payment] All installments paid, but balance remains. Recording as final payment.");else return console.error(" [Installment Payment] All installments paid and balance is zero"),{success:!1,error:"All installments have been paid and the balance is zero. This plan is complete."};const h=r.next_payment_date;console.log(" [Installment Payment] Recording payment...",{installmentNumber:i,amount:e.amount,paymentMethod:e.payment_method,accountId:e.account_id});const{data:g,error:p}=await w.from("installment_payments").insert({installment_plan_id:e.installment_plan_id,customer_id:e.customer_id,installment_number:i,amount:e.amount,payment_method:e.payment_method,due_date:h,account_id:e.account_id,reference_number:e.reference_number,notes:e.notes,status:"paid",created_by:t}).select().single();if(p)throw console.error(" [Installment Payment] Error inserting payment:",p),p;console.log(" [Installment Payment] Payment recorded:",g);const m=await this.getInstallmentPlanById(e.installment_plan_id);console.log(" [Installment Payment] Updating finance account..."),await this.updateFinanceAccount(e.account_id,e.amount,`Installment payment #${i} for plan ${(m==null?void 0:m.plan_number)||"N/A"}`,e.reference_number||`INS-PAY-${Date.now().toString().slice(-8)}`,"installment_payment",g.id,m==null?void 0:m.branch_id);const _=this.calculateSchedule(h,1,r.payment_frequency);console.log(" [Installment Payment] New payment schedule:",{oldNextPaymentDate:r.next_payment_date,newNextPaymentDate:_.nextPaymentDate});const b=await this.getInstallmentPlanById(e.installment_plan_id),S=new Set(a?a.filter($=>$.installment_number>0).map($=>$.installment_number):[]);S.add(i);const v=S.size>=r.number_of_installments,C=b&&Number(b.balance_due||0)<=0,T=v&&C;let x=!0;for(let $=1;$<=r.number_of_installments;$++)if(!S.has($)){x=!1;break}const R=T&&x,k={updated_at:new Date().toISOString()};R?(k.next_payment_date=r.end_date,k.completion_date=new Date().toISOString().split("T")[0],k.status="completed"):(k.next_payment_date=_.nextPaymentDate,R||!(b&&Number(b.installments_paid||0)>=r.number_of_installments&&Number(b.balance_due||0)<=0)&&r.status==="completed"&&(k.status="active",k.completion_date=null,console.log(" [Installment Payment] Resetting status from completed to active - not all installments paid"))),console.log(" [Installment Payment] Updating plan:",k),console.log("  [Installment Payment] Note: total_paid, balance_due, and installments_paid are auto-updated by database trigger");const{error:P}=await w.from("customer_installment_plans").update(k).eq("id",e.installment_plan_id);if(P)throw console.error(" [Installment Payment] Error updating plan:",P),P;console.log(" [Installment Payment] Plan next payment date updated successfully!"),console.log(" [Installment Payment] Database trigger will automatically update payment tracking fields"),console.log(" [Installment Payment] Sending notification..."),await this.sendPaymentReceivedNotification(e.installment_plan_id,e.amount,t),console.log(" [Installment Payment] Payment process completed successfully!");const O=await this.getInstallmentPlanById(e.installment_plan_id),N=(O==null?void 0:O.status)==="completed";return N&&O&&(console.log(" [Installment Payment] Plan completed! Will send completion notification with PDF receipt in 6 seconds..."),setTimeout(async()=>{try{await this.sendCompletionNotificationWithReceipt(O,t)}catch($){console.error(" [Installment Completion] Error sending completion notification:",$)}},6e3)),{success:!0,payment:g,planCompleted:N||!1}}catch(r){return console.error(" [Installment Payment] Error recording installment payment:",r),console.error(" [Installment Payment] Error details:",r.message),console.error(" [Installment Payment] Error stack:",r.stack),{success:!1,error:r.message}}}async getAllInstallmentPlans(e){try{let t=w.from("customer_installment_plans").select(`
          *,
          customer:customers!customer_id(id, name, phone, email)
        `).order("created_at",{ascending:!1});e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;const n=[...new Set((r||[]).map(c=>c.sale_id).filter(Boolean))];let o=new Map;if(n.length>0){const{data:c,error:l}=await w.from("lats_sales").select("id, sale_number, total_amount").in("id",n);!l&&c&&(o=new Map(c.map(d=>[d.id,d])))}return(r||[]).map(c=>({...c,total_amount:Number(c.total_amount||0),down_payment:Number(c.down_payment||0),amount_financed:Number(c.amount_financed||0),total_paid:Number(c.total_paid||0),balance_due:Number(c.balance_due||0),installment_amount:Number(c.installment_amount||0),number_of_installments:Number(c.number_of_installments||0),installments_paid:Number(c.installments_paid||0),late_fee_amount:Number(c.late_fee_amount||0),late_fee_applied:Number(c.late_fee_applied||0),days_overdue:Number(c.days_overdue||0),reminder_count:Number(c.reminder_count||0),sale:c.sale_id&&o.get(c.sale_id)||null}))}catch(t){return console.error("Error fetching installment plans:",t),[]}}async getInstallmentPlanById(e){try{const{data:t,error:r}=await w.from("customer_installment_plans").select(`
          *,
          customer:customers!customer_id(id, name, phone, email)
        `).eq("id",e).single();if(r)throw r;let a=null;if(t.sale_id){const{data:i}=await w.from("lats_sales").select("id, sale_number, total_amount").eq("id",t.sale_id).single();a=i||null}const{data:n}=await w.from("installment_payments").select("*").eq("installment_plan_id",e).order("created_at",{ascending:!0});return{...t,total_amount:Number(t.total_amount||0),down_payment:Number(t.down_payment||0),amount_financed:Number(t.amount_financed||0),total_paid:Number(t.total_paid||0),balance_due:Number(t.balance_due||0),installment_amount:Number(t.installment_amount||0),number_of_installments:Number(t.number_of_installments||0),installments_paid:Number(t.installments_paid||0),late_fee_amount:Number(t.late_fee_amount||0),late_fee_applied:Number(t.late_fee_applied||0),days_overdue:Number(t.days_overdue||0),reminder_count:Number(t.reminder_count||0),sale:a,payments:n||[]}}catch(t){return console.error("Error fetching installment plan:",t),null}}async getCustomerInstallmentPlans(e){try{const{data:t,error:r}=await w.from("customer_installment_plans").select("*").eq("customer_id",e).order("created_at",{ascending:!1});if(r)throw r;return t||[]}catch(t){return console.error("Error fetching customer installment plans:",t),[]}}async getPaymentSchedule(e){var t;try{const r=await this.getInstallmentPlanById(e);if(!r)return[];const a=[],n=new Date(r.start_date);let o;switch(r.payment_frequency){case"weekly":o=7;break;case"bi_weekly":o=14;break;case"monthly":o=30;break;default:o=30}for(let i=1;i<=r.number_of_installments;i++){const c=new Date(n);c.setDate(c.getDate()+o*i);const l=(t=r.payments)==null?void 0:t.find(h=>h.installment_number===i),d=new Date;d.setHours(0,0,0,0);let u="pending";(l==null?void 0:l.status)==="paid"?u="paid":c<d&&(u="overdue"),a.push({installment_number:i,due_date:c.toISOString().split("T")[0],amount:r.installment_amount,status:u,paid_date:l==null?void 0:l.payment_date,paid_amount:l==null?void 0:l.amount})}return a}catch(r){return console.error("Error getting payment schedule:",r),[]}}async getStatistics(e){try{let t=w.from("customer_installment_plans").select("*");e&&(t=t.eq("branch_id",e));const{data:r,error:a}=await t;if(a)throw a;const n=r||[],o=new Date,i=new Date(o);i.setDate(i.getDate()+7);const c=new Date(o);return c.setDate(c.getDate()+30),{total:n.length,active:n.filter(d=>d.status==="active").length,completed:n.filter(d=>d.status==="completed").length,defaulted:n.filter(d=>d.status==="defaulted").length,cancelled:n.filter(d=>d.status==="cancelled").length,total_value:n.reduce((d,u)=>d+Number(u.total_amount||0),0),total_paid:n.reduce((d,u)=>d+Number(u.total_paid||0),0),total_balance_due:n.reduce((d,u)=>d+Number(u.balance_due||0),0),overdue_count:n.filter(d=>{const u=new Date(d.next_payment_date);return d.status==="active"&&u<o}).length,due_this_week:n.filter(d=>{const u=new Date(d.next_payment_date);return d.status==="active"&&u>=o&&u<=i}).length,due_this_month:n.filter(d=>{const u=new Date(d.next_payment_date);return d.status==="active"&&u>=o&&u<=c}).length}}catch(t){return console.error("Error calculating statistics:",t),{total:0,active:0,completed:0,defaulted:0,cancelled:0,total_value:0,total_paid:0,total_balance_due:0,overdue_count:0,due_this_week:0,due_this_month:0}}}async sendPaymentReminder(e,t){try{const r=await this.getInstallmentPlanById(e);if(!r||!r.customer)return{success:!1,error:"Plan or customer not found"};const a=Math.ceil((new Date(r.next_payment_date).getTime()-new Date().getTime())/(1e3*60*60*24));return await w.from("customer_installment_plans").update({last_reminder_sent:new Date().toISOString(),reminder_count:r.reminder_count+1}).eq("id",e),{success:!0}}catch(r){return console.error("Error sending payment reminder:",r),{success:!1,error:r.message}}}async cancelPlan(e){try{const{error:t}=await w.from("customer_installment_plans").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e);if(t)throw t;return{success:!0}}catch(t){return console.error("Error cancelling plan:",t),{success:!1,error:t.message}}}async updateInstallmentPlan(e,t){try{const{data:r,error:a}=await w.from("customer_installment_plans").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return{success:!0,plan:await this.getInstallmentPlanById(e)||void 0}}catch(r){return console.error("Error updating installment plan:",r),{success:!1,error:r.message}}}async updateFinanceAccount(e,t,r,a,n,o,i){try{const{data:c,error:l}=await w.from("finance_accounts").select("balance, branch_id").eq("id",e).single();if(l||!c){console.error("Error fetching finance account:",l);return}const d=Number(c.balance),u=d+t,h=await this.getValidBranchId(i||c.branch_id),{error:g}=await w.from("finance_accounts").update({balance:u,updated_at:new Date().toISOString()}).eq("id",e);if(g){console.error("Error updating finance account:",g);return}const{error:p}=await w.from("account_transactions").insert({account_id:e,transaction_type:t>0?"income":"expense",amount:Math.abs(t),balance_before:d,balance_after:u,description:r||`Installment payment: ${t>0?"Received":"Paid"} ${Math.abs(t)}`,reference_number:a||`INS-${Date.now().toString().slice(-8)}`,related_entity_type:n||"installment_payment",related_entity_id:o,branch_id:h,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});p?console.error("Error creating account transaction:",p):console.log(" Account transaction recorded successfully")}catch(c){console.error("Error in updateFinanceAccount:",c)}}async sendPlanCreatedNotification(e,t){try{const r=await this.getInstallmentPlanById(e);if(!r||!r.customer)return;try{await w.from("notifications").insert({user_id:t,type:"payment",category:"payment",title:"Installment Plan Created",message:`Plan ${r.plan_number} for ${r.customer.name}`,priority:"normal",status:"unread",metadata:{planId:r.id,planNumber:r.plan_number}})}catch(a){console.error("Error creating notification:",a)}}catch(r){console.error("Error sending plan created notification:",r)}}async sendPaymentReceivedNotification(e,t,r){try{const a=await this.getInstallmentPlanById(e);if(!a||!a.customer){console.warn(" [Installment Payment] Cannot send notification: Plan or customer not found");return}try{await w.from("notifications").insert({user_id:r,type:"payment",category:"payment",title:"Installment Payment Received",message:`${this.formatCurrency(t)} received for plan ${a.plan_number}`,priority:"normal",status:"unread",metadata:{planId:a.id,amount:t}})}catch(n){console.error("Error creating in-app notification:",n)}if(!a.customer.phone){console.warn(" [Installment Payment] Customer has no phone number, skipping WhatsApp notification");return}try{const{notificationSettingsService:n}=await z(()=>import("./notificationSettingsService-1df2b297.js"),["assets/notificationSettingsService-1df2b297.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js","assets/routing-eb8c310c.js"]),o=n.getSettings();if(!(o.whatsappEnabled&&o.whatsappAutoSend||o.smsEnabled&&o.smsAutoSend)){console.log(" [Installment Payment] Auto-send notifications disabled in settings");return}let c="inauzwa",l="";try{const{businessInfoService:p}=await z(()=>Promise.resolve().then(()=>In),void 0),m=await p.getBusinessInfo();c=m.name||"inauzwa",l=m.phone||""}catch{console.warn(" Could not load business info for payment notification, using defaults")}let d="";if(l)try{const{formatContactForMessage:p}=await z(()=>import("./formatPhoneForInvoice-e7084c6d.js").then(m=>m.b),[]);d=p(l)}catch(p){console.warn(" Could not format contact, using raw phone:",p),d=l}const u=` Payment Received!

 Plan: ${a.plan_number}
 Amount Paid: ${this.formatCurrency(t)}
 Total Paid: ${this.formatCurrency(a.total_paid)}
 Balance Due: ${this.formatCurrency(a.balance_due)}
 Payment Date: ${new Date().toLocaleDateString()}

Thank you for your payment! 

`+(d?` Contact: ${d}
`:""),{smartNotificationService:h}=await z(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]);console.log(" [Installment Payment] Sending payment notification to customer...");const g=await h.sendNotification(a.customer.phone,u);g.success?console.log(` [Installment Payment] Notification sent via ${g.method} to ${a.customer.phone}`):console.warn(` [Installment Payment] Notification failed: ${g.error}`)}catch(n){console.error(" [Installment Payment] Error sending customer notification:",n)}}catch(a){console.error(" [Installment Payment] Error in payment notification:",a)}}async sendCompletionNotificationWithReceipt(e,t){try{if(!e.customer||!e.customer.phone){console.warn(" [Installment Completion] Cannot send notification: Customer or phone not found");return}const{notificationSettingsService:r}=await z(()=>import("./notificationSettingsService-1df2b297.js"),["assets/notificationSettingsService-1df2b297.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js","assets/routing-eb8c310c.js"]),a=r.getSettings();if(!(a.whatsappEnabled&&a.whatsappAutoSend||a.smsEnabled&&a.smsAutoSend)){console.log(" [Installment Completion] Auto-send notifications disabled in settings");return}let o="inauzwa",i="",c="",l="";try{const{businessInfoService:h}=await z(()=>Promise.resolve().then(()=>In),void 0),g=await h.getBusinessInfo();o=g.name||"inauzwa",i=g.phone||"",c=g.logo||"",l=g.address||""}catch{console.warn(" Could not load business info for completion notification, using defaults")}let d="";if(i)try{const{formatContactForMessage:h}=await z(()=>import("./formatPhoneForInvoice-e7084c6d.js").then(g=>g.b),[]);d=h(i)}catch{d=i}const u=` Congratulations! Your installment plan is now complete!

 Plan: ${e.plan_number}
 Total Amount: ${this.formatCurrency(e.total_amount)}
 Total Paid: ${this.formatCurrency(e.total_paid)}
 Completion Date: ${new Date().toLocaleDateString()}

Thank you for completing all payments! 

Please find your receipt attached.

`+(d?` Contact: ${d}
`:"");try{const[h,g]=await Promise.all([this.generateInstallmentReceiptPDF(e,{businessName:o,businessPhone:d,businessAddress:l,businessLogo:c}),this.generateInstallmentReceiptPNG(e,{businessName:o,businessPhone:d,businessAddress:l,businessLogo:c})]),{default:p}=await z(()=>import("./whatsappService-09f99080.js"),["assets/whatsappService-09f99080.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]);let m,_=3,b=6e3,S=!0;for(;_>0;){const v=S?g:h,C=S?"image":"document",T=S?`Receipt for Installment Plan ${e.plan_number}`:`Receipt for Installment Plan ${e.plan_number}`;if(m=await p.sendMessage(e.customer.phone,u,{message_type:C,media_url:v,caption:T}),m.success){console.log(` [Installment Completion] ${S?"PNG":"PDF"} receipt sent via WhatsApp to ${e.customer.phone}`);break}const x=m.error&&(m.error.includes("429")||m.error.includes("rate limit")||m.error.includes("too many")||m.error.includes("account protection")||m.error.includes("5 seconds"));if(x&&_>0)_--,console.warn(` [Installment Completion] Rate limited. Retrying in ${b/1e3} seconds... (${_} retries left)`),await new Promise(R=>setTimeout(R,b)),b*=2;else if(S&&!x)console.warn(` [Installment Completion] PNG failed, trying PDF: ${m.error}`),S=!1,_=3,b=6e3;else break}if(!m.success){console.warn(` [Installment Completion] Both PNG and PDF failed, sending text message: ${m.error}`);const{smartNotificationService:v}=await z(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]);await v.sendNotification(e.customer.phone,u)}}catch(h){console.error(" [Installment Completion] Error generating receipt, sending text message only:",h);const{smartNotificationService:g}=await z(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]);await g.sendNotification(e.customer.phone,u)}}catch(r){console.error(" [Installment Completion] Error sending completion notification:",r)}}async generateInstallmentReceiptPDF(e,t){var c,l;const{default:r}=await z(()=>import("./pdf-e6e38bab.js").then(d=>d.j),["assets/pdf-e6e38bab.js","assets/supabase-cf010ec4.js"]),a=new r,n=a.internal.pageSize.getWidth(),o=20;let i=o;return a.setFontSize(18),a.setFont("helvetica","bold"),a.text("INSTALLMENT PLAN RECEIPT",o,i),i+=10,a.setFontSize(12),a.setFont("helvetica","bold"),a.text(t.businessName,o,i),i+=6,a.setFontSize(10),a.setFont("helvetica","normal"),t.businessAddress&&(a.text(t.businessAddress,o,i),i+=5),t.businessPhone&&(a.text(`Phone: ${t.businessPhone}`,o,i),i+=5),i+=5,a.setDrawColor(200,200,200),a.setLineWidth(.5),a.line(o,i,n-o,i),i+=8,a.setFontSize(10),a.setFont("helvetica","bold"),a.text("Plan Information:",o,i),i+=6,a.setFont("helvetica","normal"),a.text(`Plan Number: ${e.plan_number}`,o,i),i+=5,a.text(`Customer: ${((c=e.customer)==null?void 0:c.name)||"N/A"}`,o,i),i+=5,a.text(`Phone: ${((l=e.customer)==null?void 0:l.phone)||"N/A"}`,o,i),i+=5,a.text(`Completion Date: ${e.completion_date?new Date(e.completion_date).toLocaleDateString():new Date().toLocaleDateString()}`,o,i),i+=8,a.setFont("helvetica","bold"),a.text("Payment Summary:",o,i),i+=6,a.setFont("helvetica","normal"),a.text(`Total Amount: ${this.formatCurrency(e.total_amount)}`,o,i),i+=5,a.text(`Down Payment: ${this.formatCurrency(e.down_payment||0)}`,o,i),i+=5,a.text(`Number of Installments: ${e.number_of_installments}`,o,i),i+=5,a.text(`Total Paid: ${this.formatCurrency(e.total_paid)}`,o,i),i+=5,a.text(`Balance Due: ${this.formatCurrency(e.balance_due)}`,o,i),i+=8,e.payments&&e.payments.length>0&&(a.setFont("helvetica","bold"),a.text("Payment History:",o,i),i+=6,a.setFontSize(9),a.setFont("helvetica","normal"),e.payments.forEach((d,u)=>{i>a.internal.pageSize.getHeight()-30&&(a.addPage(),i=o);const h=d.payment_date||d.created_at||"",g=d.installment_number===0?"Down Payment":`Installment #${d.installment_number}`;a.text(`${g}: ${this.formatCurrency(d.amount)} - ${h?new Date(h).toLocaleDateString():"N/A"}`,o+5,i),i+=5}),i+=5),i=a.internal.pageSize.getHeight()-30,a.setDrawColor(200,200,200),a.line(o,i,n-o,i),i+=8,a.setFontSize(9),a.setFont("helvetica","italic"),a.text("Thank you for your business!",o,i),i+=5,a.text(`Generated on ${new Date().toLocaleString()}`,o,i),a.output("dataurlstring")}async generateInstallmentReceiptPNG(e,t){var n,o;const r=`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: white;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
          }
          .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #10b981;
            padding-bottom: 20px;
          }
          .header h1 {
            font-size: 24px;
            color: #10b981;
            margin-bottom: 10px;
          }
          .business-info {
            margin-bottom: 20px;
          }
          .business-info h2 {
            font-size: 18px;
            margin-bottom: 8px;
          }
          .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
          }
          .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
          }
          .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
          }
          .info-row:last-child {
            border-bottom: none;
          }
          .info-label {
            font-weight: 600;
            color: #6b7280;
          }
          .info-value {
            color: #1f2937;
            text-align: right;
          }
          .payment-history {
            margin-top: 15px;
          }
          .payment-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #10b981;
          }
          .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-style: italic;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>INSTALLMENT PLAN RECEIPT</h1>
        </div>
        
        <div class="business-info">
          <h2>${t.businessName}</h2>
          ${t.businessAddress?`<p>${t.businessAddress}</p>`:""}
          ${t.businessPhone?`<p>Phone: ${t.businessPhone}</p>`:""}
        </div>
        
        <div class="section">
          <div class="section-title">Plan Information</div>
          <div class="info-row">
            <span class="info-label">Plan Number:</span>
            <span class="info-value">${e.plan_number}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Customer:</span>
            <span class="info-value">${((n=e.customer)==null?void 0:n.name)||"N/A"}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Phone:</span>
            <span class="info-value">${((o=e.customer)==null?void 0:o.phone)||"N/A"}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Completion Date:</span>
            <span class="info-value">${e.completion_date?new Date(e.completion_date).toLocaleDateString():new Date().toLocaleDateString()}</span>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Payment Summary</div>
          <div class="info-row">
            <span class="info-label">Total Amount:</span>
            <span class="info-value">${this.formatCurrency(e.total_amount)}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Down Payment:</span>
            <span class="info-value">${this.formatCurrency(e.down_payment||0)}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Number of Installments:</span>
            <span class="info-value">${e.number_of_installments}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Total Paid:</span>
            <span class="info-value">${this.formatCurrency(e.total_paid)}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Balance Due:</span>
            <span class="info-value">${this.formatCurrency(e.balance_due)}</span>
          </div>
        </div>
        
        ${e.payments&&e.payments.length>0?`
        <div class="section">
          <div class="section-title">Payment History</div>
          <div class="payment-history">
            ${e.payments.map(i=>{const c=i.payment_date||i.created_at||"";return`
                <div class="payment-item">
                  <div class="info-row">
                    <span class="info-label">${i.installment_number===0?"Down Payment":`Installment #${i.installment_number}`}</span>
                    <span class="info-value">${this.formatCurrency(i.amount)}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Date:</span>
                    <span class="info-value">${c?new Date(c).toLocaleDateString():"N/A"}</span>
                  </div>
                </div>
              `}).join("")}
          </div>
        </div>
        `:""}
        
        <div class="footer">
          <p>Thank you for your business! </p>
          <p>Generated on ${new Date().toLocaleString()}</p>
        </div>
      </body>
      </html>
    `,a=document.createElement("div");a.style.position="absolute",a.style.left="-9999px",a.style.width="800px",a.innerHTML=r,document.body.appendChild(a);try{const{default:i}=await z(()=>import("./html2canvas.esm-6bd083a4.js"),[]),l=(await i(a,{scale:2,backgroundColor:"#ffffff",width:800,useCORS:!0,allowTaint:!0})).toDataURL("image/png",1);return document.body.removeChild(a),l}catch(i){throw a.parentNode&&document.body.removeChild(a),i}}formatCurrency(e){return new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e)}formatDate(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}}const Zb=new Xb,So="1.0",ew=15*60*1e3,pl=class Na{getCacheKey(e){return`${Na.INSTALLMENTS_KEY_PREFIX}${e||"default"}`}saveInstallments(e,t){try{const r={data:e,timestamp:Date.now(),version:So,branchId:t};localStorage.setItem(this.getCacheKey(t),JSON.stringify(r))}catch(r){console.warn(" [InstallmentCache] Failed to save installments:",r)}}getInstallments(e){try{const t=localStorage.getItem(this.getCacheKey(e));if(!t)return null;const r=JSON.parse(t);return r.version!==So?(this.clearInstallments(e),null):e&&r.branchId&&r.branchId!==e?(this.clearInstallments(r.branchId),null):Date.now()-r.timestamp>ew?(this.clearInstallments(e),null):r.data}catch(t){return console.warn(" [InstallmentCache] Failed to read installments cache:",t),null}}clearInstallments(e){localStorage.removeItem(this.getCacheKey(e))}clearAll(){Object.keys(localStorage).forEach(t=>{t.startsWith(Na.INSTALLMENTS_KEY_PREFIX)&&localStorage.removeItem(t)})}hasValidCache(e){return this.getInstallments(e)!==null}};pl.INSTALLMENTS_KEY_PREFIX="pos_installments_cache_";let tw=pl;const La=new tw,bS=Object.freeze(Object.defineProperty({__proto__:null,installmentCacheService:La},Symbol.toStringTag,{value:"Module"})),rw=()=>{const{currentUser:s}=Lt(),{currentBranch:e}=id(),t=D.useRef(!1),r=D.useRef(!1),a=D.useRef(0),n=D.useRef([]),o=async(i=!1)=>{if(r.current){console.log(" [InstallmentPreloader] Background load already in progress, skipping");return}if(!(e!=null&&e.id)){console.log(" [InstallmentPreloader] No branch selected, skipping");return}const c=Date.now();if(!i&&c-a.current<3e4){console.log(" [InstallmentPreloader] Throttled - too soon since last load");return}r.current=!0,a.current=c;try{console.log(" [InstallmentPreloader] Background loading installment plans...");const l=await Zb.getAllInstallmentPlans(e.id);n.current=l,console.log(` [InstallmentPreloader] Background load completed (${l.length} plans)`),La.saveInstallments(l,e.id)}catch(l){console.error(" [InstallmentPreloader] Background load failed:",l)}finally{r.current=!1}};return D.useEffect(()=>{if(!s){console.log(" [InstallmentPreloader] User not authenticated, skipping preload");return}if(!(e!=null&&e.id)){console.log(" [InstallmentPreloader] No branch selected, skipping preload");return}const c=setTimeout(async()=>{try{console.log(" [InstallmentPreloader] Initializing installment preload...");const l=La.getInstallments(e.id);l&&l.length>0?(console.log(` [InstallmentPreloader] Found ${l.length} cached installment plans - instant display ready`),n.current=l,t.current=!0,setTimeout(()=>{o(!1)},2e3)):(console.log(" [InstallmentPreloader] No cache found, loading from database..."),await o(!1),t.current=!0)}catch(l){console.error(" [InstallmentPreloader] Failed to initialize installments:",l)}},100);return()=>clearTimeout(c)},[s,e==null?void 0:e.id]),D.useEffect(()=>{if(!s||!(e!=null&&e.id))return;t.current=!1,n.current=[];const c=setTimeout(async()=>{console.log(` [InstallmentPreloader] Branch changed to ${e.id}, loading installments...`),await o(!1),t.current=!0},500);return()=>clearTimeout(c)},[e==null?void 0:e.id,s]),D.useEffect(()=>{if(!s||!(e!=null&&e.id))return;const i=setInterval(()=>{console.log(" [InstallmentPreloader] Periodic background refresh triggered"),o(!0)},15*60*1e3);return()=>clearInterval(i)},[s,e==null?void 0:e.id]),D.useEffect(()=>{if(!s||!(e!=null&&e.id))return;const i=()=>{document.visibilityState==="visible"&&Date.now()-a.current>6e4&&(console.log(" [InstallmentPreloader] App became visible - refreshing installments in background"),o(!1))};return document.addEventListener("visibilitychange",i),()=>{document.removeEventListener("visibilitychange",i)}},[s,e==null?void 0:e.id]),D.useEffect(()=>{if(!s||!(e!=null&&e.id))return;const i=()=>{Date.now()-a.current>12e4&&(console.log(" [InstallmentPreloader] Window focused - refreshing installments in background"),o(!1))};return window.addEventListener("focus",i),()=>{window.removeEventListener("focus",i)}},[s,e==null?void 0:e.id]),null},sw=({children:s})=>(D.useEffect(()=>{(async()=>{try{({}).VITE_DEBUG&&console.log(" POS Settings initialized")}catch(t){console.error(" Error initializing POS settings:",t)}})()},[]),f.jsx(f.Fragment,{children:s})),aw=(s=[],e={})=>{const{enabled:t=!0,enableInInputs:r=!1}=e,a=D.useRef(s);D.useEffect(()=>{a.current=s},[s]);const n=D.useCallback(o=>{if(!t)return;const i=o.target;if((i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.tagName==="SELECT"||i.isContentEditable)&&!r){const l=["Escape","s","z","y"];if(!o.key||!l.includes(o.key.toLowerCase())||!(o.metaKey||o.ctrlKey||o.key==="Escape"))return}if(!(!a.current||!Array.isArray(a.current))&&o.key)for(const l of a.current){if(!l.key)continue;const d=o.key.toLowerCase()===l.key.toLowerCase(),u=!l.ctrl||o.ctrlKey,h=!l.alt||o.altKey,g=!l.shift||o.shiftKey,p=!l.meta||o.metaKey;if(d&&u&&h&&g&&p){l.preventDefault!==!1&&o.preventDefault(),l.action(o);break}}},[t,r]);return D.useEffect(()=>{if(t)return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[t,n]),{shortcuts:a.current}};class nw{constructor(){this.tableName="lats_store_rooms"}async getAll(){try{const{data:e,error:t}=await w.from(this.tableName).select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}catch(e){throw console.error("Error fetching storage rooms:",e),e}}async getById(e){try{const{data:t,error:r}=await w.from(this.tableName).select("*").eq("id",e).single();if(r)throw r;return t}catch(t){throw console.error("Error fetching storage room:",t),t}}async getByStoreLocation(e){try{const{data:t,error:r}=await w.from(this.tableName).select("*").eq("store_location_id",e).order("name",{ascending:!0});if(r)throw r;return t||[]}catch(t){throw console.error("Error fetching storage rooms by location:",t),t}}async create(e){try{const{data:t,error:r}=await w.from(this.tableName).insert([e]).select().single();if(r)throw r;return t}catch(t){throw console.error("Error creating storage room:",t),t}}async update(e){try{const{id:t,...r}=e,{data:a,error:n}=await w.from(this.tableName).update(r).eq("id",t).select().single();if(n)throw n;return a}catch(t){throw console.error("Error updating storage room:",t),t}}async delete(e){try{const{error:t}=await w.from(this.tableName).delete().eq("id",e);if(t)throw t}catch(t){throw console.error("Error deleting storage room:",t),t}}async getActive(){try{const{data:e,error:t}=await w.from(this.tableName).select("*").eq("is_active",!0).order("name",{ascending:!0});if(t)throw t;return e||[]}catch(e){throw console.error("Error fetching active storage rooms:",e),e}}async getSecure(){try{const{data:e,error:t}=await w.from(this.tableName).select("*").eq("is_secure",!0).order("name",{ascending:!0});if(t)throw t;return e||[]}catch(e){throw console.error("Error fetching secure storage rooms:",e),e}}async updateCapacity(e,t){try{const{error:r}=await w.from(this.tableName).update({current_capacity:t}).eq("id",e);if(r)throw r}catch(r){throw console.error("Error updating storage room capacity:",r),r}}async search(e){try{const{data:t,error:r}=await w.from(this.tableName).select("*").or(`name.ilike.%${e}%,code.ilike.%${e}%,description.ilike.%${e}%`).order("name",{ascending:!0});if(r)throw r;return t||[]}catch(t){throw console.error("Error searching storage rooms:",t),t}}async getStats(){try{const{data:e,error:t}=await w.from(this.tableName).select("is_active, is_secure, max_capacity, current_capacity");if(t)throw t;return{total:(e==null?void 0:e.length)||0,active:(e==null?void 0:e.filter(a=>a.is_active).length)||0,secure:(e==null?void 0:e.filter(a=>a.is_secure).length)||0,totalCapacity:(e==null?void 0:e.reduce((a,n)=>a+(n.max_capacity||0),0))||0,usedCapacity:(e==null?void 0:e.reduce((a,n)=>a+(n.current_capacity||0),0))||0}}catch(e){throw console.error("Error fetching storage room stats:",e),e}}}const ow=new nw;class iw{constructor(){this.tableName="lats_store_shelves"}async getAll(e){let t=w.from(this.tableName).select(`
        *,
        store_location:lats_store_locations(name, code, city)
      `).order("priority_order",{ascending:!0}).order("name",{ascending:!0});e&&(e.search&&(t=t.or(`name.ilike.%${e.search}%,code.ilike.%${e.search}%,section.ilike.%${e.search}%`)),e.store_location_id&&(t=t.eq("store_location_id",e.store_location_id)),e.storage_room_id&&(t=t.eq("storage_room_id",e.storage_room_id)),e.shelf_type&&(t=t.eq("shelf_type",e.shelf_type)),e.section&&(t=t.eq("section",e.section)),e.zone&&(t=t.eq("zone",e.zone)),e.is_active!==void 0&&(t=t.eq("is_active",e.is_active)),e.is_accessible!==void 0&&(t=t.eq("is_accessible",e.is_accessible)),e.is_refrigerated!==void 0&&(t=t.eq("is_refrigerated",e.is_refrigerated)),e.requires_ladder!==void 0&&(t=t.eq("requires_ladder",e.requires_ladder)));const{data:r,error:a}=await t;if(a)throw new Error(`Failed to fetch store shelves: ${a.message}`);return r||[]}async getById(e){const{data:t,error:r}=await w.from(this.tableName).select(`
        *,
        store_location:lats_store_locations(name, code, city)
      `).eq("id",e).single();if(r){if(r.code==="PGRST116")return null;throw new Error(`Failed to fetch store shelf: ${r.message}`)}return t}async getByCode(e){const{data:t,error:r}=await w.from(this.tableName).select(`
        *,
        store_location:lats_store_locations(name, code, city)
      `).eq("code",e).single();if(r){if(r.code==="PGRST116")return null;throw new Error(`Failed to fetch store shelf: ${r.message}`)}return t}async getShelvesByLocation(e){const{data:t,error:r}=await w.from(this.tableName).select("*").eq("store_location_id",e).eq("is_active",!0).order("priority_order",{ascending:!0}).order("name",{ascending:!0});if(r)throw new Error(`Failed to fetch shelves for location: ${r.message}`);return t||[]}async getShelvesByStorageRoom(e){const{data:t,error:r}=await w.from(this.tableName).select("*").eq("storage_room_id",e).eq("is_active",!0).order("row_number",{ascending:!0}).order("column_number",{ascending:!0});if(r)throw new Error(`Failed to fetch shelves for storage room: ${r.message}`);return t||[]}async create(e){var a,n,o;const{data:t,error:r}=await w.from(this.tableName).insert([{...e,created_by:(a=(await w.auth.getUser()).data.user)==null?void 0:a.id,updated_by:(n=(await w.auth.getUser()).data.user)==null?void 0:n.id}]).select().single();if(r)throw r.code==="23505"||(o=r.message)!=null&&o.includes("duplicate")?new Error(`Shelf with code "${e.code}" already exists in this location`):new Error(`Failed to create store shelf: ${r.message}`);return t}async update(e,t){var n;const{data:r,error:a}=await w.from(this.tableName).update({...t,updated_by:(n=(await w.auth.getUser()).data.user)==null?void 0:n.id}).eq("id",e).select().single();if(a)throw new Error(`Failed to update store shelf: ${a.message}`);return r}async delete(e){const{error:t}=await w.from(this.tableName).delete().eq("id",e);if(t)throw new Error(`Failed to delete store shelf: ${t.message}`)}async updateCapacity(e,t){var n;const{data:r,error:a}=await w.from(this.tableName).update({current_capacity:t,updated_by:(n=(await w.auth.getUser()).data.user)==null?void 0:n.id}).eq("id",e).select().single();if(a)throw new Error(`Failed to update shelf capacity: ${a.message}`);return r}async moveProductToShelf(e,t){const r=await this.getByCode(t);if(!r)throw new Error(`Shelf with code ${t} not found`);const{error:a}=await w.from("lats_products").update({store_shelf:t}).eq("id",e);if(a)throw new Error(`Failed to move product to shelf: ${a.message}`);await this.updateCapacity(r.id,r.current_capacity+1)}async getStats(e){const t=await this.getAll(e),r=t.length,a=t.filter(u=>u.is_active).length,n=t.reduce((u,h)=>u+(h.max_capacity||0),0),o=t.reduce((u,h)=>u+h.current_capacity,0),i=n>0?o/n*100:0,c=t.filter(u=>u.is_refrigerated).length,l=t.filter(u=>u.shelf_type==="display").length,d=t.filter(u=>u.shelf_type==="storage").length;return{total_shelves:r,active_shelves:a,total_capacity:n,used_capacity:o,utilization_percentage:Math.round(i*100)/100,refrigerated_shelves:c,display_shelves:l,storage_shelves:d}}async generateShelfCode(e,t){const r=await this.getShelvesByLocation(e),a=t?r.filter(l=>l.section===t):r,n=t?`${t.toUpperCase().substring(0,3)}`:"SHELF",o=a.map(l=>l.code);let i=1,c=`${n}${i.toString().padStart(3,"0")}`;for(;o.includes(c);)i++,c=`${n}${i.toString().padStart(3,"0")}`;return c}}const cw=new iw,lw=({isOpen:s,storageRooms:e,selectedRoomId:t,onChangeRoom:r,searchTerm:a,onChangeSearch:n,shelvesByRoom:o,onSelect:i,onClose:c})=>{var d;if(!s)return null;const l=()=>{if(!t)return[];const u=o[t]||[];if(!a.trim())return u;const h=a.toLowerCase();return u.filter(g=>g.code.toLowerCase().includes(h)||g.name&&g.name.toLowerCase().includes(h)||g.row_number&&g.row_number.toString().includes(h)||g.column_number&&g.column_number.toString().includes(h))};return f.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",onClick:c,children:f.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col",onClick:u=>u.stopPropagation(),children:[f.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[f.jsxs("div",{children:[f.jsx("h4",{className:"text-lg font-bold text-gray-900",children:"Select Storage Location"}),f.jsx("p",{className:"text-sm text-gray-500",children:"Choose a storage room and shelf position."})]}),f.jsx("button",{onClick:c,className:"w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors",children:f.jsx(Co,{className:"w-4 h-4"})})]}),f.jsxs("div",{className:"flex flex-col md:flex-row",children:[f.jsxs("div",{className:"md:w-72 border-b md:border-b-0 md:border-r border-gray-200",children:[f.jsx("div",{className:"p-4 border-b border-gray-200",children:f.jsx("input",{type:"search",value:a,onChange:u=>n(u.target.value),placeholder:"Search shelves, codes, rows...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"})}),f.jsx("div",{className:"max-h-80 overflow-y-auto",children:e.length===0?f.jsx("div",{className:"p-4 text-sm text-gray-500",children:"No storage rooms found."}):e.map(u=>{const h=t===u.id;return f.jsxs("button",{onClick:()=>r(u.id),className:`w-full text-left px-4 py-3 border-l-4 transition-colors ${h?"border-orange-500 bg-orange-50 text-orange-700 font-semibold":"border-transparent hover:bg-gray-50 text-gray-700"}`,children:[f.jsx("div",{className:"text-sm",children:u.name||u.code}),f.jsxs("div",{className:"text-xs text-gray-500",children:["Floor ",u.floor_level,"  ",u.code]})]},u.id)})})]}),f.jsx("div",{className:"flex-1",children:f.jsxs("div",{className:"p-4",children:[f.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:t?`Shelves in ${((d=e.find(u=>u.id===t))==null?void 0:d.name)||"selected room"}`:"Select a storage room"}),f.jsx("div",{className:"max-h-[320px] overflow-y-auto border border-gray-100 rounded-xl p-3 bg-gray-50",children:t?(()=>{const u=l();return u.length===0?f.jsx("div",{className:"py-12 text-center text-sm text-gray-500",children:"No shelves found. Adjust your search."}):f.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:u.map(h=>f.jsxs("button",{onClick:()=>i(t,h.id),className:"p-4 rounded-xl bg-white border border-gray-200 hover:border-orange-300 hover:shadow-md text-left transition-all",children:[f.jsxs("div",{className:"flex items-center justify-between mb-2",children:[f.jsx("span",{className:"text-sm font-semibold text-gray-900",children:h.code}),f.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-600",children:h.shelf_type})]}),f.jsx("p",{className:"text-xs text-gray-500 mb-1",children:h.name||"No name"}),f.jsxs("div",{className:"text-xs text-gray-400",children:["Row ",h.row_number||"-","  Column ",h.column_number||"-"]})]},h.id))})})():f.jsx("div",{className:"py-12 text-center text-sm text-gray-500",children:"Select a storage room to view shelves."})})]})})]})]})})},fl=D.createContext(void 0),uw=({children:s})=>{const[e,t]=D.useState(!1),[r,a]=D.useState([]),[n,o]=D.useState({}),[i,c]=D.useState(""),[l,d]=D.useState(""),u=D.useRef(null),h=D.useCallback(async()=>{var _;try{const b=await ow.getAll();a(b||[]);const S=((_=b==null?void 0:b[0])==null?void 0:_.id)||"";c(C=>C||S);const v={};for(const C of b){const T=await cw.getShelvesByStorageRoom(C.id);v[C.id]=T||[]}o(v)}catch(b){console.error("Failed to load storage rooms or shelves:",b),a([]),o({})}},[]),g=D.useCallback(async _=>(await h(),_!=null&&_.initialRoomId&&c(_.initialRoomId),_!=null&&_.search?d(_.search):d(""),t(!0),new Promise(b=>{u.current=b})),[h]),p=D.useCallback(()=>{t(!1),d(""),u.current&&(u.current(null),u.current=null)},[]),m=D.useCallback((_,b)=>{var R;const S=r.find(k=>k.id===_),v=(R=n[_])==null?void 0:R.find(k=>k.id===b);if(!S||!v)return;const T=[S.code||S.name,v.code||v.name].filter(Boolean).join("  "),x={roomId:_,shelfId:b,label:T,room:S,shelf:v};u.current&&(u.current(x),u.current=null),t(!1),d("")},[n,r]);return D.useEffect(()=>(e?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[e]),f.jsxs(fl.Provider,{value:{open:g,close:p},children:[s,f.jsx(lw,{isOpen:e,storageRooms:r,selectedRoomId:i,onChangeRoom:c,searchTerm:l,onChangeSearch:d,shelvesByRoom:n,onSelect:m,onClose:p})]})},wS=()=>{const s=D.useContext(fl);if(!s)throw new Error("useStorageLocationPicker must be used within StorageLocationPickerProvider");return s},$s=(s,e="Unknown")=>D.lazy(()=>(console.log(` Lazy loading component: ${e}`),s().catch(t=>(console.error(` Lazy import error for ${e}:`,t),console.error("Error stack:",t.stack),console.error("Error message:",t.message),{default:()=>f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center max-w-md mx-auto p-6",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Component Loading Error"}),f.jsxs("p",{className:"text-gray-600 mb-4",children:["There was an error loading ",e,". Please refresh the page."]}),f.jsxs("div",{className:"text-xs text-gray-500 mb-4",children:["Error: ",t.message]}),f.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})})})))),dw=D.lazy(()=>z(()=>import("./LoginPage-daec61bf.js"),["assets/LoginPage-daec61bf.js","assets/vendor-36d2c7c1.js","assets/PageErrorWrapper-b69ee385.js","assets/PageErrorBoundary-3d3e48b8.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useErrorHandler-ecda4689.js","assets/ErrorState-8ed6c2f9.js","assets/supabase-cf010ec4.js"])),hw=$s(()=>z(()=>import("./ConditionalDashboard-9b88bdc5.js"),["assets/ConditionalDashboard-9b88bdc5.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]),"ConditionalDashboard"),mw=D.lazy(()=>z(()=>import("./NewDevicePage-9154ffca.js"),["assets/NewDevicePage-9154ffca.js","assets/vendor-36d2c7c1.js","assets/toastUtils-7054c9ca.js","assets/ui-28e30067.js","assets/Modal-a5e4c1ba.js","assets/useBodyScrollLock-341c8b9f.js","assets/search-cbe15294.js","assets/AddCustomerModal-175a5a1a.js","assets/CustomerForm-3440546b.js","assets/phoneUtils-a8934478.js","assets/useSuccessModal-081786c4.js","assets/SuccessModalIcons-fe811e4d.js","assets/productCalculations-9f6c3068.js","assets/qr-3af4041b.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),pw=$s(()=>z(()=>import("./DevicesPage-2a4312ae.js"),["assets/DevicesPage-2a4312ae.js","assets/vendor-36d2c7c1.js","assets/SearchBar-c613e419.js","assets/ui-28e30067.js","assets/GlassSelect-e243562f.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/toastUtils-7054c9ca.js","assets/supabase-cf010ec4.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/GlassInput-0475021a.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/CustomerDetailModal-ad4a2166.js","assets/GlassTabs-05c8a392.js","assets/appointments-0b344a33.js","assets/whatsappService-09f99080.js","assets/Modal-a5e4c1ba.js","assets/CustomerForm-3440546b.js","assets/returns-8e3dd741.js","assets/AppointmentModal-91a07df7.js","assets/format-aff4c6a2.js","assets/index-5a6a7dda.js","assets/pdf-e6e38bab.js","assets/CBMCalculatorModal-27ed156d.js"]),"DevicesPage"),fw=D.lazy(()=>z(()=>import("./CustomersPage-68d71a3f.js"),["assets/CustomersPage-68d71a3f.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/SkeletonLoaders-da70324a.js","assets/ui-28e30067.js","assets/BackButton-02a80e74.js","assets/BulkSMSModal-ba796dbc.js","assets/useBodyScrollLock-341c8b9f.js","assets/phoneUtils-a8934478.js","assets/CustomerDetailModal-ad4a2166.js","assets/supabase-cf010ec4.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/appointments-0b344a33.js","assets/whatsappService-09f99080.js","assets/Modal-a5e4c1ba.js","assets/CustomerForm-3440546b.js","assets/returns-8e3dd741.js","assets/AppointmentModal-91a07df7.js","assets/useSuccessModal-081786c4.js","assets/SuccessModalIcons-fe811e4d.js","assets/format-aff4c6a2.js","assets/index-5a6a7dda.js","assets/pdf-e6e38bab.js","assets/AddCustomerModal-175a5a1a.js","assets/useDialog-6eb5c329.js","assets/search-cbe15294.js"])),gw=D.lazy(()=>z(()=>import("./CustomerDataUpdatePage-a9b14bc6.js"),["assets/CustomerDataUpdatePage-a9b14bc6.js","assets/vendor-36d2c7c1.js","assets/Modal-a5e4c1ba.js","assets/useBodyScrollLock-341c8b9f.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),_w=$s(()=>z(()=>import("./AppLayout-ccd65b19.js"),["assets/AppLayout-ccd65b19.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/useBusinessInfo-62d31733.js","assets/AddCustomerModal-175a5a1a.js","assets/ui-28e30067.js","assets/CustomerForm-3440546b.js","assets/phoneUtils-a8934478.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/supabase-cf010ec4.js","assets/reminderApi-be7f32c2.js","assets/enhancedCacheManager-afe341e0.js","assets/GlobalSearchShortcut-c0731781.js","assets/SearchResults-c1876f8f.js","assets/Modal-a5e4c1ba.js","assets/GlassInput-0475021a.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassSelect-e243562f.js","assets/AddProductModal-144ca68a.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js","assets/forms-ebbdb905.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/AppointmentModal-91a07df7.js","assets/appointments-0b344a33.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/stockTransferApi-f59c9e8a.js","assets/ImportEmployeesFromUsersModal-22c8484e.js","assets/employeeService-efe40e70.js","assets/TransferModal-7d7a82f1.js","assets/BulkSMSModal-ba796dbc.js","assets/DailyReportModal-f39ca22c.js","assets/InstallmentManagementModal-0b553ce1.js","assets/LoadingSpinner-251d9268.js","assets/CustomerTooltip-6a958832.js"]),"AppLayout"),yw=D.lazy(()=>z(()=>import("./AdminSettingsPage-e1e69b03.js"),["assets/AdminSettingsPage-e1e69b03.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/attendanceSettingsApi-f03692b4.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/GlassInput-0475021a.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassSelect-e243562f.js","assets/inventorySettingsApi-fd100cf3.js","assets/shippingApi-e95f9d8a.js","assets/useDialog-6eb5c329.js","assets/useSmartGridLayout-0626d484.js","assets/WidgetOrderSettings-a59a0b3b.js","assets/backupApi-b9211f47.js","assets/fullDatabaseDownloadService-81aa0524.js","assets/customerCacheService-9b459c09.js","assets/childVariantsCacheService-9368f4c7.js","assets/offlineSaleSyncService-93b9509e.js","assets/saleProcessingService-f5a8fb75.js","assets/autoSyncService-45729361.js"])),bw=D.lazy(()=>z(()=>import("./IntegrationsTestPage-23cf9031.js"),["assets/IntegrationsTestPage-23cf9031.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),ww=D.lazy(()=>z(()=>import("./ErrorLogsPage-6afe17d6.js"),["assets/ErrorLogsPage-6afe17d6.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),vw=D.lazy(()=>z(()=>import("./UserManagementPage-b8bb68c9.js"),["assets/UserManagementPage-b8bb68c9.js","assets/vendor-36d2c7c1.js","assets/SearchBar-c613e419.js","assets/ui-28e30067.js","assets/GlassSelect-e243562f.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/forms-ebbdb905.js","assets/zod-78f78e6c.js","assets/GlassInput-0475021a.js","assets/useBodyScrollLock-341c8b9f.js","assets/employeeService-efe40e70.js","assets/SkeletonLoaders-da70324a.js","assets/supabase-cf010ec4.js"])),Eo=D.lazy(()=>z(()=>import("./EnhancedSupplierManagementPage-2cfbfd01.js"),["assets/EnhancedSupplierManagementPage-2cfbfd01.js","assets/vendor-36d2c7c1.js","assets/SearchBar-c613e419.js","assets/ui-28e30067.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/SupplierDetailModal-41a61e96.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/useBodyScrollLock-341c8b9f.js","assets/supabase-cf010ec4.js"])),Sw=D.lazy(()=>z(()=>import("./SMSControlCenterPage-bfeae224.js"),["assets/SMSControlCenterPage-bfeae224.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js"])),Ew=D.lazy(()=>z(()=>import("./WhatsAppInboxPage-78c359e5.js"),["assets/WhatsAppInboxPage-78c359e5.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/whatsappService-09f99080.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/inventorySettingsApi-fd100cf3.js","assets/useBodyScrollLock-341c8b9f.js","assets/Modal-a5e4c1ba.js"])),xw=D.lazy(()=>z(()=>import("./EnhancedPaymentManagementPage-3a3fe433.js"),["assets/EnhancedPaymentManagementPage-3a3fe433.js","assets/vendor-36d2c7c1.js","assets/PageErrorBoundary-3d3e48b8.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useErrorHandler-ecda4689.js","assets/GlassBadge-9ae09fa8.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassTabs-05c8a392.js","assets/Modal-a5e4c1ba.js","assets/useBodyScrollLock-341c8b9f.js","assets/supabase-cf010ec4.js","assets/GlassSelect-e243562f.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/GlassInput-0475021a.js","assets/TransferModal-7d7a82f1.js","assets/CustomerTooltip-6a958832.js","assets/enhancedCacheManager-afe341e0.js","assets/ExpenseManagement-699e2bcf.js","assets/useSuccessModal-081786c4.js","assets/format-aff4c6a2.js"])),Pw=D.lazy(()=>z(()=>import("./ExpensesPage-05ad15c1.js"),["assets/ExpensesPage-05ad15c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/ExpenseManagement-699e2bcf.js","assets/GlassInput-0475021a.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassSelect-e243562f.js","assets/Modal-a5e4c1ba.js","assets/useBodyScrollLock-341c8b9f.js","assets/useSuccessModal-081786c4.js","assets/supabase-cf010ec4.js"])),Aw=D.lazy(()=>z(()=>import("./EmployeeManagementPage-c5f4b8bd.js"),["assets/EmployeeManagementPage-c5f4b8bd.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/BackButton-02a80e74.js","assets/ui-28e30067.js","assets/GlassSelect-e243562f.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/ImportEmployeesFromUsersModal-22c8484e.js","assets/employeeService-efe40e70.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/useDialog-6eb5c329.js","assets/supabase-cf010ec4.js"]));D.lazy(()=>z(()=>import("./EmployeeAttendancePage-b1e602f6.js"),["assets/EmployeeAttendancePage-b1e602f6.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/officeConfig-bc48d4a3.js","assets/attendanceSettingsApi-f03692b4.js","assets/employeeService-efe40e70.js","assets/supabase-cf010ec4.js"]));D.lazy(()=>z(()=>import("./AttendanceManagementPage-9d440554.js"),["assets/AttendanceManagementPage-9d440554.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/index-5a6a7dda.js","assets/pdf-e6e38bab.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"]));const kw=D.lazy(()=>z(()=>import("./MyAttendancePage-b62308bc.js"),["assets/MyAttendancePage-b62308bc.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/officeConfig-bc48d4a3.js","assets/attendanceSettingsApi-f03692b4.js","assets/employeeService-efe40e70.js","assets/supabase-cf010ec4.js"])),Iw=D.lazy(()=>z(()=>import("./UnifiedAppointmentPage-96d63fba.js"),["assets/UnifiedAppointmentPage-96d63fba.js","assets/vendor-36d2c7c1.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/SearchBar-c613e419.js","assets/ui-28e30067.js","assets/GlassSelect-e243562f.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/PageErrorBoundary-3d3e48b8.js","assets/AppointmentModal-91a07df7.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/appointments-0b344a33.js","assets/useDialog-6eb5c329.js","assets/supabase-cf010ec4.js"])),Cw=D.lazy(()=>z(()=>import("./RemindersPage-5edfe80e.js"),["assets/RemindersPage-5edfe80e.js","assets/vendor-36d2c7c1.js","assets/reminderApi-be7f32c2.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"]));D.lazy(()=>z(()=>import("./GlobalSearchPage-649ea458.js"),["assets/GlobalSearchPage-649ea458.js","assets/vendor-36d2c7c1.js","assets/SearchResults-c1876f8f.js","assets/ui-28e30067.js","assets/phoneUtils-a8934478.js","assets/routing-eb8c310c.js","assets/GlassSelect-e243562f.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassInput-0475021a.js","assets/currencyUtils-59109a41.js","assets/supabase-cf010ec4.js"]));const Dw=D.lazy(()=>z(()=>import("./ProductAdGeneratorPage-e150b333.js"),["assets/ProductAdGeneratorPage-e150b333.js","assets/vendor-36d2c7c1.js","assets/pdf-e6e38bab.js","assets/supabase-cf010ec4.js","assets/html2canvas.esm-6bd083a4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"])),Tw=D.lazy(()=>z(()=>import("./SpecialOrdersPage-8d38139b.js"),["assets/SpecialOrdersPage-8d38139b.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/SkeletonLoaders-da70324a.js","assets/useBodyScrollLock-341c8b9f.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/supabase-cf010ec4.js"])),Rw=D.lazy(()=>z(()=>import("./InstallmentsPage-cbd5c462.js"),["assets/InstallmentsPage-cbd5c462.js","assets/vendor-36d2c7c1.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/ui-28e30067.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/SkeletonLoaders-da70324a.js","assets/InstallmentManagementModal-0b553ce1.js","assets/LoadingSpinner-251d9268.js","assets/CustomerTooltip-6a958832.js","assets/supabase-cf010ec4.js"])),Ow=D.lazy(()=>z(()=>import("./CategoryManagementPage-3e5bfe4f.js"),["assets/CategoryManagementPage-3e5bfe4f.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/useDialog-6eb5c329.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),Nw=D.lazy(()=>z(()=>import("./StoreLocationManagementPage-a5c2622d.js"),["assets/StoreLocationManagementPage-a5c2622d.js","assets/vendor-36d2c7c1.js","assets/Modal-a5e4c1ba.js","assets/useBodyScrollLock-341c8b9f.js","assets/storeLocationApi-1725ef86.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),xo=D.lazy(()=>z(()=>import("./ExcelImportPage-dbb49bc1.js"),["assets/ExcelImportPage-dbb49bc1.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/phoneUtils-a8934478.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),Lw=D.lazy(()=>z(()=>import("./ExcelTemplateDownloadPage-2df8b20e.js"),["assets/ExcelTemplateDownloadPage-2df8b20e.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Uw=D.lazy(()=>z(()=>import("./LoginPage-2c5ac167.js"),["assets/LoginPage-2c5ac167.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),jw=D.lazy(()=>z(()=>import("./SignupPage-2a710c1c.js"),["assets/SignupPage-2a710c1c.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),$w=D.lazy(()=>z(()=>import("./DashboardPage-d1491e19.js"),["assets/DashboardPage-d1491e19.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),Mw=D.lazy(()=>z(()=>import("./ProductsPage-6a983f34.js"),["assets/ProductsPage-6a983f34.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),qw=D.lazy(()=>z(()=>import("./ProductDetailPage-d54eb1b4.js"),["assets/ProductDetailPage-d54eb1b4.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),Bw=D.lazy(()=>z(()=>import("./ProfilePage-a179c375.js"),["assets/ProfilePage-a179c375.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),Fw=D.lazy(()=>z(()=>import("./OrdersPage-c5d7ebcb.js"),["assets/OrdersPage-c5d7ebcb.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),zw=D.lazy(()=>z(()=>import("./LoyaltyPage-af4f910d.js"),["assets/LoyaltyPage-af4f910d.js","assets/vendor-36d2c7c1.js","assets/customerPortalService-0d37743c.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/customerLoyaltyService-09627f23.js","assets/supabase-cf010ec4.js"])),Vw=D.lazy(()=>z(()=>import("./TestImageUpload-ce511a32.js"),["assets/TestImageUpload-ce511a32.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"])),Gw=D.lazy(()=>z(()=>import("./BackgroundRemovalPage-d4a7ee1f.js"),["assets/BackgroundRemovalPage-d4a7ee1f.js","assets/vendor-36d2c7c1.js","assets/charts-d592fbd1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Ww=D.lazy(()=>z(()=>import("./UnifiedLoadingExample-c3f21dfb.js"),["assets/UnifiedLoadingExample-c3f21dfb.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Hw=D.lazy(()=>z(()=>import("./PNGGenerationTest-dcc88700.js"),["assets/PNGGenerationTest-dcc88700.js","assets/vendor-36d2c7c1.js","assets/ShareReceiptModal-8db20b0e.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/whatsappService-09f99080.js","assets/routing-eb8c310c.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/useBusinessInfo-62d31733.js","assets/formatPhoneForInvoice-e7084c6d.js","assets/pdf-e6e38bab.js","assets/html2canvas.esm-6bd083a4.js"])),Qw=D.lazy(()=>z(()=>import("./MobileLayout-f099fca3.js"),["assets/MobileLayout-f099fca3.js","assets/vendor-36d2c7c1.js","assets/mobileOfflineCache-ee6f7212.js","assets/ui-28e30067.js","assets/useMobileBranch-d96f1509.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Kw=D.lazy(()=>z(()=>import("./MobileDashboard-467734f9.js"),["assets/MobileDashboard-467734f9.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/useMobileBranch-d96f1509.js","assets/supabase-cf010ec4.js","assets/useResponsiveSize-eee1874a.js","assets/routing-eb8c310c.js"])),Jw=D.lazy(()=>z(()=>import("./MobilePOS-60067c56.js"),["assets/MobilePOS-60067c56.js","assets/vendor-36d2c7c1.js","assets/saleProcessingService-f5a8fb75.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/format-aff4c6a2.js","assets/customerCacheService-9b459c09.js","assets/MobileAddCustomerModal-ee9fad7d.js","assets/phoneUtils-a8934478.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/MobileSheetContent-25c73501.js","assets/ShareReceiptModal-8db20b0e.js","assets/whatsappService-09f99080.js","assets/routing-eb8c310c.js","assets/useBusinessInfo-62d31733.js","assets/formatPhoneForInvoice-e7084c6d.js","assets/pdf-e6e38bab.js","assets/html2canvas.esm-6bd083a4.js","assets/useMobileBranch-d96f1509.js","assets/useResponsiveSize-eee1874a.js","assets/ResponsiveMobileWrapper-b44175a0.js"])),Yw=D.lazy(()=>z(()=>import("./MobileInventory-bfe6d339.js"),["assets/MobileInventory-bfe6d339.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/useMobileBranch-d96f1509.js","assets/supabase-cf010ec4.js","assets/useResponsiveSize-eee1874a.js","assets/ResponsiveMobileWrapper-b44175a0.js","assets/routing-eb8c310c.js"])),Xw=D.lazy(()=>z(()=>import("./MobileAddProduct-81170ed7.js"),["assets/MobileAddProduct-81170ed7.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),Zw=D.lazy(()=>z(()=>import("./MobileClients-ecda0df0.js"),["assets/MobileClients-ecda0df0.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/MobileAddCustomerModal-ee9fad7d.js","assets/phoneUtils-a8934478.js","assets/useSuccessModal-081786c4.js","assets/useBodyScrollLock-341c8b9f.js","assets/SuccessModalIcons-fe811e4d.js","assets/MobileSheetContent-25c73501.js","assets/useMobileBranch-d96f1509.js","assets/supabase-cf010ec4.js","assets/dataPreloadService-9ec6c84e.js","assets/enhancedCacheManager-afe341e0.js","assets/routing-eb8c310c.js","assets/variantHelpers-318d278a.js"])),ev=D.lazy(()=>z(()=>import("./MobileEditClient-6082daee.js"),["assets/MobileEditClient-6082daee.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),tv=D.lazy(()=>z(()=>import("./MobileMore-558bb0c3.js"),["assets/MobileMore-558bb0c3.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/mobileOfflineCache-ee6f7212.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),rv=D.lazy(()=>z(()=>import("./MobileAnalytics-0ac3a4d5.js"),["assets/MobileAnalytics-0ac3a4d5.js","assets/vendor-36d2c7c1.js","assets/dashboardService-a4d4a6f3.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js"])),sv=D.lazy(()=>z(()=>import("./MobileProductDetail-047cf1b6.js"),["assets/MobileProductDetail-047cf1b6.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/robustImageService-f15af7ef.js","assets/format-aff4c6a2.js","assets/variantUtils-827870e5.js","assets/specificationUtils-0c00478d.js","assets/useMobileBranch-d96f1509.js","assets/supabase-cf010ec4.js","assets/useDialog-6eb5c329.js","assets/routing-eb8c310c.js"])),av=D.lazy(()=>z(()=>import("./MobileClientDetail-7e4f9af2.js"),["assets/MobileClientDetail-7e4f9af2.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/appointments-0b344a33.js","assets/returns-8e3dd741.js","assets/routing-eb8c310c.js"])),nv=D.lazy(()=>z(()=>import("./MobileSheetDemo-d279f210.js"),["assets/MobileSheetDemo-d279f210.js","assets/vendor-36d2c7c1.js","assets/MobileSheetContent-25c73501.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),ov=D.lazy(()=>z(()=>import("./LATSDashboardPage-e3e0f0fb.js"),["assets/LATSDashboardPage-e3e0f0fb.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/SkeletonLoaders-da70324a.js","assets/PageErrorBoundary-3d3e48b8.js","assets/useErrorHandler-ecda4689.js","assets/ErrorState-8ed6c2f9.js","assets/AddProductModal-144ca68a.js","assets/supabase-cf010ec4.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js","assets/useBodyScrollLock-341c8b9f.js","assets/forms-ebbdb905.js"])),iv=D.lazy(()=>z(()=>import("./PurchaseOrdersPage-e80e783d.js"),["assets/PurchaseOrdersPage-e80e783d.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/useDialog-6eb5c329.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/CBMCalculatorModal-27ed156d.js","assets/LoadingSpinner-251d9268.js","assets/ComprehensivePaymentModal-83b44bf0.js","assets/GlassInput-0475021a.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/currencyUtils-59109a41.js","assets/countryFlags-325b0823.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/useBodyScrollLock-341c8b9f.js","assets/SupplierDetailModal-41a61e96.js","assets/GlassTabs-05c8a392.js","assets/SupplierForm-59afd126.js","assets/forms-ebbdb905.js","assets/zod-78f78e6c.js"])),cv=D.lazy(()=>z(()=>import("./POcreate-46fac409.js"),["assets/POcreate-46fac409.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useDialog-6eb5c329.js","assets/usePOSClickSounds-e5b9fd69.js","assets/VariantProductCard-04300406.js","assets/robustImageService-f15af7ef.js","assets/format-aff4c6a2.js","assets/useBodyScrollLock-341c8b9f.js","assets/SupplierDetailModal-41a61e96.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/countryFlags-325b0823.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/SupplierForm-59afd126.js","assets/forms-ebbdb905.js","assets/zod-78f78e6c.js","assets/shippingApi-e95f9d8a.js","assets/AddProductModal-144ca68a.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js","assets/purchaseOrderUtils-7c108ebb.js","assets/OrderManagementModal-72b00066.js","assets/QualityCheckModal-849e9065.js","assets/LoadingSpinner-251d9268.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/SetPricingModal-84ffdd49.js","assets/InstallmentManagementModal-0b553ce1.js","assets/useSuccessModal-081786c4.js","assets/CustomerTooltip-6a958832.js","assets/draftService-00fb159f.js"])),Po=D.lazy(()=>z(()=>import("./PurchaseOrderDetailPage-f611cc8b.js"),["assets/PurchaseOrderDetailPage-f611cc8b.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useDialog-6eb5c329.js","assets/QualityCheckModal-849e9065.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/useBodyScrollLock-341c8b9f.js","assets/SetPricingModal-84ffdd49.js"])),lv=D.lazy(()=>z(()=>import("./TestSetPricingModal-b8243981.js"),["assets/TestSetPricingModal-b8243981.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/SetPricingModal-84ffdd49.js","assets/supabase-cf010ec4.js"])),uv=D.lazy(()=>z(()=>import("./InventorySparePartsPage-64d05872.js"),["assets/InventorySparePartsPage-64d05872.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/CategoryInput-e47eba98.js","assets/PriceInput-aa1a05e9.js","assets/storeLocationApi-1725ef86.js","assets/format-aff4c6a2.js","assets/purchaseOrderUtils-7c108ebb.js","assets/SafeImage-a3ef104e.js","assets/useDialog-6eb5c329.js","assets/routing-eb8c310c.js"])),dv=D.lazy(()=>z(()=>import("./StockTransferPage-444c89d7.js"),["assets/StockTransferPage-444c89d7.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/PageHeader-f4a9cf63.js","assets/stockTransferApi-f59c9e8a.js","assets/supabase-cf010ec4.js"])),hv=D.lazy(()=>z(()=>import("./TradeInManagementPage-7252e985.js"),["assets/TradeInManagementPage-7252e985.js","assets/vendor-36d2c7c1.js","assets/tradeInApi-5d12dbe0.js","assets/format-aff4c6a2.js","assets/useBodyScrollLock-341c8b9f.js","assets/ui-28e30067.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),mv=D.lazy(()=>z(()=>import("./TradeInTestPage-a5a5b8e5.js"),["assets/TradeInTestPage-a5a5b8e5.js","assets/vendor-36d2c7c1.js","assets/TradeInCalculator-868648b1.js","assets/tradeInApi-5d12dbe0.js","assets/format-aff4c6a2.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/TradeInContractModal-15d48929.js","assets/charts-d592fbd1.js","assets/toPropertyKey-7cc7522c.js","assets/pdf-e6e38bab.js","assets/useBodyScrollLock-341c8b9f.js"])),pv=D.lazy(()=>z(()=>import("./SalesReportsPage-4397215d.js"),["assets/SalesReportsPage-4397215d.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/rbac-6ed8a520.js","assets/useBusinessInfo-62d31733.js","assets/routing-eb8c310c.js","assets/charts-d592fbd1.js","assets/supabase-cf010ec4.js"])),fv=D.lazy(()=>z(()=>import("./ReportsPage-13b035ef.js"),["assets/ReportsPage-13b035ef.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/DailyReportModal-f39ca22c.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),gv=D.lazy(()=>z(()=>import("./CustomerLoyaltyPage-26998e4c.js"),["assets/CustomerLoyaltyPage-26998e4c.js","assets/vendor-36d2c7c1.js","assets/PriceInput-aa1a05e9.js","assets/ui-28e30067.js","assets/PageHeader-f4a9cf63.js","assets/customerLoyaltyService-09627f23.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),_v=D.lazy(()=>z(()=>import("./ShippedItemsPage-007e9b8a.js"),["assets/ShippedItemsPage-007e9b8a.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/draftService-00fb159f.js","assets/purchaseOrderUtils-7c108ebb.js","assets/supabase-cf010ec4.js"])),yv=D.lazy(()=>z(()=>import("./UnifiedInventoryPage-98e7d933.js"),["assets/UnifiedInventoryPage-98e7d933.js","assets/vendor-36d2c7c1.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/PageErrorBoundary-3d3e48b8.js","assets/useErrorHandler-ecda4689.js","assets/ErrorState-8ed6c2f9.js","assets/imeiVariantService-4ce4b8b1.js","assets/supabase-cf010ec4.js","assets/CategoryFormModal-0cc6b6de.js","assets/forms-ebbdb905.js","assets/zod-78f78e6c.js","assets/GlassInput-0475021a.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/GlassSelect-e243562f.js","assets/GlassBadge-9ae09fa8.js","assets/useBodyScrollLock-341c8b9f.js","assets/useDialog-6eb5c329.js","assets/utils-ebb5cecb.js","assets/SupplierForm-59afd126.js","assets/AddProductModal-144ca68a.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js","assets/SearchBar-c613e419.js","assets/VariantProductCard-04300406.js","assets/robustImageService-f15af7ef.js","assets/format-aff4c6a2.js","assets/useBluetoothPrinter-0ea2abfe.js","assets/variantUtils-827870e5.js","assets/OrderManagementModal-72b00066.js","assets/QualityCheckModal-849e9065.js","assets/LoadingSpinner-251d9268.js","assets/PaymentsPopupModal-6fe61f19.js","assets/currencyUtils-59109a41.js","assets/SetPricingModal-84ffdd49.js","assets/productCalculations-9f6c3068.js","assets/variantHelpers-318d278a.js","assets/qr-3af4041b.js","assets/SkeletonLoaders-da70324a.js"])),bv=$s(()=>z(()=>import("./POSPageOptimized-c894624a.js").then(s=>s.P),["assets/POSPageOptimized-c894624a.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/rbac-6ed8a520.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/usePOSClickSounds-e5b9fd69.js","assets/VariantProductCard-04300406.js","assets/robustImageService-f15af7ef.js","assets/format-aff4c6a2.js","assets/useBodyScrollLock-341c8b9f.js","assets/imeiVariantService-4ce4b8b1.js","assets/GlassBadge-9ae09fa8.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/SafeImage-a3ef104e.js","assets/specificationUtils-0c00478d.js","assets/PriceInput-aa1a05e9.js","assets/CategoryInput-e47eba98.js","assets/AddCustomerModal-175a5a1a.js","assets/CustomerForm-3440546b.js","assets/phoneUtils-a8934478.js","assets/useSuccessModal-081786c4.js","assets/SuccessModalIcons-fe811e4d.js","assets/search-cbe15294.js","assets/customerCacheService-9b459c09.js","assets/LoadingSpinner-251d9268.js","assets/useDialog-6eb5c329.js","assets/CustomerDetailModal-ad4a2166.js","assets/GlassTabs-05c8a392.js","assets/appointments-0b344a33.js","assets/whatsappService-09f99080.js","assets/Modal-a5e4c1ba.js","assets/returns-8e3dd741.js","assets/AppointmentModal-91a07df7.js","assets/index-5a6a7dda.js","assets/pdf-e6e38bab.js","assets/GlassInput-0475021a.js","assets/saleProcessingService-f5a8fb75.js","assets/TradeInContractModal-15d48929.js","assets/toPropertyKey-7cc7522c.js","assets/tradeInApi-5d12dbe0.js","assets/ComprehensivePaymentModal-83b44bf0.js","assets/currencyUtils-59109a41.js","assets/InstallmentManagementModal-0b553ce1.js","assets/CustomerTooltip-6a958832.js","assets/PaymentsPopupModal-6fe61f19.js","assets/useBusinessInfo-62d31733.js","assets/draftService-00fb159f.js","assets/ShareReceiptModal-8db20b0e.js","assets/formatPhoneForInvoice-e7084c6d.js","assets/html2canvas.esm-6bd083a4.js","assets/GlobalSearchShortcut-c0731781.js","assets/SearchResults-c1876f8f.js","assets/POSPageOptimized-8d488751.css"]),"POSPage"),wv=D.lazy(()=>z(()=>import("./InventoryManagementPage-bc0d54fb.js"),["assets/InventoryManagementPage-bc0d54fb.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/PageErrorBoundary-3d3e48b8.js","assets/ui-28e30067.js","assets/PageHeader-f4a9cf63.js","assets/SearchBar-c613e419.js","assets/CategoryFormModal-0cc6b6de.js","assets/forms-ebbdb905.js","assets/zod-78f78e6c.js","assets/GlassInput-0475021a.js","assets/GlassSelect-e243562f.js","assets/GlassBadge-9ae09fa8.js","assets/useBodyScrollLock-341c8b9f.js","assets/EnhancedSupplierManagementPage-2cfbfd01.js","assets/BackButton-02a80e74.js","assets/SupplierDetailModal-41a61e96.js","assets/EnhancedAddSupplierModal-988446e5.js","assets/supabase-cf010ec4.js","assets/StorageRoomManagementPage-6a067649.js","assets/storeLocationApi-1725ef86.js","assets/AddProductModal-144ca68a.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js"])),vv=D.lazy(()=>z(()=>import("./StorageRoomManagementPage-6a067649.js"),["assets/StorageRoomManagementPage-6a067649.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/storeLocationApi-1725ef86.js","assets/BackButton-02a80e74.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),Sv=D.lazy(()=>z(()=>import("./StorageRoomDetailPage-2b542b16.js"),["assets/StorageRoomDetailPage-2b542b16.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/storeLocationApi-1725ef86.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),Ev=D.lazy(()=>z(()=>import("./BluetoothPrinterPage-e753cae2.js"),["assets/BluetoothPrinterPage-e753cae2.js","assets/vendor-36d2c7c1.js","assets/useBluetoothPrinter-0ea2abfe.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js","assets/supabase-cf010ec4.js"])),xv=D.lazy(()=>z(()=>import("./DashboardPage-75afb163.js"),["assets/DashboardPage-75afb163.js","assets/vendor-36d2c7c1.js","assets/PageErrorWrapper-b69ee385.js","assets/PageErrorBoundary-3d3e48b8.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useErrorHandler-ecda4689.js","assets/ErrorState-8ed6c2f9.js","assets/useSmartGridLayout-0626d484.js","assets/dashboardService-a4d4a6f3.js","assets/AddProductModal-144ca68a.js","assets/supabase-cf010ec4.js","assets/skuUtils-60e0a165.js","assets/CategoryInput-e47eba98.js","assets/specificationUtils-0c00478d.js","assets/useBodyScrollLock-341c8b9f.js","assets/forms-ebbdb905.js","assets/reminderApi-be7f32c2.js","assets/RemindersPage-5edfe80e.js","assets/BackButton-02a80e74.js","assets/Modal-a5e4c1ba.js","assets/backupApi-b9211f47.js","assets/charts-d592fbd1.js","assets/AppointmentModal-91a07df7.js","assets/useSuccessModal-081786c4.js","assets/SuccessModalIcons-fe811e4d.js","assets/appointments-0b344a33.js"])),Pv=D.lazy(()=>z(()=>import("./BulkSMSPage-21dd41f0.js"),["assets/BulkSMSPage-21dd41f0.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/format-aff4c6a2.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Av=D.lazy(()=>z(()=>import("./SMSLogsPage-112f3a23.js"),["assets/SMSLogsPage-112f3a23.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),kv=D.lazy(()=>z(()=>import("./SMSSettingsPage-53120bcf.js"),["assets/SMSSettingsPage-53120bcf.js","assets/supabase-cf010ec4.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/routing-eb8c310c.js"])),Iv=D.lazy(()=>z(()=>import("./ScheduledMessagesPage-ad848ea6.js"),["assets/ScheduledMessagesPage-ad848ea6.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Cv=D.lazy(()=>z(()=>import("./IntegrationSettingsPage-e972a399.js"),["assets/IntegrationSettingsPage-e972a399.js","assets/vendor-36d2c7c1.js","assets/ui-28e30067.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js"])),Dv=D.lazy(()=>z(()=>import("./UserSettingsPage-ec401211.js"),["assets/UserSettingsPage-ec401211.js","assets/vendor-36d2c7c1.js","assets/PageErrorWrapper-b69ee385.js","assets/PageErrorBoundary-3d3e48b8.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/useErrorHandler-ecda4689.js","assets/ErrorState-8ed6c2f9.js","assets/useSmartGridLayout-0626d484.js","assets/WidgetOrderSettings-a59a0b3b.js","assets/GlassTabs-05c8a392.js","assets/utils-95f4031a.js","assets/charts-d592fbd1.js","assets/supabase-cf010ec4.js"])),ss=({error:s,retry:e})=>{const t=s.message.includes("Cannot convert object to primitive value");return f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center max-w-md mx-auto p-6",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:t?"Component Loading Error":"Failed to load page"}),f.jsx("p",{className:"text-gray-600 mb-4",children:t?"There was an error initializing this component. This is usually a temporary issue that can be resolved by refreshing the page.":"There was an error loading this page. This might be a temporary issue."}),t&&f.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800",children:[" ",f.jsx("strong",{children:"Tip:"})," This error often occurs during development. Try refreshing the page or clearing your browser cache."]}),f.jsxs("div",{className:"flex gap-3 justify-center",children:[f.jsx("button",{onClick:e,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Try Again"}),f.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors",children:"Refresh Page"})]})]})})},Tv=()=>{const{isVisible:s,jobs:e,cancelJob:t}=zc();return f.jsx(dy,{isVisible:s,jobs:e,onCancel:t})},Rv=({children:s})=>{const[e,t]=D.useState(!1);D.useEffect(()=>{t(!1)},[]);let r=!1,a=!0;try{const n=Lt();r=n.isAuthenticated,a=n.loading}catch{return f.jsx(Oa,{fullscreen:!0,transparent:!0,message:"Loading application..."})}if(e)return f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Authentication Error"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with authentication. Please refresh the page."}),f.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})});if(a)return f.jsx(Oa,{fullscreen:!0,transparent:!0});try{return r?f.jsx(f.Fragment,{children:s}):(localStorage.setItem("postLoginRedirect",window.location.pathname),f.jsx(it,{to:"/login"}))}catch(n){return console.error("ProtectedRoute error:",n),t(!0),null}},te=({children:s,allowedRoles:e,requiredPermissions:t})=>{var d;const r=Array.isArray(e)?e.map(u=>String(u)):[],[a,n]=D.useState(!1);D.useEffect(()=>{n(!1)},[]);let o;try{o=Lt()}catch(u){return console.error("Auth context error in RoleProtectedRoute:",u),f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Authentication Error"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with authentication. Please refresh the page."}),f.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})})}const{isAuthenticated:i,loading:c,currentUser:l}=o;if(a)return f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Error"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"There was an issue with role verification. Please refresh the page."}),f.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})});if(c)return f.jsx(Oa,{fullscreen:!0,transparent:!0});try{if(!i)return localStorage.setItem("postLoginRedirect",window.location.pathname),f.jsx(it,{to:"/login"});const u=l!=null&&l.role?String(l.role):null;let h=!0;t&&t.length>0&&((d=l.permissions)!=null&&d.includes("all")?h=!0:h=t.some(m=>{var _;return(_=l.permissions)==null?void 0:_.includes(m)}));const g=u&&r.includes(u);return!l||!(g||h)?f.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50",children:f.jsxs("div",{className:"text-center",children:[f.jsx("div",{className:"text-red-600 mb-4",children:f.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:f.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),f.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Denied"}),f.jsx("p",{className:"text-gray-600 mb-4",children:"You don't have permission to access this page."}),f.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:[!g&&"Required role: "+r.join(", "),t&&t.length>0&&" or permission: "+t.join(", ")]}),f.jsx("button",{onClick:()=>window.history.back(),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Go Back"})]})}):f.jsx(f.Fragment,{children:s})}catch(u){return console.error("RoleProtectedRoute error:",u),n(!0),null}},Ov=({isOnline:s,isSyncing:e})=>{let t,r;try{t=Gg()}catch{}try{r=ng()}catch{}return aw(),D.useEffect(()=>{Oy().catch(console.error)},[]),D.useEffect(()=>{console.log(" [DEBUG] App: useEffect for initialization triggered");let a=!1,n=null;async function o(){if(console.log(" [DEBUG] App: initializeOfflineSync called, isInitialized:",a),a){console.log(" [DEBUG] App: Already initialized, skipping offline sync");return}try{console.log(" [DEBUG] App: Importing offlineSaleSyncService");const{offlineSaleSyncService:c}=await z(()=>import("./offlineSaleSyncService-93b9509e.js"),["assets/offlineSaleSyncService-93b9509e.js","assets/saleProcessingService-f5a8fb75.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js"]);c.startAutoSync(),console.log(" [App] Offline sale sync service started"),navigator.onLine?(console.log(" [DEBUG] App: Online, scheduling sync in 2 seconds"),setTimeout(()=>{console.log(" [DEBUG] App: Executing pending sales sync"),c.syncAllPendingSales().catch(l=>{console.warn(" [DEBUG] App: Initial sync failed:",l)})},2e3)):console.log(" [DEBUG] App: Offline, skipping sync")}catch(c){console.error(" [DEBUG] App: Failed to initialize offline sync:",c)}}async function i(){if(console.log(" [DEBUG] App: initializeDatabaseAutoSync called, isInitialized:",a),a){console.log(" [DEBUG] App: Already initialized, skipping database auto-sync");return}try{console.log(" [DEBUG] App: Importing autoSyncService and fullDatabaseDownloadService");const{autoSyncService:c}=await z(()=>import("./autoSyncService-45729361.js"),["assets/autoSyncService-45729361.js","assets/fullDatabaseDownloadService-81aa0524.js","assets/supabase-cf010ec4.js","assets/customerCacheService-9b459c09.js","assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]),{fullDatabaseDownloadService:l}=await z(()=>import("./fullDatabaseDownloadService-81aa0524.js"),["assets/fullDatabaseDownloadService-81aa0524.js","assets/supabase-cf010ec4.js","assets/customerCacheService-9b459c09.js","assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]),d=l.isDownloaded();console.log(" [DEBUG] App: Database download status:",{isDownloaded:d,isOnline:navigator.onLine}),d&&navigator.onLine?(c.startAutoSync(),console.log(" [App] Database auto-sync service started")):console.log(d?" [App] Database downloaded but offline - auto-sync will start when online":" [App] No database downloaded - auto-sync disabled")}catch(c){console.error(" [DEBUG] App: Failed to initialize database auto-sync:",c)}}return console.log(" [DEBUG] App: Scheduling initialization in 1 second"),n=setTimeout(()=>{console.log(" [DEBUG] App: Executing initialization now"),o(),i(),a=!0,console.log(" [DEBUG] App: Initialization complete")},1e3),()=>{console.log(" [DEBUG] App: Cleanup function called"),n&&(console.log(" [DEBUG] App: Clearing initialization timeout"),clearTimeout(n)),console.log(" [DEBUG] App: Stopping auto-sync services"),z(()=>import("./offlineSaleSyncService-93b9509e.js"),["assets/offlineSaleSyncService-93b9509e.js","assets/saleProcessingService-f5a8fb75.js","assets/supabase-cf010ec4.js","assets/ui-28e30067.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js"]).then(({offlineSaleSyncService:c})=>{c.stopAutoSync(),console.log(" [DEBUG] App: Offline sync stopped")}).catch(c=>{console.warn(" [DEBUG] App: Failed to stop offline sync:",c)}),z(()=>import("./autoSyncService-45729361.js"),["assets/autoSyncService-45729361.js","assets/fullDatabaseDownloadService-81aa0524.js","assets/supabase-cf010ec4.js","assets/customerCacheService-9b459c09.js","assets/childVariantsCacheService-9368f4c7.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js"]).then(({autoSyncService:c})=>{c.stopAutoSync(),console.log(" [DEBUG] App: Database auto-sync stopped")}).catch(c=>{console.warn(" [DEBUG] App: Failed to stop database auto-sync:",c)})}},[]),D.useEffect(()=>{async function a(){try{if(!(t!=null&&t.addCustomer)||!(r!=null&&r.assignToTechnician)||!(r!=null&&r.updateDeviceStatus))return;const n=await jy();for(const o of n)try{if(o.type==="submitData")try{await fetch("/api/endpoint",{method:"POST",body:JSON.stringify(o.payload)})}catch{console.warn("API endpoint not available, skipping submitData action");continue}else if(o.type==="createCustomerFromSearch")await t.addCustomer(o.payload);else if(o.type==="adjustPoints"){const{operation:i,pointsToAdjust:c,reason:l,customerId:d}=o.payload,u=i==="add"?Math.abs(c):-Math.abs(c);if(t!=null&&t.updateCustomer){const h=t.customers.find(g=>g.id===d);if(h){const g=(h.points||0)+u;await t.updateCustomer(d,{points:g}),t.addNote&&await t.addNote(d,`${i==="add"?"Added":"Subtracted"} ${Math.abs(c)} points - ${l}`)}}}else if(o.type==="assignTechnician"){const{deviceId:i,selectedTechId:c}=o.payload;await r.assignToTechnician(i,c,"")}else if(o.type==="markDeviceFailed"){const{deviceId:i,remark:c}=o.payload;await r.updateDeviceStatus(i,"failed",c||"")}}catch(i){console.error("Error syncing action:",i)}n.length>0&&await $y()}catch(n){console.error("Error during offline sync:",n)}}s&&a()},[s,t,r]),f.jsxs(f.Fragment,{children:[!s&&f.jsx("div",{style:{background:"#f87171",color:"white",padding:"8px",textAlign:"center"},children:"You are offline. Changes will be saved and synced when you are back online."}),s&&e&&f.jsx("div",{style:{background:"#fbbf24",color:"black",padding:"8px",textAlign:"center"},children:"Syncing your offline changes..."}),f.jsxs(Pl,{children:[f.jsx(K,{path:"/login",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(dw,{})})}),f.jsxs(K,{path:"/",element:f.jsx(Rv,{children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(_w,{})})}),children:[f.jsx(K,{index:!0,element:f.jsx(po,{})}),f.jsx(K,{path:"/dashboard",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(hw,{})})}),f.jsx(K,{path:"/dashboard/admin",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(xv,{})})})}),f.jsx(K,{path:"/ad-generator",element:f.jsx(Zr,{fallback:ss,children:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Dw,{})})})})}),f.jsx(K,{path:"/devices",element:f.jsx(Zr,{fallback:ss,children:f.jsx(te,{allowedRoles:["admin","customer-care","technician"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(pw,{})})})})}),f.jsx(K,{path:"/devices/new",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(mw,{})})})}),f.jsx(K,{path:"/category-management",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Ow,{})})})}),f.jsx(K,{path:"/supplier-management",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Eo,{})})})}),f.jsx(K,{path:"/store-locations",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Nw,{})})})}),f.jsx(K,{path:"/customers/import",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(xo,{})})})}),f.jsx(K,{path:"/excel-import",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(xo,{})})})}),f.jsx(K,{path:"/excel-templates",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Lw,{})})})}),f.jsx(K,{path:"/customers",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(Zr,{fallback:ss,children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(fw,{})})})})}),f.jsx(K,{path:"/customers/update",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(gw,{})})})}),f.jsx(K,{path:"/settings",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Dv,{})})}),f.jsx(K,{path:"/sms",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Sw,{})})})}),f.jsx(K,{path:"/sms/bulk",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Pv,{})})})}),f.jsx(K,{path:"/sms/logs",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Av,{})})})}),f.jsx(K,{path:"/sms/settings",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(kv,{})})})}),f.jsx(K,{path:"/sms/scheduled",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Iv,{})})})}),f.jsx(K,{path:"/whatsapp/inbox",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Ew,{})})})}),f.jsx(K,{path:"/admin-settings",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(yw,{})})})}),f.jsx(K,{path:"/integration-settings",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Cv,{})})})}),f.jsx(K,{path:"/integrations-test",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(bw,{})})})}),f.jsx(K,{path:"/admin/error-logs",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(ww,{})})})}),f.jsx(K,{path:"/users",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(vw,{})})})}),f.jsx(K,{path:"/payments",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(xw,{})})})}),f.jsx(K,{path:"/expenses",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Pw,{})})})}),f.jsx(K,{path:"/appointments",element:f.jsx(te,{allowedRoles:["admin","customer-care","technician"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Iw,{})})})}),f.jsx(K,{path:"/reminders",element:f.jsx(te,{allowedRoles:["admin","customer-care","technician"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Cw,{})})})}),f.jsx(K,{path:"/special-orders",element:f.jsx(te,{allowedRoles:["admin","sales","manager","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Tw,{})})})}),f.jsx(K,{path:"/installments",element:f.jsx(te,{allowedRoles:["admin","sales","manager","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Rw,{})})})}),f.jsx(K,{path:"/employees",element:f.jsx(te,{allowedRoles:["admin","manager"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Aw,{})})})}),f.jsx(K,{path:"/my-attendance",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(kw,{})})}),f.jsx(K,{path:"/employees/attendance",element:f.jsx(it,{to:"/employees?tab=attendance",replace:!0})}),f.jsx(K,{path:"/employees/attendance-management",element:f.jsx(it,{to:"/employees?tab=attendance-setup",replace:!0})}),f.jsx(K,{path:"/attendance",element:f.jsx(it,{to:"/employees?tab=attendance",replace:!0})}),f.jsx(K,{path:"/lats",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(ov,{})})})}),f.jsx(K,{path:"/pos",element:f.jsx(Zr,{fallback:ss,children:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(bv,{})})})})}),f.jsx(K,{path:"/lats/unified-inventory",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(hy,{children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(yv,{})})})})}),f.jsx(K,{path:"/lats/inventory-management",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(wv,{})})})}),f.jsx(K,{path:"/lats/storage-rooms",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(vv,{})})})}),f.jsx(K,{path:"/lats/storage-rooms/:id",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Sv,{})})})}),f.jsx(K,{path:"/lats/inventory",element:f.jsx(it,{to:"/lats/unified-inventory",replace:!0})}),f.jsx(K,{path:"/lats/products",element:f.jsx(it,{to:"/lats/unified-inventory",replace:!0})}),f.jsx(K,{path:"/lats/sales-reports",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(pv,{})})})}),f.jsx(K,{path:"/admin/reports",element:f.jsx(te,{allowedRoles:["admin","manager"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(fv,{})})})}),f.jsx(K,{path:"/lats/loyalty",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(gv,{})})})}),f.jsx(K,{path:"/lats/purchase-orders",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(iv,{})})})}),f.jsx(K,{path:"/lats/purchase-order/create",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(cv,{})})})}),f.jsx(K,{path:"/lats/purchase-orders/:id",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Po,{})})})}),f.jsx(K,{path:"/lats/purchase-orders/:id/edit",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Po,{editMode:!0})})})}),f.jsx(K,{path:"/test/set-pricing-modal",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(lv,{})})})}),f.jsx(K,{path:"/lats/purchase-orders/shipped-items",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(_v,{})})})}),f.jsx(K,{path:"/lats/purchase-orders/suppliers",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Eo,{})})})}),f.jsx(K,{path:"/lats/stock-transfers",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(dv,{})})})}),f.jsx(K,{path:"/lats/spare-parts",element:f.jsx(my,{enableImageUrlValidation:!0,enableUrlLogging:!1,children:f.jsx(te,{allowedRoles:["admin","technician"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(uv,{})})})})}),f.jsx(K,{path:"/lats/trade-in/management",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(hv,{})})})}),f.jsx(K,{path:"/lats/trade-in/create",element:f.jsx(te,{allowedRoles:["admin"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(mv,{})})})}),f.jsx(K,{path:"/bluetooth-printer",element:f.jsx(te,{allowedRoles:["admin","customer-care"],children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Ev,{})})})})]}),f.jsx(K,{path:"/customer-portal/login",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Uw,{})})}),f.jsx(K,{path:"/customer-portal/signup",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(jw,{})})}),f.jsx(K,{path:"/customer-portal/dashboard",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx($w,{})})}),f.jsx(K,{path:"/customer-portal/products",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Mw,{})})}),f.jsx(K,{path:"/customer-portal/products/:id",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(qw,{})})}),f.jsx(K,{path:"/customer-portal/profile",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Bw,{})})}),f.jsx(K,{path:"/customer-portal/orders",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Fw,{})})}),f.jsx(K,{path:"/customer-portal/loyalty",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(zw,{})})}),f.jsxs(K,{path:"/mobile",element:f.jsx(Py,{children:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Qw,{})})}),children:[f.jsx(K,{index:!0,element:f.jsx(it,{to:"/mobile/dashboard",replace:!0})}),f.jsx(K,{path:"dashboard",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Kw,{})})}),f.jsx(K,{path:"pos",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Jw,{})})}),f.jsx(K,{path:"inventory",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Yw,{})})}),f.jsx(K,{path:"inventory/add",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Xw,{})})}),f.jsx(K,{path:"inventory/:productId",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(sv,{})})}),f.jsx(K,{path:"clients",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Zw,{})})}),f.jsx(K,{path:"clients/:clientId",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(av,{})})}),f.jsx(K,{path:"clients/:clientId/edit",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(ev,{})})}),f.jsx(K,{path:"more",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(tv,{})})}),f.jsx(K,{path:"analytics",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(rv,{})})}),f.jsx(K,{path:"sheet-demo",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(nv,{})})})]}),f.jsx(K,{path:"/test-image-upload",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Vw,{})})}),f.jsx(K,{path:"/background-removal",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Gw,{})})}),f.jsx(K,{path:"/test-loading",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Ww,{})})}),f.jsx(K,{path:"/test-png-generation",element:f.jsx(D.Suspense,{fallback:f.jsx(Y,{}),children:f.jsx(Hw,{})})}),f.jsx(K,{path:"*",element:f.jsx(po,{})})]})]})};function gl(){["clean-app-cache","clean-app-offline-sync","user-goals","offline-cache","pending-actions"].forEach(e=>{const t=indexedDB.deleteDatabase(e);t.onsuccess=()=>console.log(`Deleted database: ${e}`),t.onerror=()=>console.error(`Error deleting database: ${e}`)})}function Nv(){try{gl(),localStorage.clear(),sessionStorage.clear(),console.log("All databases and storage cleared")}catch(s){console.error("Error clearing databases:",s)}}function Lv(){const[s,e]=D.useState(navigator.onLine),[t,r]=D.useState(!1);D.useEffect(()=>(uo.init(),console.log(" Global error handler initialized"),()=>{uo.cleanup()}),[]),D.useEffect(()=>{const n=sessionStorage.getItem(`scroll-pos-${window.location.pathname}`);n&&window.scrollTo(0,parseInt(n,10));const o=()=>{sessionStorage.setItem(`scroll-pos-${window.location.pathname}`,String(window.scrollY))};return window.addEventListener("beforeunload",o),window.addEventListener("popstate",o),()=>{window.removeEventListener("beforeunload",o),window.removeEventListener("popstate",o),o()}},[]),D.useEffect(()=>(fo.start(),()=>{fo.stop()}),[]),D.useEffect(()=>{Fi()},[]),D.useEffect(()=>{const n=i=>{const c=document.documentElement;switch(i){case"tiny":c.style.fontSize="11px";break;case"extra-small":c.style.fontSize="12px";break;case"small":c.style.fontSize="14px";break;case"medium":c.style.fontSize="16px";break;case"large":c.style.fontSize="18px";break}},o=localStorage.getItem("fontSize");n(o||"medium")},[]),D.useEffect(()=>{const n=o=>{console.error("Unhandled promise rejection:",o.reason),o.reason&&o.reason.message&&o.reason.message.includes("Cannot convert object to primitive value")&&(console.warn("Primitive conversion error caught globally, preventing crash"),o.preventDefault())};return window.addEventListener("unhandledrejection",n),()=>{window.removeEventListener("unhandledrejection",n)}},[]),D.useEffect(()=>{const n=console.error,o=console.warn,i=(u,h,g)=>{const p=`${u} ${h||""} ${g||""}`.toLowerCase();return!!(p.includes("extension context invalidated")||p.includes("chrome-extension://")||p.includes("moz-extension://")||p.includes("content.js")||p.includes("extension context")||h&&(h.includes("chrome-extension://")||h.includes("moz-extension://")||h.includes("content.js")))},c=u=>{const h=u.toLowerCase();return!!(h.includes("whatsapp integration not configured")||h.includes("[whatsapp]")&&h.includes("not configured"))};console.error=(...u)=>{const h=u.join(" "),g=u.find(m=>m instanceof Error),p=(g==null?void 0:g.stack)||"";i(h,void 0,p)||c(h)||n.apply(console,u)},console.warn=(...u)=>{const h=u.join(" "),g=u.find(m=>m instanceof Error),p=(g==null?void 0:g.stack)||"";i(h,void 0,p)||o.apply(console,u)};const l=u=>{var m;const h=u.message||"",g=u.filename||"",p=((m=u.error)==null?void 0:m.stack)||"";if(i(h,g,p))return u.preventDefault(),u.stopPropagation(),u.stopImmediatePropagation(),!1},d=u=>{var p,m;const h=((p=u.reason)==null?void 0:p.toString())||"",g=((m=u.reason)==null?void 0:m.stack)||"";if(i(h,void 0,g))return u.preventDefault(),u.stopPropagation(),!1};return window.addEventListener("error",l,!0),window.addEventListener("unhandledrejection",d,!0),()=>{console.error=n,console.warn=o,window.removeEventListener("error",l,!0),window.removeEventListener("unhandledrejection",d,!0)}},[]),D.useEffect(()=>{typeof window<"u"&&(window.clearAllDatabases=Nv,window.clearAllIndexedDB=gl)},[]),D.useEffect(()=>{function n(){e(!0)}function o(){e(!1)}return window.addEventListener("online",n),window.addEventListener("offline",o),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",o)}},[]);const a={}.VITE_ROUTER_BASENAME!==void 0?{}.VITE_ROUTER_BASENAME:"";return f.jsx(cy,{children:f.jsxs(xl,{basename:a,future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:[f.jsx(C_,{children:f.jsx(nd,{children:f.jsx(H_,{children:f.jsx(od,{children:f.jsx(ld,{children:f.jsx(W_,{children:f.jsx(ig,{children:f.jsx(Qg,{children:f.jsx(t_,{children:f.jsx(I_,{children:f.jsx(G_,{children:f.jsx(D_,{children:f.jsx(B_,{children:f.jsx(Ry,{children:f.jsx(sw,{children:f.jsx(uw,{children:f.jsxs(Ay,{children:[f.jsx(Ov,{isOnline:s,isSyncing:t}),f.jsx(Tv,{}),f.jsx(Jb,{}),f.jsx(Yb,{}),f.jsx(rw,{}),f.jsx(My,{}),f.jsx(J_,{})]})})})})})})})})})})})})})})})})}),f.jsx(Ll,{position:"top-right",toastOptions:{duration:4e3,style:{background:"#363636",color:"#fff"},success:{duration:3e3,iconTheme:{primary:"#10B981",secondary:"#fff"}},error:{duration:5e3,iconTheme:{primary:"#EF4444",secondary:"#fff"}}}})]})})}const _l={log:console.log,info:console.info,warn:console.warn,debug:console.debug},Uv=[/AudioContext.*not allowed to start/i,/AudioContext.*user gesture/i,/POST.*neon\.tech.*400/i,/WebSocket connection.*neon\.tech.*failed/i,/WebSocket connection to.*failed/i,/WebSocket is closed before the connection is established/i,/network connection was lost/i,/Connection timeout.*attempt/i,/ Connection timeout/i,/^Auth state changed:/,/PaymentMethodsContext.*Starting/i,/PaymentMethodsContext.*Loaded/i,/Payment methods refreshed/i,/FinanceAccountService.*Fetching/i,/FinanceAccountService.*Supabase/i,/FinanceAccountService.*Query result/i,/FinanceAccountService.*Fetched/i,/FinanceAccountService.*First method/i,/Using deduplicated.*query/i,//,/FETCHING SALES/i,/Current Branch:/,/Branch Name:/,/APPLYING BRANCH FILTER/i,/Filter: branch_id/,/SALES RETURNED:/i,/SAMPLE SALES/i,/SALE-.*TZS/,/Loaded.*POS sales/i,/Active session found/i,/^\[Analytics\]/,/^ \[.*\]/,/^ \[.*\]/,/^ \[SimpleBranchSelector\]/,/^ Loading branches/,/^ \[EnhancedInventoryTab\]/,/^ Suppliers/,/^ \[LiveInventoryService\]/,/^ \[formatCurrency\]/,/^ \[PurchaseOrdersPage\]/,/^ System view mode/,/^ Device Detection/,/^ \[POS\]/,/^ Session started/,/^ Starting supplier/,/^ Using cached/,/^ Branches loaded/,/^ Products loaded/],jv=/^[\u{1F300}-\u{1F9FF}]/u,$v=[/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/,/^/];function Mv(s,e){if(typeof localStorage<"u"&&localStorage.getItem("DEBUG_MODE")==="true")return!1;for(const t of Uv)if(t.test(s))return!0;if(jv.test(s))return!0;if(e){for(const t of $v)if(t.test(s))return!0}return!1}function as(s,...e){let r="";e.length>0&&(r=e.map(a=>typeof a=="string"?a:typeof a=="number"?String(a):typeof a=="object"?JSON.stringify(a):String(a)).join(" ")),Mv(r,!0)||_l[s](...e)}function qv(){if(typeof window>"u")return;console.log=(...e)=>as("log",...e),console.info=(...e)=>as("info",...e),console.warn=(...e)=>as("warn",...e),console.debug=(...e)=>as("debug",...e);const s=console.error;console.error=(...e)=>{const t=e.join(" "),r=n=>{const o=n.toLowerCase();return!!(o.includes("extension context invalidated")||o.includes("chrome-extension://")||o.includes("moz-extension://")||o.includes("content.js")||o.includes("extension context")||o.match(/content\.js:\d+/)||n.includes("at ")&&n.includes("content.js"))};if(r(t))return;const a=e.find(n=>n instanceof Error);a&&a.stack&&r(a.stack)||t.includes("neon.tech")&&(t.includes("400")||t.includes("Bad Request"))||t.includes("WebSocket")&&(t.includes("neon.tech")||t.includes("failed")||t.includes("closed before")||t.includes("connection to"))||t.includes("network connection was lost")||t.includes("Connection timeout")||t.includes(" Connection timeout")||t.includes("timeout (attempt")||t.includes("Slow database response")||t.includes("possible cold start")||s(...e)}}if(qv(),_l.log(" Console filter initialized - debug logs will be suppressed"),typeof window<"u"){const s=(e,t,r)=>{const a=`${e} ${t||""} ${r||""}`.toLowerCase();return!!(a.includes("extension context invalidated")||a.includes("chrome-extension://")||a.includes("moz-extension://")||a.includes("content.js")||a.includes("extension context")||t&&(t.includes("chrome-extension://")||t.includes("moz-extension://")||t.includes("content.js")))};window.addEventListener("error",e=>{var n;const t=e.message||"",r=e.filename||"",a=((n=e.error)==null?void 0:n.stack)||"";if(s(t,r,a))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1;if(t&&(t.includes("neon.tech")||t.includes("400")||t.includes("Bad Request")||t.includes("WebSocket")&&(t.includes("neon.tech")||t.includes("failed")||t.includes("closed before"))||t.includes("network connection was lost")||t.includes("Connection timeout")||t.includes("WebSocket connection to")))return e.preventDefault(),!1},!0),window.addEventListener("unhandledrejection",e=>{var a,n;const t=((a=e.reason)==null?void 0:a.toString())||"",r=((n=e.reason)==null?void 0:n.stack)||"";if(s(t,void 0,r))return e.preventDefault(),e.stopPropagation(),!1;if(e.reason&&typeof e.reason=="object"){const o=JSON.stringify(e.reason);if(o.includes("neon.tech")&&(o.includes("400")||o.includes("WebSocket")||o.includes("timeout")))return e.preventDefault(),!1}if(typeof e.reason=="string"&&(e.reason.includes("neon.tech")||e.reason.includes("network connection was lost")||e.reason.includes("WebSocket")||e.reason.includes("Connection timeout")))return e.preventDefault(),!1},!0)}oa.createRoot(document.getElementById("root")).render(f.jsx(er.StrictMode,{children:f.jsx(Lv,{})}));"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(s=>{console.log("Service Worker registered successfully:",s)}).catch(s=>{console.warn("Service Worker registration failed:",s)})}):"serviceWorker"in navigator;export{Ct as $,F0 as A,ah as B,Yd as C,th as D,Zr as E,rh as F,Ht as G,sh as H,Oa as I,$_ as J,ha as K,__ as L,Ue as M,p_ as N,g_ as O,f_ as P,X_ as Q,ey as R,z0 as S,eh as T,Et as U,ks as V,Zt as W,Ta as X,oS as Y,Q0 as Z,jc as _,el as a,Z0 as a$,B0 as a0,Ut as a1,M0 as a2,$0 as a3,La as a4,Zb as a5,vr as a6,sb as a7,rb as a8,ab as a9,W0 as aA,H0 as aB,q0 as aC,xe as aD,Xs as aE,wS as aF,Dr as aG,Er as aH,ow as aI,cw as aJ,Pb as aK,Fr as aL,Ub as aM,Fb as aN,al as aO,kb as aP,pe as aQ,Oc as aR,Nc as aS,Ug as aT,sl as aU,aS as aV,sS as aW,rS as aX,nl as aY,J0 as aZ,X0 as a_,cs as aa,A0 as ab,ih as ac,k0 as ad,zi as ae,Dd as af,Hi as ag,Yy as ah,Ri as ai,pt as aj,Cy as ak,Iy as al,Ti as am,gt as an,C0 as ao,Ka as ap,pS as aq,V_ as ar,mS as as,ky as at,cS as au,aw as av,hn as aw,x0 as ax,V0 as ay,G0 as az,Gg as b,eS as b0,tS as b1,is as b2,cb as b3,Vg as b4,Y0 as b5,S0 as b6,In as b7,E0 as b8,wa as b9,D0 as ba,dn as bb,nS as bc,uS as bd,dS as be,_o as bf,hS as bg,fS as bh,gS as bi,_S as bj,yS as bk,bS as bl,ng as c,Tt as d,Jc as e,lS as f,jn as g,Gb as h,ml as i,f as j,I0 as k,Wb as l,Un as m,Qd as n,_a as o,Gd as p,Pt as q,Qb as r,w as s,zr as t,Lt as u,un as v,Bi as w,K0 as x,id as y,iS as z};
