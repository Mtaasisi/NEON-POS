import{s as se,j as e,u as Wt,n as ir,o as cr,p as dr,e as ae,G as ce,b as mr,k as We,q as ur}from"./index-61458a34.js";import{r,R as hr,b as xr}from"./vendor-36d2c7c1.js";import{a as pr,c as fr}from"./routing-eb8c310c.js";import{C as gr}from"./SkeletonLoaders-da70324a.js";import{d as Le,f as At,g as Et,X as Oe,v as br,a9 as yr,b as ns,k as gt,_ as us,T as Vt,p as Dt,s as jr,ae as Se,q as hs,af as vr,r as Re,$ as xs,ag as Mt,ah as ps,j as Ut,D as Pt,I as fs,e as Ge,ai as Nr,n as Y,R as Je,a3 as wr,aj as Cr,l as pt,ak as ls,al as Sr,S as gs,P as ft,a5 as kr,am as Dr,an as bs,ao as Mr,ap as _r,aq as ys,ar as os,as as St,at as Ar,au as is,A as Er,m as zt,o as kt,av as Pr,y as Ir}from"./ui-28e30067.js";import{B as Lr}from"./BackButton-02a80e74.js";import{B as Or}from"./BulkSMSModal-ba796dbc.js";import{f as $r,a as Tr}from"./phoneUtils-a8934478.js";import{C as Fr}from"./CustomerDetailModal-ad4a2166.js";import{_ as _t}from"./supabase-cf010ec4.js";import{A as Rr}from"./AddCustomerModal-175a5a1a.js";import{A as zr}from"./AppointmentModal-91a07df7.js";import{f as Bt,c as Br,u as Vr}from"./appointments-0b344a33.js";import{u as Ur,S as Wr}from"./useSuccessModal-081786c4.js";import{u as qr}from"./useDialog-6eb5c329.js";import{g as cs,a as Yr}from"./search-cbe15294.js";import"./useBodyScrollLock-341c8b9f.js";import"./GlassTabs-05c8a392.js";import"./utils-95f4031a.js";import"./charts-d592fbd1.js";import"./whatsappService-09f99080.js";import"./Modal-a5e4c1ba.js";import"./CustomerForm-3440546b.js";import"./returns-8e3dd741.js";import"./format-aff4c6a2.js";import"./index-5a6a7dda.js";import"./pdf-e6e38bab.js";import"./SuccessModalIcons-fe811e4d.js";function Jr(p){if(!p)return"new";const l=p.trim().toLowerCase();return{normal:"new",vip:"vip",complainer:"complainer",purchased:"purchased","not normal":"new",new:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[l]||"new"}async function ds(p=1,l=50){try{console.log(`ðŸ“„ Fetching customers page ${p} with size ${l}`);const u=(p-1)*l;let c=se.from("customers").select(`
        id, name, email, phone, created_at, branch_id, is_shared, created_by_branch_name
      `,{count:"exact"}).range(u,u+l-1).order("created_at",{ascending:!1});const{addBranchFilter:h}=await _t(()=>import("./index-61458a34.js").then(v=>v.bb),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);c=await h(c,"customers");const{data:x,error:b,count:f}=await c;if(b)throw console.error("âŒ Error fetching paginated customers:",b),b;if(x){let v={};try{const g=[...new Set(x.map(d=>d.branch_id).filter(Boolean))];if(g.length>0){const S=await se.from("store_locations").select("id, name").in("id",g);S.data&&(v=S.data.reduce((A,P)=>(A[P.id]=P.name,A),{}))}}catch(g){console.warn("âš ï¸ Could not fetch branch names:",g)}const E=x.map(g=>({...g,joined_date:g.created_at,colorTag:Jr(g.color_tag||"new"),branchName:v[g.branch_id]||g.created_by_branch_name||"Unknown Branch",customerNotes:[],customerPayments:[],devices:[],promoHistory:[]})),J=Math.ceil((f||0)/l);return{customers:E,totalCount:f||0,total:f||0,page:p,pageSize:l,totalPages:J,hasNextPage:p<J,hasPreviousPage:p>1}}return{customers:[],totalCount:0,total:0,page:p,pageSize:l,totalPages:0,hasNextPage:!1,hasPreviousPage:!1}}catch(u){throw console.error("âŒ Error fetching paginated customers:",u),u}}const Gr=({isSearching:p,searchStatus:l="pending",searchProgress:u=0,resultCount:c,onCancel:h,className:x=""})=>{const[b,f]=r.useState(!0);if(r.useEffect(()=>{p&&f(!0)},[p]),r.useEffect(()=>{if(l==="completed"){const d=setTimeout(()=>f(!1),2e3);return()=>clearTimeout(d)}},[l]),!p||!b)return null;const v=()=>{switch(l){case"completed":return"bg-green-500";case"failed":return"bg-red-500";default:return"bg-blue-500"}},E=()=>{switch(l){case"processing":return"Searching...";case"completed":return c!==void 0?`Found ${c.toLocaleString()} customers`:"Complete";case"failed":return"Search failed";default:return"Searching..."}},J=()=>{switch(l){case"completed":return"bg-green-50 border-green-200";case"failed":return"bg-red-50 border-red-200";default:return"bg-blue-50 border-blue-200"}},g=()=>{switch(l){case"completed":return"text-green-700";case"failed":return"text-red-700";default:return"text-blue-700"}};return e.jsxs("div",{className:`relative overflow-hidden rounded-lg border ${J()} ${x}`,children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 h-0.5 bg-gray-200/50",children:e.jsx("div",{className:`h-full ${v()} transition-all duration-300 ease-out`,style:{width:`${u}%`}})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:l==="completed"?e.jsx(Le,{className:"w-4 h-4 text-green-600"}):l==="failed"?e.jsx(At,{className:"w-4 h-4 text-red-600"}):e.jsx(Et,{className:"w-4 h-4 text-blue-600 animate-spin"})}),e.jsx("p",{className:`text-sm font-medium ${g()} truncate`,children:E()}),l==="processing"&&u>0&&e.jsxs("span",{className:"text-xs text-gray-600 tabular-nums",children:[u,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0 ml-2",children:[l==="processing"&&h&&e.jsx("button",{onClick:h,className:"text-xs text-gray-600 hover:text-red-600 transition-colors px-2 py-0.5",title:"Cancel",children:"Cancel"}),e.jsx("button",{onClick:()=>f(!1),className:"text-gray-400 hover:text-gray-600 transition-colors p-0.5",title:"Dismiss",children:e.jsx(Oe,{className:"w-3.5 h-3.5"})})]})]})]})},Hr=({searchQuery:p,onSearchChange:l,loyaltyFilter:u,onLoyaltyFilterChange:c,statusFilter:h,onStatusFilterChange:x,tagFilter:b,onTagFilterChange:f,referralFilter:v,onReferralFilterChange:E,birthdayFilter:J,onBirthdayFilterChange:g,whatsappFilter:d,onWhatsappFilterChange:S,showInactive:A,onShowInactiveChange:P,sortBy:j,onSortByChange:L,customers:W,searchLoading:F=!1,filteredCount:O,genderFilter:Q,onGenderFilterChange:G,minSpent:ue,onMinSpentChange:X,maxSpent:I,onMaxSpentChange:M,minPoints:le,onMinPointsChange:ne,maxPoints:Ne,onMaxPointsChange:he,cityFilter:ye,onCityFilterChange:me,minPurchases:ke,onMinPurchasesChange:De,maxPurchases:$e,onMaxPurchasesChange:de,joinDateFrom:Me,onJoinDateFromChange:je,joinDateTo:oe,onJoinDateToChange:B,lastVisitFrom:xe,onLastVisitFromChange:_e,lastVisitTo:Ae,onLastVisitToChange:Ee})=>{const[Pe,o]=r.useState(!1),m=p||u.length>0||h.length>0||b.length>0||v.length>0||J||d||A||Q.length>0||ue||I||le||Ne||ye.length>0||ke||$e||Me||oe||xe||Ae,y=()=>{l(""),c([]),x([]),f([]),E([]),g(!1),S&&S(!1),P(!1),G([]),X(""),M(""),ne(""),he(""),me([]),De(""),de(""),je(""),B(""),_e(""),Ee("")},_=Array.from(new Set(W.map(i=>i.colorTag).filter(Boolean))),a=Array.from(new Set(W.map(i=>i.referralSource).filter(Boolean))),C=Array.from(new Set(W.map(i=>i.city).filter(Boolean)));return r.useMemo(()=>{const i=new Date,N=i.getMonth()+1,$=i.getDate();return W.filter(w=>!w.birthMonth||!w.birthDay?!1:["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(w.birthMonth.toLowerCase())+1===N&&parseInt(w.birthDay)===$)},[W]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(br,{size:18,className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"}),F&&e.jsx(Et,{size:18,className:"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-200 animate-spin opacity-30"}),e.jsx("input",{type:"text",value:p,onChange:i=>l(i.target.value),placeholder:"Search customers (type at least 2 characters)...",className:"w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 placeholder-gray-500",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",inputMode:"text"}),F&&e.jsx("div",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-300 opacity-40",children:[e.jsx(Et,{size:8,className:"animate-spin"}),e.jsx("span",{children:"Searching"})]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>o(!Pe),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${Pe?"bg-blue-50 text-blue-700 border border-blue-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,children:[e.jsx(yr,{size:16}),"Filters",m&&e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx(ns,{size:14,className:`transition-transform duration-200 ${Pe?"rotate-180":""}`})]}),m&&e.jsxs("button",{onClick:y,className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-200",children:[e.jsx(Oe,{size:14}),"Clear all"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[O!==void 0&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:O})," customers found"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:j,onChange:i=>L(i.target.value),className:"appearance-none px-4 py-2 pr-10 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm font-medium text-gray-700",children:[e.jsx("option",{value:"name",children:"Sort by Name"}),e.jsx("option",{value:"recent",children:"Sort by Recent"}),e.jsx("option",{value:"spent",children:"Sort by Spent"}),e.jsx("option",{value:"points",children:"Sort by Points"})]}),e.jsx(ns,{size:14,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"})]})]})]}),Pe&&e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-6 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(gt,{size:16,className:"inline mr-2 text-yellow-500"}),"Loyalty Level"]}),e.jsx("div",{className:"space-y-2",children:["interested","engaged","payment_customer","active","regular","premium","vip"].map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:u.includes(i),onChange:N=>{N.target.checked?c([...u,i]):c(u.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(us,{size:16,className:"inline mr-2 text-green-500"}),"Status"]}),e.jsx("div",{className:"space-y-2",children:["active","inactive"].map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:h.includes(i),onChange:N=>{N.target.checked?x([...h,i]):x(h.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(Vt,{size:16,className:"inline mr-2 text-purple-500"}),"Tags"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:_.length>0?_.map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:b.includes(i),onChange:N=>{N.target.checked?f([...b,i]):f(b.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i)):e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No tags assigned yet. Add tags to customers to filter by them."})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(Dt,{size:16,className:"inline mr-2 text-blue-500"}),"Gender"]}),e.jsx("div",{className:"space-y-2",children:["male","female","other"].map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:Q.includes(i),onChange:N=>{N.target.checked?G([...Q,i]):G(Q.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(jr,{size:16,className:"inline mr-2 text-green-500"}),"City"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:C.map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:ye.includes(i),onChange:N=>{N.target.checked?me([...ye,i]):me(ye.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(Se,{size:16,className:"inline mr-2 text-orange-500"}),"Referral Source"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:a.map(i=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:v.includes(i),onChange:N=>{N.target.checked?E([...v,i]):E(v.filter($=>$!==i))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900 capitalize",children:i})]},i))})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Range Filters"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(hs,{size:16,className:"inline mr-2 text-green-500"}),"Total Spent (TSH)"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:ue,onChange:i=>X(i.target.value),placeholder:"Min amount (TSH)",min:"0",step:"100",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:I,onChange:i=>M(i.target.value),placeholder:"Max amount (TSH)",min:"0",step:"100",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(gt,{size:16,className:"inline mr-2 text-yellow-500"}),"Points"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:le,onChange:i=>ne(i.target.value),placeholder:"Min points",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:Ne,onChange:i=>he(i.target.value),placeholder:"Max points",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(vr,{size:16,className:"inline mr-2 text-purple-500"}),"Purchase Count"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"number",value:ke,onChange:i=>De(i.target.value),placeholder:"Min purchases",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"number",value:$e,onChange:i=>de(i.target.value),placeholder:"Max purchases",min:"0",step:"1",className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Date Range Filters"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(Re,{size:16,className:"inline mr-2 text-blue-500"}),"Join Date"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:Me,onChange:i=>je(i.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"date",value:oe,onChange:i=>B(i.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-900 mb-3",children:[e.jsx(Re,{size:16,className:"inline mr-2 text-green-500"}),"Last Visit"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:xe,onChange:i=>_e(i.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),e.jsx("input",{type:"date",value:Ae,onChange:i=>Ee(i.target.value),className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"})]})]})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Quick Filters"}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:J,onChange:i=>g(i.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(Re,{size:16,className:"text-pink-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Has birthday"})]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:i=>S==null?void 0:S(i.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(xs,{size:16,className:"text-green-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Has WhatsApp"})]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:i=>P(i.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 group-hover:text-gray-900",children:"Show inactive only"})]})]})]})]})]})},Kr=({isOpen:p,onClose:l,onImportComplete:u})=>{const{currentUser:c}=Wt(),[h,x]=r.useState(null),[b,f]=r.useState([]),[v,E]=r.useState([]),[J,g]=r.useState(!1),[d,S]=r.useState(!1),[A,P]=r.useState("upload"),[j,L]=r.useState(0),[W,F]=r.useState([]),[O,Q]=r.useState([]),[G,ue]=r.useState(!1),[X,I]=r.useState([]),[M,le]=r.useState(!1),[ne,Ne]=r.useState(new Set),he=r.useRef(null),ye=o=>{if(!o)return"";const m=o.replace(/[\s\-()]/g,"");return m.startsWith("+255")||m.startsWith("255")?m:m.startsWith("0")?"+255"+m.substring(1):(m.length===9&&/^\d+$/.test(m),"255"+m)},me=o=>{if(!o)return"";const m=o.replace(/[\s\-()]/g,"");return m.startsWith("+255")||m.startsWith("255")?m:m.startsWith("0")?"+255"+m.substring(1):(m.length===9&&/^\d+$/.test(m),"255"+m)},ke=o=>{if(!o)return"";const m=o.trim();return m===m.toUpperCase()&&m.length>1?m.toLowerCase().replace(/\b\w/g,y=>y.toUpperCase()):m===m.toUpperCase()?m.toLowerCase().replace(/\b\w/g,y=>y.toUpperCase()):m},De=o=>{if(!o)return"other";const m=o.trim().toLowerCase();return m==="male"||m==="m"?"male":m==="female"||m==="f"?"female":"other"},$e=o=>{if(!o)return"";const m=o.trim(),y={mtandaoni:"Social Media",physically:"Walk-in",recommendation:"Friend","social media":"Social Media",facebook:"Facebook",google:"Google",friend:"Friend",family:"Family",colleague:"Colleague",advertisement:"Advertisement",website:"Website","walk-in":"Walk-in",referral:"Referral",other:"Other"},_=m.toLowerCase();return y[_]?y[_]:m===m.toUpperCase()&&m.length>1?m.toLowerCase().replace(/\b\w/g,a=>a.toUpperCase()):m},de=o=>{if(!o)return"";const m=o.trim(),y={dsm:"Dar es Salaam",dar:"Dar es Salaam","dar es":"Dar es Salaam","dar es salaam":"Dar es Salaam",mara:"Mara",moro:"Morogoro",arusha:"Arusha",mwanza:"Mwanza",dodoma:"Dodoma",tanga:"Tanga",mbeya:"Mbeya",morogoro:"Morogoro",tabora:"Tabora",singida:"Singida",kigoma:"Kigoma",shinyanga:"Shinyanga",kagera:"Kagera",manyara:"Manyara",njombe:"Njombe",katavi:"Katavi",geita:"Geita",simiyu:"Simiyu",songwe:"Songwe"},_=m.toLowerCase();return y[_]?y[_]:m},Me=o=>{if(!o)return{month:"",day:""};const m=o.trim().toLowerCase(),y=/^(\d{1,2})-([a-z]{3,})$/,_=m.match(y);if(_){const i=_[1],N=_[2],w={jan:"January",feb:"February",fe:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December"}[N];if(w)return{month:(new Date(`${w} 1, 2000`).getMonth()+1).toString(),day:i}}const a=/^([a-z]{3,})-(\d{1,2})$/,C=m.match(a);if(C){const i=C[1],N=C[2],w={jan:"January",feb:"February",fe:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December"}[i];if(w)return{month:(new Date(`${w} 1, 2000`).getMonth()+1).toString(),day:N}}return{month:"",day:""}};r.useEffect(()=>{const o=m=>{const y=document.getElementById("column-expand-dropdown"),_=m.target;y&&!y.contains(_)&&!_.closest("[data-dropdown-button]")&&y.classList.add("hidden")};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const je=(o,m)=>{var _,a;const y=[];if((_=o.name)!=null&&_.trim()||y.push(`Row ${m}: Name is required`),(a=o.phone)!=null&&a.trim()?/^[+]?[0-9\s\-()]{8,}$/.test(o.phone)||y.push(`Row ${m}: Invalid phone number format`):y.push(`Row ${m}: Phone number is required`),o.gender&&!["male","female","other"].includes(o.gender)&&y.push(`Row ${m}: Gender must be male, female, or other`),o.loyaltyLevel&&!["bronze","silver","gold","platinum"].includes(o.loyaltyLevel)&&y.push(`Row ${m}: Invalid loyalty level`),o.birthMonth&&!o.birthDay&&y.push(`Row ${m}: Birth day is required if birth month is provided`),o.birthDay&&!o.birthMonth&&y.push(`Row ${m}: Birth month is required if birth day is provided`),o.birthDay){const C=parseInt(o.birthDay);(isNaN(C)||C<1||C>31)&&y.push(`Row ${m}: Birth day must be a number between 1-31`)}return y},oe=(o,m)=>je(o,m+2),B=(o,m,y)=>oe(o,m).some(a=>a.toLowerCase().includes(y.toLowerCase())||y==="name"&&a.includes("Name is required")||y==="phone"&&(a.includes("Phone number is required")||a.includes("Invalid phone number format"))),xe=o=>{var y;const m=(y=o.target.files)==null?void 0:y[0];if(m){if(m.size>5*1024*1024){Y.error("File size must be less than 5MB");return}x(m),_e(m)}},_e=async o=>{var m;try{g(!0),Q([]);const _=(await o.text()).split(`
`).filter(N=>N.trim());if(_.length<2){Y.error("File must contain at least a header row and one data row");return}const a=((m=_[0])==null?void 0:m.split(",").map(N=>N.trim().toLowerCase()))||[],C=[],i=[];for(let N=1;N<_.length;N++){const $=_[N].trim();if(!$)continue;const w=$.split(",").map(Z=>Z.trim().replace(/^"|"$/g,"")),T=w[a.indexOf("phone")]||w[a.indexOf("phone number")]||w[a.indexOf("mobile")]||w[a.indexOf("mobile phone")]||w[a.indexOf("primary phone")]||w[a.indexOf("phone 1 - value")]||"",K=w[a.indexOf("whatsapp")]||w[a.indexOf("whatsapp number")]||"",z={name:ke(w[a.indexOf("name")]||w[a.indexOf("full name")]||w[a.indexOf("customer name")]||w[a.indexOf("first name")]||""),email:"",phone:ye(T),gender:De(w[a.indexOf("gender")]||"other"),city:de(w[a.indexOf("city")]||w[a.indexOf("location")]||w[a.indexOf("home city")]||w[a.indexOf("business city")]||""),whatsapp:me(K),notes:w[a.indexOf("notes")]||w[a.indexOf("comments")]||"",loyaltyLevel:w[a.indexOf("loyalty")]||w[a.indexOf("loyalty level")]||"bronze",colorTag:w[a.indexOf("color tag")]||w[a.indexOf("tag")]||"new",birthMonth:w[a.indexOf("birth month")]||w[a.indexOf("month")]||"",birthDay:w[a.indexOf("birth day")]||w[a.indexOf("day")]||"",referralSource:$e(w[a.indexOf("referral source")]||w[a.indexOf("referral")]||w[a.indexOf("referred by")]||w[a.indexOf("referral resource")]||""),referralSourceCustom:w[a.indexOf("referral source custom")]||w[a.indexOf("custom referral")]||""},U=w[a.indexOf("birthday")]||w[a.indexOf("birth day")]||w[a.indexOf("birth")]||w[a.indexOf("birth date")]||"";if(U){const Z=Me(U);Z.month&&Z.day&&(z.birthMonth=Z.month,z.birthDay=Z.day)}if(z.birthMonth&&z.birthMonth.includes("-")){const Z=Me(z.birthMonth);Z.month&&Z.day&&(z.birthMonth=Z.month,z.birthDay=Z.day)}const te=je(z,N+1);i.push(...te),z.name&&z.phone&&C.push(z)}Q(i),f(C),I([...C]),E(C.slice(0,5)),P("preview"),i.length>0?Y.error(`Found ${i.length} validation errors. Please review before importing.`):Y.success(`Successfully processed ${C.length} customers`)}catch(y){console.error("Error processing file:",y),Y.error("Error processing file. Please ensure it's a valid CSV/Excel file.")}finally{g(!1)}},Ae=async()=>{if((c==null?void 0:c.role)!=="admin"){Y.error("Only administrators can import customers");return}const o=G?X:b;if(o.length===0){Y.error("No data to import. Please add at least one customer.");return}O.length>0&&Y.error(`Found ${O.length} validation errors. Invalid rows will be skipped.`);try{S(!0),L(0),F([]);const y=[],_=[];for(let N=0;N<o.length;N++){const $=o[N],w=je($,N+2);if(w.length>0){_.push({success:!1,error:`Validation errors: ${w.join(", ")}`,rowNumber:N+2});continue}try{const T=await ir({id:crypto.randomUUID(),name:$.name,email:$.email,phone:ye($.phone),gender:$.gender,city:$.city,whatsapp:me($.whatsapp||""),initialNotes:$.notes,loyaltyLevel:$.loyaltyLevel||"bronze",colorTag:$.colorTag||"new",birthMonth:$.birthMonth,birthDay:$.birthDay,referralSource:$.referralSource,joinedDate:new Date().toISOString(),totalSpent:0,points:0,lastVisit:new Date().toISOString(),isActive:!0,notes:[],referrals:[]});T?(y.push(T),_.push({success:!0,customer:T,rowNumber:N+2})):_.push({success:!1,error:"Failed to create customer",rowNumber:N+2})}catch(T){console.error(`Error creating customer ${$.name}:`,T),_.push({success:!1,error:T instanceof Error?T.message:"Unknown error",rowNumber:N+2})}L((N+1)/o.length*100),F(_)}const a=_.filter(N=>N.success).length,C=_.filter(N=>{var $;return!N.success&&(($=N.error)==null?void 0:$.includes("Validation errors"))}).length,i=_.filter(N=>{var $;return!N.success&&!(($=N.error)!=null&&$.includes("Validation errors"))}).length;a>0&&(Y.success(`Successfully imported ${a} customers!`),u(y)),C>0&&Y.success(`Skipped ${C} rows with validation errors.`),i>0&&Y.error(`${i} customers failed to import. Check the results below.`),P("import")}catch(y){console.error("Import error:",y),Y.error("Error importing customers. Please try again.")}finally{S(!1)}},Ee=()=>{x(null),f([]),I([]),E([]),P("upload"),g(!1),S(!1),ue(!1),le(!1),Ne(new Set),L(0),F([]),Q([]),he.current&&(he.current.value=""),l()},Pe=()=>{const m=`name,email,phone,gender,city,whatsapp,birth month,birth day,referral source,notes,loyalty level,color tag
John Doe,john@example.com,748757641,male,DSM,748757641,January,15,MTANDAONI,New customer,bronze,new
Jane Smith,jane@example.com,717377078,female,MARA,717377078,March,22,RECOMMENDATION,VIP customer,silver,vip
Mike Johnson,mike@example.com,676947420,male,MORO,676947420,December,5,PHYSICALLY,Regular customer,gold,new
Alice Brown,alice@example.com,655123456,female,DSM,655123456,June,10,INSTAGRAM,Social media customer,platinum,purchased`,y=new Blob([m],{type:"text/csv;charset=utf-8;"}),_=window.URL.createObjectURL(y),a=document.createElement("a");a.href=_,a.download="customer_import_template.csv",a.click(),window.URL.revokeObjectURL(_),Y.success("Template downloaded! To add dropdowns in Excel: Select column â†’ Data â†’ Data Validation â†’ List â†’ Enter values separated by commas")};return!p||(c==null?void 0:c.role)!=="admin"?null:e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[99999] p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-8 bg-gradient-to-r from-green-600 to-emerald-600 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center shadow-lg",children:e.jsx(Mt,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-1",children:"Import Customers from Excel"}),e.jsxs("p",{className:"text-base text-green-100 font-medium",children:[A==="upload"&&"Step 1: Upload File or Manual Entry",A==="preview"&&"Step 2: Review & Edit Data",A==="import"&&"Step 3: Import Progress"]})]})]}),e.jsx("button",{onClick:Ee,disabled:d,className:"w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors disabled:opacity-50",children:e.jsx(Oe,{className:"w-5 h-5 text-white"})})]}),e.jsx("div",{className:"flex items-center justify-between",children:[1,2,3].map(o=>{const y=["upload","preview","import"].indexOf(A)+1;return e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full font-bold text-base shadow-lg ${y>o?"bg-green-500 text-white":y===o?"bg-white text-green-600":"bg-white/20 text-white/60"}`,children:y>o?"âœ“":o}),o<3&&e.jsx("div",{className:`flex-1 h-2 mx-2 rounded-full ${y>o?"bg-green-500":"bg-white/20"}`})]},o)})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-8",children:[A==="upload"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center bg-green-50 border-2 border-green-200 rounded-2xl p-8",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(ps,{className:"w-10 h-10 text-white"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-3",children:"Upload Customer Data"}),e.jsx("p",{className:"text-base text-gray-600 mb-6",children:"Import customers from Excel/CSV file or enter them manually. Download the template below for the correct format."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("button",{onClick:()=>{var o;return(o=he.current)==null?void 0:o.click()},disabled:J,className:"px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-base font-bold transition-all shadow-lg flex items-center justify-center gap-2",children:[e.jsx(Mt,{className:"w-5 h-5"}),J?"Processing...":"Upload Excel/CSV"]}),e.jsxs("button",{onClick:()=>{P("preview"),ue(!0),I([{name:"",email:"",phone:"",gender:"other",city:"",whatsapp:"",birthMonth:"",birthDay:"",referralSource:"",notes:"",loyaltyLevel:"bronze",colorTag:"new"}])},className:"px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl hover:from-purple-600 hover:to-pink-700 text-base font-bold transition-all shadow-lg flex items-center justify-center gap-2",children:[e.jsx(Ut,{className:"w-5 h-5"}),"Manual Entry"]}),e.jsxs("button",{onClick:Pe,className:"px-6 py-4 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-xl hover:from-gray-700 hover:to-gray-800 text-base font-bold transition-all shadow-lg flex items-center justify-center gap-2",children:[e.jsx(Pt,{className:"w-5 h-5"}),"Download Template"]})]}),e.jsx("input",{ref:he,type:"file",accept:".csv,.xlsx,.xls",onChange:xe,className:"hidden"})]}),e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-xl p-6",children:[e.jsxs("h4",{className:"font-bold text-blue-900 mb-4 text-lg flex items-center gap-2",children:[e.jsx(fs,{className:"w-5 h-5"}),"Required Columns in Your Excel/CSV:"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-blue-200",children:[e.jsx("p",{className:"font-bold text-gray-900 text-sm mb-1",children:"âœ“ Name"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Customer's full name (Required)"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-blue-200",children:[e.jsx("p",{className:"font-bold text-gray-900 text-sm mb-1",children:"âœ“ Phone"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Phone number (Required)"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-gray-700 text-sm mb-1",children:"Gender"}),e.jsx("p",{className:"text-xs text-gray-500",children:"male, female, other"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-gray-700 text-sm mb-1",children:"City"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Customer's city"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-gray-700 text-sm mb-1",children:"WhatsApp"}),e.jsx("p",{className:"text-xs text-gray-500",children:"WhatsApp number (optional)"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3",children:[e.jsx("p",{className:"font-semibold text-gray-700 text-sm mb-1",children:"Birthday"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Format: 15-Mar or DD-MMM"})]})]})]}),e.jsxs("div",{className:"bg-purple-50 border-2 border-purple-200 rounded-xl p-6",children:[e.jsx("h4",{className:"font-bold text-purple-900 mb-4 text-base flex items-center gap-2",children:"ðŸ“ Valid Values for Dropdown Fields:"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-purple-200",children:[e.jsx("strong",{className:"text-gray-900",children:"Loyalty Level:"}),e.jsx("p",{className:"text-gray-700 mt-1",children:"bronze, silver, gold, platinum"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-purple-200",children:[e.jsx("strong",{className:"text-gray-900",children:"Color Tag:"}),e.jsx("p",{className:"text-gray-700 mt-1",children:"new, vip, complainer, purchased"})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-purple-200 md:col-span-2",children:[e.jsx("strong",{className:"text-gray-900",children:"Referral Source:"}),e.jsx("p",{className:"text-gray-700 mt-1",children:"MTANDAONI, RECOMMENDATION, PHYSICALLY, INSTAGRAM, FACEBOOK, GOOGLE, FRIEND, FAMILY, OTHER"})]})]})]})]}),A==="preview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-xl p-5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-blue-900 mb-2",children:b.length>0?"ðŸ“Š Preview & Edit Data":"âœï¸ Manual Entry Mode"}),e.jsx("p",{className:"text-sm text-blue-700",children:b.length>0?`${b.length} customers found in file`:"Add customers manually one by one"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ue(!G),className:`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${G?"bg-blue-600 text-white hover:bg-blue-700 shadow-md":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:G?"âœ“ Edit Mode ON":"Edit Mode OFF"}),e.jsx("button",{onClick:()=>le(!M),className:`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${M?"bg-purple-600 text-white hover:bg-purple-700 shadow-md":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:M?"Compact":"Normal"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{"data-dropdown-button":!0,onClick:()=>{const o=document.getElementById("column-expand-dropdown");o&&o.classList.toggle("hidden")},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-semibold transition-all",children:"Columns â–¼"}),e.jsxs("div",{id:"column-expand-dropdown",className:"hidden absolute top-full right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-48",children:[e.jsx("div",{className:"p-2 text-xs text-gray-500 border-b",children:"Select columns to expand:"}),[{key:"name",label:"Name"},{key:"phone",label:"Phone"},{key:"email",label:"Email"},{key:"city",label:"City"},{key:"whatsapp",label:"WhatsApp"},{key:"referral",label:"Referral Source"},{key:"notes",label:"Notes"}].map(o=>e.jsxs("label",{className:"flex items-center gap-2 p-2 hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ne.has(o.key),onChange:m=>{const y=new Set(ne);m.target.checked?y.add(o.key):y.delete(o.key),Ne(y)},className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm",children:o.label})]},o.key))]})]})]})]})}),O.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-yellow-800 mb-2 flex items-center gap-2",children:[e.jsx(Ge,{className:"w-4 h-4"}),"Validation Warnings (",O.length," rows will be skipped):"]}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:e.jsxs("ul",{className:"text-sm text-yellow-700 space-y-1",children:[O.slice(0,10).map((o,m)=>e.jsxs("li",{children:["â€¢ ",o]},m)),O.length>10&&e.jsxs("li",{className:"text-yellow-600",children:["... and ",O.length-10," more warnings"]})]})}),e.jsxs("div",{className:"mt-3 p-2 bg-yellow-100 rounded text-sm text-yellow-800",children:[e.jsx("strong",{children:"Note:"})," Rows with validation errors will be automatically skipped during import. Valid customers will still be imported successfully."]})]}),G&&e.jsx("div",{className:"mb-4",children:e.jsx("button",{onClick:()=>{const o={name:"",email:"",phone:"",gender:"other",city:"",whatsapp:"",birthMonth:"",birthDay:"",referralSource:"",notes:"",loyaltyLevel:"bronze",colorTag:"new"};I([...X,o])},className:"px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium hover:bg-gray-200 transition-colors",children:"+ Add Row"})}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:`w-full ${M?"text-xs":"text-sm"} min-w-full`,children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("name")?"w-32":"w-20":""} ${G?"min-w-32":""}`,children:"Name"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("phone")?"w-32":"w-24":""} ${G?"min-w-36":""}`,children:"Phone"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?"w-16":""} ${G?"min-w-20":""}`,children:"Gender"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("city")?"w-32":"w-20":""} ${G?"min-w-28":""}`,children:"City"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("whatsapp")?"w-32":"w-20":""} ${G?"min-w-32":""}`,children:"WhatsApp"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?"w-20":""} ${G?"min-w-24":""}`,children:"Birthday"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("referral")?"w-32":"w-16":""} ${G?"min-w-32":""}`,children:"Referral"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?ne.has("notes")?"w-40":"w-20":""} ${G?"min-w-48":""}`,children:"Notes"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?"w-16":""} ${G?"min-w-20":""}`,children:"Loyalty"}),e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?"w-16":""} ${G?"min-w-20":""}`,children:"Color Tag"}),G&&e.jsx("th",{className:`text-left ${M?"p-1":"p-2"} ${M?"w-12":""} ${G?"min-w-16":""}`,children:"Actions"})]})}),e.jsx("tbody",{children:(G?X:v.length>0?v:b).map((o,m)=>e.jsxs("tr",{className:`border-b ${oe(o,m).length>0?"bg-yellow-50":""}`,children:[e.jsxs("td",{className:`${M?"p-1":"p-2"} relative ${B(o,m,"name")?"bg-yellow-100 border-l-4 border-yellow-500":""}`,children:[B(o,m,"name")&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs",children:"âš ï¸"})}),G?e.jsx("input",{type:"text",value:o.name||"",onChange:y=>{const _=[...X];_[m].name=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):e.jsx("span",{className:B(o,m,"name")?"text-yellow-800":"",children:o.name||(B(o,m,"name")?"âš ï¸ Required":"")})]}),e.jsxs("td",{className:`${M?"p-1":"p-2"} relative ${B(o,m,"phone")?"bg-yellow-100 border-l-4 border-yellow-500":""}`,children:[B(o,m,"phone")&&e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs",children:"âš ï¸"})}),G?e.jsx("input",{type:"text",value:o.phone||"",onChange:y=>{const _=[...X];_[m].phone=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):e.jsx("span",{className:B(o,m,"phone")?"text-yellow-800":"",children:o.phone||(B(o,m,"phone")?"âš ï¸ Required":"")})]}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsxs("select",{value:o.gender||"other",onChange:y=>{const _=[...X];_[m].gender=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"female",children:"Female"}),e.jsx("option",{value:"other",children:"Other"})]}):e.jsx("span",{className:"capitalize",children:o.gender})}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsx("input",{type:"text",value:o.city||"",onChange:y=>{const _=[...X];_[m].city=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):o.city}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsx("input",{type:"text",value:o.whatsapp||"",onChange:y=>{const _=[...X];_[m].whatsapp=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):o.whatsapp||"-"}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"text",placeholder:"Month",value:o.birthMonth||"",onChange:y=>{const _=[...X];_[m].birthMonth=y.target.value,I(_)},className:"w-20 bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}),e.jsx("input",{type:"number",placeholder:"Day",min:"1",max:"31",value:o.birthDay||"",onChange:y=>{const _=[...X];_[m].birthDay=y.target.value,I(_)},className:"w-16 bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"})]}):o.birthMonth&&o.birthDay?`${o.birthMonth} ${o.birthDay}`:"-"}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsx("input",{type:"text",value:o.referralSource||"",onChange:y=>{const _=[...X];_[m].referralSource=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5"}):o.referralSource||"-"}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsx("textarea",{value:o.notes||"",onChange:y=>{const _=[...X];_[m].notes=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 resize-none",rows:1,placeholder:"Notes..."}):e.jsx("span",{className:"text-xs text-gray-600 max-w-xs truncate block",title:o.notes,children:o.notes||"-"})}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsxs("select",{value:o.loyaltyLevel||"bronze",onChange:y=>{const _=[...X];_[m].loyaltyLevel=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"bronze",children:"Bronze"}),e.jsx("option",{value:"silver",children:"Silver"}),e.jsx("option",{value:"gold",children:"Gold"}),e.jsx("option",{value:"platinum",children:"Platinum"})]}):e.jsx("span",{className:"capitalize",children:o.loyaltyLevel})}),e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:G?e.jsxs("select",{value:o.colorTag||"new",onChange:y=>{const _=[...X];_[m].colorTag=y.target.value,I(_)},className:"w-full bg-transparent border-none outline-none text-sm focus:bg-white focus:border focus:border-blue-300 focus:rounded px-1 py-0.5 capitalize",children:[e.jsx("option",{value:"new",children:"New"}),e.jsx("option",{value:"vip",children:"VIP"}),e.jsx("option",{value:"complainer",children:"Complainer"}),e.jsx("option",{value:"purchased",children:"Purchased"})]}):e.jsx("span",{className:"capitalize",children:o.colorTag})}),G&&e.jsx("td",{className:`${M?"p-1":"p-2"}`,children:e.jsx("button",{onClick:()=>{const y=[...X];y.splice(m,1),I(y)},className:"text-red-600 hover:text-red-800 text-sm",title:"Remove row",children:"âœ•"})})]},m))})]})})}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx("button",{onClick:()=>P("upload"),className:"px-8 py-4 bg-white border-2 border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition-all font-bold text-base",children:"â† Back"}),e.jsxs("button",{onClick:()=>P("import"),className:"flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full hover:from-green-600 hover:to-emerald-700 transition-all font-bold shadow-lg text-base flex items-center justify-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5"}),O.length>0?`Import ${X.filter((o,m)=>je(o,m+2).length===0).length} Valid Customers`:`Import ${X.length} Customers`]})]})]}),A==="import"&&e.jsxs("div",{className:"space-y-6",children:[d?e.jsxs("div",{className:"p-8 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border-2 border-blue-200 shadow-lg",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse shadow-xl",children:e.jsx(Mt,{className:"w-10 h-10 text-white"})}),e.jsx("h3",{className:"text-2xl font-bold text-blue-900 mb-2",children:"Importing Customers..."}),e.jsx("p",{className:"text-base text-blue-700 font-medium",children:"Please keep this window open"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-base font-bold text-blue-900",children:"Progress"}),e.jsxs("span",{className:"text-2xl font-bold text-blue-700",children:[W.length," / ",b.length]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-6 overflow-hidden shadow-inner",children:e.jsx("div",{className:"h-6 bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-300 flex items-center justify-end pr-3",style:{width:`${j}%`},children:e.jsxs("span",{className:"text-sm text-white font-bold",children:[Math.round(j),"%"]})})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-5 bg-white rounded-xl border-2 border-green-200 shadow-sm",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2 font-medium",children:"Successful"}),e.jsxs("p",{className:"text-4xl font-bold text-green-600",children:["âœ“ ",W.filter(o=>o.success).length]})]}),e.jsxs("div",{className:"p-5 bg-white rounded-xl border-2 border-red-200 shadow-sm",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2 font-medium",children:"Failed"}),e.jsxs("p",{className:"text-4xl font-bold text-red-600",children:["âœ— ",W.filter(o=>!o.success).length]})]})]})]}):e.jsxs("div",{className:"p-8 bg-green-50 border-2 border-green-200 rounded-2xl shadow-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl",children:e.jsx(Le,{className:"w-12 h-12 text-white"})}),e.jsx("h3",{className:"text-3xl font-bold text-green-900 mb-3",children:"âœ… Import Complete!"}),e.jsxs("p",{className:"text-base text-green-700 font-medium mb-6",children:["Processed ",b.length," customers from your file"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white border-2 border-green-300 rounded-xl p-5 shadow-sm",children:[e.jsx("h4",{className:"font-semibold text-green-800 mb-2",children:"Successful"}),e.jsx("p",{className:"text-4xl font-bold text-green-900",children:W.filter(o=>o.success).length})]}),e.jsxs("div",{className:"bg-white border-2 border-red-300 rounded-xl p-5 shadow-sm",children:[e.jsx("h4",{className:"font-semibold text-red-800 mb-2",children:"Failed"}),e.jsx("p",{className:"text-4xl font-bold text-red-900",children:W.filter(o=>!o.success).length})]}),e.jsxs("div",{className:"bg-white border-2 border-blue-300 rounded-xl p-5 shadow-sm",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"Total"}),e.jsx("p",{className:"text-4xl font-bold text-blue-900",children:W.length})]})]})]}),W.filter(o=>!o.success).length>0&&e.jsxs("div",{className:"bg-white border-2 border-red-200 rounded-xl p-5",children:[e.jsxs("h4",{className:"font-bold text-red-800 mb-3 text-base flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5"}),"Failed Imports (",W.filter(o=>!o.success).length,"):"]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:e.jsx("ul",{className:"text-sm text-red-700 space-y-2 font-medium",children:W.filter(o=>!o.success).map((o,m)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(At,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("span",{children:["Row ",o.rowNumber,": ",o.error]})]},m))})})]})]}),!d&&e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx("button",{onClick:()=>P("preview"),className:"px-8 py-4 bg-white border-2 border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition-all font-bold text-base",children:"â† Back"}),e.jsxs("button",{onClick:Ee,className:"flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full hover:from-green-600 hover:to-emerald-700 transition-all font-bold shadow-lg text-base flex items-center justify-center gap-2",children:[e.jsx(Nr,{className:"w-5 h-5"}),"Done"]})]}),d&&e.jsxs("button",{onClick:Ae,disabled:!0,className:"w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full opacity-50 cursor-not-allowed transition-all font-bold shadow-lg text-base flex items-center justify-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Importing..."]})]})]})]})})},Qr=hr.memo(({isOpen:p,onClose:l,onImportComplete:u})=>{r.useEffect(()=>{console.log(p?"CustomerUpdateImportModal: opened":"CustomerUpdateImportModal: closed")},[p]);const{currentUser:c}=Wt(),[h,x]=r.useState(null),[b,f]=r.useState([]),[v,E]=r.useState([]),[J,g]=r.useState(!1),[d,S]=r.useState(!1),[A,P]=r.useState("upload"),[j,L]=r.useState(0),[W,F]=r.useState([]),[O,Q]=r.useState([]),[G,ue]=r.useState(new Map),[X,I]=r.useState(new Map),[M,le]=r.useState(!0),[ne,Ne]=r.useState([]),[he,ye]=r.useState(!0),me=r.useRef(null),ke=$r,De=Tr,$e=r.useCallback(a=>{if(!a)return"";const C=a.trim();return C===C.toUpperCase()&&C.length>1?C.toLowerCase().replace(/\b\w/g,i=>i.toUpperCase()):C===C.toUpperCase()?C.toLowerCase().replace(/\b\w/g,i=>i.toUpperCase()):C},[]),de=r.useCallback(a=>{if(!a)return"male";const C=a.trim().toLowerCase();return C==="male"||C==="m"?"male":C==="female"||C==="f"?"female":C==="other"||C==="o"?"other":"male"},[]),Me=r.useCallback(a=>{if(!a)return"";const C=a.trim().toLowerCase();return{facebook:"Facebook",twitter:"Twitter",tiktok:"TikTok",friend:"Friend",family:"Family","walk-in":"Walk-in",walkin:"Walk-in","walk in":"Walk-in","social media":"Social Media",socialmedia:"Social Media",google:"Google",search:"Google",website:"Website",referral:"Referral","word of mouth":"Word of Mouth",wordofmouth:"Word of Mouth",advertisement:"Advertisement",ad:"Advertisement",flyer:"Flyer",poster:"Poster",radio:"Radio",tv:"TV",newspaper:"Newspaper",magazine:"Magazine",other:"Other"}[C]||a.trim()},[]),je=a=>{if(!a)return"";const C=a.trim();return C===C.toUpperCase()&&C.length>1?C.toLowerCase().replace(/\b\w/g,i=>i.toUpperCase()):C===C.toUpperCase()?C.toLowerCase().replace(/\b\w/g,i=>i.toUpperCase()):C},oe=a=>{if(!a)return{month:"",day:""};const C=a.trim(),i=C.split("/");if(i.length===2){const[w,T]=i,K=parseInt(w),z=parseInt(T);if(K>12&&z<=12)return{month:T,day:w};if(z>12&&K<=12)return{month:w,day:T};if(K<=12&&z<=31)return{month:w,day:T}}const N=["january","february","march","april","may","june","july","august","september","october","november","december"],$=C.toLowerCase();for(let w=0;w<N.length;w++)if($.includes(N[w])){const T=(w+1).toString(),K=C.match(/\d+/),z=K?K[0]:"";return{month:T,day:z}}return{month:"",day:""}},B=a=>{if(!a)return"new";const C=a.trim().toLowerCase();return{new:"new",vip:"vip",complainer:"complainer",purchased:"purchased",normal:"new",regular:"new",standard:"new",basic:"new",premium:"vip",important:"vip",priority:"vip",problem:"complainer",issue:"complainer",buyer:"purchased",customer:"purchased",buying:"purchased"}[C]||"new"},xe=async a=>{try{console.log("ðŸ” Loading existing customers for matching...");const C=await dr(),i=new Map,N=new Map,$=new Map,w=new Map,T=new Map;C.forEach(U=>{if(U.phone){const te=U.phone.replace(/[^0-9]/g,"");$.set(te,U)}if(U.whatsapp){const te=U.whatsapp.replace(/[^0-9]/g,"");w.set(te,U)}U.email&&T.set(U.email.toLowerCase(),U)}),console.log(`ðŸ“Š Loaded ${C.length} existing customers`),console.log(`ðŸ“± Phone matches available: ${$.size}`),console.log(`ðŸ’¬ WhatsApp matches available: ${w.size}`),console.log(`ðŸ“§ Email matches available: ${T.size}`),a.forEach(U=>{var He;const te=U.phone.replace(/[^0-9]/g,""),Z=((He=U.whatsapp)==null?void 0:He.replace(/[^0-9]/g,""))||"",ie=U.email.toLowerCase(),ee=$.get(te)||w.get(te)||w.get(Z)||T.get(ie);ee&&N.set(U.phone,ee)}),ue(i),I(N);const K=N.size,z=a.length;return console.log(`âœ… Matched ${K} out of ${z} imported customers with existing records`),N}catch(C){return console.error("âŒ Error checking existing customers:",C),Y.error("Failed to load existing customers"),new Map}},_e=(a,C)=>{const i=[];return(!a.name||a.name.trim().length<2)&&i.push("Name must be at least 2 characters"),(!a.phone||a.phone.trim().length<10)&&i.push("Phone number must be at least 10 digits"),a.email&&!a.email.includes("@")&&i.push("Invalid email format"),a.birthDay&&(parseInt(a.birthDay)<1||parseInt(a.birthDay)>31)&&i.push("Birth day must be between 1 and 31"),a.birthMonth&&(parseInt(a.birthMonth)<1||parseInt(a.birthMonth)>12)&&i.push("Birth month must be between 1 and 12"),i},Ae=(a,C)=>{const i=["email","gender","city","whatsapp","birthMonth","birthDay","referralSource","locationDescription","nationalId","referredBy"];for(const N of i){const $=a[N],w=C[N];if($&&!w)return!0}return!1},Ee=a=>{var i;const C=(i=a.target.files)==null?void 0:i[0];C&&(x(C),Pe(C))},Pe=async a=>{var C,i,N;try{g(!0),Q([]);const w=(await a.text()).split(`
`).filter(Z=>Z.trim());if(w.length<2){Y.error("File must contain at least a header row and one data row");return}const T=((C=w[0])==null?void 0:C.split(",").map(Z=>Z.trim().toLowerCase()))||[],K=[],z=[];for(let Z=1;Z<w.length;Z++){const ie=w[Z].trim();if(!ie)continue;const ee=ie.split(",").map(Be=>Be.trim().replace(/^"|"$/g,"")),He=ee[T.indexOf("phone")]||ee[T.indexOf("phone number")]||ee[T.indexOf("mobile")]||ee[T.indexOf("mobile phone")]||ee[T.indexOf("primary phone")]||ee[T.indexOf("phone 1 - value")]||"",Ke=ee[T.indexOf("whatsapp")]||ee[T.indexOf("whatsapp number")]||"",we={name:$e(ee[T.indexOf("name")]||""),email:ee[T.indexOf("email")]||"",phone:ke(He),gender:de(ee[T.indexOf("gender")]||""),city:je(ee[T.indexOf("city")]||""),whatsapp:De(Ke),notes:ee[T.indexOf("notes")]||ee[T.indexOf("initial notes")]||"",loyaltyLevel:ee[T.indexOf("loyalty level")]||"bronze",colorTag:B(ee[T.indexOf("color tag")]||""),referralSource:Me(ee[T.indexOf("referral source")]||""),locationDescription:ee[T.indexOf("location description")]||"",nationalId:ee[T.indexOf("national id")]||"",referredBy:ee[T.indexOf("referred by")]||"",totalSpent:parseFloat(ee[T.indexOf("total spent")]||"0")||0,points:parseInt(ee[T.indexOf("points")]||"0")||0,isActive:((i=ee[T.indexOf("is active")])==null?void 0:i.toLowerCase())==="yes"||((N=ee[T.indexOf("is active")])==null?void 0:N.toLowerCase())==="true",profileImage:ee[T.indexOf("profile image")]||""},ze=ee[T.indexOf("birth month")]||ee[T.indexOf("birthday")]||"";if(ze){const{month:Be,day:qt}=oe(ze);we.birthMonth=Be,we.birthDay=qt}const Te=_e(we,Z+2);Te.length>0&&z.push(`Row ${Z+2}: ${Te.join(", ")}`),K.push(we)}f(K),Q(z);const U=await xe(K),te=K.filter(Z=>U.has(Z.phone));Ne(te),E(te),console.log(`ðŸ“Š Processed ${K.length} customers from CSV`),console.log(`âœ… Found ${U.size} existing customers to update`),console.log(`âš ï¸ ${z.length} validation errors found`),U.size===0?Y("No existing customers found to update. Make sure phone numbers match existing records."):Y.success(`Found ${U.size} existing customers to update`),P("preview")}catch($){console.error("âŒ Error processing CSV file:",$),Y.error("Failed to process CSV file")}finally{g(!1)}},o=async()=>{var C;if((c==null?void 0:c.role)!=="admin"){Y.error("Only administrators can update customers via CSV import.");return}const a=ne;if(a.length===0){Y.error("No customers to update. Please ensure you have matched customers.");return}try{S(!0),L(0),F([]);const i=[],N=[];for(let K=0;K<a.length;K++){const z=a[K],U=X.get(z.phone);if(!U){N.push({success:!1,error:"No existing customer found to update",rowNumber:K+2,skipped:!0,reason:"No match found"});continue}if(!Ae(z,U)){N.push({success:!1,error:"No null fields to update",rowNumber:K+2,skipped:!0,reason:"No updates needed",existingCustomer:U});continue}try{const te={};if(z.email&&!U.email&&(te.email=z.email),z.gender&&!U.gender&&(te.gender=z.gender),z.city&&!U.city&&(te.city=z.city),z.whatsapp&&!U.whatsapp&&(te.whatsapp=z.whatsapp),z.birthMonth&&!U.birthMonth&&(te.birthMonth=z.birthMonth),z.birthDay&&!U.birthDay&&(te.birthDay=z.birthDay),z.referralSource&&!U.referralSource&&(te.referralSource=z.referralSource),z.locationDescription&&!U.locationDescription&&(te.locationDescription=z.locationDescription),z.nationalId&&!U.nationalId&&(te.nationalId=z.nationalId),z.referredBy&&!U.referredBy&&(te.referredBy=z.referredBy),z.notes&&!((C=U.notes)!=null&&C.length))try{await se.from("customer_notes").insert({id:crypto.randomUUID(),content:z.notes,created_by:c.id,created_at:new Date().toISOString(),customer_id:U.id})}catch(Z){console.warn("Could not add note:",Z)}if(Object.keys(te).length>0){const Z=await cr(U.id,te);Z?(i.push(Z),N.push({success:!0,customer:Z,rowNumber:K+2,existingCustomer:U})):N.push({success:!1,error:"Failed to update customer",rowNumber:K+2,existingCustomer:U})}else N.push({success:!1,error:"No fields to update",rowNumber:K+2,skipped:!0,reason:"All fields already populated",existingCustomer:U})}catch(te){console.error(`Error updating customer ${z.name}:`,te),N.push({success:!1,error:te instanceof Error?te.message:"Unknown error",rowNumber:K+2,existingCustomer:U})}L((K+1)/a.length*100)}F(N);const $=N.filter(K=>K.success).length,w=N.filter(K=>K.skipped).length,T=N.filter(K=>!K.success&&!K.skipped).length;console.log(`âœ… Import completed: ${$} updated, ${w} skipped, ${T} errors`),$>0&&(Y.success(`Successfully updated ${$} customers`),u(i)),T>0&&Y.error(`${T} customers failed to update`),P("import")}catch(i){console.error("âŒ Error during import:",i),Y.error("Failed to import customers")}finally{S(!1)}},m=()=>{x(null),f([]),E([]),Ne([]),F([]),Q([]),P("upload"),L(0),ue(new Map),I(new Map),le(!0),ye(!0),me.current&&(me.current.value=""),l()},y=()=>{const a=`Name,Email,Phone,Gender,City,WhatsApp,Notes,Loyalty Level,Color Tag,Referral Source,Location Description,National ID,Referred By,Birth Month,Birth Day
John Doe,john@example.com,+255123456789,male,Dar es Salaam,+255123456789,New customer notes,bronze,normal,Facebook,City Center,123456789,John Smith,January,15
Jane Smith,jane@example.com,+255987654321,female,Arusha,+255987654321,Another customer,bronze,vip,Friend,Suburb Area,987654321,Jane Doe,March,22`,C=new Blob([a],{type:"text/csv"}),i=window.URL.createObjectURL(C),N=document.createElement("a");N.href=i,N.download="customer_update_template.csv",document.body.appendChild(N),N.click(),document.body.removeChild(N),window.URL.revokeObjectURL(i)},_=()=>{if(le(!M),M)Ne(b),E(b);else{const a=b.filter(C=>X.has(C.phone));Ne(a),E(a)}};return r.useEffect(()=>{const a=()=>{window.innerWidth<768&&ye(!1)};return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]),p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed bg-black/50",onClick:l,style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:35}}),e.jsx("div",{className:"fixed flex items-center justify-center p-4",style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:50,pointerEvents:"none"},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(Je,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Update Customers from CSV"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Update existing customer records with new data"})]})]}),e.jsx("button",{onClick:m,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Oe,{className:"w-6 h-6"})})]})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[he&&e.jsx("div",{className:"w-72 bg-gray-50 border-r border-gray-200 p-6 overflow-y-auto",children:e.jsxs("div",{className:"space-y-4",children:[A==="upload"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white hover:border-blue-400 transition-colors",children:[e.jsx(Mt,{className:"w-10 h-10 text-blue-500 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-700 font-medium mb-3 text-sm",children:"Upload CSV file to update existing customers"}),e.jsx("input",{ref:me,type:"file",accept:".csv",onChange:Ee,className:"hidden"}),e.jsx("button",{onClick:()=>{var a;return(a=me.current)==null?void 0:a.click()},disabled:J,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:J?"Processing...":"Choose CSV File"})]}),e.jsxs("button",{onClick:y,className:"w-full px-4 py-2 border-2 border-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Pt,{className:"w-4 h-4"}),"Download Template"]})]}),A==="preview"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Preview"}),e.jsx("button",{onClick:_,className:"px-3 py-1 text-xs border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-colors",children:M?"Show All":"Matched Only"})]}),e.jsxs("div",{className:"space-y-2 bg-white p-4 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:b.length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Matched:"}),e.jsx("span",{className:"font-semibold text-green-600",children:X.size})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Unmatched:"}),e.jsx("span",{className:"font-semibold text-yellow-600",children:b.length-X.size})]})]}),O.length>0&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ge,{className:"w-4 h-4 text-yellow-600"}),e.jsxs("span",{className:"text-sm font-medium text-yellow-800",children:[O.length," Validation Errors"]})]}),e.jsxs("div",{className:"text-xs text-yellow-700 max-h-32 overflow-y-auto space-y-1",children:[O.slice(0,5).map((a,C)=>e.jsxs("div",{children:["â€¢ ",a]},C)),O.length>5&&e.jsxs("div",{className:"font-medium",children:["... and ",O.length-5," more"]})]})]}),e.jsx("button",{onClick:o,disabled:X.size===0||d,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:d?"Updating...":`Update ${X.size} Customers`})]}),A==="import"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Import Results"}),e.jsxs("div",{className:"space-y-2 bg-white p-4 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Updated:"}),e.jsx("span",{className:"font-semibold text-green-600",children:W.filter(a=>a.success).length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Skipped:"}),e.jsx("span",{className:"font-semibold text-yellow-600",children:W.filter(a=>a.skipped).length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Errors:"}),e.jsx("span",{className:"font-semibold text-red-600",children:W.filter(a=>!a.success&&!a.skipped).length})]})]}),e.jsx("button",{onClick:m,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors",children:"Close"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[d&&e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${j}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 font-semibold min-w-[40px]",children:[Math.round(j),"%"]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[A==="upload"&&e.jsxs("div",{className:"text-center py-12 max-w-xl mx-auto",children:[e.jsx("div",{className:"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(wr,{className:"w-10 h-10 text-blue-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Update Existing Customers"}),e.jsx("p",{className:"text-gray-600 max-w-md mx-auto mb-6",children:"Upload a CSV file to update existing customer records. Only empty fields in existing customers will be filled with new data."}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 text-left",children:[e.jsxs("h4",{className:"font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[e.jsx(fs,{className:"w-4 h-4"}),"How it works"]}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"â€¢ Customers are matched by phone number"}),e.jsx("li",{children:"â€¢ Only empty/null fields will be updated"}),e.jsx("li",{children:"â€¢ Existing data is never overwritten"}),e.jsx("li",{children:"â€¢ You'll see a preview before confirming"})]})]})]}),A==="preview"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-900",children:["Preview (",ne.length," customers)"]}),e.jsx("button",{onClick:()=>ye(!he),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600",children:he?e.jsx(Cr,{className:"w-5 h-5"}):e.jsx(pt,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Phone"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Email"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"City"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:ne.map((a,C)=>{const i=X.get(a.phone),N=i?Ae(a,i):!1;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:a.name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700 font-medium",children:a.phone}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:a.email||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:a.city||"-"}),e.jsx("td",{className:"px-4 py-3",children:i?N?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700",children:[e.jsx(Le,{className:"w-3 h-3 mr-1"}),"Will Update"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx(ls,{className:"w-3 h-3 mr-1"}),"No Updates"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(Ge,{className:"w-3 h-3 mr-1"}),"No Match"]})})]},C)})})]})})})]}),A==="import"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:"Import Results"}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Row"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-700",children:"Details"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:W.map((a,C)=>{var i;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 font-medium",children:a.rowNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:((i=a.existingCustomer)==null?void 0:i.name)||"Unknown"}),e.jsx("td",{className:"px-4 py-3",children:a.success?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700",children:[e.jsx(Le,{className:"w-3 h-3 mr-1"}),"Updated"]}):a.skipped?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx(ls,{className:"w-3 h-3 mr-1"}),"Skipped"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(Ge,{className:"w-3 h-3 mr-1"}),"Error"]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:a.error||a.reason||"Success"})]},C)})})]})})})]})]})]})]})]})})]}):null}),Xr=({children:p,anchorRef:l,open:u,onClose:c,width:h})=>{const[x,b]=r.useState({top:0,left:0}),f=r.useRef(null);return r.useEffect(()=>{if(u&&l.current){const v=l.current.getBoundingClientRect();b({top:v.bottom+window.scrollY,left:v.left+window.scrollX})}},[u,l]),r.useEffect(()=>{if(!u)return;function v(E){f.current&&!f.current.contains(E.target)&&l.current&&!l.current.contains(E.target)&&c&&c()}return document.addEventListener("mousedown",v),()=>document.removeEventListener("mousedown",v)},[u,c,l]),u?xr.createPortal(e.jsx("div",{ref:f,style:{position:"absolute",top:x.top,left:x.left,zIndex:9999,minWidth:h||180,background:"#fff",border:"1px solid #e5e7eb",borderRadius:8,boxShadow:"0 4px 24px 0 rgba(0,0,0,0.10)",padding:0},children:p}),document.body):null},ms=async()=>{try{const p=localStorage.getItem("current_branch_id");console.log("ðŸ“Š [CustomerStats] Configuration:"),console.log("   - Current Branch ID:",p||"âŒ NOT SET"),console.log("   - ðŸŒ CUSTOMERS: SHARED ACROSS ALL BRANCHES"),console.log("   - ðŸ“Š Will fetch stats for ALL customers from ALL branches");const{count:l,error:u}=await se.from("customers").select("id",{count:"exact",head:!0});u&&console.error("Error fetching total customers count:",u);const{count:c,error:h}=await se.from("customers").select("id",{count:"exact",head:!0}).eq("is_active",!0);h&&console.error("Error fetching active customers count:",h);const x=new Date,b=x.getMonth()+1,f=x.getDate(),{data:v,error:E}=await se.from("customers").select("id, birth_month, birth_day").not("birth_month","is",null).not("birth_day","is",null);E&&console.error("Error fetching birthday customers:",E);const J=(v==null?void 0:v.filter(j=>{if(!j.birth_month||!j.birth_day)return!1;let L,W;if(typeof j.birth_month=="string"){if(j.birth_month.trim()==="")return!1;const F=parseInt(j.birth_month);!isNaN(F)&&F>=1&&F<=12?L=F:L=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(j.birth_month.toLowerCase())+1}else return!1;if(typeof j.birth_day=="string"){if(j.birth_day.trim()==="")return!1;const F=j.birth_day.match(/^(\d+)/);F?W=parseInt(F[1]):W=parseInt(j.birth_day)}else W=parseInt(j.birth_day);return L===b&&W===f}).length)||0;let g=0,d=null;try{let j=se.from("devices").select("id",{count:"exact",head:!0});p&&(console.log("   ðŸ”’ Applying branch filter to devices count..."),j=j.eq("branch_id",p));const L=await j;g=L.count||0,d=L.error}catch{console.warn("âš ï¸  Branch filtering failed for devices, falling back to total count..."),console.warn("âš ï¸  This might be because devices table does not have branch_id column");try{const L=await se.from("devices").select("id",{count:"exact",head:!0});g=L.count||0,d=L.error}catch(L){console.error("âŒ Error fetching devices count (fallback):",L),d=L}}d&&(console.error("âŒ Error fetching total devices count:",d),console.error("âŒ Devices query details:",{currentBranchId:p,devicesError:d}));let S=0,A=null;if(p){console.log("ðŸ’° Calculating revenue for current branch:",p);try{const{data:j,error:L}=await se.from("customers").select("total_spent").eq("branch_id",p);L?(console.error("âŒ Error fetching branch revenue data:",L),console.error("âŒ Revenue query details:",{currentBranchId:p,revenueError:L})):(S=(j==null?void 0:j.reduce((W,F)=>W+(F.total_spent||0),0))||0,console.log("ðŸ’° Branch revenue calculated:",S))}catch(j){console.error("âŒ Error calculating branch revenue:",j),A=j}}else console.warn("âš ï¸  No branch selected - revenue will be 0");const P={totalCustomers:l||0,activeCustomers:c||0,todaysBirthdays:J,totalRevenue:S,totalDevices:g||0};return console.log("ðŸ“Š [CustomerStats] Final Statistics:",P),console.log("ðŸ“Š [CustomerStats] Customers: SHARED | Revenue: BRANCH-SPECIFIC"),P}catch(p){return console.error("Error fetching customer stats:",p),{totalCustomers:0,activeCustomers:0,todaysBirthdays:0,totalRevenue:0,totalDevices:0}}};class Zr{async getComprehensiveFinancialData(){try{const[l,u,c,h,x,b,f,v]=await Promise.all([this.getDevicePayments(),this.getPOSSales(),this.getRepairPayments(),this.getExpenses(),this.getAccounts(),this.getTransfers(),this.getRevenueAnalytics(),this.getFinancialTrends()]),E=[...l||[],...u||[],...c||[]];return E?{summary:this.calculateFinancialSummary(E,h||[],x||[],f),payments:E,expenses:h||[],accounts:x||[],transfers:b||[],revenue:f,trends:v}:(console.error("Failed to fetch required financial data"),null)}catch(l){return console.error("Error fetching comprehensive financial data:",l),null}}async getDevicePayments(){try{const{data:{user:l},error:u}=await se.auth.getUser();if(u||!l)return console.warn("User not authenticated, skipping device payments fetch"),[];const c=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null;let h=se.from("customer_payments").select("*").order("payment_date",{ascending:!1});c&&(console.log(`ðŸª Applying branch filter to customer payments: ${c}`),h=h.eq("branch_id",c));const{data:x,error:b}=await h;if(b)return console.error("Error fetching device payments:",{data:null,error:b,count:null}),console.error("Device payments error details:",b.message,b.details,b.hint),[];if(!x||x.length===0)return[];const f=[...new Set(x.map(g=>g.device_id).filter(Boolean))],v=[...new Set(x.map(g=>g.customer_id).filter(Boolean))];let E={};if(f.length>0){const{data:g}=await se.from("devices").select("id, brand, model").in("id",f);g&&(E=Object.fromEntries(g.map(d=>[d.id,d])))}let J={};if(v.length>0){const{data:g}=await se.from("customers").select("id, name").in("id",v);g&&(J=Object.fromEntries(g.map(d=>[d.id,d])))}return x.map(g=>{const d=E[g.device_id],S=J[g.customer_id];return{id:g.id,customer_id:g.customer_id,amount:g.amount,method:g.method,device_id:g.device_id,payment_date:g.payment_date,payment_type:g.payment_type,status:g.status,created_by:g.created_by,created_at:g.created_at,device_name:d?`${d.brand||""} ${d.model||""}`.trim():void 0,customer_name:(S==null?void 0:S.name)||void 0,source:"device_payment",repairType:g.repair_type,diagnosis:g.diagnosis,deviceBrand:d==null?void 0:d.brand,deviceModel:d==null?void 0:d.model}})}catch(l){return console.error("Error fetching device payments:",l),[]}}async getPOSSales(){try{const l=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null;let u=se.from("lats_sales").select("*").order("created_at",{ascending:!1});l&&(console.log(`ðŸª Applying branch filter to financial sales: ${l}`),u=u.eq("branch_id",l));const{data:c,error:h}=await u;return h?(console.error("âŒ Financial sales query failed:",h),[]):(console.log(`âœ… Loaded ${(c==null?void 0:c.length)||0} financial sales${l?" (branch filtered)":" (all branches)"}`),(c==null?void 0:c.map(x=>{var b;return{id:x.id,customer_id:x.customer_id,amount:x.total_amount,method:x.payment_method,device_id:null,payment_date:x.created_at,payment_type:"payment",status:x.status==="completed"?"completed":x.status==="pending"?"pending":"failed",created_by:x.created_by,created_at:x.created_at,device_name:void 0,customer_name:((b=x.customers)==null?void 0:b.name)||void 0,source:"pos_sale",orderId:x.id,orderStatus:x.status,totalAmount:x.total_amount,discountAmount:0,taxAmount:0,shippingCost:0,amountPaid:x.total_amount,balanceDue:0,customerType:"retail",deliveryMethod:"pickup",deliveryAddress:"",deliveryCity:"",deliveryNotes:""}}))||[])}catch(l){return console.error("Error fetching POS sales:",l),[]}}async getRepairPayments(){try{return(await this.getDevicePayments()).map(u=>({...u,source:"repair_payment"}))}catch(l){return console.error("Error fetching repair payments:",l),[]}}async getPayments(){try{const[l,u]=await Promise.all([this.getDevicePayments(),this.getPOSSales()]),c=[...l,...u];return c.sort((h,x)=>{const b=new Date(h.payment_date||h.created_at);return new Date(x.payment_date||x.created_at).getTime()-b.getTime()}),c}catch(l){return console.error("Error fetching all payments:",l),[]}}async getFinancialDataBySource(){try{const[l,u,c]=await Promise.all([this.getDevicePayments(),this.getPOSSales(),this.getRepairPayments()]),h=l.filter(v=>v.status==="completed").reduce((v,E)=>v+(Number(E.amount)||0),0),x=u.filter(v=>v.status==="completed").reduce((v,E)=>v+(Number(E.amount)||0),0),b=c.filter(v=>v.status==="completed").reduce((v,E)=>v+(Number(E.amount)||0),0),f=h+x+b;return{devicePayments:l,posSales:u,repairPayments:c,totalRevenue:f,devicePaymentsRevenue:h,posSalesRevenue:x,repairPaymentsRevenue:b}}catch(l){return console.error("Error fetching financial data by source:",l),{devicePayments:[],posSales:[],repairPayments:[],totalRevenue:0,devicePaymentsRevenue:0,posSalesRevenue:0,repairPaymentsRevenue:0}}}async getExpenses(){try{const l=typeof localStorage<"u"?localStorage.getItem("current_branch_id"):null;let u=se.from("finance_expenses").select("*").order("expense_date",{ascending:!1});l&&(console.log(`ðŸª Applying branch filter to expenses: ${l}`),u=u.eq("branch_id",l));const{data:c,error:h}=await u;if(h)return console.error("Error fetching expenses:",{data:null,error:h,count:null}),console.error("Finance expenses error details:",h.message,h.details,h.hint),[];if(!c||c.length===0)return[];const x=[...new Set(c.map(f=>f.account_id).filter(Boolean))];let b={};if(x.length>0){const{data:f}=await se.from("finance_accounts").select("id, name").in("id",x);f&&(b=Object.fromEntries(f.map(v=>[v.id,v.name])))}return c.map(f=>({...f,account_name:b[f.account_id]||void 0}))}catch(l){return console.error("Error fetching expenses:",l),[]}}async getAccounts(){try{const{data:l,error:u}=await se.from("finance_accounts").select("*").order("created_at",{ascending:!1});return u?(console.log("Finance accounts table not found, returning empty array"),[]):!l||l.length===0?[]:l||[]}catch(l){return console.error("Error fetching accounts:",l),[]}}async getTransfers(){try{const{data:l,error:u}=await se.from("finance_transfers").select("*").order("created_at",{ascending:!1});if(u)return console.log("Finance transfers error (table may not exist):",u.message),[];const c=new Set;l==null||l.forEach(x=>{x.from_account_id&&c.add(x.from_account_id),x.to_account_id&&c.add(x.to_account_id)});let h=new Map;if(c.size>0){const{data:x}=await se.from("finance_accounts").select("id, name").in("id",Array.from(c));x==null||x.forEach(b=>{h.set(b.id,b.name)})}return(l==null?void 0:l.map(x=>({...x,from_account_name:h.get(x.from_account_id)||void 0,to_account_name:h.get(x.to_account_id)||void 0})))||[]}catch(l){return console.error("Error fetching transfers:",l),[]}}async getRevenueAnalytics(){try{const{data:l,error:u}=await se.from("customer_payments").select("amount, payment_date, status").eq("status","completed");if(u)throw u;if(!l||l.length===0)return{total:0,this_month:0,last_month:0,this_week:0,today:0,growth_percentage:0};const c=new Date,h=new Date(c.getFullYear(),c.getMonth(),1),x=new Date(c.getFullYear(),c.getMonth()-1,1),b=new Date(c.getFullYear(),c.getMonth(),0),f=new Date(c.getTime()-7*24*60*60*1e3),v=new Date(c.getFullYear(),c.getMonth(),c.getDate());let E=0,J=0,g=0,d=0,S=0;l.forEach(P=>{const j=P.amount||0;if(E+=j,P.payment_date){const L=new Date(P.payment_date);L>=h&&(J+=j),L>=x&&L<=b&&(g+=j),L>=f&&(d+=j),L>=v&&(S+=j)}});const A=g>0?(J-g)/g*100:0;return{total:E,this_month:J,last_month:g,this_week:d,today:S,growth_percentage:A}}catch(l){return console.error("Error calculating revenue analytics:",l),{total:0,this_month:0,last_month:0,this_week:0,today:0,growth_percentage:0}}}async getFinancialTrends(){try{const[l,u]=await Promise.all([this.getPayments(),this.getExpenses()]),c=new Map,h=new Map;l.forEach(f=>{if(f.status==="completed"){const v=new Date(f.payment_date),E=v.toISOString().slice(0,7),J=v.toISOString().slice(0,10);c.has(E)||c.set(E,{revenue:0,expenses:0,profit:0,payments:0});const g=c.get(E);g.revenue+=f.amount||0,g.payments+=1,g.profit=g.revenue-g.expenses,h.has(J)||h.set(J,{revenue:0,expenses:0,profit:0,payments:0});const d=h.get(J);d.revenue+=f.amount||0,d.payments+=1,d.profit=d.revenue-d.expenses}}),u.forEach(f=>{if(f.status==="approved"){const v=new Date(f.expense_date),E=v.toISOString().slice(0,7),J=v.toISOString().slice(0,10);c.has(E)||c.set(E,{revenue:0,expenses:0,profit:0,payments:0});const g=c.get(E);g.expenses+=f.amount,g.profit=g.revenue-g.expenses,h.has(J)||h.set(J,{revenue:0,expenses:0,profit:0,payments:0});const d=h.get(J);d.expenses+=f.amount,d.profit=d.revenue-d.expenses}});const x=Array.from(c.entries()).map(([f,v])=>({month:f,...v})).sort((f,v)=>f.month.localeCompare(v.month)),b=Array.from(h.entries()).map(([f,v])=>({day:f,...v})).sort((f,v)=>f.day.localeCompare(v.day));return{monthly:x,daily:b}}catch(l){return console.error("Error calculating financial trends:",l),{monthly:[],daily:[]}}}calculateFinancialSummary(l,u,c,h){const x=new Date,b=new Date(x.getFullYear(),x.getMonth(),1),f=I=>new Date(I)>=b,v=(I,M,le)=>{if(!M||M==="TZS")return I;const ne=le&&le>1?le:M==="USD"?2500:M==="EUR"?2700:M==="GBP"?3200:1;return I*ne},E=l.filter(I=>I.status==="completed").reduce((I,M)=>{const le=Number(M.amount)||0;return I+v(le,M.currency,M.exchange_rate)},0),J=l.filter(I=>I.status==="pending").reduce((I,M)=>{const le=Number(M.amount)||0;return I+v(le,M.currency,M.exchange_rate)},0),g=l.filter(I=>I.status==="completed"&&f(I.payment_date)).reduce((I,M)=>{const le=Number(M.amount)||0;return I+v(le,M.currency,M.exchange_rate)},0),d=u.filter(I=>I.status==="approved").reduce((I,M)=>I+M.amount,0),S=u.filter(I=>I.status==="approved"&&f(I.expense_date)).reduce((I,M)=>I+M.amount,0),A=c.reduce((I,M)=>I+v(M.balance,M.currency,1),0),P=l.filter(I=>I.status==="completed").length,j=l.filter(I=>I.status==="pending").length,L=u.filter(I=>I.status==="approved").length,W=u.filter(I=>I.status==="pending").length,F=P>0?E/P:0,O=E-d,Q=g-S,G=h.growth_percentage,ue=0,X=G-ue;return{totalRevenue:E,totalOutstanding:J,totalAccounts:c.length,monthlyRevenue:g,pendingPayments:j,completedPayments:P,totalBalance:A,averageTransaction:F,totalExpenses:d,monthlyExpenses:S,pendingExpenses:W,approvedExpenses:L,netProfit:O,monthlyProfit:Q,activeAccounts:c.filter(I=>I.is_active).length,revenueGrowth:G,expenseGrowth:ue,profitGrowth:X}}async getFinancialDataForPeriod(l,u){try{const{data:c,error:h}=await se.from("customer_payments").select("*").gte("payment_date",l).lte("payment_date",u).order("payment_date",{ascending:!1}),{data:x,error:b}=await se.from("finance_expenses").select("*").gte("expense_date",l).lte("expense_date",u).order("expense_date",{ascending:!1});if(h)throw new Error("Failed to fetch period payments");let f=[];if(c&&c.length>0){const d=[...new Set(c.map(j=>j.device_id).filter(Boolean))],S=[...new Set(c.map(j=>j.customer_id).filter(Boolean))];let A={};if(d.length>0){const{data:j}=await se.from("devices").select("id, brand, model").in("id",d);j&&(A=Object.fromEntries(j.map(L=>[L.id,L])))}let P={};if(S.length>0){const{data:j}=await se.from("customers").select("id, name").in("id",S);j&&(P=Object.fromEntries(j.map(L=>[L.id,L])))}f=c.map(j=>{const L=A[j.device_id],W=P[j.customer_id];return{...j,device_name:L?`${L.brand||""} ${L.model||""}`.trim():void 0,customer_name:(W==null?void 0:W.name)||void 0}})}let v=[];if(x&&x.length>0){const d=[...new Set(x.map(A=>A.account_id).filter(Boolean))];let S={};if(d.length>0){const{data:A}=await se.from("finance_accounts").select("id, name").in("id",d);A&&(S=Object.fromEntries(A.map(P=>[P.id,P.name])))}v=x.map(A=>({...A,account_name:S[A.account_id]||void 0}))}const[E,J]=await Promise.all([this.getAccounts(),this.getRevenueAnalytics()]);return{summary:this.calculateFinancialSummary(f,v,E,J),payments:f,expenses:v,accounts:E,transfers:[],revenue:J,trends:{monthly:[],daily:[]}}}catch(c){return console.error("Error fetching financial data for period:",c),null}}async exportFinancialData(l="csv"){try{const u=await this.getComprehensiveFinancialData();if(!u)throw new Error("Failed to fetch financial data");if(l==="json")return JSON.stringify(u,null,2);const c=[];return c.push(["Financial Summary"]),c.push(["Total Revenue",u.summary.totalRevenue]),c.push(["Total Expenses",u.summary.totalExpenses]),c.push(["Net Profit",u.summary.netProfit]),c.push(["Total Balance",u.summary.totalBalance]),c.push([]),c.push(["Payments"]),c.push(["Date","Customer","Amount","Method","Status","Device"]),u.payments.forEach(h=>{c.push([h.payment_date,h.customer_name||"N/A",h.amount,h.method,h.status,h.device_name||"N/A"])}),c.push([]),c.push(["Expenses"]),c.push(["Date","Title","Category","Amount","Status","Account"]),u.expenses.forEach(h=>{c.push([h.expense_date,h.title,h.category,h.amount,h.status,h.account_name||"N/A"])}),c.map(h=>h.join(",")).join(`
`)}catch(u){throw console.error("Error exporting financial data:",u),u}}}const Ye=new Zr,ea=()=>{const[p,l]=r.useState(null),[u,c]=r.useState(!0),[h,x]=r.useState(!1),[b,f]=r.useState(!1),[v,E]=r.useState(!1),[J,g]=r.useState(null),d=r.useCallback(async()=>{c(!0),g(null);try{const O=await Ye.getComprehensiveFinancialData();l(O)}catch(O){console.error("Error fetching financial data:",O),g(O instanceof Error?O.message:"Failed to fetch financial data")}finally{c(!1)}},[]),S=r.useCallback(async()=>{await d()},[d]),A=r.useCallback(async()=>{x(!0);try{const O=await Ye.getPayments();l(Q=>Q?{...Q,payments:O}:null)}catch(O){console.error("Error refreshing payments:",O),g(O instanceof Error?O.message:"Failed to refresh payments")}finally{x(!1)}},[]),P=r.useCallback(async()=>{f(!0);try{const O=await Ye.getExpenses();l(Q=>Q?{...Q,expenses:O}:null)}catch(O){console.error("Error refreshing expenses:",O),g(O instanceof Error?O.message:"Failed to refresh expenses")}finally{f(!1)}},[]),j=r.useCallback(async()=>{E(!0);try{const O=await Ye.getAccounts();l(Q=>Q?{...Q,accounts:O}:null)}catch(O){console.error("Error refreshing accounts:",O),g(O instanceof Error?O.message:"Failed to refresh accounts")}finally{E(!1)}},[]),L=r.useCallback(async(O,Q)=>{try{return await Ye.getFinancialDataForPeriod(O,Q)}catch(G){return console.error("Error fetching period data:",G),g(G instanceof Error?G.message:"Failed to fetch period data"),null}},[]),W=r.useCallback(async(O="csv")=>{try{return await Ye.exportFinancialData(O)}catch(Q){throw console.error("Error exporting data:",Q),g(Q instanceof Error?Q.message:"Failed to export data"),Q}},[]),F=r.useCallback(()=>{g(null)},[]);return r.useEffect(()=>{d()},[d]),{financialData:p,summary:(p==null?void 0:p.summary)||null,payments:(p==null?void 0:p.payments)||[],expenses:(p==null?void 0:p.expenses)||[],accounts:(p==null?void 0:p.accounts)||[],transfers:(p==null?void 0:p.transfers)||[],revenue:(p==null?void 0:p.revenue)||null,trends:(p==null?void 0:p.trends)||null,loading:u,paymentsLoading:h,expensesLoading:b,accountsLoading:v,refreshData:S,refreshPayments:A,refreshExpenses:P,refreshAccounts:j,getDataForPeriod:L,exportData:W,error:J,clearError:F}},ta=({todaysBirthdays:p,onClose:l,onViewCustomers:u})=>p.length===0?null:e.jsx("div",{className:"fixed top-20 right-4 bottom-4 sm:bottom-auto z-[9999] w-80 sm:w-96 max-h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx(ae,{className:"p-4 bg-gradient-to-r from-pink-50 to-purple-50 border-pink-200 shadow-2xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center",children:e.jsx(Se,{className:"w-5 h-5 text-pink-600"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-pink-900",children:"ðŸŽ‰ Birthday Alert!"}),l&&e.jsx("button",{onClick:l,className:"text-pink-500 hover:text-pink-700 transition-colors",children:e.jsx(Oe,{className:"w-4 h-4"})})]}),e.jsxs("p",{className:"text-sm text-pink-800 mb-3",children:[p.length," customer",p.length>1?"s":""," celebrating their birthday today!"]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[p.slice(0,3).map(c=>e.jsxs("div",{className:"flex items-center gap-2 text-xs p-2 bg-white/50 rounded-lg",children:[e.jsx("div",{className:"w-6 h-6 bg-pink-200 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-pink-700 font-medium text-xs",children:c.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-pink-800 font-medium truncate block",children:c.name}),c.phone&&e.jsx("span",{className:"text-pink-600 text-xs block truncate",children:c.phone})]}),c.loyaltyLevel&&e.jsx("span",{className:`px-1.5 py-0.5 rounded-full text-xs font-medium flex-shrink-0 ${c.loyaltyLevel==="platinum"?"bg-purple-100 text-purple-700":c.loyaltyLevel==="gold"?"bg-yellow-100 text-yellow-700":c.loyaltyLevel==="silver"?"bg-gray-100 text-gray-700":"bg-orange-100 text-orange-700"}`,children:c.loyaltyLevel})]},c.id)),p.length>3&&e.jsxs("div",{className:"text-xs text-pink-600 font-medium text-center py-2 bg-pink-100/50 rounded-lg",children:["+",p.length-3," more celebrating today"]})]}),u&&e.jsxs(ce,{onClick:u,className:"w-full bg-pink-600 hover:bg-pink-700 text-white text-sm py-3 font-medium",children:[e.jsx(Sr,{className:"w-4 h-4 mr-2"}),"View All Birthday Customers"]})]})]})})}),sa=({todaysBirthdays:p,onClose:l})=>{const[u,c]=r.useState(!1),[h,x]=r.useState([]),[b,f]=r.useState("whatsapp"),v={sms:"Happy Birthday! ðŸŽ‰ Thank you for choosing our services. We hope your special day is filled with joy! - LATS Team",whatsapp:`ðŸŽ‰ *Happy Birthday!* ðŸŽ‰

Dear {name},

Wishing you a fantastic birthday filled with joy and happiness! Thank you for being a valued customer.

May your day be as special as you are! ðŸŽ‚âœ¨

Best regards,
LATS Team`},E=()=>{h.length===p.length?x([]):x(p.map(d=>d.id))},J=d=>{x(S=>S.includes(d)?S.filter(A=>A!==d):[...S,d])},g=async()=>{if(h.length===0){Y.error("Please select at least one customer");return}c(!0);try{const d=p.filter(P=>h.includes(P.id));let S=0,A=0;for(const P of d){const j=v[b].replace("{name}",P.name),L=P.whatsapp||P.phone;if(!L){A++;continue}try{if(b==="whatsapp"){const F=await(await _t(()=>import("./whatsappService-09f99080.js"),["assets/whatsappService-09f99080.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"])).default.sendMessage(L,j);if(F.success)S++;else if(F.error&&(F.error.includes("not_on_whatsapp")||F.error.includes("JID does not exist")||F.error.includes("Not on WhatsApp"))){const{default:Q}=await _t(()=>import("./index-61458a34.js").then(ue=>ue.ba),["assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);(await Q.sendSMS(L,j)).success?S++:A++}else A++,console.error(`Failed to send WhatsApp to ${L}:`,F.error)}else if(b==="sms"){const{smartNotificationService:W}=await _t(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/notificationSettingsService-1df2b297.js","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),F=await W.sendNotification(L,j);F.success?S++:(A++,console.error(`Failed to send message to ${L}:`,F.error))}}catch(W){A++,console.error(`Error sending message to ${P.name}:`,W)}}Y.success(`Birthday messages sent to ${d.length} customer(s)!`),x([])}catch(d){Y.error("Failed to send birthday messages"),console.error("Error sending birthday messages:",d)}finally{c(!1)}};return p.length===0?null:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx(ae,{className:"max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5 text-pink-600"}),"Send Birthday Messages"]}),l&&e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Oe,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Message Type"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"messageType",value:"whatsapp",checked:b==="whatsapp",onChange:d=>f(d.target.value),className:"text-pink-600"}),e.jsx(gs,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm",children:"WhatsApp"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"messageType",value:"sms",checked:b==="sms",onChange:d=>f(d.target.value),className:"text-pink-600"}),e.jsx(ft,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm",children:"SMS"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Select Customers (",h.length,"/",p.length,")"]}),e.jsx("button",{onClick:E,className:"text-sm text-pink-600 hover:text-pink-700 font-medium",children:h.length===p.length?"Deselect All":"Select All"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:p.map(d=>e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:h.includes(d.id),onChange:()=>J(d.id),className:"text-pink-600 rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-gray-900",children:d.name}),d.loyaltyLevel&&e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${d.loyaltyLevel==="platinum"?"bg-purple-100 text-purple-700":d.loyaltyLevel==="gold"?"bg-yellow-100 text-yellow-700":d.loyaltyLevel==="silver"?"bg-gray-100 text-gray-700":"bg-orange-100 text-orange-700"}`,children:d.loyaltyLevel})]}),e.jsx("div",{className:"text-sm text-gray-600",children:b==="whatsapp"?d.whatsapp||"No WhatsApp":d.phone})]})]},d.id))})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Message Preview"}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-sm text-gray-700",children:v[b].replace("{name}","Customer Name")})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[l&&e.jsx(ce,{onClick:l,variant:"outline",disabled:u,children:"Cancel"}),e.jsx(ce,{onClick:g,disabled:h.length===0||u,className:"bg-pink-600 hover:bg-pink-700 text-white",children:u?e.jsxs(e.Fragment,{children:[e.jsx(Et,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(kr,{className:"w-4 h-4 mr-2"}),"Send Messages (",h.length,")"]})})]})]})})})},ra=({customers:p,onCustomerClick:l})=>{const[u,c]=r.useState(new Date().getFullYear()),h=["January","February","March","April","May","June","July","August","September","October","November","December"],x=["january","february","march","april","may","june","july","august","september","october","november","december"],b=r.useMemo(()=>{const d={};return p.forEach(S=>{if(!S.birthMonth||!S.birthDay)return;let A,P;if(typeof S.birthMonth=="string"){if(S.birthMonth.trim()==="")return;const j=parseInt(S.birthMonth);!isNaN(j)&&j>=1&&j<=12?A=j:A=x.indexOf(S.birthMonth.toLowerCase())+1}else return;if(typeof S.birthDay=="string"){if(S.birthDay.trim()==="")return;const j=S.birthDay.match(/^(\d+)/);j?P=parseInt(j[1]):P=parseInt(S.birthDay)}else P=parseInt(S.birthDay);if(A&&P){const j=`${A}-${P}`;d[j]||(d[j]=[]),d[j].push(S)}}),d},[p]),f=d=>{const S=[];return Object.keys(b).forEach(A=>{const[P,j]=A.split("-").map(Number);P===d+1&&S.push({day:j,customers:b[A]})}),S.sort((A,P)=>A.day-P.day)},v=(d,S)=>new Date(S,d+1,0).getDate(),E=d=>h[d],J=(d,S)=>{const A=new Date;return A.getDate()===d&&A.getMonth()===S&&A.getFullYear()===u},g=(d,S)=>{const A=new Date;return new Date(u,S,d)<A&&!J(d,S)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Re,{className:"w-6 h-6 text-pink-600"}),"Birthday Calendar ",u]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>c(d=>d-1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Dr,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-lg font-semibold text-gray-700",children:u}),e.jsx("button",{onClick:()=>c(d=>d+1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(bs,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:h.map((d,S)=>{const A=f(S),P=v(S,u);return e.jsxs(ae,{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:E(S)}),e.jsxs("p",{className:"text-sm text-gray-600",children:[A.length," birthday",A.length!==1?"s":""]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-1 text-xs",children:[["S","M","T","W","T","F","S"].map(j=>e.jsx("div",{className:"text-center text-gray-500 font-medium py-1",children:j},j)),Array.from({length:P},(j,L)=>{const W=L+1,F=A.find(G=>G.day===W),O=J(W,S),Q=g(W,S);return e.jsxs("div",{className:`
                        relative p-1 text-center cursor-pointer rounded transition-colors
                        ${O?"bg-pink-500 text-white font-bold":""}
                        ${Q?"text-gray-400":"text-gray-700"}
                        ${F&&!O?"bg-pink-50 hover:bg-pink-100":"hover:bg-gray-50"}
                      `,onClick:()=>F&&(l==null?void 0:l(F.customers[0])),children:[e.jsx("span",{className:"text-xs",children:W}),F&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-pink-500 rounded-full"})]},W)})]}),A.length>0&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsx("div",{className:"space-y-1",children:A.map(({day:j,customers:L})=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("div",{className:"w-4 h-4 bg-pink-100 rounded-full flex items-center justify-center",children:e.jsx(Se,{className:"w-2 h-2 text-pink-600"})}),e.jsx("span",{className:"font-medium text-gray-700",children:j}),e.jsxs("span",{className:"text-gray-600",children:[L.length," customer",L.length>1?"s":""]}),J(j,S)&&e.jsx("span",{className:"text-pink-600 font-medium",children:"Today!"})]},j))})})]},S)})})]})},aa=({todaysBirthdays:p,onApplyReward:l})=>{const[u,c]=r.useState({}),h=[{id:"discount_20",name:"20% Birthday Discount",description:"20% off on any service or product",icon:Mr,color:"bg-green-100 text-green-700",value:20},{id:"free_diagnosis",name:"Free Device Diagnosis",description:"Complimentary device health check",icon:gt,color:"bg-blue-100 text-blue-700",value:"Free"},{id:"double_points",name:"Double Loyalty Points",description:"Earn 2x points on all purchases",icon:_r,color:"bg-purple-100 text-purple-700",value:"2x"},{id:"priority_service",name:"Priority Service",description:"Skip the queue for faster service",icon:ys,color:"bg-orange-100 text-orange-700",value:"Priority"}],x=b=>{const f=u[b];f&&(l==null||l(b,f),Y.success("Birthday reward applied successfully!"))};return p.length===0?null:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Se,{className:"w-6 h-6 text-pink-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Birthday Rewards & Special Offers"})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:p.map(b=>e.jsxs(ae,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center",children:e.jsx(Se,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-900",children:b.name}),e.jsx("p",{className:"text-sm text-gray-600",children:"ðŸŽ‰ Birthday Today!"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("select",{value:u[b.id]||"",onChange:f=>c(v=>({...v,[b.id]:f.target.value})),className:"w-full p-2 border border-gray-300 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select a birthday reward..."}),h.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ce,{onClick:()=>x(b.id),disabled:!u[b.id],className:"flex-1 bg-pink-600 hover:bg-pink-700 text-white",children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Apply Reward"]}),e.jsxs(ce,{onClick:()=>Y.success("Birthday message sent!"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(gs,{className:"w-4 h-4 mr-2"}),"Send Wishes"]})]})]})]},b.id))})]})};function fe(p){if(p==null)return"";const l=String(p);return l.includes('"')?'"'+l.replace(/"/g,'""')+'"':l.includes(",")||l.includes(`
`)?'"'+l+'"':l}const js="customersPagePrefs",na=()=>{if(typeof window>"u")return{};try{const p=localStorage.getItem(js);return p?JSON.parse(p):{}}catch{return{}}},Oa=()=>{const{currentUser:p}=Wt(),{confirm:l}=qr(),u=pr(),[c]=fr(),{markCustomerAsRead:h}=mr();ea();const x=Ur(),b=na(),[f,v]=r.useState(""),[E,J]=r.useState(""),[g,d]=r.useState(b.loyaltyFilter??"all"),[S,A]=r.useState(b.statusFilter??"all"),[P,j]=r.useState(b.showInactive??!1),[L,W]=r.useState(b.showAdvancedFilters??!1),[F,O]=r.useState([]),[Q,G]=r.useState(b.viewMode??"grid"),[ue,X]=r.useState(!1),[I,M]=r.useState(!1),[le,ne]=r.useState(!1),[Ne,he]=r.useState(!1),[ye,me]=r.useState(!1),[ke,De]=r.useState(!1),[$e,de]=r.useState(!1),Me=r.useRef(null),[je,oe]=r.useState(null),[B,xe]=r.useState([]),[_e,Ae]=r.useState(!0),[Ee,Pe]=r.useState(null),[o,m]=r.useState(!navigator.onLine),[y,_]=r.useState(b.sortBy??"name"),[a,C]=r.useState(!1),[i,N]=r.useState(!1),[$,w]=r.useState(!1),[T,K]=r.useState("pending"),[z,U]=r.useState(0),[te,Z]=r.useState(null),[ie,ee]=r.useState(1),[He,Ke]=r.useState(1),[we,ze]=r.useState(0),[Te,Be]=r.useState(!1),[qt,It]=r.useState(!1),[qe,Lt]=r.useState(!1),Yt=r.useRef(null),[Qe,vs]=r.useState([]),[Xe,Ns]=r.useState([]),[Ze,ws]=r.useState([]),[et,Cs]=r.useState([]),[bt,Ss]=r.useState(!1),[Jt,ks]=r.useState(!1),[yt,Ds]=r.useState([]),[tt,Ms]=r.useState(""),[st,_s]=r.useState(""),[rt,As]=r.useState(""),[at,Es]=r.useState(""),[jt,Ps]=r.useState([]),[nt,Is]=r.useState(""),[lt,Ls]=r.useState(""),[ot,Os]=r.useState(""),[it,$s]=r.useState(""),[ct,Ts]=r.useState(""),[dt,Fs]=r.useState(""),[mt,Gt]=r.useState("customers"),[ge,vt]=r.useState([]),[Ie,Ot]=r.useState({status:"all",date:"all",customer:"all"}),[la,Rs]=r.useState(0),[$t,zs]=r.useState(0),[Ce,Ht]=r.useState({totalCustomers:0,activeCustomers:0,todaysBirthdays:0,totalRevenue:0,totalDevices:0}),[Ve,Nt]=r.useState(!0),[Bs,Vs]=r.useState(!0),[Us,Tt]=r.useState(!1),[Ws,Kt]=r.useState(!1),[qs,Ft]=r.useState(!1),[Ys,wt]=r.useState(!1),[Js,ut]=r.useState(!1),[Rt,ht]=r.useState(null),[Ct,Qt]=r.useState("create");r.useEffect(()=>{const t=setTimeout(()=>{J(f)},300);return()=>clearTimeout(t)},[f]),r.useEffect(()=>{localStorage.setItem(js,JSON.stringify({loyaltyFilter:g,statusFilter:S,showInactive:P,showAdvancedFilters:L,viewMode:Q,sortBy:y}))},[g,S,P,L,Q,y]),r.useEffect(()=>{let t=null,s=!0;(async()=>{try{if(ie===1?Ae(!0):Lt(!0),te&&cs().cancelSearchJob(te),E.trim()&&E.trim().length>=2){w(!0),K("processing"),U(20),N(!0),t=setInterval(()=>{U(k=>k<90?k+10:k)},100);try{const k=await Yr(E,ie,100);if(!s)return;t&&(clearInterval(t),t=null);let R;ie===1?(R=k.customers,xe(k.customers)):(R=[...B,...k.customers],xe(R));const H=k.total||0,re=k.customers.length>=100;ze(H>0?H:R.length),Ke(k.totalPages>0?k.totalPages:re?ie+1:ie),Be(ie<k.totalPages||re&&H===0),It(ie>1),U(100),K("completed"),setTimeout(()=>{s&&w(!1)},500),Z(null)}catch(k){throw t&&(clearInterval(t),t=null),k}}else{w(!1),N(!1);const k=await ds(ie,100);if(!s)return;let R;ie===1?(R=k.customers,xe(k.customers)):(R=[...B,...k.customers],xe(R));const H=k.totalCount||0,re=k.customers.length>=100;ze(H>0?H:R.length),Ke(k.totalPages>0?k.totalPages:re?ie+1:ie),Be(k.hasNextPage||re&&H===0),It(k.hasPreviousPage)}}catch(k){if(t&&(clearInterval(t),t=null),!s)return;const R=k instanceof Error?k.message:"Failed to load customers";console.error("âŒ Error loading customers:",R),Pe(R),U(0),K("failed"),w(!1),Y.error(`Failed to load customers: ${R.includes("timed out")?"Request timed out. Please try again.":R}`,{duration:5e3,position:"top-center"})}finally{s&&(Ae(!1),Lt(!1),N(!1))}})();const D=()=>m(!1),q=()=>m(!0);return window.addEventListener("online",D),window.addEventListener("offline",q),()=>{s=!1,t&&clearInterval(t),window.removeEventListener("online",D),window.removeEventListener("offline",q)}},[ie,E]),r.useEffect(()=>{he(!1),ne(!1),me(!1),X(!1)},[]),r.useEffect(()=>{const t=new IntersectionObserver(n=>{n[0].isIntersecting&&Te&&!qe&&!_e&&ee(q=>q+1)},{threshold:.1}),s=Yt.current;return s&&t.observe(s),()=>{s&&t.unobserve(s)}},[Te,qe,_e]),r.useEffect(()=>{(async()=>{try{const s=await Bt();vt(s)}catch(s){console.error("Error fetching appointments:",s),vt([])}})()},[]),r.useEffect(()=>{(async()=>{try{const{count:s,error:n}=await se.from("devices").select("id",{count:"exact",head:!0});n?console.error("Error fetching total devices count:",n):Rs(s||0);const{count:D,error:q}=await se.from("devices").select("id",{count:"exact",head:!0}).in("status",["in-repair","diagnosis-started"]);q?console.error("Error fetching devices in repair count:",q):zs(D||0)}catch(s){console.error("Error fetching device statistics:",s)}})()},[]),r.useEffect(()=>{(async()=>{try{Nt(!0);const s=await ms();Ht(s)}catch(s){console.error("Error fetching database statistics:",s)}finally{Nt(!1)}})()},[]);const be=r.useMemo(()=>{if(!B||!Array.isArray(B))return{totalCustomers:Ce.totalCustomers,pageCustomers:0,activeCustomers:Ce.activeCustomers,vipCustomers:0,totalRevenue:Ce.totalRevenue,deviceRevenue:0,posRevenue:0,totalPoints:0,platinumCustomers:0,goldCustomers:0,silverCustomers:0,bronzeCustomers:0,totalDevices:Ce.totalDevices,devicesInRepair:$t,todaysBirthdays:Ce.todaysBirthdays};const t=B.length,s=0,n=0,D=B.reduce((V,Fe)=>V+(Fe.points||0),0),q=B.filter(V=>V.loyaltyLevel==="vip").length,k=B.filter(V=>V.loyaltyLevel==="premium").length,R=B.filter(V=>V.loyaltyLevel==="regular").length;B.filter(V=>V.loyaltyLevel==="active").length;const H=B.filter(V=>V.loyaltyLevel==="payment_customer").length,re=B.filter(V=>V.loyaltyLevel==="engaged").length,ve=B.filter(V=>V.loyaltyLevel==="interested").length;return{totalCustomers:Ce.totalCustomers,pageCustomers:t,activeCustomers:Ce.activeCustomers,totalRevenue:Ce.totalRevenue,deviceRevenue:s,posRevenue:n,totalPoints:D,vipCustomers:q,premiumCustomers:k,regularCustomers:R,paymentCustomers:H,engagedCustomers:re,interestedCustomers:ve,totalDevices:Ce.totalDevices,devicesInRepair:$t,todaysBirthdays:Ce.todaysBirthdays}},[B,Ce,$t]),xt=r.useMemo(()=>{if(!ge||!Array.isArray(ge))return{totalAppointments:0,confirmedAppointments:0,pendingAppointments:0,completedAppointments:0,cancelledAppointments:0,todaysAppointments:0,thisWeeksAppointments:0};const t=ge.length,s=ge.filter(V=>V.status==="confirmed").length,n=ge.filter(V=>V.status==="pending").length,D=ge.filter(V=>V.status==="completed").length,q=ge.filter(V=>V.status==="cancelled").length,k=new Date().toISOString().split("T")[0],R=ge.filter(V=>V.appointment_date===k).length,H=new Date;H.setDate(H.getDate()-H.getDay());const re=new Date;re.setDate(re.getDate()+(6-re.getDay()));const ve=ge.filter(V=>{const Fe=new Date(V.appointment_date);return Fe>=H&&Fe<=re}).length;return{totalAppointments:t,confirmedAppointments:s,pendingAppointments:n,completedAppointments:D,cancelledAppointments:q,todaysAppointments:R,thisWeeksAppointments:ve}},[ge]),Ue=r.useMemo(()=>[],[]);r.useMemo(()=>{if(!B||!Array.isArray(B))return[];const t=new Date,s=new Date(t.getTime()+7*24*60*60*1e3);return B.filter(n=>{if(!n.birthMonth||!n.birthDay)return!1;let D,q;if(typeof n.birthMonth=="string"){if(n.birthMonth.trim()==="")return!1;const R=parseInt(n.birthMonth);!isNaN(R)&&R>=1&&R<=12?D=R:D=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(n.birthMonth.toLowerCase())+1}else return!1;if(typeof n.birthDay=="string"){if(n.birthDay.trim()==="")return!1;const R=n.birthDay.match(/^(\d+)/);R?q=parseInt(R[1]):q=parseInt(n.birthDay)}else q=parseInt(n.birthDay);const k=new Date(t.getFullYear(),D-1,q);return k<t&&k.setFullYear(t.getFullYear()+1),k>=t&&k<=s}).sort((n,D)=>{let q,k,R,H;if(typeof n.birthMonth=="string"&&n.birthMonth.trim()!==""){const V=parseInt(n.birthMonth);!isNaN(V)&&V>=1&&V<=12?q=V:q=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(n.birthMonth.toLowerCase())+1}else q=1;if(typeof n.birthDay=="string"&&n.birthDay.trim()!==""){const V=n.birthDay.match(/^(\d+)/);R=parseInt(V?V[1]:n.birthDay)}else R=1;if(typeof D.birthMonth=="string"&&D.birthMonth.trim()!==""){const V=parseInt(D.birthMonth);!isNaN(V)&&V>=1&&V<=12?k=V:k=["january","february","march","april","may","june","july","august","september","october","november","december"].indexOf(D.birthMonth.toLowerCase())+1}else k=1;if(typeof D.birthDay=="string"&&D.birthDay.trim()!==""){const V=D.birthDay.match(/^(\d+)/);H=parseInt(V?V[1]:D.birthDay)}else H=1;const re=new Date(t.getFullYear(),q-1,R),ve=new Date(t.getFullYear(),k-1,H);return re<t&&re.setFullYear(t.getFullYear()+1),ve<t&&ve.setFullYear(t.getFullYear()+1),re.getTime()-ve.getTime()})},[B]),r.useEffect(()=>{ee(1)},[E,Qe,Xe,Ze,et,bt,P,y]),r.useEffect(()=>{const t=c.get("customerId");if(t&&B.length>0){const s=B.find(n=>n.id===t);s&&(oe(s),de(!0),h(t),u("/customers",{replace:!0}))}},[c,B,h,u]);const pe=r.useMemo(()=>{if(!B||!Array.isArray(B))return[];let t=B;if(Qe.length>0&&(t=t.filter(s=>s.loyaltyLevel&&Qe.includes(s.loyaltyLevel))),Xe.length>0&&(t=t.filter(s=>{const n=s.isActive?"active":"inactive";return Xe.includes(n)})),Ze.length>0&&(t=t.filter(s=>s.colorTag&&Ze.includes(s.colorTag))),et.length>0&&(t=t.filter(s=>s.referralSource&&et.includes(s.referralSource))),bt&&(t=t.filter(s=>s.birthMonth||s.birthDay)),Jt&&(t=t.filter(s=>s.hasWhatsApp||s.whatsapp||s.phone)),yt.length>0&&(t=t.filter(s=>s.gender&&yt.includes(s.gender))),tt&&tt.trim()!==""){const s=parseFloat(tt);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.totalSpent||0)>=s))}if(st&&st.trim()!==""){const s=parseFloat(st);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.totalSpent||0)<=s))}if(rt&&rt.trim()!==""){const s=parseInt(rt);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.points||0)>=s))}if(at&&at.trim()!==""){const s=parseInt(at);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.points||0)<=s))}if(jt.length>0&&(t=t.filter(s=>s.city&&jt.includes(s.city))),nt&&nt.trim()!==""){const s=parseInt(nt);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.totalPurchases||0)>=s))}if(lt&&lt.trim()!==""){const s=parseInt(lt);!isNaN(s)&&s>=0&&(t=t.filter(n=>(n.totalPurchases||0)<=s))}if(ot&&ot.trim()!==""){const s=new Date(ot);isNaN(s.getTime())||(t=t.filter(n=>{if(!n.joinedDate)return!1;const D=new Date(n.joinedDate);return!isNaN(D.getTime())&&D>=s}))}if(it&&it.trim()!==""){const s=new Date(it);isNaN(s.getTime())||(t=t.filter(n=>{if(!n.joinedDate)return!1;const D=new Date(n.joinedDate);return!isNaN(D.getTime())&&D<=s}))}if(ct&&ct.trim()!==""){const s=new Date(ct);isNaN(s.getTime())||(t=t.filter(n=>{if(!n.lastVisit)return!1;const D=new Date(n.lastVisit);return!isNaN(D.getTime())&&D>=s}))}if(dt&&dt.trim()!==""){const s=new Date(dt);isNaN(s.getTime())||(t=t.filter(n=>{if(!n.lastVisit)return!1;const D=new Date(n.lastVisit);return!isNaN(D.getTime())&&D<=s}))}return P&&(t=t.filter(s=>{if(!s.lastVisit)return!1;const n=new Date(s.lastVisit),D=new Date(Date.now()-90*24*60*60*1e3);return n<D})),[...t].sort((s,n)=>{switch(y){case"name":return(s.name||"").localeCompare(n.name||"");case"recent":return new Date(n.joinedDate||0).getTime()-new Date(s.joinedDate||0).getTime();case"spent":const D=s.totalSpent??(s.payments?s.payments.reduce((k,R)=>k+(Number(R.amount)||0),0):0);return(n.totalSpent??(n.payments?n.payments.reduce((k,R)=>k+(Number(R.amount)||0),0):0))-D;case"points":return(n.points||0)-(s.points||0);default:return 0}})},[B,E,Qe,Xe,Ze,et,bt,yt,tt,st,rt,at,jt,nt,lt,ot,it,ct,dt,P,y]),Xt=t=>{switch(t){case"vip":return"bg-emerald-500/20 text-emerald-700 border-emerald-300/30";case"complainer":return"bg-rose-500/20 text-rose-700 border-rose-300/30";case"purchased":return"bg-blue-500/20 text-blue-700 border-blue-300/30";case"new":return"bg-purple-500/20 text-purple-700 border-purple-300/30";default:return"bg-gray-500/20 text-gray-700 border-gray-300/30"}},Zt=t=>{switch(t){case"vip":return"bg-purple-500/20 text-purple-700 border-purple-300/30";case"premium":return"bg-amber-500/20 text-amber-700 border-amber-300/30";case"regular":return"bg-blue-500/20 text-blue-700 border-blue-300/30";case"active":return"bg-green-500/20 text-green-700 border-green-300/30";case"payment_customer":return"bg-teal-500/20 text-teal-700 border-teal-300/30";case"engaged":return"bg-indigo-500/20 text-indigo-700 border-indigo-300/30";case"interested":return"bg-gray-400/20 text-gray-700 border-gray-300/30";default:return"bg-orange-500/20 text-orange-700 border-orange-300/30"}},es=async t=>{if(F.length===0){Y.error("Please select customers first");return}switch(t){case"export":Gs();break;case"message":Hs();break;case"delete":await Ks();break}},Gs=()=>{try{const t=B.filter(H=>F.includes(H.id)),s=["Name","Phone","Email","Gender","Address","City","Birthday","Loyalty Level","Loyalty Points","Total Spent","Total Purchases","Tags","Notes","Status","Created At"],n=t.map(H=>{var re;return[fe(H.name||H.full_name),fe(H.phone),fe(H.email),fe(H.gender),fe(H.address),fe(H.city),fe(H.birthday),fe(H.loyalty_level),fe(H.loyalty_points),fe(H.total_spent),fe(H.total_purchases),fe((re=H.tags)==null?void 0:re.join(", ")),fe(H.notes),fe(H.is_active?"Active":"Inactive"),fe(H.created_at)]}),D=[s.join(","),...n.map(H=>H.join(","))].join(`
`),q=new Blob([D],{type:"text/csv;charset=utf-8;"}),k=document.createElement("a"),R=URL.createObjectURL(q);k.setAttribute("href",R),k.setAttribute("download",`customers_export_${new Date().toISOString().split("T")[0]}.csv`),k.style.visibility="hidden",document.body.appendChild(k),k.click(),document.body.removeChild(k),Y.success(`Exported ${F.length} customers to CSV`),O([])}catch(t){console.error("Export error:",t),Y.error("Failed to export customers")}},Hs=()=>{if(B.filter(s=>F.includes(s.id)).length===0){Y.error("No customers selected");return}X(!0)},Ks=async()=>{if(await l(`Are you sure you want to delete ${F.length} customer${F.length!==1?"s":""}? This action cannot be undone.`))try{const{error:s}=await se.from("customers").delete().in("id",F);if(s)throw s;xe(k=>k.filter(R=>!F.includes(R.id))),Y.success(`Successfully deleted ${F.length} customer${F.length!==1?"s":""}`),O([]);const n=await ds(ie,100);xe(n.customers);const D=n.totalCount||0,q=n.customers.length>=100;ze(D>0?D:n.customers.length),Ke(n.totalPages>0?n.totalPages:q?ie+1:ie),Be(n.hasNextPage||q&&D===0),It(n.hasPreviousPage)}catch(s){console.error("Delete error:",s),Y.error("Failed to delete customers")}},Qs=t=>{O(s=>s.includes(t)?s.filter(n=>n!==t):[...s,t])},Xs=()=>{F.length===pe.length?O([]):O(pe.map(t=>t.id))},Zs=async(t,s)=>{if(!p){Y.error("You must be logged in to send SMS");return}M(!0);try{const n=await ur.sendBulkSMS({recipients:t.map(D=>D.phone),message:s,created_by:p.id});n.success?Y.success(`SMS sent successfully to all ${n.sent} customers!`):n.sent>0?Y.success(`SMS sent to ${n.sent} customers, ${n.failed} failed.`):Y.error(`Failed to send SMS to any customers. ${n.failed} errors.`)}catch(n){const D=n instanceof Error?n.message:"Unknown error occurred";console.error("BulkSMS Error:",D),Y.error(`Failed to send bulk SMS: ${D}`)}finally{M(!1),X(!1)}},er=t=>{xe(s=>[...s,...t]),ne(!1),Y.success(`Successfully imported ${t.length} customers`)},tr=t=>{xe(s=>s.map(n=>t.find(q=>q.id===n.id)||n)),he(!1),Y.success(`Successfully updated ${t.length} customers`)},sr=async t=>{try{await Br(t),Y.success("Appointment created successfully!");const s=await Bt();vt(s),ut(!1),ht(null)}catch(s){throw console.error("Error creating appointment:",s),s}},rr=async t=>{if(Rt)try{await Vr(Rt.id,t),Y.success("Appointment updated successfully!");const s=await Bt();vt(s),ut(!1),ht(null)}catch(s){throw console.error("Error updating appointment:",s),s}},ar=async t=>{Ct==="create"?await sr(t):await rr(t)},ts=t=>{const s=B.find(n=>n.id===t);return!s||!s.payments?0:s.payments.filter(n=>n.status==="completed").reduce((n,D)=>n+(Number(D.amount)||0),0)},ss=t=>{const s=B.find(q=>q.id===t);if(!s||!s.devices)return{count:0,lastActivity:"No devices"};const n=s.devices.length;let D="";if(n>0){const q=s.devices.reduce((ve,V)=>{const Fe=new Date(V.updatedAt||V.createdAt),or=new Date(ve.updatedAt||ve.createdAt);return Fe>or?V:ve},s.devices[0]),k=new Date(q.updatedAt||q.createdAt),H=new Date().getTime()-k.getTime(),re=Math.floor(H/(1e3*60*60*24));re===0?D="Today":re===1?D="1 day ago":D=`${re} days ago`}else D="No devices";return{count:n,lastActivity:D}},rs=t=>{const s=B.find(R=>R.id===t);if(!s||!s.payments)return{totalPurchases:0,totalItems:0,lastPurchase:null};const n=s.payments.filter(R=>R.source==="device_payment"&&R.status==="completed"),D=n.length,q=D;let k=null;return n.length>0&&(k=n.reduce((H,re)=>{const ve=new Date(re.date),V=new Date(H.date);return ve>V?re:H},n[0])),{totalPurchases:D,totalItems:q,lastPurchase:k}},nr=t=>{switch(t){case"confirmed":return"bg-green-100 text-green-800 border-green-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"completed":return"bg-blue-100 text-blue-800 border-blue-200";case"cancelled":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},lr=t=>{switch(t){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},as=r.useMemo(()=>{if(!ge||!Array.isArray(ge))return[];let t=ge;if(Ie.status!=="all"&&(t=t.filter(s=>s.status===Ie.status)),Ie.date!=="all"){const s=new Date().toISOString().split("T")[0],n=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];switch(Ie.date){case"today":t=t.filter(k=>k.appointment_date===s);break;case"tomorrow":t=t.filter(k=>k.appointment_date===n);break;case"this-week":const D=new Date;D.setDate(D.getDate()-D.getDay());const q=new Date;q.setDate(q.getDate()+(6-q.getDay())),t=t.filter(k=>{const R=new Date(k.appointment_date);return R>=D&&R<=q});break}}return Ie.customer!=="all"&&(t=t.filter(s=>s.customer_id===Ie.customer)),t},[ge,Ie]);return Ee?e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto",children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ge,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsxs("p",{className:"text-red-600 mb-4",children:["Error loading customers: ",Ee]}),e.jsx(ce,{onClick:()=>window.location.reload(),children:"Try Again"})]})})}):_e&&B.length===0?e.jsx(gr,{rows:10}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[o&&e.jsx("div",{style:{background:"#fbbf24",color:"black",padding:"8px",textAlign:"center"},children:"You are offline. Data is loaded from cache."}),e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Lr,{to:"/dashboard"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Customer Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your customer relationships, track loyalty, and schedule appointments"})]})]}),e.jsx("div",{className:"flex flex-wrap gap-3",children:mt==="customers"?e.jsxs(e.Fragment,{children:[e.jsx(ce,{onClick:()=>me(!0),icon:e.jsx(Ut,{size:18}),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white",children:"New Customer"}),["admin","customer-care"].includes((p==null?void 0:p.role)||"")&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{onClick:()=>ne(!0),icon:e.jsx(ps,{size:18}),className:"bg-gradient-to-r from-green-500 to-emerald-600 text-white",children:"Import Excel"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:Me,children:e.jsxs(ce,{onClick:()=>De(!ke),icon:e.jsx(Pt,{size:18}),variant:"secondary",children:["More Actions",e.jsx(bs,{size:16,className:`ml-1 transition-transform ${ke?"rotate-90":""}`})]})}),e.jsx(Xr,{open:ke,onClose:()=>De(!1),anchorRef:Me,children:e.jsx("div",{className:"py-1 min-w-[200px]",children:e.jsxs("button",{onClick:()=>{he(!0),De(!1)},className:"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx(Je,{size:16}),"Update Existing Customers"]})})})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{onClick:()=>{Qt("create"),ht(null),ut(!0)},icon:e.jsx(os,{size:18}),className:"bg-gradient-to-r from-green-500 to-emerald-600 text-white",children:"New Appointment"}),e.jsx(ce,{onClick:()=>u("/appointments"),icon:e.jsx(St,{size:18}),className:"bg-gradient-to-r from-purple-500 to-indigo-600 text-white",children:"Calendar View"})]})})]}),e.jsxs("div",{className:"flex space-x-1 bg-gray-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>Gt("customers"),className:`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-all duration-200 ${mt==="customers"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,children:[e.jsx(Dt,{size:18}),"Customers (",be.totalCustomers,")"]}),e.jsxs("button",{onClick:()=>Gt("appointments"),className:`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-all duration-200 ${mt==="appointments"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"}`,children:[e.jsx(St,{size:18}),"Appointments (",xt.totalAppointments,")"]})]}),mt==="customers"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Customer Statistics"}),e.jsxs("button",{onClick:async()=>{try{Nt(!0);const t=await ms();Ht(t)}catch(t){console.error("Error refreshing statistics:",t),Y.error("Failed to refresh statistics")}finally{Nt(!1)}},disabled:Ve,className:"flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Je,{className:`w-4 h-4 ${Ve?"animate-spin":""}`}),"Refresh Stats"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(ae,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Customers"}),Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:be.totalCustomers})]}),e.jsx("div",{className:"p-3 bg-blue-50/20 rounded-full",children:e.jsx(Dt,{className:"w-6 h-6 text-blue-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"Active Customers"}),Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-green-600"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-green-900",children:be.activeCustomers})]}),e.jsx("div",{className:"p-3 bg-green-50/20 rounded-full",children:e.jsx(us,{className:"w-6 h-6 text-green-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Total Revenue"}),Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:We(be.totalRevenue)})]}),e.jsx("div",{className:"p-3 bg-purple-50/20 rounded-full",children:e.jsx(hs,{className:"w-6 h-6 text-purple-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-amber-50 to-amber-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-600",children:"Total Devices"}),Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-600"}),e.jsx("p",{className:"text-2xl font-bold text-amber-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-amber-900",children:be.totalDevices})]}),e.jsx("div",{className:"p-3 bg-amber-50/20 rounded-full",children:e.jsx(Ar,{className:"w-6 h-6 text-amber-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-pink-50 to-pink-100 cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all duration-300",onClick:()=>wt(!0),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-pink-600",children:"Today's Birthdays"}),Ve?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-pink-600"}),e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:"Loading..."})]}):e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:be.todaysBirthdays})]}),e.jsx("div",{className:"p-3 bg-pink-50/20 rounded-full",children:e.jsx(Se,{className:"w-6 h-6 text-pink-600"})})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(ae,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Appointments"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:xt.totalAppointments})]}),e.jsx("div",{className:"p-3 bg-blue-50/20 rounded-full",children:e.jsx(St,{className:"w-6 h-6 text-blue-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"Confirmed"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:xt.confirmedAppointments})]}),e.jsx("div",{className:"p-3 bg-green-50/20 rounded-full",children:e.jsx(Le,{className:"w-6 h-6 text-green-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-yellow-50 to-yellow-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-yellow-600",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-900",children:xt.pendingAppointments})]}),e.jsx("div",{className:"p-3 bg-yellow-50/20 rounded-full",children:e.jsx(is,{className:"w-6 h-6 text-yellow-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Today's"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:xt.todaysAppointments})]}),e.jsx("div",{className:"p-3 bg-purple-50/20 rounded-full",children:e.jsx(Re,{className:"w-6 h-6 text-purple-600"})})]})}),e.jsx(ae,{className:"bg-gradient-to-br from-pink-50 to-pink-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-pink-600",children:"Birthdays"}),e.jsx("p",{className:"text-2xl font-bold text-pink-900",children:Ue.length})]}),e.jsx("div",{className:"p-3 bg-pink-50/20 rounded-full",children:e.jsx(Se,{className:"w-6 h-6 text-pink-600"})})]})})]}),e.jsx(ae,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),e.jsxs("select",{value:Ie.status,onChange:t=>Ot(s=>({...s,status:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"confirmed",children:"Confirmed"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date"}),e.jsxs("select",{value:Ie.date,onChange:t=>Ot(s=>({...s,date:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Dates"}),e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"tomorrow",children:"Tomorrow"}),e.jsx("option",{value:"this-week",children:"This Week"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Customer"}),e.jsxs("select",{value:Ie.customer,onChange:t=>Ot(s=>({...s,customer:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"All Customers"}),B.slice(0,10).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]})}),e.jsxs(ae,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200/50",children:[e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Service"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Date & Time"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Technician"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Priority"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:as.map(t=>e.jsxs("tr",{className:"border-b border-gray-200/30 hover:bg-blue-50 transition-colors",children:[e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.customer_name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.customer_phone})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.service_type}),e.jsx("p",{className:"text-sm text-gray-600",children:t.notes})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:new Date(t.appointment_date).toLocaleDateString()}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.appointment_time," (",t.duration_minutes," min)"]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsx("p",{className:"text-gray-900",children:t.technician_name})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${nr(t.status)}`,children:[t.status==="confirmed"&&e.jsx(Le,{size:12,className:"mr-1"}),t.status==="pending"&&e.jsx(is,{size:12,className:"mr-1"}),t.status==="completed"&&e.jsx(Le,{size:12,className:"mr-1"}),t.status==="cancelled"&&e.jsx(At,{size:12,className:"mr-1"}),t.status]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${lr(t.priority)}`,children:[t.priority==="high"&&e.jsx(Er,{size:12,className:"mr-1"}),t.priority]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>{Qt("edit"),ht(t),ut(!0)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"Edit Appointment",children:e.jsx(zt,{size:16})}),e.jsx("button",{onClick:s=>{s.stopPropagation();const n=B.find(D=>D.id===t.customer_id);n&&(oe(n),de(!0),h(n.id))},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"View Customer Details",children:e.jsx(pt,{size:16})}),e.jsx("button",{onClick:()=>{t.customer_phone?window.open(`tel:${t.customer_phone}`):Y.error("No phone number available")},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Call Customer",children:e.jsx(ft,{size:16})})]})})]},t.id))})]})}),as.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(St,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No appointments found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Try adjusting your filters or create a new appointment"}),e.jsx(ce,{onClick:()=>{},icon:e.jsx(os,{size:18}),children:"Create Appointment"})]})]})]}),mt==="customers"&&e.jsxs(e.Fragment,{children:[(be.deviceRevenue>0||be.posRevenue>0)&&e.jsxs(ae,{className:"bg-gradient-to-br from-blue-50 to-indigo-100",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Revenue Breakdown"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-500 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-700",children:"Device Repairs"}),e.jsx("p",{className:"text-xs text-blue-600",children:"Repair payments"})]})]}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:We(be.deviceRevenue)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:"POS Sales"}),e.jsx("p",{className:"text-xs text-green-600",children:"Product sales"})]})]}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:We(be.posRevenue)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(ae,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Loyalty Distribution"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-purple-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Platinum"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[be.platinumCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-amber-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Gold"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[be.goldCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-400 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Silver"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[be.silverCustomers," customers"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium",children:"Bronze"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[be.bronzeCustomers," customers"]})]})]})]}),e.jsxs(ae,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Quick Actions"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(ce,{variant:"secondary",icon:e.jsx(kt,{size:16}),onClick:()=>X(!0),className:"text-sm",children:"Send SMS"}),e.jsx(ce,{variant:"secondary",icon:e.jsx(Pr,{size:16}),onClick:()=>u("/customer-analytics"),className:"text-sm",children:"Analytics"}),e.jsx(ce,{variant:"secondary",icon:e.jsx(ys,{size:16}),onClick:()=>u("/finance/payments"),className:"text-sm",children:"Points"}),e.jsx(ce,{variant:"secondary",icon:e.jsx(Re,{size:16}),onClick:()=>u("/customer-events"),className:"text-sm",children:"Events"})]})]})]}),e.jsx(Hr,{searchQuery:f,onSearchChange:v,loyaltyFilter:Qe,onLoyaltyFilterChange:vs,statusFilter:Xe,onStatusFilterChange:Ns,tagFilter:Ze,onTagFilterChange:ws,referralFilter:et,onReferralFilterChange:Cs,birthdayFilter:bt,onBirthdayFilterChange:Ss,whatsappFilter:Jt,onWhatsappFilterChange:ks,showInactive:P,onShowInactiveChange:j,sortBy:y,onSortByChange:_,customers:B,searchLoading:i,filteredCount:pe.length,genderFilter:yt,onGenderFilterChange:Ds,minSpent:tt,onMinSpentChange:Ms,maxSpent:st,onMaxSpentChange:_s,minPoints:rt,onMinPointsChange:As,maxPoints:at,onMaxPointsChange:Es,cityFilter:jt,onCityFilterChange:Ps,minPurchases:nt,onMinPurchasesChange:Is,maxPurchases:lt,onMaxPurchasesChange:Ls,joinDateFrom:ot,onJoinDateFromChange:Os,joinDateTo:it,onJoinDateToChange:$s,lastVisitFrom:ct,onLastVisitFromChange:Ts,lastVisitTo:dt,onLastVisitToChange:Fs}),$&&e.jsx("div",{className:"mb-4",children:e.jsx(Gr,{isSearching:$,searchStatus:T,searchProgress:z,resultCount:we,onCancel:()=>{te&&(cs().cancelSearchJob(te),w(!1),Z(null))}})}),F.length>0&&e.jsx(ae,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-5 h-5 text-blue-600"}),e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:[F.length," customer",F.length!==1?"s":""," selected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ce,{variant:"secondary",icon:e.jsx(kt,{size:16}),onClick:()=>es("message"),className:"text-sm",children:"Send Message"}),e.jsx(ce,{variant:"secondary",icon:e.jsx(Pt,{size:16}),onClick:()=>es("export"),className:"text-sm",children:"Export"}),e.jsx(ce,{variant:"secondary",icon:e.jsx(At,{size:16}),onClick:()=>O([]),className:"text-sm text-red-600",children:"Clear"})]})]})})]}),Q==="list"?e.jsxs(ae,{children:[a&&e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-sm opacity-70",children:[e.jsx(Je,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading..."})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200/50",children:[e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:e.jsx("input",{type:"checkbox",checked:F.length===pe.length&&pe.length>0,onChange:Xs,className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Contact"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Branch"}),e.jsx("th",{className:"text-left py-4 px-4 font-medium text-gray-700",children:"Devices"}),e.jsx("th",{className:"text-right py-4 px-4 font-medium text-gray-700",children:"Total Spent"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Loyalty"}),e.jsx("th",{className:"text-right py-4 px-4 font-medium text-gray-700",children:"Points"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Status"}),e.jsx("th",{className:"text-center py-4 px-4 font-medium text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:pe.map(t=>{const s=ss(t.id);return e.jsxs("tr",{className:"border-b border-gray-200/30 hover:bg-blue-50 cursor-pointer transition-colors",onClick:()=>{oe(t),de(!0),h(t.id)},children:[e.jsx("td",{className:"py-4 px-4",children:e.jsx("input",{type:"checkbox",checked:F.includes(t.id),onChange:n=>{n.stopPropagation(),Qs(t.id)},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold",children:t.name.charAt(0)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600",children:t.city})]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(ft,{className:"w-3 h-3 text-blue-500"}),e.jsx("span",{className:"text-blue-600 font-medium",children:t.phone})]}),t.referralSource&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-purple-600",children:[e.jsx(Vt,{className:"w-3 h-3"}),e.jsx("span",{children:t.referralSource})]}),(t.birthMonth||t.birthDay)&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-pink-600",children:[e.jsx(Re,{className:"w-3 h-3"}),e.jsxs("span",{children:[t.birthMonth," ",t.birthDay]})]})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{className:"text-sm text-gray-700 font-medium",children:t.branchName})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-gray-900 font-semibold",children:[s.count," device",s.count!==1?"s":""]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Last: ",s.lastActivity]})]})}),e.jsxs("td",{className:"py-4 px-4 text-right",children:[e.jsx("p",{className:"text-gray-900 font-semibold",children:We(ts(t.id))}),(()=>{var q;const D=(((q=t.payments)==null?void 0:q.filter(k=>k.source==="device_payment"&&k.status==="completed"))||[]).reduce((k,R)=>k+(Number(R.amount)||0),0);return D>0?e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-blue-500 rounded-full"}),e.jsxs("span",{children:["Repairs: ",We(D)]})]})}):null})(),(()=>{const n=rs(t.id);return n.totalPurchases>0?e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"w-1 h-1 bg-green-500 rounded-full"}),e.jsxs("span",{children:[n.totalPurchases," purchase",n.totalPurchases!==1?"s":""," â€¢ ",n.totalItems," items"]})]})}):null})()]}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:`
                          inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm border
                          ${Zt(t.loyaltyLevel)}
                        `,children:[e.jsx(gt,{size:14}),e.jsx("span",{className:"capitalize",children:t.loyaltyLevel})]})}),e.jsx("td",{className:"py-4 px-4 text-right",children:e.jsx("p",{className:"text-gray-900 font-semibold",children:t.points})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:`
                          inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm border
                          ${Xt(t.colorTag)}
                        `,children:[!t.isActive&&e.jsx(Ir,{size:14}),e.jsx("span",{className:"capitalize",children:t.colorTag})]})}),e.jsx("td",{className:"py-4 px-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),oe(t),de(!0),h(t.id),h(t.id)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(pt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),oe(t),de(!0),h(t.id)},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"View Customer",children:e.jsx(zt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),u(`/sms-control?customer=${t.id}`)},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Send Message",children:e.jsx(kt,{size:16})})]})})]},t.id)})})]})})]}):e.jsxs("div",{children:[a&&e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-sm opacity-70",children:[e.jsx(Je,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading..."})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:pe.map(t=>{const s=ss(t.id);return e.jsxs(ae,{onClick:()=>{oe(t),de(!0),h(t.id)},className:"cursor-pointer hover:scale-105 transition-transform duration-300",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-lg",children:t.name.charAt(0)}),e.jsx("div",{className:`
                    px-2 py-1 rounded-full text-xs border
                    ${Xt(t.colorTag)}
                  `,children:t.colorTag})]}),e.jsx("h3",{className:"font-semibold text-gray-900",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:t.city}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600 mb-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{children:t.branchName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm mb-1",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-blue-600 font-medium",children:t.phone})]}),t.referralSource&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-purple-600 mb-1",children:[e.jsx(Vt,{className:"w-3 h-3"}),e.jsxs("span",{children:["From: ",t.referralSource]})]}),(t.birthMonth||t.birthDay)&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-pink-600 mb-1",children:[e.jsx(Re,{className:"w-3 h-3"}),e.jsxs("span",{children:[t.birthMonth," ",t.birthDay]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mb-2",children:[e.jsxs("span",{children:[s.count," device",s.count!==1?"s":""]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Last: ",s.lastActivity]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:`
                    inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border
                    ${Zt(t.loyaltyLevel)}
                  `,children:[e.jsx(gt,{size:12}),e.jsx("span",{className:"capitalize",children:t.loyaltyLevel})]}),e.jsxs("span",{className:"text-xs font-semibold text-gray-900",children:[t.points," pts"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs mb-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total Spent:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:We(ts(t.id))})]}),(()=>{var q;if(!((q=t==null?void 0:t.payments)!=null&&q.length))return null;const D=t.payments.filter(k=>k.source==="device_payment"&&k.status==="completed").reduce((k,R)=>k+(Number(R.amount)||0),0);return D>0?e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 mb-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsxs("span",{children:["Repairs: ",We(D)]})]})}):null})(),(()=>{const n=rs(t.id);return n.totalPurchases>0?e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsxs("span",{children:[n.totalPurchases," purchase",n.totalPurchases!==1?"s":""]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[n.totalItems," item",n.totalItems!==1?"s":""]})]}),n.lastPurchase&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Last: ",new Date(n.lastPurchase.date).toLocaleDateString()]})]}):null})(),e.jsxs("div",{className:"flex items-center justify-end gap-2 mt-2",children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),oe(t),de(!0),h(t.id)},className:"p-1 text-gray-500 hover:text-blue-600 transition-colors",title:"View Details",children:e.jsx(pt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),oe(t),de(!0),h(t.id)},className:"p-1 text-gray-500 hover:text-green-600 transition-colors",title:"Edit Customer",children:e.jsx(zt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),u(`/sms-control?customer=${t.id}`)},className:"p-1 text-gray-500 hover:text-purple-600 transition-colors",title:"Send Message",children:e.jsx(kt,{size:16})})]})]},t.id)})})]}),pe.length>0&&e.jsxs("div",{className:"mt-6 text-center space-y-4",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500 animate-pulse"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Showing ",pe.length.toLocaleString()," of ",we.toLocaleString()]})]}),(Te||pe.length<we)&&e.jsx("span",{className:"text-xs text-gray-500",children:"â€¢ Scroll for more"})]}),!qe&&(Te||pe.length<we)&&pe.length>0&&e.jsxs("div",{className:"flex flex-col items-center gap-3 py-6 bg-gradient-to-b from-transparent via-blue-50/30 to-transparent",children:[e.jsxs("button",{onClick:()=>{qe||(Lt(!0),ee(t=>t+1))},className:"group relative px-10 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 text-lg font-bold shadow-2xl hover:shadow-blue-500/50 transform hover:scale-110 flex items-center gap-3 border-2 border-blue-400/50",children:[e.jsx("span",{children:"Load More Customers"}),e.jsx("svg",{className:"w-6 h-6 group-hover:translate-y-1 transition-transform duration-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M19 9l-7 7-7-7"})})]}),e.jsxs("div",{className:"text-sm font-medium text-gray-600",children:["Click to load ",Math.min(100,we-pe.length)," more customers"]})]}),qe&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"w-6 h-6 animate-spin text-blue-500"}),e.jsx("div",{className:"absolute inset-0 bg-blue-400 blur-lg opacity-30 animate-pulse"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Loading more customers..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Please wait"})]})]}),!qe&&!Te&&pe.length>0&&e.jsxs("div",{className:"flex flex-col items-center gap-2 py-6",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-green-50 rounded-full border border-green-200",children:[e.jsx(Le,{className:"w-4 h-4 text-green-600"}),e.jsxs("span",{className:"text-sm font-medium text-green-700",children:["All ",we.toLocaleString()," customers loaded"]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"You've reached the end of the list"})]}),e.jsx("div",{ref:Yt,className:"h-1"})]}),pe.length===0&&e.jsxs(ae,{className:"text-center py-12",children:[e.jsx(Dt,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No customers found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Try adjusting your search or filter criteria"}),e.jsx(ce,{onClick:()=>me(!0),icon:e.jsx(Ut,{size:18}),children:"Add Your First Customer"})]}),e.jsx(Rr,{isOpen:ye,onClose:()=>me(!1),onCustomerCreated:t=>{xe(s=>[t,...s]),ze(s=>s+1),me(!1),h(t.id),x.show(`Customer "${t.name}" has been added successfully!`,{title:"Customer Added",actionButtons:[{label:"View Details",onClick:()=>{oe(t),de(!0)},variant:"primary"},{label:"Add Another",onClick:()=>me(!0),variant:"secondary"}]})}}),e.jsx(Or,{open:ue,onClose:()=>X(!1),customers:B,onSend:Zs,sending:I}),e.jsx(Kr,{isOpen:le,onClose:()=>ne(!1),onImportComplete:er}),e.jsx(Qr,{isOpen:Ne,onClose:()=>he(!1),onImportComplete:tr}),e.jsx(zr,{isOpen:Js,onClose:()=>{ut(!1),ht(null)},customer:Ct==="create"&&je||void 0,appointment:Ct==="edit"&&Rt||void 0,onSave:ar,mode:Ct}),Bs&&Ue.length>0&&e.jsx(ta,{todaysBirthdays:Ue,onClose:()=>Vs(!1),onViewCustomers:()=>Kt(!0)}),Us&&e.jsx(sa,{todaysBirthdays:Ue,onClose:()=>Tt(!1)}),Ws&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(ae,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Birthday Calendar"}),e.jsx("button",{onClick:()=>Kt(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Oe,{className:"w-6 h-6"})})]}),e.jsx(ra,{customers:B,onCustomerClick:t=>{oe(t),de(!0),h(t.id)}})]})})}),qs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(ae,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Birthday Rewards"}),e.jsx("button",{onClick:()=>Ft(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Oe,{className:"w-6 h-6"})})]}),e.jsx(aa,{todaysBirthdays:Ue,onApplyReward:(t,s)=>{Y.success("Birthday reward applied successfully!")}})]})})}),Ys&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs(ae,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-rose-500 to-fuchsia-600 rounded-xl flex items-center justify-center shadow-lg",children:e.jsx(Se,{size:24,className:"text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"All Birthday Customers"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Ue.length," customers celebrating today"]})]})]}),e.jsx("button",{onClick:()=>wt(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Oe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:Ue.map(t=>e.jsx("div",{className:"group relative",children:e.jsxs("div",{className:"relative bg-gradient-to-br from-white to-gray-50/50 rounded-xl p-4 border border-gray-100/60 shadow-sm hover:shadow-md transition-all duration-500 hover:scale-105 hover:-translate-y-1 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-rose-50/20 via-transparent to-fuchsia-50/20"}),e.jsxs("div",{className:"relative z-10 flex items-center gap-3 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-12 h-12 bg-gradient-to-br from-rose-400 to-fuchsia-600 rounded-xl flex items-center justify-center shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-pulse"}),e.jsx("span",{className:"text-lg font-bold text-white relative z-10",children:t.name.charAt(0).toUpperCase()})]}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-sm animate-bounce",children:e.jsx("span",{className:"text-xs",children:"ðŸŽ‚"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-bold text-gray-900 truncate text-base",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.birthMonth," ",t.birthDay]}),t.phone&&e.jsxs("p",{className:"text-xs text-blue-500 font-medium mt-1",children:["ðŸ“ž ",t.phone]})]})]}),e.jsxs("div",{className:"relative z-10 flex items-center gap-2",children:[t.phone&&e.jsxs("button",{onClick:()=>window.open(`tel:${t.phone}`),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-rose-500 to-fuchsia-600 text-white text-sm font-semibold rounded-lg hover:from-rose-600 hover:to-fuchsia-700 transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",title:"Call customer",children:[e.jsx(ft,{size:14}),"Call"]}),e.jsx("button",{onClick:()=>{oe(t),de(!0),h(t.id)},className:"flex items-center justify-center w-10 h-10 bg-gradient-to-br from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-600 hover:text-gray-800 rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",title:"View customer details",children:e.jsx(pt,{size:16})})]}),e.jsxs("div",{className:"relative z-10 flex gap-2 mt-3",children:[e.jsxs("button",{onClick:()=>Tt(!0),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 text-white text-sm font-semibold rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",children:[e.jsx("span",{className:"text-sm",children:"ðŸ’¬"}),"Send Message"]}),e.jsxs("button",{onClick:()=>Ft(!0),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gradient-to-r from-fuchsia-500 to-fuchsia-600 hover:from-fuchsia-600 hover:to-fuchsia-700 text-white text-sm font-semibold rounded-lg transition-all duration-300 shadow-sm hover:shadow-md transform hover:scale-105",children:[e.jsx("span",{className:"text-sm",children:"ðŸŽ"}),"Give Reward"]})]})]})},t.id))}),e.jsx("div",{className:"mt-6 pt-6 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-sm text-gray-600",children:"Quick Actions:"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>{wt(!1),Tt(!0)},className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-rose-500 to-rose-600 text-white text-sm font-semibold rounded-lg hover:from-rose-600 hover:to-rose-700 transition-all duration-300 shadow-sm hover:shadow-md",children:[e.jsx(xs,{size:16}),"Send All Messages"]}),e.jsxs("button",{onClick:()=>{wt(!1),Ft(!0)},className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-fuchsia-500 to-fuchsia-600 text-white text-sm font-semibold rounded-lg hover:from-fuchsia-600 hover:to-fuchsia-700 transition-all duration-300 shadow-sm hover:shadow-md",children:[e.jsx(Se,{size:16}),"Apply All Rewards"]})]})]})})]})})}),je&&e.jsx(Fr,{isOpen:$e,onClose:()=>{de(!1),oe(null)},customer:je,onEdit:t=>{}}),e.jsx(Wr,{...x.props})]})};export{Oa as default};
