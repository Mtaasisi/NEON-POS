import{ap as m,s as i}from"./index-61458a34.js";const S="mobile-offline-pos",r=1,b={products:24*60*60*1e3,customers:12*60*60*1e3,sales:7*24*60*60*1e3,branches:24*60*60*1e3,categories:48*60*60*1e3,payment_accounts:24*60*60*1e3,settings:48*60*60*1e3};class p{constructor(){this.db=null}async init(){return this.db?this.db:(this.db=await m(S,r,{upgrade(e,t,a,s){if(console.log("üì¶ [MobileCache] Upgrading database from",t,"to",a),!e.objectStoreNames.contains("products")){const c=e.createObjectStore("products",{keyPath:"id"});c.createIndex("category","category"),c.createIndex("is_active","is_active")}e.objectStoreNames.contains("customers")||e.createObjectStore("customers",{keyPath:"id"}),e.objectStoreNames.contains("sales")||e.createObjectStore("sales",{keyPath:"id"}).createIndex("created_at","created_at"),e.objectStoreNames.contains("branches")||e.createObjectStore("branches",{keyPath:"id"}),e.objectStoreNames.contains("categories")||e.createObjectStore("categories",{keyPath:"id"}),e.objectStoreNames.contains("payment_accounts")||e.createObjectStore("payment_accounts",{keyPath:"id"}),e.objectStoreNames.contains("settings")||e.createObjectStore("settings",{keyPath:"key"}),e.objectStoreNames.contains("pending_sales")||e.createObjectStore("pending_sales",{keyPath:"id",autoIncrement:!0}).createIndex("created_at","created_at"),e.objectStoreNames.contains("sync_metadata")||e.createObjectStore("sync_metadata",{keyPath:"store"})}}),console.log("‚úÖ [MobileCache] Database initialized"),this.db)}async isCacheValid(e){try{const a=await(await this.init()).get("sync_metadata",e);if(!a)return!1;const s=b[e],c=Date.now(),o=new Date(a.lastSynced).getTime();return c-o<s}catch(t){return console.error(`‚ùå [MobileCache] Error checking cache validity for ${e}:`,t),!1}}async syncAll(e){console.log("üîÑ [MobileCache] Starting full sync...",e?`for branch ${e}`:"");const t=[],a=[];try{try{await this.syncProducts(e),t.push("products")}catch(s){console.error("‚ùå [MobileCache] Error syncing products:",s),a.push("products")}try{await this.syncCustomers(e),t.push("customers")}catch(s){console.error("‚ùå [MobileCache] Error syncing customers:",s),a.push("customers")}try{await this.syncBranches(),t.push("branches")}catch(s){console.error("‚ùå [MobileCache] Error syncing branches:",s),a.push("branches")}try{await this.syncCategories(),t.push("categories")}catch(s){console.error("‚ùå [MobileCache] Error syncing categories:",s),a.push("categories")}try{await this.syncPaymentAccounts(),t.push("payment_accounts")}catch(s){console.error("‚ùå [MobileCache] Error syncing payment accounts:",s),a.push("payment_accounts")}try{await this.syncRecentSales(e),t.push("sales")}catch(s){console.error("‚ùå [MobileCache] Error syncing sales:",s),a.push("sales")}return console.log(`‚úÖ [MobileCache] Sync complete. Synced: ${t.join(", ")}`),a.length>0&&console.warn(`‚ö†Ô∏è [MobileCache] Errors: ${a.join(", ")}`),{success:a.length===0,synced:t,errors:a}}catch(s){return console.error("‚ùå [MobileCache] Fatal error during sync:",s),{success:!1,synced:t,errors:[...a,"fatal_error"]}}}async syncProducts(e){console.log("üîÑ [MobileCache] Syncing products...");const t=await this.init();let a=i.from("lats_products").select("*").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1e3);e&&(a=a.eq("branch_id",e));const{data:s,error:c}=await a;if(c)throw new Error(`Failed to sync products: ${c.message}`);if(!s||s.length===0){console.log("‚ö†Ô∏è [MobileCache] No products to sync");return}const o=t.transaction("products","readwrite");await o.store.clear();for(const n of s)await o.store.put({...n,_cachedAt:new Date().toISOString()});await o.done,await t.put("sync_metadata",{store:"products",lastSynced:new Date().toISOString(),itemCount:s.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${s.length} products`)}async syncCustomers(e){console.log("üîÑ [MobileCache] Syncing customers...");const t=await this.init();let a=i.from("lats_customers").select("*").order("created_at",{ascending:!1}).limit(500);e&&(a=a.eq("branch_id",e));const{data:s,error:c}=await a;if(c)throw new Error(`Failed to sync customers: ${c.message}`);if(!s||s.length===0){console.log("‚ö†Ô∏è [MobileCache] No customers to sync");return}const o=t.transaction("customers","readwrite");await o.store.clear();for(const n of s)await o.store.put({...n,_cachedAt:new Date().toISOString()});await o.done,await t.put("sync_metadata",{store:"customers",lastSynced:new Date().toISOString(),itemCount:s.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${s.length} customers`)}async syncBranches(){console.log("üîÑ [MobileCache] Syncing branches...");const e=await this.init(),{data:t,error:a}=await i.from("lats_branches").select("*").eq("is_active",!0);if(a)throw new Error(`Failed to sync branches: ${a.message}`);if(!t||t.length===0){console.log("‚ö†Ô∏è [MobileCache] No branches to sync");return}const s=e.transaction("branches","readwrite");await s.store.clear();for(const c of t)await s.store.put({...c,_cachedAt:new Date().toISOString()});await s.done,await e.put("sync_metadata",{store:"branches",lastSynced:new Date().toISOString(),itemCount:t.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${t.length} branches`)}async syncCategories(){console.log("üîÑ [MobileCache] Syncing categories...");const e=await this.init(),{data:t,error:a}=await i.from("lats_categories").select("*").eq("is_active",!0);if(a)throw new Error(`Failed to sync categories: ${a.message}`);if(!t||t.length===0){console.log("‚ö†Ô∏è [MobileCache] No categories to sync");return}const s=e.transaction("categories","readwrite");await s.store.clear();for(const c of t)await s.store.put({...c,_cachedAt:new Date().toISOString()});await s.done,await e.put("sync_metadata",{store:"categories",lastSynced:new Date().toISOString(),itemCount:t.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${t.length} categories`)}async syncPaymentAccounts(){console.log("üîÑ [MobileCache] Syncing payment accounts...");const e=await this.init(),{data:t,error:a}=await i.from("finance_accounts").select("*").eq("is_active",!0).eq("is_payment_method",!0);if(a)throw new Error(`Failed to sync payment accounts: ${a.message}`);if(!t||t.length===0){console.log("‚ö†Ô∏è [MobileCache] No payment accounts to sync");return}const s=e.transaction("payment_accounts","readwrite");await s.store.clear();for(const c of t)await s.store.put({...c,_cachedAt:new Date().toISOString()});await s.done,await e.put("sync_metadata",{store:"payment_accounts",lastSynced:new Date().toISOString(),itemCount:t.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${t.length} payment accounts`)}async syncRecentSales(e){console.log("üîÑ [MobileCache] Syncing recent sales...");const t=await this.init(),a=new Date;a.setDate(a.getDate()-30);let s=i.from("lats_sales").select("*").gte("created_at",a.toISOString()).order("created_at",{ascending:!1}).limit(200);e&&(s=s.eq("branch_id",e));const{data:c,error:o}=await s;if(o)throw new Error(`Failed to sync sales: ${o.message}`);if(!c||c.length===0){console.log("‚ö†Ô∏è [MobileCache] No sales to sync");return}const n=t.transaction("sales","readwrite");await n.store.clear();for(const l of c)await n.store.put({...l,_cachedAt:new Date().toISOString()});await n.done,await t.put("sync_metadata",{store:"sales",lastSynced:new Date().toISOString(),itemCount:c.length,version:r}),console.log(`‚úÖ [MobileCache] Synced ${c.length} sales`)}async getProducts(){const t=await(await this.init()).getAll("products");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached products`),t}async getCustomers(){const t=await(await this.init()).getAll("customers");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached customers`),t}async getSales(){const t=await(await this.init()).getAll("sales");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached sales`),t}async getBranches(){const t=await(await this.init()).getAll("branches");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached branches`),t}async getCategories(){const t=await(await this.init()).getAll("categories");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached categories`),t}async getPaymentAccounts(){const t=await(await this.init()).getAll("payment_accounts");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} cached payment accounts`),t}async savePendingSale(e){const a=await(await this.init()).add("pending_sales",{...e,created_at:new Date().toISOString(),synced:!1});return console.log(`üíæ [MobileCache] Saved pending sale with ID ${a}`),a}async getPendingSales(){const t=await(await this.init()).getAll("pending_sales");return console.log(`üì¶ [MobileCache] Retrieved ${t.length} pending sales`),t.filter(a=>!a.synced)}async markSaleSynced(e){const t=await this.init(),a=await t.get("pending_sales",e);a&&(await t.put("pending_sales",{...a,synced:!0}),console.log(`‚úÖ [MobileCache] Marked sale ${e} as synced`))}async getCacheStats(){const e=await this.init(),[t,a,s,c,o,n,l,d,h,g,u,y,w]=await Promise.all([e.count("products"),e.count("customers"),e.count("sales"),e.count("branches"),e.count("categories"),e.count("payment_accounts"),e.count("pending_sales"),e.get("sync_metadata","products"),e.get("sync_metadata","customers"),e.get("sync_metadata","sales"),e.get("sync_metadata","branches"),e.get("sync_metadata","categories"),e.get("sync_metadata","payment_accounts")]);return{products:{count:t,lastSynced:(d==null?void 0:d.lastSynced)||null},customers:{count:a,lastSynced:(h==null?void 0:h.lastSynced)||null},sales:{count:s,lastSynced:(g==null?void 0:g.lastSynced)||null},branches:{count:c,lastSynced:(u==null?void 0:u.lastSynced)||null},categories:{count:o,lastSynced:(y==null?void 0:y.lastSynced)||null},payment_accounts:{count:n,lastSynced:(w==null?void 0:w.lastSynced)||null},pending_sales:{count:l}}}async clearAll(){console.log("üóëÔ∏è [MobileCache] Clearing all cached data...");const e=await this.init();await Promise.all([e.clear("products"),e.clear("customers"),e.clear("sales"),e.clear("branches"),e.clear("categories"),e.clear("payment_accounts"),e.clear("pending_sales"),e.clear("sync_metadata")]),console.log("‚úÖ [MobileCache] All cache cleared")}}const C=new p;export{C as m};
