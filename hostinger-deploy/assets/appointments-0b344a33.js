import{s as i,af as _,ae as p}from"./index-61458a34.js";async function g(){try{console.log("ðŸ“… Fetching all appointments...");let{data:e,error:o}=await i.from("appointments").select("*").order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});if(o){console.warn("âš ï¸ appointment_date field failed, trying scheduled_date:",o);const{data:t,error:n}=await i.from("appointments").select("*").order("scheduled_date",{ascending:!0});if(n)throw console.error("âŒ Error fetching appointments:",n),n;e=t}const s=(e==null?void 0:e.map(t=>{var d,m,u;const n=t.appointment_date||t.scheduled_date,l=t.appointment_time||"00:00:00",c=t.service_type||t.appointment_type||"Unknown Service",r=((d=t.customers)==null?void 0:d.name)||t.customer_name||"Unknown Customer",a=((m=t.customers)==null?void 0:m.phone)||t.customer_phone||"No Phone",h=((u=t.auth_users)==null?void 0:u.name)||t.technician_name||"No Technician";return{id:t.id,customer_id:t.customer_id,customer_name:r,customer_phone:a,service_type:c,appointment_date:n,appointment_time:l,status:t.status,notes:t.notes,priority:t.priority,technician_name:h,duration_minutes:t.duration_minutes||t.estimated_duration||60,created_at:t.created_at,updated_at:t.updated_at,...t}}))||[];return console.log(`âœ… Fetched ${s.length} appointments`),s}catch(e){throw console.error("âŒ Error fetching appointments:",e),e}}async function y(e){try{console.log(`ðŸ“… Fetching appointments for customer: ${e}`);const{data:o,error:s}=await i.from("appointments").select("*").eq("customer_id",e).order("appointment_date",{ascending:!0}).order("appointment_time",{ascending:!0});if(s)throw console.error("âŒ Error fetching customer appointments:",s),s;const t=(o==null?void 0:o.map(n=>({...n,technician_name:n.technician_name||"No Technician"})))||[];return console.log(`âœ… Fetched ${t.length} appointments for customer`),t}catch(o){throw console.error("âŒ Error fetching customer appointments:",o),o}}async function w(e){try{console.log("ðŸ“… Creating new appointment...");let o="",s="";try{const{data:r,error:a}=await i.from("customers").select("is_active, name, phone").eq("id",e.customer_id).single();if(a)throw console.error("âŒ Error fetching customer details:",a),new Error(`Failed to fetch customer details: ${a.message}`);if(!r)throw new Error("Customer not found");o=r.name,s=r.phone,r.is_active||(console.log(`ðŸ”„ Customer ${r.name} is inactive, reactivating...`),await _(e.customer_id),console.log(`âœ… Customer ${r.name} reactivated automatically`))}catch(r){throw console.error("âŒ Failed to fetch customer details:",r),r}let t="";if(e.technician_id)try{const{data:r}=await i.from("users").select("full_name").eq("id",e.technician_id).single();t=(r==null?void 0:r.full_name)||""}catch(r){console.warn("âš ï¸ Could not fetch technician name:",r)}const n={customer_id:e.customer_id,notes:e.notes,priority:e.priority||"medium",status:"scheduled"};n.service_type=e.service_type,n.appointment_date=e.appointment_date,n.appointment_time=e.appointment_time,n.duration_minutes=e.duration_minutes||60,o&&(n.customer_name=o),s&&(n.customer_phone=s),e.technician_id&&(n.technician_id=e.technician_id),t&&(n.technician_name=t);const{data:l,error:c}=await i.from("appointments").insert([n]).select().single();if(c)throw console.error("âŒ Error creating appointment:",c),c;try{await p(e.customer_id,"appointment_scheduled"),console.log("ðŸ“Š Appointment scheduling activity tracked successfully")}catch(r){console.warn("âš ï¸ Failed to track appointment activity:",r)}return console.log("âœ… Appointment created successfully"),l}catch(o){throw console.error("âŒ Error creating appointment:",o),o}}async function E(e,o){try{console.log(`ðŸ“… Updating appointment: ${e}`);const{data:s,error:t}=await i.from("appointments").update({...o,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(t)throw console.error("âŒ Error updating appointment:",t),t;try{await p(s.customer_id,"appointment_updated"),console.log("ðŸ“Š Appointment update activity tracked successfully")}catch(n){console.warn("âš ï¸ Failed to track appointment update activity:",n)}return console.log("âœ… Appointment updated successfully"),s}catch(s){throw console.error("âŒ Error updating appointment:",s),s}}async function v(e){try{console.log(`ðŸ“… Deleting appointment: ${e}`);const{error:o}=await i.from("appointments").delete().eq("id",e);if(o)throw console.error("âŒ Error deleting appointment:",o),o;return console.log("âœ… Appointment deleted successfully"),!0}catch(o){throw console.error("âŒ Error deleting appointment:",o),o}}async function A(){try{console.log("ðŸ“Š Fetching appointment statistics...");let{data:e,error:o}=await i.from("appointments").select("status, appointment_date");if(o){console.warn("âš ï¸ appointment_date field failed, trying scheduled_date:",o);const{data:c,error:r}=await i.from("appointments").select("status, scheduled_date");if(r)throw console.error("âŒ Error fetching appointment stats:",r),r;e=c==null?void 0:c.map(a=>({...a,appointment_date:a.scheduled_date}))}const s=new Date().toISOString().split("T")[0],t=new Date;t.setDate(t.getDate()-t.getDay());const n=new Date;n.setDate(n.getDate()+(6-n.getDay()));const l={total:(e==null?void 0:e.length)||0,pending:(e==null?void 0:e.filter(c=>c.status==="pending"||c.status==="scheduled").length)||0,confirmed:(e==null?void 0:e.filter(c=>c.status==="confirmed").length)||0,completed:(e==null?void 0:e.filter(c=>c.status==="completed").length)||0,cancelled:(e==null?void 0:e.filter(c=>c.status==="cancelled").length)||0,today:(e==null?void 0:e.filter(c=>(c.appointment_date||c.scheduled_date)===s).length)||0,thisWeek:(e==null?void 0:e.filter(c=>{const r=new Date(c.appointment_date||c.scheduled_date);return r>=t&&r<=n}).length)||0};return console.log("âœ… Appointment statistics calculated"),l}catch(e){throw console.error("âŒ Error fetching appointment stats:",e),e}}export{y as a,w as c,v as d,g as f,A as g,E as u};
