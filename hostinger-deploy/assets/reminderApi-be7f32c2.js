import{s as c}from"./index-61458a34.js";const m={async getReminders(r){console.log("ðŸ”µ [API] getReminders called with branchId:",r);let e=c.from("reminders").select("*").order("date",{ascending:!0}).order("time",{ascending:!0});r?(console.log("ðŸ”µ [API] Adding branch filter:",r),e=e.eq("branch_id",r)):console.warn("âš ï¸ [API] No branch ID provided, fetching all reminders");const{data:t,error:o}=await e;if(o)throw console.error("âŒ [API] Error fetching reminders:",o),o;console.log("âœ… [API] Reminders fetched (raw):",{count:(t==null?void 0:t.length)||0,data:t});const d=(t||[]).map(a=>({...a,relatedTo:a.related_to,assignedTo:a.assigned_to,notifyBefore:a.notify_before,createdBy:a.created_by,createdAt:a.created_at,updatedAt:a.updated_at,completedAt:a.completed_at,branchId:a.branch_id}));return console.log("âœ… [API] Reminders mapped:",{count:d.length,firstReminder:d[0]}),d},async getPendingReminders(r){let e=c.from("reminders").select("*").eq("status","pending").order("date",{ascending:!0}).order("time",{ascending:!0});r&&(e=e.eq("branch_id",r));const{data:t,error:o}=await e;if(o)throw console.error("Error fetching pending reminders:",o),o;return(t||[]).map(a=>({...a,relatedTo:a.related_to,assignedTo:a.assigned_to,notifyBefore:a.notify_before,createdBy:a.created_by,createdAt:a.created_at,updatedAt:a.updated_at,completedAt:a.completed_at,branchId:a.branch_id}))},async getTodayReminders(r){const e=new Date().toISOString().split("T")[0];let t=c.from("reminders").select("*").eq("date",e).eq("status","pending").order("time",{ascending:!0});r&&(t=t.eq("branch_id",r));const{data:o,error:d}=await t;if(d)throw console.error("Error fetching today reminders:",d),d;return(o||[]).map(n=>({...n,relatedTo:n.related_to,assignedTo:n.assigned_to,notifyBefore:n.notify_before,createdBy:n.created_by,createdAt:n.created_at,updatedAt:n.updated_at,completedAt:n.completed_at,branchId:n.branch_id}))},async createReminder(r,e,t){console.log("ðŸ”µ [API] createReminder called:",{input:r,userId:e,branchId:t});const o={title:r.title,description:r.description,date:r.date,time:r.time,priority:r.priority,category:r.category,status:"pending",created_by:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),branch_id:t,notify_before:r.notifyBefore};r.relatedTo!==void 0&&(o.related_to=r.relatedTo),r.assignedTo!==void 0&&(o.assigned_to=r.assignedTo),r.recurring!==void 0&&(o.recurring=r.recurring),console.log("ðŸ”µ [API] Inserting reminder:",o);const{data:d,error:a}=await c.from("reminders").insert([o]).select("*").single();if(console.log("ðŸ”µ [API] Supabase response:",{data:d,error:a}),a)throw console.error("âŒ [API] Error creating reminder:",{message:a.message,details:a.details,hint:a.hint,code:a.code,fullError:a}),new Error(`Failed to create reminder: ${a.message}`);if(!d){console.warn("âš ï¸ [API] No data returned after insert (likely RLS issue)"),console.log("ðŸ”µ [API] Attempting to fetch the reminder separately...");const{data:n,error:s}=await c.from("reminders").select("*").eq("created_by",e).eq("branch_id",t).eq("title",o.title).eq("date",o.date).eq("time",o.time).order("created_at",{ascending:!1}).limit(1).single();return s||!n?(console.error("âŒ [API] Could not fetch reminder after insert"),console.error("âŒ [API] This is likely a Row Level Security (RLS) issue"),console.error("âŒ [API] The reminder was created but cannot be read back"),console.error("âŒ [API] Please check your RLS policies or run:"),console.error("   ALTER TABLE reminders DISABLE ROW LEVEL SECURITY;"),{...o,id:"temporary-id-"+Date.now(),relatedTo:r.relatedTo,assignedTo:r.assignedTo,notifyBefore:r.notifyBefore}):(console.log("âœ… [API] Reminder fetched successfully:",n),{...n,relatedTo:n.related_to,assignedTo:n.assigned_to,notifyBefore:n.notify_before,createdBy:n.created_by,createdAt:n.created_at,updatedAt:n.updated_at,completedAt:n.completed_at,branchId:n.branch_id})}return console.log("âœ… [API] Reminder created successfully:",d),{...d,relatedTo:d.related_to,assignedTo:d.assigned_to,notifyBefore:d.notify_before,createdBy:d.created_by,createdAt:d.created_at,updatedAt:d.updated_at,completedAt:d.completed_at,branchId:d.branch_id}},async updateReminder(r,e){const t={...e,updated_at:new Date().toISOString()};e.relatedTo!==void 0&&(t.related_to=e.relatedTo,delete t.relatedTo),e.assignedTo!==void 0&&(t.assigned_to=e.assignedTo,delete t.assignedTo),e.notifyBefore!==void 0&&(t.notify_before=e.notifyBefore,delete t.notifyBefore),e.createdBy!==void 0&&(t.created_by=e.createdBy,delete t.createdBy),e.createdAt!==void 0&&(t.created_at=e.createdAt,delete t.createdAt),e.completedAt!==void 0&&(t.completed_at=e.completedAt,delete t.completedAt),e.branchId!==void 0&&(t.branch_id=e.branchId,delete t.branchId);const{data:o,error:d}=await c.from("reminders").update(t).eq("id",r).select().single();if(d)throw console.error("Error updating reminder:",d),d;return{...o,relatedTo:o.related_to,assignedTo:o.assigned_to,notifyBefore:o.notify_before,createdBy:o.created_by,createdAt:o.created_at,updatedAt:o.updated_at,completedAt:o.completed_at,branchId:o.branch_id}},async completeReminder(r){const{data:e,error:t}=await c.from("reminders").update({status:"completed",completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",r).select().single();if(t)throw console.error("Error completing reminder:",t),t;return{...e,relatedTo:e.related_to,assignedTo:e.assigned_to,notifyBefore:e.notify_before,createdBy:e.created_by,createdAt:e.created_at,updatedAt:e.updated_at,completedAt:e.completed_at,branchId:e.branch_id}},async deleteReminder(r){const{error:e}=await c.from("reminders").delete().eq("id",r);if(e)throw console.error("Error deleting reminder:",e),e},async getOverdueReminders(r){const e=new Date,t=e.toISOString().split("T")[0],o=e.toTimeString().split(" ")[0].slice(0,5);let d=c.from("reminders").select("*").eq("status","pending");r&&(d=d.eq("branch_id",r));const{data:a,error:n}=await d;if(n)throw console.error("Error fetching overdue reminders:",n),n;return(a||[]).filter(i=>{const l=i.date,f=i.time;return l<t||l===t&&f<o}).map(i=>({...i,relatedTo:i.related_to,assignedTo:i.assigned_to,notifyBefore:i.notify_before,createdBy:i.created_by,createdAt:i.created_at,updatedAt:i.updated_at,completedAt:i.completed_at,branchId:i.branch_id}))}};export{m as r};
