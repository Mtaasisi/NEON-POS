import{u as Ne,b as ve,y as xe,a as we,a4 as ne,a5 as Z,X as _e,j as e,s as K}from"./index-61458a34.js";import{r as c,b as Se}from"./vendor-36d2c7c1.js";import{u as Pe,S as Ce}from"./useSuccessModal-081786c4.js";import{B as De}from"./BackButton-02a80e74.js";import{n as S,R as ke,aE as re,N as ce,v as Ie,A as ue,r as Y,l as Fe,q as ee,m as ge,a5 as Te,bN as de,Y as Me,X as J,ay as Ae,e as ie,U as he,d as oe,af as Le,aA as be,a3 as pe,u as ze,al as me,a6 as fe}from"./ui-28e30067.js";import{T as Re}from"./SkeletonLoaders-da70324a.js";import{I as Ee}from"./InstallmentManagementModal-0b553ce1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./useBodyScrollLock-341c8b9f.js";import"./LoadingSpinner-251d9268.js";import"./CustomerTooltip-6a958832.js";const lt=()=>{const{currentUser:b}=Ne(),{customers:D}=ve(),{currentBranch:m}=xe();Pe();const{startLoading:r,completeLoading:F,failLoading:k}=we(),[y,t]=c.useState([]),[u,j]=c.useState(null),[v,d]=c.useState(!0),[i,N]=c.useState(!1),[p,x]=c.useState(!1),[L,X]=c.useState(!1),[V,H]=c.useState(!1),[n,o]=c.useState(!1),[w,E]=c.useState(!1),[z,l]=c.useState(null),[h,R]=c.useState("all"),[f,M]=c.useState(""),[I,P]=c.useState(""),[C,A]=c.useState(""),[s,_]=c.useState([]),[g,$]=c.useState(!1),T=c.useCallback(async(a=!1)=>{if(!(m!=null&&m.id)){d(!1);return}const q=r("Loading installment plans...");d(!0);try{a&&(console.log("ðŸ”„ [InstallmentsPage] Force refresh - clearing cache"),ne.clearInstallments(m.id));const O=a?null:ne.getInstallments(m.id);let B=[];O&&O.length>0?(console.log(`âš¡ [InstallmentsPage] Using ${O.length} cached installment plans - instant load!`),B=O,t(B),Z.getAllInstallmentPlans(m.id).then(U=>{console.log(`âœ… [InstallmentsPage] Background refresh completed (${U.length} plans)`),ne.saveInstallments(U,m.id),t(U)}).catch(U=>{console.warn("âš ï¸ [InstallmentsPage] Background refresh failed (non-critical):",U)})):(console.log("ðŸ“¡ [InstallmentsPage] No cache found, loading from database..."),B=await Z.getAllInstallmentPlans(m.id),console.log("Fetched plans:",B),t(B),ne.saveInstallments(B,m.id));const Q=await Z.getStatistics(m.id);console.log("Fetched stats:",Q),j(Q),F(q)}catch(O){console.error("Error fetching installment plans:",O),k(q,"Failed to load installment plans"),S.error("Failed to load installment plans")}finally{d(!1)}},[m==null?void 0:m.id,r,F,k]),W=c.useCallback(async()=>{try{console.log("Fetching payment accounts...");const a=await _e.getPaymentMethods();console.log("Fetched payment accounts:",a),_(a)}catch(a){console.error("Error fetching payment accounts:",a)}},[]);c.useEffect(()=>{console.log("InstallmentsPage mounted/branch changed:",m),T(),W()},[T,W,m]);const G=c.useMemo(()=>y.filter(a=>{var le;const q=h==="all"||a.status===h,O=f===""||a.plan_number.toLowerCase().includes(f.toLowerCase())||((le=a.customer)==null?void 0:le.name.toLowerCase().includes(f.toLowerCase())),B=new Date(a.created_at),Q=!I||B>=new Date(I),U=!C||B<=new Date(C+"T23:59:59");return q&&O&&Q&&U}),[y,h,f,I,C]),te=a=>({active:"bg-green-100 text-green-700",completed:"bg-gray-100 text-gray-700",defaulted:"bg-red-100 text-red-700",cancelled:"bg-orange-100 text-orange-700"})[a]||"bg-gray-100 text-gray-700",se=a=>a.status==="active"&&new Date(a.next_payment_date)<new Date,ae=a=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(a),ye=async a=>{const q=await Z.sendPaymentReminder(a,b==null?void 0:b.id);q.success?(S.success("Payment reminder sent successfully!"),T()):S.error(q.error||"Failed to send reminder")},je=async a=>{if(!confirm("Are you sure you want to cancel this installment plan?"))return;const q=await Z.cancelPlan(a);q.success?(S.success("Installment plan cancelled successfully"),T()):S.error(q.error||"Failed to cancel plan")};return v?e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:e.jsx(Re,{})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(De,{to:"/dashboard"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Installment Plans"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage customer payment plans"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:async()=>{const a=S.loading("Refreshing installment plans...");try{await T(!0),S.success("Installment plans refreshed!",{id:a})}catch{S.error("Failed to refresh plans",{id:a})}},disabled:v,className:"flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",title:"Refresh installment plans",children:[e.jsx(ke,{className:`w-4 h-4 ${v?"animate-spin":""}`}),"Refresh"]}),e.jsxs("button",{type:"button",onClick:()=>$(!0),className:"flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium bg-purple-600 text-white hover:bg-purple-700 transition-colors text-sm",children:[e.jsx(re,{size:18}),"Manage Installments"]}),e.jsxs("button",{onClick:()=>N(!0),className:"flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm",children:[e.jsx(ce,{size:18}),"New Installment Plan"]})]})]}),u&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:u.total}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Plans"})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-4 border border-green-200",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:u.active}),e.jsx("div",{className:"text-xs text-green-600",children:"Active"})]}),e.jsxs("div",{className:"bg-red-50 rounded-lg p-4 border border-red-200",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:u.overdue_count}),e.jsx("div",{className:"text-xs text-red-600",children:"Overdue"})]}),e.jsxs("div",{className:"bg-yellow-50 rounded-lg p-4 border border-yellow-200",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:u.due_this_week}),e.jsx("div",{className:"text-xs text-yellow-600",children:"Due This Week"})]}),e.jsxs("div",{className:"bg-purple-50 rounded-lg p-4 border border-purple-200",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:ae(u.total_balance_due)}),e.jsx("div",{className:"text-xs text-purple-600",children:"Balance Due"})]})]}),e.jsx("div",{className:"bg-white rounded-lg p-4 border border-gray-200 space-y-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:18}),e.jsx("input",{type:"text",placeholder:"Search plans, customers...",value:f,onChange:a=>M(a.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("select",{value:h,onChange:a=>R(a.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"defaulted",children:"Defaulted"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsx("input",{type:"date",value:I,onChange:a=>P(a.target.value),placeholder:"From Date",className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("input",{type:"date",value:C,onChange:a=>A(a.target.value),placeholder:"To Date",className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),(I||C||f||h!=="all")&&e.jsx("button",{onClick:()=>{P(""),A(""),M(""),R("all")},className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors text-sm font-medium",children:"Clear"})]})}),e.jsx("div",{className:"space-y-3",children:G.length===0?e.jsxs("div",{className:"bg-white rounded-lg p-12 text-center border border-gray-200",children:[e.jsx(re,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No installment plans found"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Create your first installment plan to get started"}),e.jsxs("button",{onClick:()=>N(!0),className:"mt-4 px-5 py-2.5 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm inline-flex items-center gap-2",children:[e.jsx(ce,{size:18}),"New Installment Plan"]})]}):G.map(a=>{var q;return e.jsx("div",{className:`bg-white rounded-lg p-5 border-2 transition-shadow ${se(a)?"border-red-300 bg-red-50/30":"border-gray-200 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsx("div",{className:"flex-1 space-y-2",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${se(a)?"bg-red-100":"bg-blue-100"}`,children:e.jsx(re,{className:`w-5 h-5 ${se(a)?"text-red-600":"text-blue-600"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:a.plan_number}),e.jsx("span",{className:`px-2.5 py-1 rounded-full text-xs font-semibold ${te(a.status)}`,children:a.status.toUpperCase()}),se(a)&&e.jsxs("span",{className:"px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700 flex items-center gap-1",children:[e.jsx(ue,{size:12}),"OVERDUE"]})]}),e.jsx("p",{className:"text-gray-700 font-medium mt-1",children:(q=a.customer)==null?void 0:q.name}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 mt-1",children:[e.jsxs("span",{children:[Number(a.installment_amount).toFixed(2)," TZS / ",a.payment_frequency]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[a.installments_paid," / ",a.number_of_installments," paid"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Y,{size:14}),"Next: ",new Date(a.next_payment_date).toLocaleDateString()]})]})]})]})}),e.jsxs("div",{className:"flex flex-col lg:items-end gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["Total: ",e.jsx("span",{className:"font-bold text-gray-900",children:ae(a.total_amount)})]}),e.jsxs("div",{className:"text-xs text-green-600",children:["Paid: ",e.jsx("span",{className:"font-bold",children:ae(a.total_paid)})]}),e.jsxs("div",{className:"text-xs text-red-600",children:["Balance: ",e.jsx("span",{className:"font-bold",children:ae(a.balance_due)})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-2",children:e.jsx("div",{className:"bg-green-600 h-2 rounded-full transition-all",style:{width:`${a.total_paid/a.total_amount*100}%`}})})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("button",{onClick:()=>{l(a),H(!0)},className:"px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(Fe,{size:14}),"Details"]}),(()=>{const O=Number(a.installments_paid||0),B=Number(a.number_of_installments||0),Q=O<B,U=Number(a.balance_due||0),le=!Q&&U<=0&&a.status==="completed";return(Q||U>0)&&!le&&a.status!=="cancelled"?e.jsx(e.Fragment,{children:e.jsxs("button",{onClick:()=>{l(a),x(!0)},className:"px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(ee,{size:14}),"Pay"]})}):null})(),a.status==="active"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{l(a),o(!0)},className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(ge,{size:14}),"Edit"]}),e.jsxs("button",{onClick:()=>ye(a.id),className:"px-3 py-1.5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(Te,{size:14}),"Remind"]})]}),e.jsxs("button",{onClick:()=>{l(a),X(!0)},className:"px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(Y,{size:14}),"Schedule"]}),e.jsxs("button",{onClick:()=>{l(a),E(!0)},className:"px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs font-medium flex items-center gap-1",children:[e.jsx(de,{size:14}),"History"]}),a.status==="active"&&e.jsx("button",{onClick:()=>je(a.id),className:"px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-xs font-medium",children:e.jsx(Me,{size:14})})]})]})]})},a.id)})}),i&&e.jsx(qe,{isOpen:i,onClose:()=>N(!1),onSuccess:()=>{N(!1),T()},customers:D,paymentAccounts:s,currentUser:b}),V&&z&&e.jsx(Be,{isOpen:V,onClose:()=>{H(!1),l(null)},plan:z}),n&&z&&e.jsx(Oe,{isOpen:n,onClose:()=>{o(!1),l(null)},onSuccess:()=>{o(!1),l(null),T(!0)},plan:z}),p&&z&&e.jsx($e,{isOpen:p,onClose:()=>{x(!1),l(null)},onSuccess:()=>{x(!1),l(null),T(!0)},plan:z,paymentAccounts:s,currentUser:b}),L&&z&&e.jsx(Ze,{isOpen:L,onClose:()=>{X(!1),l(null)},plan:z}),w&&z&&e.jsx(Ue,{isOpen:w,onClose:()=>{E(!1),l(null)},plan:z})]})},qe=({isOpen:b,onClose:D,onSuccess:m,customers:r,paymentAccounts:F,currentUser:k})=>{const{currentBranch:y}=xe(),[t,u]=c.useState([]),[j,v]=c.useState(!1),[d,i]=c.useState({customer_id:"",sale_id:"",total_amount:0,down_payment:0,number_of_installments:3,payment_frequency:"monthly",start_date:new Date().toISOString().split("T")[0],late_fee_amount:0,notes:"",payment_method:"cash",account_id:""}),[N,p]=c.useState(!1),x=n=>{const o=typeof n=="string"?parseFloat(n):n;return o%1===0?o.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}):o.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};c.useEffect(()=>(b?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[b]),c.useEffect(()=>{(async()=>{if(!b||!(y!=null&&y.id)){u([]);return}v(!0);try{const{data:o,error:w}=await K.from("lats_sales").select(`
            id,
            sale_number,
            customer_id,
            total_amount,
            payment_status,
            created_at,
            customers (name, phone)
          `).eq("branch_id",y.id).in("payment_status",["unpaid","partial"]).order("created_at",{ascending:!1}).limit(50);w?(console.error("Error fetching sales:",w),S.error("Failed to load sales"),u([])):u(o||[])}catch(o){console.error("Error fetching sales:",o),S.error("Failed to load sales"),u([])}finally{v(!1)}})()},[b,y==null?void 0:y.id]);const L=n=>{const o=t.find(w=>w.id===n);i(o?w=>({...w,sale_id:n,customer_id:o.customer_id,total_amount:o.total_amount,notes:`Linked to sale ${o.sale_number}`}):w=>({...w,sale_id:"",total_amount:0,notes:""}))},X=(d.total_amount||0)-(d.down_payment||0),V=X/(d.number_of_installments||1),H=async n=>{var z,l,h,R,f,M,I,P,C,A;if(n.preventDefault(),!d.customer_id||!d.account_id){S.error("Please fill in all required fields");return}const o=V*(d.number_of_installments||1),w=(d.down_payment||0)+o,E=Math.abs(w-(d.total_amount||0));if(E>.01){const s=_=>_.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});console.error("âŒ [InstallmentsPage] Payment balance mismatch:",{totalAmount:d.total_amount,downPayment:d.down_payment,totalInstallments:o,totalPayments:w,difference:E}),S.error(`Payment amounts don't balance!

Total Amount: ${s(d.total_amount||0)} TZS
Down Payment: ${s(d.down_payment||0)} TZS
Installments Total: ${s(o)} TZS
Total Payments: ${s(w)} TZS

Difference: ${s(E)} TZS

Please adjust the amounts so they equal the total amount.`);return}p(!0);try{const s=await Z.createInstallmentPlan(d,k==null?void 0:k.id,y==null?void 0:y.id);s.success?(m(),successModal.show("Installment plan has been created successfully!",{title:"Plan Created",actionButtons:[{label:"View Plans",onClick:()=>{},variant:"primary"}]})):S.error(s.error||"Failed to create installment plan")}catch(s){console.error("âŒ [InstallmentsPage] Error creating installment plan:",s),console.error("âŒ [InstallmentsPage] Error Details:",{message:s==null?void 0:s.message,code:s==null?void 0:s.code,status:s==null?void 0:s.status,name:s==null?void 0:s.name,formData:d});let _="An error occurred while creating the installment plan.",g="Error";(z=s==null?void 0:s.message)!=null&&z.includes("Failed to fetch")||(l=s==null?void 0:s.message)!=null&&l.includes("NetworkError")||(h=s==null?void 0:s.message)!=null&&h.includes("timeout")||(s==null?void 0:s.code)==="NETWORK_ERROR"?(g="Network Error",_="Unable to connect to the server. Please check your internet connection and try again."):(s==null?void 0:s.code)==="23505"||(R=s==null?void 0:s.message)!=null&&R.includes("duplicate")||(f=s==null?void 0:s.message)!=null&&f.includes("unique")?(g="Duplicate Entry",_="An installment plan with these details already exists. Please check and try again."):(s==null?void 0:s.code)==="23502"||(M=s==null?void 0:s.message)!=null&&M.includes("null value")||(I=s==null?void 0:s.message)!=null&&I.includes("required")?(g="Validation Error",_="Some required information is missing. Please check all fields and try again."):(s==null?void 0:s.code)==="42501"||(P=s==null?void 0:s.message)!=null&&P.includes("permission")||(C=s==null?void 0:s.message)!=null&&C.includes("unauthorized")?(g="Permission Denied",_="You do not have permission to create installment plans. Please contact your administrator."):(A=s==null?void 0:s.message)!=null&&A.includes("Payment amounts don't balance")?(g="Payment Balance Error",_=s.message):s!=null&&s.message&&(_=s.message),S.error(`${g}: ${_}`,{duration:6e3})}finally{p(!1)}};return b?Se.createPortal(e.jsx("div",{className:"fixed bg-black/60 flex items-center justify-center p-4 z-[100000]",style:{top:0,left:0,right:0,bottom:0},role:"dialog","aria-modal":"true","aria-labelledby":"installment-modal-title",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden relative",children:[e.jsx("button",{onClick:D,className:"absolute top-4 right-4 w-9 h-9 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors shadow-lg z-50",children:e.jsx(J,{className:"w-5 h-5"})}),e.jsx("div",{className:"p-8 bg-white border-b border-gray-200 flex-shrink-0",children:e.jsxs("div",{className:"grid grid-cols-[auto,1fr] gap-6 items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-lg",children:e.jsx(re,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"installment-modal-title",className:"text-2xl font-bold text-gray-900 mb-2",children:"Create Installment Plan"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Set up payment plan for customer"})]})]})}),e.jsxs("form",{onSubmit:H,className:"flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-6 space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 p-5 rounded-xl border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ae,{className:"w-5 h-5 text-blue-600"}),e.jsx("label",{className:"block text-sm font-bold text-blue-900",children:"Link to Existing Sale (Optional)"})]}),j?e.jsxs("div",{className:"w-full px-4 py-3 border-2 border-blue-300 rounded-xl bg-white flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Loading sales..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:d.sale_id,onChange:n=>L(n.target.value),className:"w-full px-4 py-3 border-2 border-blue-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-white font-medium",children:[e.jsx("option",{value:"",children:"-- Create New Installment (No Sale Link) --"}),t.length>0?t.map(n=>{var o;return e.jsxs("option",{value:n.id,children:[n.sale_number," - ",((o=n.customers)==null?void 0:o.name)||"Unknown Customer"," - ",x(n.total_amount)," TZS (",n.payment_status,")"]},n.id)}):e.jsx("option",{value:"",disabled:!0,children:"No unpaid or partial sales found"})]}),t.length===0&&!j&&e.jsxs("p",{className:"text-xs text-orange-600 mt-2 flex items-center gap-1",children:[e.jsx(ie,{className:"w-3 h-3"}),"No unpaid or partial sales available to link"]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Customer ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:d.customer_id,onChange:n=>i(o=>({...o,customer_id:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,disabled:!!d.sale_id,children:[e.jsx("option",{value:"",children:"Select Customer"}),r.map(n=>e.jsxs("option",{value:n.id,children:[n.name," - ",n.phone]},n.id))]})]}),d.sale_id&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx(oe,{className:"w-3 h-3"}),"Auto-selected from linked sale"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Total Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:x(d.total_amount||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),w=parseFloat(o)||0;i(E=>({...E,total_amount:w}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white disabled:bg-gray-100 disabled:cursor-not-allowed",required:!0,disabled:!!d.sale_id})]}),d.sale_id&&e.jsxs("p",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx(oe,{className:"w-3 h-3"}),"Auto-populated from linked sale"]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Down Payment ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",value:x(d.down_payment||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),w=parseFloat(o)||0;i(E=>({...E,down_payment:w}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white",required:!0})]})]})]}),e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border-2 border-blue-200 shadow-sm",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Le,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-0.5",children:"Amount to Finance"}),e.jsxs("p",{className:"text-lg font-bold text-blue-900",children:[x(X)," TZS"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Y,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-0.5",children:"Per Installment"}),e.jsxs("p",{className:"text-lg font-bold text-emerald-900",children:[x(V)," TZS"]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Number of Installments ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",value:d.number_of_installments,onChange:n=>i(o=>({...o,number_of_installments:parseInt(n.target.value)||1})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-900 text-lg font-bold bg-white",min:"1",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Frequency ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.payment_frequency,onChange:n=>i(o=>({...o,payment_frequency:n.target.value})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"bi_weekly",children:"Bi-Weekly"}),e.jsx("option",{value:"monthly",children:"Monthly"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Start Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"date",value:d.start_date,onChange:n=>i(o=>({...o,start_date:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Late Fee Amount"}),e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-orange-400"}),e.jsx("input",{type:"text",value:x(d.late_fee_amount||0),onChange:n=>{const o=n.target.value.replace(/,/g,""),w=parseFloat(o)||0;i(E=>({...E,late_fee_amount:w}))},className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 text-gray-900 font-medium bg-white"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.payment_method,onChange:n=>i(o=>({...o,payment_method:n.target.value})),className:"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"card",children:"Card"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:["Payment Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:d.account_id,onChange:n=>i(o=>({...o,account_id:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white",required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),F.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-2",children:"Notes"}),e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-4 top-4 w-5 h-5 text-gray-400"}),e.jsx("textarea",{value:d.notes,onChange:n=>i(o=>({...o,notes:n.target.value})),className:"w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-medium bg-white resize-none",placeholder:"Plan details...",rows:3})]})]})]}),e.jsx("div",{className:"p-6 pt-4 border-t border-gray-200 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:D,className:"flex-1 px-6 py-3.5 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all shadow-sm",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:N||!d.customer_id||!d.account_id,className:"flex-1 px-6 py-3.5 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl text-lg",children:N?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Creating..."]}):"Create Installment Plan"})]})})]})]})}),document.body):null},$e=({isOpen:b,onClose:D,onSuccess:m,plan:r,paymentAccounts:F,currentUser:k})=>{var N;const y=()=>{const p=Number(r.installment_amount||0),x=Number(r.balance_due||0);return x>0&&x<p?Number(x.toFixed(2)):Number(p.toFixed(2))},t=y(),[u,j]=c.useState({installment_plan_id:r.id,customer_id:r.customer_id,amount:t,payment_method:"cash",account_id:"",reference_number:"",notes:""}),[v,d]=c.useState(!1);c.useEffect(()=>{if(b){const p=y();console.log("ðŸ’° [Installment Payment Modal] Setting payment amount:",{planId:r.id,planNumber:r.plan_number,installmentAmount:r.installment_amount,balanceDue:r.balance_due,calculatedPaymentAmount:p}),j({installment_plan_id:r.id,customer_id:r.customer_id,amount:p,payment_method:"cash",account_id:"",reference_number:"",notes:""})}},[b,r.id,r.customer_id,r.installment_amount,r.balance_due]);const i=async p=>{if(p.preventDefault(),!u.account_id){S.error("Please select a payment account");return}d(!0);try{const x=await Z.recordPayment(u,k==null?void 0:k.id);x.success?(S.success("Payment recorded successfully!"),x.planCompleted?setTimeout(()=>{m()},500):m()):S.error(x.error||"Failed to record payment")}catch(x){S.error(x.message||"An error occurred")}finally{d(!1)}};return b?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ee,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Record Payment"}),e.jsx("p",{className:"text-sm text-gray-600",children:r.plan_number})]})]}),e.jsx("button",{onClick:D,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(J,{size:20})})]}),e.jsx("div",{className:"p-6 bg-gray-50 border-b border-gray-200",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Customer:"}),e.jsx("span",{className:"font-medium text-gray-900",children:(N=r.customer)==null?void 0:N.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Installments Paid:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[r.installments_paid," / ",r.number_of_installments]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Remaining Balance:"}),e.jsx("span",{className:"font-bold text-red-600",children:r.balance_due.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]}),e.jsxs("div",{className:"flex justify-between border-t border-gray-300 pt-2 mt-2",children:[e.jsx("span",{className:"text-gray-600",children:"Calculated Installment Amount:"}),e.jsxs("span",{className:"font-bold text-blue-600",children:[Number(r.installment_amount).toFixed(2)," TZS"]})]}),r.balance_due>0&&r.balance_due<r.installment_amount&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ie,{className:"w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs font-semibold text-yellow-800",children:"Final Payment"}),e.jsxs("p",{className:"text-xs text-yellow-700 mt-1",children:["This is the last payment. Amount set to remaining balance: ",e.jsx("strong",{children:r.balance_due.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})})]})]})]})})]})}),e.jsxs("form",{onSubmit:i,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"relative",children:e.jsx("input",{type:"number",value:u.amount||"",onChange:p=>j(x=>({...x,amount:parseFloat(p.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter payment amount",min:"0",max:r.balance_due,step:"0.01",required:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:u.payment_method,onChange:p=>j(x=>({...x,payment_method:p.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"card",children:"Card"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:u.account_id,onChange:p=>j(x=>({...x,account_id:p.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),F.map(p=>e.jsx("option",{value:p.id,children:p.name},p.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),e.jsx("input",{type:"text",value:u.reference_number,onChange:p=>j(x=>({...x,reference_number:p.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Transaction reference"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:u.notes,onChange:p=>j(x=>({...x,notes:p.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Payment notes...",rows:2})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:D,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:v,className:"flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Recording...":"Record Payment"})]})]})]})}):null},Ze=({isOpen:b,onClose:D,plan:m})=>{var t;const[r,F]=c.useState([]),[k,y]=c.useState(!0);return c.useEffect(()=>{b&&(async()=>{y(!0);const j=await Z.getPaymentSchedule(m.id);F(j),y(!1)})()},[b,m.id]),b?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(Y,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Payment Schedule"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[m.plan_number," - ",(t=m.customer)==null?void 0:t.name]})]})]}),e.jsx("button",{onClick:D,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(J,{size:20})})]}),e.jsx("div",{className:"p-6",children:k?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Loading schedule..."})]}):e.jsx("div",{className:"space-y-2",children:r.map(u=>e.jsx("div",{className:`p-4 rounded-lg border-2 ${u.status==="paid"?"bg-green-50 border-green-200":u.status==="overdue"?"bg-red-50 border-red-200":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:`w-10 h-10 rounded-full flex items-center justify-center font-bold ${u.status==="paid"?"bg-green-100 text-green-700":u.status==="overdue"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"}`,children:["#",u.installment_number]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:["Due: ",new Date(u.due_date).toLocaleDateString()]}),u.paid_date&&e.jsxs("div",{className:"text-xs text-gray-600",children:["Paid: ",new Date(u.paid_date).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-bold text-gray-900",children:u.amount.toLocaleString("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0})}),e.jsx("div",{className:`text-xs font-semibold uppercase ${u.status==="paid"?"text-green-600":u.status==="overdue"?"text-red-600":"text-gray-600"}`,children:u.status})]})]})},u.installment_number))})}),e.jsx("div",{className:"p-6 border-t border-gray-200",children:e.jsx("button",{onClick:D,className:"w-full px-4 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})})]})}):null},Be=({isOpen:b,onClose:D,plan:m})=>{var H,n,o,w,E,z;const[r,F]=c.useState([]),[k,y]=c.useState(!0),[t,u]=c.useState(m),[j,v]=c.useState([]),[d,i]=c.useState(null),[N,p]=c.useState(null);if(c.useEffect(()=>{(async()=>{var R;if(!b||!m.id)return;console.log("ðŸ” [Details Modal] Fetching plan details for:",m.id),y(!0);const h=await Z.getInstallmentPlanById(m.id);if(h){if(console.log("âœ… [Details Modal] Loaded plan:",{planNumber:h.plan_number,installmentsPaid:h.installments_paid,amountPaid:h.amount_paid,balanceDue:h.balance_due,paymentsCount:((R=h.payments)==null?void 0:R.length)||0}),u(h),F(h.payments||[]),h.sale_id){const{data:f}=await K.from("lats_sale_items").select("*").eq("sale_id",h.sale_id);if(f&&f.length>0){const M=[...new Set(f.map(g=>g.product_id).filter(Boolean))],I=[...new Set(f.map(g=>g.variant_id).filter(Boolean))],[P,C]=await Promise.all([M.length>0?K.from("lats_products").select("id, name, sku").in("id",M):{data:[]},I.length>0?K.from("lats_product_variants").select("id, name, variant_name, sku").in("id",I):{data:[]}]),A=new Map((P.data||[]).map(g=>[g.id,g])),s=new Map((C.data||[]).map(g=>[g.id,{...g,name:g.name||g.variant_name||"Unnamed"}]));if(M.length>0){const{data:g}=await K.from("product_images").select("id, product_id, image_url, thumbnail_url, is_primary").in("product_id",M).order("is_primary",{ascending:!1});g&&g.forEach($=>{const T=A.get($.product_id);if(T){T.images||(T.images=[]);const W={id:$.id,url:$.thumbnail_url||$.image_url,thumbnailUrl:$.thumbnail_url,isPrimary:$.is_primary||!1};$.is_primary?T.images.unshift(W):T.images.push(W)}})}const _=f.map(g=>({...g,lats_products:A.get(g.product_id),lats_product_variants:s.get(g.variant_id)}));v(_)}}if(h.branch_id){const{data:f}=await K.from("store_locations").select("id, name, address").eq("id",h.branch_id).single();f&&i(f)}if(h.created_by){const{data:f}=await K.from("users").select("id, full_name, email").eq("id",h.created_by).single();f&&p(f)}}else console.warn("âš ï¸ [Details Modal] Failed to load plan");y(!1)})()},[b,m.id,m.updated_at]),!b)return null;const x=l=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(l),L=l=>new Date(l).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),V=(()=>{const l=[],R=((P,C,A)=>{const s=P-C,_=C>0?A-1:A;if(_<=0)return[];const g=[],$=s/_;let T=0;for(let G=0;G<_-1;G++){const te=Math.round($*100)/100;g.push(te),T+=te}const W=Math.round((s-T)*100)/100;return g.push(W),g})(t.total_amount,t.down_payment||0,t.number_of_installments),f=new Date(t.start_date);if(t.down_payment>0){const P=r.find(g=>(g.installment_number===1||g.installment_number===0)&&Math.abs(Number(g.amount)-t.down_payment)<.01),C=(t.total_paid||0)>=t.down_payment,A=P&&P.status==="paid"||C,s=new Date(f),_=!A&&new Date>s;l.push({installmentNumber:1,dueDate:s.toISOString(),amount:t.down_payment,status:A?"paid":_?"overdue":"pending",payment:P,daysOverdue:_?Math.floor((new Date().getTime()-s.getTime())/(1e3*60*60*24)):0})}const M=t.down_payment>0?t.number_of_installments-1:t.number_of_installments,I=t.down_payment>0?new Date(t.next_payment_date||t.start_date):new Date(t.start_date);for(let P=0;P<M;P++){const C=new Date(I);t.payment_frequency==="weekly"?C.setDate(I.getDate()+P*7):t.payment_frequency==="monthly"?C.setMonth(I.getMonth()+P):(t.payment_frequency==="bi_weekly"||t.payment_frequency==="bi-weekly")&&C.setDate(I.getDate()+P*14);const A=t.down_payment>0?P+2:P+1,s=r.find(T=>T.installment_number===A),_=s&&s.status==="paid",g=!_&&new Date>C,$=R[P]||t.installment_amount;l.push({installmentNumber:A,dueDate:C.toISOString(),amount:$,status:_?"paid":g?"overdue":"pending",payment:s,daysOverdue:g?Math.floor((new Date().getTime()-C.getTime())/(1e3*60*60*24)):0})}return l})();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-indigo-500 to-indigo-600",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white rounded-lg",children:e.jsx(pe,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:t.plan_number}),e.jsx("p",{className:"text-sm text-indigo-100",children:"Installment Plan Details"})]})]}),e.jsx("button",{onClick:D,className:"p-2 text-white hover:bg-white/20 rounded-lg transition-colors",children:e.jsx(J,{size:24})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-3",children:"Customer Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Name:"}),e.jsx("span",{className:"font-medium text-gray-900",children:(H=t.customer)==null?void 0:H.name})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Phone:"}),e.jsx("span",{className:"font-medium text-gray-900",children:(n=t.customer)==null?void 0:n.phone})]}),((o=t.customer)==null?void 0:o.email)&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Email:"}),e.jsx("span",{className:"font-medium text-gray-900",children:t.customer.email})]})]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border border-purple-200",children:[e.jsx("h4",{className:"text-sm font-semibold text-purple-900 mb-3",children:"Plan Status"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Status:"}),e.jsx("span",{className:`font-bold uppercase px-2 py-1 rounded text-xs ${t.status==="active"?"bg-green-100 text-green-700":t.status==="completed"?"bg-gray-100 text-gray-700":t.status==="defaulted"?"bg-red-100 text-red-700":"bg-orange-100 text-orange-700"}`,children:t.status})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Created:"}),e.jsx("span",{className:"font-medium text-gray-900",children:L(t.created_at)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Reminders Sent:"}),e.jsx("span",{className:"font-medium text-gray-900",children:t.reminder_count})]})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200",children:[e.jsx("h4",{className:"text-lg font-semibold text-green-900 mb-4",children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Amount"}),e.jsx("p",{className:"text-lg font-bold text-gray-900",children:x(t.total_amount)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Down Payment"}),e.jsx("p",{className:"text-lg font-bold text-blue-600",children:x(t.down_payment)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Paid"}),e.jsx("p",{className:"text-lg font-bold text-green-600",children:x(t.total_paid||0)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Balance Due"}),e.jsx("p",{className:"text-lg font-bold text-red-600",children:x(t.balance_due)})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-green-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Payment Progress"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:[((t.total_paid||0)/t.total_amount*100).toFixed(1),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:"bg-green-600 h-3 rounded-full transition-all",style:{width:`${(t.total_paid||0)/t.total_amount*100}%`}})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Installment Amount"}),e.jsx("p",{className:"text-xl font-bold text-gray-900",children:x(t.installment_amount)}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["per ",t.payment_frequency]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Installments"}),e.jsxs("p",{className:"text-xl font-bold text-gray-900",children:[t.installments_paid," / ",t.number_of_installments]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"paid"})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Next Payment"}),e.jsx("p",{className:"text-xl font-bold text-gray-900",children:t.next_payment_date?L(t.next_payment_date):"Completed"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"due date"})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50",children:e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(Y,{size:16,className:"text-indigo-600"}),"Installment Schedule"]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Due Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Paid On"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:V.map(l=>e.jsxs("tr",{className:`
                        ${l.status==="paid"?"bg-green-50":""}
                        ${l.status==="overdue"?"bg-red-50":""}
                        hover:bg-gray-50 transition-colors
                      `,children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:l.installmentNumber}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-900",children:[L(l.dueDate),l.status==="overdue"&&e.jsxs("span",{className:"ml-2 text-xs text-red-600",children:["(",l.daysOverdue," days late)"]})]}),e.jsx("td",{className:"px-4 py-3 text-sm font-semibold text-gray-900",children:x(l.amount)}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${l.status==="paid"?"bg-green-100 text-green-800":l.status==="overdue"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:l.status.toUpperCase()})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:l.payment?L(l.payment.payment_date):"-"})]},l.installmentNumber))})]})})]}),j.length>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50",children:e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(ze,{size:16,className:"text-blue-600"}),"Product Details ",((w=t.sale)==null?void 0:w.sale_number)&&e.jsxs("span",{className:"text-xs text-gray-600 ml-2",children:["(Sale: ",t.sale.sale_number,")"]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Product"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider",children:"SKU"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Qty"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Unit Price"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:j.map((l,h)=>{var R,f,M,I;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:((R=l.lats_products)==null?void 0:R.name)||"Unknown Product"}),((f=l.lats_product_variants)==null?void 0:f.name)&&e.jsx("div",{className:"text-xs text-gray-500",children:l.lats_product_variants.name})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((M=l.lats_product_variants)==null?void 0:M.sku)||((I=l.lats_products)==null?void 0:I.sku)||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right font-medium text-gray-900",children:l.quantity}),e.jsx("td",{className:"px-4 py-3 text-sm text-right text-gray-900",children:x(l.unit_price||l.price||0)}),e.jsx("td",{className:"px-4 py-3 text-sm text-right font-semibold text-gray-900",children:x(l.total_price||0)})]},l.id||h)})})]})})]}),(d||N)&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(be,{size:16,className:"text-purple-600"}),"Business Context"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[d&&e.jsxs("div",{className:"bg-purple-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Branch"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:d.name}),d.address&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:d.address})]}),N&&e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Created By"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:N.full_name}),N.email&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:N.email})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Important Dates"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600",children:"Start Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:L(t.start_date)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600",children:"End Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:L(t.end_date)})]}),t.completion_date&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600",children:"Completed On"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:L(t.completion_date)})]}),t.last_reminder_sent&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-600",children:"Last Reminder"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:L(t.last_reminder_sent)})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx(ie,{size:16,className:"text-orange-600"}),"Payment Terms"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-orange-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Late Fee Rate"}),e.jsx("p",{className:"text-lg font-bold text-orange-600",children:x(t.late_fee_amount||0)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"per missed payment"})]}),e.jsxs("div",{className:`p-3 rounded-lg ${t.late_fee_applied>0?"bg-red-50":"bg-gray-50"}`,children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Late Fees Applied"}),e.jsx("p",{className:`text-lg font-bold ${t.late_fee_applied>0?"text-red-600":"text-gray-500"}`,children:x(t.late_fee_applied||0)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"accumulated"})]}),e.jsxs("div",{className:`p-3 rounded-lg ${t.days_overdue>0?"bg-red-50":"bg-green-50"}`,children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Days Overdue"}),e.jsx("p",{className:`text-lg font-bold ${t.days_overdue>0?"text-red-600":"text-green-600"}`,children:t.days_overdue||0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.days_overdue>0?"action required":"on track"})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50",children:e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(me,{size:16,className:"text-yellow-600"}),"Activity & Reminders"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Total Reminders Sent"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"WhatsApp notifications to customer"})]}),e.jsx("span",{className:"text-2xl font-bold text-blue-600",children:t.reminder_count||0})]}),t.last_reminder_sent&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Last Reminder Sent"}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:L(t.last_reminder_sent)})]}),e.jsx(oe,{className:"text-blue-600",size:20})]}),t.terms_accepted&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-900",children:"Terms Accepted"}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:L(t.terms_accepted_date||t.created_at)})]}),e.jsx(oe,{className:"text-green-600",size:20})]}),!t.terms_accepted&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-900",children:"Terms Not Accepted"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Customer agreement pending"})]}),e.jsx(ie,{className:"text-red-600",size:20})]})]})]}),t.notes&&e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:[e.jsx("h4",{className:"text-sm font-semibold text-yellow-900 mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm text-gray-700",children:t.notes})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(de,{size:16}),"Recent Payments (",r.length,")"]})}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:k?e.jsx("div",{className:"p-8 text-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"})}):r.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"No payments recorded yet"}):e.jsx("div",{className:"divide-y divide-gray-200",children:r.map((l,h)=>e.jsx("div",{className:"p-4 hover:bg-gray-50",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:["Payment #",l.installment_number]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[L(l.payment_date)," â€¢ ",l.payment_method]}),l.reference_number&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ref: ",l.reference_number]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-lg font-bold text-green-600",children:x(l.amount)}),e.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-semibold rounded",children:l.status})]})]})},l.id||h))})})]})]}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[(()=>{const l=Number(t.installments_paid||0),h=Number(t.number_of_installments||0),R=l<h,f=Number(t.balance_due||0),M=!R&&f<=0&&t.status==="completed";return(R||f>0)&&!M&&t.status!=="cancelled"?e.jsxs("button",{onClick:()=>{D()},className:"flex-1 min-w-[200px] px-4 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(ee,{size:18}),"Record Payment"]}):null})(),t.status==="active"&&((E=t.customer)==null?void 0:E.phone)&&e.jsxs("button",{onClick:async()=>{try{await Z.sendPaymentReminder(t.id),S.success("Reminder sent successfully!");const l=await Z.getInstallmentPlanById(t.id);l&&u(l)}catch(l){S.error(l.message||"Failed to send reminder")}},className:"flex-1 min-w-[200px] px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(me,{size:18}),"Send Reminder"]}),e.jsxs("button",{onClick:()=>{window.print()},className:"px-4 py-2.5 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(fe,{size:18}),"Print"]}),((z=t.customer)==null?void 0:z.id)&&e.jsxs("button",{onClick:()=>{window.location.href=`/customers?id=${t.customer.id}`},className:"px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(he,{size:18}),"View Customer"]}),e.jsx("button",{onClick:D,className:"px-6 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})]})})]})})},Oe=({isOpen:b,onClose:D,onSuccess:m,plan:r})=>{const[F,k]=c.useState({late_fee_amount:r.late_fee_amount,notes:r.notes||"",status:r.status}),[y,t]=c.useState(!1),u=async j=>{j.preventDefault(),t(!0);try{const v=await Z.updateInstallmentPlan(r.id,F);if(v.success){S.success("Installment plan updated successfully!");const d=F.status!==r.status,i=F.status==="completed";d&&i?setTimeout(()=>{m()},500):m()}else S.error(v.error||"Failed to update installment plan")}catch(v){S.error(v.message||"An error occurred")}finally{t(!1)}};return b?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(ge,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Installment Plan"}),e.jsx("p",{className:"text-sm text-gray-600",children:r.plan_number})]})]}),e.jsx("button",{onClick:D,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(J,{size:20})})]}),e.jsxs("form",{onSubmit:u,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{value:F.status,onChange:j=>k(v=>({...v,status:j.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"defaulted",children:"Defaulted"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Late Fee Amount"}),e.jsx("input",{type:"number",value:F.late_fee_amount,onChange:j=>k(v=>({...v,late_fee_amount:parseFloat(j.target.value)||0})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:F.notes,onChange:j=>k(v=>({...v,notes:j.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Plan notes...",rows:3})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:D,className:"flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:y,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:y?"Updating...":"Update Plan"})]})]})]})}):null},Ue=({isOpen:b,onClose:D,plan:m})=>{var d;const[r,F]=c.useState([]),[k,y]=c.useState(!0);if(c.useEffect(()=>{(async()=>{if(!b||!m.id)return;y(!0);const N=await Z.getInstallmentPlanById(m.id);N!=null&&N.payments&&F(N.payments),y(!1)})()},[b,m.id]),!b)return null;const t=i=>new Intl.NumberFormat("en-TZ",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(i),u=i=>new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),j=r.reduce((i,N)=>i+Number(N.amount||0),0),v=()=>{window.print()};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-gray-100 rounded-lg",children:e.jsx(de,{className:"w-5 h-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Payment History"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[m.plan_number," - ",(d=m.customer)==null?void 0:d.name]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:v,className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Print",children:e.jsx(fe,{size:20})}),e.jsx("button",{onClick:D,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(J,{size:20})})]})]}),e.jsx("div",{className:"p-6 bg-gray-50 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Payments"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:r.length})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Total Paid"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:t(j)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-600 mb-1",children:"Balance"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:t(m.balance_due)})]})]})}),e.jsx("div",{className:"p-6",children:k?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading payment history..."})]}):r.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"No payments recorded yet"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Payment history will appear here"})]}):e.jsx("div",{className:"space-y-3",children:r.map((i,N)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-green-700 font-bold",children:i.installment_number===0?"DP":`#${i.installment_number}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:i.installment_number===0?"Down Payment":`Installment Payment ${i.installment_number}`}),e.jsx("p",{className:"text-xs text-gray-600",children:u(i.payment_date)})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xl font-bold text-green-600",children:t(i.amount)}),e.jsx("span",{className:`inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded ${i.status==="paid"?"bg-green-100 text-green-700":i.status==="late"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"}`,children:i.status})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Payment Method:"}),e.jsx("span",{className:"font-medium text-gray-900 ml-2",children:i.payment_method})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Due Date:"}),e.jsx("span",{className:"font-medium text-gray-900 ml-2",children:new Date(i.due_date).toLocaleDateString()})]}),i.reference_number&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-gray-600",children:"Reference:"}),e.jsx("span",{className:"font-medium text-gray-900 ml-2",children:i.reference_number})]}),i.late_fee>0&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-red-600",children:"Late Fee:"}),e.jsx("span",{className:"font-medium text-red-600 ml-2",children:t(i.late_fee)})]}),i.notes&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-gray-600",children:"Notes:"}),e.jsx("p",{className:"text-gray-700 mt-1 text-sm",children:i.notes})]})]})]},i.id||N))})}),e.jsx("div",{className:"p-6 border-t border-gray-200",children:e.jsx("button",{onClick:D,className:"w-full px-4 py-2.5 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors",children:"Close"})})]}),e.jsx(Ce,{...successModal.props}),e.jsx(Ee,{isOpen:showInstallmentManagementModal,onClose:()=>setShowInstallmentManagementModal(!1)})]})};export{lt as default};
