import{s as t}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";const j=async()=>{try{const a=localStorage.getItem("current_branch_id"),{data:e}=await t.from("lats_categories").select("id").eq("name","Trade-In Items").maybeSingle();if(e)return console.log("✅ Found existing Trade-In category:",e.id),e.id;const{data:i,error:o}=await t.from("lats_categories").insert({name:"Trade-In Items",description:"Devices acquired through trade-in transactions",branch_id:a,is_active:!0}).select("id").single();if(!o&&i)return console.log("✅ Created new Trade-In category:",i.id),i.id;console.warn("⚠️ Failed to create Trade-In category, using fallback:",o);const{data:r}=await t.from("lats_categories").select("id").limit(1).single();if(r)return console.log("✅ Using fallback category:",r.id),r.id;throw new Error("No categories available in database")}catch(a){console.error("❌ Error in getOrCreateTradeInCategory:",a);try{const{data:e}=await t.from("lats_categories").select("id").limit(1).single();if(e)return console.log("⚠️ Using emergency fallback category:",e.id),e.id}catch(e){console.error("❌ Cannot get any category:",e)}throw new Error("Failed to get or create category for trade-in")}},z=async a=>{var d,c,w,u,$,T,C,S,D,F,R;const{transaction:e,categoryId:i,locationId:o,needsRepair:r=!1,repairNotes:k,resalePrice:l}=a;try{const{data:s}=await t.auth.getUser(),g=localStorage.getItem("current_branch_id")||e.branch_id;let h=null;if((d=s==null?void 0:s.user)!=null&&d.id){const{data:n}=await t.from("profiles").select("role").eq("id",s.user.id).single();h=n==null?void 0:n.role}const x=h==="admin";if(!x&&e.status!=="completed"&&e.status!=="approved")throw console.error("❌ Cannot add non-completed/non-approved trade-in to inventory:",{transaction_id:e.id,transaction_number:e.transaction_number,current_status:e.status,user_role:h}),new Error(`Only completed or approved trade-in transactions can be added to inventory. Current status: ${e.status}. Please complete the transaction first in Trade-In Management.`);if(x&&e.status==="pending"&&console.log("✅ [ADMIN] Adding pending trade-in to inventory (admin override)"),e.device_imei){const{data:n}=await t.from("lats_product_variants").select("id, product_id, variant_attributes").filter("variant_attributes->>'imei'","eq",e.device_imei).maybeSingle();if(n)throw console.warn("⚠️ Duplicate IMEI detected:",e.device_imei),new Error(`Device with IMEI ${e.device_imei} already exists in inventory. Cannot add duplicate devices.`)}const I=`${e.device_name} - ${e.device_model} (Trade-In)`,N=`TI-${Date.now()}-${e.device_imei||"NOIMEI"}`,f=((c=e.customer)==null?void 0:c.name)||`${((w=e.customer)==null?void 0:w.first_name)||""} ${((u=e.customer)==null?void 0:u.last_name)||""}`.trim()||"Trade-In Customer";let b=null;try{const{data:n}=await t.from("lats_suppliers").select("id").eq("name",`Trade-In: ${f}`).maybeSingle();if(n)b=n.id;else{const{data:m}=await t.from("lats_suppliers").insert({name:`Trade-In: ${f}`,contact_person:f,phone:(($=e.customer)==null?void 0:$.phone)||((T=e.customer)==null?void 0:T.mobile),email:(C=e.customer)==null?void 0:C.email,is_active:!0,is_trade_in_customer:!0}).select("id").single();b=m==null?void 0:m.id}}catch(n){console.warn("⚠️ Could not create supplier entry for customer:",n)}const{data:p}=await t.from("lats_products").select("id, name, stock_quantity").eq("name",I).eq("branch_id",g).maybeSingle();let _;if(p)console.log("✅ Found existing product for this device model:",p.id),_=p,await t.from("lats_products").update({stock_quantity:(p.stock_quantity||0)+1,updated_at:new Date().toISOString()}).eq("id",p.id);else{console.log("✅ Creating new product for device model:",I);const{data:n,error:m}=await t.from("lats_products").insert({name:I,description:`Trade-in devices - ${e.device_name} ${e.device_model}`,sku:`TI-${e.device_name}-${e.device_model}`.replace(/\s+/g,"-"),category_id:i,branch_id:g,supplier_id:b,cost_price:e.final_trade_in_value,selling_price:l||e.final_trade_in_value*1.2,stock_quantity:1,min_stock_level:0,is_active:!r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(m)throw m;_=n}let v=null;if(e.device_imei){const{data:n}=await t.from("lats_product_variants").select("id, variant_name, is_parent, variant_type").eq("product_id",_.id).or("is_parent.eq.true,variant_type.eq.parent").is("parent_variant_id",null).limit(1);n&&n.length>0&&(v=n[0].id,console.log(`✅ Found existing parent variant to link trade-in device to: ${v}`))}const y={product_id:_.id,variant_name:e.device_imei?`IMEI: ${e.device_imei}`:`Unit ${Date.now()}`,sku:N,cost_price:e.final_trade_in_value,selling_price:l||e.final_trade_in_value*1.2,quantity:1,is_active:!r,variant_attributes:{imei:e.device_imei,serial_number:e.device_serial_number,condition:e.condition_rating,trade_in_transaction:e.id,transaction_number:e.transaction_number,original_owner:e.customer_id,customer_name:f,customer_phone:((S=e.customer)==null?void 0:S.phone)||((D=e.customer)==null?void 0:D.mobile),damage_items:e.damage_items,source:"trade-in"},branch_id:g};v&&e.device_imei&&(y.parent_variant_id=v,y.variant_type="imei_child",y.is_parent=!1,console.log(`✅ Creating trade-in device as child variant under parent ${v}`));const{data:q,error:M}=await t.from("lats_product_variants").insert(y).select().single();if(M)throw M;const E={new_product_id:_.id,new_variant_id:q.id,needs_repair:r,repair_status:r?"pending":"completed",ready_for_resale:!r,resale_price:l||e.final_trade_in_value*1.2};(e.status==="approved"||e.status==="pending")&&(E.status="completed",E.completed_at=new Date().toISOString(),console.log(`✅ Marking ${e.status} transaction as completed after adding to inventory`));const{error:O}=await t.from("lats_trade_in_transactions").update(E).eq("id",e.id);O&&console.warn("⚠️ Could not update trade-in transaction with product link:",O);try{await t.from("lats_stock_movements").insert({product_id:_.id,variant_id:q.id,branch_id:g,movement_type:"trade_in",quantity:1,reference_type:"trade_in_transaction",reference_id:e.id,notes:`Trade-in from customer: ${((F=e.customer)==null?void 0:F.name)||"Unknown"}`,created_by:(R=s==null?void 0:s.user)==null?void 0:R.id})}catch(n){console.warn("⚠️ Could not create stock movement record:",n)}return{success:!0,data:{product:_,variant:q}}}catch(s){return console.error("Error adding trade-in device to inventory:",s),{success:!1,error:s instanceof Error?s.message:"Failed to add device to inventory"}}},G=async(a,e,i,o)=>{try{const r={repair_status:e};if(i!==void 0&&(r.repair_cost=i),e==="completed"){r.ready_for_resale=!0;const{data:d}=await t.from("lats_trade_in_transactions").select("inventory_item_id, resale_price, final_trade_in_value").eq("id",a).single();if(d!=null&&d.inventory_item_id){await t.from("lats_inventory_items").update({status:"available",notes:`Repair completed. ${o||""}`}).eq("id",d.inventory_item_id);const{data:c}=await t.from("lats_inventory_items").select("product_id, variant_id").eq("id",d.inventory_item_id).single();if(c&&(await t.from("lats_products").update({is_active:!0}).eq("id",c.product_id),await t.from("lats_product_variants").update({is_active:!0}).eq("id",c.variant_id)),i&&d.final_trade_in_value){const u=(d.final_trade_in_value+i)*1.3;r.resale_price=u,c&&(await t.from("lats_products").update({selling_price:u}).eq("id",c.product_id),await t.from("lats_product_variants").update({selling_price:u}).eq("id",c.variant_id))}}}const{data:k,error:l}=await t.from("lats_trade_in_transactions").update(r).eq("id",a).select().single();if(l)throw l;return{success:!0,data:k}}catch(r){return console.error("Error updating repair status:",r),{success:!1,error:r instanceof Error?r.message:"Failed to update repair status"}}},H=async(a,e)=>{try{const{error:i}=await t.from("lats_trade_in_transactions").update({ready_for_resale:!0,resale_price:e}).eq("id",a);if(i)throw i;const{data:o}=await t.from("lats_trade_in_transactions").select("inventory_item_id").eq("id",a).single();if(o!=null&&o.inventory_item_id){const{data:r}=await t.from("lats_inventory_items").select("product_id, variant_id").eq("id",o.inventory_item_id).single();r&&(await t.from("lats_products").update({selling_price:e,is_active:!0}).eq("id",r.product_id),await t.from("lats_product_variants").update({selling_price:e,is_active:!0}).eq("id",r.variant_id),await t.from("lats_inventory_items").update({status:"available"}).eq("id",o.inventory_item_id))}return{success:!0}}catch(i){return console.error("Error marking device ready for resale:",i),{success:!1,error:i instanceof Error?i.message:"Failed to mark device ready for resale"}}},J=async a=>{try{let e=t.from("lats_trade_in_transactions").select(`
        *,
        customer:lats_customers(id, name, phone),
        inventory_item:lats_inventory_items(
          *,
          product:lats_products(id, name, sku, selling_price),
          variant:lats_product_variants(id, variant_name, selling_price)
        )
      `).not("inventory_item_id","is",null).order("created_at",{ascending:!1});(a==null?void 0:a.needsRepair)!==void 0&&(e=e.eq("needs_repair",a.needsRepair)),(a==null?void 0:a.readyForResale)!==void 0&&(e=e.eq("ready_for_resale",a.readyForResale)),a!=null&&a.branchId&&(e=e.eq("branch_id",a.branchId));const{data:i,error:o}=await e;if(o)throw o;return{success:!0,data:i}}catch(e){return console.error("Error fetching trade-in devices:",e),{success:!1,error:e instanceof Error?e.message:"Failed to fetch devices"}}};export{z as addTradeInDeviceToInventory,j as getOrCreateTradeInCategory,J as getTradeInDevicesInInventory,H as markDeviceReadyForResale,G as updateTradeInRepairStatus};
