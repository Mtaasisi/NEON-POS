import{j as l,s as m}from"./index-61458a34.js";import{a as q,u as C}from"./routing-eb8c310c.js";import{h as j,al as S,H as N,br as $,u as I,ap as B,U as F}from"./ui-28e30067.js";const O=({children:x,title:r,showBackButton:e=!1,showBottomNav:a=!0})=>{const t=q(),c=C(),n=[{icon:N,label:"Home",path:"/customer-portal/dashboard"},{icon:$,label:"Shop",path:"/customer-portal/products"},{icon:I,label:"Orders",path:"/customer-portal/orders"},{icon:B,label:"Loyalty",path:"/customer-portal/loyalty"},{icon:F,label:"Profile",path:"/customer-portal/profile"}],g=d=>c.pathname===d;return l.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[l.jsx("header",{className:"bg-white border-b border-gray-200 sticky top-0 z-50",children:l.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e?l.jsx("button",{onClick:()=>t(-1),className:"p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors",children:l.jsx(j,{size:20,className:"text-gray-700"})}):l.jsx("div",{className:"w-8"}),r&&l.jsx("h1",{className:"text-lg font-semibold text-gray-900 truncate flex-1 text-center",children:r}),l.jsxs("button",{onClick:()=>t("/customer-portal/notifications"),className:"p-2 -mr-2 hover:bg-gray-100 rounded-full transition-colors relative",children:[l.jsx(S,{size:20,className:"text-gray-700"}),l.jsx("span",{className:"absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"})]})]})}),l.jsx("main",{className:"flex-1 overflow-y-auto pb-20",children:x}),a&&l.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50",children:l.jsx("div",{className:"flex items-center justify-around px-2 py-2",children:n.map(d=>{const y=d.icon,p=g(d.path);return l.jsxs("button",{onClick:()=>t(d.path),className:`flex flex-col items-center justify-center flex-1 py-2 px-1 rounded-lg transition-colors ${p?"text-blue-600":"text-gray-600 hover:bg-gray-50"}`,children:[l.jsx(y,{size:22,strokeWidth:p?2.5:2}),l.jsx("span",{className:`text-xs mt-1 font-medium ${p?"font-semibold":""}`,children:d.label})]},d.path)})})})]})};class U{async getCustomerByPhone(r){try{const{data:e,error:a}=await m.from("customers").select("*").eq("phone",r).eq("is_active",!0).single();return a?(console.error("Error fetching customer by phone:",a),null):e}catch(e){return console.error("Error in getCustomerByPhone:",e),null}}async getCustomerById(r){try{const{data:e,error:a}=await m.from("customers").select("*").eq("id",r).single();return a?(console.error("Error fetching customer by ID:",a),null):e}catch(e){return console.error("Error in getCustomerById:",e),null}}async updateCustomerProfile(r,e){try{const{data:a,error:t}=await m.from("lats_customers").update({...e,updated_at:new Date().toISOString()}).eq("id",r).select().single();return t?(console.error("Error updating customer profile:",t),{success:!1,error:t.message}):{success:!0,data:a}}catch(a){return console.error("Error in updateCustomerProfile:",a),{success:!1,error:"Failed to update profile"}}}async getProducts(r){console.log("ðŸ›’ CustomerPortalService: Starting to fetch products..."),console.log("ðŸ“ Filters:",r);try{let e=m.from("lats_products").select(`
          id, 
          name, 
          description, 
          image_url, 
          created_at, 
          is_active,
          category_id,
          brand,
          category:lats_categories!category_id(name)
        `);e=e.eq("is_active",!0),r!=null&&r.search&&(e=e.or(`name.ilike.%${r.search}%,description.ilike.%${r.search}%`)),r!=null&&r.category&&(e=e.eq("category.name",r.category)),r!=null&&r.brand&&(e=e.eq("brand",r.brand)),e=e.order("created_at",{ascending:!1});const{data:a,error:t}=await e;if(t)throw console.error("âŒ Error fetching products:",t),console.error("Error details:",{message:t.message,details:t.details,hint:t.hint,code:t.code}),t;if(console.log(`âœ… Fetched ${(a==null?void 0:a.length)||0} products from lats_products table`),!a||a.length===0)return console.warn("âš ï¸  No products found in database"),[];const c=a.map(o=>o.id);console.log(`ðŸ” Fetching variants for ${c.length} products...`);let n=[];const{data:g,error:d}=await m.from("lats_product_variants").select("id, product_id, variant_name, selling_price, cost_price, quantity, is_parent, variant_type, parent_variant_id").in("product_id",c);d?console.error("âŒ Error fetching from lats_product_variants:",d):g&&g.length>0&&(n=g.filter(o=>!o.parent_variant_id||o.is_parent),console.log(`âœ… Fetched ${n.length} variants from lats_product_variants table`)),n.length===0&&console.warn("âš ï¸  No variants found - products will show without variants");const y=n.reduce((o,i)=>(o[i.product_id]||(o[i.product_id]=[]),o[i.product_id].push(i),o),{});console.log(`ðŸ“Š Grouped variants for ${Object.keys(y).length} products`),console.log(`ðŸ–¼ï¸  Fetching images for ${c.length} products...`);const{data:p,error:_}=await m.from("product_images").select("product_id, image_url, is_primary").in("product_id",c).order("is_primary",{ascending:!1});_&&console.warn("âš ï¸  Error fetching product images:",_);const b=(p||[]).reduce((o,i)=>(o[i.product_id]||(o[i.product_id]=[]),o[i.product_id].push(i.image_url),o),{});console.log(`âœ… Fetched images for ${Object.keys(b).length} products`);const h=a.map(o=>{var E;const i=y[o.id]||[],f=i.map(u=>u.unit_price||u.selling_price||0).filter(u=>u>0),s=f.length>0?Math.min(...f):0,v=i.reduce((u,k)=>u+(k.quantity||0),0),w=b[o.id]||[],P=w[0]||o.image_url||null;return{id:o.id,name:o.name,description:o.description,price:s,category:((E=o.category)==null?void 0:E.name)||"Uncategorized",brand:o.brand||"Generic",imageUrl:P,images:w.length>0?w:o.image_url?[o.image_url]:[],inStock:v>0,stockQuantity:v,specifications:{},variants:i.map(u=>({id:u.id,name:u.variant_name,price:u.selling_price||0,compareAtPrice:u.cost_price,inStock:(u.quantity||0)>0,stockQuantity:u.quantity||0})),rating:Math.random()*2+3,reviewCount:Math.floor(Math.random()*100)}});return console.log(`âœ… Successfully transformed ${h.length} products for customer portal`),console.log(`ðŸ“¦ Products with variants: ${h.filter(o=>o.variants&&o.variants.length>0).length}`),console.log(`ðŸ“¦ Products in stock: ${h.filter(o=>o.inStock).length}`),h}catch(e){throw console.error("âŒ CRITICAL ERROR in getProducts:",e),console.error("Error details:",{name:e==null?void 0:e.name,message:e==null?void 0:e.message,stack:e==null?void 0:e.stack}),e}}async getProductById(r){var e,a;console.log(`ðŸ” Fetching product by ID: ${r}`);try{const{data:t,error:c}=await m.from("lats_products").select(`
          id, 
          name, 
          description, 
          image_url, 
          created_at, 
          is_active,
          category_id,
          brand,
          category:lats_categories!category_id(name)
        `).eq("id",r).eq("is_active",!0).single();if(c)return console.error("âŒ Error fetching product:",c),null;if(!t)return console.warn("âš ï¸  Product not found"),null;console.log(`âœ… Found product: ${t.name}`);let n=[];const{data:g,error:d}=await m.from("lats_product_variants").select("id, variant_name, selling_price, cost_price, quantity, is_parent, parent_variant_id").eq("product_id",r);d?console.error("âŒ Error fetching variants:",d):g?(n=g.filter(s=>!s.parent_variant_id||s.is_parent),console.log(`âœ… Fetched ${n.length} variants from lats_product_variants`)):console.warn("âš ï¸  No variants found for this product"),console.log(`ðŸ–¼ï¸  Fetching images for product ${r}...`);const{data:y,error:p}=await m.from("product_images").select("image_url, is_primary").eq("product_id",r).order("is_primary",{ascending:!1});p&&console.warn("âš ï¸  Error fetching product images:",p);const _=(y||[]).map(s=>s.image_url),b=_[0]||t.image_url||null;console.log(`âœ… Found ${_.length} images for product`);const h=n.map(s=>s.selling_price||0).filter(s=>s>0),o=h.length>0?Math.min(...h):0,i=n.reduce((s,v)=>s+(v.quantity||0),0),f={id:t.id,name:t.name,description:t.description,price:o,category:((e=t.category)==null?void 0:e.name)||"Uncategorized",brand:t.brand||"Generic",imageUrl:b,images:_.length>0?_:t.image_url?[t.image_url]:[],inStock:i>0,stockQuantity:i,specifications:{},variants:n.map(s=>({id:s.id,name:s.variant_name,price:s.selling_price||0,compareAtPrice:s.cost_price,inStock:(s.quantity||0)>0,stockQuantity:s.quantity||0})),rating:Math.random()*2+3,reviewCount:Math.floor(Math.random()*100)};return console.log(`âœ… Product transformed: ${f.name}, ${((a=f.variants)==null?void 0:a.length)||0} variants, in stock: ${f.inStock}`),f}catch(t){return console.error("âŒ Error in getProductById:",t),null}}async getCustomerOrders(r){try{const{data:e,error:a}=await m.from("lats_sales").select(`
          id,
          sale_number,
          customer_id,
          total_amount,
          payment_method,
          status,
          created_at,
          lats_sale_items (
            id,
            product_name,
            variant_name,
            quantity,
            unit_price,
            total_price,
            image_url
          )
        `).eq("customer_id",r).order("created_at",{ascending:!1});return a?(console.error("Error fetching customer orders:",a),[]):(e||[]).map(c=>({id:c.id,orderNumber:c.sale_number,date:c.created_at,totalAmount:c.total_amount,status:this.mapSaleStatus(c.status),paymentMethod:this.getPaymentMethodDisplay(c.payment_method),items:(c.lats_sale_items||[]).map(n=>({id:n.id,productName:n.product_name,variantName:n.variant_name,quantity:n.quantity,unitPrice:n.unit_price,totalPrice:n.total_price,imageUrl:n.image_url}))}))}catch(e){return console.error("Error in getCustomerOrders:",e),[]}}async getCustomerDevices(r){try{const{data:e,error:a}=await m.from("devices").select("*").eq("customer_id",r).order("intake_date",{ascending:!1});return a?(console.error("Error fetching customer devices:",a),[]):e||[]}catch(e){return console.error("Error in getCustomerDevices:",e),[]}}async getCategories(){try{const{data:r,error:e}=await m.from("lats_products").select("category").eq("is_active",!0).not("category","is",null);return e?(console.error("Error fetching categories:",e),[]):[...new Set((r||[]).map(t=>t.category).filter(Boolean))]}catch(r){return console.error("Error in getCategories:",r),[]}}async getBrands(){try{const{data:r,error:e}=await m.from("lats_products").select("brand").eq("is_active",!0).not("brand","is",null);return e?(console.error("Error fetching brands:",e),[]):[...new Set((r||[]).map(t=>t.brand).filter(Boolean))]}catch(r){return console.error("Error in getBrands:",r),[]}}mapSaleStatus(r){switch(r==null?void 0:r.toLowerCase()){case"completed":return"completed";case"pending":return"pending";case"processing":return"processing";case"cancelled":return"cancelled";default:return"completed"}}getPaymentMethodDisplay(r){return typeof r=="string"?r:typeof r=="object"&&r!==null&&(r.method||r.type)||"Cash"}}const A=new U;export{O as M,A as c};
