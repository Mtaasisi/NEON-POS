import{j as t,s as z}from"./index-61458a34.js";import{r as l}from"./vendor-36d2c7c1.js";import{u as h,A as w,af as A,N as W,v as E,cI as P,bw as F,a9 as O,an as q,z as U}from"./ui-28e30067.js";import{u as X,a as H}from"./useMobileBranch-d96f1509.js";import{u as Q,a as V}from"./useResponsiveSize-eee1874a.js";import{R as D}from"./ResponsiveMobileWrapper-b44175a0.js";import{a as Y}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";const ie=()=>{const y=Y(),{currentBranch:r,loading:$,isDataShared:b}=X(),e=Q();V();const[x,L]=l.useState(""),[v,j]=l.useState(!1),[g,_]=l.useState("All"),[m,B]=l.useState("asc"),[c,u]=l.useState([]),[S,N]=l.useState(!0),[k,T]=l.useState({});l.useEffect(()=>{const s=async()=>{if(!$){N(!0);try{console.log("ðŸ” [MobileInventory] Fetching products for branch:",r==null?void 0:r.name);let i=z.from("lats_products").select("*, image_url").eq("is_active",!0).order("created_at",{ascending:!1});if(r){const n=b("products");console.log("ðŸª [MobileInventory] Branch filter:",{branchId:r.id,mode:r.data_isolation_mode,isShared:n}),i=H(i,r.id,r.data_isolation_mode,n)}const{data:o,error:p}=await i;if(p)throw console.error("Error fetching products:",p),p;if(!o){console.warn("No data returned from products query"),u([]);return}console.log(`âœ… [MobileInventory] Loaded ${o.length} products`);const d=o.map(n=>({id:n.id,name:n.name||"Unnamed Product",sku:n.sku||"N/A",category:n.category||"Uncategorized",stock:n.stock_quantity||0,price:n.selling_price||0,status:n.stock_quantity===0?"out-of-stock":n.min_stock_level&&n.stock_quantity<=n.min_stock_level?"low-stock":"in-stock",image:n.image_url||void 0}));console.log("ðŸ“¦ [MobileInventory] Transformed products:",d.length,"products"),console.log("ðŸ“¦ [MobileInventory] Products with image_url from lats_products:",d.filter(n=>n.image).length),u(d),o.length>0?I(o.map(n=>n.id)):console.log("âš ï¸ [MobileInventory] No products to fetch images for")}catch(i){console.error("Error fetching products:",i),U.error((i==null?void 0:i.message)||"Failed to load products"),u([])}finally{N(!1)}}};s();const a=()=>{console.log("ðŸ”„ [MobileInventory] Branch changed, reloading products..."),s()};return window.addEventListener("branchChanged",a),()=>{window.removeEventListener("branchChanged",a)}},[r,$,b]);const I=async s=>{try{console.log("ðŸ–¼ï¸ [MobileInventory] Fetching images for",s.length,"products");const{data:a,error:i}=await z.from("product_images").select("product_id, image_url, is_primary").in("product_id",s).eq("is_primary",!0);if(i){console.error("âŒ [MobileInventory] Error fetching product_images:",i);return}if(a&&a.length>0){const o=a.reduce((p,d)=>(d.image_url&&(p[d.product_id]=d.image_url),p),{});T(o),console.log("âœ… [MobileInventory] Loaded",a.length,"product images from product_images table"),console.log("ðŸ–¼ï¸ [MobileInventory] Image map:",o)}else console.log("âš ï¸ [MobileInventory] No images found in product_images table"),console.log("ðŸ’¡ [MobileInventory] Will use image_url from lats_products as fallback")}catch(a){console.error("âŒ [MobileInventory] Error loading product images:",a)}},M=["All",...Array.from(new Set(c.map(s=>s.category)))],f=c.filter(s=>{const a=s.name.toLowerCase().includes(x.toLowerCase())||s.sku.toLowerCase().includes(x.toLowerCase()),i=g==="All"||s.category===g;return a&&i}).sort((s,a)=>{const i=s.name.localeCompare(a.name);return m==="asc"?i:-i}),C=[{label:"Total Products",value:c.length,icon:h,color:"blue"},{label:"Low Stock",value:c.filter(s=>s.status==="low-stock").length,icon:w,color:"yellow"},{label:"Out of Stock",value:c.filter(s=>s.status==="out-of-stock").length,icon:w,color:"red"},{label:"Total Value",value:`TSh ${(c.reduce((s,a)=>s+a.price*a.stock,0)/1e6).toFixed(1)}M`,icon:A,color:"green"}],R=()=>{B(m==="asc"?"desc":"asc")};return t.jsx(D,{children:t.jsxs("div",{className:"flex flex-col h-full bg-white",children:[t.jsxs("div",{style:{paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`,paddingTop:`${e.spacing3}px`,paddingBottom:`${e.spacing2}px`},children:[t.jsxs("div",{className:"flex items-center justify-between",style:{marginBottom:`${e.spacing3}px`},children:[t.jsx("h1",{style:{fontSize:`${e.text3xl}px`},className:"font-bold text-black tracking-tight",children:"Inventory"}),t.jsx("button",{onClick:()=>y("/mobile/inventory/add"),className:"flex items-center justify-center text-blue-500 hover:text-blue-600 active:text-blue-700 transition-colors flex-shrink-0",style:{padding:`${e.spacing1}px`},"aria-label":"Add product",children:t.jsx(W,{size:e.iconSizeLg,strokeWidth:2.5})})]}),t.jsxs("div",{className:"relative",style:{marginBottom:`${e.spacing2}px`},children:[t.jsx(E,{className:"absolute text-gray-400",size:e.iconSize,strokeWidth:2,style:{left:`${e.spacing3}px`,top:"50%",transform:"translateY(-50%)"}}),t.jsx("input",{type:"text",placeholder:"Search products",value:x,onChange:s=>L(s.target.value),className:"w-full bg-[#f2f2f7] border-0 focus:outline-none focus:ring-0 text-gray-900 placeholder-gray-400 font-light",style:{WebkitAppearance:"none",paddingLeft:`${e.spacing3+e.iconSize+e.spacing2}px`,paddingRight:`${e.spacing4}px`,paddingTop:`${e.spacing2}px`,paddingBottom:`${e.spacing2}px`,borderRadius:`${e.radiusLg}px`,fontSize:`${e.textBase}px`}})]}),t.jsxs("div",{className:"flex items-center justify-between",style:{paddingTop:`${e.spacing2}px`,paddingBottom:`${e.spacing2}px`,paddingLeft:`${e.spacing1}px`,paddingRight:`${e.spacing1}px`},children:[t.jsxs("div",{className:"flex items-center",style:{gap:`${e.spacing2}px`},children:[t.jsx(P,{size:e.iconSize,className:"text-blue-500",strokeWidth:2.5}),t.jsx("span",{style:{fontSize:`${e.textBase}px`},className:"text-gray-900 font-normal",children:"Sorted alphabetically"})]}),t.jsx("button",{onClick:R,className:"hover:opacity-70 transition-opacity",style:{padding:`${e.spacing1}px`},"aria-label":"Toggle sort order",children:t.jsx(F,{size:e.iconSize,strokeWidth:2.5,className:`text-blue-500 transition-transform ${m==="desc"?"rotate-180":""}`})})]}),t.jsx("div",{style:{paddingTop:`${e.spacing2}px`,paddingBottom:`${e.spacing2}px`},children:t.jsxs("button",{onClick:()=>j(!v),className:"flex items-center text-blue-500 font-medium",style:{gap:`${e.spacing2}px`,fontSize:`${e.textBase}px`},children:[t.jsx(O,{size:e.iconSize,strokeWidth:2.5}),t.jsx("span",{children:"Filter by Category"}),g!=="All"&&t.jsx("span",{className:"bg-blue-100 text-blue-700 rounded-full font-semibold",style:{paddingLeft:`${e.spacing2}px`,paddingRight:`${e.spacing2}px`,paddingTop:`${e.spacing1}px`,paddingBottom:`${e.spacing1}px`,fontSize:`${e.textSm}px`},children:g})]})}),v&&t.jsx("div",{className:"flex overflow-x-auto scrollbar-hide",style:{gap:`${e.spacing2}px`,paddingBottom:`${e.spacing3}px`,paddingTop:`${e.spacing1}px`,marginLeft:`-${e.spacing4}px`,marginRight:`-${e.spacing4}px`,paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`},children:M.map(s=>t.jsx("button",{onClick:()=>{_(s),j(!1)},className:`whitespace-nowrap transition-colors font-medium ${g===s?"bg-blue-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,style:{paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`,paddingTop:`${e.spacing2}px`,paddingBottom:`${e.spacing2}px`,borderRadius:`${e.radiusFull}px`,fontSize:`${e.textSm}px`},children:s},s))})]}),t.jsx("div",{className:"bg-gray-50 border-y border-gray-200",style:{paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`,paddingTop:`${e.spacing3}px`,paddingBottom:`${e.spacing3}px`},children:t.jsx("div",{className:"grid grid-cols-4 text-center",style:{gap:`${e.spacing2}px`},children:C.map((s,a)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:`${e.textLg}px`},className:"font-bold text-gray-900",children:s.value}),t.jsx("div",{style:{fontSize:`${e.textXs}px`,marginTop:`${e.spacing1}px`},className:"text-gray-500",children:s.label})]},a))})}),S&&t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full border-b-2 border-blue-500 mx-auto",style:{width:`${e.spacing10}px`,height:`${e.spacing10}px`,marginBottom:`${e.spacing3}px`}}),t.jsx("p",{style:{fontSize:`${e.textBase}px`},className:"text-gray-500",children:"Loading products..."})]})}),!S&&t.jsxs("div",{className:"flex-1 overflow-y-auto",style:{paddingBottom:`${e.spacing8+e.buttonHeight}px`},children:[f.map((s,a)=>t.jsxs("div",{onClick:()=>y(`/mobile/inventory/${s.id}`),className:"flex items-center justify-between border-b border-[#e5e5ea] hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors",style:{paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`,paddingTop:`${e.spacing3}px`,paddingBottom:`${e.spacing3}px`,borderBottomWidth:a===f.length-1?"0":"0.5px"},children:[t.jsxs("div",{className:"flex items-center flex-1 min-w-0",style:{gap:`${e.spacing3}px`},children:[t.jsx("div",{className:"flex-shrink-0 overflow-hidden bg-gray-100 flex items-center justify-center",style:{width:`${e.avatarSize}px`,height:`${e.avatarSize}px`,borderRadius:`${e.radiusLg}px`},children:k[s.id]||s.image?t.jsx("img",{src:k[s.id]||s.image,alt:s.name,className:"w-full h-full object-cover",onError:i=>{i.currentTarget.style.display="none";const o=i.currentTarget.parentElement;o&&(o.innerHTML=`<div class="text-gray-400 flex items-center justify-center w-full h-full"><svg width="${e.iconSizeLg}" height="${e.iconSizeLg}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg></div>`)}}):t.jsx(h,{size:e.iconSizeLg,className:"text-gray-400",strokeWidth:1.5})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center",style:{gap:`${e.spacing2}px`,marginBottom:`${e.spacing1}px`},children:[t.jsx("span",{style:{fontSize:`${e.textLg}px`},className:"text-black font-normal truncate",children:s.name}),s.status==="low-stock"&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-yellow-100 text-yellow-700 font-semibold flex-shrink-0",style:{paddingLeft:`${e.spacing2}px`,paddingRight:`${e.spacing2}px`,paddingTop:`${e.spacing1}px`,paddingBottom:`${e.spacing1}px`,fontSize:`${e.textXs}px`},children:"LOW"}),s.status==="out-of-stock"&&t.jsx("span",{className:"inline-flex items-center rounded-full bg-red-100 text-red-700 font-semibold flex-shrink-0",style:{paddingLeft:`${e.spacing2}px`,paddingRight:`${e.spacing2}px`,paddingTop:`${e.spacing1}px`,paddingBottom:`${e.spacing1}px`,fontSize:`${e.textXs}px`},children:"OUT"})]}),t.jsxs("div",{className:"flex items-center text-gray-500",style:{gap:`${e.spacing2}px`,fontSize:`${e.textSm}px`},children:[t.jsx("span",{className:"font-mono",children:s.sku}),t.jsx("span",{children:"â€¢"}),t.jsxs("span",{children:[s.stock," units"]})]})]})]}),t.jsxs("div",{className:"flex items-center flex-shrink-0",style:{gap:`${e.spacing2}px`},children:[t.jsxs("span",{style:{fontSize:`${e.textLg}px`},className:"text-gray-900 font-medium",children:["TSh ",s.price.toLocaleString()]}),t.jsx(q,{size:e.iconSize,className:"text-gray-400",strokeWidth:2})]})]},s.id)),f.length===0&&t.jsxs("div",{className:"text-center",style:{paddingTop:`${e.spacing6*2}px`,paddingBottom:`${e.spacing6*2}px`,paddingLeft:`${e.spacing4}px`,paddingRight:`${e.spacing4}px`},children:[t.jsx("div",{className:"rounded-full bg-gray-100 flex items-center justify-center mx-auto",style:{width:`${e.avatarSize*1.5}px`,height:`${e.avatarSize*1.5}px`,marginBottom:`${e.spacing4}px`},children:t.jsx(h,{size:e.iconSizeXl,className:"text-gray-400",strokeWidth:1.5})}),t.jsx("p",{style:{fontSize:`${e.textBase}px`},className:"text-gray-500 font-normal",children:"No products found"}),t.jsx("p",{style:{fontSize:`${e.textSm}px`,marginTop:`${e.spacing2}px`},className:"text-gray-400 font-light",children:c.length===0?"Add your first product to get started":"Try a different search term"})]})]})]})})};export{ie as default};
