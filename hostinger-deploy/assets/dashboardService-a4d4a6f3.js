import{ay as L,az as W,M as b,s as f,aA as Y,aB as $}from"./index-61458a34.js";class O{async getDashboardStats(e,n,t){try{const[r,a,s,c,m,o]=await Promise.all([this.getDeviceStats(n,t),this.getCustomerStats(n,t),this.getEmployeeStats(),this.getPaymentStats(n,t),this.getAppointmentStats(n,t),this.getInventoryStats()]);return{totalDevices:r.total,totalCustomers:a.total,totalEmployees:s.total,totalRevenue:c.totalRevenue,activeDevices:r.active,completedDevices:r.completed,pendingDevices:r.pending,overdueDevices:r.overdue,devicesInRepair:r.inRepair,presentToday:s.presentToday,onLeaveToday:s.onLeaveToday,attendanceRate:s.attendanceRate,newCustomersThisMonth:a.newThisMonth,activeCustomers:a.active,revenueThisMonth:c.thisMonth,revenueThisWeek:c.thisWeek,revenueToday:c.today,pendingPayments:c.pending,unreadNotifications:await this.getNotificationCounts(e).then(l=>l.unread),urgentNotifications:await this.getNotificationCounts(e).then(l=>l.urgent),appointmentsToday:m.today,appointmentsThisWeek:m.thisWeek,upcomingAppointments:m.upcoming,todayAppointments:m.today,appointmentCompletionRate:m.completionRate,lowStockItems:o.lowStock,criticalStockAlerts:o.critical,totalProducts:o.total,inventoryValue:o.value}}catch(r){return console.error("Error fetching dashboard stats:",r instanceof Error?r.message:r),this.getDefaultStats()}}async getDeviceStats(e,n){try{const t=await L(),r=new Date;let a=t;return e&&n&&(a=t.filter(s=>{const c=new Date(s.created_at);return c>=new Date(e)&&c<=new Date(n)})),{total:a.length,active:a.filter(s=>!["done","failed","repair-complete"].includes(s.status)).length,completed:a.filter(s=>["done","repair-complete"].includes(s.status)).length,pending:a.filter(s=>["assigned","awaiting-parts"].includes(s.status)).length,overdue:a.filter(s=>s.estimated_completion_date?new Date(s.estimated_completion_date)<r&&!["done","failed","repair-complete"].includes(s.status):!1).length,inRepair:a.filter(s=>["diagnosis-started","in-repair","reassembled-testing"].includes(s.status)).length}}catch(t){return console.error("âŒ Error fetching device stats - Full error:",t),console.error("âŒ Nested error details:",(t==null?void 0:t.error)||t),{total:0,active:0,completed:0,pending:0,overdue:0,inRepair:0}}}async getCustomerStats(e,n){try{const t=await W();let r=t;return e&&n&&(r=t.filter(a=>{const s=new Date(a.joined_date);return s>=new Date(e)&&s<=new Date(n)})),{total:t.length,active:t.filter(a=>a.is_active).length,newThisMonth:r.length}}catch(t){return console.error("Error fetching customer stats:",t instanceof Error?t.message:t),{total:0,active:0,newThisMonth:0}}}async getEmployeeStats(){try{const e=new Date().toISOString().split("T")[0],n=b();let t=f.from("employees").select("id, status");n&&(t=t.eq("branch_id",n));const{data:r,error:a}=await t;if(a)throw a;const s=(r==null?void 0:r.length)||0,c=(r==null?void 0:r.filter(u=>u.status==="on-leave").length)||0;let m=f.from("attendance_records").select("status").eq("attendance_date",e);n&&(m=m.eq("branch_id",n));const{data:o,error:l}=await m;if(l)throw l;const h=(o==null?void 0:o.filter(u=>u.status==="present"||u.status==="late").length)||0,_=s>0?h/s*100:0;return{total:s,presentToday:h,onLeaveToday:c,attendanceRate:Math.round(_)}}catch(e){return console.error("Error fetching employee stats:",e instanceof Error?e.message:e),{total:0,presentToday:0,onLeaveToday:0,attendanceRate:0}}}async getPaymentStats(e,n){try{const t=await Y();let r=t;e&&n&&(r=t.filter(o=>{const l=new Date(o.payment_date);return l>=new Date(e)&&l<=new Date(n)}));const a=new Date,s=new Date(a.getFullYear(),a.getMonth(),a.getDate()),c=new Date(s);c.setDate(c.getDate()-c.getDay());const m=new Date(a.getFullYear(),a.getMonth(),1);return{totalRevenue:t.filter(o=>o.status==="completed").reduce((o,l)=>o+(Number(l.amount)||0),0),today:r.filter(o=>new Date(o.payment_date)>=s&&o.status==="completed").reduce((o,l)=>o+(Number(l.amount)||0),0),thisWeek:r.filter(o=>new Date(o.payment_date)>=c&&o.status==="completed").reduce((o,l)=>o+(Number(l.amount)||0),0),thisMonth:r.filter(o=>new Date(o.payment_date)>=m&&o.status==="completed").reduce((o,l)=>o+(Number(l.amount)||0),0),pending:r.filter(o=>o.status==="pending").reduce((o,l)=>o+(Number(l.amount)||0),0)}}catch(t){return console.error("âŒ Error fetching payment stats - Full error:",t),console.error("âŒ Nested error details:",(t==null?void 0:t.error)||t),{totalRevenue:0,today:0,thisWeek:0,thisMonth:0,pending:0}}}async getAppointmentStats(e,n){try{const t=b(),r=new Date,a=new Date(r.getFullYear(),r.getMonth(),r.getDate());a.setHours(0,0,0,0);const s=new Date(a);s.setHours(23,59,59,999);const c=new Date(a);c.setDate(c.getDate()-c.getDay());let m=f.from("appointments").select("id, status, appointment_date, created_at");t&&(m=m.eq("branch_id",t)),e&&n&&(m=m.gte("appointment_date",e).lte("appointment_date",n));const{data:o,error:l}=await m;if(l)return console.error("Error fetching appointments:",l),{today:0,thisWeek:0,upcoming:0,completionRate:0};const h=o||[];console.log("ðŸ“… Appointments Data:",{total:h.length,sample:h.slice(0,3).map(g=>({id:g.id,date:g.appointment_date,status:g.status}))});const _=h.filter(g=>{const v=new Date(g.appointment_date);return v>=a&&v<=s}),u=h.filter(g=>new Date(g.appointment_date)>=a),w=_.filter(g=>g.status==="completed").length,p=_.length>0?Math.round(w/_.length*100):0;return{today:_.length,thisWeek:h.filter(g=>new Date(g.appointment_date)>=c).length,upcoming:u.length,completionRate:p}}catch(t){return console.error("Error fetching appointment stats:",t instanceof Error?t.message:t),{today:0,thisWeek:0,upcoming:0,completionRate:0}}}async getInventoryStats(){try{const e=await $(),n=e.filter(a=>{const s=Number(a.quantity)||0,c=Number(a.min_quantity)||0;return s>0&&s<=c}).length,t=e.filter(a=>(Number(a.quantity)||0)===0).length,r=e.reduce((a,s)=>{const c=Number(s.cost_price)||0,m=Number(s.quantity)||0;return a+c*m},0);return console.log("ðŸ“¦ Inventory Stats Calculated:",{totalVariants:e.length,lowStock:n,critical:t,sampleVariants:e.slice(0,3).map(a=>({cost_price:a.cost_price,quantity:a.quantity,min_quantity:a.min_quantity,value:(Number(a.cost_price)||0)*(Number(a.quantity)||0)})),calculatedValue:r,valueType:typeof r}),{total:e.length,lowStock:n,critical:t,value:r}}catch(e){return console.error("âŒ Error fetching inventory stats - Full error:",e),console.error("âŒ Nested error details:",(e==null?void 0:e.error)||e),{total:0,lowStock:0,critical:0,value:0}}}async getNotificationCounts(e){try{const n=b();let t=f.from("notifications").select("status, priority").eq("user_id",e);n&&(t=t.eq("branch_id",n));const{data:r,error:a}=await t;if(a)throw a;const s=r||[],c=s.filter(o=>o.status==="unread").length,m=s.filter(o=>o.priority==="urgent"&&o.status==="unread").length;return{unread:c,urgent:m}}catch(n){return console.error("Error fetching notification counts:",n instanceof Error?n.message:n),{unread:0,urgent:0}}}async getRecentNotifications(e,n=10){try{const t=b();let r=f.from("notifications").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(n);t&&(r=r.eq("branch_id",t));const{data:a,error:s}=await r;if(s)throw s;return(a||[]).map(c=>({id:c.id,title:c.title,message:c.message,priority:c.priority,createdAt:c.created_at,isRead:c.status==="read"||c.status==="actioned",type:c.type}))}catch(t){return console.error("Error fetching notifications:",t instanceof Error?t.message:t),[]}}async getTodayEmployeeStatus(){try{const e=new Date().toISOString().split("T")[0],n=b();let t=f.from("employees").select("id, full_name, email, phone, position").eq("is_active",!0).limit(10);n&&(t=t.eq("branch_id",n));const{data:r,error:a}=await t;if(a)throw a;if(!r||r.length===0)return[];const s=r.map(l=>l.id);let c=f.from("attendance_records").select("employee_id, status, check_in_time").eq("attendance_date",e).in("employee_id",s);n&&(c=c.eq("branch_id",n));const{data:m,error:o}=await c;if(o)throw o;return r.map(l=>{const h=m==null?void 0:m.find(_=>_.employee_id===l.id);return{id:l.id,full_name:l.full_name||"Unknown",email:l.email,role:l.position||"Staff",status:(h==null?void 0:h.status)||"absent",department:l.position||"",checkInTime:h!=null&&h.check_in_time?new Date(h.check_in_time).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):void 0}})}catch(e){return console.error("Error fetching employee status:",e instanceof Error?e.message:e),[]}}async getRecentActivity(e=20){try{const n=[],t=b();let r=f.from("devices").select("id, device_name, status, problem_description, created_at, updated_at").order("updated_at",{ascending:!1}).limit(5);t&&(r=r.eq("branch_id",t));const{data:a,error:s}=await r;if(s)throw console.error("Recent activity devices error:",s),s;a&&a.forEach(u=>{n.push({id:`device-${u.id}`,type:"device",title:`Device ${u.status.replace("-"," ")}`,description:`${u.problem_description||"Service"} - ${u.device_name}`,time:u.updated_at,status:["done","repair-complete"].includes(u.status)?"completed":"pending"})});let c=f.from("customer_payments").select("id, amount, payment_date, status").order("payment_date",{ascending:!1}).limit(5);t&&(c=c.eq("branch_id",t));const{data:m}=await c;m&&m.forEach(u=>{n.push({id:`payment-${u.id}`,type:"payment",title:"Payment received",description:`Payment of ${u.amount} TZS`,time:u.payment_date,status:u.status==="completed"?"completed":"pending",amount:u.amount})});let o=f.from("lats_sales").select("id, sale_number, total_amount, customer_name, created_at").order("created_at",{ascending:!1}).limit(10);t&&(o=o.eq("branch_id",t));const{data:l}=await o;l&&l.forEach(u=>{n.push({id:`sale-${u.id}`,type:"payment",title:"Sale completed",description:`${u.customer_name||"Walk-in customer"} - ${u.sale_number}`,time:u.created_at,status:"completed",amount:u.total_amount})});let h=f.from("customers").select("id, name, joined_date").order("joined_date",{ascending:!1}).limit(3);t&&(h=h.eq("branch_id",t));const{data:_}=await h;return _&&_.forEach(u=>{n.push({id:`customer-${u.id}`,type:"customer",title:"New customer registered",description:u.name,time:u.joined_date,status:"completed"})}),n.sort((u,w)=>new Date(w.time).getTime()-new Date(u.time).getTime()).slice(0,e)}catch(n){return console.error("Error fetching recent activity:",{message:n==null?void 0:n.message,details:n==null?void 0:n.details,hint:n==null?void 0:n.hint,code:n==null?void 0:n.code}),[]}}async getRecentActivities(e=20){return this.getRecentActivity(e)}async getTodayAppointments(e=10){try{const n=b(),t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate());r.setHours(0,0,0,0);const a=new Date(r);a.setHours(23,59,59,999);let s=f.from("appointments").select("*").gte("appointment_date",r.toISOString()).lte("appointment_date",a.toISOString()).order("appointment_date",{ascending:!0}).limit(e);n&&(s=s.eq("branch_id",n));const{data:c,error:m}=await s;if(m)return console.error("Error fetching appointments:",m),[];const o=c||[];if(o.length===0)return[];const l=o.map(u=>u.customer_id).filter(Boolean),{data:h}=await f.from("customers").select("id, name").in("id",l),_=new Map((h||[]).map(u=>[u.id,u.name]));return o.map(u=>({id:u.id,customerName:_.get(u.customer_id)||"Unknown",serviceName:u.title||u.service_type||u.description||"Appointment",time:new Date(u.appointment_date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),status:u.status||"scheduled",priority:u.priority||"medium",technicianName:void 0}))}catch(n){return console.error("Error fetching today appointments:",n instanceof Error?n.message:n),[]}}async getCustomerInsights(){try{const e=b();let n=f.from("customers").select("id, name, total_spent, joined_date, is_active");e&&(n=n.eq("branch_id",e));const{data:t,error:r}=await n;if(r)throw r;const a=t||[],s=new Date,c=new Date(s.getFullYear(),s.getMonth(),1),m=a.sort((o,l)=>(l.total_spent||0)-(o.total_spent||0)).slice(0,5).map(o=>({id:o.id,name:o.name,totalSpent:o.total_spent||0,deviceCount:0}));return{totalCustomers:a.length,newThisMonth:a.filter(o=>new Date(o.joined_date)>=c).length,returningCustomers:a.filter(o=>(o.total_spent||0)>0).length,avgLifetimeValue:a.length>0?a.reduce((o,l)=>o+(l.total_spent||0),0)/a.length:0,topCustomers:m}}catch(e){return console.error("Error fetching customer insights:",e instanceof Error?e.message:e),{totalCustomers:0,newThisMonth:0,returningCustomers:0,avgLifetimeValue:0,topCustomers:[]}}}async getFinancialSummary(){try{const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),t=new Date(n);t.setDate(t.getDate()-t.getDay());const r=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()-1,1),s=new Date(e.getFullYear(),e.getMonth(),0,23,59,59),c=b();console.log("ðŸ¢ Current Branch ID:",c);let m=f.from("lats_sales").select("total_amount, created_at, payment_method, sale_number");c&&(m=m.eq("branch_id",c));const{data:o,error:l}=await m;if(l)throw console.error("Financial summary sales error:",l),l;let h=f.from("customer_payments").select("amount, payment_date, status, method");c&&(h=h.eq("branch_id",c));const{data:_}=await h,u=o||[],w=_||[];console.log("ðŸ’° Financial Data:",{salesCount:u.length,servicePaymentsCount:w.length,sampleSale:u[0]});const p=(i,d="TZS",S=1)=>{if(d==="TZS"||!d)return i;const M=S&&S>1?S:d==="USD"?2500:d==="EUR"?2700:d==="GBP"?3200:1;return i*M},g=u.filter(i=>new Date(i.created_at)>=n).reduce((i,d)=>i+(Number(d.total_amount)||0),0),v=w.filter(i=>new Date(i.payment_date)>=n&&i.status==="completed").reduce((i,d)=>{const S=Number(d.amount)||0,M=p(S,d.currency,d.exchange_rate);return i+M},0),q=g+v,D=u.filter(i=>new Date(i.created_at)>=t).reduce((i,d)=>i+(Number(d.total_amount)||0),0),I=w.filter(i=>new Date(i.payment_date)>=t&&i.status==="completed").reduce((i,d)=>{const S=Number(d.amount)||0,M=p(S,d.currency,d.exchange_rate);return i+M},0),k=D+I,R=u.filter(i=>new Date(i.created_at)>=r).reduce((i,d)=>i+(Number(d.total_amount)||0),0),C=w.filter(i=>new Date(i.payment_date)>=r&&i.status==="completed").reduce((i,d)=>{const S=Number(d.amount)||0,M=p(S,d.currency,d.exchange_rate);return i+M},0),T=R+C,A=u.filter(i=>new Date(i.created_at)>=a&&new Date(i.created_at)<=s).reduce((i,d)=>i+(Number(d.total_amount)||0),0),P=w.filter(i=>new Date(i.payment_date)>=a&&new Date(i.payment_date)<=s&&i.status==="completed").reduce((i,d)=>{const S=Number(d.amount)||0,M=p(S,d.currency,d.exchange_rate);return i+M},0),y=A+P,N=y>0?Math.round((T-y)/y*100):0,F=u.length+w.filter(i=>i.status==="completed").length,B=w.filter(i=>i.status==="pending").length,Q=w.filter(i=>i.status==="pending").reduce((i,d)=>i+(Number(d.amount)||0),0),E={};u.forEach(i=>{let d="cash";i.payment_method&&(typeof i.payment_method=="string"?d=i.payment_method:typeof i.payment_method=="object"&&(d=i.payment_method.method||i.payment_method.name||i.payment_method.type||Object.keys(i.payment_method)[0]||"cash")),E[d]||(E[d]={amount:0,count:0}),E[d].amount+=Number(i.total_amount)||0,E[d].count+=1}),w.filter(i=>i.status==="completed").forEach(i=>{const d=i.method||"cash";E[d]||(E[d]={amount:0,count:0}),E[d].amount+=Number(i.amount)||0,E[d].count+=1}),console.log("ðŸ’³ Payment Method Groups Final:",E);const j=Object.entries(E).map(([i,d])=>({method:i,amount:d.amount,count:d.count})).sort((i,d)=>d.amount-i.amount);return{todayRevenue:q,weeklyRevenue:k,monthlyRevenue:T,revenueGrowth:N,completedPayments:F,pendingPayments:B,outstandingAmount:Q,paymentMethods:j}}catch(e){return console.error("Error fetching financial summary:",{message:e==null?void 0:e.message,details:e==null?void 0:e.details,hint:e==null?void 0:e.hint,code:e==null?void 0:e.code}),{todayRevenue:0,weeklyRevenue:0,monthlyRevenue:0,revenueGrowth:0,completedPayments:0,pendingPayments:0,outstandingAmount:0,paymentMethods:[]}}}async getInventoryAlerts(){try{const e=b();let n=f.from("lats_products").select("id, name, category_id, is_active, branch_id, is_shared").eq("is_active",!0);e&&(n=n.or(`is_shared.eq.true,branch_id.eq.${e}`));const{data:t,error:r}=await n;if(r)throw r;if(!t||t.length===0)return[];const a=t.map(p=>p.id);let s=f.from("lats_product_variants").select("id, product_id, quantity, min_quantity, branch_id, is_shared").in("product_id",a);e&&(s=s.or(`is_shared.eq.true,branch_id.eq.${e}`));const{data:c,error:m}=await s;if(m)throw m;const o=[...new Set(t.map(p=>p.category_id).filter(Boolean))],{data:l}=o.length>0?await f.from("lats_categories").select("id, name").in("id",o):{data:[]},h=new Map((l||[]).map(p=>[p.id,p.name])),_=new Map(t.map(p=>[p.id,p])),u=[];(c||[]).forEach(p=>{const g=Number(p.quantity)||0,v=Number(p.min_quantity)||0,q=_.get(p.product_id);if(!q)return;let D;g===0?D="out-of-stock":g<=v*.25?D="critical":g<=v&&(D="low"),D&&u.push({id:p.id,productName:q.name||"Unknown Product",category:h.get(q.category_id)||"Uncategorized",currentStock:g,minimumStock:v,alertLevel:D})});const w={"out-of-stock":0,critical:1,low:2};return u.sort((p,g)=>w[p.alertLevel]-w[g.alertLevel]),u.slice(0,10)}catch(e){return console.error("Error fetching inventory alerts:",{message:e==null?void 0:e.message,details:e==null?void 0:e.details,hint:e==null?void 0:e.hint,code:e==null?void 0:e.code}),[]}}async getAnalyticsData(e,n){try{const t=new Date,r=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()-1,1),s=new Date(t.getFullYear(),t.getMonth(),0,23,59,59),c=b();let m=f.from("customer_payments").select("amount, payment_date, status");c&&(m=m.eq("branch_id",c)),e&&n&&(m=m.gte("payment_date",e).lte("payment_date",n));const{data:o,error:l}=await m;if(l)throw console.error("Analytics payments error:",l),l;const h=o||[],_=h.filter(y=>new Date(y.payment_date)>=r&&y.status==="completed").reduce((y,N)=>y+(Number(N.amount)||0),0),u=h.filter(y=>new Date(y.payment_date)>=a&&new Date(y.payment_date)<=s&&y.status==="completed").reduce((y,N)=>y+(Number(N.amount)||0),0),w=u>0?Math.round((_-u)/u*100):0;let p=f.from("customers").select("id, joined_date");c&&(p=p.eq("branch_id",c));const{data:g}=await p,v=g||[],q=v.filter(y=>new Date(y.joined_date)>=r).length,D=v.filter(y=>new Date(y.joined_date)>=a&&new Date(y.joined_date)<=s).length,I=D>0?Math.round((q-D)/D*100):0,k=new Date;k.setHours(0,0,0,0);let R=f.from("lats_sales").select("total_amount, created_at");c&&(R=R.eq("branch_id",c));const{data:C}=await R,T=C||[],A=T.length>0?T.reduce((y,N)=>y+(Number(N.total_amount)||0),0)/T.length:0,P=T.filter(y=>new Date(y.created_at)>=k).length;return{revenueGrowth:w,customerGrowth:I,averageOrderValue:Math.round(A),completedToday:P}}catch(t){return console.error("Error fetching analytics data:",{message:t==null?void 0:t.message,details:t==null?void 0:t.details,hint:t==null?void 0:t.hint,code:t==null?void 0:t.code}),{revenueGrowth:0,customerGrowth:0,averageOrderValue:0,completedToday:0}}}getDefaultStats(){return{totalDevices:0,totalCustomers:0,totalEmployees:0,totalRevenue:0,activeDevices:0,completedDevices:0,pendingDevices:0,overdueDevices:0,devicesInRepair:0,presentToday:0,onLeaveToday:0,attendanceRate:0,newCustomersThisMonth:0,activeCustomers:0,revenueThisMonth:0,revenueThisWeek:0,revenueToday:0,pendingPayments:0,unreadNotifications:0,urgentNotifications:0,appointmentsToday:0,appointmentsThisWeek:0,upcomingAppointments:0,todayAppointments:0,appointmentCompletionRate:0,lowStockItems:0,criticalStockAlerts:0,totalProducts:0,inventoryValue:0}}}const U=new O;export{U as d};
