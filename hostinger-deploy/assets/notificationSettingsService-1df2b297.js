import{_ as i}from"./supabase-cf010ec4.js";import{q as u}from"./index-61458a34.js";import{z as o}from"./ui-28e30067.js";import{format as r}from"./format-aff4c6a2.js";import{a as c}from"./formatPhoneForInvoice-e7084c6d.js";import"./vendor-36d2c7c1.js";import"./routing-eb8c310c.js";class l{constructor(){this.STORAGE_KEY="lats-pos-notifications"}getSettings(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e)return JSON.parse(e)}catch(e){console.error("Error loading notification settings:",e)}return this.getDefaultSettings()}getDefaultSettings(){return{whatsappEnabled:!0,whatsappAutoSend:!1,whatsappShowPreview:!0,whatsappIncludeLogo:!0,whatsappIncludeItems:!0,whatsappMessage:"Thank you for your purchase! Here's your invoice:",smsEnabled:!0,smsAutoSend:!1,smsTemplate:"Thank you! Total: {total}. Balance: {balance}. Ref: {invoice_no}",smsIncludeTotal:!0,smsIncludeBalance:!0,emailEnabled:!0,emailAutoSend:!1,emailSubject:"Your Invoice from {business_name}",emailTemplate:"Thank you for your purchase. Please find your invoice attached.",emailAttachPDF:!0,notifyOnPayment:!0,notifyOnRefund:!0,notifyLowStock:!0,notifyNewCustomer:!1}}saveSettings(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){throw console.error("Error saving notification settings:",t),t}}generateWhatsAppMessage(e,t){let s=t.whatsappMessage+`

`;s+=`ðŸ“„ Invoice: ${e.invoice_no}
`,s+=`ðŸ“… Date: ${e.date}
`,s+=`ðŸ‘¤ Customer: ${e.customer_name}

`,t.whatsappIncludeItems&&e.items.length>0&&(s+=`ðŸ›’ Items:
`,e.items.forEach(a=>{s+=`  â€¢ ${a.name} x${a.quantity} - ${r.money(a.price)}
`}),s+=`
`),e.discount&&e.discount>0&&(s+=`ðŸ’µ Subtotal: ${r.money(e.subtotal)}
`,s+=`ðŸŽ Discount: -${r.money(e.discount)}
`),e.tax&&e.tax>0&&(s+=`ðŸ“Š Tax: ${r.money(e.tax)}
`),s+=`ðŸ’° Total: ${r.money(e.total)}
`,s+=`âœ… Paid: ${r.money(e.paid)}
`,e.balance>0&&(s+=`ðŸ“Š Balance: ${r.money(e.balance)}
`),e.payment_method&&(s+=`ðŸ’³ Payment: ${e.payment_method}
`);const n=c(e.business_phone);return n&&(s+=`
ðŸ“ž Contact: ${n}
`),s+=`
Thank you for your business! ðŸ™`,s}generateSMSMessage(e,t){let s=t.smsTemplate;s=s.replace("{total}",r.money(e.total)),s=s.replace("{balance}",r.money(e.balance)),s=s.replace("{paid}",r.money(e.paid)),s=s.replace("{invoice_no}",e.invoice_no),s=s.replace("{business_name}",e.business_name),s=s.replace("{customer_name}",e.customer_name),s=s.replace("{date}",e.date);const n=c(e.business_phone);return s=s.replace("{business_phone}",n||e.business_phone),s}async sendWhatsAppInvoice(e){try{const t=this.getSettings();if(!t.whatsappEnabled)return{success:!1,error:"WhatsApp notifications are disabled in settings"};if(!e.customer_phone)return{success:!1,error:"Customer phone number is required"};const s=this.generateWhatsAppMessage(e,t);console.log("ðŸ“± Sending WhatsApp invoice:",{to:e.customer_phone,invoice_no:e.invoice_no});const{default:n}=await i(()=>import("./whatsappService-09f99080.js"),["assets/whatsappService-09f99080.js","assets/supabase-cf010ec4.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]),a=await n.sendMessage(e.customer_phone,s);return a.success?o.success("WhatsApp invoice sent successfully! âœ…"):o.error(`WhatsApp failed: ${a.error}`),a}catch(t){return console.error("Error sending WhatsApp invoice:",t),{success:!1,error:t.message}}}async sendSMSInvoice(e){try{const t=this.getSettings();if(!t.smsEnabled)return{success:!1,error:"SMS notifications are disabled in settings"};if(!e.customer_phone)return{success:!1,error:"Customer phone number is required"};const s=this.generateSMSMessage(e,t);console.log("ðŸ“± Sending SMS invoice:",{to:e.customer_phone,invoice_no:e.invoice_no});const n=await u.sendSMS(e.customer_phone,s);return n.success&&o.success("SMS invoice sent successfully! âœ…"),n}catch(t){return console.error("Error sending SMS invoice:",t),{success:!1,error:t.message}}}async sendEmailInvoice(e){try{return this.getSettings().emailEnabled?e.customer_email?(console.log("ðŸ“§ Email invoice not yet implemented:",{to:e.customer_email,invoice_no:e.invoice_no}),o("Email sending coming soon! ðŸ“§",{icon:"â„¹ï¸"}),{success:!1,error:"Email sending not yet implemented"}):{success:!1,error:"Customer email is required"}:{success:!1,error:"Email notifications are disabled in settings"}}catch(t){return console.error("Error sending email invoice:",t),{success:!1,error:t.message}}}async smartSendInvoice(e){try{const{smartNotificationService:t}=await i(()=>import("./smartNotificationService-2a2d3be1.js"),["assets/smartNotificationService-2a2d3be1.js","assets/supabase-cf010ec4.js","assets/whatsappService-09f99080.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css","assets/format-aff4c6a2.js","assets/formatPhoneForInvoice-e7084c6d.js"]),s=await t.sendInvoice(e);return{success:s.success,method:s.method,whatsapp:s.whatsappResult,sms:s.smsResult,error:s.error}}catch(t){return console.error("Error in smart send invoice:",t),{success:!1,method:"none",error:t.message}}}async autoSendInvoice(e){const t=this.getSettings(),s={};if(!(t.whatsappEnabled&&t.whatsappAutoSend||t.smsEnabled&&t.smsAutoSend))return s;console.log("ðŸ“± Auto-sending invoice using smart routing (WhatsApp first, SMS fallback)...");const a=await this.smartSendInvoice(e);return a.success?a.method==="whatsapp"?s.whatsapp=a.whatsapp||{success:!0}:a.method==="sms"&&(s.sms=a.sms||{success:!0}):(a.whatsapp&&(s.whatsapp=a.whatsapp),a.sms&&(s.sms=a.sms)),t.emailEnabled&&t.emailAutoSend&&(console.log("ðŸ“§ Auto-sending Email invoice..."),s.email=await this.sendEmailInvoice(e)),s}hasAutoSendEnabled(){const e=this.getSettings();return e.whatsappEnabled&&e.whatsappAutoSend||e.smsEnabled&&e.smsAutoSend||e.emailEnabled&&e.emailAutoSend}hasManualSendEnabled(){const e=this.getSettings();return e.whatsappEnabled&&!e.whatsappAutoSend||e.smsEnabled&&!e.smsAutoSend||e.emailEnabled&&!e.emailAutoSend}}const y=new l;export{l as default,y as notificationSettingsService};
