import{s as c}from"./index-61458a34.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";class P{async reverseSale(o,n,y){try{console.log("üîÑ [SaleReversal] Starting sale reversal for:",o);const{data:t,error:s}=await c.from("lats_sales").select("*").eq("id",o).single();if(s||!t)return{success:!1,message:"Sale not found",error:(s==null?void 0:s.message)||"Sale not found"};if(t.status==="reversed")return{success:!1,message:"Sale has already been reversed",error:"Sale is already reversed"};const{data:l,error:S}=await c.from("lats_sale_items").select("*").eq("sale_id",o);if(S)return{success:!1,message:"Failed to fetch sale items",error:S.message};if(!l||l.length===0)return{success:!1,message:"No items found in sale",error:"Sale has no items"};const i=await this.restoreStock(l,o,n,y);if(!i.success)return{success:!1,message:"Failed to restore stock",error:i.error};const g=await this.reversePayments(o,t,n,y);g.success||console.warn("‚ö†Ô∏è [SaleReversal] Payment reversal failed, but continuing:",g.error),t.customer_id&&await this.reverseCustomerStats(t.customer_id,t,l);const $={reversed:!0,reversed_at:new Date().toISOString(),reversed_by:n||"system",reversal_reason:y||"Sale reversed"},p=t.notes||"",_=`

[REVERSED] ${$.reversed_at} by ${$.reversed_by}: ${$.reversal_reason}`,m=p+_,{error:r}=await c.from("lats_sales").update({status:"reversed",payment_status:"cancelled",notes:m,updated_at:new Date().toISOString()}).eq("id",o);return r?(console.error("‚ùå [SaleReversal] Failed to mark sale as reversed:",r),{success:!1,message:"Stock restored but failed to mark sale as reversed",error:r.message}):(console.log("‚úÖ [SaleReversal] Sale reversed successfully"),{success:!0,message:"Sale reversed successfully",data:{saleId:o,itemsRestored:l.length,stockRestored:i.itemsRestored||l.length,transactionsReversed:g.transactionsReversed||0}})}catch(t){return console.error("‚ùå [SaleReversal] Error reversing sale:",t),{success:!1,message:"Failed to reverse sale",error:t instanceof Error?t.message:"Unknown error"}}}async restoreStock(o,n,y,t){try{console.log(`üì¶ [SaleReversal] Restoring stock for ${o.length} items`);const s=o.map(r=>r.variant_id).filter(Boolean);if(s.length===0)return{success:!0,itemsRestored:0};const{data:R,error:l}=await c.from("lats_product_variants").select("id, quantity, is_parent, variant_type").in("id",s);if(l)return{success:!1,error:`Failed to fetch variants: ${l.message}`};const S=new Map(R.map(r=>[r.id,r])),i=new Map;for(const r of o){if(!r.variant_id){console.warn("‚ö†Ô∏è [SaleReversal] Item has no variant_id, skipping:",r.id);continue}const u=i.get(r.variant_id);u?(u.quantity+=r.quantity||1,u.item_ids.push(r.id)):i.set(r.variant_id,{quantity:r.quantity||1,product_id:r.product_id,item_ids:[r.id]})}const g=Array.from(i.entries()).map(async([r,u])=>{if(!S.get(r))return console.warn("‚ö†Ô∏è [SaleReversal] Variant not found:",r),{success:!1,error:"Variant not found"};const M=u.quantity;let e=[],a=null,d=!1;const{data:k,error:b}=await c.from("lats_stock_movements").select("previous_quantity, new_quantity, quantity, reference, reference_id, created_at").eq("variant_id",r).eq("reference_id",n).eq("movement_type","out").order("created_at",{ascending:!1}).limit(1);if(!b&&k&&k.length>0&&(e=k,d=!0,console.log(`‚úÖ [SaleReversal] Found movement by reference_id for sale ${n}`)),!d){const f=n.substring(0,8),{data:F,error:h}=await c.from("lats_stock_movements").select("previous_quantity, new_quantity, quantity, reference, reference_id, created_at").eq("variant_id",r).eq("movement_type","out").or(`reference.ilike.%${f}%,reference.ilike.%${n}%`).order("created_at",{ascending:!1}).limit(1);!h&&F&&F.length>0?(e=F,d=!0,console.log(`‚úÖ [SaleReversal] Found movement by reference text for sale ${n}`)):a=h||b}if(!d){const{data:f,error:F}=await c.from("lats_stock_movements").select("previous_quantity, new_quantity, quantity, reference, reference_id, created_at").eq("variant_id",r).eq("movement_type","out").order("created_at",{ascending:!1}).limit(5);if(!F&&f&&f.length>0){const{data:h}=await c.from("lats_sales").select("created_at").eq("id",n).single();if(h!=null&&h.created_at){const N=new Date(h.created_at).getTime(),C=f.find(O=>new Date(O.created_at).getTime()<=N+6e4);C&&(e=[C],d=!0,console.log(`‚úÖ [SaleReversal] Found movement by date matching for sale ${n}`))}!d&&f.length>0&&(e=[f[0]],d=!0,console.log(`‚ö†Ô∏è [SaleReversal] Using most recent out movement as fallback for sale ${n}`))}}let v=null;!a&&e&&e.length>0?(v=e[0].previous_quantity,console.log(`üìã [SaleReversal] Found original stock from movement: ${v}`),console.log("üìã [SaleReversal] Movement details:",{id:e[0].id||"N/A",previous_quantity:e[0].previous_quantity,new_quantity:e[0].new_quantity,quantity:e[0].quantity,reference:e[0].reference,reference_id:e[0].reference_id})):(console.error(`‚ùå [SaleReversal] Could not find sale movement for variant ${r}, sale ${n}`),console.error("‚ùå [SaleReversal] Error:",a));const{data:w,error:E}=await c.from("lats_product_variants").select("quantity").eq("id",r).single();if(E)return console.error("‚ùå [SaleReversal] Failed to fetch current stock for variant:",r,E),{success:!1,error:E.message};const T=(w==null?void 0:w.quantity)||0;let q;v!=null?(q=v,console.log(`üì¶ [SaleReversal] Restoring variant ${r} to original quantity: ${T} ‚Üí ${q} (was ${v} before sale)`)):(q=T+M,console.warn(`‚ö†Ô∏è [SaleReversal] Could not find original stock, adding back: ${T} + ${M} = ${q}`));const{error:B}=await c.from("lats_stock_movements").insert({product_id:u.product_id,variant_id:r,movement_type:"in",quantity:M,previous_quantity:T,new_quantity:q,reason:"Sale Reversal",reference:`Sale ${n.substring(0,8)}... reversed (${u.item_ids.length} item${u.item_ids.length>1?"s":""})`,notes:t||`Stock restored due to sale reversal. Original quantity was ${v??"unknown"}. Restored to ${q}.`,created_by:y||null,created_at:new Date().toISOString()});if(B){console.warn("‚ö†Ô∏è [SaleReversal] Failed to create stock movement, falling back to direct update:",B);const{error:f}=await c.from("lats_product_variants").update({quantity:q,updated_at:new Date().toISOString()}).eq("id",r);if(f)return console.error("‚ùå [SaleReversal] Failed to restore stock for variant:",r,f),{success:!1,error:f.message}}return{success:!0}}),p=(await Promise.all(g)).filter(r=>!r.success);if(p.length>0)return{success:!1,error:`Failed to restore stock for ${p.length} items`};const _=i.size,m=o.filter(r=>r.variant_id).length;return console.log(`‚úÖ [SaleReversal] Stock restored for ${_} unique variant(s) across ${m} item(s)`),{success:!0,itemsRestored:m}}catch(s){return console.error("‚ùå [SaleReversal] Error restoring stock:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}async reversePayments(o,n,y,t){try{console.log("üí≥ [SaleReversal] Reversing payment transactions");const{data:s,error:R}=await c.from("account_transactions").select("*").eq("reference_number",n.sale_number||"").eq("transaction_type","payment_received"),{data:l,error:S}=await c.from("account_transactions").select("*").eq("transaction_type","payment_received"),i=(l==null?void 0:l.filter(e=>{const a=e.metadata||{};return a.sale_id===o||a.saleId===o}))||[],g=[...s||[],...i],$=Array.from(new Map(g.map(e=>[e.id,e])).values()),p=R||S,_=$;if(p)return console.warn("‚ö†Ô∏è [SaleReversal] Failed to find transactions:",p),{success:!0,transactionsReversed:0};if(!_||_.length===0)return console.log("‚ÑπÔ∏è [SaleReversal] No payment transactions found to reverse"),{success:!0,transactionsReversed:0};const m=_.filter(e=>!(e.metadata||{}).reversed);if(m.length===0)return console.log("‚ÑπÔ∏è [SaleReversal] All transactions are already reversed"),{success:!0,transactionsReversed:0};m.length<_.length&&console.log(`‚ÑπÔ∏è [SaleReversal] ${_.length-m.length} transaction(s) already reversed, processing ${m.length} remaining`);const r=new Map;for(const e of m)if(e.account_id){const a=r.get(e.account_id);a?(a.totalAmount+=Math.abs(e.amount||0),a.transactionIds.push(e.id)):r.set(e.account_id,{totalAmount:Math.abs(e.amount||0),transactionIds:[e.id]})}let u=0;const D=m.map(async e=>{try{const{error:a}=await c.from("account_transactions").update({metadata:{...e.metadata||{},reversed:!0,reversed_at:new Date().toISOString(),reversed_by:y||"system",reversal_reason:t||"Sale reversed"}}).eq("id",e.id);return a?(console.warn("‚ö†Ô∏è [SaleReversal] Failed to mark transaction as reversed:",e.id,a),{success:!1,transactionId:e.id}):{success:!0,transactionId:e.id}}catch(a){return console.warn("‚ö†Ô∏è [SaleReversal] Error marking transaction as reversed:",e.id,a),{success:!1,transactionId:e.id}}});u=(await Promise.all(D)).filter(e=>e.success).length;for(const[e,a]of r.entries())try{const{data:d,error:k}=await c.from("finance_accounts").select("balance").eq("id",e).single();if(k||!d){console.warn(`‚ö†Ô∏è [SaleReversal] Failed to fetch account ${e}:`,k);continue}const b=Number(d.balance)||0,v=a.totalAmount,w=b-v;console.log(`üí≥ [SaleReversal] Reversing ${a.transactionIds.length} transaction(s) for account ${e}:`),console.log(`   Current balance: ${b}`),console.log(`   Total to reverse: ${v}`),console.log(`   New balance: ${w}`);const{error:E}=await c.from("finance_accounts").update({balance:w,updated_at:new Date().toISOString()}).eq("id",e);E?console.warn(`‚ö†Ô∏è [SaleReversal] Failed to update account balance for ${e}:`,E):console.log(`‚úÖ [SaleReversal] Successfully reversed ${v} from account ${e} (${b} ‚Üí ${w})`)}catch(d){console.warn(`‚ö†Ô∏è [SaleReversal] Error reversing account balance for ${e}:`,d)}return console.log(`‚úÖ [SaleReversal] Reversed ${u} payment transactions`),{success:!0,transactionsReversed:u}}catch(s){return console.error("‚ùå [SaleReversal] Error reversing payments:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}async reverseCustomerStats(o,n,y){try{console.log("üë§ [SaleReversal] Reversing customer stats");const{data:t,error:s}=await c.from("customers").select("total_spent, points").eq("id",o).single();if(s||!t){console.warn("‚ö†Ô∏è [SaleReversal] Customer not found:",s);return}const R=n.total_amount||0,l=Math.max(0,(t.total_spent||0)-R),S=Math.floor(R/1e3),i=Math.max(0,(t.points||0)-S),{error:g}=await c.from("customers").update({total_spent:l,points:i,updated_at:new Date().toISOString()}).eq("id",o);g?console.warn("‚ö†Ô∏è [SaleReversal] Failed to update customer stats:",g):console.log("‚úÖ [SaleReversal] Customer stats reversed")}catch(t){console.warn("‚ö†Ô∏è [SaleReversal] Error reversing customer stats:",t)}}}const G=new P;export{G as saleReversalService};
