import{_ as w}from"./supabase-cf010ec4.js";import{r as n}from"./vendor-36d2c7c1.js";import{s as C}from"./index-61458a34.js";import{z as d}from"./ui-28e30067.js";const S=()=>{const[a,s]=n.useState(null),[i,l]=n.useState([]),[_,u]=n.useState(!0),c=n.useCallback(async()=>{try{u(!0);const{data:e,error:t}=await C.from("store_locations").select("id, name, code, city, is_main, is_active, data_isolation_mode, share_products, share_customers, share_inventory").eq("is_active",!0).order("is_main",{ascending:!1}).order("name",{ascending:!0});if(t)throw console.error("Error loading branches:",t),t;l(e||[]);const r=localStorage.getItem("current_branch_id");let o=null;r&&(o=(e==null?void 0:e.find(h=>h.id===r))||null),o||(o=(e==null?void 0:e.find(p=>p.is_main))||(e==null?void 0:e[0])||null,o&&localStorage.setItem("current_branch_id",o.id)),s(o),console.log("ðŸ“ [Mobile] Current branch:",o==null?void 0:o.name)}catch(e){console.error("Failed to load branches:",e),d.error("Failed to load branch information")}finally{u(!1)}},[]),m=n.useCallback(async e=>{const t=i.find(r=>r.id===e);if(!t){d.error("Branch not found");return}s(t),localStorage.setItem("current_branch_id",e),console.log("ðŸ”„ [Mobile] Switched to branch:",t.name);try{console.log("ðŸ—‘ï¸ [Mobile] Clearing cache for branch switch...");const{smartCache:r}=await w(()=>import("./enhancedCacheManager-afe341e0.js"),["assets/enhancedCacheManager-afe341e0.js","assets/index-61458a34.js","assets/vendor-36d2c7c1.js","assets/supabase-cf010ec4.js","assets/routing-eb8c310c.js","assets/ui-28e30067.js","assets/index-e1f77ed5.css"]);await Promise.all([r.invalidateCache("products"),r.invalidateCache("customers"),r.invalidateCache("sales")]),console.log("âœ… [Mobile] Cache cleared for new branch")}catch(r){console.error("âŒ [Mobile] Failed to clear cache:",r)}d.success(`Switching to ${t.name}...`,{duration:1500}),window.dispatchEvent(new CustomEvent("branchChanged",{detail:{branchId:e}})),setTimeout(()=>{console.log("ðŸ”„ [Mobile] Reloading app for branch change..."),window.location.reload()},500)},[i]),f=n.useCallback(e=>!a||a.data_isolation_mode==="shared"?!0:a.data_isolation_mode==="isolated"?!1:{products:a.share_products,customers:a.share_customers,inventory:a.share_inventory}[e]??!1,[a]),b=n.useCallback(()=>a?{branchId:a.id,mode:a.data_isolation_mode}:null,[a]),g=n.useCallback(async()=>{await c()},[c]);return n.useEffect(()=>{c()},[c]),{currentBranch:a,availableBranches:i,loading:_,switchBranch:m,refreshBranches:g,isDataShared:f,getBranchFilter:b}},E=(a,s,i,l)=>i==="shared"||l?a:i==="isolated"?a.eq("branch_id",s):i==="hybrid"?a.or(`branch_id.eq.${s},is_shared.eq.true,branch_id.is.null`):a.or(`branch_id.eq.${s},branch_id.is.null`);export{E as a,S as u};
