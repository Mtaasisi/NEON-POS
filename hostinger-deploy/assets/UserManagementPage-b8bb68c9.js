import{s as _,j as e,e as V,G as N,u as ts,a as ns}from"./index-61458a34.js";import{r as f}from"./vendor-36d2c7c1.js";import{S as is}from"./SearchBar-c613e419.js";import{G as te}from"./GlassSelect-e243562f.js";import{B as ls}from"./BackButton-02a80e74.js";import{o as ze,s as z,e as Ve,b as ye,a as ue,u as Be,C as L}from"./forms-ebbdb905.js";import{t as Fe}from"./zod-78f78e6c.js";import{G as T}from"./GlassInput-0475021a.js";import{n as p,j as Ue,X as we,U as ne,M as Ge,P as Re,a2 as re,bz as Me,d as ce,aw as He,s as Je,aj as me,l as je,bp as cs,K as os,a0 as Ke,G as We,N as be,m as Ye,Y as Pe,p as ve,bj as ds,A as Qe,ay as fe,e as $e,aF as Ie,bo as ge,bF as ms,bh as xs,R as Xe,ag as us,D as Ae,_ as Le,bG as Te,bH as hs}from"./ui-28e30067.js";import{u as De}from"./useBodyScrollLock-341c8b9f.js";import{e as ps}from"./employeeService-efe40e70.js";import{T as gs}from"./SkeletonLoaders-da70324a.js";import{a as fs}from"./routing-eb8c310c.js";import"./supabase-cf010ec4.js";import"./utils-95f4031a.js";import"./charts-d592fbd1.js";async function Ze(s){try{const{data:r,error:n}=await _.from("user_branch_assignments").select(`
        *,
        branch:store_locations!branch_id (
          id,
          name,
          code,
          city,
          is_main
        )
      `).eq("user_id",s).order("is_primary",{ascending:!1});if(n)throw console.error("Error fetching user branch assignments:",n),n;return r||[]}catch(r){return console.error("Error in getUserBranchAssignments:",r),[]}}async function es(){try{const{data:s,error:r}=await _.from("store_locations").select("id, name, code, city, is_main, is_active").eq("is_active",!0).order("is_main",{ascending:!1}).order("name");if(r)throw console.error("Error fetching branches:",r),r;return s||[]}catch(s){return console.error("Error in getAllBranches:",s),[]}}async function Ee(s,r,n){try{if(await _.from("user_branch_assignments").delete().eq("user_id",s),r.length>0){const l=r.map(y=>({user_id:s,branch_id:y.branch_id,is_primary:y.is_primary||!1,can_manage:y.can_manage||!1,can_view_reports:y.can_view_reports||!1,can_manage_inventory:y.can_manage_inventory||!1,can_manage_staff:y.can_manage_staff||!1,assigned_by:n})),{error:h}=await _.from("user_branch_assignments").insert(l);if(h)throw console.error("Error bulk assigning user to branches:",h),h}return!0}catch(l){return console.error("Error in bulkAssignUserToBranches:",l),!1}}const ss={general:{label:"General Access",permissions:[{id:"all",name:"Full Access",description:"Complete system access (Admin only)"},{id:"dashboard",name:"Dashboard Access",description:"View dashboard and analytics"},{id:"pos",name:"POS Access",description:"Access point of sale system"},{id:"reports",name:"View Reports",description:"View business reports"},{id:"settings",name:"Manage Settings",description:"Manage system settings"}]},inventory:{label:"Inventory Management",permissions:[{id:"inventory_view",name:"View Inventory",description:"View inventory levels and products"},{id:"inventory_add",name:"Add Products",description:"Add new products to inventory"},{id:"inventory_edit",name:"Edit Products",description:"Modify existing products"},{id:"inventory_delete",name:"Delete Products",description:"Remove products from inventory"},{id:"inventory_adjust",name:"Adjust Stock",description:"Adjust stock levels"},{id:"inventory_history",name:"View Stock History",description:"View stock movement history"}]},customers:{label:"Customer Management",permissions:[{id:"customers_view",name:"View Customers",description:"View customer information"},{id:"customers_add",name:"Add Customers",description:"Create new customers"},{id:"customers_edit",name:"Edit Customers",description:"Modify customer details"},{id:"customers_delete",name:"Delete Customers",description:"Remove customers"},{id:"customers_history",name:"View Customer History",description:"View customer purchase history"}]},devices:{label:"Device & Repair Management",permissions:[{id:"devices_view",name:"View Devices",description:"View device repairs"},{id:"devices_add",name:"Add Devices",description:"Register new device repairs"},{id:"devices_edit",name:"Edit Devices",description:"Modify device repair information"},{id:"spare_parts",name:"Spare Parts",description:"Manage spare parts inventory"}]},financial:{label:"Financial Operations",permissions:[{id:"sales_process",name:"Process Sales",description:"Complete sales transactions"},{id:"sales_refund",name:"Process Refunds",description:"Issue refunds to customers"},{id:"sales_discount",name:"Apply Discounts",description:"Apply discounts to sales"},{id:"financial_reports",name:"Financial Reports",description:"View financial reports"},{id:"pricing_manage",name:"Manage Pricing",description:"Set and modify product prices"},{id:"payments_view",name:"View Payments",description:"View payment transactions"}]},users:{label:"User Management",permissions:[{id:"users_view",name:"View Users",description:"View user accounts"},{id:"users_create",name:"Create Users",description:"Create new user accounts"},{id:"users_edit",name:"Edit Users",description:"Modify user accounts"},{id:"users_delete",name:"Delete Users",description:"Remove user accounts"},{id:"roles_manage",name:"Manage Roles",description:"Manage user roles and permissions"}]},system:{label:"System Administration",permissions:[{id:"audit_logs",name:"View Audit Logs",description:"View system audit logs"},{id:"backup_data",name:"Backup Data",description:"Create data backups"},{id:"restore_data",name:"Restore Data",description:"Restore from backups"},{id:"integrations",name:"Manage Integrations",description:"Configure system integrations"},{id:"database_setup",name:"Database Setup",description:"Manage database configuration"}]},features:{label:"Additional Features",permissions:[{id:"appointments",name:"Appointments",description:"Manage appointments"},{id:"whatsapp",name:"WhatsApp Integration",description:"Use WhatsApp features"},{id:"sms",name:"SMS Features",description:"Send SMS messages"},{id:"loyalty",name:"Loyalty Program",description:"Manage loyalty programs"},{id:"employees",name:"Employee Management",description:"Manage employee records"}]}},xe={admin:["all"],manager:["dashboard","pos","reports","inventory_view","inventory_add","inventory_edit","inventory_adjust","inventory_history","customers_view","customers_add","customers_edit","customers_history","devices_view","devices_add","devices_edit","sales_process","sales_refund","sales_discount","financial_reports","payments_view","employees"],technician:["dashboard","devices_view","devices_add","devices_edit","spare_parts","customers_view","inventory_view"],"customer-care":["dashboard","pos","customers_view","customers_add","customers_edit","customers_history","devices_view","devices_add","appointments","whatsapp","sms"],"store-keeper":["dashboard","inventory_view","inventory_adjust","inventory_history","reports"],user:["dashboard","inventory_view","customers_view"]},ys=ze({firstName:z().min(2,"First name must be at least 2 characters"),lastName:z().min(2,"Last name must be at least 2 characters"),email:z().email("Invalid email address"),username:z().min(3,"Username must be at least 3 characters").optional(),phone:z().optional(),role:Ve(["admin","manager","technician","customer-care","store-keeper","user"]),department:z().optional(),password:z().min(8,"Password must be at least 8 characters"),confirmPassword:z(),accessAllBranches:ye().optional(),assignedBranches:ue(z()).optional(),permissions:ue(z()).optional(),customPermissions:ye().optional()}).refine(s=>s.password===s.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),js=({isOpen:s,onClose:r,onSubmit:n,loading:l=!1})=>{var W;const[h,y]=f.useState(!1),[g,S]=f.useState(!1),[R,w]=f.useState([]),[E,M]=f.useState(!1),[q,se]=f.useState(!1);De(s);const{control:k,handleSubmit:J,formState:{errors:v,isDirty:G},reset:X,watch:K,setValue:A}=Be({resolver:Fe(ys),defaultValues:{firstName:"",lastName:"",email:"",username:"",phone:"",role:"user",department:"",password:"",confirmPassword:"",accessAllBranches:!1,assignedBranches:[],permissions:[],customPermissions:!1}}),m=K();f.useEffect(()=>{if(m.role&&!m.customPermissions){const i=xe[m.role]||[];A("permissions",i,{shouldDirty:!0})}},[m.role,m.customPermissions,A]),f.useEffect(()=>{s&&Q()},[s]);const Q=async()=>{M(!0);try{const i=await es();w(i)}catch(i){console.error("Error loading branches:",i),p.error("Failed to load branches")}finally{M(!1)}},U=i=>{const x=m.assignedBranches||[];x.includes(i)?A("assignedBranches",x.filter(I=>I!==i),{shouldDirty:!0}):A("assignedBranches",[...x,i],{shouldDirty:!0})},ae=i=>{const x=m.permissions||[];x.includes(i)?A("permissions",x.filter(I=>I!==i),{shouldDirty:!0}):A("permissions",[...x,i],{shouldDirty:!0})},$=i=>{const x=m.permissions||[];if(i.every(ee=>x.includes(ee)))A("permissions",x.filter(ee=>!i.includes(ee)),{shouldDirty:!0});else{const ee=[...new Set([...x,...i])];A("permissions",ee,{shouldDirty:!0})}},o=i=>(m.permissions||[]).includes(i),b=i=>i.every(x=>o(x)),c=[{value:"admin",label:"Administrator",description:"Full system access"},{value:"manager",label:"Manager",description:"Department management"},{value:"technician",label:"Technician",description:"Device repairs"},{value:"customer-care",label:"Customer Care",description:"Customer support"},{value:"store-keeper",label:"Store Keeper",description:"Inventory and stock management"},{value:"user",label:"User",description:"Basic access"}],P=[{value:"IT",label:"IT Department"},{value:"Sales",label:"Sales Department"},{value:"Service",label:"Service Department"},{value:"Support",label:"Support Department"},{value:"Marketing",label:"Marketing Department"},{value:"Finance",label:"Finance Department"},{value:"HR",label:"Human Resources"},{value:"Operations",label:"Operations"}],j=async i=>{try{await n(i),X(),r()}catch(x){console.error("User creation error:",x)}},ie=()=>{G?confirm("Are you sure you want to cancel? Your changes will be lost.")&&(X(),r()):r()},Z=i=>{const x=c.find(I=>I.value===i);return(x==null?void 0:x.description)||""};return s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed bg-black/50",onClick:r,style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:35}}),e.jsx("div",{className:"fixed flex items-center justify-center p-4",style:{left:"var(--sidebar-width, 0px)",top:"var(--topbar-height, 64px)",right:0,bottom:0,zIndex:50,pointerEvents:"none"},children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:i=>i.stopPropagation(),style:{pointerEvents:"auto"},children:e.jsxs("form",{onSubmit:J(j),className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(Ue,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Create New User"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Add a new user to the system"})]})]}),e.jsx("button",{type:"button",onClick:ie,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(we,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"User Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"firstName",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"First Name",placeholder:"Enter first name",value:i.value,onChange:i.onChange,error:(x=v.firstName)==null?void 0:x.message,required:!0,icon:e.jsx(ne,{size:16})})}}),e.jsx(L,{name:"lastName",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Last Name",placeholder:"Enter last name",value:i.value,onChange:i.onChange,error:(x=v.lastName)==null?void 0:x.message,required:!0,icon:e.jsx(ne,{size:16})})}})]}),e.jsx(L,{name:"email",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Email Address",type:"email",placeholder:"user@company.com",value:i.value,onChange:i.onChange,error:(x=v.email)==null?void 0:x.message,required:!0,icon:e.jsx(Ge,{size:16})})}}),e.jsx(L,{name:"username",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Username",type:"text",placeholder:"username",value:i.value,onChange:i.onChange,error:(x=v.username)==null?void 0:x.message,icon:e.jsx(ne,{size:16}),helperText:"Used for login (optional)"})}}),e.jsx(L,{name:"phone",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Phone Number",type:"tel",placeholder:"+255 123 456 789",value:i.value,onChange:i.onChange,error:(x=v.phone)==null?void 0:x.message,icon:e.jsx(Re,{size:16})})}})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Role & Department"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"role",control:k,render:({field:i})=>{var x;return e.jsx(te,{label:"Role",placeholder:"Select role",value:i.value,onChange:i.onChange,error:(x=v.role)==null?void 0:x.message,options:c,required:!0,icon:e.jsx(re,{size:16})})}}),e.jsx(L,{name:"department",control:k,render:({field:i})=>{var x;return e.jsx(te,{label:"Department",placeholder:"Select department",value:i.value,onChange:i.onChange,error:(x=v.department)==null?void 0:x.message,options:P,clearable:!0})}})]}),m.role&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Role Description:"})," ",Z(m.role)]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(Me,{size:20}),"Permissions & Access Control"]}),e.jsxs("button",{type:"button",onClick:()=>se(!q),className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:[q?"Hide":"Show"," Permissions"]})]}),e.jsx("div",{className:"flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-200",children:e.jsx("div",{className:"flex-1",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m.customPermissions,onChange:i=>{if(A("customPermissions",i.target.checked,{shouldDirty:!0}),!i.target.checked&&m.role){const x=xe[m.role]||[];A("permissions",x,{shouldDirty:!0})}},className:"w-4 h-4 text-amber-600 bg-gray-100 border-gray-300 rounded focus:ring-amber-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Custom Permissions"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Override role defaults with custom permissions"})]})]})})}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Selected Permissions: ",(m.permissions||[]).length]}),e.jsx("p",{className:"text-xs text-gray-500",children:m.customPermissions?"Custom permissions configured":`Using ${m.role} role defaults`})]}),o("all")&&e.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(ce,{size:16}),e.jsx("span",{className:"text-sm font-medium",children:"Full Access"})]})]})}),q&&e.jsxs("div",{className:"space-y-4 border-2 border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Configure Permissions"}),!o("all")&&e.jsx("button",{type:"button",onClick:()=>A("permissions",["all"],{shouldDirty:!0}),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Grant Full Access"})]}),o("all")?e.jsxs("div",{className:"p-6 bg-green-50 rounded-lg border border-green-200 text-center",children:[e.jsx(ce,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-green-900",children:"Full Access Granted"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"This user has complete access to all system features"}),e.jsx("button",{type:"button",onClick:()=>{const i=xe[m.role]||[];A("permissions",i,{shouldDirty:!0})},className:"mt-3 text-xs text-green-700 hover:text-green-800 font-medium underline",children:"Revoke Full Access"})]}):e.jsx("div",{className:"space-y-4",children:Object.entries(ss).map(([i,x])=>{const I=x.permissions.map(H=>H.id),ee=b(I);return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1",children:[e.jsx("input",{type:"checkbox",checked:ee,onChange:()=>$(I),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"font-medium text-sm text-gray-900",children:x.label})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[I.filter(H=>o(H)).length,"/",I.length]})]}),e.jsx("div",{className:"ml-6 space-y-2",children:x.permissions.map(H=>e.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:o(H.id),onChange:()=>ae(H.id),disabled:H.id==="all"&&m.role!=="admin",className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800",children:H.name}),e.jsx("div",{className:"text-xs text-gray-500",children:H.description})]})]},H.id))})]},i)})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(He,{size:20}),"Branch Access"]}),e.jsx("div",{className:"flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200",children:e.jsx("div",{className:"flex-1",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m.accessAllBranches,onChange:i=>{A("accessAllBranches",i.target.checked,{shouldDirty:!0}),i.target.checked&&A("assignedBranches",[],{shouldDirty:!0})},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Access All Branches"}),e.jsx("p",{className:"text-xs text-gray-600",children:"User can access and manage all branches/stores"})]})]})})}),!m.accessAllBranches&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Assigned Branches"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3",children:E?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"Loading branches..."}):R.length===0?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"No branches available"}):R.map(i=>e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${(m.assignedBranches||[]).includes(i.id)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:[e.jsx("input",{type:"checkbox",checked:(m.assignedBranches||[]).includes(i.id),onChange:()=>U(i.id),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Je,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-900",children:i.name}),i.is_main&&e.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded",children:"Main"})]}),e.jsxs("p",{className:"text-xs text-gray-500 ml-6",children:[i.city," â€¢ ",i.code]})]})]},i.id))}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Selected: ",(m.assignedBranches||[]).length," branch(es)"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Password"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"password",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Password",type:h?"text":"password",placeholder:"Enter password",value:i.value,onChange:i.onChange,error:(x=v.password)==null?void 0:x.message,required:!0,rightIcon:h?e.jsx(me,{size:16}):e.jsx(je,{size:16}),onRightIconClick:()=>y(!h),helperText:"Minimum 8 characters"})}}),e.jsx(L,{name:"confirmPassword",control:k,render:({field:i})=>{var x;return e.jsx(T,{label:"Confirm Password",type:g?"text":"password",placeholder:"Confirm password",value:i.value,onChange:i.onChange,error:(x=v.confirmPassword)==null?void 0:x.message,required:!0,rightIcon:g?e.jsx(me,{size:16}):e.jsx(je,{size:16}),onRightIconClick:()=>S(!g)})}})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 font-medium mb-2",children:"Password Requirements:"}),e.jsxs("ul",{className:"text-xs text-gray-500 space-y-1",children:[e.jsx("li",{children:"â€¢ Minimum 8 characters"}),e.jsx("li",{children:"â€¢ Should include uppercase and lowercase letters"}),e.jsx("li",{children:"â€¢ Should include numbers"}),e.jsx("li",{children:"â€¢ Should include special characters"})]})]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"User Preview"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Name:"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[m.firstName," ",m.lastName]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Email:"}),e.jsx("p",{className:"font-medium text-gray-900",children:m.email||"Not provided"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Username:"}),e.jsx("p",{className:"font-medium text-gray-900",children:m.username||"Not set"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Role:"}),e.jsx("p",{className:"font-medium text-gray-900",children:((W=c.find(i=>i.value===m.role))==null?void 0:W.label)||"Not selected"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Department:"}),e.jsx("p",{className:"font-medium text-gray-900",children:m.department||"Not assigned"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Permissions:"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[(m.permissions||[]).length," selected",o("all")&&e.jsx("span",{className:"ml-2 text-green-600",children:"(Full Access)"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Branch Access:"}),e.jsx("p",{className:"font-medium text-gray-900",children:m.accessAllBranches?"All Branches":`${(m.assignedBranches||[]).length} branch(es)`})]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{type:"button",onClick:ie,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:!G||l,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:l?"Creating...":"Create User"})]})]})})})]}):null},bs=ze({firstName:z().min(2,"First name must be at least 2 characters"),lastName:z().min(2,"Last name must be at least 2 characters"),email:z().email("Invalid email address"),username:z().min(3,"Username must be at least 3 characters").optional(),phone:z().optional(),role:Ve(["admin","manager","technician","customer-care","user"]),department:z().optional(),isActive:ye().optional(),password:z().optional(),confirmPassword:z().optional(),permissions:ue(z()).optional(),accessAllBranches:ye().optional(),assignedBranches:ue(z()).optional()}).refine(s=>s.password&&s.password.length>0?s.password===s.confirmPassword&&s.password.length>=8:!0,{message:"Passwords must match and be at least 8 characters",path:["confirmPassword"]}),vs=({isOpen:s,onClose:r,onSubmit:n,user:l,loading:h=!1})=>{var pe;const[y,g]=f.useState(!0),[S,R]=f.useState(!1),[w,E]=f.useState(!1),[M,q]=f.useState(!1),[se,k]=f.useState([]),[J,v]=f.useState(!1),[G,X]=f.useState([]),[K,A]=f.useState(!1),[m,Q]=f.useState(!1);De(s);const{control:U,handleSubmit:ae,formState:{errors:$,isDirty:o},reset:b,watch:c,setValue:P}=Be({resolver:Fe(bs),defaultValues:{firstName:"",lastName:"",email:"",username:"",phone:"",role:"user",department:"",isActive:!0,password:"",confirmPassword:"",permissions:[],accessAllBranches:!1,assignedBranches:[]}}),j=c();f.useEffect(()=>{l&&(b({firstName:l.firstName||"",lastName:l.lastName||"",email:l.email||"",username:l.username||"",phone:l.phone||"",role:l.role||"user",department:l.department||"",isActive:l.status==="active",password:"",confirmPassword:"",permissions:l.permissions||[],accessAllBranches:!1,assignedBranches:[]}),g(l.status==="active"),q(!1),Z(l.id))},[l,b]),f.useEffect(()=>{s&&ie()},[s]);const ie=async()=>{v(!0);try{const t=await es();k(t)}catch(t){console.error("Error loading branches:",t),p.error("Failed to load branches")}finally{v(!1)}},Z=async t=>{try{const O=(await Ze(t)).map(a=>a.branch_id);X(O),P("assignedBranches",O),P("accessAllBranches",O.length===0)}catch(d){console.error("Error loading user branch assignments:",d)}},W=t=>{const d=j.assignedBranches||[];d.includes(t)?P("assignedBranches",d.filter(O=>O!==t),{shouldDirty:!0}):P("assignedBranches",[...d,t],{shouldDirty:!0})},i=t=>{const d=j.permissions||[];d.includes(t)?P("permissions",d.filter(O=>O!==t),{shouldDirty:!0}):P("permissions",[...d,t],{shouldDirty:!0})},x=t=>{const d=j.permissions||[];if(t.every(a=>d.includes(a)))P("permissions",d.filter(a=>!t.includes(a)),{shouldDirty:!0});else{const a=[...new Set([...d,...t])];P("permissions",a,{shouldDirty:!0})}},I=t=>(j.permissions||[]).includes(t),ee=t=>t.every(d=>I(d)),H=[{value:"admin",label:"Administrator",description:"Full system access"},{value:"manager",label:"Manager",description:"Department management"},{value:"technician",label:"Technician",description:"Device repairs"},{value:"customer-care",label:"Customer Care",description:"Customer support"},{value:"user",label:"User",description:"Basic access"}],Ce=[{value:"IT",label:"IT Department"},{value:"Sales",label:"Sales Department"},{value:"Service",label:"Service Department"},{value:"Support",label:"Support Department"},{value:"Marketing",label:"Marketing Department"},{value:"Finance",label:"Finance Department"},{value:"HR",label:"Human Resources"},{value:"Operations",label:"Operations"}],Se=[{value:"all",label:"All Permissions",description:"Full system access"},{value:"inventory",label:"Inventory Management",description:"Manage stock and products"},{value:"customers",label:"Customer Management",description:"Manage customer data"},{value:"reports",label:"Reports & Analytics",description:"View reports"},{value:"employees",label:"Employee Management",description:"Manage employees"},{value:"devices",label:"Device Management",description:"Manage devices"},{value:"spare-parts",label:"Spare Parts",description:"Manage spare parts"},{value:"appointments",label:"Appointments",description:"Manage appointments"},{value:"basic",label:"Basic Access",description:"Limited access"}],oe=async t=>{try{const d={...t,isActive:y};(!t.password||t.password.length===0)&&(delete d.password,delete d.confirmPassword),await n(d),r()}catch(d){console.error("User update error:",d)}},he=()=>{o?confirm("Are you sure you want to cancel? Your changes will be lost.")&&(b(),r()):r()},ke=t=>{const d=H.find(O=>O.value===t);return(d==null?void 0:d.description)||""},de=t=>(j.permissions||[]).includes(t);return!s||!l?null:e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:r,children:e.jsx(V,{className:"max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:t=>t.stopPropagation(),children:e.jsxs("form",{onSubmit:ae(oe),className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:e.jsx(cs,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit User"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Update user information and settings"})]})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:he,icon:e.jsx(we,{size:20})})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"User Status"}),e.jsx("p",{className:"text-xs text-gray-500",children:y?"User can access the system":"User is blocked from accessing the system"})]}),e.jsx("button",{type:"button",onClick:()=>g(!y),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${y?"bg-green-600":"bg-red-400"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${y?"translate-x-6":"translate-x-1"}`})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"User Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"firstName",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"First Name",placeholder:"Enter first name",value:t.value,onChange:t.onChange,error:(d=$.firstName)==null?void 0:d.message,required:!0,icon:e.jsx(ne,{size:16})})}}),e.jsx(L,{name:"lastName",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"Last Name",placeholder:"Enter last name",value:t.value,onChange:t.onChange,error:(d=$.lastName)==null?void 0:d.message,required:!0,icon:e.jsx(ne,{size:16})})}})]}),e.jsx(L,{name:"email",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"Email Address",type:"email",placeholder:"user@company.com",value:t.value,onChange:t.onChange,error:(d=$.email)==null?void 0:d.message,required:!0,icon:e.jsx(Ge,{size:16})})}}),e.jsx(L,{name:"username",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"Username",type:"text",placeholder:"username",value:t.value,onChange:t.onChange,error:(d=$.username)==null?void 0:d.message,icon:e.jsx(ne,{size:16}),helperText:"Used for login"})}}),e.jsx(L,{name:"phone",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"Phone Number",type:"tel",placeholder:"+255 123 456 789",value:t.value,onChange:t.onChange,error:(d=$.phone)==null?void 0:d.message,icon:e.jsx(Re,{size:16})})}})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Role & Department"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"role",control:U,render:({field:t})=>{var d;return e.jsx(te,{label:"Role",placeholder:"Select role",value:t.value,onChange:t.onChange,error:(d=$.role)==null?void 0:d.message,options:H,required:!0,icon:e.jsx(re,{size:16})})}}),e.jsx(L,{name:"department",control:U,render:({field:t})=>{var d;return e.jsx(te,{label:"Department",placeholder:"Select department",value:t.value,onChange:t.onChange,error:(d=$.department)==null?void 0:d.message,options:Ce,clearable:!0})}})]}),j.role&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Role Description:"})," ",ke(j.role)]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(Me,{size:20}),"Permissions & Access Control"]}),e.jsxs("button",{type:"button",onClick:()=>A(!K),className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:[K?"Hide":"Show"," Permissions"]})]}),e.jsx("div",{className:"flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-200",children:e.jsx("div",{className:"flex-1",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:t=>{if(Q(t.target.checked),!t.target.checked&&j.role){const d=xe[j.role]||[];P("permissions",d,{shouldDirty:!0})}},className:"w-4 h-4 text-amber-600 bg-gray-100 border-gray-300 rounded focus:ring-amber-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Custom Permissions"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Override role defaults with custom permissions"})]})]})})}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:["Selected Permissions: ",(j.permissions||[]).length]}),e.jsx("p",{className:"text-xs text-gray-500",children:m?"Custom permissions configured":`Using ${j.role} role defaults`})]}),I("all")&&e.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(ce,{size:16}),e.jsx("span",{className:"text-sm font-medium",children:"Full Access"})]})]})}),K&&e.jsxs("div",{className:"space-y-4 border-2 border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Configure Permissions"}),!I("all")&&e.jsx("button",{type:"button",onClick:()=>P("permissions",["all"],{shouldDirty:!0}),className:"text-xs text-blue-600 hover:text-blue-700 font-medium",children:"Grant Full Access"})]}),I("all")?e.jsxs("div",{className:"p-6 bg-green-50 rounded-lg border border-green-200 text-center",children:[e.jsx(ce,{className:"w-12 h-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium text-green-900",children:"Full Access Granted"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"This user has complete access to all system features"}),e.jsx("button",{type:"button",onClick:()=>{const t=xe[j.role]||[];P("permissions",t,{shouldDirty:!0})},className:"mt-3 text-xs text-green-700 hover:text-green-800 font-medium underline",children:"Revoke Full Access"})]}):e.jsx("div",{className:"space-y-4",children:Object.entries(ss).map(([t,d])=>{const O=d.permissions.map(u=>u.id),a=ee(O);return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1",children:[e.jsx("input",{type:"checkbox",checked:a,onChange:()=>x(O),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("span",{className:"font-medium text-sm text-gray-900",children:d.label})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[O.filter(u=>I(u)).length,"/",O.length]})]}),e.jsx("div",{className:"ml-6 space-y-2",children:d.permissions.map(u=>e.jsxs("label",{className:"flex items-start gap-2 cursor-pointer p-2 rounded hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:I(u.id),onChange:()=>i(u.id),disabled:u.id==="all"&&j.role!=="admin",className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800",children:u.name}),e.jsx("div",{className:"text-xs text-gray-500",children:u.description})]})]},u.id))})]},t)})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Password Reset"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Leave blank to keep current password"})]}),e.jsx(N,{type:"button",variant:"secondary",size:"sm",icon:M?e.jsx(me,{size:16}):e.jsx(os,{size:16}),onClick:()=>q(!M),children:M?"Hide":"Change Password"})]}),M&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-200",children:[e.jsx(L,{name:"password",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"New Password",type:S?"text":"password",placeholder:"Enter new password",value:t.value,onChange:t.onChange,error:(d=$.password)==null?void 0:d.message,icon:S?e.jsx(me,{size:16}):e.jsx(je,{size:16}),onIconClick:()=>R(!S),helperText:"Minimum 8 characters"})}}),e.jsx(L,{name:"confirmPassword",control:U,render:({field:t})=>{var d;return e.jsx(T,{label:"Confirm New Password",type:w?"text":"password",placeholder:"Confirm new password",value:t.value,onChange:t.onChange,error:(d=$.confirmPassword)==null?void 0:d.message,icon:w?e.jsx(me,{size:16}):e.jsx(je,{size:16}),onIconClick:()=>E(!w)})}}),e.jsxs("div",{className:"md:col-span-2 p-3 bg-yellow-50 rounded-lg border border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Password Requirements:"}),e.jsxs("ul",{className:"text-xs text-yellow-700 space-y-1",children:[e.jsx("li",{children:"â€¢ Minimum 8 characters"}),e.jsx("li",{children:"â€¢ Should include uppercase and lowercase letters"}),e.jsx("li",{children:"â€¢ Should include numbers"}),e.jsx("li",{children:"â€¢ Should include special characters"})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(He,{size:20}),"Branch Access"]}),e.jsx("div",{className:"flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200",children:e.jsx("div",{className:"flex-1",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:j.accessAllBranches,onChange:t=>{P("accessAllBranches",t.target.checked,{shouldDirty:!0}),t.target.checked&&P("assignedBranches",[],{shouldDirty:!0})},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Access All Branches"}),e.jsx("p",{className:"text-xs text-gray-600",children:"User can access and manage all branches/stores"})]})]})})}),!j.accessAllBranches&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Assigned Branches"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3",children:J?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"Loading branches..."}):se.length===0?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"No branches available"}):se.map(t=>e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${(j.assignedBranches||[]).includes(t.id)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:[e.jsx("input",{type:"checkbox",checked:(j.assignedBranches||[]).includes(t.id),onChange:()=>W(t.id),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Je,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-900",children:t.name}),t.is_main&&e.jsx("span",{className:"px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded",children:"Main"})]}),e.jsxs("p",{className:"text-xs text-gray-500 ml-6",children:[t.city," â€¢ ",t.code]})]})]},t.id))}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Selected: ",(j.assignedBranches||[]).length," branch(es)"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Permissions"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Select specific permissions for this user"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Se.map(t=>e.jsx("div",{onClick:()=>i(t.value),className:`p-3 rounded-lg border-2 cursor-pointer transition-all ${de(t.value)?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`mt-0.5 ${de(t.value)?"text-blue-600":"text-gray-400"}`,children:e.jsx(Ke,{size:20})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:t.label}),e.jsx("p",{className:"text-xs text-gray-500",children:t.description})]})]})},t.value))}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:(j.permissions||[]).length})," permission(s) selected"]})})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"Updated User Preview"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Name:"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[j.firstName," ",j.lastName]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Status:"}),e.jsx("p",{className:`font-medium ${y?"text-green-600":"text-red-600"}`,children:y?"Active":"Inactive"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Email:"}),e.jsx("p",{className:"font-medium text-gray-900",children:j.email||"Not provided"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Username:"}),e.jsx("p",{className:"font-medium text-gray-900",children:j.username||"Not set"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Role:"}),e.jsx("p",{className:"font-medium text-gray-900",children:((pe=H.find(t=>t.value===j.role))==null?void 0:pe.label)||"Not selected"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Department:"}),e.jsx("p",{className:"font-medium text-gray-900",children:j.department||"Not assigned"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Phone:"}),e.jsx("p",{className:"font-medium text-gray-900",children:j.phone||"Not provided"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Permissions:"}),e.jsxs("p",{className:"font-medium text-gray-900",children:[(j.permissions||[]).length," selected"]})]}),j.password&&j.password.length>0&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("p",{className:"text-gray-600",children:"Password:"}),e.jsx("p",{className:"font-medium text-orange-600",children:"Will be changed âœ“"})]})]})]}),e.jsxs("div",{className:"pt-6 border-t border-gray-200 flex gap-3",children:[e.jsx(N,{type:"button",variant:"secondary",onClick:he,className:"flex-1",children:"Cancel"}),e.jsx(N,{type:"submit",variant:"primary",loading:h,disabled:!o&&y===(l.status==="active"),className:"flex-1",icon:e.jsx(We,{size:20}),children:h?"Saving Changes...":"Save Changes"})]})]})})})},Ns=ze({name:z().min(2,"Role name must be at least 2 characters"),description:z().min(5,"Description must be at least 5 characters"),permissions:ue(z()).min(1,"Select at least one permission")}),ws=({isOpen:s,onClose:r,roles:n,onRoleCreate:l,onRoleUpdate:h,onRoleDelete:y})=>{const[g,S]=f.useState(!1),[R,w]=f.useState(null),[E,M]=f.useState(null);De(s);const{control:q,handleSubmit:se,formState:{errors:k},reset:J,setValue:v,watch:G}=Be({resolver:Fe(Ns),defaultValues:{name:"",description:"",permissions:[]}}),X=G("permissions"),K=[{value:"all",label:"All Permissions",description:"Complete system access",icon:"ðŸ”“"},{value:"inventory",label:"Inventory Management",description:"Manage stock and products",icon:"ðŸ“¦"},{value:"customers",label:"Customer Management",description:"Manage customer data",icon:"ðŸ‘¥"},{value:"reports",label:"Reports & Analytics",description:"View and generate reports",icon:"ðŸ“Š"},{value:"employees",label:"Employee Management",description:"Manage team members",icon:"ðŸ‘”"},{value:"devices",label:"Device Management",description:"Manage devices and equipment",icon:"ðŸ“±"},{value:"spare-parts",label:"Spare Parts",description:"Manage spare parts inventory",icon:"âš™ï¸"},{value:"appointments",label:"Appointments",description:"Schedule and manage appointments",icon:"ðŸ“…"},{value:"pos",label:"Point of Sale",description:"Access POS system",icon:"ðŸ’°"},{value:"sms",label:"SMS Messaging",description:"Send SMS messages",icon:"ðŸ’¬"},{value:"settings",label:"System Settings",description:"Configure system settings",icon:"âš™ï¸"},{value:"users",label:"User Management",description:"Manage users and permissions",icon:"ðŸ”"},{value:"basic",label:"Basic Access",description:"Limited system access",icon:"ðŸ‘¤"}],A=()=>{S(!0),w(null),J({name:"",description:"",permissions:[]})},m=o=>{w(o),S(!1),J({name:o.name,description:o.description,permissions:o.permissions})},Q=async o=>{try{R?(await(h==null?void 0:h(R.id,o)),p.success("Role updated successfully")):(await(l==null?void 0:l(o)),p.success("Role created successfully")),S(!1),w(null),J()}catch(b){console.error("Role save error:",b),p.error(b.message||"Failed to save role")}},U=async o=>{const b=n.find(c=>c.id===o);if(b){if(b.userCount>0){p.error(`Cannot delete role with ${b.userCount} assigned user(s)`);return}if(confirm(`Are you sure you want to delete the "${b.name}" role?`))try{await(y==null?void 0:y(o)),p.success("Role deleted successfully"),(E==null?void 0:E.id)===o&&M(null)}catch(c){console.error("Role deletion error:",c),p.error(c.message||"Failed to delete role")}}},ae=o=>{const b=X||[];b.includes(o)?v("permissions",b.filter(c=>c!==o),{shouldDirty:!0}):v("permissions",[...b,o],{shouldDirty:!0})},$=o=>(X||[]).includes(o);return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:r,children:e.jsxs(V,{className:"max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(re,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"Role Management"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Create and manage user roles and permissions"})]})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:r,icon:e.jsx(we,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 p-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Existing Roles"}),e.jsx(N,{onClick:A,size:"sm",icon:e.jsx(be,{size:16}),className:"bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"New Role"})]}),e.jsxs("div",{className:"space-y-3",children:[n.map(o=>e.jsxs(V,{className:`p-4 cursor-pointer transition-all hover:shadow-md ${(E==null?void 0:E.id)===o.id?"ring-2 ring-purple-500 bg-purple-50":""}`,onClick:()=>M(o),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(re,{size:18,className:"text-purple-600"}),e.jsx("h4",{className:"font-semibold text-gray-900",children:o.name})]}),e.jsx("p",{className:"text-sm text-gray-600",children:o.description})]}),e.jsxs("div",{className:"flex gap-1 ml-2",children:[e.jsx("button",{onClick:b=>{b.stopPropagation(),m(o)},className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"Edit role",children:e.jsx(Ye,{size:16})}),o.userCount===0&&e.jsx("button",{onClick:b=>{b.stopPropagation(),U(o.id)},className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete role",children:e.jsx(Pe,{size:16})})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(ve,{size:14}),e.jsxs("span",{children:[o.userCount," user",o.userCount!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(Ke,{size:14}),e.jsxs("span",{children:[o.permissions.length," permission",o.permissions.length!==1?"s":""]})]})]}),(E==null?void 0:E.id)===o.id&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200",children:[e.jsx("p",{className:"text-xs font-medium text-gray-700 mb-2",children:"Permissions:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:o.permissions.map(b=>{const c=K.find(P=>P.value===b);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs",children:[e.jsx("span",{children:(c==null?void 0:c.icon)||"â€¢"}),e.jsx("span",{children:(c==null?void 0:c.label)||b})]},b)})})]})]},o.id)),n.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(re,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600",children:"No custom roles yet"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Create your first role to get started"})]})]})]}),e.jsx("div",{children:g||R?e.jsxs("form",{onSubmit:se(Q),className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(re,{className:"text-purple-600",size:20}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:R?"Edit Role":"Create New Role"})]}),e.jsx(L,{name:"name",control:q,render:({field:o})=>{var b;return e.jsx(T,{label:"Role Name",placeholder:"e.g., Store Manager, Sales Rep",value:o.value,onChange:o.onChange,error:(b=k.name)==null?void 0:b.message,required:!0,icon:e.jsx(re,{size:16})})}}),e.jsx(L,{name:"description",control:q,render:({field:o})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Description ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:o.value,onChange:o.onChange,placeholder:"Describe what this role does...",className:"w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none",rows:3}),k.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:k.description.message})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["Permissions ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto pr-2",children:K.map(o=>e.jsx("div",{onClick:()=>ae(o.value),className:`p-3 rounded-lg border-2 cursor-pointer transition-all ${$(o.value)?"border-purple-500 bg-purple-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`mt-0.5 transition-colors ${$(o.value)?"text-purple-600":"text-gray-400"}`,children:$(o.value)?e.jsx(ds,{size:20}):e.jsx("div",{className:"w-5 h-5 rounded border-2 border-current"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:o.icon}),e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:o.label})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:o.description})]})]})},o.value))}),k.permissions&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:k.permissions.message}),e.jsx("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:(X||[]).length})," permission(s) selected"]})})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[e.jsx(N,{type:"button",variant:"secondary",onClick:()=>{S(!1),w(null),J()},className:"flex-1",children:"Cancel"}),e.jsx(N,{type:"submit",variant:"primary",className:"flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white",icon:e.jsx(We,{size:18}),children:R?"Update Role":"Create Role"})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(re,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Select a role or create a new one"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"Choose a role from the list to view details, or create a new role"}),e.jsx(N,{onClick:A,icon:e.jsx(be,{size:18}),className:"bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"Create New Role"})]})})})]})}),e.jsx("div",{className:"border-t border-gray-200 p-4 bg-gray-50",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Qe,{size:16,className:"text-yellow-600"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Note:"})," Roles with assigned users cannot be deleted. Reassign users before deleting a role."]})]})})]})}):null},Ne=s=>Array.isArray(s)?s.map(Ne):s!==null&&s.constructor===Object?Object.keys(s).reduce((r,n)=>{const l=n.replace(/_([a-z])/g,(h,y)=>y.toUpperCase());return r[l]=Ne(s[n]),r},{}):s;async function Cs(s,r){try{const{data:n,error:l}=await _.from("users").select("id, email, full_name").eq("id",s).single();if(l||!n)return p.error("User not found"),!1;const{data:h,error:y}=await _.from("employees").select("id, email, user_id, first_name, last_name").eq("id",r).single();if(y||!h)return p.error("Employee not found"),!1;if(h.user_id&&h.user_id!==s)return p.error("Employee already linked to another user"),!1;const{error:g}=await _.from("employees").update({user_id:s,updated_at:new Date().toISOString()}).eq("id",r);if(g)throw g;const S=`${h.first_name} ${h.last_name}`;return p.success(`Linked ${n.full_name} to ${S}`),!0}catch(n){return console.error("Error linking user to employee:",n),p.error(n.message||"Failed to link user and employee"),!1}}async function Ss(s){try{const{error:r}=await _.from("employees").update({user_id:null,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw r;return p.success("Unlinked user from employee"),!0}catch(r){return console.error("Error unlinking user from employee:",r),p.error(r.message||"Failed to unlink"),!1}}async function ks(s,r){try{const{data:n,error:l}=await _.from("users").select("id, email, full_name, phone").eq("id",s).single();if(l||!n)return p.error("User not found"),null;const{data:h}=await _.from("employees").select("id").eq("user_id",s).maybeSingle();if(h)return p("Employee record already exists for this user",{icon:"â„¹ï¸"}),h.id;const y=(n.full_name||"Unknown User").split(" "),g=y[0]||"Unknown",S=y.slice(1).join(" ")||"User";return(await ps.createEmployee({userId:n.id,firstName:g,lastName:S,email:n.email,phone:n.phone||"",position:r.position,department:r.department,hireDate:r.hireDate||new Date().toISOString().split("T")[0],salary:r.salary||0,currency:"TZS",status:"active",employmentType:"full-time",performanceRating:3,skills:null})).id}catch(n){return console.error("Error creating employee for user:",n),p.error(n.message||"Failed to create employee record"),null}}async function _s(){try{const{data:s,error:r}=await _.from("users").select("id, email").eq("is_active",!0);if(r)throw r;const{data:n,error:l}=await _.from("employees").select("id, email, user_id").is("user_id",null);if(l)throw l;let h=0,y=0,g=0;for(const S of n||[])try{const R=s==null?void 0:s.find(w=>w.email.toLowerCase()===S.email.toLowerCase());if(R){const{error:w}=await _.from("employees").update({user_id:R.id,updated_at:new Date().toISOString()}).eq("id",S.id);w?g++:h++}else y++}catch{g++}return h>0&&p.success(`Linked ${h} users to employees`),g>0&&p.error(`${g} errors occurred during linking`),{linked:h,skipped:y,errors:g}}catch(s){return console.error("Error auto-linking users and employees:",s),p.error(s.message||"Failed to auto-link"),{linked:0,skipped:0,errors:0}}}async function As(){try{const{data:s,error:r}=await _.from("employees").select(`
        id,
        user_id,
        first_name,
        last_name,
        email,
        position,
        department,
        created_at,
        users:users!user_id (
          id,
          email,
          full_name,
          role
        )
      `).not("user_id","is",null);if(r)throw r;return(s||[]).map(l=>{var h,y,g;return{userId:l.user_id,employeeId:l.id,userName:((h=l.users)==null?void 0:h.full_name)||"Unknown",userEmail:((y=l.users)==null?void 0:y.email)||"",userRole:((g=l.users)==null?void 0:g.role)||"",employeeName:`${l.first_name} ${l.last_name}`||"Unknown",employeeEmail:l.email,employeePosition:l.position,employeeDepartment:l.department,linkedAt:l.created_at}})}catch(s){return s!=null&&s.code&&s.code!=="PGRST116"&&s.code!=="42P01"&&console.warn("User-employee links unavailable"),[]}}async function Es(){try{const{data:s,error:r}=await _.from("users").select("id, email, full_name, role, is_active").eq("is_active",!0);if(r)throw r;const{data:n,error:l}=await _.from("employees").select("user_id").not("user_id","is",null);if(l)throw l;const h=new Set((n||[]).map(g=>g.user_id));return(s||[]).filter(g=>!h.has(g.id)).map(Ne)}catch(s){return s!=null&&s.code&&s.code!=="PGRST116"&&s.code!=="42P01"&&console.warn("Unlinked users query unavailable"),[]}}async function Us(){try{const{data:s,error:r}=await _.from("employees").select("id, email, first_name, last_name, position, status").is("user_id",null).eq("status","active");if(r)throw r;return(s||[]).map(n=>({...Ne(n),fullName:`${n.first_name} ${n.last_name}`}))}catch(s){return console.error("Error getting unlinked employees:",s),[]}}const Ps=({isOpen:s,onClose:r,onLinksUpdated:n})=>{const[l,h]=f.useState("linked"),[y,g]=f.useState(!0),[S,R]=f.useState([]),[w,E]=f.useState([]),[M,q]=f.useState([]),[se,k]=f.useState(!1),[J,v]=f.useState(""),[G,X]=f.useState(""),[K,A]=f.useState(!1),[m,Q]=f.useState({userId:"",position:"",department:"",salary:0});f.useEffect(()=>{s&&U()},[s]);const U=async()=>{g(!0);try{const[c,P,j]=await Promise.all([As(),Es(),Us()]);R(c),E(P),q(j)}catch{console.warn("User-employee link feature not available")}finally{g(!1)}},ae=async()=>{k(!0);try{const c=await _s();p.success(`Auto-link complete: ${c.linked} linked, ${c.skipped} skipped, ${c.errors} errors`),await U(),n==null||n()}catch{p.error("Auto-link failed")}finally{k(!1)}},$=async()=>{if(!J||!G){p.error("Please select both user and employee");return}await Cs(J,G)&&(v(""),X(""),await U(),n==null||n())},o=async c=>{confirm("Are you sure you want to unlink this user from the employee record?")&&await Ss(c)&&(await U(),n==null||n())},b=async()=>{if(!m.userId||!m.position||!m.department){p.error("Please fill in all required fields");return}await ks(m.userId,{position:m.position,department:m.department,salary:m.salary||0})&&(A(!1),Q({userId:"",position:"",department:"",salary:0}),await U(),n==null||n())};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",onClick:r,children:e.jsxs(V,{className:"max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(fe,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"User-Employee Links"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Manage relationships between user accounts and employee records"})]})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:r,icon:e.jsx(we,{size:20})})]}),e.jsxs("div",{className:"flex gap-4 px-6 pt-4 border-b border-gray-200",children:[e.jsx("button",{onClick:()=>h("linked"),className:`pb-3 px-2 font-medium transition-colors ${l==="linked"?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{size:18}),e.jsxs("span",{children:["Linked (",S.length,")"]})]})}),e.jsx("button",{onClick:()=>h("unlinked"),className:`pb-3 px-2 font-medium transition-colors ${l==="unlinked"?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{size:18}),e.jsxs("span",{children:["Unlinked (",w.length+M.length,")"]})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:y?e.jsxs("div",{className:"flex items-center justify-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading..."})]}):l==="linked"?e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid gap-4",children:S.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(fe,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Linked Accounts"}),e.jsx("p",{className:"text-gray-500 mb-6",children:"Users and employees are not yet linked"}),e.jsx(N,{onClick:()=>h("unlinked"),icon:e.jsx(Ie,{size:18}),children:"Link Users and Employees"})]}):S.map(c=>e.jsx(V,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(ne,{size:20,className:"text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:c.userName}),e.jsx("p",{className:"text-sm text-gray-600",children:c.userEmail}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Role: ",c.userRole]})]})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(Ie,{className:"text-blue-600",size:24})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ge,{size:20,className:"text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:c.employeeName}),e.jsx("p",{className:"text-sm text-gray-600",children:c.employeePosition}),e.jsx("p",{className:"text-xs text-gray-500",children:c.employeeDepartment})]})]})]}),e.jsx(N,{onClick:()=>o(c.employeeId),variant:"ghost",size:"sm",icon:e.jsx(ms,{size:16}),className:"text-red-600 hover:text-red-700",children:"Unlink"})]})},c.employeeId))})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(V,{className:"p-6 bg-gradient-to-r from-blue-50 to-indigo-50",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Auto-Link by Email"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Automatically link users to employees by matching email addresses. This will only link accounts with exact email matches."}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4 text-orange-600"}),e.jsxs("span",{children:[w.length," unlinked users"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-purple-600"}),e.jsxs("span",{children:[M.length," unlinked employees"]})]})]})]}),e.jsx(N,{onClick:ae,loading:se,icon:e.jsx(xs,{size:18}),className:"bg-gradient-to-r from-blue-500 to-indigo-600 text-white",children:"Run Auto-Link"})]})}),e.jsxs(V,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Manual Link"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsx(te,{label:"Select User",value:J,onChange:v,options:[{value:"",label:"Choose a user..."},...w.map(c=>({value:c.id,label:`${c.firstName} ${c.lastName} (${c.email})`}))],icon:e.jsx(ne,{size:16})}),e.jsx(te,{label:"Select Employee",value:G,onChange:X,options:[{value:"",label:"Choose an employee..."},...M.map(c=>({value:c.id,label:`${c.firstName} ${c.lastName} - ${c.position}`}))],icon:e.jsx(ge,{size:16})}),e.jsx(N,{onClick:$,disabled:!J||!G,icon:e.jsx(fe,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Link"})]})]}),e.jsxs(V,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Create Employee for User"}),!K&&e.jsx(N,{onClick:()=>A(!0),variant:"secondary",size:"sm",icon:e.jsx(Ue,{size:16}),children:"Create Employee"})]}),K&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(te,{label:"Select User",value:m.userId,onChange:c=>Q({...m,userId:c}),options:[{value:"",label:"Choose a user..."},...w.map(c=>({value:c.id,label:`${c.firstName} ${c.lastName} (${c.email})`}))],required:!0}),e.jsx(T,{label:"Position",value:m.position,onChange:c=>Q({...m,position:c.target.value}),placeholder:"e.g. Sales Manager",required:!0}),e.jsx(T,{label:"Department",value:m.department,onChange:c=>Q({...m,department:c.target.value}),placeholder:"e.g. Sales",required:!0}),e.jsx(T,{label:"Salary (optional)",type:"number",value:m.salary,onChange:c=>Q({...m,salary:parseFloat(c.target.value)||0}),placeholder:"0"})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[e.jsx(N,{onClick:()=>{A(!1),Q({userId:"",position:"",department:"",salary:0})},variant:"secondary",className:"flex-1",children:"Cancel"}),e.jsx(N,{onClick:b,icon:e.jsx(Ue,{size:18}),className:"flex-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:"Create Employee"})]})]})]}),w.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:["Unlinked Users (",w.length,")"]}),e.jsxs("div",{className:"grid gap-3",children:[w.slice(0,5).map(c=>e.jsx(V,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-orange-100 rounded",children:e.jsx(ne,{size:18,className:"text-orange-600"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[c.firstName," ",c.lastName]}),e.jsx("p",{className:"text-sm text-gray-600",children:c.email})]})]}),e.jsx("span",{className:"text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded",children:"No employee record"})]})},c.id)),w.length>5&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["... and ",w.length-5," more"]})]})]}),M.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:["Unlinked Employees (",M.length,")"]}),e.jsxs("div",{className:"grid gap-3",children:[M.slice(0,5).map(c=>e.jsx(V,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded",children:e.jsx(ge,{size:18,className:"text-purple-600"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[c.firstName," ",c.lastName]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[c.position," â€¢ ",c.department]})]})]}),e.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded",children:"No user account"})]})},c.id)),M.length>5&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["... and ",M.length-5," more"]})]})]})]})}),e.jsxs("div",{className:"border-t border-gray-200 p-4 bg-gray-50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx($e,{size:16,className:"text-yellow-600"}),e.jsx("p",{children:"Linking users to employees enables attendance tracking and employee self-service features"})]}),e.jsx(N,{onClick:U,variant:"secondary",size:"sm",icon:e.jsx(Xe,{size:16}),children:"Refresh"})]})]})}):null};async function zs(){try{const{data:s,error:r}=await _.from("users").select("*").order("created_at",{ascending:!1});if(r)throw console.error("Error fetching users:",r),new Error(`Failed to fetch users: ${r.message}`);return s||[]}catch(s){throw console.error("Error in fetchAllUsers:",s),s}}async function Bs(s){try{const{data:r,error:n}=await _.from("users").select("*").eq("id",s).single();if(n)throw console.error("Error fetching user:",n),new Error(`Failed to fetch user: ${n.message}`);return r}catch(r){return console.error("Error in fetchUserById:",r),null}}async function Fs(s){var r;try{const n=`${s.firstName} ${s.lastName}`,l=s.permissions&&s.permissions.length>0?s.permissions:rs(s.role),h=s.username||s.email.split("@")[0],{data:y,error:g}=await _.from("users").insert([{email:s.email,password:s.password,full_name:n,username:h,role:s.role,phone:s.phone||null,department:s.department||null,permissions:l,is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(g)throw console.error("Error creating user:",g),new Error(`Failed to create user: ${g.message}`);return y}catch(n){throw console.error("Error in createUser:",n),(r=n.message)!=null&&r.includes("duplicate key value")||n.code==="23505"?new Error("A user with this email already exists"):n}}async function Rs(s,r){var n;try{const l={updated_at:new Date().toISOString()};if(r.firstName||r.lastName){const g=await Bs(s);if(g){const S=((n=g.full_name)==null?void 0:n.split(" "))||["",""],R=r.firstName||S[0],w=r.lastName||S[1];l.full_name=`${R} ${w}`}}r.email&&(l.email=r.email),r.username&&(l.username=r.username),r.password&&(l.password=r.password),r.role&&(l.role=r.role,r.permissions||(l.permissions=rs(r.role))),r.permissions&&(l.permissions=r.permissions),r.phone!==void 0&&(l.phone=r.phone),r.department!==void 0&&(l.department=r.department),r.is_active!==void 0&&(l.is_active=r.is_active);const{data:h,error:y}=await _.from("users").update(l).eq("id",s).select().single();if(y)throw console.error("Error updating user:",y),new Error(`Failed to update user: ${y.message}`);try{const g={updated_at:new Date().toISOString()};r.username&&(g.username=r.username),r.email&&(g.email=r.email),l.full_name&&(g.name=l.full_name),r.role&&(g.role=r.role),r.is_active!==void 0&&(g.is_active=r.is_active),r.permissions&&(g.permissions=r.permissions),await _.from("auth_users").update(g).eq("id",s),console.log("âœ… Synced user update to auth_users table")}catch{console.log("â„¹ï¸ auth_users table not found or not used (this is normal for single-table setups)")}return h}catch(l){throw console.error("Error in updateUser:",l),l}}async function Ms(s){try{const{error:r}=await _.from("users").delete().eq("id",s);if(r)throw console.error("Error deleting user:",r),new Error(`Failed to delete user: ${r.message}`)}catch(r){throw console.error("Error in deleteUser:",r),r}}async function Ds(s,r){try{const{data:n,error:l}=await _.from("users").update({is_active:r,updated_at:new Date().toISOString()}).eq("id",s).select().single();if(l)throw console.error("Error toggling user status:",l),new Error(`Failed to toggle user status: ${l.message}`);return n}catch(n){throw console.error("Error in toggleUserStatus:",n),n}}async function qe(s,r){try{const{error:n}=await _.from("users").update({is_active:r,updated_at:new Date().toISOString()}).in("id",s);if(n)throw console.error("Error bulk updating users:",n),new Error(`Failed to bulk update users: ${n.message}`)}catch(n){throw console.error("Error in bulkUpdateUserStatus:",n),n}}async function $s(s){try{const{error:r}=await _.from("users").delete().in("id",s);if(r)throw console.error("Error bulk deleting users:",r),new Error(`Failed to bulk delete users: ${r.message}`)}catch(r){throw console.error("Error in bulkDeleteUsers:",r),r}}function rs(s){switch(s){case"admin":return["all"];case"manager":return["inventory","customers","reports","employees"];case"technician":return["devices","spare-parts"];case"customer-care":return["customers","appointments"];case"store-keeper":return["inventory","stock","purchase-orders","reports"];case"user":return["basic"];default:return["basic"]}}function Is(s){if(!s)return{firstName:"",lastName:""};const r=s.trim().split(" "),n=r[0]||"",l=r.slice(1).join(" ")||"";return{firstName:n,lastName:l}}function Oe(s){const{firstName:r,lastName:n}=Is(s.full_name);return{id:s.id,email:s.email,username:s.username,firstName:r,lastName:n,role:s.role,status:s.is_active?"active":"inactive",lastLogin:s.last_login,createdAt:s.created_at,phone:s.phone,department:s.department,permissions:s.permissions||[]}}const rr=()=>{const{currentUser:s}=ts();fs();const{startLoading:r,completeLoading:n,failLoading:l}=ns(),[h,y]=f.useState([]),[g,S]=f.useState([]),[R,w]=f.useState(!0),[E,M]=f.useState(""),[q,se]=f.useState("all"),[k,J]=f.useState("all"),[v,G]=f.useState([]),[X,K]=f.useState(!1),[A,m]=f.useState(!1),[Q,U]=f.useState(!1),[ae,$]=f.useState(!1),[o,b]=f.useState(null),[c,P]=f.useState(!1),[j,ie]=f.useState(!1);f.useEffect(()=>{Z()},[]);const Z=async()=>{const a=r("Loading users...");w(!0);try{const u=await zs(),B=await Promise.all(u.map(async Y=>{try{const le=(await Ze(Y.id)).map(as=>as.branch_id);return{...Oe(Y),assignedBranches:le,accessAllBranches:le.length===0}}catch(F){return console.error(`Error loading branches for user ${Y.id}:`,F),{...Oe(Y),assignedBranches:[],accessAllBranches:!0}}}));y(B);const C=new Map;u.forEach(Y=>{const F=C.get(Y.role)||0;C.set(Y.role,F+1)});const D=[{id:"admin",name:"Administrator",description:"Full system access and control",permissions:["all"],userCount:C.get("admin")||0},{id:"manager",name:"Manager",description:"Department management and reporting",permissions:["inventory","customers","reports","employees"],userCount:C.get("manager")||0},{id:"technician",name:"Technician",description:"Device repair",permissions:["devices","spare-parts"],userCount:C.get("technician")||0},{id:"customer-care",name:"Customer Care",description:"Customer support and service",permissions:["customers","appointments"],userCount:C.get("customer-care")||0},{id:"user",name:"User",description:"Basic system access",permissions:["basic"],userCount:C.get("user")||0}];S(D),n(a)}catch(u){console.error("Error loading users:",u),l(a,"Failed to load users"),p.error("Failed to load users")}finally{w(!1)}},W=h.filter(a=>{var D,Y;const u=!E||a.firstName.toLowerCase().includes(E.toLowerCase())||a.lastName.toLowerCase().includes(E.toLowerCase())||a.email.toLowerCase().includes(E.toLowerCase())||((D=a.username)==null?void 0:D.toLowerCase().includes(E.toLowerCase()))||((Y=a.department)==null?void 0:Y.toLowerCase().includes(E.toLowerCase())),B=q==="all"||a.role===q,C=k==="all"||a.status===k;return u&&B&&C}),i={totalUsers:h.length,activeUsers:h.filter(a=>a.status==="active").length,pendingUsers:h.filter(a=>a.status==="pending").length,inactiveUsers:h.filter(a=>a.status==="inactive").length},x=()=>{K(!0)},I=async a=>{P(!0);try{const u=await Fs(a);if(!a.accessAllBranches&&a.assignedBranches&&a.assignedBranches.length>0){const B=a.assignedBranches.map((C,D)=>({branch_id:C,is_primary:D===0,can_manage:!1,can_view_reports:!0,can_manage_inventory:!1,can_manage_staff:!1}));await Ee(u.id,B,s==null?void 0:s.id)}p.success("User created successfully with branch assignments"),await Z(),K(!1)}catch(u){throw console.error("Error creating user:",u),p.error(u.message||"Failed to create user"),u}finally{P(!1)}},ee=a=>{b(a),m(!0)},H=async a=>{if(o){ie(!0);try{const u={firstName:a.firstName,lastName:a.lastName,email:a.email,username:a.username,role:a.role,phone:a.phone,department:a.department,is_active:a.isActive,permissions:a.permissions};if(await Rs(o.id,u),!a.accessAllBranches&&a.assignedBranches&&a.assignedBranches.length>0){const B=a.assignedBranches.map((C,D)=>({branch_id:C,is_primary:D===0,can_manage:!1,can_view_reports:!0,can_manage_inventory:!1,can_manage_staff:!1}));await Ee(o.id,B,s==null?void 0:s.id)}else a.accessAllBranches&&await Ee(o.id,[],s==null?void 0:s.id);p.success("User updated successfully with branch assignments"),await Z(),m(!1),b(null)}catch(u){throw console.error("Error updating user:",u),p.error(u.message||"Failed to update user"),u}finally{ie(!1)}}},Ce=async a=>{if(confirm("Are you sure you want to delete this user? This action cannot be undone."))try{await Ms(a),p.success("User deleted successfully"),await Z()}catch(u){console.error("Error deleting user:",u),p.error(u.message||"Failed to delete user")}},Se=async a=>{try{const u=h.find(B=>B.id===a);if(u){const B=u.status!=="active";await Ds(a,B),p.success(`User ${B?"activated":"deactivated"} successfully`),await Z()}}catch(u){console.error("Error toggling user status:",u),p.error(u.message||"Failed to update user status")}},oe=async a=>{if(v.length===0){p.error("Please select users first");return}try{switch(a){case"activate":await qe(v,!0),p.success(`${v.length} users activated`);break;case"deactivate":await qe(v,!1),p.success(`${v.length} users deactivated`);break;case"delete":if(confirm(`Are you sure you want to delete ${v.length} users?`))await $s(v),p.success(`${v.length} users deleted`);else return;break;default:p.error("Unknown action");return}G([]),await Z()}catch(u){console.error("Error performing bulk action:",u),p.error(u.message||"Failed to perform action")}},he=a=>{switch(a){case"admin":return"bg-red-100 text-red-800";case"manager":return"bg-blue-100 text-blue-800";case"technician":return"bg-green-100 text-green-800";case"customer-care":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},ke=a=>{switch(a){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";case"pending":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},de=a=>new Date(a).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),pe=()=>{try{const a=["ID","First Name","Last Name","Email","Username","Phone","Role","Department","Status","Created At","Last Login"],u=W.map(F=>[F.id,F.firstName,F.lastName,F.email,F.username||"",F.phone||"",F.role,F.department||"",F.status,F.createdAt,F.lastLogin||""]),B=[a.join(","),...u.map(F=>F.map(le=>`"${le}"`).join(","))].join(`
`),C=new Blob([B],{type:"text/csv;charset=utf-8;"}),D=document.createElement("a"),Y=URL.createObjectURL(C);D.setAttribute("href",Y),D.setAttribute("download",`users_export_${new Date().toISOString().split("T")[0]}.csv`),D.style.visibility="hidden",document.body.appendChild(D),D.click(),document.body.removeChild(D),p.success(`Exported ${W.length} users to CSV`)}catch(a){console.error("Export error:",a),p.error("Failed to export users")}},t=()=>{try{const a={exportDate:new Date().toISOString(),totalUsers:W.length,users:W},u=JSON.stringify(a,null,2),B=new Blob([u],{type:"application/json"}),C=document.createElement("a"),D=URL.createObjectURL(B);C.setAttribute("href",D),C.setAttribute("download",`users_export_${new Date().toISOString().split("T")[0]}.json`),C.style.visibility="hidden",document.body.appendChild(C),C.click(),document.body.removeChild(C),p.success(`Exported ${W.length} users to JSON`)}catch(a){console.error("Export error:",a),p.error("Failed to export users")}},d=a=>{var C;const u=(C=a.target.files)==null?void 0:C[0];if(!u)return;const B=new FileReader;B.onload=async D=>{var Y;try{const F=(Y=D.target)==null?void 0:Y.result,le=JSON.parse(F),_e=le.users||le;if(!Array.isArray(_e))throw new Error("Invalid file format");p.success(`Ready to import ${_e.length} users. Feature coming soon!`)}catch(F){console.error("Import error:",F),p.error("Failed to import users. Please check file format.")}},B.readAsText(u),a.target.value=""},O=()=>{p.promise(Z(),{loading:"Refreshing users...",success:"Users refreshed successfully",error:"Failed to refresh users"})};return R?e.jsx("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:e.jsx(gs,{})}):e.jsxs("div",{className:"p-4 sm:p-6 max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ls,{to:"/dashboard"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"User Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage users, roles, and permissions"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(N,{onClick:O,variant:"secondary",icon:e.jsx(Xe,{size:18}),title:"Refresh users list",children:"Refresh"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".json",onChange:d,className:"hidden",id:"import-users"}),e.jsx("label",{htmlFor:"import-users",children:e.jsx(N,{variant:"secondary",icon:e.jsx(us,{size:18}),as:"span",children:"Import"})})]}),e.jsxs("div",{className:"relative group",children:[e.jsx(N,{variant:"secondary",icon:e.jsx(Ae,{size:18}),children:"Export"}),e.jsxs("div",{className:"hidden group-hover:block absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10",children:[e.jsxs("button",{onClick:pe,className:"w-full text-left px-4 py-2 hover:bg-gray-50 rounded-t-lg flex items-center gap-2",children:[e.jsx(Ae,{size:16}),e.jsx("span",{children:"Export as CSV"})]}),e.jsxs("button",{onClick:t,className:"w-full text-left px-4 py-2 hover:bg-gray-50 rounded-b-lg flex items-center gap-2",children:[e.jsx(Ae,{size:16}),e.jsx("span",{children:"Export as JSON"})]})]})]}),e.jsx(N,{onClick:()=>$(!0),variant:"secondary",icon:e.jsx(fe,{size:18}),title:"Link users to employee records",children:"User-Employee Links"}),e.jsx(N,{onClick:()=>U(!0),variant:"secondary",icon:e.jsx(re,{size:18}),children:"Manage Roles"}),e.jsx(N,{onClick:x,icon:e.jsx(be,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Add User"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(V,{className:"bg-gradient-to-br from-blue-50 to-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-600",children:"Total Users"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:i.totalUsers})]}),e.jsx(ve,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx(V,{className:"bg-gradient-to-br from-green-50 to-green-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"Active Users"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:i.activeUsers})]}),e.jsx(Le,{className:"w-8 h-8 text-green-600"})]})}),e.jsx(V,{className:"bg-gradient-to-br from-purple-50 to-purple-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Admins"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:h.filter(a=>a.role==="admin").length}),e.jsx("p",{className:"text-xs text-purple-500",children:"Full Access"})]}),e.jsx(re,{className:"w-8 h-8 text-purple-600"})]})}),e.jsx(V,{className:"bg-gradient-to-br from-red-50 to-red-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-600",children:"Inactive Users"}),e.jsx("p",{className:"text-2xl font-bold text-red-900",children:i.inactiveUsers})]}),e.jsx(Te,{className:"w-8 h-8 text-red-600"})]})})]}),e.jsx(V,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(is,{onSearch:M,placeholder:"Search users by name, email, username, or department...",className:"w-full",suggestions:h.map(a=>`${a.firstName} ${a.lastName}`),searchKey:"user_management_search"})}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(te,{options:[{value:"all",label:"All Roles"},{value:"admin",label:"Administrator"},{value:"manager",label:"Manager"},{value:"technician",label:"Technician"},{value:"customer-care",label:"Customer Care"},{value:"user",label:"User"}],value:q,onChange:se,placeholder:"Filter by Role",className:"min-w-[150px]"}),e.jsx(te,{options:[{value:"all",label:"All Status"},{value:"active",label:"Active"},{value:"inactive",label:"Inactive"},{value:"pending",label:"Pending"}],value:k,onChange:J,placeholder:"Filter by Status",className:"min-w-[150px]"})]})]})}),v.length>0&&e.jsx(V,{className:"p-4 bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-800 font-medium",children:[v.length," user(s) selected"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:()=>oe("activate"),variant:"secondary",size:"sm",icon:e.jsx(Le,{size:16}),children:"Activate"}),e.jsx(N,{onClick:()=>oe("deactivate"),variant:"secondary",size:"sm",icon:e.jsx(Te,{size:16}),children:"Deactivate"}),e.jsx(N,{onClick:()=>oe("delete"),variant:"danger",size:"sm",icon:e.jsx(Pe,{size:16}),children:"Delete"})]})]})}),e.jsxs(V,{className:"p-6",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:e.jsx("input",{type:"checkbox",checked:v.length===W.length&&W.length>0,onChange:a=>{a.target.checked?G(W.map(u=>u.id)):G([])},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"User"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Role & Status"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Branch Access"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Permissions"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Last Activity"}),e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-900",children:"Actions"})]})}),e.jsx("tbody",{children:W.map(a=>{var u,B;return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4",children:e.jsx("input",{type:"checkbox",checked:v.includes(a.id),onChange:C=>{C.target.checked?G([...v,a.id]):G(v.filter(D=>D!==a.id))},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0",children:e.jsxs("span",{className:"text-white font-semibold text-sm",children:[(u=a.firstName)==null?void 0:u[0],(B=a.lastName)==null?void 0:B[0]]})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"font-medium text-gray-900 truncate",children:[a.firstName," ",a.lastName]}),e.jsx("p",{className:"text-sm text-gray-500 truncate",children:a.email}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[a.username&&e.jsxs("span",{className:"text-xs text-gray-400 font-mono",children:["@",a.username]}),a.phone&&e.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[e.jsx(Re,{size:10}),a.phone]})]})]})]})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${he(a.role)}`,children:a.role.replace("-"," ")}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${ke(a.status)}`,children:a.status})}),a.department&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:a.department})]})}),e.jsx("td",{className:"py-3 px-4",children:a.accessAllBranches===!0?e.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(ce,{size:14}),e.jsx("span",{className:"text-xs font-medium",children:"All Branches"})]}):a.assignedBranches&&a.assignedBranches.length>0?e.jsx("div",{className:"text-xs",children:e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium",children:[a.assignedBranches.length," ",a.assignedBranches.length===1?"Branch":"Branches"]})}):e.jsxs("span",{className:"text-xs text-yellow-600 flex items-center gap-1",children:[e.jsx(Qe,{size:12}),"No access"]})}),e.jsx("td",{className:"py-3 px-4",children:a.permissions&&a.permissions.length>0?a.permissions.includes("all")?e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium",children:"Full Access âœ“"})}):e.jsx("div",{children:e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium cursor-help",title:a.permissions.join(", "),children:[a.permissions.length," permission",a.permissions.length!==1?"s":""]})}):e.jsx("span",{className:"text-gray-400 italic text-xs",children:"None"})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"text-sm",children:[a.lastLogin?e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-900 font-medium",children:de(a.lastLogin)}),e.jsx("div",{className:"text-xs text-gray-500",children:"Last login"})]}):e.jsx("div",{children:e.jsx("div",{className:"text-gray-400 italic",children:"Not logged in"})}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Created: ",de(a.createdAt)]})]})}),e.jsx("td",{className:"py-3 px-4",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(N,{onClick:()=>ee(a),variant:"ghost",size:"sm",icon:e.jsx(Ye,{size:14}),title:"Edit user"}),e.jsx(N,{onClick:()=>Se(a.id),variant:"ghost",size:"sm",icon:a.status==="active"?e.jsx(Me,{size:14}):e.jsx(hs,{size:14}),title:a.status==="active"?"Deactivate":"Activate",className:a.status==="active"?"text-orange-600":"text-green-600"}),e.jsx(N,{onClick:()=>Ce(a.id),variant:"ghost",size:"sm",icon:e.jsx(Pe,{size:14}),className:"text-red-600 hover:text-red-700",title:"Delete user"})]})})]},a.id)})})]})}),W.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ve,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No users found"}),e.jsx("p",{className:"text-gray-500 mb-6",children:E||q!=="all"||k!=="all"?"Try adjusting your search or filters":"Get started by adding your first user"}),!E&&q==="all"&&k==="all"&&e.jsx(N,{onClick:x,icon:e.jsx(be,{size:18}),className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:"Add Your First User"})]})]}),e.jsx(js,{isOpen:X,onClose:()=>K(!1),onSubmit:I,loading:c}),e.jsx(vs,{isOpen:A,onClose:()=>{m(!1),b(null)},onSubmit:H,user:o,loading:j}),e.jsx(ws,{isOpen:Q,onClose:()=>U(!1),roles:g,onRoleCreate:async a=>{p.success("Role creation API coming soon!")},onRoleUpdate:async(a,u)=>{p.success("Role update API coming soon!")},onRoleDelete:async a=>{p.success("Role deletion API coming soon!")}}),e.jsx(Ps,{isOpen:ae,onClose:()=>$(!1),onLinksUpdated:()=>Z()})]})};export{rr as default};
