import{r as c}from"./vendor-36d2c7c1.js";class T{constructor(){this.device=null,this.server=null,this.service=null,this.characteristic=null,this.isConnected=!1,this.settings={paperWidth:80,printCopies:1,autoConnect:!1,connectionTimeout:1e4,labelHeight:25,dpi:203,defaultPrintType:"receipt"}}async initialize(){try{return navigator.bluetooth?(this.loadSettings(),!0):(console.warn("ℹ️ Bluetooth printing not available in this browser. Use Chrome/Edge on HTTPS for Bluetooth support."),!1)}catch(e){return console.error("Failed to initialize Bluetooth printer service:",e),!1}}async requestDevice(){try{const e=await navigator.bluetooth.requestDevice({filters:[{services:["000018f0-0000-1000-8000-00805f9b34fb"]},{namePrefix:"Printer"},{namePrefix:"Thermal"},{namePrefix:"Receipt"},{namePrefix:"POS"},{namePrefix:"ESC"},{namePrefix:"Star"},{namePrefix:"Citizen"},{namePrefix:"Epson"},{namePrefix:"Zebra"}],optionalServices:["000018f0-0000-1000-8000-00805f9b34fb","000018f1-0000-1000-8000-00805f9b34fb","000018f2-0000-1000-8000-00805f9b34fb"]});this.device=e,e.addEventListener("gattserverdisconnected",()=>{this.handleDisconnection()});const n=e.name||"";let o="thermal",t=80,s=25,g=203;return n.toLowerCase().includes("xp-p301a")||n.toLowerCase().includes("xprinter")?(o="receipt",t=80,s=25,g=203):n.toLowerCase().includes("label")||n.toLowerCase().includes("zebra")?(o="label",t=50,s=25,g=203):(n.toLowerCase().includes("receipt")||n.toLowerCase().includes("thermal"))&&(o="receipt",t=80),[{id:e.id,name:e.name||"Unknown Printer",address:e.id,connected:!1,type:o,paperWidth:t,labelHeight:s,dpi:g,supportedCommands:o==="label"?["text","barcode","qr","image"]:n.toLowerCase().includes("xp-p301a")?["text","barcode","qr","cut","feed","label"]:["text","cut","feed"]}]}catch(e){throw console.error("Failed to request Bluetooth device:",e),e}}async connect(e){var n;try{if(!this.device&&e){const o=await navigator.bluetooth.getDevices();if(this.device=o.find(t=>t.id===e)||null,!this.device)throw new Error("Device not found. Please pair the printer first.")}if(!this.device)throw new Error("No device selected");if(console.log("Connecting to printer:",this.device.name),this.server=await((n=this.device.gatt)==null?void 0:n.connect()),!this.server)throw new Error("Failed to connect to GATT server");if(this.service=await this.server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb"),!this.service)throw new Error("Printer service not found");if(this.characteristic=await this.service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb"),!this.characteristic)throw new Error("Printer characteristic not found");return this.isConnected=!0,console.log("Successfully connected to printer"),this.saveConnectedDevice(),!0}catch(o){throw console.error("Failed to connect to printer:",o),this.isConnected=!1,o}}async disconnect(){try{this.server&&this.server.connected&&await this.server.disconnect(),this.device=null,this.server=null,this.service=null,this.characteristic=null,this.isConnected=!1,console.log("Disconnected from printer")}catch(e){console.error("Error disconnecting from printer:",e)}}async print(e){try{if(console.log("Print job received:",e),console.log("Is connected:",this.isConnected),console.log("Characteristic exists:",!!this.characteristic),!this.isConnected||!this.characteristic)throw new Error("Printer not connected");const{content:n,commands:o=[],copies:t=1,paperWidth:s=this.settings.paperWidth,labelHeight:g=this.settings.labelHeight,dpi:f=this.settings.dpi,printType:a=this.settings.defaultPrintType}=e;let h="";a==="label"?h+=this.generateLabelCommands(n,s,g,f):(console.log("Adding ESC/POS commands..."),h+="\x1B@",console.log("Added initialize command (ESC @)"),h+=n,console.log("Added content:",n),h+=`




`,console.log("Added paper feed"));const v=new TextEncoder().encode(h);console.log("Print data length:",v.length),console.log("Print data preview:",h.substring(0,100)+"...");for(let p=0;p<t;p++)console.log(`Sending copy ${p+1}/${t}...`),await this.characteristic.writeValue(v),console.log(`Copy ${p+1} sent successfully`),t>1&&p<t-1&&await new Promise(m=>setTimeout(m,500));return console.log("Print job completed successfully"),!0}catch(n){throw console.error("Failed to print:",n),n}}generateLabelCommands(e,n,o,t){const s=h=>Math.round(h*t/25.4),g=s(n),f=s(o);let a="";return a+="\x1B@",a+="\x1BiM@",a+=`\x1BiA${String.fromCharCode(g&255)}${String.fromCharCode(g>>8&255)}`,a+=`\x1BiQ${String.fromCharCode(f&255)}${String.fromCharCode(f>>8&255)}`,a+="\x1Bia",a+="\x1Bi!\0",a+=e,a+="\x1BiM\0",a+="\x1BiM",a}async printReceipt(e){try{const{paperWidth:n=this.settings.paperWidth}=this.settings,o=Math.floor(n/8);let t="";return t+="\x1Ba",t+=e.header+`
`,t+="=".repeat(o)+`
`,t+="\x1Ba\0",e.items.forEach(s=>{const g=`${s.name}
`,f=`  ${s.quantity} x ${this.formatMoney(s.price)} = ${this.formatMoney(s.total)}
`;t+=g+f}),t+=`
`+"=".repeat(o)+`
`,t+=`Subtotal: ${this.formatMoney(e.subtotal)}
`,e.tax>0&&(t+=`Tax: ${this.formatMoney(e.tax)}
`),e.discount>0&&(t+=`Discount: -${this.formatMoney(e.discount)}
`),t+=`TOTAL: ${this.formatMoney(e.total)}
`,t+="=".repeat(o)+`
`,t+=`Payment: ${e.paymentMethod}
`,t+=`Cashier: ${e.cashier}
`,t+=`Date: ${new Date().toLocaleString()}
`,t+=`
\x1Ba`,t+=e.footer+`
`,await this.print({content:t,copies:this.settings.printCopies})}catch(n){throw console.error("Failed to print receipt:",n),n}}async printLabel(e){try{const{paperWidth:n=this.settings.paperWidth,labelHeight:o=this.settings.labelHeight}=this.settings;let t="";if(e.title&&(t+="\x1Bi!",t+=e.title+`
`),e.barcode&&(t+="\x1Bb",t+=e.barcode,t+="\x1Bb\0",t+=`
`),e.qrCode&&(t+="\x1Bq",t+=e.qrCode,t+="\x1Bq\0",t+=`
`),e.text&&(t+="\x1Bi!\0",t+=e.text+`
`),e.price&&(t+="\x1Bi!",t+=`Price: ${e.price}
`),e.sku&&(t+=`SKU: ${e.sku}
`),e.size||e.color){const s=[];e.size&&s.push(`Size: ${e.size}`),e.color&&s.push(`Color: ${e.color}`),t+=s.join(" | ")+`
`}return e.customFields&&e.customFields.forEach(s=>{t+=`${s.label}: ${s.value}
`}),await this.print({content:t,copies:this.settings.printCopies,printType:"label",paperWidth:n,labelHeight:o})}catch(n){throw console.error("Failed to print label:",n),n}}isPrinterConnected(){var e;return this.isConnected&&((e=this.server)==null?void 0:e.connected)===!0}getConnectedDevice(){return!this.device||!this.isConnected?null:{id:this.device.id,name:this.device.name||"Unknown Printer",address:this.device.id,connected:this.isConnected,type:"thermal",paperWidth:this.settings.paperWidth,supportedCommands:["text","cut","feed"]}}updateSettings(e){this.settings={...this.settings,...e},this.saveSettings()}getSettings(){return{...this.settings}}handleDisconnection(){console.log("Printer disconnected"),this.isConnected=!1,this.server=null,this.service=null,this.characteristic=null,this.settings.autoConnect&&this.device&&setTimeout(()=>{this.connect().catch(e=>{console.error("Auto-reconnect failed:",e)})},2e3)}saveSettings(){try{localStorage.setItem("bluetoothPrinterSettings",JSON.stringify(this.settings))}catch(e){console.error("Failed to save printer settings:",e)}}loadSettings(){try{const e=localStorage.getItem("bluetoothPrinterSettings");e&&(this.settings={...this.settings,...JSON.parse(e)})}catch(e){console.error("Failed to load printer settings:",e)}}saveConnectedDevice(){try{this.device&&localStorage.setItem("connectedPrinterDevice",this.device.id)}catch(e){console.error("Failed to save connected device:",e)}}formatMoney(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"TZS",minimumFractionDigits:0}).format(e)}}const u=new T,z=()=>{const[y,e]=c.useState(!1),[n,o]=c.useState(!1),[t,s]=c.useState(!1),[g,f]=c.useState(!1),[a,h]=c.useState(null),[w,v]=c.useState([]),[p,m]=c.useState({paperWidth:80,printCopies:1,autoConnect:!1,connectionTimeout:1e4,labelHeight:25,dpi:203,defaultPrintType:"receipt"}),[b,l]=c.useState(null),C=c.useCallback(async()=>{try{l(null);const r=await u.initialize();if(e(r),r){const i=u.getSettings();m(i);const d=u.getConnectedDevice();d&&(h(d),o(!0))}return r}catch(r){const i=r instanceof Error?r.message:"Failed to initialize Bluetooth printer service";return i.includes("not supported")||l(i),!1}},[]),x=c.useCallback(async()=>{try{l(null),s(!0);const r=await u.requestDevice();v(r),r.length===1&&await S(r[0].id)}catch(r){const i=r instanceof Error?r.message:"Failed to request Bluetooth device";l(i)}finally{s(!1)}},[]),S=c.useCallback(async r=>{try{l(null),s(!0);const i=await u.connect(r);if(i){const d=u.getConnectedDevice();h(d),o(!0)}return i}catch(i){const d=i instanceof Error?i.message:"Failed to connect to printer";return l(d),!1}finally{s(!1)}},[]),P=c.useCallback(async()=>{try{l(null),await u.disconnect(),h(null),o(!1)}catch(r){const i=r instanceof Error?r.message:"Failed to disconnect from printer";l(i)}},[]),E=c.useCallback(async r=>{try{return l(null),f(!0),await u.print(r)}catch(i){const d=i instanceof Error?i.message:"Failed to print";return l(d),!1}finally{f(!1)}},[]),B=c.useCallback(async r=>{try{return l(null),f(!0),await u.printReceipt(r)}catch(i){const d=i instanceof Error?i.message:"Failed to print receipt";return l(d),!1}finally{f(!1)}},[]),$=c.useCallback(async r=>{try{return l(null),f(!0),await u.printLabel(r)}catch(i){const d=i instanceof Error?i.message:"Failed to print label";return l(d),!1}finally{f(!1)}},[]),F=c.useCallback(r=>{try{u.updateSettings(r);const i=u.getSettings();m(i)}catch(i){const d=i instanceof Error?i.message:"Failed to update settings";l(d)}},[]),M=c.useCallback(()=>{l(null)},[]);return c.useEffect(()=>{C()},[C]),c.useEffect(()=>{const r=setInterval(()=>{const i=u.isPrinterConnected();if(o(i),!i&&a)h(null);else if(i&&!a){const d=u.getConnectedDevice();h(d)}},2e3);return()=>clearInterval(r)},[a]),{isInitialized:y,isConnected:n,isConnecting:t,isPrinting:g,connectedDevice:a,availableDevices:w,settings:p,error:b,initialize:C,requestDevice:x,connect:S,disconnect:P,print:E,printReceipt:B,printLabel:$,updateSettings:F,clearError:M}};export{z as u};
