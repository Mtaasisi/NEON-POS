import{aP as Y,j as e}from"./index-61458a34.js";import{r as i,R as $}from"./vendor-36d2c7c1.js";import{e as z,k as X,l as H,t as S}from"./tradeInApi-5d12dbe0.js";import{format as r}from"./format-aff4c6a2.js";import{a7 as q,X as G,v as K,S as k,d as D,Y as J}from"./ui-28e30067.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";const te=({isOpen:p,onClose:v,newDevicePrice:m=0,onTradeInComplete:T})=>{const[d,c]=i.useState("select-device"),[E,P]=i.useState([]),[A,L]=i.useState([]),[R,j]=i.useState(!0),[b,f]=i.useState(""),[a,y]=i.useState(null),[o,N]=i.useState(""),[u,_]=i.useState("excellent"),[h,w]=i.useState(""),[n,g]=i.useState([]),[t,C]=i.useState(null);i.useEffect(()=>{p?M():(c("select-device"),y(null),N(""),_("excellent"),w(""),g([]),C(null),f(""))},[p]);const M=async()=>{j(!0);const[s,l]=await Promise.all([z({is_active:!0}),Y()]);s.success&&s.data&&P(s.data),l.success&&l.data&&L(l.data),j(!1)};i.useEffect(()=>{if(a){const s=X(a.base_trade_in_price,u,{excellent:a.excellent_multiplier,good:a.good_multiplier,fair:a.fair_multiplier,poor:a.poor_multiplier},n),l=m?H(m,s.final_trade_in_value):0;C({...s,new_device_price:m||void 0,customer_payment_amount:l})}},[a,u,n,m]);const F=s=>{const l={spare_part_id:s.id,spare_part_name:s.name,price:s.selling_price,description:""};g([...n,l])},B=s=>{g(n.filter((l,x)=>x!==s))},V=(s,l)=>{const x=[...n];x[s].description=l,g(x)},U=async()=>{if(console.log("üöÄ handleComplete CALLED"),console.log("üìä State check:",{selectedPrice:a?"EXISTS":"NULL",calculation:t?"EXISTS":"NULL",deviceImei:o||"EMPTY"}),!a||!t){console.error("‚ùå Missing selectedPrice or calculation"),S.error("Please complete all steps");return}if(!o){console.error("‚ùå Missing device IMEI"),S.error("Please enter device IMEI");return}console.log("‚úÖ All validations passed - Processing trade-in..."),console.log("üì¶ Trade-in data:",{final_trade_in_value:t.final_trade_in_value,customer_payment_amount:t.customer_payment_amount,device_name:a.device_name,device_model:a.device_model,device_imei:o}),T({final_trade_in_value:t.final_trade_in_value,customer_payment_amount:t.customer_payment_amount,trade_in_details:{device_name:a.device_name,device_model:a.device_model,device_imei:o,base_price:a.base_trade_in_price,condition_rating:u,condition_multiplier:t.condition_multiplier,damage_items:n,total_deductions:t.total_damage_deductions,condition_description:h}}),console.log("‚úÖ onTradeInComplete called successfully")};if(!p)return null;const I=E.filter(s=>{if(!b)return!0;const l=b.toLowerCase();return s.device_name.toLowerCase().includes(l)||s.device_model.toLowerCase().includes(l)});return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99998] p-4",onClick:s=>{s.target===s.currentTarget&&v()},children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col relative z-[99998]",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-blue-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-8 h-8 text-white"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:"Trade-In Calculator"}),e.jsx("p",{className:"text-blue-100 text-sm mt-1",children:"Value your customer's device for trade-in"})]})]}),e.jsx("button",{onClick:v,className:"p-2 hover:bg-blue-800 rounded-lg transition-colors text-white",children:e.jsx(G,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"mt-6 flex items-center gap-2",children:["select-device","assess-condition","damage-assessment","review"].map((s,l)=>e.jsx($.Fragment,{children:e.jsx("div",{className:`flex-1 h-2 rounded-full transition-all ${d===s?"bg-white":l<["select-device","assess-condition","damage-assessment","review"].indexOf(d)?"bg-blue-300":"bg-blue-800"}`})},s))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:R?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"})}):e.jsxs(e.Fragment,{children:[d==="select-device"&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Select the device being traded in"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(K,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search device...",value:b,onChange:s=>f(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto",children:I.map(s=>e.jsx("button",{onClick:()=>{y(s),c("assess-condition")},className:"p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-left",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(k,{className:"w-8 h-8 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s.device_name}),e.jsx("div",{className:"text-sm text-gray-600",children:s.device_model}),e.jsxs("div",{className:"mt-2 text-lg font-bold text-blue-600",children:["Up to ",r.money(s.base_trade_in_price)]})]})]})},s.id))}),I.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(k,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No devices found"})]})]})}),d==="assess-condition"&&a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:a.device_name}),e.jsx("div",{className:"text-sm text-gray-600",children:a.device_model})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Device IMEI *"}),e.jsx("input",{type:"text",required:!0,value:o,onChange:s=>N(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter device IMEI"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Device Condition *"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[{value:"excellent",label:"Excellent",color:"green",multiplier:a.excellent_multiplier},{value:"good",label:"Good",color:"blue",multiplier:a.good_multiplier},{value:"fair",label:"Fair",color:"yellow",multiplier:a.fair_multiplier},{value:"poor",label:"Poor",color:"red",multiplier:a.poor_multiplier}].map(s=>e.jsxs("button",{type:"button",onClick:()=>_(s.value),className:`p-4 border-2 rounded-lg transition-all ${u===s.value?`border-${s.color}-500 bg-${s.color}-50`:"border-gray-200 hover:border-gray-300"}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s.label}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[(s.multiplier*100).toFixed(0),"% of base price"]}),e.jsx("div",{className:"text-lg font-bold text-blue-600 mt-2",children:r.money(a.base_trade_in_price*s.multiplier)})]},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Condition Notes"}),e.jsx("textarea",{value:h,onChange:s=>w(s.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Describe the overall condition..."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>c("select-device"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Back"}),e.jsx("button",{onClick:()=>{g([]),c("review")},className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"No Damage - Skip to Review"}),e.jsx("button",{onClick:()=>c("damage-assessment"),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Add Damage/Issues"})]})]}),d==="damage-assessment"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Damage & Issues Assessment (Optional)"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Add any damaged parts to deduct from the trade-in value, or skip if device has no issues"})]}),n.length===0&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx(D,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"No damage or issues selected"})]}),e.jsx("p",{className:"text-sm text-green-600 mt-1",children:'The device will be valued at the full condition-adjusted price. Click "Continue" to proceed.'})]}),n.length>0&&e.jsx("div",{className:"space-y-3",children:n.map((s,l)=>e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.spare_part_name}),e.jsxs("div",{className:"font-bold text-red-600",children:["-",r.money(s.price)]})]}),e.jsx("input",{type:"text",value:s.description||"",onChange:x=>V(l,x.target.value),placeholder:"Add description...",className:"w-full mt-2 px-3 py-1 text-sm border border-gray-300 rounded"})]}),e.jsx("button",{onClick:()=>B(l),className:"p-1 text-red-600 hover:bg-red-100 rounded",children:e.jsx(J,{className:"w-4 h-4"})})]},l))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select damaged parts (optional - skip if no damage)"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50",children:A.map(s=>e.jsxs("button",{onClick:()=>F(s),className:"p-3 border border-gray-200 rounded hover:border-blue-500 hover:bg-blue-50 transition-all text-left text-sm",children:[e.jsx("div",{className:"font-medium text-gray-900 truncate",children:s.name}),e.jsx("div",{className:"text-xs text-gray-600",children:r.money(s.selling_price)})]},s.id))})]}),t&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Base Price:"}),e.jsx("span",{className:"font-medium",children:r.money(t.base_price)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Condition Adjustment:"}),e.jsx("span",{className:"font-medium",children:r.money(t.condition_adjusted_price)})]}),e.jsxs("div",{className:"flex justify-between text-sm text-red-600",children:[e.jsx("span",{children:"Damage Deductions:"}),e.jsxs("span",{className:"font-medium",children:["-",r.money(t.total_damage_deductions)]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold text-gray-900 pt-2 border-t border-blue-200",children:[e.jsx("span",{children:"Final Trade-In Value:"}),e.jsx("span",{children:r.money(t.final_trade_in_value)})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>c("assess-condition"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Back"}),e.jsx("button",{onClick:()=>c("review"),className:"flex-1 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:n.length>0?"Continue to Review":"Continue (No Damage)"})]})]}),d==="review"&&t&&a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(D,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900",children:"Trade-In Summary"})]}),e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Device"}),e.jsxs("div",{className:"font-semibold text-gray-900",children:[a.device_name," - ",a.device_model]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["IMEI: ",o]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Condition"}),e.jsx("div",{className:"font-medium text-gray-900 capitalize",children:u}),h&&e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:h})]}),n.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"Damage/Issues"}),e.jsx("div",{className:"space-y-1",children:n.map((s,l)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-700",children:s.spare_part_name}),e.jsxs("span",{className:"text-red-600",children:["-",r.money(s.price)]})]},l))})]})]}),e.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-700",children:"Base Trade-In Price:"}),e.jsx("span",{className:"font-medium",children:r.money(t.base_price)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-700",children:["Condition Adjustment (",(t.condition_multiplier*100).toFixed(0),"%):"]}),e.jsx("span",{className:"font-medium",children:r.money(t.condition_adjusted_price)})]}),t.total_damage_deductions>0&&e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsx("span",{children:"Total Deductions:"}),e.jsxs("span",{className:"font-medium",children:["-",r.money(t.total_damage_deductions)]})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold text-gray-900 pt-3 border-t-2 border-blue-200",children:[e.jsx("span",{children:"Final Trade-In Value:"}),e.jsx("span",{className:"text-green-600",children:r.money(t.final_trade_in_value)})]}),m>0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"border-t-2 border-blue-200 pt-3 mt-3",children:[e.jsxs("div",{className:"flex justify-between text-gray-700",children:[e.jsx("span",{children:"New Device Price:"}),e.jsx("span",{className:"font-medium",children:r.money(m)})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold text-blue-600 mt-2",children:[e.jsx("span",{children:"Customer Pays:"}),e.jsx("span",{children:r.money(t.customer_payment_amount)})]})]})})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Debug Info:"}),e.jsxs("div",{children:["Device: ",(a==null?void 0:a.device_name)||"N/A"]}),e.jsxs("div",{children:["IMEI: ",o||"‚ö†Ô∏è Not set"]}),e.jsxs("div",{children:["Calculation: ",t?"‚úÖ":"‚ùå"]}),e.jsxs("div",{children:["Final Value: ",t!=null&&t.final_trade_in_value?r.money(t.final_trade_in_value):"N/A"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{console.log("‚¨ÖÔ∏è Back button clicked"),c("damage-assessment")},className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer",children:"Back"}),e.jsx("button",{type:"button",onClick:s=>{console.log("üîò Complete Trade-In button CLICKED!"),s.preventDefault(),s.stopPropagation(),U()},className:"flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 active:bg-green-800 font-semibold transition-colors shadow-md hover:shadow-lg",children:"Complete Trade-In"})]})]}):d==="review"?e.jsxs("div",{className:"p-6 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("p",{className:"text-yellow-800 font-medium",children:"‚ö†Ô∏è Review Step Debug Info:"}),e.jsxs("ul",{className:"mt-2 text-sm text-yellow-700 space-y-1",children:[e.jsxs("li",{children:["Step: ",d]}),e.jsxs("li",{children:["Has Calculation: ",t?"‚úÖ Yes":"‚ùå No"]}),e.jsxs("li",{children:["Has Selected Price: ",a?"‚úÖ Yes":"‚ùå No"]}),e.jsxs("li",{children:["Device IMEI: ",o||"‚ùå Not set"]})]})]}):null]})})]})})};export{te as TradeInCalculator,te as default};
