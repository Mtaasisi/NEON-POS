import{s}from"./index-61458a34.js";import{t as c,a as v}from"./utils-95f4031a.js";import"./vendor-36d2c7c1.js";import"./supabase-cf010ec4.js";import"./routing-eb8c310c.js";import"./ui-28e30067.js";import"./charts-d592fbd1.js";class m{constructor(){this.queue=[],this.processing=!1,this.maxConcurrent=2,this.delayBetweenRequests=500}static getInstance(){return m.instance||(m.instance=new m),m.instance}async execute(r){return new Promise((t,o)=>{this.queue.push(async()=>{try{await new Promise(a=>setTimeout(a,this.delayBetweenRequests));const i=await r();t(i)}catch(i){o(i)}}),this.processQueue()})}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const r=this.queue.splice(0,this.maxConcurrent);await Promise.all(r.map(t=>t()))}this.processing=!1}}}const f=["id","customer_id","brand","model","serial_number","issue_description","status","assigned_to","estimated_hours","expected_return_date","warranty_start","warranty_end","warranty_status","repair_count","last_return_date","created_at","updated_at"];function p(e){const r={};for(const t of f)e[t]!==void 0&&(r[t]=e[t]);return r}const I={async getAllDevices(){try{console.log("ðŸ” deviceServices.getAllDevices() called");const e=localStorage.getItem("current_branch_id");let r=s.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).order("created_at",{ascending:!1});e&&(r=r.eq("branch_id",e));const{data:t,error:o}=await r;if(o)throw console.error("âŒ Database error:",o),new Error(`Failed to fetch devices: ${o.message}`);return console.log("ðŸ“± Database query successful, devices found:",(t==null?void 0:t.length)||0),(t==null?void 0:t.map(c))||[]}catch(e){throw console.error("âŒ Network error in getAllDevices:",e),new Error("Network error: Unable to connect to database")}},async getDeviceById(e){try{const{data:r,error:t}=await s.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).eq("id",e).single();if(t)throw new Error(`Failed to fetch device: ${t.message}`);return c(r)}catch{throw new Error("Network error: Unable to connect to database")}},async createDevice(e){try{const r=localStorage.getItem("current_branch_id"),t=p(e),o=v(t),{id:i,...a}=o;a.status||(a.status="received"),a.branch_id=r||"00000000-0000-0000-0000-000000000001",console.log("Inserting sanitized device:",a);const{data:d,error:l}=await s.from("devices").insert(a).select("*").single();if(l)throw new Error(`Failed to create device: ${l.message}`);return c(d)}catch{throw new Error("Network error: Unable to connect to database")}},async updateDevice(e,r){console.log("[deviceServices.updateDevice] Called with:",{id:e,updates:r});const t=Object.fromEntries(Object.entries(r).map(([a,d])=>[v(a),d]));console.log("[deviceServices.updateDevice] Snake case updates:",t);const{data:o,error:i}=await s.from("devices").update(t).eq("id",e).select().single();if(i)throw console.error("[deviceServices.updateDevice] âŒ Update failed:",i),console.error("[deviceServices.updateDevice] Error details:",{message:i.message,details:i.details,hint:i.hint,code:i.code}),i;return console.log("[deviceServices.updateDevice] âœ… Update successful:",o),r.status&&await s.from("device_notifications").insert({device_id:e,type:"info",title:"Device Status Updated",message:`Device status changed to ${r.status}`,sent_at:new Date().toISOString(),is_read:!1}),o},async deleteDevice(e){try{const{error:r}=await s.from("devices").delete().eq("id",e);if(r)throw new Error(`Failed to delete device: ${r.message}`);return!0}catch{throw new Error("Network error: Unable to connect to database")}},async addDeviceChecklist(e){try{const{data:r,error:t}=await s.from("device_checklists").insert(e).select().single();if(t)throw console.error("Error adding device checklist:",t),new Error(`Failed to add device checklist: ${t.message}`);return r}catch(r){throw console.error("Network error adding device checklist:",r),new Error("Network error: Unable to connect to database")}},async updateDeviceChecklist(e,r){try{const{data:t,error:o}=await s.from("device_checklists").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw console.error("Error updating device checklist:",o),new Error(`Failed to update device checklist: ${o.message}`);return t}catch(t){throw console.error("Network error updating device checklist:",t),new Error("Network error: Unable to connect to database")}},async addDeviceRemark(e){try{const{data:r,error:t}=await s.from("device_remarks").insert(e).select().single();if(t)throw console.error("Error adding device remark:",t),new Error(`Failed to add device remark: ${t.message}`);return await s.from("device_notifications").insert({device_id:e.device_id,type:"info",title:"New Device Remark",message:`A new remark/message was added to device ${e.device_id}.`,sent_at:new Date().toISOString(),is_read:!1}),r}catch(r){throw console.error("Network error adding device remark:",r),new Error("Network error: Unable to connect to database")}},async addDeviceTransition(e){try{const{data:r,error:t}=await s.from("device_transitions").insert(e).select().single();if(t)throw console.error("Error adding device transition:",t),new Error(`Failed to add device transition: ${t.message}`);return await s.from("device_notifications").insert({device_id:e.device_id,type:"info",title:"Device Status Updated",message:`Device ${e.device_id} status changed from ${e.from_status} to ${e.to_status}.`,sent_at:new Date().toISOString(),is_read:!1}),r}catch(r){throw console.error("Network error adding device transition:",r),new Error("Network error: Unable to connect to database")}},async addDeviceRating(e){try{const{data:r,error:t}=await s.from("device_ratings").insert(e).select().single();if(t)throw console.error("Error adding device rating:",t),new Error(`Failed to add device rating: ${t.message}`);return r}catch(r){throw console.error("Network error adding device rating:",r),new Error("Network error: Unable to connect to database")}},async searchDevices(e){try{const r=localStorage.getItem("current_branch_id");let t=s.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).or(`brand.ilike.%${e}%,model.ilike.%${e}%,serial_number.ilike.%${e}%,id.ilike.%${e}%`).order("created_at",{ascending:!1});r&&(t=t.eq("branch_id",r));const{data:o,error:i}=await t;if(i)throw console.error("Error searching devices:",i),new Error(`Failed to search devices: ${i.message}`);return c(o||[])}catch(r){throw console.error("Network error searching devices:",r),new Error("Network error: Unable to connect to database")}},async filterDevicesByStatus(e){try{const r=localStorage.getItem("current_branch_id");let t=s.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).eq("status",e).order("created_at",{ascending:!1});r&&(t=t.eq("branch_id",r));const{data:o,error:i}=await t;if(i)throw console.error("Error filtering devices by status:",i),new Error(`Failed to filter devices: ${i.message}`);return c(o||[])}catch(r){throw console.error("Network error filtering devices by status:",r),new Error("Network error: Unable to connect to database")}},async getDevicesByTechnician(e){try{console.log("ðŸ”§ Fetching devices for technician:",e);const r=localStorage.getItem("current_branch_id");let t=s.from("devices").select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).eq("assigned_to",e).order("created_at",{ascending:!1});r&&(t=t.eq("branch_id",r));const{data:o,error:i}=await t;if(i)throw console.error("âŒ Error fetching devices by technician:",i),new Error(`Failed to fetch devices: ${i.message}`);return console.log("âœ… Devices fetched for technician:",(o==null?void 0:o.length)||0),c(o||[])}catch(r){throw console.error("âŒ Network error fetching devices by technician:",r),new Error("Network error: Unable to connect to database")}},async getDevicesByCustomer(e){try{return await m.getInstance().execute(async()=>{const o=localStorage.getItem("current_branch_id");let i=s.from("devices").select(`
            id,
            customer_id,
            brand,
            model,
            serial_number,
            issue_description,
            status,
            assigned_to,
            estimated_hours,
            expected_return_date,
            created_at,
            updated_at
          `).eq("customer_id",e).order("created_at",{ascending:!1});o&&(i=i.eq("branch_id",o));const{data:a,error:d}=await i;if(d)throw console.error("Error fetching devices by customer:",d),new Error(`Failed to fetch devices: ${d.message}`);return c(a||[])})}catch(r){throw console.error("Network error fetching devices by customer:",r),new Error("Network error: Unable to connect to database")}},async getDevicePaymentRecords(e){try{const{data:r,error:t}=await s.from("customer_payments").select(`
          *,
          devices(brand, model)
        `).eq("device_id",e).order("payment_date",{ascending:!1});if(t)throw console.error("Error fetching device payment records:",t),new Error(`Failed to fetch payment records: ${t.message}`);const o=(r||[]).map(i=>{var a;return{...i,device_name:i.devices?`${i.devices.brand||""} ${i.devices.model||""}`.trim():void 0,customer_name:((a=i.customers)==null?void 0:a.name)||void 0}});return c(o)}catch(r){throw console.error("Network error fetching device payment records:",r),new Error("Network error: Unable to connect to database")}},async getCustomerPaymentRecords(e){try{const{data:r,error:t}=await s.from("customer_payments").select(`
          *,
          devices(brand, model)
        `).eq("customer_id",e).order("payment_date",{ascending:!1});if(t)return console.log("âš ï¸ DeviceServices: customer_payments table not found or error:",t),[];const o=(r||[]).map(i=>({...i,device_name:i.devices?`${i.devices.brand||""} ${i.devices.model||""}`.trim():void 0}));return c(o)}catch(r){return console.error("Network error fetching customer payment records:",r),[]}},async addPaymentRecord(e){try{if(!e.customer_id)throw new Error("Customer ID is required for payment record");const{data:r,error:t}=await s.from("customer_payments").insert([e]).select().single();if(t)throw console.error("Error adding payment record:",t),new Error(`Failed to add payment record: ${t.message}`);return await s.from("device_notifications").insert({device_id:e.device_id,type:e.status==="failed"?"error":"info",title:e.status==="failed"?"Payment Failed":"Payment Received",message:e.status==="failed"?`A payment for device ${e.device_id} failed.`:`Payment received for device ${e.device_id}.`,sent_at:new Date().toISOString(),is_read:!1}),c(r)}catch(r){throw console.error("Network error adding payment record:",r),new Error("Network error: Unable to connect to database")}},async getDeviceStatistics(){try{const e=localStorage.getItem("current_branch_id");let r=s.from("devices").select("id",{count:"exact"}),t=s.from("devices").select("id",{count:"exact"}).in("status",["received","in_progress"]),o=s.from("devices").select("id",{count:"exact"}).eq("status","completed"),i=s.from("devices").select("id",{count:"exact"}).eq("status","completed");e&&(r=r.eq("branch_id",e),t=t.eq("branch_id",e),o=o.eq("branch_id",e),i=i.eq("branch_id",e));const{data:a,error:d}=await r,{data:l,error:h}=await t,{data:_,error:u}=await o,{data:w,error:n}=await i;if(d||h||u||n)throw console.error("Error fetching device statistics:",{totalError:d,repairError:h,pickupError:u,completedError:n}),new Error("Failed to fetch device statistics");return{totalDevices:(a==null?void 0:a.length)||0,inRepair:(l==null?void 0:l.length)||0,readyForPickup:(_==null?void 0:_.length)||0,completed:(w==null?void 0:w.length)||0}}catch(e){throw console.error("Network error fetching device statistics:",e),new Error("Network error: Unable to connect to database")}},async getTechnicianRating(e){try{const{data:r,error:t}=await s.from("device_ratings").select("*").eq("technician_id",e);if(t)throw console.error("Error getting technician rating:",t),new Error(`Failed to get technician rating: ${t.message}`);return!r||r.length===0?0:r.reduce((i,a)=>i+(a.score||5),0)/r.length}catch(r){throw console.error("Network error getting technician rating:",r),new Error("Network error: Unable to connect to database")}},async updateDeviceReturnDate(e,r){try{const{data:t,error:o}=await s.from("devices").update({expected_return_date:r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw console.error("Error updating device return date:",o),new Error(`Failed to update device return date: ${o.message}`);return c(t)}catch(t){throw console.error("Network error updating device return date:",t),new Error("Network error: Unable to connect to database")}},async sendCustomerNotification(e,r){try{const{error:t}=await s.from("device_notifications").insert({device_id:e,message:r,sent_at:new Date().toISOString(),is_read:!1});if(t)throw t;return!0}catch(t){return console.error("Error sending customer notification:",t),!1}},async assignTechnicianToDevice(e,r){try{const{data:t,error:o}=await s.from("devices").update({assigned_to:r,updated_at:new Date().toISOString()}).eq("id",e).select(`
          id,
          customer_id,
          brand,
          model,
          serial_number,
          issue_description,
          status,
          assigned_to,
          estimated_hours,
          expected_return_date,
          created_at,
          updated_at
        `).single();if(o)throw console.error("Error assigning technician to device:",o),new Error(`Failed to assign technician: ${o.message}`);return await s.from("device_notifications").insert({device_id:e,type:"info",title:"Technician Assigned",message:`A technician has been assigned to device ${e}.`,sent_at:new Date().toISOString(),is_read:!1}),c(t)}catch(t){throw console.error("Network error assigning technician to device:",t),new Error("Network error: Unable to assign technician")}},async saveReceipt(e){try{const{data:r,error:t}=await s.from("receipts").insert({receipt_number:`RCP-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,device_id:e.deviceId,customer_id:e.customerId,payment_id:e.paymentId,technician_id:e.technicianId,device_brand:e.deviceBrand,device_model:e.deviceModel,device_serial_number:e.deviceSerialNumber,device_issue:e.deviceIssue,customer_name:e.customerName,customer_phone:e.customerPhone,customer_email:e.customerEmail,payment_method:e.paymentMethod,payment_reference:e.paymentReference,payment_amount:e.paymentAmount,total_cost:e.totalCost,deposit_amount:e.depositAmount,remaining_balance:e.remainingBalance,repair_cost:e.repairCost,labor_cost:e.laborCost,parts_cost:e.partsCost,device_status:e.deviceStatus,generated_by:e.generatedBy,receipt_content:e.receiptContent}).select().single();if(t)throw console.error("Error saving receipt:",t),new Error(`Failed to save receipt: ${t.message}`);return c(r)}catch(r){throw console.error("Network error saving receipt:",r),new Error("Network error: Unable to connect to database")}},async getReceipt(e){try{const{data:r,error:t}=await s.from("receipts").select("*").eq("id",e).single();if(t)throw console.error("Error fetching receipt:",t),new Error(`Failed to fetch receipt: ${t.message}`);if(!r)throw new Error("Receipt not found");const[o,i,a]=await Promise.all([r.device_id?s.from("devices").select("*").eq("id",r.device_id).single():Promise.resolve({data:null,error:null}),r.customer_id?s.from("customers").select("*").eq("id",r.customer_id).single():Promise.resolve({data:null,error:null}),s.from("customer_payments").select("*").eq("receipt_id",e)]),d={...r,devices:o.data,customers:i.data,customer_payments:a.data||[]};return c(d)}catch(r){throw console.error("Network error fetching receipt:",r),new Error("Network error: Unable to connect to database")}},async getDeviceReceipts(e){var r,t;try{const{data:o,error:i}=await s.from("receipts").select("*").eq("device_id",e).order("receipt_date",{ascending:!1});if(i)throw console.error("Error fetching device receipts:",i),new Error(`Failed to fetch device receipts: ${i.message}`);if(!o||o.length===0)return[];const a=o.map(n=>n.customer_id).filter(Boolean),d=o.map(n=>n.id),[l,h]=await Promise.all([a.length>0?s.from("customers").select("*").in("id",a):Promise.resolve({data:[],error:null}),s.from("customer_payments").select("*").in("receipt_id",d)]),_=new Map(((r=l.data)==null?void 0:r.map(n=>[n.id,n]))||[]),u=new Map;(t=h.data)==null||t.forEach(n=>{const g=u.get(n.receipt_id)||[];g.push(n),u.set(n.receipt_id,g)});const w=o.map(n=>({...n,customers:n.customer_id?_.get(n.customer_id):null,customer_payments:u.get(n.id)||[]}));return c(w)}catch(o){throw console.error("Network error fetching device receipts:",o),new Error("Network error: Unable to connect to database")}},async getCustomerReceipts(e){try{const{data:r,error:t}=await s.from("receipts").select(`
          *,
          devices(*),
          customer_payments(*),
          auth_users!receipts_technician_id_fkey(*)
        `).eq("customer_id",e).order("receipt_date",{ascending:!1});if(t)throw console.error("Error fetching customer receipts:",t),new Error(`Failed to fetch customer receipts: ${t.message}`);return c(r||[])}catch(r){throw console.error("Network error fetching customer receipts:",r),new Error("Network error: Unable to connect to database")}},async markReceiptPrinted(e){try{const{data:r,error:t}=await s.from("receipts").update({is_printed:!0}).eq("id",e).select().single();if(t)throw console.error("Error marking receipt as printed:",t),new Error(`Failed to mark receipt as printed: ${t.message}`);return c(r)}catch(r){throw console.error("Network error marking receipt as printed:",r),new Error("Network error: Unable to connect to database")}},async markReceiptSent(e,r){try{const{data:t,error:o}=await s.from("receipts").update({is_sent_to_customer:!0,sent_via:r,sent_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw console.error("Error marking receipt as sent:",o),new Error(`Failed to mark receipt as sent: ${o.message}`);return c(t)}catch(t){throw console.error("Network error marking receipt as sent:",t),new Error("Network error: Unable to connect to database")}}},q={subscribeToDevices(e){try{return s.channel("devices").on("postgres_changes",{event:"*",schema:"public",table:"devices"},e).subscribe(t=>{})}catch{return null}},subscribeToDeviceChecklists(e){try{return s.channel("device_checklists").on("postgres_changes",{event:"*",schema:"public",table:"device_checklists"},e).subscribe(t=>{})}catch{return null}},subscribeToDeviceRemarks(e){try{return s.channel("device_remarks").on("postgres_changes",{event:"*",schema:"public",table:"device_remarks"},e).subscribe(t=>{})}catch{return null}},subscribeToDeviceTransitions(e){try{return s.channel("device_transitions").on("postgres_changes",{event:"*",schema:"public",table:"device_transitions"},e).subscribe(t=>{})}catch{return null}},subscribeToDevice(e,r){try{return s.channel(`device_${e}`).on("postgres_changes",{event:"*",schema:"public",table:"devices",filter:`id=eq.${e}`},r).subscribe(o=>{})}catch{return null}},subscribeToDeviceNotifications(e){try{return s.channel("device_notifications").on("postgres_changes",{event:"*",schema:"public",table:"device_notifications"},e).subscribe(t=>{})}catch{return null}}},R={async notifyInventoryLow(e){await s.from("device_notifications").insert({type:"warning",title:"Low Inventory",message:`${e} is low on stock.`,sent_at:new Date().toISOString(),is_read:!1})},async notifyInventoryOut(e){await s.from("device_notifications").insert({type:"error",title:"Out of Stock",message:`${e} is out of stock!`,sent_at:new Date().toISOString(),is_read:!1})},async notifyInventoryNew(e){await s.from("device_notifications").insert({type:"info",title:"New Inventory Item",message:`New item added: ${e}`,sent_at:new Date().toISOString(),is_read:!1})},async notifyWarrantyExpiring(e){await s.from("device_notifications").insert({type:"warning",title:"Warranty Expiry Soon",message:`Warranty for device ${e} expires soon.`,sent_at:new Date().toISOString(),is_read:!1})},async notifyWarrantyExpired(e){await s.from("device_notifications").insert({type:"error",title:"Warranty Expired",message:`Warranty for device ${e} has expired.`,sent_at:new Date().toISOString(),is_read:!1})},async notifySystemError(e){await s.from("device_notifications").insert({type:"error",title:"System Error",message:`A critical system error occurred: ${e}`,sent_at:new Date().toISOString(),is_read:!1})},async notifySystemMaintenance(e){await s.from("device_notifications").insert({type:"info",title:"System Maintenance",message:`System maintenance scheduled for ${e}.`,sent_at:new Date().toISOString(),is_read:!1})}};export{I as deviceServices,q as deviceSubscriptions,R as notificationHelpers};
