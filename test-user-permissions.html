<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Permissions System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .test-section h2 {
            margin-top: 0;
            color: #3b82f6;
            font-size: 18px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: background 0.2s;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #3b82f6;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .result {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.pending { background: #fbbf24; color: #92400e; }
        .status.testing { background: #3b82f6; color: white; }
        .status.passed { background: #10b981; color: white; }
        .status.failed { background: #ef4444; color: white; }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê User Permissions System Test</h1>
        <p class="subtitle">Test database connection and user creation with permissions</p>

        <!-- Test 1: Database Connection -->
        <div class="test-section">
            <h2>Test 1: Database Connection <span class="status pending" id="status-1">PENDING</span></h2>
            <p>Verify that the application can connect to Neon Database</p>
            <button onclick="testDatabaseConnection()">Run Test</button>
            <div id="result-1"></div>
        </div>

        <!-- Test 2: Fetch Users -->
        <div class="test-section">
            <h2>Test 2: Fetch Existing Users <span class="status pending" id="status-2">PENDING</span></h2>
            <p>Verify that the users table exists and can be queried</p>
            <button onclick="testFetchUsers()">Run Test</button>
            <div id="result-2"></div>
        </div>

        <!-- Test 3: Check Users Table Schema -->
        <div class="test-section">
            <h2>Test 3: Users Table Schema <span class="status pending" id="status-3">PENDING</span></h2>
            <p>Verify that the users table has the permissions column</p>
            <button onclick="testUsersTableSchema()">Run Test</button>
            <div id="result-3"></div>
        </div>

        <!-- Test 4: Create Test User -->
        <div class="test-section">
            <h2>Test 4: Create Test User with Permissions <span class="status pending" id="status-4">PENDING</span></h2>
            <p>Create a test user with custom permissions and verify it's saved correctly</p>
            <button onclick="testCreateUser()">Run Test</button>
            <button onclick="cleanupTestUser()" style="background: #ef4444;">Cleanup Test User</button>
            <div id="result-4"></div>
        </div>

        <!-- Test 5: Verify Permissions Storage -->
        <div class="test-section">
            <h2>Test 5: Verify Permissions Storage <span class="status pending" id="status-5">PENDING</span></h2>
            <p>Fetch the created test user and verify permissions are stored correctly</p>
            <button onclick="testVerifyPermissions()">Run Test</button>
            <div id="result-5"></div>
        </div>

        <!-- Run All Tests -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button onclick="runAllTests()" style="font-size: 16px; padding: 15px 30px; background: #10b981;">
                ‚ñ∂Ô∏è Run All Tests
            </button>
            <button onclick="location.reload()" style="background: #64748b;">
                üîÑ Reset
            </button>
        </div>
    </div>

    <script type="module">
        // Import necessary modules
        import { supabase, testSupabaseConnection } from './src/lib/supabaseClient.js';
        import { fetchAllUsers, createUser, fetchUserById } from './src/lib/userApi.js';

        // Make functions available globally
        window.supabase = supabase;
        window.testSupabaseConnection = testSupabaseConnection;
        window.fetchAllUsers = fetchAllUsers;
        window.createUser = createUser;
        window.fetchUserById = fetchUserById;

        console.log('‚úÖ Test modules loaded successfully');
    </script>

    <script>
        let testUserId = null;

        function updateStatus(testNumber, status) {
            const statusEl = document.getElementById(`status-${testNumber}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = status.toUpperCase();
        }

        function showResult(testNumber, type, message, details = null) {
            const resultEl = document.getElementById(`result-${testNumber}`);
            let html = `<div class="${type}">${message}</div>`;
            
            if (details) {
                html += `<div class="result"><pre>${JSON.stringify(details, null, 2)}</pre></div>`;
            }
            
            resultEl.innerHTML = html;
        }

        async function testDatabaseConnection() {
            updateStatus(1, 'testing');
            try {
                console.log('Testing database connection...');
                const result = await window.testSupabaseConnection();
                
                if (result.success) {
                    updateStatus(1, 'passed');
                    showResult(1, 'success', '‚úÖ Database connection successful!', result);
                } else {
                    updateStatus(1, 'failed');
                    showResult(1, 'error', '‚ùå Database connection failed', result);
                }
            } catch (error) {
                updateStatus(1, 'failed');
                showResult(1, 'error', `‚ùå Error: ${error.message}`, { error: error.toString() });
            }
        }

        async function testFetchUsers() {
            updateStatus(2, 'testing');
            try {
                console.log('Fetching users...');
                const users = await window.fetchAllUsers();
                
                if (users && Array.isArray(users)) {
                    updateStatus(2, 'passed');
                    showResult(2, 'success', `‚úÖ Successfully fetched ${users.length} user(s)`, {
                        count: users.length,
                        sample: users.slice(0, 3).map(u => ({
                            id: u.id,
                            email: u.email,
                            role: u.role,
                            permissions: u.permissions?.length || 0
                        }))
                    });
                } else {
                    updateStatus(2, 'failed');
                    showResult(2, 'error', '‚ùå Failed to fetch users or empty result', { users });
                }
            } catch (error) {
                updateStatus(2, 'failed');
                showResult(2, 'error', `‚ùå Error: ${error.message}`, { error: error.toString() });
            }
        }

        async function testUsersTableSchema() {
            updateStatus(3, 'testing');
            try {
                console.log('Checking users table schema...');
                
                // Fetch a user to check schema
                const users = await window.fetchAllUsers();
                
                if (users && users.length > 0) {
                    const sampleUser = users[0];
                    const hasPermissionsColumn = 'permissions' in sampleUser;
                    const hasRequiredColumns = 'id' in sampleUser && 'email' in sampleUser && 'role' in sampleUser;
                    
                    if (hasPermissionsColumn && hasRequiredColumns) {
                        updateStatus(3, 'passed');
                        showResult(3, 'success', '‚úÖ Users table has correct schema including permissions column', {
                            columns: Object.keys(sampleUser),
                            permissions_type: Array.isArray(sampleUser.permissions) ? 'array' : typeof sampleUser.permissions
                        });
                    } else {
                        updateStatus(3, 'failed');
                        showResult(3, 'error', '‚ùå Users table missing required columns', {
                            hasPermissions: hasPermissionsColumn,
                            columns: Object.keys(sampleUser)
                        });
                    }
                } else {
                    updateStatus(3, 'failed');
                    showResult(3, 'error', '‚ùå No users found to check schema', { users: [] });
                }
            } catch (error) {
                updateStatus(3, 'failed');
                showResult(3, 'error', `‚ùå Error: ${error.message}`, { error: error.toString() });
            }
        }

        async function testCreateUser() {
            updateStatus(4, 'testing');
            try {
                console.log('Creating test user...');
                
                const timestamp = Date.now();
                const testUserData = {
                    firstName: 'Test',
                    lastName: 'User',
                    email: `testuser${timestamp}@test.com`,
                    username: `testuser${timestamp}`,
                    password: 'test123456',
                    role: 'manager',
                    phone: '+255 123 456 789',
                    department: 'IT',
                    permissions: [
                        'dashboard',
                        'pos',
                        'reports',
                        'inventory_view',
                        'inventory_add',
                        'customers_view',
                        'customers_add'
                    ]
                };
                
                const newUser = await window.createUser(testUserData);
                
                if (newUser && newUser.id) {
                    testUserId = newUser.id;
                    updateStatus(4, 'passed');
                    showResult(4, 'success', `‚úÖ Successfully created test user!`, {
                        id: newUser.id,
                        email: newUser.email,
                        full_name: newUser.full_name,
                        role: newUser.role,
                        permissions: newUser.permissions,
                        permissions_count: newUser.permissions?.length || 0
                    });
                } else {
                    updateStatus(4, 'failed');
                    showResult(4, 'error', '‚ùå User creation returned empty or invalid result', { newUser });
                }
            } catch (error) {
                updateStatus(4, 'failed');
                showResult(4, 'error', `‚ùå Error: ${error.message}`, { 
                    error: error.toString(),
                    stack: error.stack 
                });
            }
        }

        async function testVerifyPermissions() {
            updateStatus(5, 'testing');
            try {
                if (!testUserId) {
                    throw new Error('No test user ID available. Please run Test 4 first.');
                }
                
                console.log('Verifying permissions for test user:', testUserId);
                
                const user = await window.fetchUserById(testUserId);
                
                if (user && user.permissions && Array.isArray(user.permissions)) {
                    const hasExpectedPermissions = user.permissions.includes('dashboard') && 
                                                  user.permissions.includes('inventory_view');
                    
                    if (hasExpectedPermissions) {
                        updateStatus(5, 'passed');
                        showResult(5, 'success', '‚úÖ Permissions are correctly stored and retrieved!', {
                            user_id: user.id,
                            email: user.email,
                            role: user.role,
                            permissions: user.permissions,
                            permissions_count: user.permissions.length
                        });
                    } else {
                        updateStatus(5, 'failed');
                        showResult(5, 'error', '‚ùå Permissions exist but don\'t match expected values', {
                            expected: ['dashboard', 'inventory_view', '...'],
                            actual: user.permissions
                        });
                    }
                } else {
                    updateStatus(5, 'failed');
                    showResult(5, 'error', '‚ùå User fetched but permissions column missing or invalid', {
                        user,
                        has_permissions: 'permissions' in user,
                        permissions_value: user.permissions
                    });
                }
            } catch (error) {
                updateStatus(5, 'failed');
                showResult(5, 'error', `‚ùå Error: ${error.message}`, { 
                    error: error.toString(),
                    testUserId 
                });
            }
        }

        async function cleanupTestUser() {
            if (!testUserId) {
                alert('No test user to cleanup. Create a test user first.');
                return;
            }
            
            if (!confirm('Delete the test user?')) {
                return;
            }
            
            try {
                const { data, error } = await window.supabase
                    .from('users')
                    .delete()
                    .eq('id', testUserId);
                
                if (error) {
                    throw error;
                }
                
                alert('‚úÖ Test user deleted successfully!');
                testUserId = null;
                updateStatus(4, 'pending');
                updateStatus(5, 'pending');
                document.getElementById('result-4').innerHTML = '';
                document.getElementById('result-5').innerHTML = '';
            } catch (error) {
                alert(`‚ùå Error deleting test user: ${error.message}`);
            }
        }

        async function runAllTests() {
            document.querySelectorAll('.status').forEach(el => {
                el.className = 'status pending';
                el.textContent = 'PENDING';
            });
            
            document.querySelectorAll('[id^="result-"]').forEach(el => {
                el.innerHTML = '';
            });
            
            await testDatabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFetchUsers();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUsersTableSchema();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCreateUser();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (testUserId) {
                await testVerifyPermissions();
            }
            
            console.log('‚úÖ All tests completed!');
        }

        // Make functions globally available
        window.testDatabaseConnection = testDatabaseConnection;
        window.testFetchUsers = testFetchUsers;
        window.testUsersTableSchema = testUsersTableSchema;
        window.testCreateUser = testCreateUser;
        window.testVerifyPermissions = testVerifyPermissions;
        window.cleanupTestUser = cleanupTestUser;
        window.runAllTests = runAllTests;
    </script>
</body>
</html>

