<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Quick Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover { background: #2980b9; }
        .result { margin: 10px 0; padding: 10px; background: #ecf0f1; border-radius: 4px; }
        .pass { color: #27ae60; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üß™ POS Quick Test</h1>
    
    <div class="status">
        <h2>Auto-Test with Login</h2>
        <p>This will open your POS application in a new tab and automatically:</p>
        <ul>
            <li>Navigate to login page</li>
            <li>Fill in credentials (care@care.com / 123456)</li>
            <li>Run comprehensive tests</li>
            <li>Display results</li>
        </ul>
        
        <button onclick="runAutoTest()">üöÄ Run Automated Test</button>
        <button onclick="openApp()">üì± Just Open App</button>
    </div>
    
    <div class="status">
        <h2>Manual Testing</h2>
        <p>For manual testing, you can:</p>
        <ol>
            <li>Open the app: <code>http://localhost:5173</code></li>
            <li>Login with: <strong>care@care.com</strong> / <strong>123456</strong></li>
            <li>Open console (F12)</li>
            <li>Run this command:</li>
        </ol>
        <button onclick="copyTestCommand()">üìã Copy Test Command</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        function openApp() {
            window.open('http://localhost:5173', 'POSApp');
        }
        
        function runAutoTest() {
            const testWindow = window.open('http://localhost:5173', 'POSTestWindow');
            
            // Wait for page to load
            setTimeout(() => {
                if (testWindow) {
                    alert('‚úÖ App opened!\n\nNow:\n1. Wait for page to load\n2. Check if you need to login\n3. If on login page, press the "Auto Login & Test" button below');
                    
                    // Create a button in the original window to inject test script
                    const btn = document.createElement('button');
                    btn.textContent = 'üî¨ Auto Login & Test (Click after app loads)';
                    btn.style.cssText = 'background: #e74c3c; font-size: 18px; padding: 20px;';
                    btn.onclick = () => injectTestScript(testWindow);
                    
                    document.getElementById('results').innerHTML = '';
                    document.getElementById('results').appendChild(btn);
                }
            }, 2000);
        }
        
        function injectTestScript(targetWindow) {
            if (!targetWindow || targetWindow.closed) {
                alert('‚ùå App window is closed. Please run the test again.');
                return;
            }
            
            // Inject auto-login and test script
            const script = `
(async () => {
    console.clear();
    console.log('%cüß™ AUTO TEST & LOGIN', 'font-size: 24px; font-weight: bold; color: #3498db;');
    
    // Check if already logged in
    const isLoginPage = window.location.pathname.includes('/login') || window.location.pathname === '/';
    
    if (isLoginPage) {
        console.log('üîê Attempting auto-login...');
        
        // Wait a bit for page to fully load
        await new Promise(r => setTimeout(r, 1000));
        
        // Find and fill login form
        const emailInput = document.querySelector('input[type="email"], input[name="email"], input[placeholder*="email" i]');
        const passwordInput = document.querySelector('input[type="password"], input[name="password"]');
        const submitBtn = document.querySelector('button[type="submit"]');
        
        if (emailInput && passwordInput && submitBtn) {
            console.log('üìù Filling login form...');
            
            // Fill form
            emailInput.value = 'care@care.com';
            passwordInput.value = '123456';
            
            // Trigger events
            ['input', 'change'].forEach(eventType => {
                emailInput.dispatchEvent(new Event(eventType, { bubbles: true }));
                passwordInput.dispatchEvent(new Event(eventType, { bubbles: true }));
            });
            
            console.log('‚úÖ Form filled');
            console.log('üîÑ Submitting...');
            
            // Submit
            submitBtn.click();
            
            // Wait for navigation
            await new Promise(r => setTimeout(r, 3000));
            console.log('‚úÖ Login submitted - checking status...');
        } else {
            console.log('‚ùå Login form not found');
            console.log('Email input:', emailInput);
            console.log('Password input:', passwordInput);
            console.log('Submit button:', submitBtn);
        }
    } else {
        console.log('‚úÖ Already logged in');
    }
    
    // Now run tests
    console.log('\\nüß™ Running tests...\\n');
    
    const results = { pass: 0, fail: 0, tests: [] };
    
    // Test 1: Database connection
    try {
        if (typeof supabase !== 'undefined') {
            const { data, error } = await supabase.from('lats_products').select('count').limit(1);
            if (!error) {
                console.log('‚úÖ Database connected');
                results.pass++;
                results.tests.push({ name: 'Database', status: 'pass' });
            } else {
                console.log('‚ùå Database error:', error.message);
                results.fail++;
                results.tests.push({ name: 'Database', status: 'fail', error: error.message });
            }
        } else {
            console.log('‚ö†Ô∏è Supabase not initialized yet');
            results.fail++;
            results.tests.push({ name: 'Database', status: 'fail', error: 'Not initialized' });
        }
    } catch (e) {
        console.log('‚ùå Database test failed:', e.message);
        results.fail++;
        results.tests.push({ name: 'Database', status: 'fail', error: e.message });
    }
    
    // Test 2: Inventory store
    try {
        if (typeof useInventoryStore !== 'undefined') {
            const store = useInventoryStore.getState();
            console.log('‚úÖ Inventory store available');
            console.log('   Products:', store.products?.length || 0);
            console.log('   Categories:', store.categories?.length || 0);
            results.pass++;
            results.tests.push({ name: 'Inventory Store', status: 'pass' });
        } else {
            console.log('‚ö†Ô∏è Inventory store not available');
            results.fail++;
            results.tests.push({ name: 'Inventory Store', status: 'fail' });
        }
    } catch (e) {
        console.log('‚ùå Inventory store test failed:', e.message);
        results.fail++;
        results.tests.push({ name: 'Inventory Store', status: 'fail', error: e.message });
    }
    
    // Test 3: Branch context
    try {
        const branchId = localStorage.getItem('selectedBranchId');
        if (branchId) {
            console.log('‚úÖ Branch context:', branchId);
            results.pass++;
            results.tests.push({ name: 'Branch Context', status: 'pass' });
        } else {
            console.log('‚ö†Ô∏è No branch selected');
            results.fail++;
            results.tests.push({ name: 'Branch Context', status: 'fail' });
        }
    } catch (e) {
        console.log('‚ùå Branch test failed:', e.message);
        results.fail++;
        results.tests.push({ name: 'Branch Context', status: 'fail', error: e.message });
    }
    
    // Test 4: Check for console errors
    const consoleErrors = window.performance?.getEntriesByType?.('resource')?.filter(e => 
        e.name.includes('400') || e.name.includes('401') || e.name.includes('500')
    ) || [];
    
    if (consoleErrors.length > 0) {
        console.log('‚ö†Ô∏è Found', consoleErrors.length, 'HTTP errors');
        results.tests.push({ name: 'Console Errors', status: 'warn', count: consoleErrors.length });
    } else {
        console.log('‚úÖ No HTTP errors detected');
        results.pass++;
        results.tests.push({ name: 'Console Errors', status: 'pass' });
    }
    
    // Summary
    console.log('\\n' + '='.repeat(60));
    console.log('üìä TEST SUMMARY');
    console.log('='.repeat(60));
    console.log('‚úÖ Passed:', results.pass);
    console.log('‚ùå Failed:', results.fail);
    console.log('Total Tests:', results.tests.length);
    console.log('\\nDetailed Results:');
    console.table(results.tests);
    console.log('='.repeat(60));
    
    // Apply quick fixes
    console.log('\\nüîß Applying quick fixes...');
    
    if (typeof useInventoryStore !== 'undefined') {
        const store = useInventoryStore.getState();
        if (store.clearFilters) {
            store.clearFilters();
            console.log('‚úÖ Cleared filters');
        }
    }
    
    console.log('\\nüéâ Testing complete!');
    console.log('\\nTo re-run tests, refresh the page or paste this script again.');
    
    return results;
})();
            `;
            
            try {
                targetWindow.eval(script);
                alert('‚úÖ Test script injected!\n\nCheck the console in the app window for results.\n\n(Press F12 in the app window to see the console)');
            } catch (error) {
                alert('‚ùå Could not inject script: ' + error.message + '\n\nPlease copy and paste the test script manually.');
            }
        }
        
        function copyTestCommand() {
            const command = `// Paste this in browser console (F12) on http://localhost:5173
fetch('http://localhost:5173/auto-browser-test-and-fix.js')
    .then(r => r.text())
    .then(script => eval(script))
    .catch(() => alert('Could not load test script'));`;
            
            navigator.clipboard.writeText(command).then(() => {
                alert('‚úÖ Command copied!\n\nNow:\n1. Open http://localhost:5173\n2. Press F12\n3. Paste in console\n4. Press Enter');
            });
        }
        
        // Auto-check if server is running
        fetch('http://localhost:5173')
            .then(() => {
                document.body.insertAdjacentHTML('afterbegin', 
                    '<div style="background:#27ae60;color:white;padding:10px;text-align:center;margin:-20px -20px 20px;border-radius:8px 8px 0 0;">‚úÖ Dev server is running on port 5173</div>');
            })
            .catch(() => {
                document.body.insertAdjacentHTML('afterbegin',
                    '<div style="background:#e74c3c;color:white;padding:10px;text-align:center;margin:-20px -20px 20px;border-radius:8px 8px 0 0;">‚ùå Dev server not detected on port 5173 - Please start it with: npm run dev</div>');
            });
    </script>
</body>
</html>

